<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍🏭 🦗 🐉 Pythonバックエンドサービス開発ガイド 👨‍🍳 😳 🍘</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、アレクサンダーヴァシンと申します。エダディルのバックエンドデベロッパーです。この資料のアイデアは、導入課題（Ya.Disk）をYandex バックエンド開発スクールに解析したかったという事実から始まりました。私は特定のテクノロジーの選択の微妙さ、テスト方法論のすべてについて説明し始めまし...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pythonバックエンドサービス開発ガイド</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/499534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、アレクサンダーヴァシンと申します。エダディルのバックエンドデベロッパーです。この資料のアイデアは、導入課題（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya.Disk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）をYandex </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">バックエンド開発</font></a><font style="vertical-align: inherit;">スクール</font><font style="vertical-align: inherit;">に解析したかったという事実から始まりました</font><font style="vertical-align: inherit;">。私は特定のテクノロジーの選択の微妙さ、テスト方法論のすべてについて説明し始めました...それはまったく分析ではなく、Pythonでバックエンドを記述する方法に関する非常に詳細なガイドであることがわかりました。当初のアイデアからは、サービスの要件のみがあり、その例では、ツールとテクノロジーを分解することが便利でした。その結果、10万の文字で目が覚めました。すべてを非常に詳細に検討するためには、非常に多くのことが必要でした。したがって、次の100キロバイト用のプログラム：ツールの選択からデプロイメントまで、サービスバックエンドを構築する方法。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/sz/r2/pmszr288srjaplio0w_utpnb4ym.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにある</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションとGitHubの担当者は、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そして（本物の）ロングリードを愛する人-猫の下で。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PythonでREST APIサービスを開発してテストし、軽量のDockerコンテナーにパックして、Ansibleを使用してデプロイします。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">REST APIサービスは、さまざまなツールを使用してさまざまな方法で実装できます。</font><font style="vertical-align: inherit;">説明されているソリューションは唯一の正しいものではありません。私は自分の個人的な経験と好みに基づいて実装とツールを選択しました。</font></font></blockquote><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは何をしますか？</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">選択するツールは？</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜsetup.pyから始める必要があるのですか？</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">依存バージョンを指定する方法は？</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベース</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキームを設計します</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLAlchemyでスキーマを説明する</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembicをカスタマイズする</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイグレーションを生成します</font></font></a></li>
</ul></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">応用</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データのシリアル化</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラー</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST /インポート</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッチ/インポート/ $ import_id / citizens / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET /インポート/ $ import_id /市民/誕生日</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat /パーセンタイル/年齢</font></font></a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト中</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラー</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST /インポート</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッチ/インポート/ $ import_id / citizens / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET /インポート/ $ import_id /市民/誕生日</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat /パーセンタイル/年齢</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイグレーション</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブリ</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デプロイ</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストレステスト</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他に何ができますか？</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終的に</font></font></a></li>
</ul><br>
<a name="task"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは何をしますか？</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オンラインギフトストアがさまざまな地域でアクションを開始することを計画していると想像してください。</font><font style="vertical-align: inherit;">販売戦略を効果的にするには、市場分析が必要です。</font><font style="vertical-align: inherit;">ストアには、居住者に関する情報を含むデータのアンロードを定期的に（たとえば、郵便で）送信するサプライヤーがいます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
提供されたデータを分析し、月ごとにさまざまな都市のさまざまな年齢層の居住者からの贈り物の需要を特定するPython REST APIサービスを開発しましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のハンドラーをサービスに実装します。</font></font><br>
<br>
<ul>
<li> <code>POST /imports</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを含む新しいアップロードを追加します。</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指定された退院者を返します。</font></font><br>
 </li>
<li> <code>PATCH /imports/$import_id/citizens/$citizen_id</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指定された荷降ろしの居住者（および彼の親族）に関する情報を変更します。</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens/birthdays</code><br>
  ,        ( ),   ;<br>
 </li>
<li> <code>GET /imports/$import_id/towns/stat/percentile/age</code><br>
 50-, 75-  99-   ( )      .<br>
 </li>
</ul><br>
<a name="tools"></a><h1>  ?</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、使い慣れたフレームワーク、ライブラリ、DBMSを使用して、Pythonでサービスを作成しています。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">4回の講義</font></a><font style="vertical-align: inherit;">ビデオもちろん、様々なDBMSおよびその特徴について説明されています。私の実装では</font><font style="vertical-align: inherit;">、信頼できるソリューションとして確立され</font><font style="vertical-align: inherit;">た</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">PostgreSQL</font></a><font style="vertical-align: inherit;"> DBMSを選択しました</font><font style="vertical-align: inherit;">。これは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、ロシア語の</font></a><font style="vertical-align: inherit;">優れた</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ドキュメント</font></a><font style="vertical-align: inherit;">、強力なロシア語コミュニティ（ロシア語での質問に対する答えはいつでも見つかります）、さらには</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">無料のコース</font></a><font style="vertical-align: inherit;">です。リレーショナルモデルは非常に用途が広く、多くの開発者によく理解されています。同じことはどのNoSQL DBMSでも行うことができますが、この記事ではPostgreSQLについて検討します。</font></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスの主な目的（データベースとクライアント間のネットワークを介したデータ伝送）は、プロセッサーに大きな負荷を与えることを意味しませんが、一度に複数の要求を処理する機能を必要とします。で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10回の講義</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期的なアプローチと見なさ。これにより、同じOSプロセス内の複数のクライアントに効率的にサービスを提供できます（たとえば、Flask / Djangoで使用されるpre-forkモデルとは異なり、ユーザーからのリクエストを処理するための複数のプロセスを作成し、それぞれがメモリを消費しますが、ほとんどの時間はアイドル状態です）したがって、サービスを作成するためのライブラリーとして、非同期の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を選択し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://docs.aio"><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ビデオコース</font><font style="vertical-align: inherit;">
の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">5番目の講義で</font></a><font style="vertical-align: inherit;">は、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">SQLAlchemy</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/or/rj/pn/orrjpnx6upvsipcqbsql7f36vzc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複雑なクエリをパーツに分解して再利用し、動的なフィールドのセットを使用してクエリを生成し（たとえば、PATCHプロセッサにより、任意のフィールドを持つ常駐者の部分的な更新が可能）、ビジネスロジックに直接焦点を当てることができます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドライバー</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">は</font></a><font style="vertical-align: inherit;">これらの要求を処理し、データを最速</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">転送</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">でき</font></a><font style="vertical-align: inherit;">ます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。asyncpgsa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、友達を作るのに役立ちます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースの状態を管理し、移行を操作するための私のお気に入りのツールは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。ちなみに、最近</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モスクワパイソン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で話しまし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
検証のロジックは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マシュマロ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキーム</font><font style="vertical-align: inherit;">（家族のつながりのチェックを含む）</font><font style="vertical-align: inherit;">によって簡潔に説明されていました</font><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;">aiohttp-spec</font></a><font style="vertical-align: inherit;">モジュールの使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ検証のためにaiohttp-handlersとスキームをリンクしましたが、ボーナスは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形式でドキュメントを生成</font><font style="vertical-align: inherit;">し、それを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グラフィカルインターフェイス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で表示すること</font><font style="vertical-align: inherit;">でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストを書くために、私は</font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それについてさらに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3つの講義</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">選び</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロジェクトをデバッグしてプロファイルするために、私はPyCharmデバッガーを使用しました（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">講義9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7講演</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのように任意のコンピュータに説明し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドッカー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（あるいは異なるOS上）は、/更新/サーバ上でアプリケーションを削除し、インストールするのは簡単始めとするアプリケーション環境を調整することなく、パッケージを実行することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
展開には、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Ansible</font></a><font style="vertical-align: inherit;">を選択しました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">サーバーとそのサービスの望ましい状態を宣言的に記述することができ、sshを介して機能し、特別なソフトウェアを必要としません。</font></font><br>
<br>
<a name="development"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は、Pythonパッケージに名前を付け</font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次の構造を使用することにしまし</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ly/wt/oxlywtje20xt5ceou8pbtfp8an8.png" width="550"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
た。ファイル</font></font><code>analyzer/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">には、パッケージに関する一般的な情報（説明（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docstring</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、バージョン、ライセンス、開発者の連絡先）</font><font style="vertical-align: inherit;">を投稿しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">組み込みのヘルプで表示できます</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python<font></font>
&gt;&gt;&gt; import analyzer<font></font>
&gt;&gt;&gt; <span class="hljs-built_in">help</span>(analyzer)<font></font>
<font></font>
Help on package analyzer:<font></font>
<font></font>
NAME<font></font>
    analyzer<font></font>
<font></font>
DESCRIPTION<font></font>
      REST API,    .<font></font>
<font></font>
PACKAGE CONTENTS<font></font>
    api (package)<font></font>
    db (package)<font></font>
    utils (package)<font></font>
<font></font>
DATA<font></font>
    __all__ = (<span class="hljs-string">'__author__'</span>, <span class="hljs-string">'__email__'</span>, <span class="hljs-string">'__license__'</span>, <span class="hljs-string">'__maintainer__'</span>,...<font></font>
    __email__ = <span class="hljs-string">'alvassin@yandex.ru'</span>
    __license__ = <span class="hljs-string">'MIT'</span>
    __maintainer__ = <span class="hljs-string">'Alexander Vasin'</span><font></font>
<font></font>
VERSION<font></font>
    0.0.1<font></font>
<font></font>
AUTHOR<font></font>
    Alexander Vasin<font></font>
<font></font>
FILE<font></font>
    /Users/alvassin/Work/backendschool2019/analyzer/__init__.py</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッケージには、REST APIサービス（</font></font><code>analyzer/api/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）とデータベース状態管理ユーティリティ（</font></font><code>analyzer/db/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">2つの入力ポイントが</font><font style="vertical-align: inherit;">あります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ファイルは</font></font><code>__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理由のために</font><font style="vertical-align: inherit;">呼び出さ</font><font style="vertical-align: inherit;">れ</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">-最初に、そのような名前が注目を集め、ファイルがエントリポイントであることを明確にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、エントリポイントへのこのアプローチのおかげで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>     python -m</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># REST API</span>
$ python -m analyzer.api --<span class="hljs-built_in">help</span><font></font>
<font></font>
<span class="hljs-comment">#    </span>
$ python -m analyzer.db --<span class="hljs-built_in">help</span></code></pre><br>
<a name="setuppy"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜsetup.pyから始める必要があるのですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今後は、アプリケーションの配布方法について検討します。zip-（およびwheel / egg-）アーカイブ、rpm-package、macOS用のpkg-fileにパッケージ化して、リモートコンピューター、仮想マシン、MacBookまたはDocker-にインストールできます。容器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルの主な目的は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>setup.py</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、アプリケーションを使用してパッケージを記述することです</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
ファイルには、パッケージに関する一般情報（名前、バージョン、作成者など）が含まれている必要がありますが、作業に必要なモジュール、「追加の」依存関係（たとえば、テスト）、エントリポイント（たとえば、実行可能なコマンド）を指定することもできます。 ）および通訳者の要件。</font><font style="vertical-align: inherit;">
Setuptoolsプラグインを使用すると、説明したパッケージからアーティファクトを収集できます。組み込みプラグインがあります：zip、egg、rpm、macOS pkg。残りのプラグインはは、PyPIを介して配信される：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ホイール</font></a><font style="vertical-align: inherit;">、</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">distutils</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">setuptools</a></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一番下の行では、1つのファイルについて説明しているので、大きなチャンスがあります。</font><font style="vertical-align: inherit;">そのため、新しいプロジェクトの開発はから始める必要があります</font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数では、</font></font><code>setup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">依存モジュールはリストで示されます。</font></font><br>
<br>
<pre><code class="python hljs">setup(..., install_requires=[<span class="hljs-string">"aiohttp"</span>, <span class="hljs-string">"SQLAlchemy"</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、私は別々のファイルに依存関係を記述</font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その内容に使用されています</font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私にはより柔軟に思えますが、秘密があります。後でそれを使用すると、Dockerイメージをより速く構築できます。</font><font style="vertical-align: inherit;">依存関係は、アプリケーション自体をインストールする前に別個のステップとして設定され、Dockerコンテナーを再構築するとき、それはキャッシュにあります。</font><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">から依存関係を読み取る</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ことが</font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できるように</font><font style="vertical-align: inherit;">、関数は次のように記述されています。</font></font><code>requirements.txt</code><font style="vertical-align: inherit;"></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、ことは注目に値する</font></font><code>setuptools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デフォルトのアセンブリソースディストリビューションのみアセンブリファイルが含まれている場合に</font></font><code>.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>.cpp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">依存関係ファイルにアクセス</font><font style="vertical-align: inherit;">してバッグ</font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒットするには、それらをファイルで明確に指定する必要があります</font></font><code>MANIFEST.in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全にsetup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> importlib.machinery <span class="hljs-keyword">import</span> SourceFileLoader<font></font>
<font></font>
<span class="hljs-keyword">from</span> pkg_resources <span class="hljs-keyword">import</span> parse_requirements
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
module_name = <span class="hljs-string">'analyzer'</span><font></font>
<font></font>
<span class="hljs-comment"># ,     (   ), </span>
<span class="hljs-comment">#   __init__.py   machinery.</span><font></font>
module = SourceFileLoader(<font></font>
    module_name, os.path.join(module_name, <span class="hljs-string">'__init__.py'</span>)<font></font>
).load_module()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements<font></font>
<font></font>
setup(<font></font>
    name=module_name,<font></font>
    version=module.__version__,<font></font>
    author=module.__author__,<font></font>
    author_email=module.__email__,<font></font>
    license=module.__license__,<font></font>
    description=module.__doc__,<font></font>
    long_description=open(<span class="hljs-string">'README.rst'</span>).read(),<font></font>
    url=<span class="hljs-string">'https://github.com/alvassin/backendschool2019'</span>,<font></font>
    platforms=<span class="hljs-string">'all'</span>,<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Intended Audience :: Developers'</span>,
        <span class="hljs-string">'Natural Language :: Russian'</span>,
        <span class="hljs-string">'Operating System :: MacOS'</span>,
        <span class="hljs-string">'Operating System :: POSIX'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.8'</span>,
        <span class="hljs-string">'Programming Language :: Python :: Implementation :: CPython'</span><font></font>
    ],<font></font>
    python_requires=<span class="hljs-string">'&gt;=3.8'</span>,<font></font>
    packages=find_packages(exclude=[<span class="hljs-string">'tests'</span>]),<font></font>
    install_requires=load_requirements(<span class="hljs-string">'requirements.txt'</span>),<font></font>
    extras_require={<span class="hljs-string">'dev'</span>: load_requirements(<span class="hljs-string">'requirements.dev.txt'</span>)},<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-comment"># f-strings  setup.py   - </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-comment">#   ,     Python 3.8, </span>
            <span class="hljs-comment"># source distribution       </span>
            <span class="hljs-comment">#   Python.     </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-string">'{0}-api = {0}.api.__main__:main'</span>.format(module_name),
            <span class="hljs-string">'{0}-db = {0}.db.__main__:main'</span>.format(module_name)<font></font>
        ]<font></font>
    },<font></font>
    include_package_data=<span class="hljs-literal">True</span>
)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコマンドを使用して、開発モードでプロジェクトをインストールできます（編集可能モードでは、Pythonはフォルダー</font></font><code>site-packages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">パッケージ全体をインストールせ</font><font style="vertical-align: inherit;">ず、リンクのみを作成するため、パッケージファイルに加えられた変更はすぐに表示されます）。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      extra- "dev"</span>
pip install -e <span class="hljs-string">'.[dev]'</span><font></font>
<font></font>
<span class="hljs-comment">#      </span>
pip install -e .</code></pre><br>
<a name="requirements"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">依存バージョンを指定する方法は？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者がパッケージに積極的に取り組んでいるときは素晴らしいことです。バグが積極的に修正されており、新しい機能が表示され、フィードバックをより早く取得できます。ただし、依存ライブラリの変更には下位互換性がなく、事前に考慮しなければアプリケーションでエラーが発生する場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
依存パッケージごとに、特定のバージョンを指定できます</font></font><code>aiohttp==3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。その後、アプリケーションは、テストされた依存ライブラリのバージョンで具体的に構築されることが保証されます。しかし、このアプローチには欠点があります。開発者が下位互換性に影響しない依存パッケージの重大なバグを修正した場合、この修正はアプリケーションに適用されません。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">セマンティックバージョニングの</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
バージョン管理にはアプローチがあります</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのオファーは、次の形式でバージョンを表します</font></font><code>MAJOR.MINOR.PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -下位互換性のない変更が追加されると増加します。</font></font></li>
<li><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -下位互換性をサポートする新しい機能を追加すると増加します。</font></font></li>
<li><code>PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -下位互換性サポートのあるバグ修正を追加すると増加します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
依存パッケージは、このアプローチを（その著者が、通常はREADMEとCHANGELOGファイルで報告されている）以下の場合は、の値を修正するために十分であり</font></font><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">かつPATCH-バージョンの最小値を制限します：</font></font><code>&gt;= MAJOR.MINOR.PATCH, == MAJOR.MINOR.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような要件は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">〜=</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">演算子を使用して実装できます</font><font style="vertical-align: inherit;">。たとえば、</font></font><code>aiohttp~=3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PIPを</font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バージョン3.6.3 </font><font style="vertical-align: inherit;">にインストールでき</font><font style="vertical-align: inherit;">ますが、3.7は</font><font style="vertical-align: inherit;">インストールでき</font><font style="vertical-align: inherit;">ません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
依存バージョンの間隔を指定すると、もう1つの利点が得られます。依存ライブラリ間でバージョンの競合が発生することはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
異なる依存パッケージを必要とするライブラリを開発している場合は、特定のバージョンではなく、間隔を空けてください。</font><font style="vertical-align: inherit;">そうすれば、ライブラリのユーザーがそれを使用するほうがはるかに簡単になります（突然のアプリケーションでは、同じ依存パッケージが必要ですが、バージョンが異なります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セマンティックバージョニングは、パッケージの作成者と消費者の間の単なる合意です。</font><font style="vertical-align: inherit;">それは、作者がバグなしでコードを書くことを保証するものではなく、彼らのパッケージの新しいバージョンを間違えることはありません。</font></font><br>
<br>
<a name="db"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベース</font></font></h2><br>
<a name="dbstructure"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキームを設計します</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
POST / importsハンドラーの説明は、居住者に関する情報を含むアンロードの例を示しています。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップロード例</font></font></b>
                        <div class="spoiler_text"><pre><code class="json hljs">{
  <span class="hljs-attr">"citizens"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"26.12.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">2</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"01.04.1997"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">1</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"2"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">11</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"23.11.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"female"</span>,
      <span class="hljs-attr">"relatives"</span>: []<font></font>
    },<font></font>
    ...<font></font>
  ]<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の考えは、居住者に関するすべての情報を1つのテーブルに格納することでした。この</font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合、関係は</font><b><font style="vertical-align: inherit;">整数のリスト形式の</font></b><font style="vertical-align: inherit;">フィールド</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">表され</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、この方法にはいくつかの欠点があります</font></font></b>
                        <div class="spoiler_text"><ol>
<li>   <code>GET /imports/$import_id/citizens/birthdays</code>   ,      ,     <code>citizens</code>   .          <code>relatives</code>    <code>UNNEST</code>.<br>
<br>
     ,  <b>    10- </b>:<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
    relations.citizen_id, <font></font>
    relations.relative_id, <font></font>
    date_part(<span class="hljs-string">'month'</span>, relatives.birth_date) <span class="hljs-keyword">as</span> relative_birth_month
<span class="hljs-keyword">FROM</span> (
	<span class="hljs-keyword">SELECT</span><font></font>
        citizens.import_id, <font></font>
        citizens.citizen_id,<font></font>
        <span class="hljs-keyword">UNNEST</span>(citizens.relatives) <span class="hljs-keyword">as</span> relative_id
	<span class="hljs-keyword">FROM</span> citizens
    <span class="hljs-keyword">WHERE</span> import_id = <span class="hljs-number">1</span>
) <span class="hljs-keyword">as</span> relations
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> citizens <span class="hljs-keyword">as</span> relatives <span class="hljs-keyword">ON</span>
    relations.import_id = relatives.import_id <span class="hljs-keyword">AND</span><font></font>
    relations.relative_id = relatives.citizen_id<font></font>
</code></pre><br>
 </li>
<li>    <b>    <code>relatives</code>   PostgreSQL</b>,   :    <code>relatives</code>     ,      .       (     )         .</li>
</ol></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、作業に必要なすべてのデータを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第3正規形</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にすることを決定し</font><font style="vertical-align: inherit;">、次の構造が得られました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/pf/px/dipfpxxw142kafiect0yhrtt4uo.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インポート</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブル</font><font style="vertical-align: inherit;">は、自動的に増加する列で構成されます</font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">テーブルに外部キーチェックを作成するために必要です</font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">市民の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブル</font><font style="vertical-align: inherit;">に格納</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スカラーデータ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">居住者（家族関係に関する情報を除くすべてのフィールド）についてを。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペア（</font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">が主キーとして使用され</font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、フレームワーク内</font><font style="vertical-align: inherit;">の居住者の一意性が保証され</font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部キー</font></font><code>citizens.import_id -&gt; imports.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、フィールド</font></font><code>citizens.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に既存のアンロードのみが含まれる</font><font style="vertical-align: inherit;">ことを保証し</font><font style="vertical-align: inherit;">ます。</font></font><br>
 </li>
<li>  <b>relations</b>    <b> </b>. <br>
<br>
<b>     </b> (     ):           <code>citizens</code>  <code>relations</code>     .<br>
     (<code>import_id</code>, <code>citizen_id</code>, <code>relative_id</code>)  ,      <code>import_id</code>   <code>citizen_id</code>   c  <code>relative_id</code>. <br>
<br>
       : <code>(relations.import_id, relations.citizen_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>  <code>(relations.import_id, relations.relative_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>, ,        <code>citizen_id</code>   <code>relative_id</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この構造は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLツールを使用してデータ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><b><font style="vertical-align: inherit;">整合性を</font></b><font style="vertical-align: inherit;">保証し</font><b><font style="vertical-align: inherit;">ます。</font></b><font style="vertical-align: inherit;">これにより、</font><font style="vertical-align: inherit;">データベースから</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">親族の住人</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">効率的に取得</font></b><font style="vertical-align: inherit;">できます</font><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">、競合クエリで住人に関する情報を更新するときに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">競合状態が</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発生します（PATCHハンドラーの実装を詳しく見ていきます）。</font></font><br>
<br>
<a name="do_sqlalchemy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLAlchemyでスキーマを説明する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
では</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、第5章、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私はSQLAlchemyのを使用してクエリを作成する方法について話しました、あなたは特別なオブジェクトを使用してデータベーススキーマを記述する必要があります。表には、使用して記述されている</font></font><code>sqlalchemy.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、レジストリにバインドされて</font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いる店舗すべてのデータベースに関するメタ情報。ちなみに、レジストリ</font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はPythonで記述されたメタ情報を格納できるだけでなく、SQLAlchemyオブジェクトの形式でデータベースの実際の状態を表すこともできます。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能により、Alembicは条件を比較し、移行コードを自動的に生成することもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、各データベースには独自のデフォルトの制約命名スキームがあります。</font><font style="vertical-align: inherit;">新しい制約に名前を付けたり、削除しようとしている制約を検索/思い出したりする時間を無駄にしないように、SQLAlchemyは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命名規則に名前を付ける</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パターンを使用</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">する</font></a><font style="vertical-align: inherit;">ことを推奨しています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これらはレジストリで定義できます</font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MetaDataレジストリを作成し、それにネーミングパターンを渡す</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> MetaData<font></font>
<font></font>
convention = {<font></font>
    <span class="hljs-string">'all_column_names'</span>: <span class="hljs-keyword">lambda</span> constraint, table: <span class="hljs-string">'_'</span>.join([<font></font>
        column.name <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> constraint.columns.values()<font></font>
    ]),<font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-string">'ix'</span>: <span class="hljs-string">'ix__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'uq'</span>: <span class="hljs-string">'uq__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#  CHECK-constraint-</span>
    <span class="hljs-string">'ck'</span>: <span class="hljs-string">'ck__%(table_name)s__%(constraint_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'fk'</span>: <span class="hljs-string">'fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'pk'</span>: <span class="hljs-string">'pk__%(table_name)s'</span><font></font>
}<font></font>
metadata = MetaData(naming_convention=convention)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
命名パターンを指定すると、Alembicはマイグレーションの自動生成中にそれらを使用し、すべての制約にそれらに従って名前を付けます。</font><font style="vertical-align: inherit;">将来的には、作成されたレジストリで</font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルを記述する必要があり</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQLAlchemyオブジェクトを使用してデータベーススキーマを記述します</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<font></font>
<font></font>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> (<font></font>
    Column, Date, Enum <span class="hljs-keyword">as</span> PgEnum, ForeignKey, ForeignKeyConstraint, Integer,<font></font>
    String, Table<font></font>
)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@unique</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gender</span>(<span class="hljs-params">Enum</span>):</span>
    female = <span class="hljs-string">'female'</span>
    male = <span class="hljs-string">'male'</span><font></font>
<font></font>
<font></font>
imports_table = Table(<font></font>
    <span class="hljs-string">'imports'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>)<font></font>
)<font></font>
<font></font>
citizens_table = Table(<font></font>
    <span class="hljs-string">'citizens'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, ForeignKey(<span class="hljs-string">'imports.import_id'</span>),<font></font>
           primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'town'</span>, String, nullable=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'street'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'building'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'apartment'</span>, Integer, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'name'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'birth_date'</span>, Date, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'gender'</span>, PgEnum(Gender, name=<span class="hljs-string">'gender'</span>), nullable=<span class="hljs-literal">False</span>),<font></font>
)<font></font>
<font></font>
relations_table = Table(<font></font>
    <span class="hljs-string">'relations'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'relative_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'citizen_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'relative_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
)<font></font>
</code></pre></div>
                    </div><br>
<a name="db_alembic"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembicをカスタマイズする</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベーススキーマが記述されている場合、マイグレーションを生成する必要がありますが、そのためには、最初にAlembicを構成する必要があります。これについては、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5章で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も説明してい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドを使用するには</font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次の手順を実行する必要があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インストールパッケージ： </font></font><code>pip install alembic</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembicを初期化します</font></font><code>cd analyzer &amp;&amp; alembic init db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコマンドは</font><font style="vertical-align: inherit;">、次の内容の</font><font style="vertical-align: inherit;">構成ファイル</font></font><code>analyzer/alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とフォルダー</font></font><code>analyzer/db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成します</font><font style="vertical-align: inherit;">。</font></font><br>
 <ul>
<li> <code>env.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Alembicを起動するたびに呼び出されます。</font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースの目的の状態の説明</font><font style="vertical-align: inherit;">を含むAlembicレジストリに接続</font><font style="vertical-align: inherit;">し、移行を開始するための手順を含みます。</font></font><br>
 </li>
<li><code>script.py.mako</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -マイグレーションが生成される基礎となるテンプレート。</font></font></li>
<li><code>versions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Alembicがマイグレーションを検索（および生成）するフォルダー。</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alembic.iniファイルでデータベースアドレスを指定します。</font></font><br>
<br>
<pre><code class="plaintext hljs">; analyzer/alembic.ini<font></font>
[alembic] <font></font>
sqlalchemy.url = postgresql://user:hackme@localhost/analyzer</code></pre></li>
<li><font style="vertical-align: inherit;"></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembicがマイグレーションを自動的に生成できるよう</font><font style="vertical-align: inherit;">に、データベース（レジストリ</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">の望ましい状態の説明を指定し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/alembic/env.py</span>
<span class="hljs-keyword">from</span> analyzer.db <span class="hljs-keyword">import</span> schema<font></font>
target_metadata = schema.metadata</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembicは構成済みで、すでに使用できますが、この場合、この構成にはいくつかの欠点があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティ</font><font style="vertical-align: inherit;">は現在の作業ディレクトリを</font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検索</font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">します。</font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドライン引数</font><font style="vertical-align: inherit;">へ</font><font style="vertical-align: inherit;">の</font><font style="vertical-align: inherit;">パスを</font><font style="vertical-align: inherit;">指定できますが、これは不便です。追加のパラメーターなしで任意のフォルダーからコマンドを呼び出すことができるようにしたいのです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のデータベースで動作するようにAlembicを構成するには、ファイルを変更する必要があります</font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、環境変数やコマンドライン引数、あるいはその両方のデータベース設定を指定するほうがはるかに便利</font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティ</font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の名前は、サービスの名前とあまり相関していません（ユーザーは実際にはPythonをまったく持っておらず、Alembicについて何も知らない可能性があります）。</font><font style="vertical-align: inherit;">たとえば、サービスのすべての実行可能なコマンドに共通のプレフィックスが付いていると、エンドユーザーにとってはるかに便利になります</font></font><code>analyzer-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの問題は小さなラッパーで解決されます。 </font></font><code>analyzer/db/__main__.py:</code><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembicは標準モジュールを使用してコマンドライン引数を処理します</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">argparse</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">環境変数のデフォルト値を使用して</font><font style="vertical-align: inherit;">、オプションの引数を追加できます</font></font><code>ANALYZER_PG_URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    alembic.parser.add_argument(<font></font>
        <span class="hljs-string">'--pg-url'</span>, default=os.getenv(<span class="hljs-string">'ANALYZER_PG_URL'</span>, DEFAULT_PG_URL),<font></font>
        help=<span class="hljs-string">'Database URL [env var: ANALYZER_PG_URL]'</span><font></font>
    )<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#   sqlalchemy.url   Alembic</span>
    config.set_main_option(<span class="hljs-string">'sqlalchemy.url'</span>, options.pg_url)<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルへのパス</font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ユーザーの現在の作業ディレクトリではなく、実行可能ファイルの場所を基準にして計算できます。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<font></font>
<font></font>
<font></font>
PROJECT_PATH = Path(__file__).parent.parent.resolve()<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#     (alembic.ini),   </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(options.config):<font></font>
        options.config = os.path.join(PROJECT_PATH, options.config)<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#      alembic   (,  alembic</span>
    <span class="hljs-comment">#   env.py,       )</span>
    alembic_location = config.get_main_option(<span class="hljs-string">'script_location'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(alembic_location):<font></font>
        config.set_main_option(<span class="hljs-string">'script_location'</span>,<font></font>
                               os.path.join(PROJECT_PATH, alembic_location))<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースの状態を管理</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
する</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ユーティリティの</font></a><font style="vertical-align: inherit;">準備ができたら、</font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンドユーザーが理解できる名前で実行可能なコマンドとして</font><font style="vertical-align: inherit;">登録できます。</font><font style="vertical-align: inherit;">次に例を示し</font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行可能なコマンドをsetup.pyに登録する</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup<font></font>
<font></font>
setup(..., entry_points={<font></font>
    <span class="hljs-string">'console_scripts'</span>: [
        <span class="hljs-string">'analyzer-db = analyzer.db.__main__:main'</span><font></font>
    ]<font></font>
})<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モジュールを再インストールすると、ファイルが生成さ</font></font><code>env/bin/analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ、コマンド</font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が使用可能になります。</font></font><br>
<br>
<pre><code class="bash hljs">$ pip install -e <span class="hljs-string">'.[dev]'</span></code></pre><br>
<a name="db_alembic_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイグレーションを生成します</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
移行を生成するには、2つの状態が必要です。目的の状態（SQLAlchemyオブジェクトで説明）と実際の状態（この場合、データベースは空です）です。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Postgresを起動する最も簡単な方法はDockerを使用することであると判断し、便宜上</font></font><code>make postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ポート5432でPostgreSQLを使用してバックグラウンドでコンテナーを実行する</font><font style="vertical-align: inherit;">コマンドを追加しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLを上げて移行を生成する</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ make postgres<font></font>
...<font></font>
$ analyzer-db revision --message=<span class="hljs-string">"Initial"</span> --autogenerate<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'imports'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'citizens'</span>
INFO  [alembic.autogenerate.compare] Detected added index <span class="hljs-string">'ix__citizens__town'</span> on <span class="hljs-string">'['</span>town<span class="hljs-string">']'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'relations'</span>
  Generating /Users/alvassin/Work/backendschool2019/analyzer/db/alembic/versions/d5f704ed4610_initial.py ...  <span class="hljs-keyword">done</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembicは通常、マイグレーションを生成する日常的な作業を適切に実行しますが、次のことに注意したいと思います。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成されたテーブルで指定されたユーザーデータタイプは自動的に作成されますが（この場合は- </font></font><code>gender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、それらを削除するコード</font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は生成されません。</font><font style="vertical-align: inherit;">適用し、ロールバックしてから移行を再度適用すると、指定したデータ型が既に存在するため、エラーが発生します。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウングレードメソッドで性別データタイプを削除する</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic <span class="hljs-keyword">import</span> op
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Enum<font></font>
<font></font>
GenderType = Enum(<span class="hljs-string">'female'</span>, <span class="hljs-string">'male'</span>, name=<span class="hljs-string">'gender'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span>():</span><font></font>
    ...<font></font>
    <span class="hljs-comment">#      GenderType   </span>
    op.create_table(<span class="hljs-string">'citizens'</span>, ...,<font></font>
                    Column(<span class="hljs-string">'gender'</span>, GenderType, nullable=<span class="hljs-literal">False</span>))<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
    op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
<font></font>
    <span class="hljs-comment">#       </span>
    GenderType.drop(op.get_bind())</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このメソッドでは、</font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一部のアクションを削除できる場合があります（テーブル全体を削除した場合、そのインデックスを個別に削除することはできません）。</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例えば</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
op.drop_table(<span class="hljs-string">'relations'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      citizens,    </span>
<span class="hljs-comment">#    </span>
op.drop_index(op.f(<span class="hljs-string">'ix__citizens__town'</span>), table_name=<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'imports'</span>)</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
移行が修正され、準備ができたら、適用します。</font></font><br>
<br>
<pre><code class="bash hljs">$ analyzer-db upgrade head<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.runtime.migration] Running upgrade  -&gt; d5f704ed4610, Initial</code></pre><br>
<a name="application"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">応用</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーの作成を開始する前に、aiohttpアプリケーションを構成する必要があります。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttpクイックスタートを見ると、このようなものを書くことができます</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    logging.basicConfig(level=logging.DEBUG)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = web.Application()<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app.router.add_route(...)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    web.run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードはいくつかの質問を引き起こし、いくつかの欠点があります：</font></font><br>
<br>
<ul>
<li> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションの構成方法は？</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少なくとも、クライアントに接続するためのホストとポート、およびデータベースに接続するための情報を指定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はモジュールの助けを借りてこの問題を本当に解決したいのです</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>ConfigArgParse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。標準の</font><font style="vertical-align: inherit;">問題を</font><font style="vertical-align: inherit;">拡張し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>argparse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドライン引数、環境変数（Dockerコンテナーの構成に不可欠）、さらには構成ファイル（これらのメソッドの組み合わせ）を使用して構成できるようにします。</font><font style="vertical-align: inherit;">これを使用し</font></font><code>ConfigArgParse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て、アプリケーション構成パラメーターの値を検証することもできます。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigArgParseを使用してパラメーターを処理する例</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser, ArgumentDefaultsHelpFormatter<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.argparse <span class="hljs-keyword">import</span> positive_int<font></font>
<font></font>
parser = ArgumentParser(<font></font>
    <span class="hljs-comment">#        ANALYZER_,</span>
    <span class="hljs-comment">#  ANALYZER_API_ADDRESS  ANALYZER_API_PORT</span>
    auto_env_var_prefix=<span class="hljs-string">'ANALYZER_'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#     </span><font></font>
    formatter_class=ArgumentDefaultsHelpFormatter<font></font>
)<font></font>
<font></font>
parser.add_argument(<span class="hljs-string">'--api-address'</span>, default=<span class="hljs-string">'0.0.0.0'</span>,<font></font>
                    help=<span class="hljs-string">'IPv4/IPv6 address API server would listen on'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
parser.add_argument(<span class="hljs-string">'--api-port'</span>, type=positive_int, default=<span class="hljs-number">8081</span>,<font></font>
                    help=<span class="hljs-string">'TCP port API server would listen on'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#   ,     </span>
    <span class="hljs-comment">#  ,    </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#       </span><font></font>
    app = web.Application()<font></font>
    web.run_app(app, host=args.api_address, port=args.api_port)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div><br>
, <code>ConfigArgParse</code>,   <code>argparse</code>,           (     <code>-h</code>  <code>--help</code>).       :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python __main__.py --<span class="hljs-built_in">help</span><font></font>
usage: __main__.py [-h] [--api-address API_ADDRESS] [--api-port API_PORT]<font></font>
<font></font>
If an arg is specified <span class="hljs-keyword">in</span> more than one place, <span class="hljs-keyword">then</span> commandline values override environment variables <span class="hljs-built_in">which</span> override defaults.<font></font>
<font></font>
optional arguments:<font></font>
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><font></font>
  --api-address API_ADDRESS<font></font>
                        IPv4/IPv6 address API server would listen on [env var: ANALYZER_API_ADDRESS] (default: 0.0.0.0)<font></font>
  --api-port API_PORT   TCP port API server would listen on [env var: ANALYZER_API_PORT] (default: 8081)</code></pre></div>
                    </div></li>
<li>             — ,    «»     .          ,  <strong>     </strong>. <br>
<br>
    <code>os.environ.clear()</code>,  Python            (,      <code>asyncio</code>?),        ,   <code>ConfigArgParser</code>.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Callable
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
ENV_VAR_PREFIX = <span class="hljs-string">'ANALYZER_'</span><font></font>
<font></font>
parser = ArgumentParser(auto_env_var_prefix=ENV_VAR_PREFIX)<font></font>
parser.add_argument(<span class="hljs-string">'--pg-url'</span>, type=URL, default=URL(DEFAULT_PG_URL),<font></font>
                   help=<span class="hljs-string">'URL to use to connect to the database'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_environ</span>(<span class="hljs-params">rule: Callable</span>):</span>
    <span class="hljs-string">"""
      ,     
     rule
    """</span>
    <span class="hljs-comment">#   os.environ    tuple,    </span>
    <span class="hljs-comment"># os.environ   </span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> filter(rule, tuple(os.environ)):<font></font>
        os.environ.pop(name)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#      ANALYZER_</span>
    clear_environ(<span class="hljs-keyword">lambda</span> i: i.startswith(ENV_VAR_PREFIX))<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = create_app(args)<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li> <strong>   stderr/      .</strong><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 9</a> ,    <code>logging.basicConfig()</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>   stderr</code></a>.<br>
<br>
       ,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>   aiomisc.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    aiomisc</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiomisc.log <span class="hljs-keyword">import</span> basic_config<font></font>
<font></font>
basic_config(logging.DEBUG, buffered=<span class="hljs-literal">True</span>)    
</code></pre></div>
                    </div></li>
<li> <strong>  ,     </strong>    ?    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>fork</code></a>     ,           (,  Windows   ).<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<font></font>
<font></font>
<span class="hljs-keyword">import</span> forklib
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket
<span class="hljs-keyword">from</span> setproctitle <span class="hljs-keyword">import</span> setproctitle<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8081</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
    setproctitle(<span class="hljs-string">f'[Master] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span>
        setproctitle(<span class="hljs-string">f'[Worker] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
        app = Application()<font></font>
        run_app(app, sock=sock)<font></font>
<font></font>
    forklib.fork(os.cpu_count(), worker, auto_restart=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre></div>
                    </div></li>
<li>    <strong>   -    </strong>?  ,      (   —    )    ,      <code>nobody</code>.      —     .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pwd<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8085</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
<font></font>
    user = pwd.getpwnam(<span class="hljs-string">'nobody'</span>)<font></font>
    os.setgid(user.pw_gid)<font></font>
    os.setuid(user.pw_uid)<font></font>
<font></font>
    app = create_app(...)<font></font>
    run_app(app, sock=sock)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li>            <code>create_app</code>,         .</li>
</ul><br>
<a name="serialization"></a><h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
成功したすべてのハンドラー応答は、JSON形式で返されます。</font><font style="vertical-align: inherit;">また、クライアントがシリアル化された形式でエラーに関する情報を受け取ると便利です（たとえば、検証に合格しなかったフィールドを確認するため）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドキュメント</font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://docs.aio"><code>json_response</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、オブジェクトを受け取り、それをJSONで</font><font style="vertical-align: inherit;">シリアル化し、内部に</font></font><code>aiohttp.web.Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘッダー</font></font><code>Content-Type: application/json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とシリアル化されたデータを</font><font style="vertical-align: inherit;">持つ</font><font style="vertical-align: inherit;">新しいオブジェクト</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">返す</font><font style="vertical-align: inherit;">メソッド</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">提供します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">json_responseを使用してデータをシリアル化する方法</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, View, run_app
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> json_response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> json_response({<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、別の方法もあります。aiohttpを使用すると、特定のタイプの応答データの任意のシリアライザをレジストリに登録できます</font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば</font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、タイプ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mappingの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトに</font><font style="vertical-align: inherit;">シリアライザ</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">指定できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、ハンドラー</font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はパラメーターに応答データを持つ</font><font style="vertical-align: inherit;">オブジェクトを返すだけで十分です</font></font><code>body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">aiohttpは、データ型と一致するシリアライザーを見つけて、応答をシリアライズします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクトのシリアル化が1か所で記述されるという事実に加えて、このアプローチはより柔軟でもあります。これにより、非常に興味深いソリューションを実装できます（ハンドラーの使用例の1つを検討します</font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp.PAYLOAD_REGISTRYを使用してデータをシリアル化する方法</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Mapping<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> PAYLOAD_REGISTRY, JsonPayload
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app, Application, Response, View<font></font>
<font></font>
PAYLOAD_REGISTRY.register(JsonPayload, (Mapping, MappingProxyType))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Response(body={<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"></font><code>json_response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などは</font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>json.dumps</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複雑なデータ型をシリアル化できない</font><font style="vertical-align: inherit;">標準</font><font style="vertical-align: inherit;">
メソッド</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用する</font><font style="vertical-align: inherit;">こと、</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><code>asyncpg.Record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><code>asyncpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースからレコードをこのクラスのインスタンスとして返す</font><font style="vertical-align: inherit;">）を使用</font><font style="vertical-align: inherit;">することを理解することが重要</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">さらに、一部の複雑なオブジェクトには他のオブジェクトが含まれている場合があります</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">データベースの1つのレコードには、型フィールドがある場合があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python開発者はこの問題に対処しました。このメソッドで</font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、引数</font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用して</font><font style="vertical-align: inherit;">、なじみのないオブジェクトをシリアル化する必要があるときに呼び出される関数を指定</font><font style="vertical-align: inherit;">できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この関数は、見慣れないオブジェクトをjsonモジュールをシリアル化できる型にキャストすることが期待されています。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JsonPayloadを拡張して任意のオブジェクトをシリアル化する方法</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, singledispatch
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.payload <span class="hljs-keyword">import</span> JsonPayload <span class="hljs-keyword">as</span> BaseJsonPayload
<span class="hljs-keyword">from</span> aiohttp.typedefs <span class="hljs-keyword">import</span> JSONEncoder<font></font>
<font></font>
<span class="hljs-meta">@singledispatch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span>(<span class="hljs-params">value</span>):</span>
    <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">f'Unserializable value: <span class="hljs-subst">{value!r}</span>'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(Record)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_asyncpg_record</span>(<span class="hljs-params">value: Record</span>):</span>
    <span class="hljs-string">"""
        , 
    asyncpg
    """</span>
    <span class="hljs-keyword">return</span> dict(value)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(date)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date</span>(<span class="hljs-params">value: date</span>):</span>
    <span class="hljs-string">"""
       date      —  
      .     
      ..
    """</span>
    <span class="hljs-keyword">return</span> value.strftime(<span class="hljs-string">'%d.%m.%Y'</span>)<font></font>
    <font></font>
 <font></font>
dumps = partial(json.dumps, default=convert)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonPayload</span>(<span class="hljs-params">BaseJsonPayload</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,
                 value: Any,
                 encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 dumps: JSONEncoder = dumps,
                 *args: Any,
                 **kwargs: Any</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        super().__init__(value, encoding, content_type, dumps, *args, **kwargs)</code></pre></div>
                    </div><br>
<a name="handlers"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aiohttpを使用すると、非同期の関数とクラスでハンドラーを実装できます。</font><font style="vertical-align: inherit;">クラスはより拡張可能です。1つ目は、1つのハンドラーに属するコードを1か所に配置できること、2つ目は、継承を使用してコードの重複を取り除くことができることです（たとえば、各ハンドラーにはデータベース接続が必要です）。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラー基本クラス</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_urldispatcher <span class="hljs-keyword">import</span> View
<span class="hljs-keyword">from</span> asyncpgsa <span class="hljs-keyword">import</span> PG<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>(<span class="hljs-params">View</span>):</span><font></font>
    URL_PATH: str<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pg</span>(<span class="hljs-params">self</span>) -&gt; PG:</span>
        <span class="hljs-keyword">return</span> self.request.app[<span class="hljs-string">'pg'</span>]
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つの大きなファイルを読み取るのは難しいため、ハンドラーをファイルに分割することにしました。</font><font style="vertical-align: inherit;">小さなファイルは弱い接続を促進します。たとえば、ハンドラー内にリングインポートがある場合、エンティティの構成に問題がある可能性があります。</font></font><br>
<br>
<a name="imports_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST /インポート</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
入力ハンドラは、住民に関するデータを含むjsonを受け取ります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大許容要求サイズ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aiohttpではオプションで制御される</font></font><code>client_max_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=http://docs.aiohttp.org/en/stable/web_reference.html&amp;usg=ALkJrhjZjCAKBrGAHxES0EE1nMJau6CAmw#aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、デフォルトでは2メガバイトです</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。制限を超えると、aiohttpはステータス413：Request Entity Too Large ErrorのHTTP応答を返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、最長の行と番号を持つ正しいjsonは約63メガバイトになるため、リクエストのサイズの制限を拡張する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データを確認して逆シリアル化</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する必要があり</font><strong><font style="vertical-align: inherit;">ます</font></strong><font style="vertical-align: inherit;">。正しくない場合は、HTTP応答を返す必要があります</font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのスキームが必要でした</font></font><code>Marhsmallow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 1つ目は</font></font><code>CitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、個々の居住者のデータをチェックし、誕生日の文字列をオブジェクトに逆シリアル化します</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての必須フィールドのデータタイプ、フォーマット、および可用性。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なじみのない分野の欠如;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生年月日は形式で示す必要があり</font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、未来からの重要なものであってはなりません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各居住者の親族のリストには、このアップロードに存在する居住者の一意の識別子が含まれている必要があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のスキーム</font></font><code>ImportSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、アンロード全体をチェックします。</font></font><br>
<br>
<ul>
<li><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> アンロード内の各居住者は一意である必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">家族関係は双方向である必要があります（居住者＃1が親族のリストに居住者＃2を持っている場合、居住者＃2も親族＃1を持っている必要があります）。</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データが正しい場合は</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、新しい一意の</font><strong><font style="vertical-align: inherit;">データ</font></strong><font style="vertical-align: inherit;">とともに</font><strong><font style="vertical-align: inherit;">データベースに追加する必要があります</font></strong></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを追加するには、異なるテーブルでいくつかのクエリを実行する必要があります。</font><font style="vertical-align: inherit;">エラーまたは例外（たとえば、完全な応答を受信しなかったクライアントを切断すると、aiohttp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=http://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がCancelledError例外をスローする</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）が</font><font style="vertical-align: inherit;">発生した場合に、データベースに部分的に追加されたデータを回避</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するには、トランザクションを使用する必要があります</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">PostgreSQLへの1つのクエリでは32,767以下の引数しか存在できない</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、データをパーツ単位でテーブルに追加する必要</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があります。</font><font style="vertical-align: inherit;">テーブルには</font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9つのフィールド</font><font style="vertical-align: inherit;">があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、1つのクエリで、このテーブルに挿入できるのは32,767 / 9 = 3,640行のみであり、1回のアップロードで最大10,000人の住民が存在できます。</font></font><br>
<br>
<a name="citizens_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーは、指定されたでアンロードするためにすべての居住者を返します</font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">指定した</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップロードが存在しない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合は</font><font style="vertical-align: inherit;">、404：Not Found HTTPレスポンスを返す必要があります。</font><font style="vertical-align: inherit;">この動作は、既存のアンロードを必要とするハンドラーでは一般的であると思われるため、検証コードを別のクラスにプルしました。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アンロードを伴うハンドラーの基本クラス</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_exceptions <span class="hljs-keyword">import</span> HTTPNotFound
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, exists<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> imports_table<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseImportView</span>(<span class="hljs-params">BaseView</span>):</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> int(self.request.match_info.get(<span class="hljs-string">'import_id'</span>))<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_import_exists</span>(<span class="hljs-params">self</span>):</span><font></font>
        query = select([<font></font>
            exists().where(imports_table.c.import_id == self.import_id)<font></font>
        ])<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">await</span> self.pg.fetchval(query):
            <span class="hljs-keyword">raise</span> HTTPNotFound()
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各居住者の親族のリストを取得するには</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">によってグループ化され</font><font style="vertical-align: inherit;">たフィールドを集計して、</font><font style="vertical-align: inherit;">テーブル</font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からテーブル</font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">へ</font><font style="vertical-align: inherit;">と実行する必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
居住者が親族を持たない場合、</font><font style="vertical-align: inherit;">彼はフィールドに彼の</font><font style="vertical-align: inherit;">値</font><font style="vertical-align: inherit;">を返し、</font><font style="vertical-align: inherit;">集計の結果、親族のリストはのようになります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
この誤った値を修正するために、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">array_remove</font></a><font style="vertical-align: inherit;">関数を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
データベースは日付をフォーマット</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">保存しますが、フォーマット</font><font style="vertical-align: inherit;">が必要です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
技術的には、SQLクエリまたはPython側で応答をシリアル化するときに日付をフォーマットできます</font><font style="vertical-align: inherit;">（asyncpgは</font><font style="vertical-align: inherit;">クラスのインスタンスとして</font><font style="vertical-align: inherit;">フィールド値</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">返します</font></font><code>relations</code><font style="vertical-align: inherit;"></font><code>relations.relative_id</code><font style="vertical-align: inherit;"></font><code>import_id</code><font style="vertical-align: inherit;"></font><code>citizen_id</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"></font><code>relations.relative_id</code><font style="vertical-align: inherit;"></font><code>NULL</code><font style="vertical-align: inherit;"></font><code>[NULL]</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>YYYY-MM-DD</code><font style="vertical-align: inherit;"></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>json.dumps</code><font style="vertical-align: inherit;"></font><code>birth_date</code><font style="vertical-align: inherit;"></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python側でシリアル化を選択したの</font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font><font style="vertical-align: inherit;">それ</font><font style="vertical-align: inherit;">が</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクト内で単一の形式</font><font style="vertical-align: inherit;">の唯一のオブジェクト</font><font style="vertical-align: inherit;">であるため（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「データの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリアル</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">化」</font></a><font style="vertical-align: inherit;">のセクションを参照</font><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセッサが2つの要求（アンロードの存在の確認と居住者のリストの要求）を実行するという事実にもかかわらず、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランザクションを使用する必要はありません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。デフォルトでは、PostgreSQLは分離レベルを使用し</font></font><code>READ COMMITTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。1つのトランザクション内でも、正常に完了した他のトランザクションに対するすべての変更が表示されます（新しい行の追加、既存の行の変更）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テキストビューでの最大のアップロードには最大63メガバイトかかる可能性があります。これは特に、データを受信するための複数のリクエストが同時に到着する可能性があることを考えると、非常に多くなります。</font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">カーソル</font></a></b><b><font style="vertical-align: inherit;">を</font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用してデータベースからデータを取得</font><font style="vertical-align: inherit;">し、クライアントに部分的に送信</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するかなり興味深い方法があり</font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、2つのオブジェクトを実装する必要があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースからレコードを返す</font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイプ</font><font style="vertical-align: inherit;">オブジェクト</font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最初の呼び出しで、データベースに接続し、トランザクションを開いてカーソルを作成します。以降の反復中に、データベースからレコードを返します。</font><font style="vertical-align: inherit;">ハンドラーによって返されます。</font></font><br>
 <br>
 <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SelectQueryコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> AsyncIterable
<span class="hljs-keyword">from</span> asyncpgsa.transactionmanager <span class="hljs-keyword">import</span> ConnectionTransactionContextManager
<span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> Select<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectQuery</span>(<span class="hljs-params">AsyncIterable</span>):</span>
    <span class="hljs-string">"""
    ,     PostgreSQL   
    ,  ,    
    """</span>
    PREFETCH = <span class="hljs-number">500</span><font></font>
<font></font>
    __slots__ = (<font></font>
        <span class="hljs-string">'query'</span>, <span class="hljs-string">'transaction_ctx'</span>, <span class="hljs-string">'prefetch'</span>, <span class="hljs-string">'timeout'</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query: Select,
                 transaction_ctx: ConnectionTransactionContextManager,
                 prefetch: int = None,
                 timeout: float = None</span>):</span><font></font>
        self.query = query<font></font>
        self.transaction_ctx = transaction_ctx<font></font>
        self.prefetch = prefetch <span class="hljs-keyword">or</span> self.PREFETCH<font></font>
        self.timeout = timeout<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.transaction_ctx <span class="hljs-keyword">as</span> conn:<font></font>
            cursor = conn.cursor(self.query, prefetch=self.prefetch,<font></font>
                                 timeout=self.timeout)<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
                <span class="hljs-keyword">yield</span> row
</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリアライザ</font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSONへの非同期発電機からの非同期発電機、シリアル化データを反復処理し、部品のクライアントにデータを送信することができます。</font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトのシリアライザとして</font><font style="vertical-align: inherit;">登録さ</font><font style="vertical-align: inherit;">れています</font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncGenJSONListPayloadコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> Payload<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># ,    JSON  asyncpg.Record  datetime.date</span>
dumps = partial(json.dumps, default=convert, ensure_ascii=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncGenJSONListPayload</span>(<span class="hljs-params">Payload</span>):</span>
    <span class="hljs-string">"""
       AsyncIterable,     
     JSON   
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 root_object: str = <span class="hljs-string">'data'</span>,
                 *args, **kwargs</span>):</span><font></font>
        self.root_object = root_object<font></font>
        super().__init__(value, content_type=content_type, encoding=encoding,<font></font>
                         *args, **kwargs)<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">self, writer</span>):</span>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<font></font>
            (<span class="hljs-string">'{"%s":['</span> % self.root_object).encode(self._encoding)<font></font>
        )<font></font>
<font></font>
        first = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> self._value:
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> first:
                <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b','</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                first = <span class="hljs-literal">False</span><font></font>
<font></font>
            <span class="hljs-keyword">await</span> writer.write(dumps(row).encode(self._encoding))<font></font>
<font></font>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b']}'</span>)</code></pre></div>
                    </div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、ハンドラーでは、オブジェクトを作成し</font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、SQLクエリと関数をそれに渡してトランザクションを開き、次のように返すことができ</font></font><code>Response body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラーコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/api/handlers/citizens.py</span>
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> aiohttp_apispec <span class="hljs-keyword">import</span> docs, response_schema<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.schema <span class="hljs-keyword">import</span> CitizensResponseSchema
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> citizens_table <span class="hljs-keyword">as</span> citizens_t
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> SelectQuery<font></font>
<font></font>
<span class="hljs-keyword">from</span> .query <span class="hljs-keyword">import</span> CITIZENS_QUERY
<span class="hljs-keyword">from</span> .base <span class="hljs-keyword">import</span> BaseImportView<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CitizensView</span>(<span class="hljs-params">BaseImportView</span>):</span>
    URL_PATH = <span class="hljs-string">r'/imports/{import_id:\d+}/citizens'</span><font></font>
<font></font>
<span class="hljs-meta">    @docs(summary='    ')</span>
<span class="hljs-meta">    @response_schema(CitizensResponseSchema())</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">await</span> self.check_import_exists()<font></font>
<font></font>
        query = CITIZENS_QUERY.where(<font></font>
            citizens_t.c.import_id == self.import_id<font></font>
        )<font></font>
        body = SelectQuery(query, self.pg.transaction())<font></font>
        <span class="hljs-keyword">return</span> Response(body=body)
</code></pre></div>
                    </div><br>
<code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジストリ</font><font style="vertical-align: inherit;">内のタイプのオブジェクトの</font><font style="vertical-align: inherit;">登録済み</font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シリアライザ</font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">検出します</font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。次に、シリアライザはオブジェクトを反復処理し、</font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データをクライアントに送信します。最初の呼び出しで、オブジェクト</font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はデータベースへの接続を受信し、トランザクションを開いてカーソルを作成します。以降の反復中</font><font style="vertical-align: inherit;">に、オブジェクト</font><font style="vertical-align: inherit;">はカーソルを使用してデータベースからデータを受信し、1行ずつ返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチでは、各リクエストでデータ全体にメモリを割り当てることはできませんが、エラーが発生した場合、アプリケーションは対応するHTTPステータスをクライアントに返すことができません（結局、HTTPステータス、ヘッダーがすでにクライアントに送信されており、データが書き込まれています）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例外が発生すると、切断するしかありません。</font><font style="vertical-align: inherit;">もちろん、例外を保護することはできますが、クライアントはどのエラーが発生したかを正確に理解することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方、プロセッサがデータベースからすべてのデータを受信して​​も、同様の状況が発生する可能性がありますが、クライアントにデータを送信している間、ネットワークが点滅します-これから安全な人はいません。</font></font><br>
<br>
<a name="update_citizen_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッチ/インポート/ $ import_id / citizens / $ citizen_id</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーは、アンロード</font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、居住者</font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、および居住者に関する新しいデータを含むjson </font><font style="vertical-align: inherit;">のIDを受け取り</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">以下の場合には</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存在しないアンロードまたは居住者</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、HTTPレスポンスを返さなければなりません</font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントから送信されたデータは、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検証およびデシリアライズする</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">正しくない場合は、HTTP応答を返す必要があります</font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私</font></font><code>PatchCitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はチェック</font><font style="vertical-align: inherit;">するマシュマロスキームを実装しました</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定したフィールドのデータのタイプとフォーマット。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生年月日。</font><font style="vertical-align: inherit;">形式で指定する必要があり</font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、将来的に重要になることはありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各居住者の親族のリスト。</font><font style="vertical-align: inherit;">住民の一意の識別子が必要です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィールドに示された親族の存在を</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">個別にチェックすることはできません。</font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存在しない居住者が</font><font style="vertical-align: inherit;">テーブルに追加された場合、</font><font style="vertical-align: inherit;">PostgreSQLは</font></font><code>ForeignKeyViolationError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">処理可能</font><font style="vertical-align: inherit;">なエラー</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">返し</font><font style="vertical-align: inherit;">、HTTPステータスが返され</font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">存在しない居住者またはアンロードに対して誤ったデータを</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">送信した場合、どのステータスが返され</font><font style="vertical-align: inherit;">ますか？意味的には、最初にアンロードと常駐の存在（存在しない場合はreturn </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">をチェックし、</font><font style="vertical-align: inherit;">次にクライアントが正しいデータを送信したかどうか（そうでない場合はreturn </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">をチェックする方が正しい</font><font style="vertical-align: inherit;">です。実際には、多くの場合、最初にデータをチェックする方が安く、データが正しい場合にのみ、データベースにアクセスします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どちらのオプションも許容されますが、いずれの場合も操作の結果は何にも影響を与えないエラーになるため、安価な2番目のオプションを選択することにしました（クライアントはデータを修正し、居住者が存在しないこともわかります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データが正しい場合は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、データベース内の居住者に関する情報</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">更新する</font></strong><font style="vertical-align: inherit;">必要</font><strong><font style="vertical-align: inherit;">があります</font></strong><font style="vertical-align: inherit;">。ハンドラーでは、さまざまなテーブルに対していくつかのクエリを実行する必要があります。エラーまたは例外が発生した場合、データベースへの変更を元に戻す必要があるため、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリはトランザクションで実行する必要があります</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッドで</font></font><code>PATCH</code> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、居住者の</font><b><font style="vertical-align: inherit;">一部のフィールドのみを転送できます</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーは、クライアントが指定していないデータにアクセスしたときにクラッシュしないように、またデータが変更されていないテーブルに対してクエリを実行しないように記述する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントがフィールドを指定した場合、</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既存の親族のリストを取得する必要があります。</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベース</font><font style="vertical-align: inherit;">が変更されている場合は、テーブルから</font><font style="vertical-align: inherit;">削除する必要が</font><font style="vertical-align: inherit;">あるレコード</font><font style="vertical-align: inherit;">と、データベースをクライアントの要求に合わせるために追加する</font><font style="vertical-align: inherit;">レコードを決定</font><font style="vertical-align: inherit;">します。デフォルトでは、PostgreSQLはトランザクション分離を使用します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code> READ COMMITTED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。つまり、現在のトランザクションの一部として、他の完了したトランザクションの既存の（新しいものも含む）レコードに変更が反映されます。これ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">により、競合する要求間の競合状態が発生する</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能性が</font><b><font style="vertical-align: inherit;">あります</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
居住者との荷下ろしがあるとします</font></font><code>#1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><code>#2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>#3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">親族なし。サービスは、居住者＃1 </font></font><code><nobr>{"relatives": [2]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">を変更するための2つの同時リクエストを受信</font><font style="vertical-align: inherit;">し</font></font><code><nobr>{"relatives": [3]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。 aiohttpは、PostgreSQLから居住者の現在の状態を同時に受け取る2つのハンドラーを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各ハンドラーは単一の関連関係を検出せず、指定された親族との新しい関係を追加することを決定します。その結果、住人＃1には親戚と同じフィールドがあり</font></font><code>[2,3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/bk/mz/gobkmzuhzr47rfzgvtygkxb1stm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この動作は明白とは言えません。レースの結果を決定するために予想される2つのオプションがあります。最初の要求のみを完了し、2番目がHTTP応答を返す</font></font><br>
<code>409: Conflict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（クライアントが要求を繰り返すようにする）か、要求を順番に実行する（2番目の要求は最初の要求が完了した後でのみ処理されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のオプションは、分離モードをオンにすることで実装できます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>SERIALIZABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。リクエストの処理中に、誰かがすでにデータを変更およびコミットできた場合、例外がスローされます。例外は処理され、対応するHTTPステータスが返されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このソリューションの短所-PostgreSQLでの多数のロックは、</font></font><code>SERIALIZABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">競合するクエリが異なるアンロードからの住民のレコードを変更した場合でも、例外をスローします。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">推奨ロック</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
メカニズムを使用することもでき</font><font style="vertical-align: inherit;">ます。このようなロックを取得</font><font style="vertical-align: inherit;">すると、さまざまなアンロードに対する競合するリクエストを並行して実行できます。</font><font style="vertical-align: inherit;">
1回のアップロードで競合するリクエストを処理するには、オプションの動作を実装できます。関数</font><font style="vertical-align: inherit;">はロックを取得しようとし、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>import_id</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>pg_try_advisory_xact_lock</code><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すぐにブール値の結果を返し（ロックを取得できなかった場合は、例外がスローされる</font><font style="vertical-align: inherit;">
可能性があります）</font></font><code>pg_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースがブロック</font><font style="vertical-align: inherit;">できるようになる</font><font style="vertical-align: inherit;">まで待機し</font><font style="vertical-align: inherit;">ます（この場合、リクエストは順次実行され、このオプションで解決します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、ハンドラ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は更新された常駐者に関する現在の情報を返す</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要があり</font><font style="vertical-align: inherit;">ます。彼のリクエストからクライアントにデータを返すことに制限することができました（クライアントにレスポンスを返しているため、例外はなく、すべてのリクエストが正常に完了したことを意味します）。または-データベースを変更し、結果から応答を生成するクエリでRETURNINGキーワードを使用します。しかし、これらのアプローチはどちらも、国家競争によるケースを見てテストすることはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このサービスには高負荷の要件がなかったため、居住者に関するすべてのデータを再度要求し、データベースからクライアントに正直な結果を返すことにしました。 </font></font><br>
<br>
<a name="citizen_birthdays_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET /インポート/ $ import_id /市民/誕生日</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
荷受人は、荷降ろしの各居住者が彼の親戚に渡すギフトの数を計算します（最初の注文）。</font><font style="vertical-align: inherit;">番号は、指定されたでアップロードするために月ごとにグループ化されます</font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップロードが存在しない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合は</font><font style="vertical-align: inherit;">、HTTP応答を返す必要があります</font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの実装オプションがあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースから親族の居住者のデータを取得し、Python側では、月ごとにデータを集計し、データベースにデータがない月のリストを生成します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースでjsonリクエストをコンパイルし、不足している月のスタブを追加します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は最初のオプションに決めました-視覚的にはより理解しやすくサポートされているように見えます。与えられた月の誕生日の数は</font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、家族とのつながり（</font></font><code>relations.citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-親族の誕生日を考慮する居住者）からテーブル</font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（月を取得したい生年月日を含む</font><font style="vertical-align: inherit;">）に作成する</font><font style="vertical-align: inherit;">ことで取得できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
月の値に先行ゼロを含めることはできません。</font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を使用</font><font style="vertical-align: inherit;">してフィールドから取得した月に</font></font><code>date_part</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、先行ゼロが含まれる場合があります。それを削除する</font></font><code>cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため</font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、SQLクエリで</font><font style="vertical-align: inherit;">を実行</font><font style="vertical-align: inherit;">し</font><font style="vertical-align: inherit;">ました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーが2つの要求を満たす必要があるという事実にもかかわらず（荷降ろしの存在を確認し、誕生日とギフトに関する情報を取得する）、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランザクションは必要ありません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、PostgreSQLはREAD COMMITTEDモードを使用します。このモードでは、すべての新しい（他のトランザクションによって追加された）および既存の（他のトランザクションによって変更された）レコードは、正常に完了した後に現在のトランザクションで表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、データの受信時に新しいアップロードが追加されても、既存のアップロードには影響しません。</font><font style="vertical-align: inherit;">データの受信時に居住者を変更する要求が満たされた場合、データはまだ表示されていないか（データを変更するトランザクションが完了していない場合）、トランザクションが完全に完了し、すべての変更がすぐに表示されます。</font><font style="vertical-align: inherit;">データベースから取得した整合性は侵害されません。</font></font><br>
<br>
<a name="town_age_stat_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat /パーセンタイル/年齢</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーは、指定されたimport_idを使用して、サンプルの居住者の年齢（フルイヤー）の50、75、および99パーセンタイルを都市別に計算します。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップロードが存在しない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合は</font><font style="vertical-align: inherit;">、HTTP応答を返す必要があります</font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセッサが2つの要求を実行する（アンロードの存在の確認と居住者のリストの取得）という事実にもかかわらず、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランザクションを使用する必要はありません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの実装オプションがあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースから居住者の年齢を都市別にグループ化して取得し、Python側でnumpy（タスクで参照として指定されています）を使用してパーセンタイルを計算し、小数点以下2桁に切り上げます。</font></font></li>
<li>     PostgreSQL:  percentile_cont     ,             SQL-,  numpy   .</li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のオプションでは、アプリケーションとPostgreSQLの間で転送するデータが少なくて済みますが、それほど明白な落とし穴はありません。PostgreSQLでは、丸めは数学的であり（</font></font><code>SELECT ROUND(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3を返します）、Pythonでは、会計処理では、最も近い整数</font><font style="vertical-align: inherit;">に丸められます</font><font style="vertical-align: inherit;">（</font></font><code>round(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2を返します）。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーをテストするには、PostgreSQLとPythonの両方で実装が同じである必要があります（Pythonで数学的な丸めを使用して関数を実装すると簡単に見えます）。</font><font style="vertical-align: inherit;">パーセンタイルを計算する場合、numpyとPostgreSQLはわずかに異なる数値を返す可能性がありますが、丸めを考えると、この違いは顕著ではありません。</font></font><br>
<br>
<a name="testing"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト中</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプリケーションでは何を確認する必要がありますか？まず、ハンドラーが要件を満たし、戦闘環境にできるだけ近い環境で必要な作業を実行すること。次に、データベースの状態を変更する移行はエラーなしで機能します。第3に、テストで正しくカバーできる補助機能がいくつかあります。</font><font style="vertical-align: inherit;">柔軟性と使いやすさ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">から</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pytestフレームワーク</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用する</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">こと</font></a><font style="vertical-align: inherit;">にしました。テスト用の環境を準備するための強力なメカニズムを提供します- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィクスチャ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、つまり、デコレータを使用した関数</font></font><code>pytest.mark.fixture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その名前は、テストのパラメーターで指定できます。</font><font style="vertical-align: inherit;">pytestがテストアノテーションでフィクスチャ名を持つパラメーターを検出すると、そのフィクスチャーを実行し、結果をこのパラメーターの値で渡します。</font><font style="vertical-align: inherit;">フィクスチャがジェネレーターの場合、テストパラメーターは返された値を受け取り</font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、テストが終了</font><font style="vertical-align: inherit;">する</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">フィクスチャの</font><font style="vertical-align: inherit;">2番目の部分が実行され、リソースをクリアしたり接続を閉じたりできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのテストでは、PostgreSQLデータベースが必要です。</font><font style="vertical-align: inherit;">テストを互いに分離するには、各テストの前に個別のデータベースを作成し、実行後に削除します。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各テストのフィクスチャデータベースを作成する</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy_utils <span class="hljs-keyword">import</span> create_database, drop_database
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
PG_URL = os.getenv(<span class="hljs-string">'CI_ANALYZER_PG_URL'</span>, DEFAULT_PG_URL)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">postgres</span>():</span>
    tmp_name = <span class="hljs-string">'.'</span>.join([uuid.uuid4().hex, <span class="hljs-string">'pytest'</span>])<font></font>
    tmp_url = str(URL(PG_URL).with_path(tmp_name))<font></font>
    create_database(tmp_url)<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#      postgres  -</span>
        <span class="hljs-keyword">yield</span> tmp_url
    <span class="hljs-keyword">finally</span>:<font></font>
        drop_database(tmp_url)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_db</span>(<span class="hljs-params">postgres</span>):</span>
    <span class="hljs-string">"""
     ,  PostgreSQL
    """</span><font></font>
    engine = create_engine(postgres)<font></font>
    <span class="hljs-keyword">assert</span> engine.execute(<span class="hljs-string">'SELECT 1'</span>).scalar() == <span class="hljs-number">1</span>
    engine.dispose()</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlalchemy_utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
モジュールは、</font><font style="vertical-align: inherit;">さまざまなデータベースとドライバーの機能を考慮して、</font><font style="vertical-align: inherit;">このタスクをうまく</font><font style="vertical-align: inherit;">実行しました。たとえば、PostgreSQLでは</font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランザクションブロックでの</font><font style="vertical-align: inherit;">実行は許可さ</font><font style="vertical-align: inherit;">れて</font><font style="vertical-align: inherit;">いません</font><font style="vertical-align: inherit;">。データベースを作成するとき、それは</font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻訳</font></font><code>psycopg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動コミット・モードに（通常は、トランザクション内のすべての要求を実行します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の重要な機能：少なくとも1つのクライアントがPostgreSQLに接続されている場合、データベースは削除できませんが</font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、データベースを削除する前にすべてのクライアントを切断します。データベースへのアクティブな接続のあるテストがハングしても、データベースは正常に削除されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLにはさまざまな状態が必要です。移行をテストするにはクリーンなデータベースが必要ですが、ハンドラーではすべての移行を適用する必要があります。</font><font style="vertical-align: inherit;">Alembicコマンドを使用してデータベースの状態をプログラムで変更できます。これらのコマンドを呼び出すには、Alembic構成オブジェクトが必要です。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィクスチャのAlembic構成オブジェクトを作成する</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> SimpleNamespace<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> make_alembic_config<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alembic_config</span>(<span class="hljs-params">postgres</span>):</span>
    cmd_options = SimpleNamespace(config=<span class="hljs-string">'alembic.ini'</span>, name=<span class="hljs-string">'alembic'</span>,<font></font>
                                  pg_url=postgres, raiseerr=<span class="hljs-literal">False</span>, x=<span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> make_alembic_config(cmd_options)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
備品があることに注意してください</font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータを持っている</font></font><code>postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">備品のテストの依存性を示すことができないだけでなく、依存関係備品の間。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメカニズムにより、ロジックを柔軟に分離し、非常に簡潔で再利用可能なコードを記述できます。</font></font><br>
<br>
<a name="testing_handlers"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーをテストするには、テーブルとデータ型が作成されたデータベースが必要です。マイグレーションを適用するには、プログラムでupgrade Alembicコマンドを呼び出す必要があります。これを呼び出すには、Alembic構成のオブジェクトが必要</font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">これは、フィクスチャですでに定義されてい</font><font style="vertical-align: inherit;">ます。移行を伴うデータベースは完全に独立したエンティティのように見え、フィクスチャとして表すことができます：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic.command <span class="hljs-keyword">import</span> upgrade<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrated_postgres</span>(<span class="hljs-params">alembic_config, postgres</span>):</span>
    upgrade(alembic_config, <span class="hljs-string">'head'</span>)
    <span class="hljs-comment">#  DSN  ,    </span>
    <span class="hljs-keyword">return</span> postgres</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトに多くの移行がある場合、各テストへの移行には時間がかかりすぎる場合があります。プロセスをスピードアップするために、次のことが可能</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移行を使用してデータベースを作成し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たら</font><font style="vertical-align: inherit;">、次に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テンプレートとして使用します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーをテストするためのデータベースに加えて、実行中のアプリケーションと、このアプリケーションで動作するように構成されたクライアントが必要です。アプリケーションを簡単にテストできるようにするために、実行のために</font></font><code>create_app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメーターを取る</font><font style="vertical-align: inherit;">関数（</font><font style="vertical-align: inherit;">データベース、REST APIのポートなど）</font><font style="vertical-align: inherit;">にその作成を入れまし</font><font style="vertical-align: inherit;">た。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを起動するための引数は、別個のフィクスチャとして表すこともできます。それらを作成するには、テストアプリケーションを実行するための空きポートと移行した一時データベースのアドレスを決定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
空きポートを特定するために</font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、aiomiscパッケージの</font><font style="vertical-align: inherit;">フィクスチャを使用しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
標準のフィクスチャ</font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でも</font><font style="vertical-align: inherit;">構い</font><font style="vertical-align: inherit;">ませんが、空きポートを特定する関数を</font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返し、すぐにポート番号を返します。</font><font style="vertical-align: inherit;">このアプリケーションでは、空いているポートを1つだけ決定する必要があるため、呼び出しで余分なコード行を記述しないことにしました</font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arguments</span>(<span class="hljs-params">aiomisc_unused_port, migrated_postgres</span>):</span>
    <span class="hljs-keyword">return</span> parser.parse_args(<font></font>
        [<font></font>
            <span class="hljs-string">'--log-level=debug'</span>,
            <span class="hljs-string">'--api-address=127.0.0.1'</span>,
            <span class="hljs-string">f'--api-port=<span class="hljs-subst">{aiomisc_unused_port}</span>'</span>,
            <span class="hljs-string">f'--pg-url=<span class="hljs-subst">{migrated_postgres}</span>'</span><font></font>
        ]<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーを使用したすべてのテストは、REST APIへのリクエストを意味するため、アプリケーションを直接操作する</font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要</font><font style="vertical-align: inherit;">はあり</font><font style="vertical-align: inherit;">ません。</font><font style="vertical-align: inherit;">したがって、アプリケーションを起動するフィクスチャを1つ</font></font><code>aiohttp_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成</font><font style="vertical-align: inherit;">し、ファクトリ</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">て、アプリケーションに接続された標準のテストクライアントを作成して返します</font></font><code>aiohttp.test_utils.TestClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api_client</span>(<span class="hljs-params">aiohttp_client, arguments</span>):</span><font></font>
    app = create_app(arguments)<font></font>
    client = <span class="hljs-keyword">await</span> aiohttp_client(app, server_kwargs={
        <span class="hljs-string">'port'</span>: arguments.api_port<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> client
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、テストパラメータ</font></font><code>api_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">フィクスチャを指定する</font><font style="vertical-align: inherit;">と、次のようになり</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ol>
<li> <code>postgres</code>    (  <code>migrated_postgres</code>).</li>
<li> <code>alembic_config</code>    Alembic,      (  <code>migrated_postgres</code>).</li>
<li> <code>migrated_postgres</code>   (  <code>arguments</code>).</li>
<li> <code>aiomisc_unused_port</code>    (  <code>arguments</code>).</li>
<li> <code>arguments</code>     (  <code>api_client</code>).</li>
<li> <code>api_client</code>          .</li>
<li> .</li>
<li> <code>api_client</code>     .</li>
<li> <code>postgres</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フィクスチャを使用すると、コードの重複を回避できますが、テストで環境を準備するだけでなく、同じコードが多数存在する可能性のある場所として、アプリケーションリクエストがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、リクエストを行うと、特定のHTTPステータスを取得することが期待されます。次に、ステータスが期待されるものと一致する場合、データを操作する前に、それらが正しい形式であることを確認する必要があります。ここで間違いを犯し、正しい計算を行い</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、正しい結果</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><strong><font style="vertical-align: inherit;">返す</font></strong><font style="vertical-align: inherit;">ハンドラーを作成するのは簡単ですが、</font><strong><font style="vertical-align: inherit;">応答形式が正しくないために自動検証に合格しません</font></strong><font style="vertical-align: inherit;">（たとえば、キーで辞書に回答をラップするのを忘れるなど</font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。これらのチェックはすべて1か所で行うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モジュール内</font></font><code>analyzer.testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 各ハンドラーには、HTTPのステータスをチェックするヘルパー関数と、Marshmallowを使用した応答形式を用意しました。 </font></font><br>
<br>
<a name="test_citizens_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースの状態を変更する他のハンドラーの結果を確認するのに非常に役立つので、住民を返すハンドラーから始めることにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーからデータベースにデータを追加するコードは意図的に使用していません</font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、別の関数にすることは難しくありません。</font><font style="vertical-align: inherit;">ハンドラーコードには変更するプロパティがあり、データベースに追加するコードにエラーがある場合、テストが意図したとおりに機能しなくなり、開発者向けに暗黙的にエラーが表示されなくなる可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このテストでは、次のテストデータセットを定義しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数人の親類との荷降ろし。</font><font style="vertical-align: inherit;">居住者ごとに親族の識別子を含むリストが正しく形成されることを確認します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">親族のいない一人の居住者との荷降ろし。</font><font style="vertical-align: inherit;">フィールド</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が空のリストであること</font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を確認します</font><font style="vertical-align: inherit;">（</font><font style="vertical-align: inherit;">SQLクエリのため、親戚のリストが等しい場合があります</font></font><code>[None]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本人の親族である居住者との荷下ろし。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空のアンロード。</font><font style="vertical-align: inherit;">ハンドラーが空のアンロードの追加を許可し、エラーでクラッシュしないことを確認します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アップロードごとに同じテストを個別に実行するために、別の非常に強力なpytestメカニズム（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメーター化）を使用しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このメカニズムを使用すると、テスト関数をデコレータでラップし、テスト関数が</font></font><code>pytest.mark.parametrize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">個々のテストケースごとにどのパラメータを取得する必要があるかを記述できます。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストをパラメーター化する方法</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
datasets = [<font></font>
    <span class="hljs-comment">#    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">3</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   </span><font></font>
    [<font></font>
        generate_citizen(relatives=[])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   ,    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, name=<span class="hljs-string">''</span>, gender=<span class="hljs-string">'male'</span>,<font></font>
                         birth_date=<span class="hljs-string">'17.02.2020'</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    [],<font></font>
]<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.mark.parametrize('dataset', datasets)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_citizens</span>(<span class="hljs-params">api_client, dataset</span>):</span>
    <span class="hljs-string">"""
        4 ,    
    """</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、テストはアップロードをデータベースに追加し、ハンドラーへのリクエストを使用して、居住者に関する情報を受信し、参照アップロードと受信したアップロードを比較します。しかし、居住者をどのように比較しますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各居住者はスカラーフィールドとフィールド</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-親族の識別子のリストで構成されます。 Pythonのリストは順序付きの型であり、各リストの要素の順序を比較する場合は重要ですが、兄弟とリストを比較する場合は、順序は重要ではありません。</font><font style="vertical-align: inherit;">比較の前にセットに</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
持っ</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て行った</font><font style="vertical-align: inherit;">場合</font><font style="vertical-align: inherit;">、比較するときに、フィールドの住民の1人</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が重複</font><font style="vertical-align: inherit;">している状況を見つけることができません</font><font style="vertical-align: inherit;">。親族の識別子でリストを並べ替えると、親族の識別子の順序が異なるという問題が回避されますが、同時に重複が検出されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのリストを居住者と比較する場合、1つは同様の問題に遭遇する可能性があります。技術的には、荷降ろしにおける居住者の順序は重要ではありませんが、1つの荷降ろしに同じ識別子を持つ2人の居住者が他にいないかどうかを検出することが重要です。</font><font style="vertical-align: inherit;">したがって、親族でリストを整理することに加えて、各居住者の親族は各荷下ろしで居住者を手配する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
居住者を比較するタスクは複数回発生するため、2つの関数を実装しました。1つは2人の居住者を比較するためのもので、もう1つは2つのリストを居住者と比較するためのものです。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">居住者を比較する</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Iterable, Mapping<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_citizen</span>(<span class="hljs-params">citizen</span>):</span>
    <span class="hljs-string">"""
         
    """</span>
    <span class="hljs-keyword">return</span> {**citizen, <span class="hljs-string">'relatives'</span>: sorted(citizen[<span class="hljs-string">'relatives'</span>])}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizens</span>(<span class="hljs-params">left: Mapping, right: Mapping</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
      
    """</span>
    <span class="hljs-keyword">return</span> normalize_citizen(left) == normalize_citizen(right)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizen_groups</span>(<span class="hljs-params">left: Iterable, right: Iterable</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
          ,   
      
    """</span>
    left = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> left]<font></font>
    left.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])<font></font>
<font></font>
    right = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> right]<font></font>
    right.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])
    <span class="hljs-keyword">return</span> left == right
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このハンドラーが他の荷降ろしの居住者を返さないことを確認するために、各テストの前に、1人の居住者による荷降ろしを追加することにしました。</font></font><br>
<br>
<a name="test_imports_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST /インポート</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーをテストするために、次のデータセットを定義しました。</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースに正常に追加されることが期待される正しいデータ。</font></font></b><br>
 <br>
<ul>
<li>    ( ).<br>
<br>
      .    ,     ,    insert    ,    .</li>
<li>   ( , ).<br>
<br>
,            .<br>
 </li>
<li>    .<br>
<br>
     ,       . :)<br>
 </li>
<li>    <br>
<br>
,  aiohttp             PostgreSQL    32 767  (    ).<br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空のアンロード</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーは、このようなケースを考慮に入れて、居住者と一緒にテーブルに空の挿入を実行しようとする必要があります。</font></font><br>
 </li>
</ul><br>
 </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーのあるデータ。HTTP応答は400：Bad Requestであると想定しています。</font></font></b><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生年月日が正しくありません（未来時制）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citizen_idはアップロード内で一意ではありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">親族関係が正しく表示されていません（居住者間でのみ存在しますが、フィードバックはありません）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">居住者の荷降ろしに親戚が存在しません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">家族の絆はユニークではありません。</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセッサが正常に動作してデータが追加された場合は、住民をデータベースに追加して、標準のアンロードと比較する必要があります。</font><font style="vertical-align: inherit;">居住者を取得するために、テスト済みのハンドラー</font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、比較のために関数を使用しました</font></font><code>compare_citizen_groups</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="test_update_citizen_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッチ/インポート/ $ import_id / citizens / $ citizen_id</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データの検証は</font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、いくつかの例外を除いて</font><font style="vertical-align: inherit;">、ハンドラー</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">説明されているものと多くの点で似てい</font><font style="vertical-align: inherit;">ます。常駐は1つだけであり、クライアントは必要な</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドのみ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を渡すことができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーがHTTP応答を返すことを確認するために、不正なデータを含む次のセットを使用することにしました</font></font><code>400: Bad request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドは指定されていますが、データ型やフォーマットが正しくありません</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生年月日が正しくありません（将来）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このフィールドに</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、アンロードに存在しない親戚が含まれています。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ハンドラーが居住者とその親族に関する情報を正しく更新していることを確認する必要もあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、3人の住民（うち2人は親族）でアップロードを作成し、すべてのスカラーフィールドの新しい値とフィールド内の新しい相対識別子を使用してリクエストを送信します</font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーがテスト前に異なるアンロードの居住者を区別することを確認するために（たとえば、同じ識別子を持つ居住者を別のアンロードから変更しない）、同じ識別子を持つ3人の居住者で追加のアンロードを作成しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーはスカラーフィールドの新しい値を保存し、新しく指定された相対を追加し、指定されていない古い相対との関係を削除する必要があります。</font><font style="vertical-align: inherit;">親族関係のすべての変化は二国間でなければなりません。</font><font style="vertical-align: inherit;">他の荷降ろしに変更はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなハンドラーは競合状態の影響を受ける可能性があるため（これについては開発セクションで説明しました）、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2つのテスト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を追加しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">1つは競合状態の問題を再現し（ハンドラークラスを拡張してロックを削除）、2つ目は競合状態の問題が再現されないことを証明します。</font></font><br>
<br>
<a name="test_citizen_birthdays_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET /インポート/ $ import_id /市民/誕生日</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このハンドラーをテストするために、次のデータセットを選択しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">居住者が1か月に1人の親戚と別の1人に2人の親戚を持つ荷降ろし。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">親族のいない一人の居住者との荷降ろし。</font><font style="vertical-align: inherit;">ハンドラが計算で考慮しないことを確認します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空のアンロード。</font><font style="vertical-align: inherit;">ハンドラーが失敗しないことを確認し、12か月の応答で正しい辞書を返します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本人の親族である居住者との荷下ろし。</font><font style="vertical-align: inherit;">居住者が彼の誕生月に贈り物を購入することを確認します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーは、これらの月に誕生日がない場合でも、応答ですべての月を返す必要があります。</font><font style="vertical-align: inherit;">重複を避けるために、欠落している月の値で補完するように、辞書を渡すことができる関数を作成しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーが異なる荷降ろしの居住者を確実に区別するために、2つの親類との荷降ろしを追加しました。</font><font style="vertical-align: inherit;">ハンドラーが誤ってそれらを計算で使用すると、結果は正しくなくなり、ハンドラーはエラーで失敗します。</font></font><br>
<br>
<a name="test_town_age_stat_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat /パーセンタイル/年齢</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このテストの特徴は、その作業の結果が現在の時刻に依存することです。住民の年齢は現在の日付に基づいて計算されます。</font><font style="vertical-align: inherit;">テスト結果が時間の経過とともに変化しないようにするには、現在の日付、居住者の生年月日、および期待される結果を記録する必要があります。</font><font style="vertical-align: inherit;">これにより、エッジケースも簡単に再現できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適な修正日はいつですか？</font><font style="vertical-align: inherit;">ハンドラーはPostgreSQL関数を使用して、居住者の年齢を計算し</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>AGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。最初のパラメーターを年齢の計算に必要な日付とし、2番目のパラメーターを基準日（定数で定義</font></font><code>TownAgeStatView.CURRENT_DATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）とします。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハンドラーの基準日をテスト時間に置き換えます</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@patch('analyzer.api.handlers.TownAgeStatView.CURRENT_DATE', new=CURRENT_DATE)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_ages</span>(<span class="hljs-params">...</span>):</span>
    ...</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーをテストするために、次のデータセットを選択しました（すべての居住者に対して、ハンドラーが結果を都市別に集計するため、1つの都市を指定しました）。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誕生日が明日（年齢-数年と364日）である複数の居住者との荷降ろし。</font><font style="vertical-align: inherit;">プロセッサが計算に完全な年数のみを使用することを確認します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誕生日が今日の居住者と一緒に荷降ろし（年齢-ちょうど数年）。</font><font style="vertical-align: inherit;">それは地域のケースをチェックします-今日の誕生日である居住者の年齢は1年だけ減らされて計算されるべきではありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空のアンロード。</font><font style="vertical-align: inherit;">ハンドラーがそれに落ちてはなりません。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パーセンタイルを計算するための</font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベンチマーク</font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">線形補間、およびそれらについて計算したテストのベンチマーク結果。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、小数百分位数の値を小数点第2位で四捨五入する必要があります。</font><font style="vertical-align: inherit;">ハンドラーでの丸めにPostgreSQLを使用し、参照データの計算にPythonを使用した</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合、Python 3とPostgreSQL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">での</font><strong><font style="vertical-align: inherit;">丸めによって異なる結果が得られることがあります</font></strong><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例えば</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># Python 3<font></font>
round(2.5)<font></font>
&gt; 2<font></font>
<font></font>
-- PostgreSQL<font></font>
SELECT ROUND(2.5)<font></font>
&gt; 3<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、Pythonは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最も近い偶数に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バンク丸め</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">を</font></a><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">、PostgreSQL </font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">数学的（ハーフアップ）を使用します。</font><font style="vertical-align: inherit;">PostgreSQLで計算と丸めが実行される場合、テストでも数学的な丸めを使用するのが正しいでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は生年月日を含むデータセットをテキスト形式で説明しましたが、この形式でテストを読むのは不便でした。特定のデータセットが何をチェックしていたかを思い出すために、頭の中で各住民の年齢を計算する必要があったたびです。</font><font style="vertical-align: inherit;">もちろん、コード内のコメントで十分ですが、少し先に進んで</font></font><code>age2date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、生年月日を年齢の形式（年数と日数）で記述できる</font><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">を作成しました。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たとえば、このように</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">age2date</span>(<span class="hljs-params">years: int, days: int = <span class="hljs-number">0</span>, base_date=CURRENT_DATE</span>) -&gt; str:</span><font></font>
    birth_date = copy(base_date).replace(year=base_date.year - years)<font></font>
    birth_date -= timedelta(days=days)<font></font>
    <span class="hljs-keyword">return</span> birth_date.strftime(BIRTH_DATE_FORMAT)<font></font>
<font></font>
<span class="hljs-comment">#    ?  ,     ?</span>
generate_citizen(birth_date=<span class="hljs-string">'17.02.2009'</span>)<font></font>
<font></font>
<span class="hljs-comment">#   11       </span>
generate_citizen(birth_date=age2date(years=<span class="hljs-number">11</span>))
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ハンドラーが異なるアンロードの居住者を確実に区別するために、別の都市の居住者を1人追加してアンロードを追加しました。ハンドラーが誤ってそれを使用すると、余分な都市が結果に表示され、テストが失敗します。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">興味深い事実：2020年2月29日にこのテストを書いたとき、私は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fakerのバグのために</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">住民</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">との</font></a><font style="vertical-align: inherit;">アンロードの生成を突然停止</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">しました</font></a><font style="vertical-align: inherit;">（2020はうるう年であり、Fakerが選択した他の年も必ずしもうるう年ではありませんでした） 2月29日ではありませんでした）。</font><font style="vertical-align: inherit;">日付を記録し、エッジケースをテストすることを忘れないでください！</font></font></blockquote><br>
<a name="test_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイグレーション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一見すると、移行コードは明白でエラーが発生しにくいように見えますが、なぜそれをテストするのですか？これは非常に危険なエラーです。移行の最も油断のならない間違いは、最も不都合なときに現れます。データが損なわれない場合でも、不要なダウンタイムが発生する可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトに存在する</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移行は、データベースの構造を変更しますが、データは変更しません。そのような移行から保護できる一般的な間違いは何ですか？</font></font><br>
<br>
<ul>
<li>  <code>downgrade</code>           (     ,      ,     ).<br>
<br>
   ,        (--):         ,        —    .<br>
 </li>
<li>C   .</li>
<li>    ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのエラーのほとんどは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">階段テストで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検出され</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">彼のアイデアは-一貫した方法を実行する、単一の移行を使用するには</font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それぞれの移行のため。</font><font style="vertical-align: inherit;">このようなテストはプロジェクトに一度追加するだけで十分であり、サポートを必要とせず、忠実に機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、構造に加えて移行によってデータが変更される場合は、少なくとも1つの個別のテストを記述して、メソッドでデータが正しく変更され、</font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の初期状態に戻ることを</font><font style="vertical-align: inherit;">確認する必要が</font><font style="vertical-align: inherit;">あります</font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">念のため：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまな移行をテストする例を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含む</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">プロジェクト</font></a><font style="vertical-align: inherit;">。モスクワPythonの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembicに関するレポートの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ために準備しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="build"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンブリ</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デプロイする最後のアーティファクトであり、アセンブリの結果として取得したいものは、Dockerイメージです。ビルドするには、</font><font style="vertical-align: inherit;">Pythonで</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベースイメージ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">選択</font></b><font style="vertical-align: inherit;">する必要があり</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。公式イメージの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>python:latest</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重さは1 GB以下であり、ベースイメージとして使用すると、アプリケーションのイメージは非常に大きくなります。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alpine OSに基づいたイメージ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があり</font><font style="vertical-align: inherit;">、サイズははるかに小さくなっています。しかし、インストールされるパッケージの数が増えると、最終的なイメージのサイズが大きくなり、その結果、Alpineに基づいて収集されたイメージもそれほど小さくなりません。私はベースイメージとして</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snakepacker / python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を選択し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;"> -重さはアルパインイメージより少し重いですが、Ubuntuに基づいており、パッケージとライブラリの膨大な選択肢を提供しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の方法</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションでのイメージのサイズの縮小</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -最終的なイメージには、アプリケーションの動作に必要のない、アセンブリのヘッダーを持つコンパイラ、ライブラリ、およびファイルを含めないでください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dockerの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">マルチステージアセンブリを</font></a><font style="vertical-align: inherit;">使用できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「重い」イメージ</font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（〜1 GB、〜500 MB圧縮）を使用して、仮想環境を作成し、すべての依存関係とアプリケーションパッケージをそれにインストールします。</font><font style="vertical-align: inherit;">このイメージは、アセンブリーにのみ必要であり、コンパイラー、必要なすべてのライブラリー、およびヘッダー付きのファイルを含めることができます。</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#   </span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/*</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完成した仮想環境を</font></font><code>snakepacker/python:3.8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、必要なバージョンのPythonのインタープリターのみが含ま</font><font style="vertical-align: inherit;">れる「軽い」イメージ</font><font style="vertical-align: inherit;">（約100 MB、圧縮された約50 MB）に</font><font style="vertical-align: inherit;">コピーします</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要：仮想環境では絶対パスが使用されるため、コレクターコンテナーでアセンブルされたのと同じアドレスにコピーする必要があります。</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#       builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></li>
</ol><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イメージの構築にかかる時間</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を</font><b><font style="vertical-align: inherit;">短縮</font></b><font style="vertical-align: inherit;">する</font><b><font style="vertical-align: inherit;">ため</font></b><font style="vertical-align: inherit;">に、仮想環境にインストールする前に、アプリケーションに依存するモジュールをインストールできます。</font><font style="vertical-align: inherit;">次に、Dockerはそれらをキャッシュし、変更されていない場合は再インストールしません。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile全体</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">###############      ################</span>
<span class="hljs-comment">#  — «» (~1 ,    ~500 )    </span>
<span class="hljs-comment">#    </span>
FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#      pip</span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
RUN /usr/share/python3/app/bin/pip install -U pip<font></font>
<font></font>
<span class="hljs-comment">#   ,  .   </span>
<span class="hljs-comment"># Docker   ,  requirements.txt  </span><font></font>
COPY requirements.txt /mnt/<font></font>
RUN /usr/share/python3/app/bin/pip install -Ur /mnt/requirements.txt<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/* \<font></font>
    &amp;&amp; /usr/share/python3/app/bin/pip check<font></font>
<font></font>
<span class="hljs-comment">###########################   ############################</span>
<span class="hljs-comment">#    «» (~100 ,    ~50 )   Python</span>
FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#         builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組み立てを簡単にするために</font></font><code>make upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Dockerイメージを収集してhub.docker.comにアップロード</font><font style="vertical-align: inherit;">するコマンドを追加しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<a name="ci"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードがテストでカバーされ、Dockerイメージを構築できるようになったので、これらのプロセスを自動化する番です。最初に頭に浮かぶのは、プールリクエストを作成するためのテストを実行し、変更をマスターブランチに追加するときに、新しいDockerイメージを収集して</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（または</font><font style="vertical-align: inherit;">イメージを公開しない場合は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHubパッケージ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）に</font><font style="vertical-align: inherit;">アップロードすること</font><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHubアクションで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解決しました</font><font style="vertical-align: inherit;">。これを行うには、フォルダー内にYAMLファイルを作成し、</font></font><code>.github/workflows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その中にワークフロー（</font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">およびの</font><font style="vertical-align: inherit;">2つのタスク</font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を記述</font><font style="vertical-align: inherit;">する必要がありました</font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">サービス</font></a><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">して</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">ワークフローが開始されるたびに</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスク</font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が実行され</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a></font><code>CI</code><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLでコンテナを取得し、コンテナが使用可能になるのを待って、コンテナで起動</font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスク</font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が実行されるのは、変更がブランチに追加され</font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、タスク</font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が成功した</font><font style="vertical-align: inherit;">場合</font><font style="vertical-align: inherit;">のみです</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">コンテナによってソース配布を収集し</font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次にでDockerイメージを収集してロードし</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>docker/build-push-action@v1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワークフローの完全な説明</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">name: CI<font></font>
<font></font>
# Workflow      <font></font>
#   -  master<font></font>
on:<font></font>
  push:<font></font>
    branches: [ master ]<font></font>
  pull_request:<font></font>
    branches: [ master ]<font></font>
<font></font>
jobs:<font></font>
  #       workflow<font></font>
  test:<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    services:<font></font>
      postgres:<font></font>
        image: docker://postgres<font></font>
        ports:<font></font>
          - 5432:5432<font></font>
        env:<font></font>
          POSTGRES_USER: user<font></font>
          POSTGRES_PASSWORD: hackme<font></font>
          POSTGRES_DB: analyzer<font></font>
<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: test<font></font>
        uses: docker://snakepacker/python:all<font></font>
        env:<font></font>
          CI_ANALYZER_PG_URL: postgresql://user:hackme@postgres/analyzer<font></font>
        with:<font></font>
          args: /bin/bash -c "pip install -U '.[dev]' &amp;&amp; pylama &amp;&amp; wait-for-port postgres:5432 &amp;&amp; pytest -vv --cov=analyzer --cov-report=term-missing tests"<font></font>
<font></font>
  #    Docker-  <font></font>
  publish:<font></font>
    #        master<font></font>
    if: github.event_name == 'push' &amp;&amp; github.ref == 'refs/heads/master'<font></font>
    # ,   test   <font></font>
    needs: test<font></font>
    runs-on: ubuntu-latest<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: sdist<font></font>
        uses: docker://snakepacker/python:all<font></font>
        with:<font></font>
          args: make sdist<font></font>
<font></font>
      - name: build-push<font></font>
        uses: docker/build-push-action@v1<font></font>
        with:<font></font>
          username: ${{ secrets.REGISTRY_LOGIN }}<font></font>
          password: ${{ secrets.REGISTRY_TOKEN }}<font></font>
          repository: alvassin/backendschool2019<font></font>
          target: api<font></font>
          tags: 0.0.1, latest<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、GitHubの[アクション]タブでマスターに変更を追加すると、テストの起動、Dockerイメージのアセンブリおよびロードを確認できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/qx/pm/r5qxpmy7mlttqniibfvxadvzitw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、マスターブランチでプールリクエストを作成すると、タスクの結果もそこに表示されます</font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/d9/nk/pzd9nkmxq7a75fnlcw2tx37i308.png"><br>
<br>
<a name="deployment"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デプロイ</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
提供されたサーバーにアプリケーションをデプロイするには、Docker、Docker Composeをインストールし、アプリケーションとPostgreSQLでコンテナーを起動して、移行を適用する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの手順は、Ansibleの構成管理システムを使用して自動化できます。 Pythonで記述され、特別なエージェントを必要とせず（sshを介して直接接続）、jinjaテンプレートを使用し、YAMLファイルで目的の状態を宣言的に記述できます。宣言型のアプローチでは、システムの現在の状態や、システムを望ましい状態にするために必要なアクションについて考える必要がありません。このすべての作業は、Ansibleモジュールの肩にかかっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansibleを使用すると、論理的に関連するタスクを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">役割</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にグループ化</font><font style="vertical-align: inherit;">し、それらを再利用できます。 2つの役割が必要です。</font></font><code>docker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（Dockerのインストールと構成）および</font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（アプリケーションのインストールと構成）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この役割</font></font><code>docker</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、Dockerを含むリポジトリをシステムに追加し、パッケージ</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">インストールして構成します</font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オプションで、サーバーの再起動後にREST APIが自動的に再開するように設定できます。 Ubuntuでは、初期化システムを利用してこの問題を解決できます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>systemd</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。さまざまなリソース（デーモン、ソケット、マウントポイントなど）を表すユニットを制御します。 systemdに新しいユニットを追加するには、その構成を別の.serviceファイルに記述し、このファイルをのような特別なフォルダーの1つに配置する必要があります</font></font><code>/etc/systemd/system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。次に、ユニットを起動し、オートロードを有効にすることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッケージ</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インストール時に、ユニット構成を含むファイルが自動的に作成されます。システムが起動したときに、ファイルが実行されていてオンになっていることを確認するだけで済みます。</font><font style="vertical-align: inherit;">Dockerの場合、Compose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>  docker-compose@.service</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はAnsibleによって作成されます。</font><font style="vertical-align: inherit;">名前の記号</font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ユニットがテンプレートであることをsystemdに示しています。</font><font style="vertical-align: inherit;">これにより</font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、パラメーターを使用し</font><font style="vertical-align: inherit;">てサービスを開始できます。</font><font style="vertical-align: inherit;">たとえば、</font></font><code>%i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユニット構成ファイルの</font><font style="vertical-align: inherit;">代わりに使用されるサービスの名前を</font><font style="vertical-align: inherit;">使用します。</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=%i service with docker compose<font></font>
Requires=docker.service<font></font>
After=docker.service<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
RemainAfterExit=true<font></font>
WorkingDirectory=/etc/docker/compose/%i<font></font>
ExecStart=/usr/local/bin/docker-compose up -d --remove-orphans<font></font>
ExecStop=/usr/local/bin/docker-compose down<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このロールは</font></font><code>analyzer</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、テンプレート</font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のアドレス</font><font style="vertical-align: inherit;">からファイル</font><b><font style="vertical-align: inherit;">を</font></b><font style="vertical-align: inherit;">生成し</font></font><code>/etc/docker/compose/analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、アプリケーションをで自動的に起動されるサービスとして登録し</font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、移行を適用します。</font><font style="vertical-align: inherit;">役割の準備ができたら、プレイブックを説明する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Gathering facts<font></font>
  hosts: all<font></font>
  become: yes<font></font>
  gather_facts: yes<font></font>
<font></font>
- name: Install docker<font></font>
  hosts: docker<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - docker<font></font>
<font></font>
- name: Install analyzer<font></font>
  hosts: api<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストのリストとロールで使用される変数は、インベントリファイルで指定できます</font></font><code>hosts.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">[api]<font></font>
130.193.51.154<font></font>
<font></font>
[docker:children]<font></font>
api<font></font>
<font></font>
[api:vars]<font></font>
analyzer_image = alvassin/backendschool2019<font></font>
analyzer_pg_user = user<font></font>
analyzer_pg_password = hackme<font></font>
analyzer_pg_dbname = analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのAnsibleファイルの準備ができたら、それを実行します。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ansible-playbook -i hosts.ini deploy.yml</code></pre><br>
<a name="load_testing"></a><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストレステストについて</font></font></b>
                        <div class="spoiler_text">,   ,     .      ,      -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.     :      ,    —   ,         10 . ,         (, ,   CI-):           .<br>
<br>
,     ,      ,        10 .   ?  ,          ,   .  ,     ,       .<br>
<br>
          RPS,      :      . ,    ,     <code>import_id</code>,    <code>POST /imports</code>      .      . <br>
<br>
,       Python 3,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Locust</a>. <br>
<br>
   ,      <code>locustfile.py</code>     <code>locust</code>.         -     .<br>
<br>
 Locust   .    ,        .       <br>
 <code>self.round</code>           .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    locustfile.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># locustfile.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus<font></font>
<font></font>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, constant, task, TaskSet
<span class="hljs-keyword">from</span> locust.exception <span class="hljs-keyword">import</span> RescheduleTask<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.handlers <span class="hljs-keyword">import</span> (<font></font>
    CitizenBirthdaysView, CitizensView, CitizenView, TownAgeStatView<font></font>
)<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen, generate_citizens, url_for<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyzerTaskSet</span>(<span class="hljs-params">TaskSet</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.round = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_dataset</span>(<span class="hljs-params">self</span>):</span><font></font>
        citizens = [<font></font>
            <span class="hljs-comment">#     .   </span>
            <span class="hljs-comment"># PATCH-  relatives    </span>
            <span class="hljs-comment"># ,     - </span>
            <span class="hljs-comment"># (     ,    </span>
            <span class="hljs-comment"># ).</span>
            generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>]),<font></font>
            generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
            *generate_citizens(citizens_num=<span class="hljs-number">9998</span>, relations_num=<span class="hljs-number">1000</span>,<font></font>
                               start_citizen_id=<span class="hljs-number">3</span>)<font></font>
        ]<font></font>
        <span class="hljs-keyword">return</span> {citizen[<span class="hljs-string">'citizen_id'</span>]: citizen <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> citizens}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, method, path, expected_status, **kwargs</span>):</span>
        <span class="hljs-keyword">with</span> self.client.request(<font></font>
                method, path, catch_response=<span class="hljs-literal">True</span>, **kwargs<font></font>
        ) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">if</span> resp.status_code != expected_status:<font></font>
                resp.failure(<span class="hljs-string">f'expected status <span class="hljs-subst">{expected_status}</span>, '</span>
                             <span class="hljs-string">f'got <span class="hljs-subst">{resp.status_code}</span>'</span>)<font></font>
            logging.info(<font></font>
                <span class="hljs-string">'round %r: %s %s, http status %d (expected %d), took %rs'</span>,<font></font>
                self.round, method, path, resp.status_code, expected_status,<font></font>
                resp.elapsed.total_seconds()<font></font>
            )<font></font>
            <span class="hljs-keyword">return</span> resp<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_import</span>(<span class="hljs-params">self, dataset</span>):</span>
        resp = self.request(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/imports'</span>, HTTPStatus.CREATED,<font></font>
                            json={<span class="hljs-string">'citizens'</span>: list(dataset.values())})
        <span class="hljs-keyword">if</span> resp.status_code != HTTPStatus.CREATED:
            <span class="hljs-keyword">raise</span> RescheduleTask
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">'data'</span>][<span class="hljs-string">'import_id'</span>]<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_citizens</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizensView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_citizen</span>(<span class="hljs-params">self, import_id</span>):</span>
        url = url_for(CitizenView.URL_PATH, import_id=import_id, citizen_id=<span class="hljs-number">1</span>)<font></font>
        self.request(<span class="hljs-string">'PATCH'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/{citizen_id}'</span>,<font></font>
                     json={<span class="hljs-string">'relatives'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)]})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_birthdays</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizenBirthdaysView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/birthdays'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_town_stats</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(TownAgeStatView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/towns/stat/percentile/age'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @task</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">workflow</span>(<span class="hljs-params">self</span>):</span>
        self.round += <span class="hljs-number">1</span><font></font>
        dataset = self.make_dataset()<font></font>
<font></font>
        import_id = self.create_import(dataset)<font></font>
        self.get_citizens(import_id)<font></font>
        self.update_citizen(import_id)<font></font>
        self.get_birthdays(import_id)<font></font>
        self.get_town_stats(import_id)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><font></font>
    task_set = AnalyzerTaskSet<font></font>
    wait_time = constant(<span class="hljs-number">1</span>)</code></pre></div>
                    </div><br>
 100  c  ,  ,        :<br>
<br>
<img src="https://habrastorage.org/webt/qx/ri/b3/qxrib3jily9gzmexxhupu35tipa.png"><br>
<br>
       ,           ( — 95 ,  — ).        .<br>
<br>
<img src="https://habrastorage.org/webt/dn/px/fn/dnpxfn5ly7vttziqnnfpvvdsl9g.png"><br>
<br>
      —     Ansible       ~20.15  ~20.30    Locust.<br>
<br>
<img src="https://habrastorage.org/webt/om/1e/ok/om1eoknqvzqmyez-plpgykhz8io.png"></div>
                    </div><br>
<a name="whatelse"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他に何ができますか？</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションのプロファイルを作成したところ、クエリ実行時間全体の約4分の1がJSONのシリアル化と逆シリアル化に費やされていることがわかりました。サービスとの間で送受信されるデータは大量にあります。これらのプロセスは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orjson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリを使用すると大幅に高速化できます</font><font style="vertical-align: inherit;">が、サービスは少し準備する</font><font style="vertical-align: inherit;">
必要があり</font></font><code>orjson</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。これは標準モジュールのドロップイン置換ではありません。</font></font><code>json</code> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常、本番</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">環境</font></a><font style="vertical-align: inherit;">では、</font><font style="vertical-align: inherit;">フォールトトレランスを確保し、負荷に対処するためにサービスのコピーをいくつか必要とします。サービスのグループを管理するには、サービスのコピーが「生きている」かどうかを示すツールが必要です。この問題は</font></font><code>/health</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、作業に必要なすべてのリソース（この場合はデータベース）をポーリング</font><font style="vertical-align: inherit;">するハンドラーによって解決でき</font><font style="vertical-align: inherit;">ます。もし</font></font><code>SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1秒未満で実行され、サービスは有効です。そうでない場合は、それに注意を払う必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションがネットワークで非常に集中的に動作する場合、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uvloop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はパフォーマンスを大幅に向上させることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要な要素は、コードの読みやすさです。私の同僚の1人であるYuri Shikanovは、</font><font style="vertical-align: inherit;">自動検証とコードの実行のための</font><font style="vertical-align: inherit;">いくつかのツール</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">組み合わせた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">灰色の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュールを作成し</font><font style="vertical-align: inherit;">ました。これは、</font></font><code>pre-commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gitフックに</font><font style="vertical-align: inherit;">簡単に追加でき</font><font style="vertical-align: inherit;">、単一の構成ファイルまたは環境変数で設定されます。グレーソート輸入（にあなたを可能に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">言語（の新しいバージョンに応じて、）Pythonの表現を最適化</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyupgrade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、（関数呼び出し、輸入、リストなどの末尾にカンマを追加します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add-trailing-comma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、および単一のフォームに引用符で囲みます（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<a name="final"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* * *</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はこれですべてです。私たちは開発し、テストでカバーし、サービスを組み立てて展開し、負荷テストも実施しました。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">謝辞</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事の執筆、コードのレビュー、私のアイデアやコメントの紹介に時間を割いてくださった方々に心から感謝します。MariaZelenovaへ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゼルマ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ウラジミール・ソロマティン </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leenr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、アナスタシアセメノバ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モルコフ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Yuri Shikanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジズバランゼ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ミハイル・シュパノフ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ミッシュッシュ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Pavel Mosein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pavkazzz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 特にドミトリー・オルロフへ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orlovdl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja499518/index.html">ビデオ会議は現在、市場であり、新しいテクノロジーです。Longrid、パート1</a></li>
<li><a href="../ja499522/index.html">Все нововведения Windows 10 2004 (20H1)</a></li>
<li><a href="../ja499524/index.html">Quarkus：JBoss EAPクイックスタートのhelloworldサンプルを使用したアプリケーションのアップグレード</a></li>
<li><a href="../ja499528/index.html">フェルマーの大定理を超えた「見事な」数学的橋</a></li>
<li><a href="../ja499532/index.html">数の言葉：Yandex.Metricaによる無料のブログ分析habravebinary</a></li>
<li><a href="../ja499536/index.html">自分を知る方法としてのGrowbox</a></li>
<li><a href="../ja499540/index.html">3Dゲームレンダリングのしくみ：テクスチャリングとテクスチャフィルタリング</a></li>
<li><a href="../ja499542/index.html">トップファカポフシアン</a></li>
<li><a href="../ja499544/index.html">Googleスプレッドシートでニューラルネットワークを学ぶ</a></li>
<li><a href="../ja499546/index.html">アナログビデオカメラEVR-Y2022Fのファームウェア開発</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>