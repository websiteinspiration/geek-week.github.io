<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìº üòÑ üõÄüèª Consul + iptables =: 3 ‚úèÔ∏è üôåüèΩ üë∑üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In 2010, Wargaming had 50 servers and a simple network model: backend, frontend, and firewall. The number of servers grew, the model became more compl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Consul + iptables =: 3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486842/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In 2010, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wargaming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> had 50 servers and a simple network model: backend, frontend, and firewall. The number of servers grew, the model became more complicated: staging, isolated VLANs with ACLs, then VPNs with VRF, VLANs with ACLs to L2, VRFs from ACLs to L3. Head is spinning? More will be more fun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When servers began to work 16,000 without tears with so many heterogeneous segments, it became impossible. Therefore, they came up with a different solution. We took the Netfilter stack, added Consul to it as a data source, and we got a fast distributed firewall. They replaced the ACL on the routers and used as an external and internal firewall. For dynamic tool management, we developed the BEFW system, which was used everywhere: from controlling user access to the grocery network to isolating network segments from each other.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/wg/bd/odwgbdlxcjww7ln1u_btv23hyvq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How it all works and why you should take a closer look at this system, tells </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ivan Agarkov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">annmuor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - the head of the infrastructure security group of the Maintenance unit at the Minsk company development center. </font><font style="vertical-align: inherit;">Ivan is a SELinux fan, loves Perl, writes code. </font><font style="vertical-align: inherit;">As the head of the IB group, he regularly works with logs, backups and R&amp;D to protect Wargaming from hackers and ensure the operation of all game servers in the company.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4zP67uYnsR4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">History reference</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before telling how we did it, I‚Äôll tell you how we came to this and why it was needed. To do this, we transfer 9 years ago: 2010, only the World of Tanks appeared. Wargaming had approximately 50 servers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e6/qf/6h/e6qf6hugl_efcmn73qn16mcyeoc.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Growth graph of company servers.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We had a network model. For that time it was optimal. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/zw/vj/bizwvjhrfphzbrhme6v1avzjxag.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The network model in 2010.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
At the front end there are bad guys who want to break us, but there is a firewall in it. There is no firewall on the backend, but there are 50 servers there, we all know them. Everything works well. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Over 4 years, the server fleet has grown 100 times, up to 5000. The first isolated networks appeared - stageing: they can‚Äôt go into production, and often things that could be dangerous were spinning there. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z0/6e/ba/z06ebavv-r6yu7fuhy2zvvhsnw0.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network model in 2014.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By inertia, all the same pieces of iron were used, and all work was done on isolated VLANs: ACLs are written to the VLAN that allow or prohibit any connection. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2016, the number of servers reached 8000. Wargaming absorbed other studios, additional affiliate networks appeared. They seem to be ours, but not quite: VLAN often does not work for partners, you have to use a VPN with VRF, isolation becomes more complicated. A mixture of ACL isolates grew. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w-/zj/ej/w-zjej3fr8frinvbg4z1thbwdre.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The network model in 2016.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
By the beginning of 2018, the fleet of cars grew to 16,000. There were 6 segments, and the rest we did not count, including closed ones, in which financial data were stored. There are container networks (Kubernetes), DevOps, cloud networks connected via VPN, for example, from the IVS. There were a lot of rules - it hurt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/zf/cd/ivzfcdz9lzxsiugegpfthzwubik.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network model and isolation methods in 2018.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For isolation we used: VLAN with ACL on L2, VRF with ACL on L3, VPN and much more. </font><font style="vertical-align: inherit;">Too much.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problems</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everyone lives with ACLs and VLANs. </font><font style="vertical-align: inherit;">What is generally wrong? </font><font style="vertical-align: inherit;">Harold, hiding the pain, will answer this question. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y2/hi/tl/y2hitlbrqlvcbm6rjg59tzaaqxw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were many problems, but there were five massive ones.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geometric price increases for the new rules</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Each new rule was added longer than the previous one, because you had to first see if there was already such a rule.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is no firewall inside the segments</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Segments were somehow separated from each other, inside there are already not enough resources.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The rules have been applied for a long time. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hands one local rule operators could write in an hour. </font><font style="vertical-align: inherit;">Global took several days.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difficulties with the audit of the rules</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">More precisely, it was not possible. </font><font style="vertical-align: inherit;">The first rules were written back in 2010, and most of their authors no longer worked for the company.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Low level of control over infrastructure</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is the main problem - we did not know well what was going on with us.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is what the network engineer looked like in 2018 when he heard: ‚ÄúWe need some more ACLs.‚Äù</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/rl/_i/hhrl_ig_xefe7lps5yrz_liioam.png" width="350"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solutions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the beginning of 2018, it was decided to do something about it. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The price of integration is constantly growing.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The starting point was that large data centers no longer supported isolated VLANs and ACLs, because the memory on the devices ran out. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solution: removed the human factor and automated the provision of access to the maximum. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New rules apply for a long time.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solution: speed up the application of the rules, make it distributed and parallel. To do this, you need a distributed system so that the rules are delivered on their own, without rsync or SFTP per thousand systems. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The lack of a firewall inside the segments.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The firewall inside the segments began to fly to us when different services appeared within the same network. Solution: use a host-based firewall. Almost everywhere we have Linux, and iptables are everywhere, this is not a problem. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difficulties with the audit of the rules.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solution: keep all the rules in a single place for review and management, so we can audit everything. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Low level of control over infrastructure.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Solution: take an inventory of all services and accesses between them.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is more of an administrative process than a technical one. </font><font style="vertical-align: inherit;">Sometimes we have 200-300 new releases per week, especially during promotions and on holidays. </font><font style="vertical-align: inherit;">However, this is only for one team of our DevOps. </font><font style="vertical-align: inherit;">With so many releases, it's impossible to see what kind of ports, IP, integration are needed. </font><font style="vertical-align: inherit;">Therefore, we needed specially trained service managers who interviewed the teams: ‚ÄúWhat is there and why did you raise it?‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After all that we launched, the network engineer in 2019 began to look like this.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/fx/qi/yvfxqisjbogjxfy6czj0p6xmvuw.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consul</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We decided that we would put everything that we found with the help of service managers in Consul and from there we would write iptables rules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How did we decide to do this?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We collect all the services, networks and users.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's make iptables rules based on them.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automate control.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PROFIT.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consul is not a remote API; it can work on every node and write to iptables. </font><font style="vertical-align: inherit;">It remains only to come up with automatic controls that will clean out the excess, and most of the problems will be solved! </font><font style="vertical-align: inherit;">We will finalize the rest in the process.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why consul?</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well established.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In 2014-15, we used it as a backend for Vault, in which we store passwords. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Does not lose data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . During use, Consul did not lose data in any accident. This is a huge plus for the firewall management system. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P2P communications accelerate the spread of change</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . With P2P, all changes come quickly, no need to wait for hours. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convenient REST API.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We also considered Apache ZooKeeper, but it does not have a REST API, you will have to put crutches. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It works as a keystore (KV), and as a directory (Service Discovery)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . You can immediately store services, catalogs, data centers. This is convenient not only for us, but also for neighboring teams, because when building a global service, we think big.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Written in Go, which is part of the Wargaming stack. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We love this language, we have many Go developers. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Powerful ACL system. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In Consul, you can use ACLs to manage who and what to write. </font><font style="vertical-align: inherit;">We guarantee that the rules of the firewall will not overlap with anything else and we will not have problems with this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But Consul has its drawbacks.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It does not scale within the data center, if you do not have a business version. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is scaled only by the federation.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Very dependent on network quality and server load. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consul will not function normally as a server on a busy server if there are any lags in the network, for example, uneven speed. </font><font style="vertical-align: inherit;">This is due to P2P connections and update distribution models.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Difficulties with accessibility monitoring</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In the status of Consul can say that everything is fine, but he has long died.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We solved most of these problems during the operation of Consul, so we chose it. </font><font style="vertical-align: inherit;">The company has plans for an alternative backend, but we have learned how to deal with problems and are still living with Consul.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How Consul Works</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the conditional data center, we install servers - from three to five. </font><font style="vertical-align: inherit;">One or two servers will not work: they will not be able to organize a quorum and decide who is right, who is wrong, when the data does not match. </font><font style="vertical-align: inherit;">More than five makes no sense, performance will drop. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/bb/ms/ljbbms9ipssmvl-pooll-judvgs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Clients connect in any order to the servers: the same agents, only with a flag </font></font><code>server = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jx/ku/ub/jxkuubjet3kolzk07yqq0qkak8m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, clients receive a list of P2P connections and build connections between themselves. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/st/ca/owstcacfv-iuaz42vdlyk1cmes8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the global level, we are interconnecting several data centers. </font><font style="vertical-align: inherit;">They also connect P2P and communicate. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gx/5r/s5/gx5rs5yetwzbe63odrgx6ppfnm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we want to collect data from another data center, the request goes from server to server. </font><font style="vertical-align: inherit;">Such a scheme is called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Serf protocol</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The Serf protocol, like Consul, is developed by HashiCorp.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A Few Important Facts About Consul</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consul has documentation describing his work. </font><font style="vertical-align: inherit;">I will give only selected facts that are worth knowing. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consul servers select masters from among the voters</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Consul selects the wizard from the list of servers for each data center, and all requests go only to it, regardless of the number of servers. </font><font style="vertical-align: inherit;">Hanging the wizard does not lead to re-election. </font><font style="vertical-align: inherit;">If the wizard is not selected, the requests are not served by anyone.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do you want horizontal scaling? </font><font style="vertical-align: inherit;">Sorry, but no.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A request to another data center goes from master to master, regardless of which server it came to. </font><font style="vertical-align: inherit;">The selected master receives 100% of the load, except for the load on the forward requests. </font><font style="vertical-align: inherit;">All data center servers have an up-to-date copy of the data, but only one answers.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The only way to scale is to enable stale mode on the client.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In stale mode, you can respond without quorum. This is a mode in which we refuse data consistency, but we read a little faster than usual and any server responds. Naturally, recording is only through the master. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consul does not copy data between data centers</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . When collecting federation, each server will have only its own data. For others, he always turns to someone else. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The atomicity of operations is not guaranteed outside the transaction</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Remember that not only you can change something. If you want it differently, conduct a transaction with a lock. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blocking operations do not guarantee blocking</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The request goes from master to master, and not directly, so there is no guarantee that the lock will work when you lock, for example, in another data center.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACLs do not guarantee access either (in many cases)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The ACL may not work because it is stored in one data center of the federation - in the ACL data center (Primary DC). If the DC does not answer you, the ACL will not work. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One hovering wizard will freeze the entire federation</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For example, in the federation there are 10 data centers, and in one there is a bad network, and one master falls. Everyone who communicates with him is stuck in a circle: a request is being made, there is no answer to it, the thread hangs. It will not be possible to find out when this will happen, just in an hour or two the whole federation will fall. You cannot do anything about it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Status, quorum and elections are processed in a separate thread. </font><font style="vertical-align: inherit;">Re-selection will not happen, the status will not show anything. </font><font style="vertical-align: inherit;">You think that you have a live Consul, you ask, and nothing happens - there is no answer. </font><font style="vertical-align: inherit;">Moreover, the status shows that everything is fine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We faced this problem, we had to rebuild specific parts of data centers in order to avoid it. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The business version of Consul Enterprise does not have some of the drawbacks above</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It has many useful functions: voting, distribution, scaling. </font><font style="vertical-align: inherit;">There is only one ‚Äúbut‚Äù - a licensing system for a distributed system is very expensive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Life hack: </font></font><code>rm -rf /var/lib/consul</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a cure for all diseases of the agent. </font><font style="vertical-align: inherit;">If something doesn‚Äôt work for you, simply delete your data and download the data from the copy. </font><font style="vertical-align: inherit;">Most likely, Consul will work.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Befw</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's talk about what we added to Consul. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BEFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - an acronym for </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bed and</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ack </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nd </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the F</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the ire of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the W</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> all. </font><font style="vertical-align: inherit;">It was necessary to somehow name the product when I created the repository in order to put the first test commits into it. </font><font style="vertical-align: inherit;">This name remains.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rules Templates</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rules are written in iptables syntax.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-N BEFW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-P INPUT DROP</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A INPUT -m state ‚Äî state RELATED, ESTABLISHED -j ACCEPT</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A INPUT -i lo -j ACCEPT</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A INPUT -j BEFW</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We all go to BEFW chain, except </font></font><code>ESTABLISHED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RELATED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and localhost. </font><font style="vertical-align: inherit;">The template can be anything, this is just an example. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is BEFW useful for?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Services</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have a service, it always has a port, the node on which it works. </font><font style="vertical-align: inherit;">From our node, we can locally ask the agent and find out that we have some kind of service. </font><font style="vertical-align: inherit;">You can also put tags. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/lc/7n/fmlc7n4h4rmyqbeemb7lcn6lzco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any service that is running and registered with Consul turns into an iptables rule. </font><font style="vertical-align: inherit;">We have SSH - open port 22. The bash script is simple: curl and iptables, nothing else is needed.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to open access not to everyone, but selectively? </font><font style="vertical-align: inherit;">By the name of the service, add IP lists to the KV repository. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pg/y4/nu/pgy4nufltcqaimdqv7ncfpntix0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we want everyone from the tenth network to be able to access the SSH_TCP_22 service. </font><font style="vertical-align: inherit;">Add one small TTL field? </font><font style="vertical-align: inherit;">and now we have temporary permissions, for example, for a day.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accesses</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We connect services and customers: we have a service, for each KV-storage is ready. </font><font style="vertical-align: inherit;">Now we give access not to everyone, but selectively.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/yo/vn/f1yovnkwz7qddj1sw267obg3gvk.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Groups</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If every time we write thousands of IPs for accesses, we will get tired. </font><font style="vertical-align: inherit;">Let's come up with groupings - a separate subset in KV. </font><font style="vertical-align: inherit;">We will call it Alias ‚Äã‚Äã(or groups) and we will store groups there according to the same principle. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/un/um/vzunum6qz9s9fs8odlwiwlz6vsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connect: now we can open SSH not specifically on P2P, but on a whole group or several groups. </font><font style="vertical-align: inherit;">Similarly, there is TTL - you can add to the group and remove from the group temporarily.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/2w/as/ao2was0eioehjrwnn1ypgh4zj5w.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our problem is the human factor and automation. So far we have solved it like that. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/pv/j0/8gpvj0liyxy64mamjpwr8nbn4xc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We work with Puppet, and transfer everything related to the system (application code) to it. Puppetdb (regular PostgreSQL) stores a list of services that are running there, you can find them by resource type. There you can find who goes where. We also have a pull request and merge request system for this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We wrote befw-sync, the simplest solution that helps transfer data. First, sync cookies go to puppetdb. The HTTP API is configured there: we ask what services we have, what needs to be done. Then they make a request to Consul.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Is there integration? </font><font style="vertical-align: inherit;">Yes: they wrote the rules, allowed to accept the Pull Request. </font><font style="vertical-align: inherit;">Need some port or add a host to some group? </font><font style="vertical-align: inherit;">Pull Request, review - no more "Find 200 other ACLs and try to do something about it."</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimization</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Localhost ping with an empty rule chain takes 0.075 ms. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/6p/ce/_j6pceeghhejvrabuazobzgbfmw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add 10,000 iptables to this chain. </font><font style="vertical-align: inherit;">As a result, ping will increase by 5 times: iptables is completely linear, processing each address takes some time. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/v9/ic/erv9ic34w6oqhoy7aekpfimpys4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the firewall, into which we migrate thousands of ACLs, we have many rules, and this introduces a delay. </font><font style="vertical-align: inherit;">For gaming protocols, this is bad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But if we put </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10,000 addresses in ipset</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ping will even decrease. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_l/zb/qs/_lzbqsckkctv-01v3vu-irjhvcq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The point is that the ‚ÄúO‚Äù (algorithm complexity) for ipset is always 1, no matter how many rules there are. </font><font style="vertical-align: inherit;">True, there is a limitation - there cannot be more than 65535 rules. For now, we live with this: you can combine them, expand them, make two ipsets in one.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Storage</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The logical continuation of the iteration process is the storage of customer information for the service in ipset. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/up/dv/x0updv72n35faryycb_ntjmpqik.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have the same SSH, and we do not immediately write 100 IP, but we set the name ipset to communicate with, and the following rule </font></font><code>DROP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">You can redo the rule ‚ÄúWho is not here, that is DROP‚Äù, but more clearly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we have rules and sets. </font><font style="vertical-align: inherit;">The main task is to make a set before writing the rule, because otherwise iptables will not write the rule.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">General scheme</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the form of a diagram, everything that I said looks like this. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/qa/i-/9wqai-52aq3i3onq1dovwbfzpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commit to Puppet, everything is sent to the host, services are here, ipset is there, and whoever is not registered there is not allowed.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Allow &amp; deny</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To quickly save the world or quickly turn off someone, at the beginning of all the chains we made two ipset: </font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>rules_deny</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">How it works? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, someone with bots creates a load on our Web. </font><font style="vertical-align: inherit;">Previously, it was necessary to find its IP by the logs, refer it to network engineers so that they could find the source of the traffic and ban it. </font><font style="vertical-align: inherit;">Now it looks different. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a6/so/xq/a6soxqdkwf8qokucl-ztjs6xdde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We ship to Consul, wait 2.5 s, and you're done. </font><font style="vertical-align: inherit;">Since Consul quickly distributes through P2P, it works everywhere, anywhere in the world. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once I somehow completely stopped WOT, making a mistake with the firewall. </font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- This is our insurance against such cases. </font><font style="vertical-align: inherit;">If we made a mistake with the firewall somewhere, something is blocked somewhere, we can always send a conditional </font></font><code>0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to quickly raise everything. </font><font style="vertical-align: inherit;">Then we will fix everything with our hands.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other sets</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can add any other sets in space </font></font><code>$IPSETS$</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/md/hv/jf/mdhvjfb8t36heje-udbnw5fly0m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What for? </font><font style="vertical-align: inherit;">Sometimes someone needs an ipset, for example, to emulate the disconnection of some part of the cluster. </font><font style="vertical-align: inherit;">Everyone can bring any sets, call them and they will be taken from Consul. </font><font style="vertical-align: inherit;">At the same time, the sets can both participate in the iptables rules and be like a team </font></font><code>NOOP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: consistency will be supported by the daemon.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Users</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It used to be like this: a user connected to a network and received parameters through a domain. </font><font style="vertical-align: inherit;">Until the next generation of firewalls, Cisco was not able to understand where the user is and where is the IP. </font><font style="vertical-align: inherit;">Therefore, access was granted only through hostname-machines. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What have we done? </font><font style="vertical-align: inherit;">Wedged in at the time of receiving the address. </font><font style="vertical-align: inherit;">Usually it is dot1x, Wi-Fi or VPN - everything goes through RADIUS. </font><font style="vertical-align: inherit;">For each user, create a group by user name and put an IP with TTL in it, which is equal to its dhcp.lease - as soon as it expires, the rule will disappear. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/ps/ad/tfpsad3jh-egdfn_uehr3yvmcao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can open access to services, as well as to other groups, by username. </font><font style="vertical-align: inherit;">We got rid of the pain with the hostname when they change, and took the load off the network engineers because they no longer needed Cisco. </font><font style="vertical-align: inherit;">Now, engineers themselves prescribe access to their servers.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insulation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In parallel, we began to disassemble the insulation. </font><font style="vertical-align: inherit;">Service managers took an inventory, and we analyzed all our networks. </font><font style="vertical-align: inherit;">We decompose them into the same groups, and on the necessary servers the groups were added, for example, to deny. </font><font style="vertical-align: inherit;">Now the same staging isolation gets into rules_deny in production, but not in production itself. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fd/9g/ed/fd9gedlbs2_9gyyg-5lwm_fp75m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The scheme works quickly and simply: remove all ACLs from servers, unload hardware, reduce the number of isolated VLANs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrity control</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Previously, a special trigger worked for us, which informed when someone changed the firewall rule with their hands. </font><font style="vertical-align: inherit;">I wrote a huge firewall rule checker, it was difficult. </font><font style="vertical-align: inherit;">Now integrity controls BEFW. </font><font style="vertical-align: inherit;">He zealously makes sure that the rules he makes do not change. </font><font style="vertical-align: inherit;">If someone changes the rules of the firewall, he will return everything back. </font><font style="vertical-align: inherit;">‚ÄúI quickly raised a proxy here to work from home‚Äù - there are no such options anymore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW controls the ipset from the services and list in befw.conf, the service rules in the BEFW chain. </font><font style="vertical-align: inherit;">But does not follow other chains and rules and other ipset.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accident protection</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW always saves the last successful state directly in the binary structure of state.bin. If something went wrong, it always rolls back to this state.bin. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2z/fe/ru/2zferuy2qiohwpa6odt1s0d642g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is Consul's unstable insurance when he did not send data or someone made a mistake and used rules that could not be applied. So that we are not left without a firewall, BEFW will roll back to the last state if an error occurs at some stage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In critical situations, this is a guarantee that we will remain with a working firewall. We open all gray networks in the hope that the admin will come and fix it. Someday I will take it out in configs, but now we just have three gray networks: 10/8, 172/12 and 192.168 / 16. As part of our Consul, this is an important feature that helps to develop further.</font></font><br>
<br>
<em>:      -  BEFW.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> GitHub</a>.</em><br>
<br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll tell you about the bugs we encountered. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset add set 0.0.0.0/0.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What happens if you add to ipset 0.0.0.0/0? Will all IPs be added? Will Internet access be opened? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, we get a bug that cost us two hours of downtime. Moreover, the bug has not been working since 2016, it lies in RedHat Bugzilla under the number # 1297092, but we found it by accident - from the developer's report. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now BEFW has a strict rule, which </font></font><code>0.0.0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">turns into two addresses: </font></font><code>0.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>128.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset restore set &lt;file.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What does ipset do when you tell it </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Do you think it works just like iptables? Recover data? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nothing of the kind - he does a merge, and the old addresses do not disappear, you do not close access.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We found a bug when we tested isolation. Now there is a rather complicated system - instead of being </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carried out </font></font><code>create temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then </font></font><code>restore flush temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>restore temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. At the end of swap: for atomicity, because if you first carry out </font></font><code>flush</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and at that moment some package arrives, it will be discarded and something will go wrong. Therefore, there is a little black magic. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consul kv get -datacenter = other.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As I said, we think that we are requesting some data, but we will get either data or an error. We can do this through Consul locally, but in this case both one and the other will hang. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The local Consul client is a wrapper over the HTTP API. But it just hangs and does not answer either Ctrl + C, or Ctrl + Z, no matter what, only</font></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the adjacent console. </font><font style="vertical-align: inherit;">We came across this when we were building a large cluster. </font><font style="vertical-align: inherit;">But we still have no solution, we are preparing to correct this error in Consul. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consul leader is not responding. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our master in the data center does not respond, we think: ‚ÄúProbably, the re-selection algorithm will work now?‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, it will not work, and monitoring will not show anything: Consul will say that there is a commitment index, a leader has been found, everything is fine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How are we fighting this? </font></font><code>service consul restart</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in cron every hour. </font><font style="vertical-align: inherit;">If you have 50 servers - no big deal. </font><font style="vertical-align: inherit;">When there will be 16,000, you will understand how it works.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we got the following advantages:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100% coverage of all Linux machines.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automation</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Freed iron and network engineers from slavery.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are integration opportunities that are almost endless: even with Kubernetes, even with Ansible, even with Python.</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cons</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Consul, with whom we now live, and a very high price of error. </font><font style="vertical-align: inherit;">As an example, once at 6 pm (prime time in Russia), I ruled something on the lists of networks. </font><font style="vertical-align: inherit;">We were building insulation at BEFW just then. </font><font style="vertical-align: inherit;">I was mistaken somewhere, it seems, I indicated the wrong mask, but everything fell in two seconds. </font><font style="vertical-align: inherit;">Monitoring lights up, the duty officer comes in: ‚ÄúEverything lies with us!‚Äù </font><font style="vertical-align: inherit;">The head of the department turned gray when he explained to the business why this happened. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The price of the error is so high that we came up with our own complicated prophylaxis procedure. </font><font style="vertical-align: inherit;">If you will implement it on a large production, you do not need to give a master token over Consul to everyone. </font><font style="vertical-align: inherit;">It will end badly. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cost.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wrote the code for 400 hours alone. </font><font style="vertical-align: inherit;">To support my team of 4 people spends 10 hours a month at all. </font><font style="vertical-align: inherit;">Compared to the price of any new generation firewall, it's free. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plans. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The long-term plan is the search for alternative transport in return for or in addition to Consul. </font><font style="vertical-align: inherit;">Perhaps it will be Kafka or something like that. </font><font style="vertical-align: inherit;">But in the coming years we will live on Consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immediate plans: integration with Fail2ban, with monitoring, with nftables, possibly with other distributions, metrics, advanced monitoring, optimization. </font><font style="vertical-align: inherit;">Kubernetes support is also somewhere in the plans, because right now we have several clusters and desire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another of the plans:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">search for traffic anomalies;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">network map management;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes support;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assembly of packages for all systems;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web UI</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are constantly working on expanding the configuration, increasing metrics and optimizing. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Join the project. </font><font style="vertical-align: inherit;">The project turned out to be cool, but, unfortunately, this is still a project of one person. </font><font style="vertical-align: inherit;">Come to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and try to do something: commit, test, offer something, give your assessment.</font></font></i><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the meantime, we are preparing for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saint HighLoad ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which will be held on April 6 and 7 in St. Petersburg, and we invite developers of high-loaded systems </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to apply for a report</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Experienced speakers already know what to do, and we recommend that newcomers to speeches at least </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">try</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Participating in the conference as a speaker has several advantages. </font><font style="vertical-align: inherit;">Which, you can read, for example, at the end of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486822/index.html">[By the docks] Flutter. Part 4. For web developers</a></li>
<li><a href="../en486824/index.html">Bad advice when working with ANTLR</a></li>
<li><a href="../en486826/index.html">Creating a full-fledged Viberbot on Django 2 and the Viber REST API. Part One - Webhook</a></li>
<li><a href="../en486828/index.html">Food Design Digest, January 2020</a></li>
<li><a href="../en486832/index.html">How many years taiga go - understand no</a></li>
<li><a href="../en486844/index.html">The evolution of Facebook webhook processing: from zero to 25,000 per second</a></li>
<li><a href="../en486850/index.html">New reserved seat - like a capsule hotel</a></li>
<li><a href="../en486858/index.html">Creating a full-fledged Viberbot. Part two - first contact or "conversion_started"</a></li>
<li><a href="../en486860/index.html">ATX12VO - Eating a New Way</a></li>
<li><a href="../en486862/index.html">5 reasons why motion design helps you connect with people</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>