<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😳 🤽🏻 ☺️ 集成服务器负载指标评估 🌰 🔜 😙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在该国最大的银行之一工作时，我不得不处理评估约1.6万台服务器的资源使用效率的任务。该任务的制定非常简单-必须开发一种方法来评估一段时间内的服务器负载指标。理想情况下，应使用一个或几个（不超过8个）数字来估算每个时间段的服务器负载。
 
 关于使用虚拟服务器的功能的几点说明
 大型组织（尤其是银行）...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>集成服务器负载指标评估</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498360/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在该国最大的银行之一工作时，我不得不处理评估约1.6万台服务器的资源使用效率的任务。</font><font style="vertical-align: inherit;">该任务的制定非常简单-必须开发一种方法来评估一段时间内的服务器负载指标。</font><font style="vertical-align: inherit;">理想情况下，应使用一个或几个（不超过8个）数字来估算每个时间段的服务器负载。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于使用虚拟服务器的功能的几点说明</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大型组织（尤其是银行）使用各种虚拟化技术将传统应用程序部署在不同的服务器上，杂乱无章。私有云是一种有前途的技术，但实际上，大型组织将长期使用各种虚拟化平台来部署各种应用程序。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
随着虚拟化平台的发展，公司中没人会了解资源的使用效率。由于各种服务器使用情况，即使是最先进的监视工具也无法提供此问题的答案。例如，一个部门可能有一个报表服务器，它将仅在有限的时间段内完全加载。在月底说3-4个小时。在现实生活中，没有人为这些服务器动态分配资源-这在技术和组织上都是困难的。资源是专门为最大的周期性服务器负载分配的，尽管这种情况很少发生。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总之，在大型组织中，虚拟服务器场资源的使用效率极低。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下面，我提出一种方法，您可以通过这种方法轻松地证明分配给虚拟服务器的资源的增加和减少的理由，而不管情况如何。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要评估资源负载，有必要收集各种计数器的统计信息；要评估资源负载，将使用各种度量。按照惯例，计数器可以分为两种类型（根据变化率）：“快速”和“慢速”。 “快速”计数器的一个很好的例子是处理器负载计数器（％CPU）。慢速计数器的一个示例是可用硬盘空间的百分比（％FreeSpace）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
慢速计数器的评估包括计算该期间指标的极值（最小值或最大值）。这种方法允许（例如，在评估磁盘可用空间时）估计可用资源，并在必要时分配其他卷或减少当前卷。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于快速计数器，使用另一种方法。在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">很好地描述了使用简单的积分指标（平均值，最大值，最小值和中位数）来评估此类计数器的动态的缺点</font><font style="vertical-align: inherit;">。常见的缺点包括缺乏有关增加的负载（中和峰值）的信息。如果我们将周期的最大值作为整数指标，那么异常值的存在（例如，程序启动时CPU的即时加载高达100％）将无法提供客观信息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文章中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">建议使用0.9分位数来估算快速度量（此值表示在90％的样本中观察到的值位于该水平以下的水平）。根据此指标，在服务器负载均匀的情况下，我们可以充分估计平均处理器负载。但是这种方法具有相同的缺点-缺乏有关增加的负载（中和峰值）的信息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下面，以％CPU计数器的每周和每日图表为例。图表上的最大计数器值为100％。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ym/al/xi/ymalxitgoyqlsthnyhs0cjttbie.png"><br>
<br>
<img src="https://habrastorage.org/webt/wj/xk/aj/wjxkajy2y3enm93easqblqnl-x8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该图显示，在指定的时间段内，负载突增，持续约3小时。对于此计数器，本周计算了各种指标。图2显示，中值（绿线，5％值），平均值（黄色，12％值）和0.9分位数（红色，27％值）过滤了负载变化，并且丢失了有关负载的信息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为分位数概念的发展，我想提出滑动分位数的概念。这类似于</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移动平均线。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但分位数0.9用作窗口函数。</font><font style="vertical-align: inherit;">此外，我们将使用2个滑动分位数来估算计数器的级别-短期（1小时）快速运行，而长期（24小时）缓慢运行。</font><font style="vertical-align: inherit;">快速分位数将过滤掉瞬时排放并提供峰值负荷信息。</font><font style="vertical-align: inherit;">缓慢的分位数将允许您估计平均负载。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从图中可以看出，移动的分位数为0.9是动态特征（棕色-快速，紫色-慢速）。</font><font style="vertical-align: inherit;">为简单起见，评估计数器的状态作为建议使用的指标：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1小时周期的最大分位数，显示该时间段内的最大连续服务器负载，</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">24小时的平均分位数，显示该期间的平均服务器负载。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在图中，快速分位数的最大值是85％处的黑线，慢速分位数的平均值是30％处的粉红线。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在分析服务器资源的负载（根据％CPU计数器）时，如果我们将月份的平均值（12％）作为度量标准，则会做出错误的决定以减少分配的资源。</font><font style="vertical-align: inherit;">双快/慢移动分位数度量（分别为85％和30％）表明分配的资源足够，但是没有剩余。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">决断</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
资源利用效率评估的实施已分解为三个任务：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据采集 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">评估方法的发展 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当前架构中的方法论实施 </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上面，我检查了此实现的任务2，下面我们将讨论第三个任务。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数据收集在ClickHouse数据库中。 DBMS专栏是存储时间序列数据的理想选择。在</font><font style="vertical-align: inherit;">2019年9月5日的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouse聚会中对此</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行了详细讨论</font><font style="vertical-align: inherit;">。可在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到ClickHouse与其他时间序列DBMS的比较</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于数据收集的结果，我们形成了几个表，其中的数据是逐行组织的（每个计数器的值写在单独的行中）。当然，原始数据也存在问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一个问题是计数器条目之间的间隔不均匀。例如，如果标准计数器记录时间为5分钟，则有时会出现间隙，下一条记录会比上一个记录多5分钟（最多20分钟）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二个问题是，有时计数器数据使用相同的时间戳出现两次或多次（具有不同的值）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第三个问题-ClickHouse没有窗口功能。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要解决第一个问题，可以使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASOF JOIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。这个想法很简单-每个服务器的每个计数器都以均匀填充的时间间隔均匀地创建一个表。使用ASOF JOIN允许使用原始数据表中最接近的值填充新表中的值（可以配置类似于ffill和bfill的填充选项）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二个问题的解决方案是在给定时间选择最大值进行聚合。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了解决第三个问题，考虑了几种解决方案。</font><font style="vertical-align: inherit;">首先，由于性能不足，Python脚本被拒绝。</font><font style="vertical-align: inherit;">第二种解决方案-将原始数据复制到MSSQL数据库，计算指标并复制回-实施起来似乎太复杂了。</font><font style="vertical-align: inherit;">MSSQL也具有窗口函数，但是不需要聚合函数。</font><font style="vertical-align: inherit;">可能会感到困惑，并编写了自己的SQL CLR函数。</font><font style="vertical-align: inherit;">但是由于过于复杂，该选项被拒绝了。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一个有效的解决方案可能是ClickHouse的SQL脚本。</font><font style="vertical-align: inherit;">下面给出了此脚本的示例。</font><font style="vertical-align: inherit;">为简单起见，我只查看了多个服务器的单个计数器的快速分位数。</font><font style="vertical-align: inherit;">该解决方案看起来不是很简单，也不是很方便，但是可以工作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果，在PowerBI中创建了一个测试报告以演示该方法。 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qk/t9/kgqkt92tcilmz8h9gqieermwz3w.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/c_/m5/tk/c_m5tk-r1ehlvrdhh_dbsj3rzie.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，我想对解决方案的开发进行推测。</font><font style="vertical-align: inherit;">如果从数据仓库的角度看解决方案，您会发现以这种方式解决了从原始数据层（暂存区）创建数据仓库（数据仓库）的任务。</font><font style="vertical-align: inherit;">您可以讨论该体系结构，但对于ClickHouse作为列数据库而言，规范化并不重要（甚至可能有害）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在创建具有不同生存期（TTL）的汇总表（日，周，月）时，可以看到存储库的进一步发展。</font><font style="vertical-align: inherit;">这样可以避免存储过度膨胀。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一步可能是将数据用于预测分析。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
附注</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
：用于测试的代码和数据已发布</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN498346/index.html">GoLand 2020.1-增强了对Go模块的支持，很多自动完成功能以及更多功能</a></li>
<li><a href="../zh-CN498350/index.html">最好的面试和求职材料</a></li>
<li><a href="../zh-CN498352/index.html">SHISHUA：世界上最快的伪随机数生成器</a></li>
<li><a href="../zh-CN498354/index.html">如何将“愿望清单”转换为“硬件”或半理想的半移动半桌面</a></li>
<li><a href="../zh-CN498358/index.html">学习法语或如何从PSA诊断扫描仪获取通用适配器</a></li>
<li><a href="../zh-CN498362/index.html">金士顿在固态硬盘出货量方面保持领先地位：我们如何做到这一点？</a></li>
<li><a href="../zh-CN498366/index.html">Yandex开发人员每天执行哪些算法</a></li>
<li><a href="../zh-CN498368/index.html">一键开关的故事</a></li>
<li><a href="../zh-CN498370/index.html">SAP UI5和确认窗口：关于上下文</a></li>
<li><a href="../zh-CN498372/index.html">网络模拟器教程ns-3。第五章</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>