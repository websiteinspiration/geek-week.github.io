<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§üüèø üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ ü•ê Everyday Life Tinkoff Security Operations Center: Single Bootloader Analysis üòµ ‚úä üòπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 
 
 In our Tinkoff Security Operation Center, we regularly analyze the techniques used in malware and attacks, and recently we came acros...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Everyday Life Tinkoff Security Operations Center: Single Bootloader Analysis</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/504430/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our Tinkoff Security Operation Center, we regularly analyze the techniques used in malware and attacks, and recently we came across one interesting file that we would like to talk about.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/u9/yk/wju9ykf2tcl0k7ab3xohfmoilge.png" alt="image"><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The technique that was used to create this masterpiece has been known for over 20 years, but even decades later it remains relevant, since the calls of some checks in the macro are not suspicious and can be used in legitimate documents. </font><font style="vertical-align: inherit;">This is a malware downloader written in Excel 4.0 macros.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tools</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As part of the analysis, we will use third-party tools to a minimum and get by with a standard set of programs:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft Office Suite</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archiver;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text editor;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as a tool for analyzing software actions, we will use Sysmon;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as an environment for analysis, we will use a VM with Windows 7 on board</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mnogabukaf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The document we are going to parse is an Excel workbook in xls format. </font><font style="vertical-align: inherit;">The malware is delivered in phishing emails, when the document starts, the macro unloads the registry branch, downloads information about Office updates from the Microsoft website, and also downloads and launches malicious .dll. </font><font style="vertical-align: inherit;">After these steps, the book closes without saving changes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main difference from other loaders of this type is that it does not use VBA macros.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Static analysis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following is an example of an email containing a malicious document. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/sf/hl/pnsfhllpvob_d_b7sop7ljyv7jq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open the attachment in our virtual machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You should pay attention right away: the picture warns that the document is ‚Äúprotected‚Äù and it is worth opening it locally and clicking on ‚Äúenable content‚Äù: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/mj/eu/sgmjeuardcvtcxqdvuf-wpk5ul0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A security warning hints that you need to look at projects in the Visual Basic Editor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We turn to the developer - macro management (vbs), but we do not see any vbs or vba macros: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/te/jj/pn/tejjpn888lj2jfeoyj9snzxugos.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the time to remember what office documents are. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each Microsoft Office document is an archive that can be unzipped using any archiver, extracting the contents of the document:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/nj/hg/kfnjhgg1rmz7xffqsfm5w0plojk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After unpacking, we see that inside the documents there are no xml files that we are used to seeing, the thing is in the older document format - xls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the xls extension, content is not stored in Office Open XML format, but in BIFF8 binary format. The document uses Excel 4.0 macro, where macros can be executed in document cells. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth noting that the sheet with the macro is not hidden, but the sheet has a large number of empty cells, which makes analysis difficult. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are tools for analyzing BIFF8 files, for example BiffViewer, and for analyzing content there is a great tool - oletools. But we will try to do without using third-party utilities. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Excel also has an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> based format </font><font style="vertical-align: inherit;">- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xlsm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you can save VBA macro code and Excel 4.0 macro sheets in it, which we will do. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full list of formats available for Excel is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excel formats</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We save our document, unzip it: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yg/yu/8b/ygyu8bzhfi2qwajfjmekp3i5_ek.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what is in the files, start with the macrosheets directory in the xl folder and find the file with all the data on the macro sheet: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rt/9l/tw/rt9ltwvg6gyr0wipyuse7cootpe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, we get all the values ‚Äã‚Äãin the cells on the macro sheet. </font><font style="vertical-align: inherit;">The macro itself is obfuscated, the cells contain only numerical values ‚Äã‚Äãand formulas that convert these values ‚Äã‚Äãand write the result into new cells. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, in this formula, numeric values ‚Äã‚Äãare converted to characters, concatenated, and written to cell FK17653.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formula in excel</font></font></b>
                        <div class="spoiler_text">FORMULA.FILL(CHAR(CV63675+HE4018)&amp;CHAR(DG27830+HE26544)&amp;CHAR(IA33205-EW25294)&amp;CHAR(X1216+BA26751)&amp;CHAR(X1216*ER27642)&amp;CHAR(EC50683*IA4491)&amp;CHAR(CV63675*CQ12674)&amp;CHAR(CV63675-IP35389)&amp;CHAR(DL61540+AP31398)&amp;CHAR(GB59870-IB5677)&amp;CHAR(X1216+DS45768)&amp;CHAR(GB59870+FV60781)&amp;CHAR(AA45534*S4000)&amp;CHAR(CV63675*FK10514)&amp;CHAR(EC50683/GD6905)&amp;CHAR(GB59870+EM58732)&amp;CHAR(HQ31358-GI51882)&amp;CHAR(X1216+FX24913)&amp;CHAR(DL61540*EC63501)&amp;CHAR(HQ31358-IC62223)&amp;CHAR(X1216*BY50777)&amp;CHAR(X1216*FY64649)&amp;CHAR(G64471+DW7092)&amp;CHAR(HQ31358-B26139)&amp;CHAR(HQ31358/I494)&amp;CHAR(G64471*DG37241)&amp;CHAR(DL61540-ES39934)&amp;CHAR(X1216+BX48975),FK17653)</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result of the formula, we get the following line: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ve/xn/rqvexng052dssxefthigngmj9nq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each subsequent macro command is ‚Äúcollected‚Äù by a similar formula, written to the cell, and then executed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for the macro to run automatically when the document is opened, the cell from which the script should be launched must be called Auto_Open. </font><font style="vertical-align: inherit;">Consider the workbook.xml file:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workbook.xml</font></font></b>
                        <div class="spoiler_text">&lt;?xml version=¬´1.0¬ª encoding=¬´UTF-8¬ª standalone=¬´yes¬ª?&gt;<br>
&lt;workbook xmlns=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">schemas.openxmlformats.org/spreadsheetml/2006/main</a>¬ª xmlns:r=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">schemas.openxmlformats.org/officeDocument/2006/relationships</a>¬ª xmlns:mc=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>¬ª mc:Ignorable=¬´x15¬ª xmlns:x15=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/main</a>¬ª&gt; appName=¬´xl¬ª lastEdited=¬´6¬ª lowestEdited=¬´6¬ª rupBuild=¬´14420¬ª/&gt;&lt;workbookPr/&gt;&lt;mc:AlternateContent xmlns:mc=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>¬ª&gt; Requires=¬´x15¬ª&gt;&lt;x15ac:absPath url=¬´C:\Users\User\Desktop\malware\¬ª xmlns:x15ac=¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/ac</a>¬ª/&gt;&lt;/mc:Choice&gt;&lt;/mc:AlternateContent&gt;/&gt;&lt;sheet name=¬´Sheet1¬ª sheetId=¬´1¬ª r:id=¬´rId1¬ª/&gt;&lt;sheet name=¬´Sheet2¬ª sheetId=¬´2¬ª r:id=¬´rId2¬ª/&gt;Sheet2!$IE$65406/&gt;/&gt;/&gt;</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inside the file we find the line name = "_ xlnm.Auto_OpenT8nee" hidden = "1"&gt; Sheet2! $ IE $ 65406 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that the cell with which the macro is run, IE65406, is hidden. </font><font style="vertical-align: inherit;">Now we know the entry point to the macro.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamic analysis</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Never run suspicious files on your machine. </font><font style="vertical-align: inherit;">To study the actions of suspicious software, it is necessary to use a specially prepared environment: various sandboxes or a specially prepared isolated machine - virtual or iron. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open the document and run the content. </font><font style="vertical-align: inherit;">The command prompt window flashes and the book closes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see the Sysmon logs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon has a process creation event (id 1), more about Sysmon can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the logs, we see that the macro creates files in the directory c: \ users \ public </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following is the sysmon message, which shows that the registry branch is unloaded and the result is written to the file:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sysmon Event event ID 1</font></font></b>
                        <div class="spoiler_text">sysmon event id 1 <br>
Process Create:<br>
RuleName: technique_id=T1112,technique_name=Modify Registry<br>
ProcessGuid: {2a62482c-b244-5ecf-3a00-000000002700}<br>
ProcessId: 3268<br>
Image: C:\Windows\System32\reg.exe<br>
FileVersion: 6.1.7600.16385 (win7_rtm.090713-1255)<br>
Description: Registry Console Tool<br>
Product: Microsoft Windows Operating System<br>
Company: Microsoft Corporation<br>
OriginalFileName: reg.exe<br>
CommandLine: ¬´C:\Windows\system32\reg.exe¬ª EXPORT HKCU\Software\Microsoft\Office\16.0\Excel\Security C:\Users\Public\IcItdXw.reg /y"<br>
CurrentDirectory: C:\Users\user\Documents\<br>
User: user<br>
LogonGuid: {2a62482c-b1d8-5ecf-3284-010000000000}<br>
LogonId: 0x18432<br>
TerminalSessionId: 1<br>
IntegrityLevel: High<br>
Hashes: SHA1=8BD131B03D6BA865B228CA8EE3239D2EF2B90B74,MD5=D69A9ABBB0D795F21995C2F48C1EB560,SHA256=36414C7E57AFA6136D77FD47F4C55102E35F2475FBCD719728DA7D14B1590E2A,IMPHASH=BC564726CFF18A49EBC14784593A51CA<br>
ParentProcessGuid: {2a62482c-b23f-5ecf-3900-000000002700}<br>
ParentProcessId: 3164<br>
ParentImage: C:\Program Files\Microsoft Office\Office16\EXCEL.EXE<br>
ParentCommandLine: ¬´C:\Program Files\Microsoft Office\Office16\EXCEL.EXE¬ª</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Upon completion, the macro deletes the created files. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To prohibit the deletion of files, change the permissions on the folder, leave read and write permissions and prohibit deletion: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/lf/1a/go/lf1agokzzhrg21juvd4ptxlv1os.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the document again, we will receive an error during the execution of the macro, which will enable us to debug it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is possible because there is no exception handling in some calls. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0t/ul/u-/0tulu-lqdvaiqqwvif3qgy7syjg.png"><br>
 <br>
<img src="https://habrastorage.org/webt/rf/jo/em/rfjoem_yjobjgq4qnakt80zglke.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's run the macro step-by-step; during the debug, we encounter function calls from dll libraries, such as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShellExecute</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLDownloadToFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Upon completion of the macro, the following files will be in the shared users folder:</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dc/aw/bd/dcawbdyabmgyj-qzjxcrvzqhpqi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we know the cell from which execution begins, we can fill in all the cells in the macro sheet. </font><font style="vertical-align: inherit;">Let's go over the macro to the close (false) function, where we will interrupt the execution by clicking the ‚ÄúPause‚Äù button.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Environment check cells</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking through the cells that the macro fills, we come across several functions get.window () and get.workspace ()</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The get.window () function returns information about the current window: status, window status, its name, display options, etc.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The get.workspace () function allows you to find out information about the environment in which the document is running.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A complete list of calls available to Excel 4.0 can be found in the links. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we need to dwell in more detail: my colleague and I suggested that most of these calls are related to attempts to bypass sandboxes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.winow (7) - checks if the current window is hidden. </font><font style="vertical-align: inherit;">Returns true or false.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows (20) - returns true if the window is maximized.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows (23) - can return the value 1, 2 and 3.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/d54/afe/028/d54afe0281d24b5e34040af0122cd3d7.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 - restored </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 - minimized </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 - maximized </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, it checks to see if the current window is open: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (31) - checks to see if the macro is being debugged in steps. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (13) - check the width of the workspace in pixels: if less than 770, the book will close </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dh/zz/w3/dhzzw3m9vx-krc6nxgje-ken6x4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (14) - check the height of the workspace in pixels: if less than 390, the book will close </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4b/m5/8l/4bm58lswcaq-yi9xfjjinjc9ng0.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (19) - check the presence of a mouse. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (1) - returns which operating system the document is running in. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of false, in each check there is a transition to the book closing cell without saving the result.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">External Library Calls</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After checking the environment, we move on to the main functionality. Let's see how WinAPI functions are called from the macro: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. The reg.exe call, which we saw in the Sysmon logs. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gy/vz/lv/gyvzlv4tfc9o4q0pmkplr9ea3eq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To call the utility, the ShellExecute function from the shell32.dll library is used, the parameters for the function are scattered in other cells. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cell BN16631: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ug/af/vn/ugafvnkenyfwp2iv2mqvml0kfl8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cell A46097: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/qa/wy/f7/qawyf7w4clfqocrpp4ixokeyzyc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In cell GN47559, the command to export the necessary registry branch is sent, Get.workspace (2) returns the version of Excel. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/s7/_g/w5/s7_gw5jjgmgw32b9vxugtqxnxkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cell DX48821 contains the path where the result is written. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/wt/i9/-m/wti9-myhidza4-8nm7xd_s3rkmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further in the macro there is a check for the existence of the created IcltdXw.reg file and its deletion. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Calling the URLDownloadToFile function. This function saves the result of a get request to a file. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The call is as follows:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/vn/ye/buvnyevcolwz4oofwcxygw1zbam.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This call leads us to the Microsoft website, to the page with information about Office updates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Function parameters: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cell BR6547 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yc/s9/ws/ycs9wsggtysuw-zxwt_o0dt4r94.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cell IN49847 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/i2/an/lg/i2anlg2ev8fwcc40tb-z9f2mzmi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After executing the instruction, it is checked whether the file was created, and also the reading of the character by the offset in the file: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ei/by/lc/eibylc7t9nfpt1o9fpqqri2myzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most likely, these actions are aimed at checking whether the environment where the document is running has Internet access. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the formula, the FILES function is passed to iserror and the argument is the name of the file where the result of the URLDownloadToFile function should be written: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/rh/x1/_urhx1xm6fnl5wiaca1r1zojjba.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cell FM27223 will give control to the book closing function: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/fj/ka/f2fjkalfq8wvjhotj8xyb8td5-g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Upon successful receipt of the file from Microsoft, the cells are filled to prepare for the second call to the urlmon dll.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Payload loading</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is the second call, but to the dehabadi [.] Ir domain, from which the malicious load should be loaded: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/3f/jx/db/3fjxdb9mshlwdu0y6xgnp0j_ena.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result will be written to a file in the same folder with the html extension: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dh/py/vd/dhpyvdog5thduid5qvxiuclpa6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we come across a branch in the macro code if, on the first attempt to download payload, failed, a second attempt will be made, but from a different address. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the download is successful, a warning pop-up will appear and the loaded library will be called. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/uo/dn/gv/uodngvrubmpjcf-zkckbqj5wm-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full call is as follows:</font></font><br>
<br>
<pre><code class="plaintext hljs">=CALL("shell32","ShellExecuteA","JJCCJJ",0,"open","c:\windows\systemc32\rundll32.exe","c:\users\public\4hcFC.html,DllRegisterServer",0,5) </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a full call, the ShellExecuteA function is called from the Shell32 library with parameters for launching rundll32, with which the exported function of the downloaded malicious library is called. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This completes the macro function, the payload is up and running.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As was said, the technology is quite old ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel 4.0 for Windows 3.0 and 3.1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), but it fully provides the functionality that malware needs to achieve its goals. And the purpose of this file is to quietly put dangerous software in the system that can cause serious damage, starting from the theft of personal data, authorization data for systems, ending with data corruption / encryption on the computer and the ability to remotely execute code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the analysis of such documents it is not at all necessary to use any special utilities and software, however, it is worth mentioning a set of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oletools</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> scripts </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">- more details can be found here</font></a><font style="vertical-align: inherit;"> . We will end here, below are indicators of compromise identified as a result of the analysis. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Received IOC:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
evans [.] williamdmon [@] wp [.] pl </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eleventalents [.] com </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dehabadi [.] ir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps: //eleventalents.com/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps: //dehabadi.ir/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
de88d3774ae006d96121d9b45efbf1ee </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a73d1214740330013773cd733b0daf206eae2e03 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ba4adb640f777ad9b0881919e9bd1e171e64025d97a37fd585295ab611653419 </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A complete list of indicators of compromise. </font></font></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References:</font></font></b><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Macro Reference 4.0 </font></font></a> </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Worked on the analysis: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frolov Ilya </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kolenchuk Alexey</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504402/index.html">May 29th Java Digest</a></li>
<li><a href="../en504408/index.html">Simple and convenient test framework template on selenide for UI autotests</a></li>
<li><a href="../en504412/index.html">Online programming championship "Open Finals of Moscow Training"</a></li>
<li><a href="../en504414/index.html">How Microsoft Killed AppGet</a></li>
<li><a href="../en504420/index.html">Writing a turn-based PvP arena with simultaneous moves</a></li>
<li><a href="../en504434/index.html">Educational program for parents: how to protect children from danger on the Internet</a></li>
<li><a href="../en504438/index.html">30 mitaps per week. We open the summer season 2020</a></li>
<li><a href="../en504442/index.html">A bit about relocations in the Linux kernel</a></li>
<li><a href="../en504444/index.html">Using docker multi-stage to build windows images</a></li>
<li><a href="../en504448/index.html">Gamers Generation II</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>