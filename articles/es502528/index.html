<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚óªÔ∏è üö∂üèº üïäÔ∏è Programaci√≥n de un juego para un dispositivo integrado en ESP32 ‚ûñ ‚ùå üóìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parte 0: motivaci√≥n
 Introducci√≥n
 Estaba buscando un proyecto de pasatiempo en el que pudiera trabajar fuera de mis tareas principales para escapar d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Programaci√≥n de un juego para un dispositivo integrado en ESP32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502528/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 0: motivaci√≥n</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estaba buscando un proyecto de pasatiempo en el que pudiera trabajar fuera de mis tareas principales para escapar de la situaci√≥n en el mundo. </font><font style="vertical-align: inherit;">Estoy principalmente interesado en la programaci√≥n de juegos, pero tambi√©n me gustan los sistemas integrados. </font><font style="vertical-align: inherit;">Ahora trabajo en una empresa de juegos, pero antes me dedicaba principalmente a microcontroladores. </font><font style="vertical-align: inherit;">Aunque al final decid√≠ cambiar mi camino e ingresar a la industria del juego, todav√≠a me gusta experimentar con ellos. </font><font style="vertical-align: inherit;">Entonces, ¬øpor qu√© no combinar ambos pasatiempos?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid go</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ten√≠a a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Odroid Go por ah√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , con lo cual ser√≠a interesante jugar. </font><font style="vertical-align: inherit;">Su n√∫cleo es ESP32, un microcontrolador muy popular con funcionalidad MK est√°ndar (SPI, I2C, GPIO, temporizadores, etc.), pero tambi√©n con WiFi y Bluetooth, lo que lo hace atractivo para crear dispositivos IoT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Go complementa el ESP32 con un mont√≥n de perif√©ricos, convirti√©ndolo en una m√°quina de juegos port√°til que recuerda a Gameboy Color: una pantalla LCD, un altavoz, una cruz de control, dos botones principales y cuatro auxiliares, una bater√≠a y un lector de tarjetas SD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mayor√≠a de las personas compran Odroid Go para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejecutar emuladores de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> viejos sistemas de 8 bits. </font><font style="vertical-align: inherit;">Si esto es capaz de emular juegos antiguos, tambi√©n har√° frente al lanzamiento de un juego nativo dise√±ado espec√≠ficamente para √©l.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/44b/800/42e/44b80042e94aa2f2da9da2d2296461ad.jpg"></div><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limitaciones</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resoluci√≥n 320x240 La</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
pantalla tiene un tama√±o de solo 320x240, por lo que estamos muy limitados en la cantidad de informaci√≥n que se muestra en la pantalla al mismo tiempo. Necesitamos considerar cuidadosamente qu√© juego haremos y qu√© recursos usar. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Color de 16 bits La</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
pantalla admite </font><strong><font style="vertical-align: inherit;">color de</font></strong><font style="vertical-align: inherit;"> 16 bits por p√≠xel: 5 bits para el rojo, 6 bits para el verde y 5 para el azul. Por razones obvias, dicho circuito generalmente se llama RGB565. El verde se puso un poco m√°s rojo y azul, porque el ojo humano distingue mejor entre las gradaciones de verde que el azul o el rojo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El color de 16 bits significa que tenemos acceso a solo 65 mil colores. Compare esto con el color est√°ndar de 24 bits (8 bits por color), que proporciona 16 </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">millones de</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> colores. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de GPU</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin una GPU, no podemos usar una API como OpenGL. Hoy en d√≠a, las mismas GPU se usan generalmente para renderizar juegos 2D como para juegos 3D. Justo en lugar de objetos, se dibujan cuadr√°ngulos, en los que se superponen texturas de bits. Sin una GPU, tenemos que rasterizar cada p√≠xel con una CPU, que es m√°s lenta pero m√°s simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con una resoluci√≥n de pantalla de 320x240 y color de 16 bits, el tama√±o total del b√∫fer de cuadro es 153,600 bytes. Esto significa que al menos treinta veces por segundo necesitaremos transmitir 153,600 bytes a la pantalla. En √∫ltima instancia, esto puede causar problemas, por lo que debemos ser m√°s inteligentes al renderizar la pantalla. Por ejemplo, puede convertir un color indexado en una paleta de modo que para cada p√≠xel necesite almacenar un byte, que se usar√° como √≠ndice de una paleta de 256 colores.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 MB</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ESP32 tiene 520 KB de RAM interna, mientras que Odroid Go agrega otros 4 MB de RAM externa. Pero no toda esta memoria est√° disponible para nosotros, porque parte es utilizada por el SDK de ESP32 (m√°s sobre esto m√°s adelante). Despu√©s de deshabilitar todas las funciones extra√±as posibles e ingresar mi funci√≥n principal, ESP32 informa que podemos usar 4,494,848 bytes. Si en el futuro necesitamos m√°s memoria, luego podremos volver a recortar funciones innecesarias. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procesador de 80-240 MHz</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La CPU est√° configurada a tres velocidades posibles: 80 MHz, 160 MHz y 240 MHz. Incluso un m√°ximo de 240 MHz est√° lejos de la potencia de m√°s de tres gigahercios de computadoras modernas con las que estamos acostumbrados a trabajar. Comenzaremos a 80 MHz y veremos hasta d√≥nde podemos llegar. Si queremos que el juego funcione con bater√≠a, el consumo de energ√≠a deber√≠a ser bajo. Para hacer esto, ser√≠a bueno bajar la frecuencia. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mala depuraci√≥n</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay formas de usar depuradores con dispositivos integrados (JTAG), pero, desafortunadamente, Odroid Go no nos proporciona los contactos necesarios, por lo que no podemos pasar por el c√≥digo en el depurador, como suele ser el caso. </font><font style="vertical-align: inherit;">Esto significa que la depuraci√≥n puede ser un proceso dif√≠cil, y tendremos que usar activamente la depuraci√≥n en pantalla (usando colores y texto), y tambi√©n enviar informaci√≥n a la consola de depuraci√≥n (que, afortunadamente, es f√°cilmente accesible a trav√©s de USB UART).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© todos los problemas?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPor qu√© incluso intentar crear un juego para este dispositivo d√©bil con todas las limitaciones mencionadas anteriormente, y simplemente no escribir nada para una PC de escritorio? Hay dos razones para esto: las </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limitaciones estimulan la creatividad:</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
cuando trabajas con un sistema que tiene un cierto conjunto de equipos, cada uno de los cuales tiene sus propias limitaciones, te hace pensar en c√≥mo usar mejor las ventajas de estas limitaciones. Entonces nos acercamos a los desarrolladores de juegos de sistemas antiguos, por ejemplo, Super Nintendo (pero a√∫n es mucho m√°s f√°cil para nosotros que para ellos). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El desarrollo de bajo nivel es divertido</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para escribir un juego desde cero para un sistema de escritorio normal, tendremos que trabajar con conceptos de motor est√°ndar de bajo nivel: renderizado, f√≠sica, reconocimiento de colisi√≥n. </font><font style="vertical-align: inherit;">Pero al implementar todo esto en un dispositivo integrado, tambi√©n tenemos que lidiar con conceptos inform√°ticos de bajo nivel, por ejemplo, escribir un controlador LCD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© tan bajo ser√° el desarrollo?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se trata de nivel bajo y de crear su propio c√≥digo, debe dibujar un borde en alguna parte. Si estamos tratando de escribir un juego sin bibliotecas para el escritorio, es probable que el borde sea un sistema operativo o una API multiplataforma como SDL. En mi proyecto, trazar√© una l√≠nea para escribir cosas como controladores SPI y cargadores de arranque. Con ellos mucho m√°s tormento que diversi√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, usaremos el ESP-IDF, que es esencialmente un SDK para ESP32. Podemos suponer que nos proporciona algunas utilidades que generalmente proporciona el </font><font style="vertical-align: inherit;">sistema operativo </font><font style="vertical-align: inherit;">, pero el </font><font style="vertical-align: inherit;">sistema operativo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona </font><font style="vertical-align: inherit;">en ESP32 </font><font style="vertical-align: inherit;">. Estrictamente hablando, este MK usa FreeRTOS, que es </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un sistema operativo en tiempo real</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero este no es un sistema operativo real. </font><font style="vertical-align: inherit;">Esto es solo un planificador. </font><font style="vertical-align: inherit;">Lo m√°s probable es que no interactuemos con √©l, pero en su n√∫cleo ESP-IDF lo usa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP-IDF nos proporciona una API para perif√©ricos ESP32 como SPI, I2C y UART, as√≠ como una biblioteca de tiempo de ejecuci√≥n C, por lo que cuando llamamos a algo como printf, en realidad transfiere bytes a trav√©s de UART para que se muestren en el monitor de interfaz serie. </font><font style="vertical-align: inherit;">Tambi√©n procesa todo el c√≥digo de inicio necesario para preparar la m√°quina antes de invocar el punto de inicio de nuestro juego. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta publicaci√≥n mantendr√© una revista de desarrollo en la que hablar√© sobre puntos interesantes que me parecieron y explicar√© los aspectos m√°s dif√≠ciles. </font><font style="vertical-align: inherit;">No tengo un plan y muy probablemente cometer√© muchos errores. </font><font style="vertical-align: inherit;">Todo esto lo creo por inter√©s.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1: sistema de construcci√≥n</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de que podamos comenzar a escribir c√≥digo para Odroid Go, debemos configurar el SDK de ESP32. </font><font style="vertical-align: inherit;">Contiene el c√≥digo que inicia ESP32 y llama a nuestra funci√≥n principal, as√≠ como el c√≥digo perif√©rico (por ejemplo, SPI) que necesitaremos cuando escribamos el controlador LCD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espressif llama a su SDK </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP-IDF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font><font style="vertical-align: inherit;">Utilizamos la √∫ltima versi√≥n estable </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v4.0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos clonar el repositorio de acuerdo con sus instrucciones (con el indicador </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recursivo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) o simplemente descargar el archivo zip desde la p√°gina de lanzamientos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro primer objetivo es una aplicaci√≥n m√≠nima de estilo Hello World instalada en Odroid Go que demuestre la configuraci√≥n correcta del entorno de compilaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C o C ++</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP-IDF usa C99, por lo que tambi√©n lo elegiremos. </font><font style="vertical-align: inherit;">Si lo desea, podr√≠amos usar C ++ (hay un compilador de C ++ en la cadena de herramientas ESP32), pero por ahora, nos quedaremos con C. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En realidad, me gusta C y su simplicidad. </font><font style="vertical-align: inherit;">No importa cu√°nto escriba c√≥digo en C ++, nunca logr√© llegar al momento de disfrutarlo. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta persona resume mis pensamientos bastante bien. </font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, si es necesario, podemos cambiar a C ++ en cualquier momento.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proyecto m√≠nimo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDF usa CMake para administrar el sistema de compilaci√≥n. Tambi√©n es compatible con Makefile, pero est√°n en desuso en v4.0, por lo que solo usaremos CMake. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como m√≠nimo, necesitamos un archivo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con una descripci√≥n de nuestro proyecto, una carpeta </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principal</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con el archivo fuente del punto de entrada al juego y otro archivo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dentro de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que enumera los archivos fuente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CMake necesita hacer referencia a variables de entorno que le indiquen d√≥nde buscar IDF y cadena de herramientas. Me molest√≥ que tuviera que reinstalarlos cada vez que iniciaba una nueva sesi√≥n de terminal, as√≠ que escrib√≠ el script </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">export.sh</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Establece </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_TOOLS_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y tambi√©n es una fuente de exportaci√≥n IDF que establece otras variables de entorno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es suficiente que el usuario del script establezca las </font><strong><font style="vertical-align: inherit;">variables </font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDF_TOOLS_PATH</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="powershell hljs">IDF_PATH=<font></font>
IDF_TOOLS_PATH=<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -<span class="hljs-type">z</span> <span class="hljs-string">"<span class="hljs-variable">$IDF_PATH</span>"</span> ]<font></font>
then<font></font>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"IDF_PATH not set"</span>
	<span class="hljs-keyword">return</span><font></font>
fi<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -<span class="hljs-type">z</span> <span class="hljs-string">"<span class="hljs-variable">$IDF_TOOLS_PATH</span>"</span> ]<font></font>
then<font></font>
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"IDF_TOOLS_PATH not set"</span>
	<span class="hljs-keyword">return</span><font></font>
fi<font></font>
<font></font>
<font></font>
export IDF_PATH<font></font>
export IDF_TOOLS_PATH<font></font>
<font></font>
source <span class="hljs-variable">$IDF_PATH</span>/export.sh</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la ra√≠z:</font></font><br>
<br>
<pre><code class="cmake hljs"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>)<font></font>
<font></font>
<span class="hljs-keyword">set</span>(COMPONENTS <span class="hljs-string">"esptool_py main"</span>)<font></font>
<font></font>
<span class="hljs-keyword">include</span>($ENV{IDF_PATH}/tools/cmake/<span class="hljs-keyword">project</span>.cmake)<font></font>
<font></font>
<span class="hljs-keyword">project</span>(game)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por defecto, el sistema de compilaci√≥n compilar√° todos los componentes posibles dentro de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ ESP_IDF / components</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lo que resultar√° en m√°s tiempo de compilaci√≥n. </font><font style="vertical-align: inherit;">Queremos compilar un conjunto m√≠nimo de componentes para llamar a nuestra funci√≥n principal y conectar componentes adicionales m√°s adelante si es necesario. </font><font style="vertical-align: inherit;">Para eso est√° la variable </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COMPONENTES</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMakeLists.txt</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dentro de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cmake hljs">idf_component_register(<font></font>
	SRCS <span class="hljs-string">"main.c"</span>
    INCLUDE_DIRS <span class="hljs-string">""</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo lo que hace: infinitamente una vez que un segundo muestra en el monitor la interfaz en serie "Hello World". </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VTaskDelay</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa FreeRTOS </font><font style="vertical-align: inherit;">para retrasar </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es </font><font style="vertical-align: inherit;">muy simple:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;freertos/FreeRTOS.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;freertos/task.h&gt;</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello World!\n"</span>);<font></font>
		vTaskDelay(<span class="hljs-number">1000</span> / portTICK_PERIOD_MS);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que nuestra funci√≥n se llama </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app_main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no </font></font></em> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El </font><font style="vertical-align: inherit;">IDF utiliza la </font><font style="vertical-align: inherit;">funci√≥n </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">principal</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para la preparaci√≥n necesaria, y luego crea una </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con nuestra funci√≥n </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">app_main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como punto de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una tarea es solo un bloque ejecutable que FreeRTOS puede administrar. Si bien no deber√≠amos preocuparnos por esto (o tal vez no del todo), es importante tener en cuenta aqu√≠ que nuestro juego se ejecuta en un n√∫cleo (ESP32 tiene dos n√∫cleos), y con cada iteraci√≥n del bucle for, la tarea retrasa la ejecuci√≥n por un segundo. Durante este retraso, el planificador de FreeRTOS puede ejecutar otro c√≥digo que est√© esperando en l√≠nea para su ejecuci√≥n (si corresponde).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos usar ambos n√∫cleos, pero por ahora, limit√©monos a uno.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Componentes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluso si reducimos la lista de componentes al m√≠nimo requerido para la aplicaci√≥n Hello World (que son </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esptool_py</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), debido a la configuraci√≥n de la cadena de dependencia, a√∫n recopila algunos otros componentes que no necesitamos. </font><font style="vertical-align: inherit;">Re√∫ne todos estos componentes:</font></font><br>
<br>
<pre><code class="cmake hljs">app_trace app_update bootloader bootloader_support cxx driver efuse esp32 esp_common esp_eth esp_event esp_ringbuf<font></font>
esp_rom esp_wifi espcoredump esptool_py freertos heap log lwip main mbedtls newlib nvs_flash partition_table pthread<font></font>
soc spi_flash tcpip_adapter vfs wpa_supplicant xtensa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muchos de ellos son bastante l√≥gicos ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bootloader</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freertos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), pero son seguidos por componentes innecesarios porque no usamos funciones de red: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_eth, esp_wifi, lwip, mbedtls, tcpip_adapter, wpa_supplicant</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Desafortunadamente, todav√≠a nos vemos obligados a ensamblar estos componentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afortunadamente, el enlazador es lo suficientemente inteligente y no coloca componentes no utilizados en un archivo binario listo para usar del juego. </font><font style="vertical-align: inherit;">Podemos verificar esto con </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make size-components</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<code><pre>Total sizes:
 DRAM .data size:    8476 bytes
 DRAM .bss  size:    4144 bytes
Used static DRAM:   12620 bytes ( 168116 available, 7.0% used)
Used static IRAM:   56345 bytes (  74727 available, 43.0% used)
      Flash code:   95710 bytes
    Flash rodata:   40732 bytes
Total image size:~ 201263 bytes (.bin may be padded larger)
Per-archive contributions to ELF file:
            Archive File DRAM .data &amp; .bss   IRAM Flash code &amp; rodata   Total
                  libc.a        364      8   5975      63037     3833   73217
              libesp32.a       2110    151  15236      15415    21485   54397
           libfreertos.a       4148    776  14269          0     1972   21165
                libsoc.a        184      4   7909        875     4144   13116
          libspi_flash.a        714    294   5069       1320     1386    8783
                libvfs.a        308     48      0       5860      973    7189
         libesp_common.a         16   2240    521       1199     3060    7036
             libdriver.a         87     32      0       4335     2200    6654
               libheap.a        317      8   3150       1218      748    5441
             libnewlib.a        152    272    869        908       99    2300
        libesp_ringbuf.a          0      0    906          0      163    1069
                liblog.a          8    268    488         98        0     862
         libapp_update.a          0      4    127        159      486     776
 libbootloader_support.a          0      0      0        634        0     634
                libhal.a          0      0    519          0       32     551
            libpthread.a          8     12      0        288        0     308
             libxtensa.a          0      0    220          0        0     220
                libgcc.a          0      0      0          0      160     160
               libmain.a          0      0      0         22       13      35
                libcxx.a          0      0      0         11        0      11
                   (exe)          0      0      0          0        0       0
              libefuse.a          0      0      0          0        0       0
         libmbedcrypto.a          0      0      0          0        0       0
     libwpa_supplicant.a          0      0      0          0        0       0</pre></code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre todo, libc afecta el tama√±o del binario, y eso est√° bien.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n del proyecto</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDF le permite especificar los par√°metros de configuraci√≥n en tiempo de compilaci√≥n que utiliza durante el ensamblaje para habilitar o deshabilitar varias funciones. </font><font style="vertical-align: inherit;">Necesitamos establecer par√°metros que nos permitan aprovechar los aspectos adicionales de Odroid Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, debe ejecutar el script fuente de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">export.sh</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que CMake tenga acceso a las variables de entorno necesarias. </font><font style="vertical-align: inherit;">Adem√°s, como para todos los proyectos de CMake, necesitamos crear una carpeta de ensamblaje y llamar a CMake desde ella.</font></font><br>
<br>
<pre><code class="cmake hljs">source <span class="hljs-keyword">export</span>.sh<font></font>
mkdir build<font></font>
cd build<font></font>
cmake ..</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si ejecuta </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make menuconfig</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se abre una ventana donde puede configurar los ajustes del proyecto.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ampliaci√≥n de memoria flash hasta 16 MB</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Go ampl√≠a la capacidad de la unidad flash est√°ndar a 16 MB. </font><font style="vertical-align: inherit;">Puede habilitar esta funci√≥n yendo a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de flasheo en serie -&gt; Tama√±o de flash -&gt; 16 MB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encienda la RAM SPI externa</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n tenemos acceso a 4 MB adicionales de RAM externa conectada a trav√©s de SPI. </font><font style="vertical-align: inherit;">Puede habilitarlo yendo a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de componentes -&gt; ESP32 espec√≠fico -&gt; Soporte para RAM externa conectada a SPI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y presionando la barra espaciadora para habilitarlo. </font><font style="vertical-align: inherit;">Tambi√©n queremos poder asignar expl√≠citamente memoria desde la RAM SPI; </font><font style="vertical-align: inherit;">esto se puede habilitar yendo a la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configuraci√≥n de RAM SPI -&gt; M√©todo de acceso SPI RAM -&gt; Hacer RAM asignable usando heap_caps_malloc</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bajar la frecuencia</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP32 funciona de manera predeterminada con una frecuencia de 160 MHz, pero baj√©moslo a 80 MHz para ver qu√© tan lejos puede llegar con la frecuencia de reloj m√°s baja. Queremos que el juego funcione con bater√≠a, y reducir la frecuencia ahorrar√° energ√≠a. Puede cambiarlo yendo a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de componente -&gt; ESP32 espec√≠fico -&gt; Frecuencia de CPU -&gt; 80MHz</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si selecciona </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guardar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el archivo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se guardar√° en la ra√≠z de la carpeta del proyecto </font><font style="vertical-align: inherit;">. Podemos escribir este archivo en git, pero tiene muchos par√°metros que no son importantes para nosotros. Hasta ahora, estamos satisfechos con los par√°metros est√°ndar, excepto los que acabamos de cambiar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En su lugar, puede crear el archivo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que contendr√° los valores cambiados anteriormente. </font><font style="vertical-align: inherit;">Todo lo dem√°s se configurar√° por defecto. </font><font style="vertical-align: inherit;">Durante la compilaci√≥n, el IDF leer√° </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , anular√° los valores que establecemos y usar√° el est√°ndar para todos los dem√°s par√°metros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdkconfig.defaults se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ve as√≠:</font></font><br>
<br>
<pre><code class="cpp hljs"># Set flash size to <span class="hljs-number">16</span>MB<font></font>
CONFIG_ESPTOOLPY_FLASHSIZE_16MB=y<font></font>
<font></font>
# Set CPU frequency to <span class="hljs-number">80</span>MHz<font></font>
CONFIG_ESP32_DEFAULT_CPU_FREQ_80=y<font></font>
<font></font>
# Enable SPI RAM <span class="hljs-keyword">and</span> allocate with heap_caps_malloc()<font></font>
CONFIG_ESP32_SPIRAM_SUPPORT=y<font></font>
CONFIG_SPIRAM_USE_CAPS_ALLOC=y</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, la estructura original del juego se ve as√≠:</font></font><br>
<br>
<code><pre>game
‚îú‚îÄ‚îÄ CMakeLists.txt
‚îú‚îÄ‚îÄ export.sh
‚îú‚îÄ‚îÄ main
‚îÇ   ‚îú‚îÄ‚îÄ CMakeLists.txt
‚îÇ   ‚îî‚îÄ‚îÄ main.c
‚îî‚îÄ‚îÄ sdkconfig.defaults</pre></code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Construir y flashear</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El proceso de ensamblaje y firmware en s√≠ es bastante simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Corremos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para compilar (ADD </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-j4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-j8</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para compilaciones paralelas </font><font style="vertical-align: inherit;">), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que Flash</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para escribir la imagen para ODROID Ve, y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monitor de maquillaje</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para ver la salida de los </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> declaraciones </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cmake hljs">make<font></font>
make flash<font></font>
make monitor</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n podemos ejecutarlos en una l√≠nea.</font></font><br>
<br>
<pre><code class="cmake hljs">make flash monitor</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado no es particularmente impresionante, pero se convertir√° en la base para el resto del proyecto.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3c2/329/62f/3c232962f8e782c9220b25b7e3c0df5e.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencias</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentaci√≥n ESP-IDF: sistema de compilaci√≥n</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentaci√≥n de FreeRTOS: vTaskDelay</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2: entrada</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Necesitamos poder leer los botones presionados por el jugador y la cruz en Odroid Go.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Botones</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/106/142/ca2/106142ca2250eb9301215015b6f0bbad.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPIO</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odroid Go tiene seis botones: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seleccionar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicio</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Men√∫</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Volumen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada uno de los botones est√° conectado a un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pin IO de prop√≥sito general (GPIO)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> separado </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Los pines GPIO se pueden usar como entradas (para leer) o como salidas (les escribimos). </font><font style="vertical-align: inherit;">En el caso de los botones, necesitamos una lectura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero debe configurar los contactos como entradas, despu√©s de lo cual podemos leer su estado. </font><font style="vertical-align: inherit;">Los contactos internos tienen uno de dos voltajes (3.3V o 0V), pero cuando los leen usando la funci√≥n IDF, se convierten a valores enteros.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicializaci√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los elementos marcados como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el diagrama </font><font style="vertical-align: inherit;">son los botones f√≠sicos en s√≠. Cuando no se presiona, los contactos ESP32 ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO13</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc.) est√°n conectados a 3.3 V; es decir, 3.3 V significa que el bot√≥n </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° </font><strong><font style="vertical-align: inherit;">presionado</font></strong><font style="vertical-align: inherit;"> . La l√≥gica aqu√≠ es lo contrario de lo que se espera. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO39</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tienen resistencias f√≠sicas en el tablero. Si no se presiona el bot√≥n, la resistencia </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tira de los</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contactos a un alto voltaje. Si se presiona el bot√≥n, la corriente que </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fluye a</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trav√©s de los contactos va a tierra, por lo que el voltaje 0 se leer√° en los contactos. </font><strong><font style="vertical-align: inherit;">IO13</font></strong><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO27</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO33</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no tienen resistencias, porque el contacto en el ESP32 tiene resistencias internas, que configuramos para el modo pull-up. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sabiendo esto, podemos configurar seis botones usando la API GPIO.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_A = GPIO_NUM_32;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_B = GPIO_NUM_33;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_START = GPIO_NUM_39;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_SELECT = GPIO_NUM_27;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_VOLUME = GPIO_NUM_0;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> BUTTON_PIN_MENU = GPIO_NUM_13;<font></font>
<font></font>
<span class="hljs-keyword">gpio_config_t</span> gpioConfig = {};<font></font>
<font></font>
gpioConfig.mode = GPIO_MODE_INPUT;<font></font>
gpioConfig.pull_up_en = GPIO_PULLUP_ENABLE;<font></font>
gpioConfig.pin_bit_mask =<font></font>
	  (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_A)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_B)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_START)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_SELECT)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_VOLUME)<font></font>
	| (<span class="hljs-number">1U</span>LL &lt;&lt; BUTTON_PIN_MENU);<font></font>
<font></font>
ESP_ERROR_CHECK(gpio_config(&amp;gpioConfig));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las constantes especificadas al comienzo del c√≥digo corresponden a cada uno de los contactos del circuito. Utilizamos la estructura </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpio_config_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para configurar cada uno de los seis botones como entrada pull-up. En el caso de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO13</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO27</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO32</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO33,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necesitamos pedirle a IDF que active las resistencias pull-up de estos contactos. Para </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO39</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no necesitamos hacer esto porque tienen resistencias f√≠sicas, pero lo haremos de todos modos para que la configuraci√≥n sea hermosa. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_ERROR_CHECK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una macro auxiliar de IDF que verifica autom√°ticamente el resultado de todas las funciones que devuelven </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_err_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(la mayor√≠a de las IDF) y afirman que el resultado no es igual a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_OK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esta macro es conveniente de usar para una funci√≥n si su error es cr√≠tico y no tiene sentido continuar la ejecuci√≥n. </font><font style="vertical-align: inherit;">En este juego, un juego sin entrada no es un juego, por lo que esta afirmaci√≥n es cierta. </font><font style="vertical-align: inherit;">A menudo usaremos esta macro.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Botones de lectura</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, configuramos todos los contactos y finalmente podemos leer los valores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La funci√≥n </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gpio_get_level</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lee los botones </font><strong><font style="vertical-align: inherit;">num√©ricos</font></strong><font style="vertical-align: inherit;"> , pero necesitamos invertir los valores recibidos, porque los contactos se levantan, es decir, una se√±al alta en realidad significa "no presionado" y una baja significa "presionado". </font><font style="vertical-align: inherit;">La inversi√≥n conserva la l√≥gica habitual: 1 significa "presionado", 0 - "no presionado".</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">int</span> a = !gpio_get_level(BUTTON_PIN_A);
<span class="hljs-keyword">int</span> b = !gpio_get_level(BUTTON_PIN_B);
<span class="hljs-keyword">int</span> select = !gpio_get_level(BUTTON_PIN_SELECT);
<span class="hljs-keyword">int</span> start = !gpio_get_level(BUTTON_PIN_START);
<span class="hljs-keyword">int</span> menu = !gpio_get_level(BUTTON_PIN_MENU);
<span class="hljs-keyword">int</span> volume = !gpio_get_level(BUTTON_PIN_VOLUME);</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cruceta (D-pad)</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e8/d9e/a73/1e8d9ea7303257afd45846771726a275.png"></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectar la cruz es diferente de conectar los botones. </font><font style="vertical-align: inherit;">Los botones arriba y abajo est√°n conectados a un pin de un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convertidor anal√≥gico a digital (ADC)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y los botones izquierdo y derecho est√°n </font><font style="vertical-align: inherit;">conectados </font><font style="vertical-align: inherit;">a otro pin ADC. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diferencia de los contactos digitales GPIO, de los cuales podr√≠amos leer uno de los dos estados (alto o bajo), el ADC convierte un voltaje anal√≥gico continuo (por ejemplo, de 0 V a 3.3 V) en un valor num√©rico discreto (por ejemplo, de 0 a 4095 ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongo que los dise√±adores de Odroid Go lo hicieron para ahorrar en los pines GPIO (solo necesita dos pines anal√≥gicos en lugar de cuatro pines digitales). </font><font style="vertical-align: inherit;">Sea como fuere, esto complica un poco la configuraci√≥n y la lectura de estos contactos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El contacto </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35 est√°</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conectado al eje Y de la </font><strong><font style="vertical-align: inherit;">ara√±a</font></strong><font style="vertical-align: inherit;"> , y el contacto </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° </font><strong><font style="vertical-align: inherit;">conectado</font></strong><font style="vertical-align: inherit;"> al eje X de la </font><strong><font style="vertical-align: inherit;">ara√±a</font></strong><font style="vertical-align: inherit;"> . Vemos que las articulaciones de la cruz son un poco m√°s complicadas que los botones num√©ricos. Cada eje tiene dos interruptores ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW1</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el eje Y, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SW4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el eje X), cada uno de los cuales est√° conectado a un conjunto de resistencias ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si no se presiona "arriba" ni "abajo", el </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pin IO35 se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> baja hacia el suelo a trav√©s de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R3</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y consideramos el valor 0 V. Si no se presiona "izquierda" ni "derecha", comun√≠quese con </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">baja hacia el suelo a trav√©s de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R5</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y contamos el valor a 0 V. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> presiona </font><strong><font style="vertical-align: inherit;">SW1 ("arriba")</font></strong><font style="vertical-align: inherit;"> , entonces con </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contamos 3.3 V. Si </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> presiona </font><strong><font style="vertical-align: inherit;">SW2 ("abajo")</font></strong><font style="vertical-align: inherit;"> , entonces con </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO35</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contamos aproximadamente 1, 65 V, porque la mitad del voltaje caer√° en la resistencia </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> presiona </font><strong><font style="vertical-align: inherit;">SW3 (‚Äúizquierda‚Äù)</font></strong><font style="vertical-align: inherit;"> , entonces con </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contamos 3.3 V. Si </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> presiona </font><strong><font style="vertical-align: inherit;">SW4 (‚Äúderecha‚Äù)</font></strong><font style="vertical-align: inherit;"> , entonces con </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO34</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tambi√©n contamos aproximadamente 1.65 V, porque la mitad del voltaje caer√° en la resistencia </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R4</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ambos casos son ejemplos de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">divisores</font></a><font style="vertical-align: inherit;"> de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voltaje.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cuando dos resistencias en el divisor de voltaje tienen la misma resistencia (en nuestro caso, 100K), la ca√≠da de voltaje ser√° la mitad del voltaje de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sabiendo esto, podemos configurar el travesa√±o:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">adc1_channel_t</span> DPAD_PIN_X_AXIS = ADC1_GPIO34_CHANNEL;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">adc1_channel_t</span> DPAD_PIN_Y_AXIS = ADC1_GPIO35_CHANNEL;<font></font>
<font></font>
ESP_ERROR_CHECK(adc1_config_width(ADC_WIDTH_BIT_12));<font></font>
ESP_ERROR_CHECK(adc1_config_channel_atten(DPAD_PIN_X_AXIS,ADC_ATTEN_DB_11));<font></font>
ESP_ERROR_CHECK(adc1_config_channel_atten(DPAD_PIN_Y_AXIS,ADC_ATTEN_DB_11));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajustamos el ADC a 12 bits de ancho para que 0 V se lea como 0 y 3,3 V como 4095 (2 ^ 12). </font><font style="vertical-align: inherit;">La atenuaci√≥n informa que no necesitamos atenuar la se√±al para obtener el rango de voltaje completo de 0 V a 3.3 V. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A 12 bits, podemos esperar que si no se presiona nada, se leer√° 0, cuando se presiona hacia arriba y hacia la izquierda - 4096, y se leer√° aproximadamente 2048 cuando se presione hacia abajo y hacia la derecha (porque las resistencias reducen el voltaje a la mitad).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lectura cruzada</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leer la cruz es m√°s dif√≠cil que los botones, porque necesitamos leer los valores sin procesar (de 0 a 4095) e interpretarlos.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> ADC_POSITIVE_LEVEL = <span class="hljs-number">3072</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint32_t</span> ADC_NEGATIVE_LEVEL = <span class="hljs-number">1024</span>;<font></font>
<font></font>
<span class="hljs-keyword">uint32_t</span> dpadX = adc1_get_raw(DPAD_PIN_X_AXIS);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (dpadX &gt; ADC_POSITIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Left pressed</span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dpadX &gt; ADC_NEGATIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Right pressed</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">uint32_t</span> dpadY = adc1_get_raw(DPAD_PIN_Y_AXIS);<font></font>
<font></font>
<span class="hljs-keyword">if</span> (dpadY &gt; ADC_POSITIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Up pressed</span><font></font>
}<font></font>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dpadY &gt; ADC_NEGATIVE_LEVEL)<font></font>
{<font></font>
	<span class="hljs-comment">// Down pressed</span>
}</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC_POSITIVE_LEVEL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADC_NEGATIVE_LEVEL</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son valores con un margen, asegurando que siempre leamos los valores correctos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encuesta</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay dos opciones para obtener los valores de los botones: sondeo o interrupciones. Podemos crear funciones de procesamiento de entrada y pedirle a IDF que llame a estas funciones cuando se presionan los botones, o sondear manualmente el estado de los botones cuando lo necesitemos. El comportamiento impulsado por interrupciones hace las cosas m√°s complicadas y dif√≠ciles de entender. Adem√°s, siempre me esfuerzo por hacer que todo sea lo m√°s simple posible. Si es necesario, podemos agregar interrupciones m√°s tarde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crearemos una estructura que almacenar√° el estado de seis botones y cuatro direcciones de la cruz. Podemos crear una estructura con 10 booleanos, o 10 int, o 10 sin signo int. Sin embargo, en su lugar, crearemos la estructura utilizando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">campos de bits</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>
{</span>
	<span class="hljs-keyword">uint16_t</span> a : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> b : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> volume : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> menu : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> select : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> start : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> left : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> right : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> up : <span class="hljs-number">1</span>;
	<span class="hljs-keyword">uint16_t</span> down : <span class="hljs-number">1</span>;<font></font>
} Odroid_Input;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se programa para sistemas de escritorio, los campos de bits generalmente se evitan porque est√°n mal portados a diferentes m√°quinas, pero programamos para una m√°quina espec√≠fica y no tenemos que preocuparnos por eso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En lugar de campos, se podr√≠a utilizar una estructura con 10 valores booleanos con un tama√±o total de 10 bytes. </font><font style="vertical-align: inherit;">Otra opci√≥n es una </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uint16_t con</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cambio de bit y macros de enmascaramiento de bits que pueden establecer, </font><strong><font style="vertical-align: inherit;">borrar</font></strong><font style="vertical-align: inherit;"> y verificar bits individuales. </font><font style="vertical-align: inherit;">Funcionar√°, pero no ser√° muy hermoso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un campo de bits simple nos permite aprovechar ambos enfoques: dos bytes de datos y campos con nombre.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manifestaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora podemos sondear el estado de las entradas dentro del bucle principal y mostrar el resultado.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
	Odroid_InitializeInput();<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		Odroid_Input input = Odroid_PollInput();<font></font>
<font></font>
		<span class="hljs-built_in">printf</span>(
			<span class="hljs-string">"\ra: %d  b: %d  start: %d  select: %d  vol: %d  menu: %d  up: %d  down: %d  left: %d  right: %d"</span>,<font></font>
			input.a, input.b, input.start, input.select, input.volume, input.menu,<font></font>
			input.up, input.down, input.left, input.right);<font></font>
<font></font>
		fflush(<span class="hljs-built_in">stdout</span>);<font></font>
<font></font>
		vTaskDelay(<span class="hljs-number">250</span> / portTICK_PERIOD_MS);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La funci√≥n </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">printf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ r</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para sobrescribir la l√≠nea anterior en lugar de agregar una nueva. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necesita </font><strong><font style="vertical-align: inherit;">fflush</font></strong><font style="vertical-align: inherit;"> para mostrar una l√≠nea, porque en el estado normal se restablece con el car√°cter de nueva l√≠nea </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ n</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Su navegador no admite video HTML5.</font></font><source src="https://austinmorlan.com/posts/embedded_game_programming_2/media/input.mp4" type="video/mp4"></video></div></div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencias</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema de odroid go</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentaci√≥n ESP-IDF: ADC</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentaci√≥n ESP-IDF: GPIO</font></font></a></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 3: pantalla</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Necesitamos poder renderizar p√≠xeles en la pantalla LCD de Odroid Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mostrar colores en la pantalla ser√° m√°s dif√≠cil que leer el estado de entrada porque la pantalla LCD tiene cerebro. </font><font style="vertical-align: inherit;">La pantalla est√° controlada por </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ILI9341</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un controlador TFT LCD muy popular en un solo chip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En otras palabras, estamos hablando con ILI9341, que responde a nuestros comandos controlando los p√≠xeles en la pantalla LCD. </font><font style="vertical-align: inherit;">Cuando digo "pantalla" o "pantalla" en esta parte, en realidad me refiero a ILI9341. </font><font style="vertical-align: inherit;">Estamos lidiando con ILI9341. </font><font style="vertical-align: inherit;">Controla la pantalla LCD.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La pantalla LCD est√° conectada al ESP32 a trav√©s de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI (interfaz perif√©rica en serie)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SPI es un protocolo est√°ndar utilizado para intercambiar datos entre dispositivos en una placa de circuito impreso. Tiene cuatro se√±ales: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOSI (Master Out Slave In)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISO (Master In Slave Out)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCK (Clock)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS (Chip Select)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un solo dispositivo maestro en el bus coordina la transferencia de datos controlando SCK y CS. Puede haber varios dispositivos en un bus, cada uno de los cuales tendr√° sus propias se√±ales CS. Cuando se activa la se√±al CS de este dispositivo, puede transmitir y recibir datos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El ESP32 ser√° el maestro SPI (maestro), y la pantalla LCD ser√° el esclavo SPI esclavo. </font><font style="vertical-align: inherit;">Necesitamos configurar el bus SPI con los par√°metros requeridos y agregar una pantalla LCD al bus configurando los contactos correspondientes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bc/60e/18c/7bc60e18c1b066ba7c22756464f92512.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f12/463/615/f124636158029efeab3259f299a2af36.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los nombres </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VSPI.XXXX</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son solo etiquetas para los contactos en el diagrama, pero podemos revisar los contactos mirando las partes de los diagramas LCD y ESP32.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MOSI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.MOSI -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO23</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISO</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.MISO -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO19</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCK</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.SCK -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO18</font></font></strong></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS0</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -&gt; VSPI.CS0 -&gt; </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO5</font></font></strong></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n tenemos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO14</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que es el pin GPIO que se usa para encender la luz de fondo, y tambi√©n </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IO21</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que est√° conectado al pin </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la </font><font style="vertical-align: inherit;">pantalla LCD. Este contacto controla el tipo de informaci√≥n que transmitimos a la pantalla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, configure el bus SPI.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_MISO = GPIO_NUM_19;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_MOSI = GPIO_NUM_23;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_SCLK = GPIO_NUM_18;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_CS = GPIO_NUM_5;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_DC = GPIO_NUM_21;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">gpio_num_t</span> LCD_PIN_BACKLIGHT = GPIO_NUM_14;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_WIDTH = <span class="hljs-number">320</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_HEIGHT = <span class="hljs-number">240</span>;
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> LCD_DEPTH = <span class="hljs-number">2</span>;<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">spi_bus_config_t</span> spiBusConfig = {};<font></font>
spiBusConfig.miso_io_num = LCD_PIN_MISO;<font></font>
spiBusConfig.mosi_io_num = LCD_PIN_MOSI;<font></font>
spiBusConfig.sclk_io_num = LCD_PIN_SCLK;<font></font>
spiBusConfig.quadwp_io_num = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Unused</span>
spiBusConfig.quadhd_io_num = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Unused</span><font></font>
spiBusConfig.max_transfer_sz = LCD_WIDTH * LCD_HEIGHT * LCD_DEPTH;<font></font>
<font></font>
ESP_ERROR_CHECK(spi_bus_initialize(VSPI_HOST, &amp;spiBusConfig, <span class="hljs-number">1</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuramos el bus usando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_bus_config_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es necesario comunicar los contactos que usamos y el tama√±o m√°ximo de una transferencia de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ahora, realizaremos una transmisi√≥n SPI para todos los datos del b√∫fer de cuadros, que es igual al ancho de la pantalla LCD (en p√≠xeles) multiplicado por su altura (en p√≠xeles) multiplicado por el n√∫mero de bytes por p√≠xel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El ancho es 320, la altura es 240 y la profundidad de color es de 2 bytes (la pantalla espera que los colores de los p√≠xeles tengan 16 bits de profundidad).</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">spi_handle_t</span> gSpiHandle;<font></font>
<font></font>
<span class="hljs-keyword">spi_device_interface_config_t</span> spiDeviceConfig = {};<font></font>
spiDeviceConfig.clock_speed_hz = SPI_MASTER_FREQ_40M;<font></font>
spiDeviceConfig.spics_io_num = LCD_PIN_CS;<font></font>
spiDeviceConfig.queue_size = <span class="hljs-number">1</span>;<font></font>
spiDeviceConfig.flags = SPI_DEVICE_NO_DUMMY;<font></font>
<font></font>
ESP_ERROR_CHECK(spi_bus_add_device(VSPI_HOST, &amp;spiDeviceConfig, &amp;gSpiHandle));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de inicializar el bus, necesitamos agregar un dispositivo LCD al bus para que podamos comenzar a hablar con √©l.</font></font><br>
<br>
<ul>
<li><strong>clock_speed_hz</strong> ‚Äî   - ,      SPI   40 ,     .        80 ,         .</li>
<li><strong>spics_io_num</strong> ‚Äî    CS,  IDF     CS,        ( SD-     SPI).</li>
<li><strong>queue_size</strong> ‚Äî     1,           (  ).</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicadores</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : el controlador IDF SPI generalmente inserta bits vac√≠os en la transmisi√≥n para evitar problemas de tiempo durante la lectura desde el dispositivo SPI, pero realizamos una transmisi√≥n unidireccional (no leeremos desde la pantalla). </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_DEVICE_NO_DUMMY</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> informa que confirmamos esta transmisi√≥n unidireccional y que no necesitamos insertar bits vac√≠os.</font></font></li>
</ul><br>
<br>
<pre><code class="cpp hljs">gpio_set_direction(LCD_PIN_DC, GPIO_MODE_OUTPUT);<font></font>
gpio_set_direction(LCD_PIN_BACKLIGHT, GPIO_MODE_OUTPUT);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n necesitamos configurar los </font><font style="vertical-align: inherit;">pines de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y luz de fondo como pines GPIO. </font><font style="vertical-align: inherit;">Despu√©s de cambiar </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC, la</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> luz de fondo estar√° encendida constantemente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equipos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La comunicaci√≥n con la pantalla LCD es en forma de comandos. </font><font style="vertical-align: inherit;">Primero, pasamos un byte que denota el comando que queremos enviar, y luego pasamos los par√°metros del comando (si los hay). </font><font style="vertical-align: inherit;">La pantalla comprende que el byte es un comando si la </font><font style="vertical-align: inherit;">se√±al de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es baja. </font><font style="vertical-align: inherit;">Si la </font><font style="vertical-align: inherit;">se√±al de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es alta, los datos recibidos se considerar√°n los par√°metros del comando transmitido previamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, la transmisi√≥n se ve as√≠:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le damos una </font><font style="vertical-align: inherit;">se√±al baja </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviamos un byte del comando</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Damos una </font><font style="vertical-align: inherit;">se√±al alta </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviar cero o m√°s bytes, seg√∫n los requisitos del comando</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repita los pasos 1-4.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ nuestro mejor amigo es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la especificaci√≥n ILI9341</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Enumera todos los comandos posibles, sus par√°metros y c√≥mo usarlos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68d/8d8/09c/68d8d809ceb9446142cd5c77bb78d0e2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ejemplo de un comando sin par√°metros es </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Display ON</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El byte de comando es </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x29</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero no se especifican par√°metros para √©l.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/35a/4e0/446/35a4e04466c22aa6746fe441f345c02f.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ejemplo de un comando con par√°metros es el </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conjunto de direcciones de columna</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El byte de comando es </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero se especifican cuatro par√°metros necesarios para ello. </font><font style="vertical-align: inherit;">Para usar el comando, debe enviar una </font><font style="vertical-align: inherit;">se√±al baja </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , enviar </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , enviar una </font><font style="vertical-align: inherit;">se√±al alta </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y luego transferir los bytes de cuatro par√°metros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los c√≥digos de comando se especifican en la enumeraci√≥n.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span><font></font>
{<font></font>
	SOFTWARE_RESET = <span class="hljs-number">0x01</span>u,<font></font>
	SLEEP_OUT = <span class="hljs-number">0x11</span>u,<font></font>
	DISPLAY_ON = <span class="hljs-number">0x29</span>u,<font></font>
	COLUMN_ADDRESS_SET = <span class="hljs-number">0x2A</span>u,<font></font>
	PAGE_ADDRESS_SET = <span class="hljs-number">0x2B</span>u,<font></font>
	MEMORY_WRITE = <span class="hljs-number">0x2C</span>u,<font></font>
	MEMORY_ACCESS_CONTROL = <span class="hljs-number">0x36</span>u,<font></font>
	PIXEL_FORMAT_SET = <span class="hljs-number">0x3A</span>u,<font></font>
} CommandCode;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En su lugar, podr√≠amos usar una macro ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define SOFTWARE_RESET (0x01u)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), pero no tienen s√≠mbolos en el depurador y no tienen alcance. </font><font style="vertical-align: inherit;">Tambi√©n ser√≠a posible usar constantes est√°ticas enteras, como hicimos con los contactos GPIO, pero gracias a enum, podemos comprender de un vistazo qu√© datos se pasan a una funci√≥n o miembro de la estructura: son del tipo </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CommandCode</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">De lo contrario, podr√≠a ser </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uint8_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sin </font><strong><font style="vertical-align: inherit;">formato</font></strong><font style="vertical-align: inherit;"> que no </font><strong><font style="vertical-align: inherit;">le dice</font></strong><font style="vertical-align: inherit;"> nada al programador que lee el c√≥digo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lanzamiento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante la inicializaci√≥n, podemos pasar diferentes comandos para poder dibujar algo. </font><font style="vertical-align: inherit;">Cada comando tiene un byte de comando, que llamaremos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de comando</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definiremos una estructura para almacenar el comando de lanzamiento para que pueda especificar su matriz.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>
{</span><font></font>
	CommandCode code;<font></font>
	<span class="hljs-keyword">uint8_t</span> parameters[<span class="hljs-number">15</span>];
	<span class="hljs-keyword">uint8_t</span> length;<font></font>
} StartupCommand;</code></pre><br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el c√≥digo de comando.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par√°metros</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una matriz de par√°metros de comando (si los hay). </font><font style="vertical-align: inherit;">Esta es una matriz est√°tica de tama√±o 15, porque este es el n√∫mero m√°ximo de par√°metros que necesitamos. </font><font style="vertical-align: inherit;">Debido a la naturaleza est√°tica de la matriz, no tenemos que preocuparnos de asignar una matriz din√°mica para cada comando cada vez.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">longitud</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el n√∫mero de par√°metros en la matriz de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par√°metros</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando esta estructura, podemos especificar una lista de comandos de lanzamiento.</font></font><br>
<br>
<pre><code class="cpp hljs">StartupCommand gStartupCommands[] =<font></font>
{<font></font>
	<span class="hljs-comment">// Reset to defaults</span><font></font>
	{<font></font>
		SOFTWARE_RESET,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Landscape Mode</span>
	<span class="hljs-comment">// Top-Left Origin</span>
	<span class="hljs-comment">// BGR Panel</span><font></font>
	{<font></font>
		MEMORY_ACCESS_CONTROL,<font></font>
		{<span class="hljs-number">0x20</span> | <span class="hljs-number">0xC0</span> | <span class="hljs-number">0x08</span>},
		<span class="hljs-number">1</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// 16 bits per pixel</span><font></font>
	{<font></font>
		PIXEL_FORMAT_SET,<font></font>
		{<span class="hljs-number">0x55</span>},
		<span class="hljs-number">1</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Exit sleep mode</span><font></font>
	{<font></font>
		SLEEP_OUT,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
<font></font>
	<span class="hljs-comment">// Turn on the display</span><font></font>
	{<font></font>
		DISPLAY_ON,<font></font>
		{},<font></font>
		<span class="hljs-number">0</span><font></font>
	},<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los comandos sin par√°metros, por ejemplo, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SOFTWARE_RESET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , establecen la lista de inicializadores en </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par√°metros</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como vac√≠os (es decir, con un cero) y la longitud establecida en 0. Los comandos con par√°metros completan los par√°metros y especifican la longitud. </font><font style="vertical-align: inherit;">Ser√≠a genial si pudi√©ramos establecer la longitud autom√°ticamente y no escribir n√∫meros (en caso de que cometamos un error o los par√°metros cambien), pero no creo que valga la pena. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El prop√≥sito de la mayor√≠a de los equipos se desprende del nombre, con la excepci√≥n de dos. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORIA_ACCESO_CONTROL</font></font></strong><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> horizontal </font><strong><font style="vertical-align: inherit;">:</font></strong><font style="vertical-align: inherit;"> de manera predeterminada, la pantalla usa orientaci√≥n vertical (240x320), pero queremos usar horizontal (320x240).</font></font></li>
<li><strong>Top-Left Origin:</strong>      (0,0)     ,    ( )         .</li>
<li><strong>BGR Panel:</strong>  ,        BGR.   ,    , ,   ,     .</li>
</ul><br>
<strong>PIXEL_FORMAT_SET</strong><br>
<br>
<ul>
<li><strong>16 bits per pixel:</strong>   16- .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchos otros comandos que se pueden enviar al inicio para controlar varios aspectos, como gamma. Los par√°metros necesarios se describen en la especificaci√≥n de la pantalla LCD (y no del controlador ILI9341), a la que no tenemos acceso. Si no transmitimos estos comandos, se utiliza la configuraci√≥n de pantalla predeterminada, que nos conviene perfectamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habiendo preparado una serie de comandos de inicio, podemos comenzar a transferirlos a la pantalla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, necesitamos una funci√≥n que env√≠e un byte de comando a la pantalla. No olvide que enviar comandos es diferente de enviar par√°metros, porque necesitamos enviar una </font><font style="vertical-align: inherit;">se√±al baja </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BYTES_TO_BITS(value) ( (value) * 8 )</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCommandCode</span><span class="hljs-params">(CommandCode code)</span>
</span>{
	<span class="hljs-keyword">spi_transaction_t</span> transaction = {};<font></font>
<font></font>
	transaction.length = BYTES_TO_BITS(<span class="hljs-number">1</span>);<font></font>
	transaction.tx_data[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">uint8_t</span>)code;<font></font>
	transaction.flags = SPI_TRANS_USE_TXDATA;<font></font>
<font></font>
	gpio_set_level(LCD_PIN_DC, <span class="hljs-number">0</span>);<font></font>
	spi_device_transmit(gSpiHandle, &amp;transaction);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El IDF tiene una estructura </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spi_transaction_t</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que completamos cuando queremos transferir algo a trav√©s del bus SPI. Sabemos cu√°ntos bits tiene la carga √∫til y transferimos la carga en s√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos pasar un puntero a la carga √∫til o usar la estructura interna struct </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que tiene un tama√±o de solo cuatro bytes, pero evita que el controlador tenga que acceder a la memoria externa. Si usamos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , debemos establecer el indicador </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_TRANS_USE_TXDATA</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de transmitir datos, enviamos una </font><font style="vertical-align: inherit;">se√±al baja </font><font style="vertical-align: inherit;">al </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , indicando que este es un c√≥digo de comando.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">SendCommandParameters</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span>* data, <span class="hljs-keyword">int</span> length)</span>
</span>{
	<span class="hljs-keyword">spi_transaction_t</span> transaction = {};<font></font>
<font></font>
	transaction.length = BYTES_TO_BITS(length);<font></font>
	transaction.tx_buffer = data;<font></font>
	transaction.flags = <span class="hljs-number">0</span>;<font></font>
<font></font>
	gpio_set_level(LCD_PIN_DC, <span class="hljs-number">1</span>);<font></font>
	spi_device_transmit(SPIHANDLE, &amp;transaction);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasar par√°metros es similar a enviar un comando, solo que esta vez usamos nuestro propio b√∫fer ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) y enviamos una </font><font style="vertical-align: inherit;">se√±al alta </font><font style="vertical-align: inherit;">a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DC</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para decirle a la pantalla que los par√°metros se est√°n transmitiendo. </font><font style="vertical-align: inherit;">Adem√°s, no establecemos el indicador </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPI_TRANS_USE_TXDATA</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> porque estamos pasando nuestro propio b√∫fer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego puede enviar todos los comandos de inicio.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ARRAY_COUNT(value) ( sizeof(value) / sizeof(value[0]) )</span><font></font>
<font></font>
<span class="hljs-keyword">int</span> commandCount = ARRAY_COUNT(gStartupCommands);<font></font>
<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> commandIndex = <span class="hljs-number">0</span>; commandIndex &lt; commandCount; ++commandIndex)<font></font>
{<font></font>
	StartupCommand* command = &amp;gStartupCommands[commandIndex];<font></font>
<font></font>
	SendCommandCode(command-&gt;code);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (command-&gt;length &gt; <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		SendCommandData(command-&gt;parameters, command-&gt;length);<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recorrimos iterativamente la matriz de comandos de lanzamiento, pasando primero el c√≥digo del comando y luego los par√°metros (si los hay).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dibujo de marco</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de inicializar la pantalla, puede comenzar a dibujar en ella.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> UPPER_BYTE_16(value) ( (value) &gt;&gt; 8u )</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOWER_BYTE_16(value) ( (value) &amp; 0xFFu )</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Odroid_DrawFrame</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span>* buffer)</span>
</span>{
	<span class="hljs-comment">// Set drawing window width to (0, LCD_WIDTH)</span>
    <span class="hljs-keyword">uint8_t</span> drawWidth[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, UPPER_BYTE_16(LCD_WIDTH), LOWER_BYTE_16(LCD_WIDTH) };<font></font>
	SendCommandCode(COLUMN_ADDRESS_SET);<font></font>
	SendCommandParameters(drawWidth, ARRAY_COUNT(drawWidth));<font></font>
<font></font>
	<span class="hljs-comment">// Set drawing window height to (0, LCD_HEIGHT)</span>
    <span class="hljs-keyword">uint8_t</span> drawHeight[] = { <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, UPPER_BYTE_16(LCD_HEIGHT), LOWER_BYTE_16(LCD_HEIGHT) };<font></font>
	SendCommandCode(PAGE_ADDRESS_SET);<font></font>
	SendCommandParameters(drawHeight, ARRAY_COUNT(drawHeight));<font></font>
<font></font>
	<span class="hljs-comment">// Send the buffer to the display</span><font></font>
	SendCommandCode(MEMORY_WRITE);<font></font>
	SendCommandParameters(buffer, LCD_WIDTH * LCD_HEIGHT * LCD_DEPTH);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ILI9341 tiene la capacidad de volver a dibujar partes individuales de la pantalla. Esto puede ser √∫til en el futuro si notamos una ca√≠da en la velocidad de fotogramas. En este caso, ser√° posible actualizar solo las partes cambiadas de la pantalla, pero por ahora simplemente volveremos a dibujar la pantalla completa nuevamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para renderizar un marco, se requiere configurar una ventana de renderizado. Para hacer esto, env√≠e el comando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLUMN_ADDRESS_SET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con el ancho de la ventana y el comando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PAGE_ADDRESS_SET</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con la altura de la ventana. Cada uno de los comandos toma cuatro bytes del par√°metro que describe la ventana en la que realizaremos el renderizado. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPPER_BYTE_16</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOWER_BYTE_16</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Estas son macros auxiliares para extraer los bytes altos y bajos de un valor de 16 bits. </font><font style="vertical-align: inherit;">Los par√°metros de estos comandos requieren que dividamos el valor de 16 bits en dos valores de 8 bits, por lo que hacemos esto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El procesamiento se inicia mediante el comando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MEMORY_WRITE</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y se env√≠an a la pantalla los </font><strong><font style="vertical-align: inherit;">153,600</font></strong><font style="vertical-align: inherit;"> bytes del b√∫fer de trama a la vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay otras formas de transferir el b√∫fer de cuadros a la pantalla:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podemos crear otra tarea (tarea) de FreeRTOS, que es responsable de coordinar las transacciones SPI.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede transferir un marco no en uno, sino en varias transacciones.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede utilizar la transmisi√≥n sin bloqueo, en la que iniciamos el env√≠o y luego continuamos realizando otras operaciones.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede usar cualquier combinaci√≥n de los m√©todos anteriores.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ahora, utilizaremos la forma m√°s simple: la √∫nica transacci√≥n de bloqueo. </font><font style="vertical-align: inherit;">Cuando </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> llama a </font><strong><font style="vertical-align: inherit;">DrawFrame, se inicia</font></strong><font style="vertical-align: inherit;"> la </font><font style="vertical-align: inherit;">transferencia a la pantalla y nuestra tarea se detiene hasta que se completa la transferencia. </font><font style="vertical-align: inherit;">Si luego descubrimos que no podemos lograr una buena velocidad de cuadros con este m√©todo, volveremos a este problema.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565 y orden de bytes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una pantalla t√≠pica (por ejemplo, el monitor de su computadora) tiene una profundidad de 24 bits (1,6 millones de colores): 8 bits por rojo, verde y azul. El p√≠xel se escribe en la memoria como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RRRRRRRRGGGGGGGGGBBBBBBBBB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El Odroid LCD tiene una profundidad de 16 bits (65 mil colores): 5 bits de rojo, 6 bits de verde y 5 bits de azul. El p√≠xel se escribe en la memoria como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RRRRRGGGGGGGBBBBB</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este formato se llama </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SWAP_ENDIAN_16(value) ( (((value) &amp; 0xFFu) <span class="hljs-meta-string">&lt;&lt; 8u) | ((value) &gt;&gt; 8u)  )</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RGB565(red, green, blue) ( SWAP_ENDIAN_16( ((red) &lt;&lt; 11u) | ((green) &lt;&lt; 5u) | (blue) ) )</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Defina una macro que cree un color en el formato RGB565. Le pasaremos un byte de rojo, un byte de verde y un byte de azul. Tomar√° los cinco bits m√°s significativos de rojo, los seis bits m√°s significativos de verde y los cinco bits m√°s significativos de azul. Elegimos bits altos porque contienen m√°s informaci√≥n que los bits bajos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, el ESP32 almacena los datos en orden </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Little Endian</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir, el byte menos significativo se almacena en la direcci√≥n de memoria inferior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, el valor de 32 bits </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[0xDE 0xAD 0xBE 0xEF]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se almacenar√° en la memoria como </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[0xEF 0xBE 0xAD 0xDE]</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Al transferir datos a la pantalla, esto se convierte en un problema porque el byte menos significativo se enviar√° primero y la pantalla LCD espera recibir primero el byte m√°s significativo. </font><strong><font style="vertical-align: inherit;">Establecer</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
macro </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SWAP_ENDIAN_16</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para intercambiar bytes y usarlo en la macro </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RGB565</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se describe cada uno de los tres colores primarios en RGB565 y c√≥mo se almacenan en la memoria ESP32 si no cambia el orden de los bytes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rojo</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
11111 | 000000 | 00000? -&gt; 11111000 00000000 -&gt; 00000000 11111000 </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verde</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
00000 | 111111 | 00000? -&gt; 00000111 11100000 -&gt; 11100000 00000111 </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Azul</font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
00000 | 000000 | 11111? -&gt; 00000000 00011111 -&gt; 00011111 00000000</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manifestaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos crear una demostraci√≥n simple para ver la pantalla LCD en acci√≥n. </font><font style="vertical-align: inherit;">Al comienzo del marco, vac√≠a el b√∫fer del marco a negro y dibuja un cuadrado de 50x50. </font><font style="vertical-align: inherit;">Podemos mover el cuadrado con una cruz y cambiar su color con los botones </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicio</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">app_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
	Odroid_InitializeInput();<font></font>
	Odroid_InitializeDisplay();<font></font>
<font></font>
	ESP_LOGI(LOG_TAG, <span class="hljs-string">"Odroid initialization complete - entering main loop"</span>);<font></font>
<font></font>
	<span class="hljs-keyword">uint16_t</span>* framebuffer = (<span class="hljs-keyword">uint16_t</span>*)heap_caps_malloc(<span class="hljs-number">320</span> * <span class="hljs-number">240</span> * <span class="hljs-number">2</span>, MALLOC_CAP_DMA);<font></font>
	assert(framebuffer);<font></font>
<font></font>
	<span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">int</span> y = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">uint16_t</span> color = <span class="hljs-number">0xffff</span>;<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		<span class="hljs-built_in">memset</span>(framebuffer, <span class="hljs-number">0</span>, <span class="hljs-number">320</span> * <span class="hljs-number">240</span> * <span class="hljs-number">2</span>);<font></font>
<font></font>
		Odroid_Input input = Odroid_PollInput();<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.left) { x -= <span class="hljs-number">10</span>; }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.right) { x += <span class="hljs-number">10</span>; }<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.up) { y -= <span class="hljs-number">10</span>; }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.down) { y += <span class="hljs-number">10</span>; }<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (input.a) { color = RGB565(<span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.b) { color = RGB565(<span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>); }
		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (input.start) { color = RGB565(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>); }<font></font>
<font></font>
		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> row = y; row &lt; y + <span class="hljs-number">50</span>; ++row)<font></font>
		{<font></font>
			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> col = x; col &lt; x + <span class="hljs-number">50</span>; ++col)<font></font>
			{<font></font>
				framebuffer[<span class="hljs-number">320</span> * row + col] = color;<font></font>
			}<font></font>
		}<font></font>
<font></font>
		Odroid_DrawFrame(framebuffer);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">// Should never get here</span><font></font>
	esp_restart();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Asignamos el b√∫fer de trama de acuerdo con el tama√±o completo de la pantalla: 320 x 240, dos bytes por p√≠xel (color de 16 bits). </font><font style="vertical-align: inherit;">Usamos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heap_caps_malloc</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que se asigne en la memoria, que se puede usar para transacciones SPI con </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acceso directo a memoria (DMA)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">DMA permite que los perif√©ricos SPI accedan al b√∫fer de trama sin la necesidad de participaci√≥n de la CPU. </font><font style="vertical-align: inherit;">Sin DMA, las transacciones SPI toman mucho m√°s tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No realizamos comprobaciones para garantizar que el renderizado no se produzca fuera de los bordes de la pantalla.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Su navegador no admite video HTML5.</font></font><source src="https://austinmorlan.com/posts/embedded_game_programming_3/media/demo.mp4" type="video/mp4"></video></div></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fuerte desgarro es notable. En aplicaciones de escritorio, la forma est√°ndar de eliminar el desgarro es usar m√∫ltiples buffers. Por ejemplo, cuando el almacenamiento en b√∫fer doble, hay dos amortiguadores: amortiguadores delanteros y traseros. Mientras se muestra el b√∫fer frontal, la grabaci√≥n se realiza </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
en la parte trasera. Luego cambian de lugar y el proceso se repite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP32 no tiene suficiente RAM con capacidades DMA para almacenar dos buffers de trama (desafortunadamente, 4 MB de SPI RAM externo no tiene capacidades DMA), por lo que esta opci√≥n no es adecuada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ILI9341 tiene una se√±al ( </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TE</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) que le indica cu√°ndo ocurre </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VBLANK para</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que podamos escribir en la pantalla hasta que se dibuje. Pero con Odroid (o el m√≥dulo de visualizaci√≥n) esta se√±al no est√° conectada, por lo que no podemos acceder a ella.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tal vez podr√≠amos encontrar un valor decente, pero por ahora no lo haremos, porque ahora nuestra tarea es simplemente mostrar los p√≠xeles en la pantalla.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuente</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo el c√≥digo fuente se puede encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencias</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema de odroid go</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ir a jugar</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentaci√≥n ESP-IDF: SPI Master</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hoja de datos del controlador LCD</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es502518/index.html">Como trepar a un √°rbol</a></li>
<li><a href="../es502520/index.html">Informes en video de informes mitap sobre an√°lisis de productos</a></li>
<li><a href="../es502522/index.html">Abrimos el chip de aislamiento galv√°nico con un peque√±o transformador dentro</a></li>
<li><a href="../es502524/index.html">Los psicos hacen civilizaci√≥n</a></li>
<li><a href="../es502526/index.html">JUG Ru Group # 2 Semana de transmisi√≥n en l√≠nea</a></li>
<li><a href="../es502532/index.html">La revoluci√≥n en el departamento de TI (departamento). ¬øEs necesario?</a></li>
<li><a href="../es502536/index.html">Primeras impresiones y caracter√≠sticas clave de MIUI 12</a></li>
<li><a href="../es502538/index.html">C√≥mo construir una versi√≥n anterior de NGINX Ingress Controller y parchearlo</a></li>
<li><a href="../es502540/index.html">Alpine.js - sigue saliendo</a></li>
<li><a href="../es502542/index.html">C√≥mo le ense√±amos a Yandex a responder preguntas y ahorrar a los usuarios 20 mil horas al d√≠a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>