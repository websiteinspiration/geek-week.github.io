<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÑ ü§™ üßï Bitrix Auditor√≠a de bricolaje üò® üì§ üåÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos. 
 
 Cuando buscaba informaci√≥n sobre el registro (auditor√≠a de eventos) en Bitrix, no hab√≠a nada en Habr, pero hab√≠a algo m√°s en el rest...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bitrix Auditor√≠a de bricolaje</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491826/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola a todos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando buscaba informaci√≥n sobre el registro (auditor√≠a de eventos) en Bitrix, no hab√≠a nada en Habr, pero hab√≠a algo m√°s en el resto, pero ¬øqui√©n lo encontrar√° all√≠? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para reponer la base de conocimiento, decid√≠ escribir este art√≠culo: compartir mi experiencia y advertir sobre un posible rastrillo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulaci√≥n del problema</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mi tarea consist√≠a en desarrollar el sistema de contabilidad m√°s simple para las estructuras publicitarias, seg√∫n los t√©rminos del contrato estatal, el sistema deber√≠a funcionar sobre la base de Bitrix (versi√≥n 15). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era posible montar en bicicleta todo al lado de Bitrix, pero decid√≠ que ser√≠a demasiado deshonesto en relaci√≥n con el cliente, la funcionalidad de Bitrix se utiliz√≥ al m√°ximo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autenticacion de usuario</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sistema de almacenamiento de datos (EAV)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">editor de datos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controladores de eventos de auditor√≠a</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modelo a seguir para autorizar acciones de usuario</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesti√≥n de usuarios</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajar con directorios</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este art√≠culo trata principalmente de eventos de auditor√≠a, tambi√©n hablar√© un poco sobre la autorizaci√≥n y la adici√≥n de marcadores personalizados a la tarjeta de registro del bloque de informaci√≥n.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eventos de auditoria</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el sistema desarrollado, el trabajo con datos se realiza a trav√©s de la API (agregando un nuevo objeto al mapa y cambiando sus coordenadas), otros par√°metros del objeto se editan a trav√©s del editor de Bitrix, ya que la API no procesa todas las solicitudes de cambio de datos, por lo que la auditor√≠a solo en la API no estar√≠a completa, lo que significa Necesitamos una auditor√≠a del lado de Bitrix. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No es que no supiera qu√© es la auditor√≠a, pero no tengo que escribirla con frecuencia. Por lo general, esto se resuelve escribiendo la versi√≥n anterior de la fila (datos antiguos) en una tabla separada, y la implementaci√≥n se realiza completamente en el lado DBMS. Adem√°s, simult√°neamente tenemos un estado antes de los cambios y un estado despu√©s de los cambios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para escribir una auditor√≠a en los desencadenantes de DBMS, o para escribir una auditor√≠a en eventos de Bitrix, la diferencia no es grande. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los eventos para el procesamiento se registran en el script "</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bitrix / php_interface / init.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", si no hay un archivo, debe crearlo:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">use</span> <span class="hljs-title">Topliner</span>\<span class="hljs-title">Scheme</span>\<span class="hljs-title">Logger</span>;
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">require_once</span>($_SERVER[<span class="hljs-string">'DOCUMENT_ROOT'</span>] . <span class="hljs-string">'/vendor/autoload.php'</span>);
<span class="hljs-comment">//        </span>
<span class="hljs-keyword">if</span> (!defined(<span class="hljs-string">'IBLOCK_MODULE'</span>)) {<font></font>
    define(<span class="hljs-string">'IBLOCK_MODULE'</span>, <span class="hljs-string">'iblock'</span>);<font></font>
}<font></font>
<span class="hljs-comment">//    </span>
AddEventHandler(IBLOCK_MODULE, <span class="hljs-string">'OnIBlockElementAdd'</span>,
    <span class="hljs-keyword">Array</span>(Logger::class, <span class="hljs-string">'OnAdd'</span>));
<span class="hljs-comment">//     ,  -    ,              ,   </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es un ejemplo de un controlador, en mi implementaci√≥n hay varios de ellos, el c√≥digo se puede ver en el repositorio, el enlace estar√° al final del art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La firma del m√©todo para procesar el evento para cada evento tiene la suya, que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">observamos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> espec√≠ficamente </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">en la documentaci√≥n de Bitrix</font></a><font style="vertical-align: inherit;"> o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">debutamos</font></a><font style="vertical-align: inherit;"> y miramos las fuentes (m√°s claramente, todos los eventos y momentos de los controladores de llamadas tambi√©n se pueden ver en las fuentes durante la depuraci√≥n). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aqu√≠ nos enfrentamos al hecho de que cuando trabajamos con un DBMS, tenemos tanto datos actuales (antiguos) como datos que se registrar√°n (nuevos), y cuando trabajamos con Bitrix, tenemos datos antiguos o nuevos, pero no cuando no habr√° viejos y nuevos al mismo tiempo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otro problema es que hay varios eventos antes de cambiar los datos, y no pude entender la diferencia entre ellos, la misma historia es cuando se dispararon varios eventos despu√©s de que se cambiaron los datos, los ojos miran fijamente desde la gran cantidad de opciones, de hecho, es solo una ilusi√≥n de elecci√≥n.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mi humilde opini√≥n sobre Bitrix</font></font></b><div class="spoiler_text"><blockquote>       ,      ,    _  ,     (       Delphi        PHP),     .<br>
<br>
           depricated       ¬´¬ª,       .<br>
<br>
  ¬´ ¬ª       ( )  ¬´¬ª (, , )  ,              .                ,         ¬´¬ª  .<br>
<br>
             ,      :)<br>
<br>
            ,            ,       ,                  ,   ,       ,     ,   ?   .<br>
</blockquote><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando el estado global</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para guardar y pasar el estado entre los controladores de eventos, debe tener variables globales. </font><font style="vertical-align: inherit;">Las variables globales son algo que no se puede refactorizar, por lo que utilizo las propiedades est√°ticas de la clase:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span>
</span>{
    <span class="hljs-keyword">const</span> CHANGE = <span class="hljs-string">'change'</span>;
    <span class="hljs-keyword">const</span> REMOVE = <span class="hljs-string">'remove'</span>;
    <span class="hljs-keyword">const</span> CREATE = <span class="hljs-string">'create'</span>;
    <span class="hljs-keyword">const</span> UNDEFINED = <span class="hljs-string">'undefined'</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> $operation = <span class="hljs-built_in">self</span>::UNDEFINED;<font></font>
<font></font>
    <span class="hljs-keyword">const</span> NO_VALUE = [];<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> $fields = <span class="hljs-built_in">self</span>::NO_VALUE;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> $properties = <span class="hljs-built_in">self</span>::NO_VALUE;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> $names = <span class="hljs-built_in">self</span>::NO_VALUE;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ debe hacer una explicaci√≥n sobre el uso de "campos" y "propiedades". Los campos son los par√°metros que tiene cada registro de bloque de informaci√≥n (identificador, nombre, bloque de informaci√≥n "padre"), las propiedades son par√°metros espec√≠ficos para registros de un tipo particular de bloque de informaci√≥n, en el modelo EAV, estos son atributos y sus valores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los "nombres" son nombres de atributos, en un evento tenemos identificadores de atributos y nombres, en otro evento solo tenemos identificadores, y para un hermoso registro en el diario necesitamos guardar los nombres (por supuesto, podemos restar el identificador, pero por alguna raz√≥n no desea).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Operaci√≥n" es la operaci√≥n actual, para trabajar con "campos" Bitrix proporciona eventos espec√≠ficos, cuando se trabaja con "propiedades" (funciones "SetPropertyValues" y "SetPropertyValuesEx"), no hay evento con el tipo de operaci√≥n, hay un evento antes y despu√©s de la llamada, pero no Se sabe qu√© operaci√≥n se realiza (agregar / actualizar / eliminar), por lo tanto, la operaci√≥n tambi√©n debe transferirse del controlador al controlador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tal vez no lo descubr√≠, y en Bitrix puede ver simult√°neamente los valores como estaban y c√≥mo ser√°n, o tal vez fue necesario registrar por separado el estado anterior y el posterior, pero por alguna raz√≥n decid√≠ que la entrada del registro deber√≠a estar en el formato "propiedad % name% era% value antes del cambio% =&gt; se convirti√≥ en% value despu√©s de% ‚Äùy, por lo tanto, existen muchos problemas para mantener el estado global.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Determinar si se requieren cambios</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por extra√±o que parezca, se llamar√° a nuestro controlador para cambiar cualquier registro de cualquier bloque de informaci√≥n. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, en el controlador, necesitamos comprender el registro de qu√© bloque de informaci√≥n recibimos en los par√°metros. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El bloque de informaci√≥n de un registro se caracteriza por dos valores: el bloque de informaci√≥n en s√≠ ('IBLOCK_ID') y su secci√≥n ('IBLOCK_SECTION_ID'), y el identificador de secci√≥n a veces se encuentra en la matriz de valores con el √≠ndice 'IBLOCK_SECTION_ID', y a veces 'IBLOCK_SECTION', as√≠ que leo el identificador de secci√≥n por ambas teclas con prioridad para 'IBLOCK_SECTION'. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, en algunas situaciones, el identificador de secci√≥n no puede determinarse en principio, por lo tanto, la verificaci√≥n de la necesidad de agregar una entrada al registro de auditor√≠a debe realizarse solo en funci√≥n del identificador del bloque de informaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de determinar el bloque de informaci√≥n y la secci√≥n, decidimos la necesidad de registrar el evento en el diario.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guardar estado antes de cambios</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada entrada del bloque de informaci√≥n consta de dos partes, una parte es "campos", y estos par√°metros se cambian por m√©todos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: Add () </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: Update () </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: Delete ()</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La otra parte son los m√©todos de "propiedades":</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: SetPropertyValues ‚Äã‚Äã()</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: SetPropertyValuesEx ()</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No recuerdo por qu√©, pero es mejor abstenerse de usar CIBlockElement :: SetPropertyValuesEx () en mi c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada parte de los datos en su controlador de eventos es independiente de la otra, por lo tanto, al hacer clic en el bot√≥n "Guardar", se pueden crear dos entradas en el registro de auditor√≠a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las firmas de eventos para "campos" y "propiedades" son diferentes, en la parte con el procesamiento de "campos" guardamos el estado actual de los campos y establecemos el valor para la operaci√≥n, en la parte con el procesamiento de "propiedades" guardamos las propiedades y sus nombres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, hacemos esto en el manejador "antes".</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cambiar registro</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el controlador "despu√©s", escribimos en el registro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al compilar una lista de diferencias en los registros, hay un problema con los atributos que pueden tomar m√∫ltiples valores. </font><font style="vertical-align: inherit;">El formato para registrar su estado ‚Äúantes‚Äù y el estado ‚Äúdespu√©s‚Äù difiere tanto que uno no puede deducir el otro, por lo que al determinar si se registran cambios, siempre concluir√° que el registro es necesario. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo fuente de la auditor√≠a en el repositorio en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archivo src / Topliner / Scheme / Logger.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregar una pesta√±a personalizada a la tarjeta de bloque de informaci√≥n (en el clasificador de Bitrix)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para agregar una tarjeta, se utiliza un enfoque similar a la auditor√≠a: agregamos un controlador:</font></font><br>
<br>
<pre><code class="php hljs">AddEventHandler(<span class="hljs-string">'main'</span>, <span class="hljs-string">'OnAdminIBlockElementEdit'</span>,
    <span class="hljs-keyword">Array</span>(PermitTab::class, <span class="hljs-string">'OnInit'</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el m√©todo 'OnInit', definimos los otros m√©todos para trabajar con la pesta√±a en el editor de Bitrix:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PermitTab</span>
</span>{
    <span class="hljs-keyword">const</span> LINKS = <span class="hljs-string">'links'</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">OnInit</span>(<span class="hljs-params">$arArgs</span>)
    </span>{<font></font>
        $permits = BitrixScheme::getPermits();<font></font>
        $pubPermits = BitrixScheme::getPublishedPermits();<font></font>
        $blockId = (<span class="hljs-keyword">int</span>)$arArgs[<span class="hljs-string">'IBLOCK'</span>][<span class="hljs-string">'ID'</span>];<font></font>
        $letShow = $blockId === $permits-&gt;getBlock()<font></font>
            || $blockId === $pubPermits-&gt;getBlock();<font></font>
        $result = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> ($letShow) {<font></font>
            $result = [<font></font>
                <span class="hljs-string">'TABSET'</span> =&gt; <span class="hljs-string">'LinksToConstructs'</span>,
                <span class="hljs-string">'GetTabs'</span> =&gt; [<span class="hljs-built_in">static</span>::class, <span class="hljs-string">'GetTabs'</span>],
                <span class="hljs-string">'ShowTab'</span> =&gt; [<span class="hljs-built_in">static</span>::class, <span class="hljs-string">'ShowTab'</span>],
                <span class="hljs-string">'Action'</span> =&gt; [<span class="hljs-built_in">static</span>::class, <span class="hljs-string">'Action'</span>],
                <span class="hljs-string">'Check'</span> =&gt; [<span class="hljs-built_in">static</span>::class, <span class="hljs-string">'Check'</span>],<font></font>
            ];<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> $result;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, por supuesto, verificamos que para este bloque de informaci√≥n necesitamos mostrar nuestra pesta√±a de usuario, si es necesario, establecemos m√©todos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No hay nada especial que contar aqu√≠, vea las fuentes en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repositorio src / Topliner / Scheme / PermitTab.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lea la documentaci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo a seguir para autorizar acciones de usuario</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los m√©todos de autorizaci√≥n de Bitrix funcionan con una escala de derechos lineal, es decir, un escenario en el que uno puede tener el primero y el segundo, pero no el tercero, y el otro puede ser el segundo y el tercero, pero no el primero, no puede implementar Bitrix directamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para escenarios tan complicados en Bitrix, simplemente hay una verificaci√≥n de alg√∫n permiso, y en el c√≥digo al realizar la operaci√≥n, puede ver si el usuario tiene permiso o no, y permite el primer y segundo roles, y el segundo y el tercero permiten el otro rol.</font></font><br>
<br>
<pre><code class="php hljs">        $constSec = BitrixScheme::getConstructs();<font></font>
        $isAllow = CIBlockSectionRights::UserHasRightTo(<font></font>
            $constSec-&gt;getBlock(), $constSec-&gt;getSection(),<font></font>
            BitrixPermission::ELEMENT_ADD, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (!$isAllow) {<font></font>
            $output[<span class="hljs-string">'message'</span>] = <span class="hljs-string">'Forbidden, not enough permission;'</span>;<font></font>
        }<font></font>
</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ constSec-&gt; getBlock () - identificador de bloque de informaci√≥n</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ constSec-&gt; getSection () - identificador de secci√≥n</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BitrixPermission :: ELEMENT_ADD - c√≥digo de permiso</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el clasificador (directorio de bloques de informaci√≥n) en los bloques y secciones de informaci√≥n necesarios, asigna los derechos apropiados a los roles. </font><font style="vertical-align: inherit;">Distribuya roles a los usuarios y todo estar√° bajo su control.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autenticaci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si necesita autenticaci√≥n de usuario para algunas p√°ginas, simplemente agregue:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
define(<span class="hljs-string">"NEED_AUTH"</span>, <span class="hljs-literal">true</span>);
<span class="hljs-keyword">require</span>($_SERVER[<span class="hljs-string">"DOCUMENT_ROOT"</span>] . <span class="hljs-string">"/bitrix/header.php"</span>);
<span class="hljs-meta">?&gt;</span><font></font>
<font></font>
<span class="hljs-comment">//      </span><font></font>
<font></font>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">require</span>($_SERVER[<span class="hljs-string">"DOCUMENT_ROOT"</span>] . <span class="hljs-string">"/bitrix/footer.php"</span>);
<span class="hljs-meta">?&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al cargar dicha p√°gina, Bitrix entregar√° un formulario de inicio de sesi√≥n si el usuario a√∫n no ha iniciado sesi√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si solo necesita conectar Bitrix en alg√∫n tipo de script, entonces:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">require_once</span>($_SERVER[<span class="hljs-string">'DOCUMENT_ROOT'</span>]<font></font>
    . <span class="hljs-string">'/bitrix/modules/main/include/prolog_before.php'</span>);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabajar con directorios</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los directorios "nuevos" (a partir de noviembre de 2019) en Bitrix se llaman "HighloadBlock", trabajar con ellos es un poco no est√°ndar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada bloque Hyload se puede almacenar en una tabla separada, por lo tanto, para acceder al directorio, cada vez que necesite determinar el nombre de la tabla a leer. </font><font style="vertical-align: inherit;">Para no hacer esto constantemente, en Bitrix necesita crear una instancia de una clase para acceder a los datos. </font><font style="vertical-align: inherit;">Se crea una instancia en dos l√≠neas:</font></font><br>
<br>
<pre><code class="php hljs">CModule::IncludeModule(<span class="hljs-string">'highloadblock'</span>);<font></font>
$entity = HighloadBlockTable::compileEntity(<span class="hljs-string">'ConstructionTypes'</span>);<font></font>
$reference = $entity-&gt;getDataClass();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donde 'ConstructionTypes' es el c√≥digo de referencia. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Para</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
no escribir constantemente estas dos l√≠neas, puede escribir una clase que crear√° instancias de referencia para nosotros ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / Topliner / Bitrix / BitrixReference.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, trabajamos con la instancia como con la clase habitual de Bitrix ORM (D7):</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-comment">/* <span class="hljs-doctag">@var</span> $reference DataManager */</span>
$data = $reference::getList(<span class="hljs-keyword">array</span>(
    <span class="hljs-string">'select'</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">'UF_NAME'</span>, <span class="hljs-string">'UF_XML_ID'</span>),
    <span class="hljs-string">'filter'</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">'UF_TYPE_ID'</span> =&gt; <span class="hljs-number">0</span>)<font></font>
    ));<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositorio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (cuidadosamente, mucha copia y pegado) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias por su atenci√≥n.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es491812/index.html">Consejos y trucos de IntelliJ IDEA: 2. An√°lisis de dependencia</a></li>
<li><a href="../es491814/index.html">Diagrama de red como c√≥digo</a></li>
<li><a href="../es491816/index.html">[Previsi√≥n] Transporte del futuro: horizonte a largo plazo</a></li>
<li><a href="../es491818/index.html">Los fundamentos de la transferencia de datos confiable</a></li>
<li><a href="../es491824/index.html">Ama a todas las personas: los mejores informes con TeamLeadConf en 5 minutos</a></li>
<li><a href="../es491828/index.html">DataMatrix o c√≥mo etiquetar los zapatos correctamente</a></li>
<li><a href="../es491832/index.html">8 ventajas de Flutter en comparaci√≥n con React Native</a></li>
<li><a href="../es491838/index.html">MIPT lanza un curso abierto en l√≠nea sobre programaci√≥n deportiva</a></li>
<li><a href="../es491840/index.html">Visualizaci√≥n del trabajo de los trabajadores del servicio.</a></li>
<li><a href="../es491844/index.html">Visualizaci√≥n de cobertura de prueba autom√°tica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>