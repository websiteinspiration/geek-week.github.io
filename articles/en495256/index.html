<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêé üòò üÜò About ports and encryption in mail servers üçß üîò üîü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When configuring the outgoing mail server on the mail client, you see 3 options for encryption - without encryption, SMTPS and STARTTLS, as well as 3 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>About ports and encryption in mail servers</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495256/"><img src="https://habrastorage.org/webt/pj/a_/os/pja_osqbo80fknqvjnkwxjfdqma.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When configuring the outgoing mail server on the mail client, you see 3 options for encryption - without encryption, SMTPS and STARTTLS, as well as 3 possible ports - 25, 465, 587. What to choose and what for - let's understand.</font></font><br>
 <a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/GvyQvKyrEaI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Previous &lt; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail Server Operating Modes</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Next&gt; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DNS Records for Mail Servers</font></font></a><br>
<img src="https://habrastorage.org/webt/xd/iz/0b/xdiz0b5aiuipl9f9oylqxannogi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When you send a message to someone, your mail client uses ESMTP to send this message, and then your mail server uses the same protocol if it needs to send this message to another server. </font><font style="vertical-align: inherit;">And while everyone speaks and writes SMTP, it is usually about ESMTP - the same SMTP, but with a set of extensions, such as authorization and encryption. </font><font style="vertical-align: inherit;">Yes, once SMTP did not even support authorization.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/q8/zz/xc/q8zzxcz0tpk86ealobs3ghe6hd4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now a little about SMTPS. </font><font style="vertical-align: inherit;">Once the Internet was so simple that everything in it was transmitted in clear text. </font><font style="vertical-align: inherit;">Then came cryptographic encryption protocols, the same SSL. </font><font style="vertical-align: inherit;">And services that previously transmitted information in an open form, began to wrap traffic in SSL.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vi/ly/sg/vilysgbdveruivjlnd6bx00uk2o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But it was not easy to do this on the same standard ports - the client and server must agree on an encryption method, and for a service on one port to work simultaneously for some with encryption, and for others without - it would require changes in the protocols. And in order not to complicate everything, they began to sculpt separate ports for encrypted connections - this is how 443 for HTTPS and 465 for SMTPS appeared. But we realized it right now - there are few dedicated ports, the number of services is growing, and if each of them will use several ports with encryption and without encryption for their purposes - trouble.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/se/qs/ku/seqskuovnrhned_eis83hcbf9x0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in the end, they decided to modify the protocols a bit. In some cases, this did not work out very well, for example, for HTTP, and in the case of SMTP, it turned out to be a perfectly suitable option. For this, the STARTTLS extension was added to SMTP. In general, the STARTTLS extension is not only used for SMTP, in general it is a command to start encryption negotiations. Unlike SMTPS, which uses a dedicated port 465 and immediately encrypts the connection, STARTTLS is just an extension for SMTP, which means that the session is initiated as a regular SMTP session. Mail servers greet each other, and then offer to start encrypting and select the available cryptographic protocols.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3-/md/bw/3-mdbw0y7amg4gvwt2vh6e_csdy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, with the advent of STARTTLS from the standards, they decided to remove SMTPS on port 465 as a separate service. They removed it from the standards, but the service remained, and is still in use. As for encryption, I‚Äôll still make a separate topic, but for now let's talk about STARTTLS.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bv/-v/pi/bv-vpiqh-9bsozbp7cu7ajr1vfq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I said earlier that with STARTTLS, mail servers or a client / server open a connection without encryption, and then agree on encryption. They use the same SSL / TLS for encryption. But what if they cannot agree? It turns out they will communicate in unencrypted form? On the internet? Meanwhile, they agree without any encryption, thereby easily deceiving the server or client by the lack of available encryption methods. And at one time they caught one of the providers in such an attack. And then you need such encryption, you ask. Not everything is so hopeless. In fact, the administrator can disable the ability to send mail if it is not possible to agree on encryption, and mail clients are required to warn that the server does not support encryption.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jk/jd/yr/jkjdyrfzt3wgtv8rq35xchtqa3c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so, we figured out that there is SMTP that works on port 25, there are SMTPS that works on 465, but there is another port - 587, which is also used by the mail server.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qw/di/er/qwdiersbgizdugoml737dpbiihq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you noticed, email clients connect to servers via SMTP. And mail servers connect to each other via SMTP as well. I also said in the last part that there are such servers - relay hosts that forward mail. For certain reasons, mostly human, there are relay hosts on the Internet that allow unauthorized users to redirect messages from any address. And these hosts appear every time when a negligent admin raises the mail server, and this happens often. As a result, cybercriminals raise temporary servers or infect computers of users who send spam through these relay hosts without authorization. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ft/im/ml/ftimml9dpl0jriux1qzfyk4vxkm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, some Internet providers block any user connections to port 25.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/zd/w9/f2zdw98_ws_lxyyldagtxnhuaf0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This port is open between servers on the Internet, but they made a separate service for users - MSA (message submission agent - sending agent), thereby separating user connections from server connections that still communicate via MTA. In general, MSA even works on port 25, but the official port for it is 587. So what prevents spammers from using this port? The fact that the MSA, as a rule, requires user authorization. This is not the only reason for the existence of MSA - since it works with email clients, it is better optimized for the work of clients - it immediately warns of any errors in messages, for example, the absence of the recipient's domain address.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nk/in/xg/nkinxgm7k5y9--jpyllipbfbej4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And finally, let's follow the process of sending an email message. </font><font style="vertical-align: inherit;">To do this, use wireshark, an email client and a gmail account. </font><font style="vertical-align: inherit;">It all starts with the standard TCP handshake, after which the SMTP session is started. </font><font style="vertical-align: inherit;">During the session, the mail client and server greet each other, after which the mail client offers to encrypt the session, the server agrees, after which the keys are exchanged and the TLSv1.3 session begins, after which the client logs in encrypted and sends a message that is not visible for a traffic interceptor.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495242/index.html">5NO - NodeJS ORM for Postgres</a></li>
<li><a href="../en495246/index.html">SAP Specialist: Who is and How to Become One</a></li>
<li><a href="../en495248/index.html">The role of self-isolation and hand washing</a></li>
<li><a href="../en495250/index.html">Do gamepads have a future?</a></li>
<li><a href="../en495254/index.html">Simulation of targeted cyberattacks, Red Team, Pentest, vulnerability scanning. Pros and cons of various methods</a></li>
<li><a href="../en495258/index.html">How Zoom became the most important company in the era of coronavirus</a></li>
<li><a href="../en495262/index.html">PostgreSQL version upgrade practice. Andrey Salnikov</a></li>
<li><a href="../en495266/index.html">Renaissance e-learning. Why 2020 will show all the advantages of distance learning</a></li>
<li><a href="../en495268/index.html">UI / UX case: airport parking automation</a></li>
<li><a href="../en495272/index.html">SNES emulators just a few pixels away from absolute perfection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>