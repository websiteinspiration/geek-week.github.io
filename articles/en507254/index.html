<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äç‚ù§Ô∏è‚Äçüë® üêâ üë∞üèø Zabbix - expanding macro borders üë®‚Äçüè´ üôåüèº üé£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Making a solution for the client, there were 2 tasks that I wanted to solve beautifully and with regular Zabbix functionality. 
 
 Task 1. Tracking th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Zabbix - expanding macro borders</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/507254/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Making a solution for the client, there were 2 tasks that I wanted to solve beautifully and with regular Zabbix functionality. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task 1.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tracking the current firmware version on Mikrotik routers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task is solved easily - by adding an agent to the HTTP template. The agent receives the current version from the Mikrotik website, and the trigger compares the current version with the current one and, in case of a discrepancy, issues an alert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you have 10 routers, this algorithm is not critical, but what to do with 3000 routers? Send 3000 requests to the server? Of course, such a scheme will work, but the idea of ‚Äã‚Äã3000 queries did not suit me, I wanted to find another solution. In addition, there was a drawback in such an algorithm: the other side can calculate such a number of requests from one IP for a DoS attack, they can simply ban it. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Task 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using an authorization session in different HTTP agents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When through an HTTP agent you need to receive information from "closed" pages, you need an authorization cookie. To do this, there is usually a standard authorization form with a login / password pair and setting the session ID in the cookie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there is a problem, you cannot access data from another item from one item of the HTTP agent to substitute this value in the Header. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is also a ‚ÄúWeb scenario‚Äù, it has another limitation, it does not allow to receive content for analysis and further storage. You can only check for the presence of the necessary variables on the pages or pass the previously obtained variables between the steps of the web script.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After a little reflection on these tasks, I decided to use macros that are perfectly visible in any part of the monitoring system: in templates, hosts, triggers or items. </font><font style="vertical-align: inherit;">And macros can be updated via the web interface API.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbix has a good and detailed API documentation. </font><font style="vertical-align: inherit;">To exchange data via api, the Json data format is used. </font><font style="vertical-align: inherit;">Details can be found in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">official documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The sequence of actions for obtaining the data we need and recording them in a macro is presented in the diagram below.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xj/of/h-/xjofh-pgwt34jl-vwzzrhhe8fly.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The very first step may consist of one action or many actions. </font><font style="vertical-align: inherit;">In the first steps, all the basic logic is laid, and the main are the last 3 steps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my example, the first step was to obtain the authorization cookies on the PBX for the first task. </font><font style="vertical-align: inherit;">For the second task, I got the number of the current Mikrotik firmware version.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URL of current Mikrotik firmware versions</font></font></b>
                        <div class="spoiler_text"><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">upgrade.mikrotik.com/routeros/LATEST.6</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - URL of the current Stable version</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">upgrade.mikrotik.com/routeros/LATEST.6fix</a> ‚Äî URL   LTS </li>
</ul><br>
      Mikrotik,      .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first step is completely individual for each case and the logic of its work may be different. </font><font style="vertical-align: inherit;">It all depends on your task.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When working with web scripts, keep track of which method you need to get the response. </font><font style="vertical-align: inherit;">HTTP response </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">headers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or the </font><font style="vertical-align: inherit;">response </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">body</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> itself </font><font style="vertical-align: inherit;">without headers? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If authorization cookies are needed, then set the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Headers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> response method </font><font style="vertical-align: inherit;">as in the case of Asterisk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you need data, as is the case with the response of the mikrotik server, put the </font><font style="vertical-align: inherit;">Response </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">body</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> without headers.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We pass to the second step. </font><font style="vertical-align: inherit;">Getting an authorization session:</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">POST</span> http://company.com/zabbix/api_jsonrpc.php HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><font></font>
Content-Type: application/json-rpc<font></font>
<font></font>
{<font></font>
    "jsonrpc": "2.0",<font></font>
    "method": "user.login",<font></font>
    "params": {<font></font>
        "user": "Admin"<font></font>
        "password": "zabbix"<font></font>
    },<font></font>
    "id": 1,<font></font>
    "auth": <span class="hljs-attribute">null</span>
}</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonrpc is the version of the JSON-RPC protocol that is used; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbix implements JSON-RPC version 2.0;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method - the method that is called;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">params - parameters that are passed by the method;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id - an arbitrary request identifier;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auth - user authentication key; </font><font style="vertical-align: inherit;">like we don‚Äôt have it yet, we set it to null.</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To work with the API, I created a separate account with limited rights. Firstly, you do not need to give access to where you do not need to. And secondly, before version 5.0, the password specified through the macro could be read. Accordingly, if you use the Zabbix admin password, the admin account is easy to steal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This will be especially true when working with the API through third-party scripts and store credentials on the side. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since version 5.0, the option to hide the password saved in the macro has appeared. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/26/y5/pr/26y5pr4auyxr1cszmm4xzfsswv4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When creating a separate account for updating data via the API, be sure to check whether the data you need is accessible through the web interface and whether it is possible to update it. I did not check, and then for a long time I could not understand why the macro I needed was not visible by the API.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hb/wp/xp/hbwpxpunvf_aji_5pbnlx0ao4xw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After you have received authorization in the API, we proceed to obtain a list of macros. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The API does not allow updating the host macro by name, for this you need to first get the macro ID. </font><font style="vertical-align: inherit;">Moreover, to get a list of macros for a specific host, you need to find out the ID of this host, and this is an extra request. </font><font style="vertical-align: inherit;">You </font><font style="vertical-align: inherit;">cannot </font><font style="vertical-align: inherit;">use the regular macro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{HOST.ID}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the request. </font><font style="vertical-align: inherit;">The limitation decided to get around this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/va/1d/qava1dngv9wr_wmydwyw-wmb030.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I created a local macro with the ID of this host. </font><font style="vertical-align: inherit;">It is very easy to find out the host ID from the web interface. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The response with a list of all macros of a given host can be filtered by a template:</font></font><br>
<br>
<pre><code class="perl hljs">regex:{<span class="hljs-string">"hostmacroid"</span>:<span class="hljs-string">"([0-9]+)"</span>[A-z<span class="hljs-number">0</span>-<span class="hljs-number">9</span>,<span class="hljs-string">":]+"</span>{\$MIKROTIK_VERSION}<span class="hljs-string">"</span></code></pre><br>
<img src="https://habrastorage.org/webt/vg/9q/od/vg9qod-ek9z0rdxyeuszidxvy6e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, we get the ID of the macro we need, where </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIKROTIK_VERSION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the name of the macro we are looking for. </font><font style="vertical-align: inherit;">In my case, it searches for the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIKROTIK_VERSION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> macro </font><font style="vertical-align: inherit;">that has been assigned to the host. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The request itself looks like this:</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">POST</span> http://company.com/zabbix/api_jsonrpc.php HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><font></font>
Content-Type: application/json-rpc<font></font>
<font></font>
{<font></font>
    "jsonrpc":"2.0",<font></font>
    "method":"usermacro.get",<font></font>
    "params":{<font></font>
        "output":"extend",<font></font>
        "hostids":"{$HOST_ID}"<font></font>
    },<font></font>
    "auth":"{sid}",<font></font>
    "id":1<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The variable </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{sid} was</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> obtained in the second step and will be used constantly, where it is necessary to work with the API interface.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Final 4 STEP - macro update</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we know the macro ID that needs to be updated, the authorization cookie or the firmware version of the router. </font><font style="vertical-align: inherit;">You can update the macro itself.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">POST</span> http://company.com/zabbix/api_jsonrpc.php HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><font></font>
Content-Type: application/json-rpc<font></font>
<font></font>
{<font></font>
    "jsonrpc":"2.0",<font></font>
    "method":"usermacro.update",<font></font>
    "params":{<font></font>
        "hostmacroid":"{hostmacroid}",<font></font>
        "value":"{mikrotik_version}"<font></font>
    },<font></font>
    "auth":"{sid}",<font></font>
    "id":1<font></font>
}<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{mikrotik_version}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the value obtained in the first step. </font><font style="vertical-align: inherit;">In my example - the version of the current firmware mikrotik </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{hostmacroid}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the value was obtained in the third step - the macro id, which we update.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The approach to solving the problem with regular functionality is many times more complicated and longer. </font><font style="vertical-align: inherit;">Especially if you know programming and can quickly throw the necessary logic in the script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The obvious advantage of this approach is the ‚Äúportability‚Äù of the solution between different servers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Personally, it‚Äôs strange for me to not be able to access the data of another item in the HTTP agent and substitute them in the request body or headers [ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZBXNEXT-5993</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The finished template can be </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">downloaded on GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en507234/index.html">Snort or Suricata. Part 2: installation and initial setup of Suricata</a></li>
<li><a href="../en507236/index.html">We increase the effectiveness of interaction between designers and frontend developers</a></li>
<li><a href="../en507238/index.html">We use DS to process customer reviews from large sites</a></li>
<li><a href="../en507242/index.html">What is interesting Wi-Fi 6 in the performance of Huawei</a></li>
<li><a href="../en507250/index.html">Defining a winning poker hand using map / reduce in JavaScript</a></li>
<li><a href="../en507256/index.html">Peter Hinchens: Psychopath Source Code</a></li>
<li><a href="../en507258/index.html">Bonuses, benefits and bonuses in IT: the results of Habr Career research</a></li>
<li><a href="../en507260/index.html">Fast Lifehack for Application Growth - ASO in Other Languages</a></li>
<li><a href="../en507264/index.html">New Features in Python 3.9</a></li>
<li><a href="../en507270/index.html">Selecting Dependencies for a Project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>