<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏮 🛐 👩🏼‍🎤 Maison intelligente sans télécommandes, mais avec un cube 🤷🏾 🔯 🐁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Problème
 
 

Lors de la réparation d'un nouvel appartement, je suis rentré dans l'appartement dans lequel je n'avais pas vécu depuis 10 ans et j'ai d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Maison intelligente sans télécommandes, mais avec un cube</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496856/"><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problème</font></font></h3><br>
 <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f01/d76/558/f01d76558d836eb09b9838514b61dc61.jpg"></div><br>
 <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors de la réparation d'un nouvel appartement, je suis rentré dans l'appartement dans lequel je n'avais pas vécu depuis 10 ans et j'ai décidé de pratiquer la discipline «Smart Home» afin d'équiper un nouvel appartement en connaissance de cause. L'équipement de cet appartement n'est pas non plus le plus intelligent et le plus récent, car il a été produit il y a environ 10 ans. Surtout dans l'appartement, j'ai été gêné par l'abondance de télécommandes infrarouges, elles ont été perdues et ont chargé le cerveau de la sélection de la bonne. Jusqu'à récemment, il a été décidé de créer un grand nombre de boutons inutilisés sur les télécommandes. Et les consoles ne sont ni esthétiques ni hygiéniques, certaines sont anguleuses, d'autres aux bords arrondis, les boutons jaunissent et les vestiges de la vie des habitants sur lesquels se forme une «biocénose sous-bouton» s'y accumulent. En conséquence, une douzaine de télécommandes sont dispersées dans la maison avec un tas de boutons inutiles, pour des opérations simples j'ai dû chercher deux ou trois pièces, leur look me gratte les yeux,Je voulais une commande vocale tactile confortable et à la mode.</font></font></p><a name="habracut"></a><br>
<h3></h3><br>
 <p>          ,         .             .     xiaomi          Xiaomi universal IR remotecontroller  Xiaomi Mi Smart Home Magic Cube,         Xiaomi smart home gateway 2</p><br>
<img src="https://habrastorage.org/getpro/habr/post_images/99d/4d4/062/99d4d4062e0b4e751d8cbd5daee9c4e7.jpg" width="300"><br>
<br>
<h3></h3><br>
 <p>    ,  ,   IR ,    — ZigBee .  ,  , .</p> <br>
 <p>      ,      ,       xiaomi,  ,              Mi Home    “”.   ,           ,   .   ,                   .   ,                  ,    ( )      Mi Home 10        5    ,    30     10 ,       ,  ,    1      ,   .   ,   ...</p><br>
 <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le problème de la Chine ne vient pas seul, sauf que les freins à frotter sont devenus l'incapacité de visser un cube intelligent au contrôle du son.</font></font></p> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le cube est contrôlé par des gestes: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secouer</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se déplacer dans un avion</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rotation de 90/180 degrés autour de l'axe horizontal</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rotation autour d'un axe vertical</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et etc...</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/04c/7f1/589/04c7f1589de5ab65448e3a5851900c42.png" width="500"><br>
<br>
<p>   —    ,    ,   ,             ,        ,   90     —    10 ,   45    —    5 .             ,      —       ZigBee,  -   ,     3     .</p><br>
<p>             Home Assistant,   ,   ,   Xiaomi    ,               ZigBee . Security token    IR            ,      Mi Home       .  xiaomi gateway   ,     UART RX/TX             Home Assistant.</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le Home Assistant lui-même doit être lancé quelque part, le Synology DS718 + est venu dans le cadre de cette tâche, qui a été utilisée comme centre multimédia DLNA et téléchargement de torrent. </font><font style="vertical-align: inherit;">Cet appareil est capable d'exécuter des conteneurs Docker, et un conteneur avec Home Assistant y est facilement enroulé. </font><font style="vertical-align: inherit;">Home Assistant est cool, mais contrairement à Mi Home, vous devez y écrire toute l'intelligence d'une maison avec des stylos en yaml. </font><font style="vertical-align: inherit;">Ayant maîtrisé le DSL, compris Home Assistant et recraché d'un autre outil de programmation qui ne nécessite pas de connaissance du PL, j'ai réussi à concocter une béquille de la forme souhaitée.</font></font></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Code d'automatisation:</font></font><br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- id: volume_up</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  alias: augmentation du volume</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  déclencheur:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  - event_data:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      type_action: rotation</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      entity_id: binary_sensor.cube_0000000103ec74</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    event_type: xiaomi_aqara.cube_action</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    plateforme: événement</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  état:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    condition: modèle</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    value_template: "{{trigger.event.data.action_value&gt; 0}}"</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  action:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  - service_template: "script.bbk_vol_up _ {{(trigger.event.data.action_value / 3) | int}}"</font></font></pre></blockquote><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette automatisation intercepte l'événement de rotation dans le sens horaire et appelle un script au nom duquel le nombre de signaux d'augmentation du son que l'émetteur infrarouge doit envoyer est substitué. </font><font style="vertical-align: inherit;">Comme vous l'avez probablement deviné, chaque coin de la rotation nécessite son propre script, le copier-coller a été appelé pour les créer, et il m'a donné 20 scripts comme ceux-ci:</font></font></p><br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bbk_vol_up_10:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  séquence:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  - Les données:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      commander:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      - bbk_vol_up</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      delay_secs: 0,04</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      num_repeats: 10</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    entity_id: remote.xiaomi_miio_192_168_2_62</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    service: remote.send_command</font></font></pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La configuration de l'émetteur avec les signaux interceptés du panneau des haut-parleurs ressemble à ceci:</font></font><br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éloigné:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  - plate-forme: xiaomi_miio</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    hôte: 192.168.2.62</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    jeton: 392cbed325e862ffff983c4575b7a6f2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    commandes:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      bbk_power:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        commande: raw: nE5m0wlk0msxmEsmszmEsm0wAHKaABkAoQAcAL1MZtOQEFmM3ARMCHwCymM2m4ENgXEAioHlgy + AwoL3gvYAh4L0gGGEBYLCAL0BR4CHhU4A + wQ8</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      bbk_vol_up:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        commande: raw: nMwmUwlk0mk1mEsms3ADKbABlM5hLJtMAD2ALKazkAdgAymM3AYMBApjNgKTmgGLABuBD4IaAEKA1YJrgyuBDwJvgZeEx4C / geHMZsA4YCDJxox</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      bbk_vol_down:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        commande: raw: nE5m0wlk0msxmEsmszmEsm0wAHKaABkAoQAcAL1MZtOQEFmM3ARMCHwIfAdQBFZuAQYFfAfuBCoHngveEx4C / gL + Cj4R2ANfLJqAYQUChU3MAA</font></font></pre><br>
</blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hourra! </font><font style="vertical-align: inherit;">Le son contrôle la rotation du cube autour de l'axe vertical, et le téléviseur et les haut-parleurs sont allumés en tournant le cube de 90 degrés autour de l'axe horizontal.</font></font><br>
<br>
<p> Home Assistant  ,        , Google Assistant   Home Assistant,     . GA     ,   .       ,           .        Ethernet ,        ,      IP       ,  IP     —  ,   .        custom_component  Home Assistant:</p><br>
<blockquote><pre>import logging<font></font>
from homeassistant.helpers.entity import Entity<font></font>
from pythonping import ping<font></font>
<font></font>
logger = logging.getLogger(__name__)<font></font>
<font></font>
def setup_platform(hass, config, add_entities, discovery_info=None):<font></font>
    entities = []<font></font>
    for name, ip in config['hosts'].items():<font></font>
        entities.append(IPSensor(name, ip))<font></font>
<font></font>
    add_entities(entities)<font></font>
<font></font>
class IPSensor(Entity):<font></font>
    def __init__(self, name, ip):<font></font>
        self._name = name<font></font>
        self._ip = ip<font></font>
        self._state = None<font></font>
        self._is_on = None<font></font>
<font></font>
    @property<font></font>
    def name(self):<font></font>
        return self._name<font></font>
<font></font>
    @property<font></font>
    def state(self):<font></font>
        return self._state<font></font>
<font></font>
    @property<font></font>
    def state_attributes(self):<font></font>
        return {'ip_address': self._ip}<font></font>
<font></font>
    @property<font></font>
    def device_class(self):<font></font>
        return 'connectivity'<font></font>
<font></font>
    @property<font></font>
    def is_on(self):<font></font>
        return self._is_on<font></font>
<font></font>
    def update(self):<font></font>
        result = ping(self._ip, count=1, timeout=0.1)<font></font>
        self._is_on = result.success()<font></font>
        self._state = 'on' if result.success() else ‘off'</pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connectez ensuite l'émetteur infrarouge avec le capteur au commutateur comme ceci:</font></font><br>
<blockquote><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commutateur:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
  - plateforme: modèle</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    commutateurs:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
      toshiba_tv:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        value_template: "{{is_state ('binary_sensor.toshiba_tv', 'on')}}"</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        allumer:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          service: script.toshiba_power</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        éteindre:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
          service: script.toshiba_power</font></font></pre></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et un tel commutateur a commencé à être affiché dans Google Home et contrôlé par la voix. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exercice PS avec une maison intelligente a réussi, est allé acheter de nouveaux appareils! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PPS Un hub ZigBee illumine maintenant le couloir pour une raison quelconque ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'était</font></font></h4><br>
<img src="https://habrastorage.org/webt/da/tl/lf/datllfwsuxaymb2ambzwp-20faq.jpeg" width="300"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est devenu</font></font></h4><br>
<img src="https://habrastorage.org/webt/co/bo/ly/cobolyyfof7zpaqji3wfgx0dkfw.jpeg" width="300"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496842/index.html">Un modèle épidémique simple avec des outils de base Python</a></li>
<li><a href="../fr496846/index.html">Mécanique du langage des piles et des pointeurs</a></li>
<li><a href="../fr496848/index.html">Le condensé de matériaux intéressants pour le développeur mobile # 340 (du 6 au 12 avril)</a></li>
<li><a href="../fr496850/index.html">Plugin Maven pour JPackage de Java 14</a></li>
<li><a href="../fr496852/index.html">Tri en douceur</a></li>
<li><a href="../fr496858/index.html">FOSS News n ° 11 - une revue des logiciels libres et open source du 6 au 12 avril 2020</a></li>
<li><a href="../fr496860/index.html">Première DI: Première DI sur les interfaces pour les applications dactylographiées</a></li>
<li><a href="../fr496862/index.html">Affichage Bulle Arduino</a></li>
<li><a href="../fr496864/index.html">Portefeuilles d'audit dans CryptoNote</a></li>
<li><a href="../fr496868/index.html">Small Space Symphony</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>