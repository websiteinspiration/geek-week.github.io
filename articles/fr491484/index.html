<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úåüèΩ ‚óÄÔ∏è üë©üèæ‚Äçüíª Stas Afanasyev. Juno. Pipelines bas√©s sur io.Reader / io.Writer. Partie 1 üóùÔ∏è ‚úåüèæ üè∑Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le rapport, nous parlerons du concept de io.Reader / io.Writer, pourquoi ils sont n√©cessaires, comment les impl√©menter correctement et quels pi√®g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Stas Afanasyev. Juno. Pipelines bas√©s sur io.Reader / io.Writer. Partie 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/491484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans le rapport, nous parlerons du concept de io.Reader / io.Writer, pourquoi ils sont n√©cessaires, comment les impl√©menter correctement et quels pi√®ges existent √† cet √©gard, ainsi que de la construction de pipelines bas√©s sur des impl√©mentations standard et personnalis√©es de io.Reader / io.Writer .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rd/nv/uj/rdnvujcjwsukejxq_6a9syayawu.jpeg"><a name="habracut"></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stanislav Afanasyev (ci-apr√®s - SA):</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Bonjour! Je m'appelle Stas. Je venais de Minsk, de la soci√©t√© Juno. Merci d'√™tre venu ce jour de pluie, d'avoir trouv√© la force de quitter la maison. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, je veux vous parler d'un sujet tel que la construction de pipelines Go bas√©s sur les interfaces io.Reader / io.Writer. Ce dont je vais parler aujourd'hui est, en g√©n√©ral, le concept des interfaces io.Reader / io.Writer, pourquoi elles sont n√©cessaires, comment les utiliser correctement et, surtout, comment les impl√©menter correctement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous parlerons √©galement de la construction de pipelines bas√©s sur diverses impl√©mentations de ces interfaces. Nous parlerons des m√©thodes existantes, discuterons de leurs avantages et inconv√©nients. Je mentionnerai divers pi√®ges (ce sera en abondance).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer, nous devons r√©pondre √† la question: pourquoi ces interfaces sont-elles n√©cessaires? </font><font style="vertical-align: inherit;">Levez la main, qui travaille √©troitement avec Go (tous les jours, tous les deux jours) ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d2/pd/f4/d2pdf4kdwdjk_vxkqz6fwckqrgk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
G√©nial! </font><font style="vertical-align: inherit;">Nous avons toujours une communaut√© Go. </font><font style="vertical-align: inherit;">Je pense que beaucoup d'entre vous ont travaill√© avec ces interfaces, en ont entendu parler, au moins. </font><font style="vertical-align: inherit;">Vous ne les connaissez peut-√™tre m√™me pas, mais vous auriez certainement d√ª en entendre parler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, ces interfaces sont une abstraction de l'op√©ration entr√©e-sortie dans toutes ses manifestations. </font><font style="vertical-align: inherit;">Deuxi√®mement, c'est une API tr√®s pratique qui vous permet de construire des pipelines, comme un constructeur √† partir de cubes, sans vraiment penser aux d√©tails internes de l'impl√©mentation. </font><font style="vertical-align: inherit;">Au moins, c'√©tait initialement pr√©vu.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'une interface tr√®s simple. Il se compose d'une seule m√©thode - la m√©thode Read. Conceptuellement, l'impl√©mentation de l'interface io.Reader peut √™tre une connexion r√©seau - par exemple, o√π il n'y a pas encore de donn√©es, mais elles peuvent y appara√Ætre: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n-/4n/dc/n-4ndcbxpoxkul6h227ue7hruli.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
il peut s'agir d'un tampon en m√©moire o√π les donn√©es existent d√©j√† et peuvent √™tre lues enti√®rement. Il peut √©galement s'agir d'un descripteur de fichier - nous pouvons lire ce fichier en morceaux s'il est tr√®s volumineux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'impl√©mentation conceptuelle de l'interface io.Reader est l'acc√®s √† certaines donn√©es. Tous les cas que j'ai √©crits sont pris en charge par la m√©thode Read. Il n'a qu'un seul argument - c'est l'octet de tranche.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un point √† souligner ici. Ceux qui sont venus r√©cemment sur Go ou sont venus d'une autre technologie, o√π il n'y avait pas d'API similaire (je suis de ceux-l√†), cette signature est un peu d√©routante. La m√©thode Read semble lire en quelque sorte cette tranche. En fait, l'inverse est vrai: l'impl√©mentation de l'interface Reader lit les donn√©es √† l'int√©rieur et remplit cette tranche avec les donn√©es que cette impl√©mentation poss√®de.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La quantit√© maximale de donn√©es pouvant √™tre lues sur demande par la m√©thode Read est √©gale √† la longueur de cette tranche. </font><font style="vertical-align: inherit;">Une impl√©mentation r√©guli√®re renvoie autant de donn√©es qu'elle peut en renvoyer au moment de la demande, ou la quantit√© maximale qui correspond √† cette tranche. </font><font style="vertical-align: inherit;">Cela sugg√®re que Reader peut √™tre lu en morceaux: au moins par octet, au moins dix - comme vous le souhaitez. </font><font style="vertical-align: inherit;">Et le client qui appelle Reader, selon les valeurs de retour de la m√©thode Read, pense comment vivre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode Read renvoie deux valeurs:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre d'octets soustraits;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une erreur si elle s'est produite.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces valeurs influencent le comportement futur du client. </font><font style="vertical-align: inherit;">Il y a un gif sur la diapositive qui montre, affiche ce processus, que je viens de d√©crire:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/ww/sf/siwwsf6u8mb1nkztg0ltnumkckw.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/p1/hk/mb/p1hkmbpfp8-twtnznjj2ihireaa.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Io.Reader - Comment faire?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe exactement deux fa√ßons pour que vos donn√©es satisfassent l'interface du Reader. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/l0/fm/e7/l0fme7quz_tqzilkfiuiddpgjk4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le premier est le plus simple. Si vous avez une sorte d'octet de tranche et que vous voulez qu'il satisfasse l'interface Reader, vous pouvez prendre l'impl√©mentation d'une biblioth√®que standard qui satisfait d√©j√† cette interface. Par exemple, Reader √† partir du package d'octets. Sur la diapositive ci-dessus, vous pouvez voir la signature de la fa√ßon dont ce Reader est cr√©√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe un moyen plus compliqu√© - d'impl√©menter l'interface Reader vous-m√™me. Il y a environ 30 lignes dans la documentation avec des r√®gles compliqu√©es, des restrictions qui doivent √™tre suivies. Avant de parler de chacun d'eux, il m'est devenu int√©ressant: ¬´Et dans quels cas les impl√©mentations standard (biblioth√®que standard) ne sont-elles pas suffisantes? Quel est le moment o√π nous devons impl√©menter l'interface Reader nous-m√™mes? ¬ª</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de r√©pondre √† cette question, j'ai pris les milliers de r√©f√©rentiels les plus populaires sur Github (par le nombre d'√©toiles), les ai ajout√©s et y ai trouv√© toutes les impl√©mentations de l'interface Reader. </font><font style="vertical-align: inherit;">Sur la diapositive, j'ai quelques statistiques (cat√©goris√©es) sur le moment o√π les gens impl√©mentent cette interface.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La cat√©gorie la plus populaire est celle des connexions. </font><font style="vertical-align: inherit;">Il s'agit d'une impl√©mentation de protocoles propri√©taires et d'encapsuleurs pour les types existants. </font><font style="vertical-align: inherit;">Ainsi, Brad Fitzpatrick a un projet Camlistore - il y a un exemple sous la forme de statTrackingConn, qui, en g√©n√©ral, est un wrapper ordinaire sur le type con du package net (ajoute des m√©triques √† ce type).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La deuxi√®me cat√©gorie la plus populaire est celle des tampons personnalis√©s. </font><font style="vertical-align: inherit;">Ici, j'ai aim√© le seul et unique exemple: dataBuffer du package x / net. </font><font style="vertical-align: inherit;">Sa particularit√© est qu'il stocke les donn√©es d√©coup√©es en morceaux, et lors de la soustraction, il passe √† travers ces morceaux. </font><font style="vertical-align: inherit;">Si les donn√©es du bloc sont termin√©es, elles passent au bloc suivant. </font><font style="vertical-align: inherit;">Dans le m√™me temps, il prend en compte la longueur, la place qu'il peut remplir dans la tranche transmise.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une autre cat√©gorie comprend toutes sortes de barres de progression, comptant le nombre d'octets soustraits lors de l'envoi de m√©triques ...</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la base de ces donn√©es, nous pouvons dire que la n√©cessit√© de mettre en ≈ìuvre l'interface io.Reader se produit assez souvent. </font><font style="vertical-align: inherit;">Commen√ßons ensuite par parler des r√®gles qui se trouvent dans la documentation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√®gles de documentation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme je l'ai dit, la liste des r√®gles, et en g√©n√©ral la documentation est assez grande, massive. 30 lignes suffisent pour une interface compos√©e de seulement trois lignes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re r√®gle, la plus importante, concerne le nombre d'octets renvoy√©s. Elle doit √™tre strictement sup√©rieure ou √©gale √† z√©ro et inf√©rieure ou √©gale √† la longueur de la tranche envoy√©e. Pourquoi c'est important? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1k/kp/xh/1kkpxhahoiicme8z8vbdbq5ajbm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme il s'agit d'un contrat assez strict, le client peut faire confiance au montant provenant de la mise en ≈ìuvre. Il existe des wrappers dans la biblioth√®que standard (par exemple, bytes.Buffer et bufio). Il y a un tel moment dans la biblioth√®que standard: certaines impl√©mentations font confiance aux lecteurs envelopp√©s, d'autres ne font pas confiance (nous en reparlerons plus tard).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bufio ne fait confiance √† rien - il v√©rifie absolument tout. </font><font style="vertical-align: inherit;">Bytes.Buffer fait enti√®rement confiance √† tout ce qui lui arrive. </font><font style="vertical-align: inherit;">Je vais maintenant montrer ce qui se passe √† ce sujet ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant consid√©rer trois cas possibles - ce sont trois lecteurs impl√©ment√©s. </font><font style="vertical-align: inherit;">Ils sont assez synth√©tiques, utiles √† la compr√©hension. </font><font style="vertical-align: inherit;">Nous lirons tous ces lecteurs √† l'aide de l'assistant ReadAll. </font><font style="vertical-align: inherit;">Sa signature est pr√©sent√©e en haut de la diapositive:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ib/c1/7b/ibc17bdqyrimk3xce2khqwera4w.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader # 1. </font><font style="vertical-align: inherit;">Exemple 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ReadAll est un assistant qui accepte une sorte d'impl√©mentation de l'interface Reader, lit tout et retourne les donn√©es qu'il a lues, ainsi qu'une erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre premier exemple est Reader, qui renverra toujours -1 et nil comme une erreur, c'est-√†-dire un tel NegativeReader. Lan√ßons-le et voyons ce qui se passe: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7n/3h/l-/7n3hl-2vdvmgvmw80eljlorapiw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous le savez, la panique sans raison est un signe de folie. Mais qui dans ce cas est idiot - moi ou octet.Buffer - d√©pend du point de vue. Ceux qui √©crivent ce paquet et qui le suivent ont des points de vue diff√©rents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que s'est-il pass√© ici? Bytes.Buffer a accept√© un nombre n√©gatif d'octets, n'a pas v√©rifi√© qu'il √©tait n√©gatif et a essay√© de couper le tampon interne le long de la limite sup√©rieure, qu'il a re√ßu - et nous sommes sortis des limites de tranche.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a deux probl√®mes dans cet exemple. La premi√®re est que la signature n'est pas interdite de renvoyer des nombres n√©gatifs, et la documentation est interdite. Si la signature avait Uint, nous obtiendrions un d√©bordement classique (lorsqu'un num√©ro sign√© est interpr√©t√© comme non sign√©). Et c'est un bug tr√®s d√©licat, qui se produira certainement vendredi soir, lorsque vous serez d√©j√† assembl√© √† la maison. Par cons√©quent, la panique dans ce cas est l'option pr√©f√©r√©e.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxi√®me ¬´point¬ª est que la trace de la pile ne comprend pas du tout ce qui s'est pass√©. Il est clair que nous avons d√©pass√© les limites de la tranche - alors quoi? Lorsque vous disposez d'un tel tuyau multicouche et qu'une telle erreur se produit, il n'est pas imm√©diatement clair ce qui s'est pass√©. Le bufio de la biblioth√®que standard ¬´panique¬ª √©galement dans cette situation, mais il le fait plus magnifiquement. Il √©crit imm√©diatement: ¬´J'ai soustrait un nombre n√©gatif d'octets. Je ne ferai rien d'autre - je ne sais pas quoi en faire. "</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et octets. Buffer panique du mieux qu'il peut. </font><font style="vertical-align: inherit;">J'ai post√© un probl√®me √† Golang me demandant d'ajouter une erreur humaine. </font><font style="vertical-align: inherit;">Le troisi√®me jour, nous avons discut√© des perspectives de cette d√©cision. </font><font style="vertical-align: inherit;">La raison en est la suivante: historiquement, il arrivait que diff√©rentes personnes √† diff√©rents moments prenaient diff√©rentes d√©cisions non coordonn√©es. </font><font style="vertical-align: inherit;">Et maintenant, nous avons ce qui suit: dans un cas, nous ne faisons pas du tout confiance √† la mise en ≈ìuvre (nous v√©rifions tout), et dans l'autre, nous faisons enti√®rement confiance, nous n'obtenons pas ce qui en d√©coule. </font><font style="vertical-align: inherit;">Il s'agit d'un probl√®me non r√©solu, et nous en parlerons davantage.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader # 1. </font><font style="vertical-align: inherit;">Exemple 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La situation suivante: notre Reader retournera toujours 0 et nil comme r√©sultat. </font><font style="vertical-align: inherit;">Du point de vue des contrats, tout est l√©gal ici - il n'y a pas de probl√®mes. </font><font style="vertical-align: inherit;">Seul b√©mol: la documentation indique que les impl√©mentations ne sont pas recommand√©es pour renvoyer les valeurs 0 et nil, en plus du cas, lorsque la longueur de la tranche envoy√©e est nulle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la vraie vie, un tel lecteur peut causer beaucoup de probl√®mes. </font><font style="vertical-align: inherit;">Donc, revenons √† la question, faut-il faire confiance √† Reader? </font><font style="vertical-align: inherit;">Par exemple, une v√©rification est int√©gr√©e √† bufio: elle lit s√©quentiellement Reader exactement 100 fois - si une telle paire de valeurs est retourn√©e 100 fois, elle renvoie simplement NoProgress. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a rien de tel dans bytes.Buffer. </font><font style="vertical-align: inherit;">Si nous ex√©cutons cet exemple, nous obtenons juste une boucle sans fin (ReadAll utilise bytes.Buffer sous le capot, pas Reader lui-m√™me):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xh/br/zu/xhbrzuvnof4dxubt2d26i6q4l_q.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader # 1. </font><font style="vertical-align: inherit;">Exemple 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre exemple. </font><font style="vertical-align: inherit;">Il est √©galement assez synth√©tique, mais utile √† la compr√©hension: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/pe/xp/gapexpzfyhd6za09ss_uuwbrmlk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ici, nous renvoyons toujours 1 et nil. </font><font style="vertical-align: inherit;">Il semblerait qu'il n'y ait pas de probl√®me ici non plus - tout est l√©gal du point de vue du contrat. </font><font style="vertical-align: inherit;">Il y a une nuance: si j'ex√©cute cet exemple sur mon ordinateur, il se fige apr√®s 30 secondes ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela est d√ª au fait que le client qui lit ce Reader (c'est-√†-dire octets.Buffer) ne re√ßoit jamais un signe de la fin des donn√©es - il lit, soustrait ... De plus, il obtient un octet soustrait √† chaque fois. </font><font style="vertical-align: inherit;">Pour lui, cela signifie qu'√† un moment donn√©, le tampon repositionn√© se termine, il s'ex√©cute toujours - la situation se r√©p√®te et il s'ex√©cute √† l'infini jusqu'√† ce qu'il √©clate.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Lecteur # 2. </font><font style="vertical-align: inherit;">Retour d'erreur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous arrivons √† la deuxi√®me r√®gle importante pour la mise en ≈ìuvre de l'interface Reader - il s'agit d'un retour d'erreur. </font><font style="vertical-align: inherit;">La documentation indique trois erreurs que l'impl√©mentation doit renvoyer. </font><font style="vertical-align: inherit;">Le plus important d'entre eux est l'EOF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EOF est le signe m√™me de la fin des donn√©es, que l'impl√©mentation doit retourner chaque fois qu'il manque de donn√©es. </font><font style="vertical-align: inherit;">Sur le plan conceptuel, il ne s'agit pas, en g√©n√©ral, d'une erreur, mais d'une erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a une autre erreur appel√©e UnexpectedEOF. </font><font style="vertical-align: inherit;">Si soudainement, pendant la lecture, Reader ne peut plus lire les donn√©es, on pensait que cela retournerait UneattenduEOF. </font><font style="vertical-align: inherit;">Mais en fait, cette erreur n'est utilis√©e qu'√† un seul endroit de la biblioth√®que standard - dans la fonction ReadAtLeast.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-c/og/la/-coglawtrylyakbq0kxlc0ob9rs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre erreur est NoProgress, dont nous avons d√©j√† parl√©. </font><font style="vertical-align: inherit;">La documentation le dit: c'est un signe que l'interface est impl√©ment√©e, c'est nul.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lecteur n ¬∞ 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La documentation stipule un ensemble de cas sur la fa√ßon de renvoyer correctement l'erreur. </font><font style="vertical-align: inherit;">Ci-dessous, vous pouvez voir trois cas possibles: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m1/ef/si/m1efsipabh8oypgch-7_ni2syc8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons renvoyer une erreur √† la fois avec le nombre d'octets soustraits et s√©par√©ment. </font><font style="vertical-align: inherit;">Mais si tout d'un coup vos donn√©es s'√©puisent dans votre Reader et que vous ne pouvez pas retourner le EOF [signe de fin] pour le moment (de nombreuses impl√©mentations de la biblioth√®que standard fonctionnent exactement comme √ßa), alors on suppose que vous retournerez EOF au prochain appel cons√©cutif (c'est-√†-dire, vous devez laisser aller client). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le client, cela signifie qu'il n'y a plus de donn√©es - ne me revenez plus. </font><font style="vertical-align: inherit;">Si vous retournez z√©ro et que le client a besoin de donn√©es, il devrait revenir vers vous.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Reader. </font><font style="vertical-align: inherit;">Erreurs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, selon Reader, ce sont les principales r√®gles importantes. </font><font style="vertical-align: inherit;">Il existe encore un ensemble de petits, mais ils ne sont pas si importants et ne conduisent pas √† une telle situation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xv/iu/az/xviuazv5segzzd5ganrbinp8xli.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de passer en revue tout ce qui concerne Reader, nous devons r√©pondre √† la question: est-ce important, des erreurs se produisent-elles souvent dans les impl√©mentations personnalis√©es? </font><font style="vertical-align: inherit;">Pour r√©pondre √† cette question, je me suis tourn√© vers mon spool pour 1000 r√©f√©rentiels (et l√†, nous avons obtenu environ 550 impl√©mentations personnalis√©es). </font><font style="vertical-align: inherit;">J'ai regard√© √† travers les cent premiers avec mes yeux. </font><font style="vertical-align: inherit;">Bien s√ªr, ce n'est pas une super-analyse, mais ce que c'est ... J'ai </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
identifi√© les deux erreurs les plus courantes:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne renvoie jamais EOF;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trop de confiance dans le Reader encapsul√©.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encore une fois, c'est un probl√®me de mon point de vue. </font><font style="vertical-align: inherit;">Et pour ceux qui regardent le package io, ce n'est pas un probl√®me. </font><font style="vertical-align: inherit;">Nous en reparlerons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je voudrais revenir sur une nuance. </font><font style="vertical-align: inherit;">Voir: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/te/3h/9q/te3h9q46okeg22rijrfyxrmi4da.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le client ne doit jamais interpr√©ter la paire 0 et nil comme EOF. </font><font style="vertical-align: inherit;">C'est une erreur! </font><font style="vertical-align: inherit;">Pour Reader, cette valeur n'est qu'une opportunit√© de laisser aller le client. </font><font style="vertical-align: inherit;">Donc, les deux erreurs que j'ai mentionn√©es semblent insignifiantes, mais il suffit d'imaginer que vous avez un pipeline multicouche dans la prod et un petit "bagul" sournois gliss√© au milieu, alors le "coup souterrain" ne prendra pas longtemps - c'est garanti! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon Reader, pratiquement tout. </font><font style="vertical-align: inherit;">Telles √©taient les r√®gles de mise en ≈ìuvre de base.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io.Writer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä l'autre bout des pipelines, nous avons io.Writer, qui est l'endroit o√π nous √©crivons habituellement les donn√©es. </font><font style="vertical-align: inherit;">Une interface tr√®s similaire: elle se compose √©galement d'une m√©thode (Write), leur signature est similaire. </font><font style="vertical-align: inherit;">Du point de vue de la s√©mantique, l'interface Writer est plus compr√©hensible: je dirais que telle qu'elle est entendue, elle est √©crite. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fq/ya/ls/fqyalshoz2lwp48cs5u8oa9ymdk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode Write prend un octet de tranche et l'√©crit dans son int√©gralit√©. </font><font style="vertical-align: inherit;">Il a √©galement un ensemble de r√®gles qui doivent √™tre suivies.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le premier concerne le nombre d'octets renvoy√©s √©crits. </font><font style="vertical-align: inherit;">Je dirais que ce n'est pas si strict, parce que je n'ai pas trouv√© un seul exemple o√π cela conduirait √† des cons√©quences critiques - par exemple, √† la panique. </font><font style="vertical-align: inherit;">Ce n'est pas tr√®s strict car il y a la r√®gle suivante ...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'impl√©mentation Writer est requise pour renvoyer une erreur lorsque la quantit√© de donn√©es √©crites est inf√©rieure √† ce qui a √©t√© envoy√©. </font><font style="vertical-align: inherit;">Autrement dit, l'enregistrement partiel n'est pas pris en charge. </font><font style="vertical-align: inherit;">Cela signifie qu'il n'est pas tr√®s important de savoir combien d'octets ont √©t√© √©crits.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une r√®gle de plus: Writer ne doit en aucun cas modifier la tranche envoy√©e, car le client continuera de travailler avec cette tranche.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Writer ne doit pas contenir cette tranche (Reader a la m√™me r√®gle). </font><font style="vertical-align: inherit;">Si vous avez besoin de donn√©es dans votre impl√©mentation pour certaines op√©rations, il vous suffit de copier cette diapositive, et c'est tout.</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iy/tx/qe/iytxqemg1nabcwxyfzxtgszmjxy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par Reader et Writer, c'est tout.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dendrogramme</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Surtout pour ce rapport, j'ai g√©n√©r√© un graphe d'impl√©mentation et l'ai con√ßu sous forme de dendrogramme. </font><font style="vertical-align: inherit;">Ceux qui veulent en ce moment peuvent suivre ce code QR: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/zp/pq/r2zppqu-0snqu80oqyxxpxakkpc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce dendrogramme a toutes les impl√©mentations de toutes les interfaces du paquet io. </font><font style="vertical-align: inherit;">Ce dendrogramme est n√©cessaire pour comprendre simplement: quoi et avec quoi vous pouvez rester ensemble dans les pipelines, o√π et ce que vous pouvez lire, o√π vous pouvez √©crire. </font><font style="vertical-align: inherit;">Je vais toujours y faire r√©f√©rence au cours de mon rapport, veuillez donc vous r√©f√©rer au code QR.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pipelines</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons parl√© de ce qu'est Reader, io.Writer. Parlons maintenant de l'API qui existe dans la biblioth√®que standard pour la construction de pipelines. Commen√ßons par les bases. Peut-√™tre que cela ne sera m√™me int√©ressant pour personne. Cependant, c'est tr√®s important. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous lirons les donn√©es du flux d'entr√©e standard (de Stdin): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/tq/4m/zqtq4mfocqntafmpk5m_scirhcm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stdin est repr√©sent√© dans Go par une variable globale de type file du package os. Si vous regardez le dendrogramme, vous remarquerez que le type de fichier impl√©mente √©galement les interfaces Reader et Writer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ce moment, nous sommes int√©ress√©s par Reader. Nous lirons Stdin en utilisant le m√™me assistant ReadAll que nous avons d√©j√† utilis√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une nuance concernant cet assistant m√©rite d'√™tre not√©e: ReadAll lit Reader jusqu'√† la fin, mais il d√©termine la fin par EOF, selon le signe de la fin dont nous avons parl√©. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons maintenant limiter la quantit√© de donn√©es que nous lisons depuis Stdin. Pour ce faire, il existe une impl√©mentation de LimitedReader dans la biblioth√®que standard: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qq/dm/hn/qqdmhnj73dfyxpdlrpoffwzimgq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
je voudrais que vous fassiez attention √† la fa√ßon dont LimitedReader limite le nombre d'octets √† lire. On pourrait penser que cette impl√©mentation, ce Wrapper, soustrait tout ce qui se trouve dans le Reader, qu'il enveloppe, puis donne autant que nous voulons. Mais tout fonctionne un peu diff√©remment ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LimitedReader coupe la tranche qui lui est donn√©e comme argument le long de la limite sup√©rieure. </font><font style="vertical-align: inherit;">Et il passe cette tranche recadr√©e √† Reader, qui l'enveloppe. </font><font style="vertical-align: inherit;">Il s'agit d'une d√©monstration claire de la fa√ßon dont la longueur des donn√©es lues est r√©gul√©e dans les impl√©mentations de l'interface io.Reader.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erreur de retour de fin de fichier</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autre point int√©ressant: notez comment cette impl√©mentation renvoie une erreur EOF! </font><font style="vertical-align: inherit;">Les valeurs nomm√©es renvoy√©es sont utilis√©es ici, et elles sont affect√©es par les valeurs que nous obtenons du Reader encapsul√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et s'il arrive qu'il y ait plus de donn√©es dans le lecteur encapsul√© que nous n'en avons besoin, nous attribuons les valeurs du lecteur encapsul√© - disons, 10 octets et z√©ro - car il y a encore des donn√©es dans le lecteur encapsul√©. </font><font style="vertical-align: inherit;">Mais la variable n, qui diminue (dans l'avant-derni√®re ligne), dit que nous avons atteint le ¬´bas¬ª - la fin de ce dont nous avons besoin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la prochaine it√©ration, le client devrait revenir - √† la premi√®re condition, il recevra EOF. </font><font style="vertical-align: inherit;">C'est le cas que j'ai mentionn√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A suivre tr√®s prochainement ...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/kuyjuGk1USY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un peu de publicit√© :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci de rester avec nous. Aimez-vous nos articles? Vous voulez voir des mat√©riaux plus int√©ressants? Soutenez-nous en passant une commande ou en recommandant √† vos amis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des VPS bas√©s sur le cloud pour les d√©veloppeurs √† partir de 4,99 $</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analogue unique de serveurs d'entr√©e de gamme que nous avons invent√©s pour vous: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toute la v√©rit√© sur les VPS (KVM) E5-2697 v3 (6 c≈ìurs) 10 Go DDR4 480 Go SSD 1 Gbit / s √† partir de 19 $ ou comment diviser le serveur?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (les options sont disponibles avec RAID1 et RAID10, jusqu'√† 24 c≈ìurs et jusqu'√† 40 Go de DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 fois moins cher au centre de donn√©es Equinix Tier IV √† Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous avons seulement </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV √† partir de 199 $</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aux Pays-Bas!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - √† partir de 99 $! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur la</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cr√©ation d'un b√¢timent d'infrastructure. </font><font style="vertical-align: inherit;">classe c utilisant des serveurs Dell R730xd E5-2650 v4 co√ªtant 9 000 euros pour un sou?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491462/index.html">Week-end lu: 12 podcasts, stations de radio FM de l'√®re du coucher du soleil et applications de m√©ditation</a></li>
<li><a href="../fr491476/index.html">Acc√©l√©rom√®tres, magn√©tom√®tres et angles d'orientation MEMS</a></li>
<li><a href="../fr491478/index.html">Un nouvel implant pour les aveugles se connecte directement au cerveau</a></li>
<li><a href="../fr491480/index.html">Projet CoVirus MVP - une carte en ligne de l'infection √† coronavirus ou un ¬´bouton rouge¬ª dans votre main</a></li>
<li><a href="../fr491482/index.html">Pr√©sentation de PowerShell 7.0</a></li>
<li><a href="../fr491486/index.html">Script personnalis√© lors de la fermeture du couvercle de l'ordinateur portable et du verrouillage de l'√©cran sans sommeil</a></li>
<li><a href="../fr491488/index.html">Que signifie √™tre agile?</a></li>
<li><a href="../fr491490/index.html">Comment Gitlab-CI h√©rite-t-il des variables d'environnement?</a></li>
<li><a href="../fr491494/index.html">L'arnaque grandiose de la science sovi√©tique: pourquoi un vaisseau orbital r√©utilisable s'est av√©r√© √™tre une fois</a></li>
<li><a href="../fr491496/index.html">Conseils et astuces IntelliJ IDEA: 1. Comparaison de fichiers et de dossiers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>