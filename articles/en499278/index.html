<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì∑ ü§≥ ‚≠êÔ∏è Brotli Efficiency in the Real World üè® üåÜ üìá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the most fundamental rules for developing fast websites is to optimize their resources. If we are talking about text resources - about code wri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Brotli Efficiency in the Real World</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/499278/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of the most fundamental rules for developing fast websites is to optimize their resources. If we are talking about text resources - about code written in HTML, CSS and JavaScript, this means that we are talking about data compression. </font><font style="vertical-align: inherit;">
The de facto standard for compressing text resources on the web is the Gzip method. Namely, about 80% of the compressed resources obtained during site downloads are compressed using Gzip. To compress the remaining 20% ‚Äã‚Äãof the resources, a much newer algorithm is used - Brotli.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/f1/0c/go/f10cgoennqxp98xrt8hxus_wkii.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, these 100% of the compressed resources that come into browsers when they receive answers to requests to sites do not include absolutely all resources. There are still many resources that could be compressed, or that could be compressed. But these resources remain uncompressed. More detailed metrics regarding compression can be found in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://almanac."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compression</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section of the </font><font style="vertical-align: inherit;">Web Almanac resource. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The gzip compression method is incredibly efficient. All Shakespeare's work in plain text takes 5.3 MB. And after Gzip-compression (compression level 6) they occupy only 1.9 MB. This means that the file size in which this data is stored has decreased by 2.8 times. At the same time, data is not lost during compression. Great!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even better, the degree of Gzip compression is affected by the presence of duplicate lines in files. The more repetitions in the text, the more efficient the compression. This is very good for the web, since the code written in HTML, CSS and JS has a uniform syntax and contains many repetitions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But, although Gzip is a very efficient compression method, it is also quite old. It appeared in 1992 (which, of course, helps explain its widespread prevalence). After 21 years, in 2013, Google released Brotli, a new algorithm that promises even higher levels of compression than those that the Gzip method is capable of. The same works of Shakespeare 5.2 MB in size are compressed using Brotli to a size of 1.7 MB (with a compression level of 6). And this already means a 3.1-fold reduction in file size. This is even better than using Gzip.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to evaluate the level of data compression using Gzip and Brotli, you are likely to find out that when compressing some data, Brotli is much more efficient than Gzip. </font><font style="vertical-align: inherit;">For example, ReactDOM data is 27% smaller when compressed using Brotli with a maximum compression level (11) than when using Gzip with a maximum compression level (9). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is a comparison of Brotli compression with Gzip compression when processing ReactDOM.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compression level</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Size (in bytes)</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compression Efficiency (Compared to Uncompressed Data)</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% Improvement over Gzip</font></font></strong></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">43456</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.73</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">39898</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.97</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eleven%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">39416</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.08</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fifteen%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">38488</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.08</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fifteen%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">36323</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.27</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nineteen%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">36048</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.29</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">twenty%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">35804</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.31</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">twenty%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">35709</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.32</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">35659</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.33</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">33590</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.53</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">25%</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eleven</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">33036</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.59</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">27%</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, at all compression levels Brotli bypasses Gzip. At the maximum compression level available with Brotli, it is 27% more efficient than Gzip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And, based on personal observation, I note that the transition of one of my clients from Gzip to Brotli led to a median reduction in file sizes by 31%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, over the past few years, I, along with other performance experts, have been encouraging customers to switch from Gzip to Brotli.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will say a few words about browser support for Gzip and Brotli. Gzip is so widespread that CanIUse doesn't even display a table with support information. It says so: "This HTTP header is supported in almost all browsers (starting with IE6 +, Firefox 2+, Chrome 1+, and so on)." And Brotli, while writing this material, enjoys a very pleasant level of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at 93.17%. And this is very, very much! Thus, if your site has at least some significant size, you may not particularly like the return of uncompressed resources to more than 6% of your users. But using Brotli, you won‚Äôt lose anything. Customers use a progressive model of support for new algorithms, so users who cannot accept Brotli resources will simply use the fallback option in the form of Gzip. We will talk more about this below.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, especially if you use CDN, turning on Brotli is a matter of seconds. </font><font style="vertical-align: inherit;">At least this is the case with Cloudflare, the service I use for the CSS Wizardry site. </font><font style="vertical-align: inherit;">However, many of my clients, if we talk about the last couple of years, are not so successful. </font><font style="vertical-align: inherit;">Some of them support their own infrastructure, and practice shows that installing and deploying Brotli is not so simple. </font><font style="vertical-align: inherit;">Some use CDN services that do not differ in easily accessible capabilities to support the new algorithm. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In those cases when we could not switch to Brotli, we always had an unanswered question: "What if ...". </font><font style="vertical-align: inherit;">As a result, I finally decided to arm myself with numbers and give an answer to the question of what gives the site the transition to Brotli.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Less is not necessarily faster.</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually ‚Äúless‚Äù, however, means ‚Äúfaster.‚Äù </font><font style="vertical-align: inherit;">As a rule, if you reduce the file size, it will be transferred faster from the server to the client. </font><font style="vertical-align: inherit;">But if you make a file, say, 20% smaller, this does not mean that it will arrive 20% faster. </font><font style="vertical-align: inherit;">The point here is that file size is just one aspect of web performance. </font><font style="vertical-align: inherit;">And whatever the size of the file, the resource delivered to the browser is associated with many other factors and with many system limitations ‚Äî network delays, packet loss, and the like. </font><font style="vertical-align: inherit;">In other words, saving on file size helps to transfer the same data as before, sending fewer packets, but the data transfer between the server and the client is limited by network delays, as a result, the speed with which packets arriving at the client will be smaller will not change.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP, packets, round-trip delay</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If it‚Äôs very simplistic to consider transferring files from the server to the client, we will have to take a look at the TCP protocol. When we receive a file from the server, it does not come to us in one go. The TCP protocol, on top of which HTTP works, breaks the files into segments called packets. These packets are sent to the client in order, in sequence. The client confirms the receipt of each packet in the series before starting the transfer of the next series. This happens until the client collects all the necessary packages, until there are no unsent packages on the server, and until the client can collect the packages into something that can be recognized as a file. In order for the packet sequence transfer session to complete successfully, the server must send them to the client, and the client must acknowledge their receipt. Time,The amount of data required to receive data and receive confirmation of reception is called Round Trip Time (RTT).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each new TCP connection cannot know what the available bandwidth is, and how reliable the connection is (that is, what is the level of packet loss). If the server tries to send megabytes of data over a connection that supports a data transfer rate of one megabit per second, such a transfer will overwhelm the connection and lead to an overload of the communication channel. And vice versa - if the server tries to transfer a small amount of data through a very fast connection, the connection will be used inefficiently, it will be idle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to solve this puzzle, TCP uses a mechanism called slow start. </font><font style="vertical-align: inherit;">This is part of the overload window management strategy. </font><font style="vertical-align: inherit;">Each new TCP connection is limited by the ability to send only 10 data packets in the first sequence of packets (10 packets - the size of the initial congestion window). </font><font style="vertical-align: inherit;">Ten TCP segments are approximately 14 KB of data. </font><font style="vertical-align: inherit;">If these packages are successfully received by the client, the second series will already contain 20 packages, then there will be 40, 80, 160 and so on. </font><font style="vertical-align: inherit;">The exponential growth of packets in sequences will continue until one of the following events occurs:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The system will face packet loss. </font><font style="vertical-align: inherit;">At this point, the server will reduce the number of packets in the following sequence, dividing the previous number of packets by 2, and try to transfer the data again.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have reached the limit of available bandwidth and can use it at full capacity.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This simple and elegant strategy allows you to balance on the verge of caution and optimism. </font><font style="vertical-align: inherit;">It applies to every new TCP connection established by the web application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In simple words, the initial size of the congestion window of the new TCP connection is only about 14 Kb. </font><font style="vertical-align: inherit;">Or about 11.8% of uncompressed ReactDOM data. </font><font style="vertical-align: inherit;">Either 36.94% of the data compressed using Gzip, or 42.38% of the data compressed using Brotli (at the maximum compression level). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And then we‚Äôll slow down. </font><font style="vertical-align: inherit;">The transition from 11.8% to 36.94% is already a very noticeable improvement! </font><font style="vertical-align: inherit;">But the transition from 36.94% to 42.38% - this is far from so impressive. </font><font style="vertical-align: inherit;">What's happening?</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Session Number</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The amount of data transferred in one session, Kb</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cumulative amount of data transferred, Kb</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sequence in which the ReactDOM data is transferred</font></font></strong></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">14</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">14</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">42</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gzip (37.904 Kb), Brotli (33.036 Kb)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">56</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">98</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">112</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">210</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uncompressed option (118.656 Kb)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">224</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">434</font></font></td>
<td></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that both data compressed with Gzip and data compressed with Brotli are transmitted in the same series of packets. </font><font style="vertical-align: inherit;">Transferring a file takes two sequences. </font><font style="vertical-align: inherit;">If the RTT turns out to be fairly uniform when transmitting all the sequences, this means that it takes the same time to transmit data compressed using Gzip and Brotli. </font><font style="vertical-align: inherit;">On the other hand, transferring an uncompressed version of data requires four series of packets, not two. </font><font style="vertical-align: inherit;">And this, especially on connections with high network latencies, can result in a rather noticeable time required for data transfer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I tend here to the fact that data transfer speed depends not only on file sizes. It is influenced by the features of the functioning of the TCP protocol. We do not just need to make the files smaller. We need to make them much smaller, bringing them to a size that will allow them to be transmitted in fewer packet sequences. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means, in theory, that in order for the Brotli algorithm to be noticeably more efficient than Gzip, it must be able to compress data much more aggressively. This is necessary so that data can be transmitted in fewer packet sequences than when using Gzip. And I don‚Äôt know how this algorithm will develop ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth noting that the above model is quite simplified. There are many other factors to consider. For example - is it a new or already open TCP connection? Is the connection being used for something else? Are server traffic prioritization mechanisms stopping and starting data transfer? Does H / 2 streams have exclusive access to bandwidth? This section is a more serious study. It should be considered as a good starting point for your own research. But consider thoroughly analyzing the data using something like Wireshark, and read </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> material, which provides a deeper description of the ‚Äúmagic‚Äù first 14 Kb.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The above applies only to brand new TCP connections. </font><font style="vertical-align: inherit;">Files transferred over an existing connection will not go through the slow start procedure. </font><font style="vertical-align: inherit;">This leads us to two important conclusions:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I don‚Äôt think it‚Äôs worth repeating, but I will repeat: static resources need to be hosted. </font><font style="vertical-align: inherit;">This is a great way to avoid slow-start delays, since using your own, already ‚Äúwarmed up‚Äù server means that packets leaving this server have access to a wider bandwidth. </font><font style="vertical-align: inherit;">This conclusion leads me to the second conclusion.</font></font></li>
<li> ,              ,    .       ,            .    .</li>
</ol><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong>   </strong></td>
<td><strong> ,    , </strong></td>
<td><strong>   , </strong></td>
</tr>
<tr>
<td>1</td>
<td>14</td>
<td>14</td>
</tr>
<tr>
<td>2</td>
<td>28</td>
<td>42</td>
</tr>
<tr>
<td>3</td>
<td>56</td>
<td>98</td>
</tr>
<tr>
<td>4</td>
<td>112</td>
<td>210</td>
</tr>
<tr>
<td>5</td>
<td>224</td>
<td>434</td>
</tr>
<tr>
<td>6</td>
<td>448</td>
<td>882</td>
</tr>
<tr>
<td>7</td>
<td>896</td>
<td>1778</td>
</tr>
<tr>
<td>8</td>
<td>1792</td>
<td>3570</td>
</tr>
<tr>
<td>9</td>
<td>3584</td>
<td>7154</td>
</tr>
<tr>
<td>10</td>
<td>7168</td>
<td>14322</td>
</tr>
<tr>
<td>‚Ä¶</td>
<td>‚Ä¶</td>
<td>‚Ä¶</td>
</tr>
<tr>
<td>20</td>
<td>7340032</td>
<td>14680050</td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the end of the 10th data transfer session, the amount of data transferred in one session is 7168 Kb, while, in total, 14322 Kb of data has already been transferred. </font><font style="vertical-align: inherit;">This is more than enough for ordinary work on the Internet (that is, not for viewing the Game of Thrones). </font><font style="vertical-align: inherit;">In fact, it usually happens that we load the entire web page and all its resources without even reaching the limit of our bandwidth. </font><font style="vertical-align: inherit;">In other words, using a 1 Gbit / s fiber optic communication channel (that is, 0.125 GB / s) will not make normal browsing seem much faster than using a slower connection, since most of this channel does not even will be used.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And by the 20th data transfer session, we theoretically transfer 7.34 GB of data in one sequence of packets.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What about the real world?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far, we have been engaged in theoretical considerations. </font><font style="vertical-align: inherit;">And I started working on this material due to the fact that I would like to know about the impact that Brotli can have on real sites. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far, the numbers given here have pointed to the huge difference between the lack of compression and the use of Gzip, and the fact that the gain from using Brotli, compared to Gzip, is quite modest. </font><font style="vertical-align: inherit;">This tells us that the transition from the lack of compression to the use of Gzip will give a noticeable improvement, while the transition from Gzip to Brotli may probably look much less impressive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I selected, as examples, several sites, guided by the following considerations:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The site should be relatively well-known (it is better to use sites that can be compared with something).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The site should be suitable for the test. </font><font style="vertical-align: inherit;">That is - it should be of a suitable size (so it will be more interesting to analyze its materials for compression), and at the same time it should not contain mainly materials that are not compressed using Gzip / Brotli - like, for example, YouTube.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not all sites from the collection should belong to large corporations (it is worth analyzing some, let's say, ‚Äúregular‚Äù sites).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Given these requirements, I </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selected the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sites listed below and started testing. </font><font style="vertical-align: inherit;">Here are the sites I selected:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m.facebook.com</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.linkedin.com</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.insider.com</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yandex.com</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.esedirect.co.uk</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.story.one</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.cdm-bedrijfskleding.nl</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.everlane.com</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did not want to complicate the tests, so I settled on the following indicators:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The amount of data transferred.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First contentful paint (FCP) time.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They were analyzed in the following situations:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lack of compression.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using gzip.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using brotli.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The FCP metric looks close to the real world and universal enough for its application to any site, since it allows you to evaluate what people need from websites - that is, the contents of these sites. </font><font style="vertical-align: inherit;">In addition, I chose this metric because </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paul Calvano</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , an intelligent person, said this: ‚ÄúExperience tells me that using Brotli leads to improved FCP, especially when critical CSS / JS resources are large‚Äù .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll tell you one dirty secret. Many studies of web performance (not all, but many) are not based on research on performance improvements, but on drawing conclusions from the opposite - from performance degradation. For example, the BBC is much easier to claim that ‚Äúthey lose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10% of users</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for every extra second they need to load their site‚Äù than to figure out what‚Äôs happening thanks to a one-second improvement. It‚Äôs much easier to slow down the site rather than speed it up, and you get the feeling that this is why many people do this job so well.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Given this, I did not try to first download sites that use Gzip, and then, offline, somehow compress their contents using Brotli. </font><font style="vertical-align: inherit;">Instead, I found sites that use Brotli, and then turned off compression. </font><font style="vertical-align: inherit;">I went from Brotli to Gzip, and then from Gzip to non-compression, measuring how this works on the site. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although I cannot, say, connect to the Linkedin server and disconnect Brotli, I can simply access this site from a browser that does not support Brotli. </font><font style="vertical-align: inherit;">Although I am not able to disable Brotli support in Chrome, I am able to hide from the server the fact that my browser supports Brotli. </font><font style="vertical-align: inherit;">Browsers tell servers which compression algorithms they support using the request header</font></font><code>content-encoding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Using Webpagetest, I can customize the headers myself. </font><font style="vertical-align: inherit;">So, everything is very simple!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3bb/295/390/3bb2953909f7cea0ac8970049f763638.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The advanced features of WebPageTest allow us to set custom request headers.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Here's how I set up the Custom Headers field:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Complete shutdown of compression: </font></font><code>accept-encoding: randomstring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disabling Brotli, but Gzip support: </font></font><code>accept-encoding: gzip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To use Brotli if this compression method is supported by the site (and provided that it is supported by the browser): the field remains empty.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can find out if this works as intended by checking the presence (or absence) of the header </font></font><code>content-encoding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the server response.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">results</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As expected, the transition from lack of compression to Gzip meant a significant improvement, but the transition from Gzip to Brotli does not look so impressive. </font><font style="vertical-align: inherit;">The raw data from my experiments can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The following are the findings that interest me the most:</font></font><br>
<br>
<ul>
<li>     Gzip     : 73%.</li>
<li>  FCP   Gzip     : 23.305%.</li>
<li>     Brotli    Gzip: 5.767%.</li>
<li>  FCP   Brotli    Gzip: 3.462%.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are all median values. </font><font style="vertical-align: inherit;">Speaking of ‚Äúmaterial sizes,‚Äù I mean only HTML, CSS, and JavaScript. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to the use of Gzip, file sizes were reduced by 73% compared to their uncompressed versions. </font><font style="vertical-align: inherit;">And the use of Brotli allowed to reduce file sizes only by an additional 5.7%. </font><font style="vertical-align: inherit;">If we talk about FCP, thanks to Gzip this indicator improved by 23% compared to the lack of compression, and Brotli added only an additional 3.5% to this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although it seems that such results reinforce the theory, there are several ways to improve these results. </font><font style="vertical-align: inherit;">The first is to test a much larger number of sites, I would like to discuss two more in more detail.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Own resource data and data from external sources</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my tests, I turned off Brotli everywhere, and not just for servers that store site data. </font><font style="vertical-align: inherit;">This means that I measured not only the benefits that sites get from using Brotli, but, in terms of potential, the benefits that Brotli gets from the external sources that these sites use. </font><font style="vertical-align: inherit;">This falls into the scope of our interests only if third-party resources are used in the critical ways of the sites under investigation, but this is worth remembering.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compression levels</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Speaking of compression, we often discuss the results obtained with the best compression application scenario. Namely - when using Gzip we have in mind the 9th level of compression, and when using Brotli - 11th level. However, it is unlikely that the server under investigation will be configured in the most optimal way. For example, Apache uses level 6 gzip compression, while NGINX uses only the first. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Disabling Brotli means that we are switching to the fallback option, to Gzip, and given the way I tested the sites, I could not change such a fallback configuration or act on it somehow. I say this because the materials of the two sites in the test actually increased in size when Brotli was turned on. This indicates to me that the level of Gzip compression was such that it provided stronger compression than the level of Brotli compression.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Choosing a compression level is a compromise. </font><font style="vertical-align: inherit;">Everyone would like to ask the highest level of compression and on this consider the issue resolved. </font><font style="vertical-align: inherit;">But such an approach is impractical. </font><font style="vertical-align: inherit;">The fact is that the extra time that the server will need to dynamically perform this compression is very likely to negate the benefits of a higher compression level. </font><font style="vertical-align: inherit;">In order to cope with this problem, you can resort to the following:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can use a pragmatic level of compression that provides the right balance of speed and efficiency during dynamic data compression.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can upload pre-compressed static resources to the server, the compression level of which is higher than that used for dynamic compression. </font><font style="vertical-align: inherit;">In this case, to select the level of dynamic compression, you can use the idea described in the first paragraph.</font></font></li>
</ol><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One gets the impression that, reasoning sensibly, one can recognize the insignificance of Brotli's advantages over Gzip. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If enabling Brotli support is a matter of a couple of mouse movements in the control panel of your CDN, then you should take Brotli and turn it on right now. Support for this compression algorithm is wide enough, browsers that do not support Brotli easily switch to spare mechanisms, and even a slight improvement is better than nothing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If possible, upload static resources pre-compressed at the maximum compression level to the servers. And for dynamic compression, use not the highest, but not the lowest compression levels. If you use NGINX, make sure that you are not using the standard first level of compression for NGINX.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, if in order to use Brotli, you may need weeks of development, testing and deployment, do not panic - just make sure to use Gzip compression for everything that can be compressed (this includes, in addition to text resources, files .ico and .ttf - if they are, of course, used in your project). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I suppose a short version of this article might look like this: if you should not or cannot enable Brotli, you are not losing so much. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dear readers! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do you plan to use Brotli?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499254/index.html">PyConRu 2020 Program Committee Member answers questions about Python: an up-to-date look and a bit of parseltang</a></li>
<li><a href="../en499262/index.html">Final online hackathon for self-employed SMZhack: projects that will hit the people</a></li>
<li><a href="../en499268/index.html">Spatial awareness: what can Hololens glasses do?</a></li>
<li><a href="../en499272/index.html">Soldering components 0201. Nervous, please move away from the screens</a></li>
<li><a href="../en499274/index.html">We disassembled the new Capsule. We know how many microphones and how it works</a></li>
<li><a href="../en499280/index.html">The price of JavaScript frameworks</a></li>
<li><a href="../en499286/index.html">Study: corporate network access trading is growing in the black market</a></li>
<li><a href="../en499288/index.html">All measures to support business in connection with the coronavirus. Part 1</a></li>
<li><a href="../en499290/index.html">How to write a technical standard for information security for a large company</a></li>
<li><a href="../en499296/index.html">English for demo (structure, phrases, Q&A, grammar, tips)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>