<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍✈️ 👩🏼‍🚒 👩🏻‍🤝‍👨🏾 Kafka Streamsを使用したSpring Bootアプリケーション 🚴🏼 🧔 📐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！この記事では、MegaFonがデータ処理をストリーミングする方法を見て、Kafka Streamsを使用して簡単なSpring Bootアプリケーションを開発します。
 
 
 当社には、マイクロサービスアーキテクチャに基づくアプリケーションの研究開発に従事するユニットであるマイ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kafka Streamsを使用したSpring Bootアプリケーション</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/megafon/blog/504422/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font><font style="vertical-align: inherit;">この記事では、MegaFonがデータ処理をストリーミングする方法を見て、Kafka Streamsを使用して簡単なSpring Bootアプリケーションを開発します。</font></font></i><br>
<img src="https://habrastorage.org/webt/ak/bq/-v/akbq-vwtnvfto63yzb4jynsf1x4.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当社には、マイクロサービスアーキテクチャに基づくアプリケーションの研究開発に従事するユニットであるマイクロサービスファクトリ（MFactory）というドメインがあります。マイクロサービスが相互に「通信」するために、メッセージブローカーのRabbitMQとKafkaを使用しますが、このブローカーはストリーミングデータ処理のための非常に強力なツールであるKafka Streamsを実装しているため、本日はKafkaについて詳しく説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データ処理への標準的なアプローチを考えてみましょう。データストリームを取得し、それをデータベースに入れてから、データベースに接続し、データをアップロードして処理します。しかし、データベースをバイパスして、データストリームをリアルタイムで処理することで生産性を向上できるタスクがいくつかあります。それらを解決するために、Kafka Streamsインターフェースを使用します。しかし、最初に、カフカが何であるかを思い出してください。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/l9/s2/3j/l9s23jwtvkt04t52c0_8urvkdmi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kafkaは、分散メッセージングソフトウェアブローカーです。 「分散」とは、ブローカーが複数のサーバーで同時に動作してクラスターを形成できることを意味します。 Kafkaは、メッセージジェネレーター、メッセージコンシューマー、トピックで構成されています。トピックは、着信エントリがファイルの最後に追加されるファイルです。つまり、トピックは時間順のメッセージログです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の問題を考えてください。サブスクライバーの残高の変化に関する情報をJSON形式で取得したデータストリームを取得します-{"phone_number"：number、 "balance"：balance}。トピック "src"に書き込みます。そして、バランスがゼロ以下のメッセージをリアルタイムでフィルタリングする必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gr/se/8d/grse8dacdnkvq-h5-mu2z6uwhd0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、カフカストリームとは何かを検討します。 Apache Kafka Streams APIは、Kafkaクラスターに格納されたデータのリアルタイム処理を可能にするアプリケーションとマイクロサービスを作成するためのクライアントライブラリです。 Kafka Streamsは、標準JavaおよびScalaアプリケーションをクライアント側で簡単に作成およびデプロイできることと、Kafkaサーバークラスターテクノロジーの利点を組み合わせています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/as/q_/-q/asq_-q33-wjdxiyudf8iioa6jrw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kafka Streamsデバイスは、グラフ（処理トポロジ）として表すことができます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トピックにサブスクライブして着信メッセージを読み取る処理ノード。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスロジックを実装する処理ノード。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">処理結果をトピックに送信するハンドラノード。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の問題を想像してみてください。</font><font style="vertical-align: inherit;">{"phone_number"：number、 "balance"：balance}という形式のJSON形式で、加入者の残高の変化に関する情報のストリームを取得し、トピック「src」に書き込みます。</font><font style="vertical-align: inherit;">残高がゼロ以下のメッセージをリアルタイムでフィルタリングし、メッセージデータを処理するためのサービスがサブスクライブされている「out」トピックに結果を書き込む必要があります。</font><font style="vertical-align: inherit;">Kafkaコンソールジェネレーターを使用して同様のストリームをシミュレートします。</font></font><br>
<br>
<pre><code class="java hljs">PS C:\Users\User&gt; cd C:\kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">2.5</span><span class="hljs-number">.0</span>\<font></font>
PS C:\kafka&gt; bin\windows\kafka-topics.bat --create --bootstrap-server localhost:<span class="hljs-number">9092</span> --replication-factor <span class="hljs-number">1</span> --partitions <span class="hljs-number">1</span> --topic src<font></font>
Created topic src.<font></font>
PS C:\kafka&gt; bin\windows\kafka-topics.bat --create --bootstrap-server localhost:<span class="hljs-number">9092</span> --replication-factor <span class="hljs-number">1</span> --partitions <span class="hljs-number">1</span> --topic out<font></font>
Created topic out.<font></font>
PS C:\kafka&gt; bin\windows\kafka-topics.bat --list --bootstrap-server localhost:<span class="hljs-number">9092</span><font></font>
out<font></font>
src<font></font>
PS C:\kafka&gt; bin\windows\kafka-console-producer.bat --bootstrap-server localhost:<span class="hljs-number">9092</span> --topic src<font></font>
&gt;{<span class="hljs-string">"phone_number"</span>:<span class="hljs-number">79301</span>,<span class="hljs-string">"balance"</span>:<span class="hljs-number">100</span>}<font></font>
&gt;{<span class="hljs-string">"phone_number"</span>:<span class="hljs-number">79302</span>,<span class="hljs-string">"balance"</span>:<span class="hljs-number">0</span>}<font></font>
&gt;{<span class="hljs-string">"phone_number"</span>:<span class="hljs-number">79303</span>,<span class="hljs-string">"balance"</span>:-<span class="hljs-number">50</span>}<font></font>
&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、簡単なSpring Bootアプリケーションを開発し、実際のKafka Streamsを見てみましょう。</font><font style="vertical-align: inherit;">まず、次の依存関係を定義します。</font></font><br>
<br>
<pre><code class="java hljs">&lt;dependency&gt;<font></font>
    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;<font></font>
    &lt;artifactId&gt;kafka-streams&lt;/artifactId&gt;<font></font>
&lt;/dependency&gt;<font></font>
&lt;dependency&gt;<font></font>
    &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;<font></font>
    &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;<font></font>
&lt;/dependency&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーオブジェクトを作成します。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> ru.megafon.kafkastreamsdemo.model;<font></font>
<font></font>
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonProperty;
<span class="hljs-keyword">import</span> lombok.Getter;<font></font>
<font></font>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
    <span class="hljs-meta">@JsonProperty("phone_number")</span>
    <span class="hljs-keyword">private</span> Long phoneNumber;
    <span class="hljs-meta">@JsonProperty("balance")</span>
    <span class="hljs-keyword">private</span> Double balance;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションの構成を書いてみましょう：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> ru.megafon.kafkastreamsdemo.config;<font></font>
<font></font>
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.apache.kafka.common.serialization.Serde;
<span class="hljs-keyword">import</span> org.apache.kafka.common.serialization.Serdes;
<span class="hljs-keyword">import</span> org.apache.kafka.streams.StreamsBuilder;
<span class="hljs-keyword">import</span> org.apache.kafka.streams.StreamsConfig;
<span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.Consumed;
<span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.KStream;
<span class="hljs-keyword">import</span> org.apache.kafka.streams.kstream.Produced;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.kafka.annotation.EnableKafka;
<span class="hljs-keyword">import</span> org.springframework.kafka.annotation.EnableKafkaStreams;
<span class="hljs-keyword">import</span> org.springframework.kafka.annotation.KafkaStreamsDefaultConfiguration;
<span class="hljs-keyword">import</span> org.springframework.kafka.config.KafkaStreamsConfiguration;
<span class="hljs-keyword">import</span> org.springframework.kafka.support.serializer.JsonDeserializer;
<span class="hljs-keyword">import</span> org.springframework.kafka.support.serializer.JsonSerializer;
<span class="hljs-keyword">import</span> ru.megafon.kafkastreamsdemo.model.User;<font></font>
<font></font>
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;<font></font>
<font></font>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableKafka</span>
<span class="hljs-meta">@EnableKafkaStreams</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaStreamsConfig</span> </span>{
    <span class="hljs-meta">@Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KafkaStreamsConfiguration <span class="hljs-title">kStreamsConfigs</span><span class="hljs-params">()</span> </span>{<font></font>
        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
        props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="hljs-string">"id"</span>);<font></font>
        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="hljs-string">"localhost:9092"</span>);<font></font>
        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName());<font></font>
        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass().getName());<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KafkaStreamsConfiguration(props);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Serde&lt;User&gt; <span class="hljs-title">userSerde</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> Serdes.serdeFrom(<span class="hljs-keyword">new</span> JsonSerializer&lt;&gt;(), <span class="hljs-keyword">new</span> JsonDeserializer&lt;&gt;(User.class));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KStream&lt;String, User&gt; <span class="hljs-title">kStream</span><span class="hljs-params">(StreamsBuilder kStreamBuilder)</span> </span>{<font></font>
        KStream&lt;String, String&gt; stream = kStreamBuilder<font></font>
                .stream(<span class="hljs-string">"src"</span>, Consumed.with(Serdes.String(), Serdes.String()));<font></font>
        KStream&lt;String, User&gt; userStream = stream<font></font>
                .mapValues(<span class="hljs-keyword">this</span>::getUserFromString)<font></font>
                .filter((key, value) -&gt; value.getBalance() &lt;= <span class="hljs-number">0</span>);<font></font>
        userStream.to(<span class="hljs-string">"out"</span>, Produced.with(Serdes.String(), userSerde()));
        <span class="hljs-keyword">return</span> userStream;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ObjectMapper <span class="hljs-title">objectMapper</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ObjectMapper();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function">User <span class="hljs-title">getUserFromString</span><span class="hljs-params">(String userString)</span> </span>{<font></font>
        User user = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> {<font></font>
            user = objectMapper().readValue(userString, User.class);<font></font>
        } <span class="hljs-keyword">catch</span> (JsonProcessingException e) {<font></font>
            log.error(e.getMessage(), e);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> user;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各メソッドをさらに詳しく検討してみましょう</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。kStreamsConfigsメソッドでは、アプリケーションをKafkaサーバーに接続するための最小構成を作成します。アプリケーションの識別子とブローカーサーバーのアドレス、デフォルトのシリアライザー/デシリアライザーを設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
userSerdeメソッドでは、Userモデルに独自のシリアライザー/デシリアライザーを定義しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kStreamメソッドでは、Kafka Streamsアプリケーションのトポロジを作成し、KStream &lt;String、User&gt;オブジェクトを返します。</font><font style="vertical-align: inherit;">トポロジを作成するための主なオブジェクトは、StreamsBuilderオブジェクトです。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">streamメソッドでは、トピック「src」にサブスクライブし、着信メッセージを読み取ります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filterメソッドでは、ビジネスロジック-フィルタリングを実装しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toメソッドでは、処理結果を結果のトピック「out」に送信します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを起動し、「out」トピックをサブスクライブします。</font></font><br>
<br>
<pre><code class="java hljs">PS C:\Users\User&gt; cd C:\kafka_2<span class="hljs-number">.12</span>-<span class="hljs-number">2.5</span><span class="hljs-number">.0</span>\<font></font>
PS C:\kafka&gt; bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:<span class="hljs-number">9092</span> --topic out --from-beginning<font></font>
{<span class="hljs-string">"phone_number"</span>:<span class="hljs-number">79302</span>,<span class="hljs-string">"balance"</span>:<span class="hljs-number">0.0</span>}<font></font>
{<span class="hljs-string">"phone_number"</span>:<span class="hljs-number">79303</span>,<span class="hljs-string">"balance"</span>:-<span class="hljs-number">50.0</span>}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データが正常に処理されたことがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kafkaストリームの利点：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任意のJavaアプリケーションに簡単に統合でき、パッケージング、デプロイメント、およびメンテナンスツールと統合できるシンプルで軽量なライブラリ。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apache Kafka以外のシステムへの外部依存関係はありません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォールトトレラントなローカル状態をサポートし、非常に高速で効率的な状態保存操作を提供します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kafka StreamsクライアントまたはKafkaブローカーで処理が失敗した場合でも、各レコードが確実に1回だけ処理されるようにする「1回だけ処理する」ルールをサポートします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「一度に1つのレコード」処理を使用して、ミリ秒の遅延を実現します。</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja504408/index.html">UI自動テスト用のセレン化されたシンプルで便利なテストフレームワークテンプレート</a></li>
<li><a href="../ja504412/index.html">オンラインプログラミングチャンピオンシップ「モスクワトレーニングのオープンファイナル」</a></li>
<li><a href="../ja504414/index.html">Как Microsoft убила AppGet</a></li>
<li><a href="../ja504416/index.html">3D ML。パート2：3D MLタスクの損失関数</a></li>
<li><a href="../ja504420/index.html">同時移動を伴うターンベースのPvPアリーナの作成</a></li>
<li><a href="../ja504430/index.html">Everyday Life Tinkoff Security Operations Center：シングルブートローダー分析</a></li>
<li><a href="../ja504434/index.html">親のための教育プログラム：インターネットで子供を危険から守る方法</a></li>
<li><a href="../ja504438/index.html">1週間あたり30ミタップ。2020年夏シーズンオープン</a></li>
<li><a href="../ja504442/index.html">Linuxカーネルでの再配置について少し</a></li>
<li><a href="../ja504444/index.html">docker multi-stageを使用してWindowsイメージを構築する</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>