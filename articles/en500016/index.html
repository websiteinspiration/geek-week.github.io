<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå∫ ‚ùóÔ∏è üç¶ Practical work with FPGAs in the set of Redd. Mastering DMA for the Avalon-ST bus and switching between Avalon-MM buses ü•Ä üíÜüèæ ‚úâÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to move towards the creation of real devices based on the Redd FPGA complex. For another All-Hardware project, I need a simple logic analy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Practical work with FPGAs in the set of Redd. Mastering DMA for the Avalon-ST bus and switching between Avalon-MM buses</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500016/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We continue to move towards the creation of real devices based on the Redd FPGA complex. </font><font style="vertical-align: inherit;">For another All-Hardware project, I need a simple logic analyzer, so we will move in this direction. </font><font style="vertical-align: inherit;">Lucky - and get to the USB bus analyzer (but this is still in the long run). </font><font style="vertical-align: inherit;">The heart of any analyzer is RAM and a unit that first uploads data to it and then retrieves it. </font><font style="vertical-align: inherit;">Today we will design it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we will master the DMA block. </font><font style="vertical-align: inherit;">In general, DMA is my favorite topic. </font><font style="vertical-align: inherit;">I even did a great </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article about DMA on some ARM controllers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">From that article it is clear that DMA takes clock cycles from the bus. </font><font style="vertical-align: inherit;">In the current article, we will consider how things are going with the FPGA-based processor system.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cg/77/ve/cg77velzruiaao4svcvahmuumse.png"><br>
<a name="habracut"></a><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Previous cycle articles</font></font></b>
                        <div class="spoiler_text"><ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  ¬´¬ª  ,   Redd,      .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  ¬´¬ª  ,   Redd.  2.  .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">          .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">     Redd     .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">              Redd.</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> ,       .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Redd.  1:  .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Redd.  2:      .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  :        .</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    Redd,    FTDI</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">     Redd</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">       Redd</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> USB-  Windows 10   </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   Nios II    Nios II</a></li>
</ol><br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hardware Creation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We begin to create the hardware. In order to understand how much the DMA block conflicts with clock cycles, we will need to take accurate measurements at high load on the Avalon-MM bus (Avalon Memory-Mapped). We have already </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">found out</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that the Altera JTAG-to-Avalon-MM bridge cannot provide high bus loads. Therefore, today we have to add a processor core to the system so that it accesses the bus at high speed. How this is done has been described </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For the sake of optimality, let's disable both caches for the processor core, but create one strongly connected bus, as we did </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4z/a8/xx/4za8xxe_btr14mdgfjmzhpwxusi.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add 8 kilobytes of program memory and data memory. Remember that the memory must be dual-port and have an address in a special range (to prevent it from jumping, lock it, we discussed the reasons for this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/kp/km/3v/kpkm3vhuov70qf9zgfl89njhqum.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have already created the project a thousand times, so there is nothing particularly interesting in the creation process itself (if anything, all the steps for creating it are described </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The base is ready. Now we need a data source that we will put in memory. The ideal thing is a constantly ticking timer. If during some measure the DMA block was not able to process the data, then we will immediately see this by the missing value. Well, that is, if in memory there are values ‚Äã‚Äã1234 and 1236, it means that on the clock, when the timer issued 1235, the DMA block did not transfer data. Create a file</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Timer_ST.sv</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with such a simple counter:</font></font><br>
<br>
<pre><code class="plaintext hljs">module Timer_ST (<font></font>
  input              clk,<font></font>
  input              reset,<font></font>
	<font></font>
  input  logic       source_ready,<font></font>
  output logic       source_valid,<font></font>
  output logic[31:0] source_data<font></font>
	<font></font>
);<font></font>
    logic [31:0] counter;<font></font>
    always @ (posedge clk, posedge reset)<font></font>
    if (reset == 1)<font></font>
    begin<font></font>
        counter &lt;= 0;<font></font>
    end else<font></font>
    begin<font></font>
        counter &lt;= counter + 1;<font></font>
    end<font></font>
<font></font>
    assign source_valid = 1;<font></font>
    assign source_data [31:24] = counter [7:0];<font></font>
    assign source_data [23:16] = counter [15:8];<font></font>
    assign source_data [15:8] = counter [23:16];<font></font>
    assign source_data [7:0] = counter [31:24];<font></font>
<font></font>
endmodule<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This counter is like a pioneer: it is always ready (at the output </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source_valid is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> always one) and it always counts (except for the moments of the reset state). </font><font style="vertical-align: inherit;">Why the module has exactly these signals - we discussed </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in this article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we create our own component (how this is done is described </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Automation mistakenly chose the Avalon_MM bus for us. </font><font style="vertical-align: inherit;">Replace it with </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avalon_streaming_source</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and map the signals as shown below: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/to/u1/fb/tou1fbktluymact4id-sxeca5qq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Great. </font><font style="vertical-align: inherit;">Add our component to the system. </font><font style="vertical-align: inherit;">Now we are looking for the DMA block ... And we find not one, but three. </font><font style="vertical-align: inherit;">All of them are described in the document </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Embedded Peripheral IP User Guide</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from Altera (as always, I give names, but not links, since links always change).</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/0q/a9/lo/0qa9lo90au55qrl5-02u3py-bb8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Which one to use? I can not resist nostalgia. Back in 2012, I made a system based on the PCIe bus. All manuals from Altera contained an example based on the first of these blocks. But he with the PCIe component gave a speed of no more than 4 megabytes per second. In those days, I spat and wrote my DMA block. Now I don‚Äôt remember his speed, but he drove the data from SATA drives to the limit of the capabilities of drives and SSDs of those times. That is, I have sharpened a tooth on this block. But I will not slip into a comparison of the three blocks. The fact is that today we have to work with a source based on Avalon-ST (Avalon Streaming Interface), and only </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modular Scatter-Gather DMA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block supports such sources </font><font style="vertical-align: inherit;">. Here we put it on the diagram. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the block settings, select the mode</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Streaming to Memory Mapped</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Plus - I want to drive data from launch to filling SDRAM, so I replaced the maximum data transfer unit from 1 kilobyte to 4 megabytes. True, I was warned that in the end, the FMax parameter will not be so hot (even if you replace the maximum block with 2 kilobytes). But for today, FMax is acceptable (104 MHz), and then we'll figure it out. I left the remaining parameters unchanged. You can also set the transmission mode to Full Word Access Only, this will increase FMax to 109 MHz. But we will not fight for performance today.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/u6/1y/8-/u61y8-h-wpei03u3xgkjsjtuurs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So. The source is, DMA is. Receiver ... SDRAM? In future combat conditions, yes. But today we need a memory with known characteristics. Unfortunately, SDRAM needs to periodically send commands that take several clock cycles, plus this memory can be occupied by regeneration. Therefore, instead of it, we will now use the built-in FPGA memory. Everything is working for her in one step, without unpredictable delays.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the SDRAM controller is single-port, the built-in memory can also be used exclusively in single-port mode. It is important. The fact is that we want to write to the memory using the DMA block master, but on the other hand, we want to read from this memory using the processor core or the Altera JTAG-to-Avalon-MM block. The hand reaches out and connect the write and read blocks to two different ports ... But you can‚Äôt! Rather, it is forbidden by the conditions of the problem. Because today it is possible, but tomorrow we will replace the memory with an exclusively single-port one. In general, we get such a block of three components (timer, DMA and memory):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vb/ws/rv/vbwsrvdbjsns34syktoliarkudy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, and just for the sake of proforma, I‚Äôll add UT and sysid to the JTAG system (although the second one didn‚Äôt help, I still had to conjure it with a JTAG adapter). </font><font style="vertical-align: inherit;">What it is, and how their addition solves small problems, we have already studied. </font><font style="vertical-align: inherit;">I will not tint the tires, everything is clear with them. </font><font style="vertical-align: inherit;">Just show how it all looks in my project: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t5/xk/qv/t5xkqv474idlwer3fnklkz5whbs.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's it. </font><font style="vertical-align: inherit;">The system is ready. </font><font style="vertical-align: inherit;">We assign addresses, assign processor vectors, generate a system (do not forget that you need to save with the same name as the project itself, then it will go to the top level of the hierarchy), add it to the project. </font><font style="vertical-align: inherit;">Make the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> leg </font><font style="vertical-align: inherit;">virtual, connect </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clk</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font><b><font style="vertical-align: inherit;">pin_25</font></b><font style="vertical-align: inherit;"> leg</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We are assembling the project, pouring it into the equipment ... How is it, poor thing, in the empty office because of the total remote location? .. It‚Äôs lonely and scary for her, probably, alone ... But I was distracted.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a software part</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Training</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the BSP Editor with the usual movement of the hand I turn on C ++ support. </font><font style="vertical-align: inherit;">I so often inserted a screenshot of this case that I stop doing it. </font><font style="vertical-align: inherit;">But another screenshot, although it has already been seen, is still so common. </font><font style="vertical-align: inherit;">So let's discuss it one more time. </font><font style="vertical-align: inherit;">We remember that the system is trying to put data in the largest piece of memory. </font><font style="vertical-align: inherit;">And such is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buffer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Therefore, we force everything to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ck/ge/g_/ckgeg_tcmcuz0oa8retrmdrfiiw.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Program experiment</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We make a code that simply fills the memory with the contents of the source (in the role of the counter).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View code</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">#include "sys/alt_stdio.h"<font></font>
#include &lt;altera_msgdma.h&gt;<font></font>
#include &lt;altera_msgdma_descriptor_regs.h&gt;<font></font>
#include &lt;system.h&gt;<font></font>
#include &lt;string.h&gt;<font></font>
<font></font>
int main()<font></font>
{ <font></font>
  alt_putstr("Hello from Nios II!\n");<font></font>
<font></font>
  memset (BUFFER_BASE,0,BUFFER_SIZE_VALUE);<font></font>
<font></font>
  //  ,   <font></font>
  IOWR_ALTERA_MSGDMA_CSR_CONTROL(MSGDMA_0_CSR_BASE,<font></font>
      ALTERA_MSGDMA_CSR_STOP_DESCRIPTORS_MASK);<font></font>
<font></font>
  //   ,      ,<font></font>
  //    ,   .  .<font></font>
<font></font>
  //    FIFO<font></font>
  IOWR_ALTERA_MSGDMA_DESCRIPTOR_READ_ADDRESS(MSGDMA_0_DESCRIPTOR_SLAVE_BASE,<font></font>
      (alt_u32)0);<font></font>
  IOWR_ALTERA_MSGDMA_DESCRIPTOR_WRITE_ADDRESS(MSGDMA_0_DESCRIPTOR_SLAVE_BASE,<font></font>
      (alt_u32)BUFFER_BASE);<font></font>
  IOWR_ALTERA_MSGDMA_DESCRIPTOR_LENGTH(MSGDMA_0_DESCRIPTOR_SLAVE_BASE,<font></font>
      BUFFER_SIZE_VALUE);<font></font>
  IOWR_ALTERA_MSGDMA_DESCRIPTOR_CONTROL_STANDARD(MSGDMA_0_DESCRIPTOR_SLAVE_BASE,<font></font>
      ALTERA_MSGDMA_DESCRIPTOR_CONTROL_GO_MASK);<font></font>
<font></font>
   //  ,    <font></font>
   IOWR_ALTERA_MSGDMA_CSR_CONTROL(MSGDMA_0_CSR_BASE,<font></font>
       ALTERA_MSGDMA_CSR_STOP_ON_ERROR_MASK<font></font>
       &amp; (~ALTERA_MSGDMA_CSR_STOP_DESCRIPTORS_MASK)<font></font>
       &amp;(~ALTERA_MSGDMA_CSR_GLOBAL_INTERRUPT_MASK)) ;<font></font>
<font></font>
<font></font>
   //   <font></font>
   static const alt_u32 errMask = ALTERA_MSGDMA_CSR_STOPPED_ON_ERROR_MASK |<font></font>
           ALTERA_MSGDMA_CSR_STOPPED_ON_EARLY_TERMINATION_MASK |<font></font>
           ALTERA_MSGDMA_CSR_STOP_STATE_MASK |<font></font>
           ALTERA_MSGDMA_CSR_RESET_STATE_MASK;<font></font>
<font></font>
  volatile alt_u32 status;<font></font>
  do<font></font>
  {<font></font>
     status = IORD_ALTERA_MSGDMA_CSR_STATUS(MSGDMA_0_CSR_BASE);<font></font>
  } while (!(status &amp; errMask) &amp;&amp;(status &amp; ALTERA_MSGDMA_CSR_BUSY_MASK));     <font></font>
<font></font>
  alt_putstr("You can play with memory!\n");<font></font>
<font></font>
  /* Event loop never exits. */<font></font>
  while (1);<font></font>
<font></font>
  return 0;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start, we wait for the message </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"You can play with memory!"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , put the program on pause and look at the memory, starting from address 0. At first I was very scared: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rw/yd/kb/rwydkbfypprtgoj5wspybiq3sv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From address 0x80, the counter changes its value sharply. Moreover, a very large amount. But it turned out that everything is fine. At our place, the counter never stops and is always ready, and DMA has its own read-ahead queue. Let me remind you the settings of the DMA block:</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ty/hk/-6/tyhk-610qcr5r-jpmrr2dnxz4wg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x80 bytes are 0x20 thirty-two-bit words. </font><font style="vertical-align: inherit;">Just 32 decimal. </font><font style="vertical-align: inherit;">It all fits together. </font><font style="vertical-align: inherit;">In debugging conditions, this is not scary. </font><font style="vertical-align: inherit;">In combat conditions, the source will work more correctly (its readiness will be reset). </font><font style="vertical-align: inherit;">Therefore, we simply ignore this section. </font><font style="vertical-align: inherit;">In other areas, the meter counts sequentially. </font><font style="vertical-align: inherit;">I will show only the dump fragment in width. </font><font style="vertical-align: inherit;">Take a word that I examined it in its entirety. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pw/hg/eq/pwhgeqyxbian3_fg-m46yliilrk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not trusting my eyes, I wrote a code that automatically checks the data:</font></font><br>
<br>
<pre><code class="plaintext hljs">  volatile alt_u32* pData = (alt_u32*)BUFFER_BASE;<font></font>
  volatile alt_u32 cur = pData[0x10];<font></font>
  int nLine = 0;<font></font>
  for (volatile int i=0x11;i&lt;BUFFER_SIZE_VALUE/4;i++)<font></font>
  {<font></font>
	  if (pData[i]!=cur+1)<font></font>
	  {<font></font>
		  alt_printf("Problem at 0x%x\n",i*4);<font></font>
		  if (nLine++ &gt; 10)<font></font>
		  {<font></font>
			  break;<font></font>
		  }<font></font>
	  }<font></font>
	  cur = pData[i];<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He also does not reveal any problems.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trying to find at least some problems</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, the absence of problems is not always good. </font><font style="vertical-align: inherit;">As part of the article, I needed to find the problems, and then show how they are fixed. </font><font style="vertical-align: inherit;">After all, the problems are obvious. </font><font style="vertical-align: inherit;">A busy bus cannot pass data without delays! </font><font style="vertical-align: inherit;">There should be delays! </font><font style="vertical-align: inherit;">But let's check why everything happens so beautifully. </font><font style="vertical-align: inherit;">First of all, it may turn out that the whole thing is in the FIFO of the DMA block. </font><font style="vertical-align: inherit;">Reduce their size to a minimum: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z3/vm/9i/z3vm9igmqgqcgynhiyzu-9dr7ss.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything continues to work! </font><font style="vertical-align: inherit;">Good. </font><font style="vertical-align: inherit;">Make sure that we provoke the number of accesses to the bus more than the FIFO dimension. </font><font style="vertical-align: inherit;">Add a hit counter:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fa/f4/iq/faf4iqvpkc4ezbvhdz4uhpnrbjo.png"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same text:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">  volatile alt_u32 status;<font></font>
  volatile int n = 0;<font></font>
  do<font></font>
  {<font></font>
	  status = IORD_ALTERA_MSGDMA_CSR_STATUS(MSGDMA_0_CSR_BASE);<font></font>
	  n += 1;<font></font>
  } while (!(status &amp; errMask) &amp;&amp;(status &amp; ALTERA_MSGDMA_CSR_BUSY_MASK));  <font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the end of the work, it is 29. This is more than 16. That is, the FIFO should overflow. </font><font style="vertical-align: inherit;">Just in case, let's add more status register readings. </font><font style="vertical-align: inherit;">Does not help. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With grief, I disconnected from the remote Redd complex, redid the project to my existing breadboard, which I can connect to with an oscilloscope right now (in the office, nobody is at a distance, I can‚Äôt reach the oscilloscope). </font><font style="vertical-align: inherit;">Added two ports to the timer:</font></font><br>
<br>
<pre><code class="plaintext hljs">   output    clk_copy,<font></font>
   output    ready_copy<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And appointed them:</font></font><br>
<br>
<pre><code class="plaintext hljs">    assign clk_copy = clk;<font></font>
    assign ready_copy = source_ready;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the module began to look like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">module Timer_ST (<font></font>
   input           clk,<font></font>
   input           reset,<font></font>
	<font></font>
   input logic     source_ready,<font></font>
   output logic    source_valid,<font></font>
   output logic[31:0] source_data,<font></font>
<font></font>
   output    clk_copy,<font></font>
   output    ready_copy<font></font>
	<font></font>
);<font></font>
    logic [31:0] counter;<font></font>
    always @ (posedge clk, posedge reset)<font></font>
    if (reset == 1)<font></font>
    begin<font></font>
        counter &lt;= 0;<font></font>
    end else<font></font>
    begin<font></font>
        counter &lt;= counter + 1;<font></font>
    end<font></font>
<font></font>
    assign source_valid = 1;<font></font>
    assign source_data [31:24] = counter [7:0];<font></font>
    assign source_data [23:16] = counter [15:8];<font></font>
    assign source_data [15:8] = counter [23:16];<font></font>
    assign source_data [7:0] = counter [31:24];<font></font>
<font></font>
    assign clk_copy = clk;<font></font>
    assign ready_copy = source_ready;<font></font>
<font></font>
endmodule<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At home I have a smaller model with a crystal, so I had to reduce the appetite of memory. And it turned out that my primitive program would not fit into a 4 kilobyte section. So the topic raised </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the last article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is, oh, how relevant. Memory in the system - barely enough! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the program starts, we get a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ready</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> surge of </font><font style="vertical-align: inherit;">either 16 or 17 measures. This is filled with the FIFO of the DMA block. The same effect that scared me at the beginning. It is these data that will form the very false buffer filling. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i6/wy/-a/i6wy-a4xsnbwej_o9indj_plneg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we have a beautiful picture at 40960 nanoseconds, that is, 2048 cycles (with a home crystal, the buffer had to be reduced to 8 kilobytes, that is, 2048 thirty-two-bit words). Here is its beginning: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9h/c5/1d/9hc51dpo8ur2_1whymyreqkvzre.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the end:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5l/3y/le/5l3ylew4zpty3b9xf6bn_zjunlc.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, and throughout - not a single failure. </font><font style="vertical-align: inherit;">No, it was clear that this would happen, but there was some hope ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maybe we should try to write on the bus, and not just read from it? </font><font style="vertical-align: inherit;">I added a GPIO block to the system: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rj/lg/o8/rjlgo8iyaj30cxjr8jhkc1njap4.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Added an entry to it while waiting for readiness:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j4/ci/vp/j4civpmja0ccaz_9qinqqc247wu.png"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same text</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">  volatile alt_u32 status;<font></font>
  volatile int n = 0;<font></font>
  do<font></font>
  {<font></font>
	status = IORD_ALTERA_MSGDMA_CSR_STATUS(MSGDMA_0_CSR_BASE);<font></font>
       IOWR_ALTERA_AVALON_PIO_DATA (PIO_0_BASE,0x01);<font></font>
       IOWR_ALTERA_AVALON_PIO_DATA (PIO_0_BASE,0x00);<font></font>
<font></font>
       n += 1;<font></font>
  } while (!(status &amp; errMask) &amp;&amp;(status &amp; ALTERA_MSGDMA_CSR_BUSY_MASK));  <font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are no problems and that's it! </font><font style="vertical-align: inherit;">Who is to blame?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are no miracles, but there are unexplored things</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Who is to blame? With grief, I began to study all the menus of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Platform Designer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tool </font><font style="vertical-align: inherit;">and, it seems, found a clue. What does a tire usually look like? The set of wires to which clients are connected. So? It seems so. We see this from the figures in the editor. Just, the second goal of the article was to show how the bus can be divided into two independent segments, each of which works without interfering with the other. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But let's look at the messages that appear when the system is generated. Highlight keywords:</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/di/ri/c1/diric1mrzwztjmu2bcw3nrxg5du.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And there are a lot of similar messages: it is added, it is added. It turns out that after editing with pens, a lot of additional things are added to the system. How would you look at a scheme in which all this is already available? I‚Äôm still swimming in this, but we can get the most likely answer within the framework of the article by choosing this menu item: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/7s/k_/vv7sk_blrrjycf7wfixijjcdzus.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
opened picture is impressive by itself, but I won‚Äôt give it. And immediately </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y-/ub/dv/y-ubdvljrhcecquyc0rg5u5t16e.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll </font><font style="vertical-align: inherit;">select this tab: </font><font style="vertical-align: inherit;">And there we see the following: I will </font></font><br>
<br>
<img src="https://habrastorage.org/webt/18/zk/_9/18zk_94hudf6j0r9lfliuu9wjy8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
show larger the most important:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gy/1u/if/gy1uifa4ln0x8_axbm4t9_juypq.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tires are not combined! </font><font style="vertical-align: inherit;">They are segmented! </font><font style="vertical-align: inherit;">I can‚Äôt justify it (perhaps experts will correct me in the comments), but it seems that the system inserted the switches for us! </font><font style="vertical-align: inherit;">It is these switches that create the isolated bus segments, and the main system can work in parallel with the DMA unit, which at this time can access memory without conflict!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We provoke real problems</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having received all this knowledge, we conclude that we can very well provoke problems. </font><font style="vertical-align: inherit;">This is necessary in order to make sure that the test system can create them, which means that the development environment really resolves them independently. </font><font style="vertical-align: inherit;">We will not refer to abstract devices on the bus, but to the same Buffer memory so that the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmd_mux_005</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">distributes the bus between the processor core and the DMA block. </font><font style="vertical-align: inherit;">We rewrite the long-suffering wait function like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zm/ww/4n/zmww4n1xt_p-eo_2hqrfufgtmis.png"><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same text</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">  volatile alt_u32 status;<font></font>
  volatile int n = 0;<font></font>
  volatile alt_u32* pBuf = (alt_u32*)BUFFER_BASE;<font></font>
  volatile alt_u32 sum = 0;<font></font>
  do<font></font>
  {<font></font>
	  status = IORD_ALTERA_MSGDMA_CSR_STATUS(MSGDMA_0_CSR_BASE);<font></font>
	  sum += pBuf[n];<font></font>
<font></font>
	  n += 1;<font></font>
  } while (!(status &amp; errMask) &amp;&amp;(status &amp; ALTERA_MSGDMA_CSR_BUSY_MASK));<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And finally, dips appeared on the waveform! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/po/rc/vvporcmhdl2i9julycbcib6vnfe.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The memory check function also found a lot of omissions: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xf/pf/8y/xfpf8ytbjo3wqlxsgqprx6eqnj0.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, and we see very well that the data is shifted from row to row: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/eu/eh/uu/euehuuf9rp-ilidebmcy_zsdcuq.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is an example of a specific bad spot (6CCE488F is missing): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v_/5e/rj/v_5erjk_wbxw9ujfrhptcxpeudy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we see that the experiment was done correctly, just the development environment carried out optimization for us. </font><font style="vertical-align: inherit;">This is the case when I pronounce the phrase ‚ÄúAll smartly hurt all steel‚Äù not with mockery, but with gratitude. </font><font style="vertical-align: inherit;">Thanks to the Quartus developers for this matter!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We learned how to insert a DMA block into the system to transfer streaming data to memory. </font><font style="vertical-align: inherit;">We also made sure that the process of downloading other devices on the bus will not interfere with the download process. </font><font style="vertical-align: inherit;">The development environment will automatically create an isolated segment that will run in parallel with other sections of the bus. </font><font style="vertical-align: inherit;">Of course, if someone turns to the same segment, conflicts and time spent on resolving them are inevitable, but the programmer may well foresee such things. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the next article, we will replace RAM with an SDRAM controller, and the timer with a real "head" and make the first logical analyzer. </font><font style="vertical-align: inherit;">Will it work? I don‚Äôt know yet. </font><font style="vertical-align: inherit;">I hope the problems do not appear.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500002/index.html">IT specialists vs salesmen: and the world cracked in half</a></li>
<li><a href="../en500008/index.html">Meet upscalers</a></li>
<li><a href="../en500010/index.html">History of dirty hydrogen</a></li>
<li><a href="../en500012/index.html">Entity Framework Core</a></li>
<li><a href="../en500014/index.html">Fully responsive design is more than just media queries</a></li>
<li><a href="../en500018/index.html">Imitation of freehand drawing on the example of RoughJS</a></li>
<li><a href="../en500020/index.html">Google Earth Engine - Unique Big Geodata Analysis Platform</a></li>
<li><a href="../en500022/index.html">Why participate in community life and how does it help professional growth?</a></li>
<li><a href="../en500026/index.html">Nonsense in this industry * just unbelievable</a></li>
<li><a href="../en500028/index.html">Data Management Platforms: Peripheral to Cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>