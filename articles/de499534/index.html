<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏂🏿 ✍🏾 🤶🏻 Entwicklungshandbuch für Python-Backend-Dienste 📂 🙆🏻 🚜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo, mein Name ist Alexander Vasin, ich bin ein Backend-Entwickler in Edadil. Die Idee zu diesem Material begann mit der Tatsache, dass ich die Einf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Entwicklungshandbuch für Python-Backend-Dienste</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/499534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo, mein Name ist Alexander Vasin, ich bin ein Backend-Entwickler in Edadil. Die Idee zu diesem Material begann mit der Tatsache, dass ich die Einführungsaufgabe ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya.Disk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) in die Yandex </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Backend Development</font></a><font style="vertical-align: inherit;"> School </font><font style="vertical-align: inherit;">analysieren wollte </font><font style="vertical-align: inherit;">. Ich begann alle Feinheiten der Auswahl bestimmter Technologien, der Testmethode zu beschreiben ... Es stellte sich heraus, dass es sich überhaupt nicht um eine Analyse handelte, sondern um eine sehr detaillierte Anleitung zum Schreiben von Backends in Python. Von der ersten Idee an gab es nur Anforderungen an den Service, an deren Beispiel es zweckmäßig ist, Werkzeuge und Technologien zu zerlegen. Infolgedessen bin ich mit hunderttausend Zeichen aufgewacht. Es war genau so viel erforderlich, um alles im Detail zu betrachten. Also das Programm für die nächsten 100 Kilobyte: Wie man ein Service-Backend erstellt, von der Auswahl der Tools bis zur Bereitstellung. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/sz/r2/pmszr288srjaplio0w_utpnb4ym.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hier ist </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein GitHub-Vertreter mit Anwendung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und wer (echte) Longreads liebt - bitte unter Katze.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden den REST-API-Service in Python entwickeln und testen, ihn in einen leichten Docker-Container packen und ihn mit Ansible bereitstellen.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können den REST-API-Service mit verschiedenen Tools auf unterschiedliche Weise implementieren. </font><font style="vertical-align: inherit;">Die beschriebene Lösung ist nicht die einzig richtige. Ich habe die Implementierung und die Tools basierend auf meinen persönlichen Erfahrungen und Vorlieben ausgewählt.</font></font></blockquote><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was werden wir machen?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Welche Tools zur Auswahl?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entwicklung</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum müssen Sie mit setup.py beginnen?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie werden Abhängigkeitsversionen angegeben?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenbank</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir entwerfen das Schema</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beschreiben Sie das Schema in SQLAlchemy</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passen Sie Alembic an</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir generieren Migrationen</font></font></a></li>
</ul></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendung</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenserialisierung</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / Importe</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Bürger</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / bürger / $ bürger_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Bürger / Geburtstage</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Towns / Stat / Perzentil / Alter</font></font></a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testen</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Bürger</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / Importe</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / bürger / $ bürger_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Bürger / Geburtstage</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Towns / Stat / Perzentil / Alter</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrationen</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versammlung</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bereitstellen</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Belastbarkeitstest</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was kann man noch tun?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abschließend</font></font></a></li>
</ul><br>
<a name="task"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was werden wir machen?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie sich vor, ein Online-Geschenkeladen plant, eine Aktion in verschiedenen Regionen zu starten. </font><font style="vertical-align: inherit;">Damit eine Vertriebsstrategie effektiv ist, ist eine Marktanalyse erforderlich. </font><font style="vertical-align: inherit;">Das Geschäft verfügt über einen Lieferanten, der regelmäßig (z. B. per Post) Daten mit Informationen über die Bewohner entlädt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns einen Python-REST-API-Service entwickeln, der die bereitgestellten Daten analysiert und die Nachfrage nach Geschenken von Bewohnern verschiedener Altersgruppen in verschiedenen Städten nach Monat ermittelt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir implementieren die folgenden Handler im Service:</font></font><br>
<br>
<ul>
<li> <code>POST /imports</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügt einen neuen Upload mit Daten hinzu.</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gibt die Bewohner der angegebenen Entlastung zurück;</font></font><br>
 </li>
<li> <code>PATCH /imports/$import_id/citizens/$citizen_id</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ändert Informationen über den Bewohner (und seine Verwandten) in der angegebenen Entladung;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens/birthdays</code><br>
  ,        ( ),   ;<br>
 </li>
<li> <code>GET /imports/$import_id/towns/stat/percentile/age</code><br>
 50-, 75-  99-   ( )      .<br>
 </li>
</ul><br>
<a name="tools"></a><h1>  ?</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir schreiben also einen Dienst in Python unter Verwendung vertrauter Frameworks, Bibliotheken und DBMS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 Vorlesungen des</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Videokurses werden verschiedene DBMS und deren Funktionen beschrieben. Für meine Implementierung habe ich das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DBMS ausgewählt </font><font style="vertical-align: inherit;">, das sich als zuverlässige Lösung mit hervorragender </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentation auf Russisch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , einer starken russischen Community (Sie können die Antwort auf eine Frage immer auf Russisch finden) und sogar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kostenlosen Kursen etabliert hat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Das relationale Modell ist sehr vielseitig und wird von vielen Entwicklern gut verstanden. Obwohl das Gleiche mit jedem NoSQL-DBMS möglich ist, werden wir in diesem Artikel PostgreSQL betrachten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Hauptziel des Dienstes - die Datenübertragung über das Netzwerk zwischen der Datenbank und den Clients - bedeutet keine große Belastung des Prozessors, sondern die Fähigkeit, mehrere Anforderungen gleichzeitig zu verarbeiten. In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 Vorlesungen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> als asynchroner Ansatz betrachtet. Sie können damit mehrere Clients innerhalb desselben Betriebssystemprozesses effizient bedienen (im Gegensatz zum Beispiel zum in Flask / Django verwendeten Pre-Fork-Modell, das mehrere Prozesse für die Verarbeitung von Benutzeranforderungen erstellt, von denen jeder Speicher verbraucht, aber die meiste Zeit im Leerlauf ist ) Daher habe ich als Bibliothek zum Schreiben des Dienstes das asynchrone </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp gewählt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">
Die </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">5. Vorlesung des </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Videokurses</font></a><font style="vertical-align: inherit;"> erzählt, dass </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">SQLAlchemy</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/or/rj/pn/orrjpnx6upvsipcqbsql7f36vzc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit dieser Option können Sie komplexe Abfragen in Teile zerlegen, wiederverwenden, Abfragen mit einem dynamischen Satz von Feldern generieren (z. B. ermöglicht der PATCH-Prozessor die teilweise Aktualisierung eines Bewohners mit beliebigen Feldern) und sich direkt auf die Geschäftslogik konzentrieren. Der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpg-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Treiber </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">kann</font></a><font style="vertical-align: inherit;"> diese Anforderungen verarbeiten und die Daten am schnellsten übertragen </font><font style="vertical-align: inherit;">. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncpgsa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hilft ihnen dabei, Freunde zu finden </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mein Lieblingswerkzeug zum Verwalten des Datenbankstatus und zum Arbeiten mit Migrationen ist </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Übrigens habe ich kürzlich in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moscow Python darüber gesprochen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Logik der Validierung wurde durch </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marshmallow-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schemata </font><font style="vertical-align: inherit;">(einschließlich der Überprüfung auf familiäre Bindungen) kurz und </font><font style="vertical-align: inherit;">bündig beschrieben </font><font style="vertical-align: inherit;">. Verwenden des Moduls </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp-spec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe Aiohttp-Handler und Schemata für die Datenvalidierung verknüpft. Der Bonus bestand darin, Dokumentation im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Format zu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erstellen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und in einer </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">grafischen Oberfläche</font></a><font style="vertical-align: inherit;"> anzuzeigen </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für das Schreiben von Tests habe ich </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mehr darüber in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 Vorlesungen ausgewählt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Debuggen und Profilieren dieses Projekts habe ich den PyCharm-Debugger verwendet ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorlesung 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorlesung 7 wird</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beschrieben, wie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (oder sogar auf einem anderen Betriebssystem) </font><font style="vertical-align: inherit;">auf einem Computer ausgeführt werden </font><font style="vertical-align: inherit;">kann, ohne dass die Anwendungsumgebung zum Starten angepasst werden muss und die Anwendung auf dem Server einfach installiert / aktualisiert / gelöscht werden kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für die Bereitstellung habe ich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible ausgewählt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sie können den gewünschten Status des Servers und seiner Dienste deklarativ beschreiben, arbeiten über ssh und benötigen keine spezielle Software.</font></font><br>
<br>
<a name="development"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entwicklung</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe beschlossen, dem Python-Paket einen Namen zu geben </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und die folgende Struktur zu verwenden: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ly/wt/oxlywtje20xt5ceou8pbtfp8an8.png" width="550"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Datei habe </font></font><code>analyzer/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ich allgemeine Informationen zum Paket veröffentlicht: Beschreibung ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentzeichenfolge</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), Version, Lizenz, Entwicklerkontakte.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es kann mit der eingebauten Hilfe angezeigt werden</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python<font></font>
&gt;&gt;&gt; import analyzer<font></font>
&gt;&gt;&gt; <span class="hljs-built_in">help</span>(analyzer)<font></font>
<font></font>
Help on package analyzer:<font></font>
<font></font>
NAME<font></font>
    analyzer<font></font>
<font></font>
DESCRIPTION<font></font>
      REST API,    .<font></font>
<font></font>
PACKAGE CONTENTS<font></font>
    api (package)<font></font>
    db (package)<font></font>
    utils (package)<font></font>
<font></font>
DATA<font></font>
    __all__ = (<span class="hljs-string">'__author__'</span>, <span class="hljs-string">'__email__'</span>, <span class="hljs-string">'__license__'</span>, <span class="hljs-string">'__maintainer__'</span>,...<font></font>
    __email__ = <span class="hljs-string">'alvassin@yandex.ru'</span>
    __license__ = <span class="hljs-string">'MIT'</span>
    __maintainer__ = <span class="hljs-string">'Alexander Vasin'</span><font></font>
<font></font>
VERSION<font></font>
    0.0.1<font></font>
<font></font>
AUTHOR<font></font>
    Alexander Vasin<font></font>
<font></font>
FILE<font></font>
    /Users/alvassin/Work/backendschool2019/analyzer/__init__.py</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Paket verfügt über zwei Eingabepunkte - den REST-API-Dienst ( </font></font><code>analyzer/api/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) und das Dienstprogramm zur Verwaltung des Datenbankstatus ( </font></font><code>analyzer/db/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Dateien werden </font></font><code>__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus einem bestimmten Grund </font><font style="vertical-align: inherit;">aufgerufen </font><font style="vertical-align: inherit;">- erstens zieht ein solcher Name die Aufmerksamkeit auf sich und macht deutlich, dass die Datei ein Einstiegspunkt ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zweitens dank dieser Herangehensweise an Einstiegspunkte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>     python -m</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># REST API</span>
$ python -m analyzer.api --<span class="hljs-built_in">help</span><font></font>
<font></font>
<span class="hljs-comment">#    </span>
$ python -m analyzer.db --<span class="hljs-built_in">help</span></code></pre><br>
<a name="setuppy"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum müssen Sie mit setup.py beginnen?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit Blick auf die Zukunft werden wir darüber nachdenken, wie die Anwendung verteilt werden kann: Sie kann in ein Zip-Archiv (sowie ein Rad- / Ei-Archiv), ein RPM-Paket, eine Paketdatei für MacOS gepackt und auf einem Remotecomputer, in einer virtuellen Maschine, einem MacBook oder Docker installiert werden. Container. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Hauptzweck der Datei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>setup.py</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">besteht darin, das Paket mit der Anwendung für zu beschreiben </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Die Datei muss allgemeine Informationen zum Paket enthalten (Name, Version, Autor usw.). Sie können jedoch auch die für die Arbeit erforderlichen Module, zusätzliche Abhängigkeiten (z. B. zum Testen) und Einstiegspunkte (z. B. ausführbare Befehle) angeben ) und Anforderungen an den Dolmetscher. </font><font style="vertical-align: inherit;">
Mit Setuptools-Plugins können Sie Artefakte aus dem beschriebenen Paket sammeln. Es gibt eingebaute Plugins: zip, Ei, U / min, macOS pkg. Die restlichen Plugins werden über PyPI verteilt: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Rad</font></a><font style="vertical-align: inherit;"> ,</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">distutils</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">setuptools</a></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter dem Strich, wenn wir eine Datei beschreiben, erhalten wir großartige Möglichkeiten. </font><font style="vertical-align: inherit;">Deshalb muss die Entwicklung eines neuen Projekts beginnen </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Funktion werden </font></font><code>setup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abhängige Module durch eine Liste angezeigt:</font></font><br>
<br>
<pre><code class="python hljs">setup(..., install_requires=[<span class="hljs-string">"aiohttp"</span>, <span class="hljs-string">"SQLAlchemy"</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber ich habe die Abhängigkeiten in separaten Dateien beschrieben </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deren Inhalt in verwendet wird </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es scheint mir flexibler zu sein, und es gibt ein Geheimnis: Später können Sie damit schneller ein Docker-Image erstellen. </font><font style="vertical-align: inherit;">Abhängigkeiten werden vor der Installation der Anwendung selbst als separater Schritt festgelegt. Wenn Sie den Docker-Container neu erstellen, befindet er sich im Cache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Abhängigkeiten aus den Dateien </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font><font style="vertical-align: inherit;">lesen </font><font style="vertical-align: inherit;">zu </font><font style="vertical-align: inherit;">können </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wird die Funktion geschrieben:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist erwähnenswert, dass , </font></font><code>setuptools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenn die Standardmontage Source - </font><font style="vertical-align: inherit;">Distribution enthält nur die Baugruppendateien </font></font><code>.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.cpp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Um eine Abhängigkeitsdatei </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Tasche zu treffen, sollten sie in der Datei klar angegeben werden </font></font><code>MANIFEST.in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setup.py vollständig</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> importlib.machinery <span class="hljs-keyword">import</span> SourceFileLoader<font></font>
<font></font>
<span class="hljs-keyword">from</span> pkg_resources <span class="hljs-keyword">import</span> parse_requirements
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
module_name = <span class="hljs-string">'analyzer'</span><font></font>
<font></font>
<span class="hljs-comment"># ,     (   ), </span>
<span class="hljs-comment">#   __init__.py   machinery.</span><font></font>
module = SourceFileLoader(<font></font>
    module_name, os.path.join(module_name, <span class="hljs-string">'__init__.py'</span>)<font></font>
).load_module()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements<font></font>
<font></font>
setup(<font></font>
    name=module_name,<font></font>
    version=module.__version__,<font></font>
    author=module.__author__,<font></font>
    author_email=module.__email__,<font></font>
    license=module.__license__,<font></font>
    description=module.__doc__,<font></font>
    long_description=open(<span class="hljs-string">'README.rst'</span>).read(),<font></font>
    url=<span class="hljs-string">'https://github.com/alvassin/backendschool2019'</span>,<font></font>
    platforms=<span class="hljs-string">'all'</span>,<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Intended Audience :: Developers'</span>,
        <span class="hljs-string">'Natural Language :: Russian'</span>,
        <span class="hljs-string">'Operating System :: MacOS'</span>,
        <span class="hljs-string">'Operating System :: POSIX'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.8'</span>,
        <span class="hljs-string">'Programming Language :: Python :: Implementation :: CPython'</span><font></font>
    ],<font></font>
    python_requires=<span class="hljs-string">'&gt;=3.8'</span>,<font></font>
    packages=find_packages(exclude=[<span class="hljs-string">'tests'</span>]),<font></font>
    install_requires=load_requirements(<span class="hljs-string">'requirements.txt'</span>),<font></font>
    extras_require={<span class="hljs-string">'dev'</span>: load_requirements(<span class="hljs-string">'requirements.dev.txt'</span>)},<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-comment"># f-strings  setup.py   - </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-comment">#   ,     Python 3.8, </span>
            <span class="hljs-comment"># source distribution       </span>
            <span class="hljs-comment">#   Python.     </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-string">'{0}-api = {0}.api.__main__:main'</span>.format(module_name),
            <span class="hljs-string">'{0}-db = {0}.db.__main__:main'</span>.format(module_name)<font></font>
        ]<font></font>
    },<font></font>
    include_package_data=<span class="hljs-literal">True</span>
)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können ein Projekt im Entwicklungsmodus mit dem folgenden Befehl installieren (im bearbeitbaren Modus installiert Python nicht das gesamte Paket in einem Ordner </font></font><code>site-packages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sondern erstellt nur Links, sodass alle an den Paketdateien vorgenommenen Änderungen sofort sichtbar sind):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      extra- "dev"</span>
pip install -e <span class="hljs-string">'.[dev]'</span><font></font>
<font></font>
<span class="hljs-comment">#      </span>
pip install -e .</code></pre><br>
<a name="requirements"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie werden Abhängigkeitsversionen angegeben?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist großartig, wenn Entwickler aktiv an ihren Paketen arbeiten - Fehler werden aktiv in ihnen behoben, neue Funktionen werden angezeigt und Feedback kann schneller eingeholt werden. Manchmal sind Änderungen in abhängigen Bibliotheken jedoch nicht abwärtskompatibel und können zu Fehlern in Ihrer Anwendung führen, wenn Sie nicht vorher darüber nachdenken. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für jedes abhängige Paket können Sie beispielsweise eine bestimmte Version angeben </font></font><code>aiohttp==3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dann wird garantiert, dass die Anwendung speziell mit den Versionen der abhängigen Bibliotheken erstellt wird, mit denen sie getestet wurde. Dieser Ansatz hat jedoch einen Nachteil: Wenn Entwickler einen kritischen Fehler in einem abhängigen Paket beheben, der die Abwärtskompatibilität nicht beeinträchtigt, wird dieser Fix nicht in die Anwendung übernommen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt einen Ansatz zur Versionierung der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semantischen Versionierung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, was vorschlägt, die Version im Format einzureichen </font></font><code>MAJOR.MINOR.PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - erhöht sich, wenn rückwärts inkompatible Änderungen hinzugefügt werden;</font></font></li>
<li><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Erhöht sich beim Hinzufügen neuer Funktionen mit Unterstützung der Abwärtskompatibilität.</font></font></li>
<li><code>PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - erhöht sich beim Hinzufügen von Fehlerkorrekturen mit Abwärtskompatibilitätsunterstützung.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ein abhängiges Paket diesen Ansatz folgt (von denen die Autoren in der Regel in der Readme und CHANGELOG Dateien berichten), ist es ausreichend , </font><font style="vertical-align: inherit;">den Wert zu fixieren </font></font><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und den Minimalwert für PATCH-Version zu begrenzen: </font></font><code>&gt;= MAJOR.MINOR.PATCH, == MAJOR.MINOR.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine solche Anforderung kann mit dem Operator </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ =</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementiert werden </font><font style="vertical-align: inherit;">. Beispielsweise kann </font></font><code>aiohttp~=3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PIP für </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version 3.6.3 </font><font style="vertical-align: inherit;">installiert werden </font><font style="vertical-align: inherit;">, nicht jedoch </font><font style="vertical-align: inherit;">für </font><font style="vertical-align: inherit;">Version 3.7. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie das Intervall der Abhängigkeitsversionen angeben, bietet dies einen weiteren Vorteil: Es gibt keine Versionskonflikte zwischen abhängigen Bibliotheken.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie eine Bibliothek entwickeln, für die ein anderes Abhängigkeitspaket erforderlich ist, lassen Sie nicht eine bestimmte Version, sondern ein Intervall zu. </font><font style="vertical-align: inherit;">Dann ist es für die Benutzer Ihrer Bibliothek viel einfacher, sie zu verwenden (plötzlich erfordert ihre Anwendung dasselbe Abhängigkeitspaket, jedoch eine andere Version). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die semantische Versionierung ist nur eine Vereinbarung zwischen Autoren und Verbrauchern von Paketen. </font><font style="vertical-align: inherit;">Es garantiert nicht, dass Autoren Code ohne Fehler schreiben und in der neuen Version ihres Pakets keinen Fehler machen können.</font></font><br>
<br>
<a name="db"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenbank</font></font></h2><br>
<a name="dbstructure"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir entwerfen das Schema</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Beschreibung des POST / Imports-Handlers enthält ein Beispiel für das Entladen mit Informationen zu Anwohnern:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beispiel zum Hochladen</font></font></b>
                        <div class="spoiler_text"><pre><code class="json hljs">{
  <span class="hljs-attr">"citizens"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"26.12.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">2</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"01.04.1997"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">1</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"2"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">11</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"23.11.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"female"</span>,
      <span class="hljs-attr">"relatives"</span>: []<font></font>
    },<font></font>
    ...<font></font>
  ]<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste Gedanke war, alle Informationen über den Bewohner in einer Tabelle zu speichern </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in der die Beziehung durch ein Feld </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Form einer Liste von ganzen Zahlen dargestellt wird</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diese Methode hat jedoch mehrere Nachteile</font></font></b>
                        <div class="spoiler_text"><ol>
<li>   <code>GET /imports/$import_id/citizens/birthdays</code>   ,      ,     <code>citizens</code>   .          <code>relatives</code>    <code>UNNEST</code>.<br>
<br>
     ,  <b>    10- </b>:<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
    relations.citizen_id, <font></font>
    relations.relative_id, <font></font>
    date_part(<span class="hljs-string">'month'</span>, relatives.birth_date) <span class="hljs-keyword">as</span> relative_birth_month
<span class="hljs-keyword">FROM</span> (
	<span class="hljs-keyword">SELECT</span><font></font>
        citizens.import_id, <font></font>
        citizens.citizen_id,<font></font>
        <span class="hljs-keyword">UNNEST</span>(citizens.relatives) <span class="hljs-keyword">as</span> relative_id
	<span class="hljs-keyword">FROM</span> citizens
    <span class="hljs-keyword">WHERE</span> import_id = <span class="hljs-number">1</span>
) <span class="hljs-keyword">as</span> relations
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> citizens <span class="hljs-keyword">as</span> relatives <span class="hljs-keyword">ON</span>
    relations.import_id = relatives.import_id <span class="hljs-keyword">AND</span><font></font>
    relations.relative_id = relatives.citizen_id<font></font>
</code></pre><br>
 </li>
<li>    <b>    <code>relatives</code>   PostgreSQL</b>,   :    <code>relatives</code>     ,      .       (     )         .</li>
</ol></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Außerdem habe ich beschlossen, alle für die Arbeit erforderlichen Daten auf eine </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dritte Normalform zu bringen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , und die folgende Struktur wurde erhalten:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/pf/px/dipfpxxw142kafiect0yhrtt4uo.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importtabelle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> besteht aus einer automatisch inkrementierenden Spalte </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es ist erforderlich, eine Fremdschlüsselprüfung in der Tabelle zu erstellen </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bürger-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tabelle </font><font style="vertical-align: inherit;">werden </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skalare Daten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zum Bewohner </font><b><font style="vertical-align: inherit;">gespeichert</font></b><font style="vertical-align: inherit;"> (alle Felder außer Informationen zu familiären Beziehungen). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Paar ( </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">wird als Primärschlüssel verwendet </font><font style="vertical-align: inherit;">, um die Eindeutigkeit der Bewohner </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">innerhalb des Rahmens zu </font><font style="vertical-align: inherit;">gewährleisten </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Fremdschlüssel </font></font><code>citizens.import_id -&gt; imports.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stellt sicher, dass das Feld </font></font><code>citizens.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nur vorhandene Entladungen enthält.</font></font><br>
 </li>
<li>  <b>relations</b>    <b> </b>. <br>
<br>
<b>     </b> (     ):           <code>citizens</code>  <code>relations</code>     .<br>
     (<code>import_id</code>, <code>citizen_id</code>, <code>relative_id</code>)  ,      <code>import_id</code>   <code>citizen_id</code>   c  <code>relative_id</code>. <br>
<br>
       : <code>(relations.import_id, relations.citizen_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>  <code>(relations.import_id, relations.relative_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>, ,        <code>citizen_id</code>   <code>relative_id</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Struktur stellt die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrität der Daten mithilfe von PostgreSQL-Tools</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sicher. </font><font style="vertical-align: inherit;">Sie ermöglicht es Ihnen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Bewohner mit Verwandten effizient</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus der Datenbank </font><font style="vertical-align: inherit;">zu </font><b><font style="vertical-align: inherit;">holen.</font></b><font style="vertical-align: inherit;"> Sie </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unterliegt jedoch einer Race-Bedingung,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wenn Informationen über Bewohner mit Wettbewerbsanfragen aktualisiert werden (wir werden uns die Implementierung des PATCH-Handlers genauer ansehen).</font></font><br>
<br>
<a name="do_sqlalchemy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beschreiben Sie das Schema in SQLAlchemy</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kapitel 5 habe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ich darüber gesprochen, wie Abfragen mit SQLAlchemy erstellt werden. Sie müssen das Datenbankschema mit speziellen Objekten beschreiben: Tabellen werden mit beschrieben </font></font><code>sqlalchemy.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und an eine Registrierung gebunden </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in der alle Metainformationen über die Datenbank gespeichert sind. Übrigens kann die Registrierung </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht nur die in Python beschriebenen Metainformationen speichern, sondern auch den tatsächlichen Status der Datenbank in Form von SQLAlchemy-Objekten darstellen. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dieser Funktion kann Alembic auch Bedingungen vergleichen und automatisch einen Migrationscode generieren.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Übrigens hat jede Datenbank ihr eigenes Benennungsschema für Standardeinschränkungen. </font><font style="vertical-align: inherit;">Damit Sie keine Zeit damit verschwenden, neue Einschränkungen zu benennen oder zu suchen / abzurufen, welche Einschränkung Sie entfernen möchten, empfiehlt SQLAlchemy die Verwendung von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Namenskonventionen für</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Namensmuster </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sie können in der Registrierung definiert werden </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie eine MetaData-Registrierung und übergeben Sie ihr Namensmuster</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> MetaData<font></font>
<font></font>
convention = {<font></font>
    <span class="hljs-string">'all_column_names'</span>: <span class="hljs-keyword">lambda</span> constraint, table: <span class="hljs-string">'_'</span>.join([<font></font>
        column.name <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> constraint.columns.values()<font></font>
    ]),<font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-string">'ix'</span>: <span class="hljs-string">'ix__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'uq'</span>: <span class="hljs-string">'uq__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#  CHECK-constraint-</span>
    <span class="hljs-string">'ck'</span>: <span class="hljs-string">'ck__%(table_name)s__%(constraint_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'fk'</span>: <span class="hljs-string">'fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'pk'</span>: <span class="hljs-string">'pk__%(table_name)s'</span><font></font>
}<font></font>
metadata = MetaData(naming_convention=convention)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie Namensmuster angeben, verwendet Alembic diese während der automatischen Generierung von Migrationen und benennt alle Einschränkungen entsprechend. </font><font style="vertical-align: inherit;">In Zukunft muss die erstellte Registrierung </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Tabellen beschreiben:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir beschreiben das Datenbankschema mit SQLAlchemy-Objekten</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<font></font>
<font></font>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> (<font></font>
    Column, Date, Enum <span class="hljs-keyword">as</span> PgEnum, ForeignKey, ForeignKeyConstraint, Integer,<font></font>
    String, Table<font></font>
)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@unique</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gender</span>(<span class="hljs-params">Enum</span>):</span>
    female = <span class="hljs-string">'female'</span>
    male = <span class="hljs-string">'male'</span><font></font>
<font></font>
<font></font>
imports_table = Table(<font></font>
    <span class="hljs-string">'imports'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>)<font></font>
)<font></font>
<font></font>
citizens_table = Table(<font></font>
    <span class="hljs-string">'citizens'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, ForeignKey(<span class="hljs-string">'imports.import_id'</span>),<font></font>
           primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'town'</span>, String, nullable=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'street'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'building'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'apartment'</span>, Integer, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'name'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'birth_date'</span>, Date, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'gender'</span>, PgEnum(Gender, name=<span class="hljs-string">'gender'</span>), nullable=<span class="hljs-literal">False</span>),<font></font>
)<font></font>
<font></font>
relations_table = Table(<font></font>
    <span class="hljs-string">'relations'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'relative_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'citizen_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'relative_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
)<font></font>
</code></pre></div>
                    </div><br>
<a name="db_alembic"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passen Sie Alembic an</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn das Datenbankschema beschrieben wird, müssen Migrationen generiert werden. Dazu müssen Sie jedoch zuerst Alembic konfigurieren, was auch in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kapitel 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erläutert wird </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den Befehl zu verwenden </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, müssen Sie die folgenden Schritte ausführen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installationspaket: </font></font><code>pip install alembic</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic initialisieren : </font></font><code>cd analyzer &amp;&amp; alembic init db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Befehl erstellt eine Konfigurationsdatei </font></font><code>analyzer/alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und einen Ordner </font></font><code>analyzer/db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit den folgenden Inhalten:</font></font><br>
 <ul>
<li> <code>env.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Wird jedes Mal angerufen, wenn Sie Alembic starten. </font><font style="vertical-align: inherit;">Stellt eine Verbindung zur Alembic-Registrierung </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einer Beschreibung des gewünschten Status der Datenbank her und enthält Anweisungen zum Starten von Migrationen.</font></font><br>
 </li>
<li><code>script.py.mako</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - die Vorlage, auf deren Grundlage Migrationen generiert werden.</font></font></li>
<li><code>versions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Der Ordner, in dem Alembic Migrationen durchsucht (und generiert).</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Geben Sie die Datenbankadresse in der Datei alembic.ini an:</font></font><br>
<br>
<pre><code class="plaintext hljs">; analyzer/alembic.ini<font></font>
[alembic] <font></font>
sqlalchemy.url = postgresql://user:hackme@localhost/analyzer</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geben Sie eine Beschreibung des gewünschten Status der Datenbank (Registrierung </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) an, damit Alembic automatisch Migrationen generieren kann:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/alembic/env.py</span>
<span class="hljs-keyword">from</span> analyzer.db <span class="hljs-keyword">import</span> schema<font></font>
target_metadata = schema.metadata</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic ist konfiguriert und kann bereits verwendet werden. In unserem Fall weist diese Konfiguration jedoch mehrere Nachteile auf:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Dienstprogramm </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sucht </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im aktuellen Arbeitsverzeichnis. </font><font style="vertical-align: inherit;">Sie </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">können den </font><font style="vertical-align: inherit;">Pfad zum </font><font style="vertical-align: inherit;">Befehlszeilenargument angeben, dies ist jedoch unpraktisch: Ich möchte den Befehl von jedem Ordner aus ohne zusätzliche Parameter aufrufen können.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um Alembic für die Arbeit mit einer bestimmten Datenbank zu konfigurieren, müssen Sie die Datei ändern </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es wäre viel bequemer, beispielsweise die Datenbankeinstellungen für die Umgebungsvariable und / oder ein Befehlszeilenargument anzugeben </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Name des Dienstprogramms </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">korreliert nicht sehr gut mit dem Namen unseres Dienstes (und der Benutzer hat möglicherweise überhaupt kein Python und weiß nichts über Alembic). </font><font style="vertical-align: inherit;">Für den Endbenutzer wäre es viel bequemer, wenn beispielsweise alle ausführbaren Befehle des Dienstes ein gemeinsames Präfix hätten </font></font><code>analyzer-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Probleme werden mit einem kleinen Wrapper gelöst. </font></font><code>analyzer/db/__main__.py:</code><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic verwendet ein Standardmodul zur Verarbeitung von Befehlszeilenargumenten </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">argparse</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sie können ein optionales Argument </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einem Standardwert aus einer Umgebungsvariablen </font><font style="vertical-align: inherit;">hinzufügen </font></font><code>ANALYZER_PG_URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    alembic.parser.add_argument(<font></font>
        <span class="hljs-string">'--pg-url'</span>, default=os.getenv(<span class="hljs-string">'ANALYZER_PG_URL'</span>, DEFAULT_PG_URL),<font></font>
        help=<span class="hljs-string">'Database URL [env var: ANALYZER_PG_URL]'</span><font></font>
    )<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#   sqlalchemy.url   Alembic</span>
    config.set_main_option(<span class="hljs-string">'sqlalchemy.url'</span>, options.pg_url)<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Pfad zur Datei </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kann relativ zum Speicherort der ausführbaren Datei und nicht zum aktuellen Arbeitsverzeichnis des Benutzers berechnet werden.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<font></font>
<font></font>
<font></font>
PROJECT_PATH = Path(__file__).parent.parent.resolve()<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#     (alembic.ini),   </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(options.config):<font></font>
        options.config = os.path.join(PROJECT_PATH, options.config)<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#      alembic   (,  alembic</span>
    <span class="hljs-comment">#   env.py,       )</span>
    alembic_location = config.get_main_option(<span class="hljs-string">'script_location'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(alembic_location):<font></font>
        config.set_main_option(<span class="hljs-string">'script_location'</span>,<font></font>
                               os.path.join(PROJECT_PATH, alembic_location))<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dienstprogramm zum Verwalten des Status der Datenbank</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bereit ist, kann es </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">als ausführbarer Befehl mit einem Namen </font><font style="vertical-align: inherit;">registriert werden </font><font style="vertical-align: inherit;">, der für den Endbenutzer verständlich ist, z. B </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registrieren Sie einen ausführbaren Befehl in setup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup<font></font>
<font></font>
setup(..., entry_points={<font></font>
    <span class="hljs-string">'console_scripts'</span>: [
        <span class="hljs-string">'analyzer-db = analyzer.db.__main__:main'</span><font></font>
    ]<font></font>
})<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach der Neuinstallation des Moduls wird eine Datei generiert </font></font><code>env/bin/analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und der Befehl </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird verfügbar:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip install -e <span class="hljs-string">'.[dev]'</span></code></pre><br>
<a name="db_alembic_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir generieren Migrationen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Migrationen zu generieren, sind zwei Zustände erforderlich: der gewünschte Zustand (den wir mit SQLAlchemy-Objekten beschrieben haben) und der reale Zustand (die Datenbank ist in unserem Fall leer). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich entschied, dass der einfachste Weg, Postgres zu erhöhen, Docker war, und fügte der Einfachheit halber einen Befehl hinzu </font></font><code>make postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, der einen Container im Hintergrund mit PostgreSQL auf Port 5432 ausführt:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erhöhen Sie PostgreSQL und generieren Sie eine Migration</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ make postgres<font></font>
...<font></font>
$ analyzer-db revision --message=<span class="hljs-string">"Initial"</span> --autogenerate<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'imports'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'citizens'</span>
INFO  [alembic.autogenerate.compare] Detected added index <span class="hljs-string">'ix__citizens__town'</span> on <span class="hljs-string">'['</span>town<span class="hljs-string">']'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'relations'</span>
  Generating /Users/alvassin/Work/backendschool2019/analyzer/db/alembic/versions/d5f704ed4610_initial.py ...  <span class="hljs-keyword">done</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic leistet im Allgemeinen gute Arbeit bei der Routinearbeit zur Generierung von Migrationen, aber ich möchte auf Folgendes aufmerksam machen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die in den erstellten Tabellen angegebenen Benutzerdatentypen werden automatisch erstellt (in unserem Fall - </font></font><code>gender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), aber der Code zum Löschen wird </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht generiert. </font><font style="vertical-align: inherit;">Wenn Sie die Migration anwenden, zurücksetzen und dann erneut anwenden, führt dies zu einem Fehler, da der angegebene Datentyp bereits vorhanden ist.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Löschen Sie den Geschlechtsdatentyp in der Downgrade-Methode</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic <span class="hljs-keyword">import</span> op
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Enum<font></font>
<font></font>
GenderType = Enum(<span class="hljs-string">'female'</span>, <span class="hljs-string">'male'</span>, name=<span class="hljs-string">'gender'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span>():</span><font></font>
    ...<font></font>
    <span class="hljs-comment">#      GenderType   </span>
    op.create_table(<span class="hljs-string">'citizens'</span>, ...,<font></font>
                    Column(<span class="hljs-string">'gender'</span>, GenderType, nullable=<span class="hljs-literal">False</span>))<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
    op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
<font></font>
    <span class="hljs-comment">#       </span>
    GenderType.drop(op.get_bind())</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In der Methode können </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einige Aktionen manchmal entfernt werden (wenn wir die gesamte Tabelle löschen, können Sie ihre Indizes nicht separat löschen):</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zum Beispiel</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
op.drop_table(<span class="hljs-string">'relations'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      citizens,    </span>
<span class="hljs-comment">#    </span>
op.drop_index(op.f(<span class="hljs-string">'ix__citizens__town'</span>), table_name=<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'imports'</span>)</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Migration behoben und bereit ist, wenden wir sie an:</font></font><br>
<br>
<pre><code class="bash hljs">$ analyzer-db upgrade head<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.runtime.migration] Running upgrade  -&gt; d5f704ed4610, Initial</code></pre><br>
<a name="application"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor Sie mit der Erstellung von Handlern beginnen, müssen Sie die aiohttp-Anwendung konfigurieren.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie sich aiohttp quickstart ansehen, können Sie so etwas schreiben</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    logging.basicConfig(level=logging.DEBUG)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = web.Application()<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app.router.add_route(...)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    web.run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Code wirft eine Reihe von Fragen auf und hat eine Reihe von Nachteilen:</font></font><br>
<br>
<ul>
<li> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie konfiguriere ich die Anwendung? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie müssen mindestens den Host und den Port für die Verbindung mit Clients sowie Informationen für die Verbindung mit der Datenbank angeben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich möchte dieses Problem wirklich gerne mit Hilfe des Moduls lösen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>ConfigArgParse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Es erweitert das Standardmodul </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>argparse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und ermöglicht die Verwendung von Befehlszeilenargumenten, Umgebungsvariablen (unverzichtbar für die Konfiguration von Docker-Containern) und sogar Konfigurationsdateien (sowie die Kombination dieser Methoden) für die Konfiguration. </font><font style="vertical-align: inherit;">Mit </font></font><code>ConfigArgParse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dieser Funktion können Sie auch die Werte der Anwendungskonfigurationsparameter überprüfen.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Beispiel für die Verarbeitung von Parametern mit ConfigArgParse</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser, ArgumentDefaultsHelpFormatter<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.argparse <span class="hljs-keyword">import</span> positive_int<font></font>
<font></font>
parser = ArgumentParser(<font></font>
    <span class="hljs-comment">#        ANALYZER_,</span>
    <span class="hljs-comment">#  ANALYZER_API_ADDRESS  ANALYZER_API_PORT</span>
    auto_env_var_prefix=<span class="hljs-string">'ANALYZER_'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#     </span><font></font>
    formatter_class=ArgumentDefaultsHelpFormatter<font></font>
)<font></font>
<font></font>
parser.add_argument(<span class="hljs-string">'--api-address'</span>, default=<span class="hljs-string">'0.0.0.0'</span>,<font></font>
                    help=<span class="hljs-string">'IPv4/IPv6 address API server would listen on'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
parser.add_argument(<span class="hljs-string">'--api-port'</span>, type=positive_int, default=<span class="hljs-number">8081</span>,<font></font>
                    help=<span class="hljs-string">'TCP port API server would listen on'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#   ,     </span>
    <span class="hljs-comment">#  ,    </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#       </span><font></font>
    app = web.Application()<font></font>
    web.run_app(app, host=args.api_address, port=args.api_port)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div><br>
, <code>ConfigArgParse</code>,   <code>argparse</code>,           (     <code>-h</code>  <code>--help</code>).       :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python __main__.py --<span class="hljs-built_in">help</span><font></font>
usage: __main__.py [-h] [--api-address API_ADDRESS] [--api-port API_PORT]<font></font>
<font></font>
If an arg is specified <span class="hljs-keyword">in</span> more than one place, <span class="hljs-keyword">then</span> commandline values override environment variables <span class="hljs-built_in">which</span> override defaults.<font></font>
<font></font>
optional arguments:<font></font>
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><font></font>
  --api-address API_ADDRESS<font></font>
                        IPv4/IPv6 address API server would listen on [env var: ANALYZER_API_ADDRESS] (default: 0.0.0.0)<font></font>
  --api-port API_PORT   TCP port API server would listen on [env var: ANALYZER_API_PORT] (default: 8081)</code></pre></div>
                    </div></li>
<li>             — ,    «»     .          ,  <strong>     </strong>. <br>
<br>
    <code>os.environ.clear()</code>,  Python            (,      <code>asyncio</code>?),        ,   <code>ConfigArgParser</code>.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Callable
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
ENV_VAR_PREFIX = <span class="hljs-string">'ANALYZER_'</span><font></font>
<font></font>
parser = ArgumentParser(auto_env_var_prefix=ENV_VAR_PREFIX)<font></font>
parser.add_argument(<span class="hljs-string">'--pg-url'</span>, type=URL, default=URL(DEFAULT_PG_URL),<font></font>
                   help=<span class="hljs-string">'URL to use to connect to the database'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_environ</span>(<span class="hljs-params">rule: Callable</span>):</span>
    <span class="hljs-string">"""
      ,     
     rule
    """</span>
    <span class="hljs-comment">#   os.environ    tuple,    </span>
    <span class="hljs-comment"># os.environ   </span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> filter(rule, tuple(os.environ)):<font></font>
        os.environ.pop(name)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#      ANALYZER_</span>
    clear_environ(<span class="hljs-keyword">lambda</span> i: i.startswith(ENV_VAR_PREFIX))<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = create_app(args)<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li> <strong>   stderr/      .</strong><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> 9</a> ,    <code>logging.basicConfig()</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>   stderr</code></a>.<br>
<br>
       ,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a>   aiomisc.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    aiomisc</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiomisc.log <span class="hljs-keyword">import</span> basic_config<font></font>
<font></font>
basic_config(logging.DEBUG, buffered=<span class="hljs-literal">True</span>)    
</code></pre></div>
                    </div></li>
<li> <strong>  ,     </strong>    ?    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>fork</code></a>     ,           (,  Windows   ).<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<font></font>
<font></font>
<span class="hljs-keyword">import</span> forklib
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket
<span class="hljs-keyword">from</span> setproctitle <span class="hljs-keyword">import</span> setproctitle<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8081</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
    setproctitle(<span class="hljs-string">f'[Master] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span>
        setproctitle(<span class="hljs-string">f'[Worker] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
        app = Application()<font></font>
        run_app(app, sock=sock)<font></font>
<font></font>
    forklib.fork(os.cpu_count(), worker, auto_restart=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre></div>
                    </div></li>
<li>    <strong>   -    </strong>?  ,      (   —    )    ,      <code>nobody</code>.      —     .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pwd<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8085</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
<font></font>
    user = pwd.getpwnam(<span class="hljs-string">'nobody'</span>)<font></font>
    os.setgid(user.pw_gid)<font></font>
    os.setuid(user.pw_uid)<font></font>
<font></font>
    app = create_app(...)<font></font>
    run_app(app, sock=sock)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li>            <code>create_app</code>,         .</li>
</ul><br>
<a name="serialization"></a><h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle erfolgreichen Handlerantworten werden im JSON-Format zurückgegeben. </font><font style="vertical-align: inherit;">Für Clients wäre es auch praktisch, Informationen über Fehler in serialisierter Form zu erhalten (z. B. um festzustellen, welche Felder die Validierung nicht bestanden haben). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Dokumentation </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bietet eine Methode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://docs.aio"><code>json_response</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mit der ein Objekt übernommen, in JSON serialisiert und ein neues Objekt </font></font><code>aiohttp.web.Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einem Header </font></font><code>Content-Type: application/json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und serialisierten Daten zurückgegeben wird.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So serialisieren Sie Daten mit json_response</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, View, run_app
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> json_response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> json_response({<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt aber noch einen anderen Weg: Mit aiohttp können Sie einen beliebigen Serializer für einen bestimmten Typ von Antwortdaten in der Registrierung registrieren </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Beispielsweise können Sie einen Serializer </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für Objekte vom Typ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapping</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> angeben </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall reicht es aus, wenn der Handler ein Objekt </font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit den Antwortdaten im Parameter zurückgibt </font></font><code>body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">aiohttp findet einen Serializer, der dem Datentyp entspricht, und serialisiert die Antwort. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neben der Tatsache, dass die Serialisierung von Objekten an einer Stelle beschrieben wird, ist dieser Ansatz auch flexibler - Sie können sehr interessante Lösungen implementieren (wir werden einen der Anwendungsfälle im Handler betrachten </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So serialisieren Sie Daten mit aiohttp.PAYLOAD_REGISTRY</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Mapping<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> PAYLOAD_REGISTRY, JsonPayload
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app, Application, Response, View<font></font>
<font></font>
PAYLOAD_REGISTRY.register(JsonPayload, (Mapping, MappingProxyType))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Response(body={<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist wichtig zu verstehen , </font><font style="vertical-align: inherit;">dass </font></font><code>json_response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wie </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sie einen Standard verwenden </font><font style="vertical-align: inherit;">Methode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>json.dumps</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die sich nicht serialize komplexe Datentypen, zum Beispiel, </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder </font></font><code>asyncpg.Record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>asyncpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kehrt Datensätze aus der Datenbank als Instanzen dieser Klasse). </font><font style="vertical-align: inherit;">Darüber hinaus können einige komplexe Objekte andere enthalten: In einem Datensatz aus der Datenbank kann sich ein Typfeld befinden </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python-Entwickler haben dieses Problem behoben: Mit dieser Methode </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">können Sie mithilfe des Arguments </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine Funktion angeben, die aufgerufen wird, wenn ein unbekanntes Objekt serialisiert werden muss. </font><font style="vertical-align: inherit;">Es wird erwartet, dass die Funktion ein unbekanntes Objekt in einen Typ umwandelt, der das JSON-Modul serialisieren kann.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So erweitern Sie JsonPayload, um beliebige Objekte zu serialisieren</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, singledispatch
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.payload <span class="hljs-keyword">import</span> JsonPayload <span class="hljs-keyword">as</span> BaseJsonPayload
<span class="hljs-keyword">from</span> aiohttp.typedefs <span class="hljs-keyword">import</span> JSONEncoder<font></font>
<font></font>
<span class="hljs-meta">@singledispatch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span>(<span class="hljs-params">value</span>):</span>
    <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">f'Unserializable value: <span class="hljs-subst">{value!r}</span>'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(Record)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_asyncpg_record</span>(<span class="hljs-params">value: Record</span>):</span>
    <span class="hljs-string">"""
        , 
    asyncpg
    """</span>
    <span class="hljs-keyword">return</span> dict(value)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(date)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date</span>(<span class="hljs-params">value: date</span>):</span>
    <span class="hljs-string">"""
       date      —  
      .     
      ..
    """</span>
    <span class="hljs-keyword">return</span> value.strftime(<span class="hljs-string">'%d.%m.%Y'</span>)<font></font>
    <font></font>
 <font></font>
dumps = partial(json.dumps, default=convert)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonPayload</span>(<span class="hljs-params">BaseJsonPayload</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,
                 value: Any,
                 encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 dumps: JSONEncoder = dumps,
                 *args: Any,
                 **kwargs: Any</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        super().__init__(value, encoding, content_type, dumps, *args, **kwargs)</code></pre></div>
                    </div><br>
<a name="handlers"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit aiohttp können Sie Handler mit asynchronen Funktionen und Klassen implementieren. </font><font style="vertical-align: inherit;">Klassen sind erweiterbarer: Erstens kann der Code, der zu einem Handler gehört, an einer Stelle platziert werden, und zweitens können Sie mithilfe von Klassen die Vererbung verwenden, um die Codeduplizierung zu beseitigen (z. B. benötigt jeder Handler eine Datenbankverbindung).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler-Basisklasse</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_urldispatcher <span class="hljs-keyword">import</span> View
<span class="hljs-keyword">from</span> asyncpgsa <span class="hljs-keyword">import</span> PG<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>(<span class="hljs-params">View</span>):</span><font></font>
    URL_PATH: str<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pg</span>(<span class="hljs-params">self</span>) -&gt; PG:</span>
        <span class="hljs-keyword">return</span> self.request.app[<span class="hljs-string">'pg'</span>]
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da es schwierig ist, eine große Datei zu lesen, habe ich beschlossen, die Handler in Dateien aufzuteilen. </font><font style="vertical-align: inherit;">Kleine Dateien fördern eine schwache Konnektivität, und wenn beispielsweise Ringimporte in Handlern vorhanden sind, bedeutet dies, dass möglicherweise etwas mit der Zusammensetzung von Entitäten nicht stimmt.</font></font><br>
<br>
<a name="imports_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / Importe</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Eingabehandler empfängt json mit Daten über Bewohner. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die maximal zulässige Anforderungsgröße</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in aiohttp wird von der Option gesteuert </font></font><code>client_max_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://docs.aiohttp.org/en/stable/web_reference.html&amp;usg=ALkJrhgNrt8k96RWkTODfSj1axbWRNah6g#aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beträgt standardmäßig 2 MB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wenn das Limit überschritten wird, gibt aiohttp eine HTTP-Antwort mit dem Status 413: Request Entity Too Large Error zurück. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig wiegt der richtige JSON mit den längsten Zeilen und Zahlen ~ 63 Megabyte, sodass die Einschränkungen für die Größe der Anforderung erweitert werden müssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als nächstes müssen Sie </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Daten überprüfen und deserialisieren</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wenn sie falsch sind, müssen Sie eine HTTP-Antwort zurückgeben </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich brauchte zwei Pläne </font></font><code>Marhsmallow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Der erste </font></font><code>CitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">überprüft die Daten jedes einzelnen Bewohners und deserialisiert auch die Happy Birthday-Zeichenfolge in das Objekt </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datentyp, Format und Verfügbarkeit aller erforderlichen Felder;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mangel an unbekannten Feldern;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Geburtsdatum muss im Format angegeben werden </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und kann für die Zukunft keine Bedeutung haben.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Liste der Verwandten jedes Bewohners muss eindeutige Kennungen der in diesem Upload vorhandenen Bewohner enthalten.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das zweite Schema </font></font><code>ImportSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">überprüft das gesamte Entladen:</font></font><br>
<br>
<ul>
<li><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jeder Bewohner des Entladens sollte eindeutig sein.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Familienbande sollten wechselseitig sein (wenn Bewohner Nr. 1 einen Bewohner Nr. 2 in der Liste der Verwandten hat, muss Bewohner Nr. 2 auch einen Verwandten Nr. 1 haben).</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn die Daten korrekt sind, müssen sie der Datenbank</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einer neuen eindeutigen </font><strong><font style="vertical-align: inherit;">hinzugefügt werden</font></strong></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Daten hinzuzufügen, müssen Sie mehrere Abfragen in verschiedenen Tabellen ausführen. </font><font style="vertical-align: inherit;">Um zu vermeiden, dass im Falle eines Fehlers oder einer Ausnahme teilweise teilweise hinzugefügte Daten in die Datenbank aufgenommen werden (z. B. wenn Sie einen Client trennen, der keine vollständige Antwort erhalten hat, löst aiohttp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine CancelledError-Ausnahme aus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">müssen Sie eine Transaktion verwenden</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist erforderlich, Daten in Teilen zu Tabellen hinzuzufügen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da in einer Abfrage an PostgreSQL nicht mehr als 32.767 Argumente vorhanden sein dürfen. </font><font style="vertical-align: inherit;">Die Tabelle enthält </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 Felder. </font><font style="vertical-align: inherit;">Dementsprechend können für 1 Abfrage nur 32.767 / 9 = 3.640 Zeilen in diese Tabelle eingefügt werden, und in einem Upload können bis zu 10.000 Einwohner vorhanden sein.</font></font><br>
<br>
<a name="citizens_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Bürger</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Handler gibt alle Bewohner zum Entladen mit der angegebenen zurück </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn der angegebene </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upload nicht vorhanden ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , müssen Sie die HTTP-Antwort 404: Not Found zurückgeben. </font><font style="vertical-align: inherit;">Dieses Verhalten scheint bei Handlern üblich zu sein, die eine vorhandene Entladung benötigen. Daher habe ich den Bestätigungscode in eine separate Klasse gezogen.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basisklasse für Handler mit Entladungen</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_exceptions <span class="hljs-keyword">import</span> HTTPNotFound
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, exists<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> imports_table<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseImportView</span>(<span class="hljs-params">BaseView</span>):</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> int(self.request.match_info.get(<span class="hljs-string">'import_id'</span>))<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_import_exists</span>(<span class="hljs-params">self</span>):</span><font></font>
        query = select([<font></font>
            exists().where(imports_table.c.import_id == self.import_id)<font></font>
        ])<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">await</span> self.pg.fetchval(query):
            <span class="hljs-keyword">raise</span> HTTPNotFound()
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um eine Liste der Verwandten für jeden Bewohner zu erhalten, müssen Sie </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">von Tabelle </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zu Tabelle arbeiten </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und das </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nach </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font><font style="vertical-align: inherit;">gruppierte </font><font style="vertical-align: inherit;">Feld aggregieren </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der Bewohner keine Verwandten hat, gibt er </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wert </font><font style="vertical-align: inherit;">für ihn vor Ort zurück, </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und als Ergebnis der Aggregation sieht die Liste der Verwandten so aus </font></font><code>[NULL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um diesen falschen Wert zu beheben, habe ich die Funktion </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_remove</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verwendet </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Datenbank speichert das Datum in einem Format </font></font><code>YYYY-MM-DD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aber wir benötigen ein Format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Technisch gesehen können Sie das Datum entweder mit einer SQL-Abfrage oder auf der Python-Seite zum Zeitpunkt der Serialisierung der Antwort mit </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">formatieren (asyncpg gibt den Feldwert </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">als Instanz der Klasse zurück</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mich für die Serialisierung auf der Python-Seite entschieden, da dies </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">das einzige Objekt </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Projekt mit einem einzigen Format ist (siehe Abschnitt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„Serialisierung von Daten“</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz der Tatsache, dass der Prozessor zwei Anforderungen ausführt (Überprüfung auf das Vorhandensein eines Entladens und eine Anforderung für eine Liste von Bewohnern), ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es nicht erforderlich, eine Transaktion zu verwenden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Standardmäßig verwendet PostgreSQL die Isolationsstufe, </font></font><code>READ COMMITTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und selbst innerhalb einer Transaktion werden alle Änderungen an anderen, erfolgreich abgeschlossenen Transaktionen sichtbar (Hinzufügen neuer Zeilen, Ändern vorhandener).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der größte Upload in einer Textansicht kann ~ 63 Megabyte dauern - dies ist ziemlich viel, insbesondere wenn man bedenkt, dass mehrere Anforderungen zum Empfangen von Daten gleichzeitig eingehen können. </font><font style="vertical-align: inherit;">Es gibt eine interessante Möglichkeit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Daten mit dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cursor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus der Datenbank </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">abzurufen</font></a><font style="vertical-align: inherit;"> und in Teilen an den Client zu senden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu müssen wir zwei Objekte implementieren:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typ - </font><font style="vertical-align: inherit;">Objekt , </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">das Datensätze aus der Datenbank zurückgibt. </font><font style="vertical-align: inherit;">Beim ersten Aufruf wird eine Verbindung zur Datenbank hergestellt, eine Transaktion geöffnet und ein Cursor erstellt. Während der weiteren Iteration werden Datensätze aus der Datenbank zurückgegeben. </font><font style="vertical-align: inherit;">Es wird vom Handler zurückgegeben.</font></font><br>
 <br>
 <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SelectQuery Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> AsyncIterable
<span class="hljs-keyword">from</span> asyncpgsa.transactionmanager <span class="hljs-keyword">import</span> ConnectionTransactionContextManager
<span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> Select<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectQuery</span>(<span class="hljs-params">AsyncIterable</span>):</span>
    <span class="hljs-string">"""
    ,     PostgreSQL   
    ,  ,    
    """</span>
    PREFETCH = <span class="hljs-number">500</span><font></font>
<font></font>
    __slots__ = (<font></font>
        <span class="hljs-string">'query'</span>, <span class="hljs-string">'transaction_ctx'</span>, <span class="hljs-string">'prefetch'</span>, <span class="hljs-string">'timeout'</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query: Select,
                 transaction_ctx: ConnectionTransactionContextManager,
                 prefetch: int = None,
                 timeout: float = None</span>):</span><font></font>
        self.query = query<font></font>
        self.transaction_ctx = transaction_ctx<font></font>
        self.prefetch = prefetch <span class="hljs-keyword">or</span> self.PREFETCH<font></font>
        self.timeout = timeout<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.transaction_ctx <span class="hljs-keyword">as</span> conn:<font></font>
            cursor = conn.cursor(self.query, prefetch=self.prefetch,<font></font>
                                 timeout=self.timeout)<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
                <span class="hljs-keyword">yield</span> row
</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein Serializer </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, der über asynchrone Generatoren iterieren, Daten von einem asynchronen Generator an JSON serialisieren und Daten in Teilen an Clients senden kann. </font><font style="vertical-align: inherit;">Es ist </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">als Serializer von Objekten </font><font style="vertical-align: inherit;">registriert </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncGenJSONListPayload-Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> Payload<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># ,    JSON  asyncpg.Record  datetime.date</span>
dumps = partial(json.dumps, default=convert, ensure_ascii=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncGenJSONListPayload</span>(<span class="hljs-params">Payload</span>):</span>
    <span class="hljs-string">"""
       AsyncIterable,     
     JSON   
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 root_object: str = <span class="hljs-string">'data'</span>,
                 *args, **kwargs</span>):</span><font></font>
        self.root_object = root_object<font></font>
        super().__init__(value, content_type=content_type, encoding=encoding,<font></font>
                         *args, **kwargs)<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">self, writer</span>):</span>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<font></font>
            (<span class="hljs-string">'{"%s":['</span> % self.root_object).encode(self._encoding)<font></font>
        )<font></font>
<font></font>
        first = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> self._value:
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> first:
                <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b','</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                first = <span class="hljs-literal">False</span><font></font>
<font></font>
            <span class="hljs-keyword">await</span> writer.write(dumps(row).encode(self._encoding))<font></font>
<font></font>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b']}'</span>)</code></pre></div>
                    </div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus ist es im Handler möglich, ein Objekt zu erstellen </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, eine SQL-Abfrage und eine Funktion zu übergeben, um die Transaktion zu öffnen und an Folgendes zurückzugeben </font></font><code>Response body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler-Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/api/handlers/citizens.py</span>
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> aiohttp_apispec <span class="hljs-keyword">import</span> docs, response_schema<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.schema <span class="hljs-keyword">import</span> CitizensResponseSchema
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> citizens_table <span class="hljs-keyword">as</span> citizens_t
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> SelectQuery<font></font>
<font></font>
<span class="hljs-keyword">from</span> .query <span class="hljs-keyword">import</span> CITIZENS_QUERY
<span class="hljs-keyword">from</span> .base <span class="hljs-keyword">import</span> BaseImportView<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CitizensView</span>(<span class="hljs-params">BaseImportView</span>):</span>
    URL_PATH = <span class="hljs-string">r'/imports/{import_id:\d+}/citizens'</span><font></font>
<font></font>
<span class="hljs-meta">    @docs(summary='    ')</span>
<span class="hljs-meta">    @response_schema(CitizensResponseSchema())</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">await</span> self.check_import_exists()<font></font>
<font></font>
        query = CITIZENS_QUERY.where(<font></font>
            citizens_t.c.import_id == self.import_id<font></font>
        )<font></font>
        body = SelectQuery(query, self.pg.transaction())<font></font>
        <span class="hljs-keyword">return</span> Response(body=body)
</code></pre></div>
                    </div><br>
<code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es erkennt einen registrierten </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serializer </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für Objekte vom Typ </font><font style="vertical-align: inherit;">in der Registrierung </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dann iteriert der Serializer über das Objekt </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und sendet Daten an den Client. Beim ersten Aufruf </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">empfängt </font><font style="vertical-align: inherit;">das Objekt </font><font style="vertical-align: inherit;">eine Verbindung zur Datenbank, öffnet eine Transaktion und erstellt einen Cursor. Während der weiteren Iteration empfängt es mit dem Cursor Daten aus der Datenbank und gibt sie zeilenweise zurück. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Ansatz ermöglicht es, nicht bei jeder Anforderung Speicher für die gesamte Datenmenge zuzuweisen, hat jedoch eine Besonderheit: Die Anwendung kann den entsprechenden HTTP-Status nicht an den Client zurückgeben, wenn ein Fehler auftritt (schließlich wurden der HTTP-Status, Header bereits an den Client gesendet und Daten werden geschrieben).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn eine Ausnahme auftritt, bleibt nichts anderes übrig, als die Verbindung zu trennen. </font><font style="vertical-align: inherit;">Eine Ausnahme kann natürlich gesichert werden, aber der Client kann nicht genau verstehen, welcher Fehler aufgetreten ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Andererseits kann eine ähnliche Situation auftreten, selbst wenn der Prozessor alle Daten aus der Datenbank empfängt, das Netzwerk jedoch blinkt, während Daten an den Client übertragen werden - niemand ist davor sicher.</font></font><br>
<br>
<a name="update_citizen_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / bürger / $ bürger_id</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Handler erhält die Kennung des Entladens </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, des Bewohners </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sowie von json mit den neuen Daten über den Bewohner. </font><font style="vertical-align: inherit;">Im Falle eines </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht vorhandenen Entladens oder eines residenten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ereignisses muss eine HTTP-Antwort zurückgegeben werden </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die vom Kunden übermittelten Daten müssen </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">überprüft und deserialisiert werden</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wenn sie falsch sind, müssen Sie eine HTTP-Antwort zurückgeben </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ich habe ein Marshmallow-Schema implementiert, das Folgendes </font></font><code>PatchCitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">überprüft:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Art und Format der Daten für die angegebenen Felder.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geburtsdatum. </font><font style="vertical-align: inherit;">Es muss in einem Format angegeben werden </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und kann für die Zukunft nicht von Bedeutung sein.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine Liste der Verwandten jedes Bewohners. </font><font style="vertical-align: inherit;">Es muss eindeutige Kennungen für die Bewohner haben.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Existenz der im Feld angegebenen Verwandten </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kann nicht separat überprüft werden: Wenn der Tabelle ein </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht vorhandener Bewohner </font><font style="vertical-align: inherit;">hinzugefügt wird, gibt </font><font style="vertical-align: inherit;">PostgreSQL einen Fehler zurück </font></font><code>ForeignKeyViolationError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, der verarbeitet werden kann, und der HTTP-Status kann zurückgegeben werden </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Welcher Status sollte zurückgegeben werden, wenn der Client </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falsche Daten für einen nicht vorhandenen Bewohner</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gesendet </font><b><font style="vertical-align: inherit;">oder entladen hat</font></b><font style="vertical-align: inherit;"> ? Es ist semantisch korrekter, zuerst das Vorhandensein eines Entladens und eines Bewohners zu überprüfen (wenn es keine gibt, Rückgabe </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) und erst dann, ob der Client die richtigen Daten gesendet hat (wenn nicht, Rückgabe </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). In der Praxis ist es oft günstiger, die Daten zuerst zu überprüfen und nur dann auf die Datenbank zuzugreifen, wenn sie korrekt sind.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beide Optionen sind akzeptabel, aber ich habe mich für eine günstigere zweite Option entschieden, da das Ergebnis der Operation in jedem Fall ein Fehler ist, der nichts beeinflusst (der Client korrigiert die Daten und stellt dann auch fest, dass der Bewohner nicht existiert). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Daten korrekt sind, müssen </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Informationen über den Bewohner in der Datenbank aktualisiert werden</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Im Handler müssen Sie mehrere Abfragen an verschiedene Tabellen durchführen. Wenn ein Fehler oder eine Ausnahme auftritt, müssen die Änderungen an der Datenbank rückgängig gemacht werden, sodass </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abfragen in einer Transaktion ausgeführt werden müssen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit dieser Methode </font></font><code>PATCH</code> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">können Sie nur einige Felder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für einen Bewohner übertragen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Handler muss so geschrieben sein, dass er beim Zugriff auf Daten, die der Client nicht angegeben hat, nicht abstürzt und keine Abfragen für Tabellen ausführt, in denen sich die Daten nicht geändert haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der Kunde das Feld angegeben hat </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, muss eine Liste der vorhandenen Verwandten abgerufen werden. Wenn es sich geändert hat, bestimmen Sie, welche Datensätze aus der Tabelle </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gelöscht und welche hinzugefügt werden müssen, um die Datenbank mit der Anforderung des Clients in Einklang zu bringen. Standardmäßig verwendet PostgreSQL die Transaktionsisolation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code> READ COMMITTED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dies bedeutet, dass im Rahmen der aktuellen Transaktion Änderungen für vorhandene (sowie neue) Datensätze anderer abgeschlossener Transaktionen sichtbar sind. Dies kann zu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einer Rennbedingung zwischen Wettbewerbsanforderungen führen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, es wird mit den Bewohnern entladen</font></font><code>#1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>#2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>#3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ohne Verwandtschaft. Der Dienst erhält zwei gleichzeitige Anforderungen zum Ändern des Bewohners Nr. 1: </font></font><code><nobr>{"relatives": [2]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code><nobr>{"relatives": [3]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. aiohttp erstellt zwei Handler, die gleichzeitig den aktuellen Status des Bewohners von PostgreSQL empfangen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder Handler erkennt keine einzelne verwandte Beziehung und beschließt, eine neue Beziehung mit dem angegebenen Verwandten hinzuzufügen. Infolgedessen hat Einwohner Nr. 1 das gleiche Feld wie Verwandte </font></font><code>[2,3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/bk/mz/gobkmzuhzr47rfzgvtygkxb1stm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Verhalten kann nicht als offensichtlich bezeichnet werden. Es werden zwei Optionen erwartet, um über das Ergebnis des Rennens zu entscheiden: Nur die erste Anforderung abzuschließen und für die zweite eine HTTP-Antwort zurückzugeben </font></font><br>
<code>409: Conflict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(damit der Client die Anforderung wiederholt) oder Anforderungen nacheinander auszuführen (die zweite Anforderung wird erst verarbeitet, nachdem die erste abgeschlossen ist). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die erste Option kann durch Aktivieren des Isolationsmodus implementiert werden</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>SERIALIZABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Wenn es während der Verarbeitung der Anforderung bereits jemandem gelungen ist, die Daten zu ändern und festzuschreiben, wird eine Ausnahme ausgelöst, die verarbeitet und der entsprechende HTTP-Status zurückgegeben werden kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Nachteil dieser Lösung - eine große Anzahl von Sperren in PostgreSQL - </font></font><code>SERIALIZABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">löst eine Ausnahme aus, selbst wenn Wettbewerbsabfragen die Aufzeichnungen von Bewohnern aus verschiedenen Entladungen ändern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können auch den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empfehlungssperrmechanismus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verwenden </font><font style="vertical-align: inherit;">. Wenn Sie eine solche Sperre erhalten </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, können wettbewerbsfähige Anforderungen für verschiedene Entladungen parallel ausgeführt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um wettbewerbsfähige Anforderungen in einem Upload zu verarbeiten, können Sie das Verhalten einer der folgenden Optionen implementieren: Die Funktion </font></font><code>pg_try_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versucht, eine Sperre und zu erhalten</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt das boolesche Ergebnis sofort zurück (wenn es nicht möglich war, die Sperre zu erhalten, kann eine Ausnahme ausgelöst werden) und </font></font><code>pg_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wartet, bis die </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ressource zum Blockieren verfügbar ist (in diesem Fall werden die Anforderungen nacheinander ausgeführt, ich habe mich für diese Option entschieden). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen muss der Handler </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die aktuellen Informationen über den aktualisierten Bewohner zurückgeben</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es war möglich, uns darauf zu beschränken, Daten von seiner Anfrage an den Kunden zurückzugeben (da wir eine Antwort an den Kunden zurücksenden, bedeutet dies, dass es keine Ausnahmen gab und alle Anfragen erfolgreich abgeschlossen wurden). Oder - verwenden Sie das Schlüsselwort RETURNING in Abfragen, die die Datenbank ändern und aus den Ergebnissen eine Antwort generieren. Beide Ansätze würden es uns jedoch nicht erlauben, den Fall mit der Rasse der Staaten zu sehen und zu testen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab keine hohen Lastanforderungen für den Dienst, daher habe ich beschlossen, alle Daten über den Bewohner erneut anzufordern und dem Kunden ein ehrliches Ergebnis aus der Datenbank zurückzugeben. </font></font><br>
<br>
<a name="citizen_birthdays_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Bürger / Geburtstage</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Handler berechnet die Anzahl der Geschenke, die jeder Bewohner des Entladens an seine Verwandten erhält (erste Bestellung). </font><font style="vertical-align: inherit;">Die Nummer wird nach Monat zum Hochladen mit der angegebenen Nummer gruppiert </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Bei einem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht vorhandenen Upload</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muss eine HTTP-Antwort zurückgegeben werden </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt zwei Implementierungsoptionen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rufen Sie Daten für Einwohner mit Verwandten aus der Datenbank ab und aggregieren Sie auf Python-Seite Daten nach Monat und generieren Sie Listen für die Monate, für die keine Daten in der Datenbank vorhanden sind.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kompilieren Sie eine JSON-Anfrage in der Datenbank und fügen Sie Stubs für die fehlenden Monate hinzu.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mich für die erste Option entschieden - visuell sieht sie verständlicher und unterstützter aus. Die Anzahl der Geburtstage in einem bestimmten Monat kann ermittelt werden, indem </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus der Tabelle mit familiären Bindungen ( </font></font><code>relations.citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- dem Bewohner, für den wir die Geburtstage von Verwandten betrachten) die Tabelle </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(mit dem Geburtsdatum, von dem Sie den Monat erhalten möchten) hervorgeht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monatswerte dürfen keine führenden Nullen enthalten. Der </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit der Funktion </font><font style="vertical-align: inherit;">aus dem Feld erhaltene Monat </font></font><code>date_part</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kann eine führende Null enthalten. Um sie </font><font style="vertical-align: inherit;">zu entfernen, führte ich </font></font><code>cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zu </font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in der SQL - </font><font style="vertical-align: inherit;">Abfrage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz der Tatsache, dass der Handler zwei Anforderungen erfüllen muss (überprüfen Sie das Vorhandensein des Entladens und erhalten Sie Informationen zu Geburtstagen und Geschenken), ist eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transaktion nicht erforderlich</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Standardmäßig verwendet PostgreSQL den READ COMMITTED-Modus, in dem alle neuen (durch andere Transaktionen hinzugefügten) und vorhandenen (durch andere Transaktionen geänderten) Datensätze in der aktuellen Transaktion sichtbar sind, nachdem sie erfolgreich abgeschlossen wurden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn beispielsweise zum Zeitpunkt des Empfangs der Daten ein neuer Upload hinzugefügt wird, hat dies keine Auswirkungen auf die vorhandenen. </font><font style="vertical-align: inherit;">Wenn zum Zeitpunkt des Empfangs der Daten eine Anforderung zum Ändern des Bewohners erfüllt ist, sind entweder die Daten noch nicht sichtbar (wenn die Transaktion zum Ändern der Daten noch nicht abgeschlossen wurde) oder die Transaktion wird vollständig abgeschlossen und alle Änderungen werden sofort sichtbar. </font><font style="vertical-align: inherit;">Die aus der Datenbank erhaltene Integrität wird nicht verletzt.</font></font><br>
<br>
<a name="town_age_stat_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Towns / Stat / Perzentil / Alter</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Handler berechnet das 50., 75. und 99. Perzentil des Alters (volle Jahre) der Einwohner nach Stadt in der Stichprobe mit der angegebenen import_id. </font><font style="vertical-align: inherit;">Bei einem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht vorhandenen Upload</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muss eine HTTP-Antwort zurückgegeben werden </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trotz der Tatsache, dass der Prozessor zwei Anforderungen ausführt (Überprüfung auf das Vorhandensein des Entladens und Abrufen einer Liste von Bewohnern), ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es nicht erforderlich, eine Transaktion zu verwenden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt zwei Implementierungsoptionen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Holen Sie sich das Alter der Einwohner aus der Datenbank, gruppiert nach Stadt, und berechnen Sie dann auf der Python-Seite die Perzentile mit numpy (das in der Aufgabe als Referenz angegeben wird) und runden Sie auf zwei Dezimalstellen auf.</font></font></li>
<li>     PostgreSQL:  percentile_cont     ,             SQL-,  numpy   .</li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die zweite Option erfordert weniger Datenübertragung zwischen der Anwendung und PostgreSQL, weist jedoch keine offensichtliche Gefahr auf: In PostgreSQL ist die Rundung mathematisch ( </font></font><code>SELECT ROUND(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rückgabe 3) und in Python - Accounting auf die nächste Ganzzahl ( </font></font><code>round(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rückgabe 2). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den Handler zu testen, muss die Implementierung in PostgreSQL und Python identisch sein (die Implementierung einer Funktion mit mathematischer Rundung in Python sieht einfacher aus). </font><font style="vertical-align: inherit;">Es ist anzumerken, dass bei der Berechnung von Perzentilen numpy und PostgreSQL leicht unterschiedliche Zahlen zurückgeben können. Angesichts der Rundung ist dieser Unterschied jedoch nicht erkennbar.</font></font><br>
<br>
<a name="testing"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testen</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was muss in dieser Anwendung überprüft werden? Erstens, dass die Handler die Anforderungen erfüllen und die erforderlichen Arbeiten in einer Umgebung ausführen, die so nah wie möglich an der Kampfumgebung liegt. Zweitens funktionieren Migrationen, die den Status der Datenbank ändern, fehlerfrei. Drittens gibt es eine Reihe von Hilfsfunktionen, die auch durch Tests korrekt abgedeckt werden könnten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mich wegen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seiner Flexibilität und Benutzerfreundlichkeit für </font><font style="vertical-align: inherit;">das </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Pytest-Framework</font></a><font style="vertical-align: inherit;"> entschieden </font><font style="vertical-align: inherit;">. Es bietet einen leistungsstarken Mechanismus zur Vorbereitung der Umgebung für Tests - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorrichtungen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">dh</font></a><font style="vertical-align: inherit;"> Funktionen mit einem Dekorateur</font></font><code>pytest.mark.fixture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deren Namen können durch den Parameter im Test angegeben werden. </font><font style="vertical-align: inherit;">Wenn pytest einen Parameter mit einem Fixture-Namen in der Testanmerkung erkennt, führt es dieses Fixture aus und übergibt das Ergebnis an den Wert dieses Parameters. </font><font style="vertical-align: inherit;">Wenn das Gerät ein Generator ist, nimmt der Testparameter den zurückgegebenen Wert an </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, und nach Abschluss des Tests wird der zweite Teil des </font><font style="vertical-align: inherit;">Geräts </font><font style="vertical-align: inherit;">ausgeführt, wodurch Ressourcen gelöscht oder Verbindungen geschlossen werden können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für die meisten Tests benötigen wir eine PostgreSQL-Datenbank. </font><font style="vertical-align: inherit;">Um Tests voneinander zu isolieren, können Sie vor jedem Test eine separate Datenbank erstellen und nach der Ausführung löschen.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie für jeden Test eine Fixture-Datenbank</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy_utils <span class="hljs-keyword">import</span> create_database, drop_database
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
PG_URL = os.getenv(<span class="hljs-string">'CI_ANALYZER_PG_URL'</span>, DEFAULT_PG_URL)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">postgres</span>():</span>
    tmp_name = <span class="hljs-string">'.'</span>.join([uuid.uuid4().hex, <span class="hljs-string">'pytest'</span>])<font></font>
    tmp_url = str(URL(PG_URL).with_path(tmp_name))<font></font>
    create_database(tmp_url)<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#      postgres  -</span>
        <span class="hljs-keyword">yield</span> tmp_url
    <span class="hljs-keyword">finally</span>:<font></font>
        drop_database(tmp_url)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_db</span>(<span class="hljs-params">postgres</span>):</span>
    <span class="hljs-string">"""
     ,  PostgreSQL
    """</span><font></font>
    engine = create_engine(postgres)<font></font>
    <span class="hljs-keyword">assert</span> engine.execute(<span class="hljs-string">'SELECT 1'</span>).scalar() == <span class="hljs-number">1</span>
    engine.dispose()</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Modul </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlalchemy_utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hat diese Aufgabe </font><font style="vertical-align: inherit;">unter Berücksichtigung der Funktionen verschiedener Datenbanken und Treiber </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">hervorragend</font></a><font style="vertical-align: inherit;"> erledigt </font><font style="vertical-align: inherit;">. Beispielsweise erlaubt PostgreSQL keine Ausführung </font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einem Transaktionsblock. Beim Erstellen einer Datenbank wird diese </font><font style="vertical-align: inherit;">in den Autocommit-Modus </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">übersetzt </font></font><code>psycopg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(der normalerweise alle Anforderungen in einer Transaktion ausführt). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiteres wichtiges Merkmal: Wenn mindestens ein Client mit PostgreSQL verbunden ist, kann die Datenbank nicht gelöscht werden, </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trennt jedoch alle Clients, bevor die Datenbank </font><font style="vertical-align: inherit;">gelöscht wird </font><font style="vertical-align: inherit;">. Die Datenbank wird erfolgreich gelöscht, auch wenn ein Test mit aktiven Verbindungen zu ihr hängt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir benötigen PostgreSQL in verschiedenen Zuständen: Zum Testen von Migrationen benötigen wir eine saubere Datenbank, während Handler die Anwendung aller Migrationen erfordern. </font><font style="vertical-align: inherit;">Sie können den Status einer Datenbank mithilfe von Alembic-Befehlen programmgesteuert ändern. Dazu muss das Alembic-Konfigurationsobjekt aufgerufen werden.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie ein Fixture Alembic-Konfigurationsobjekt</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> SimpleNamespace<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> make_alembic_config<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alembic_config</span>(<span class="hljs-params">postgres</span>):</span>
    cmd_options = SimpleNamespace(config=<span class="hljs-string">'alembic.ini'</span>, name=<span class="hljs-string">'alembic'</span>,<font></font>
                                  pg_url=postgres, raiseerr=<span class="hljs-literal">False</span>, x=<span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> make_alembic_config(cmd_options)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bitte beachten Sie, dass Geräte </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einen Parameter haben </font></font><code>postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit dem nicht nur die Abhängigkeit des Tests von Geräten angezeigt werden kann, sondern auch die Abhängigkeiten zwischen Geräten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Mechanismus können Sie die Logik flexibel trennen und sehr präzisen und wiederverwendbaren Code schreiben.</font></font><br>
<br>
<a name="testing_handlers"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Testen von Handlern ist eine Datenbank mit erstellten Tabellen und Datentypen erforderlich. Um Migrationen anzuwenden, müssen Sie programmgesteuert den Befehl upgrade Alembic aufrufen. Um es aufzurufen, benötigen Sie ein Objekt mit der Alembic-Konfiguration, die wir bereits mit Fixtures definiert haben </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Die Datenbank mit Migrationen sieht aus wie eine völlig unabhängige Entität und kann als Fixture dargestellt werden:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic.command <span class="hljs-keyword">import</span> upgrade<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrated_postgres</span>(<span class="hljs-params">alembic_config, postgres</span>):</span>
    upgrade(alembic_config, <span class="hljs-string">'head'</span>)
    <span class="hljs-comment">#  DSN  ,    </span>
    <span class="hljs-keyword">return</span> postgres</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn das Projekt viele Migrationen enthält, kann die Anwendung für jeden Test zu lange dauern. Um den Prozess zu beschleunigen, können Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine Datenbank mit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einmaligen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Migrationen erstellen</font></a><font style="vertical-align: inherit;"> und diese dann </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">als Vorlage verwenden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zusätzlich zur Datenbank zum Testen von Handlern benötigen Sie eine laufende Anwendung sowie einen Client, der für die Arbeit mit dieser Anwendung konfiguriert ist. Um das Testen der Anwendung zu vereinfachen, habe ich ihre Erstellung in eine Funktion </font></font><code>create_app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eingefügt, für deren Ausführung Parameter </font><font style="vertical-align: inherit;">erforderlich sind </font><font style="vertical-align: inherit;">: eine Datenbank, ein Port für die REST-API und andere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Argumente zum Starten der Anwendung können auch als separates Gerät dargestellt werden. Um sie zu erstellen, müssen Sie den freien Port zum Ausführen der Testanwendung und die Adresse für die migrierte temporäre Datenbank ermitteln.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den freien Port zu bestimmen, habe ich das Gerät </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus dem Aiomisc-Paket verwendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Standard-Fixture </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wäre ebenfalls in Ordnung, gibt jedoch eine Funktion zum Ermitteln freier Ports zurück, während </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Portnummer sofort zurückgegeben wird. </font><font style="vertical-align: inherit;">Für unsere Anwendung müssen wir nur einen freien Port bestimmen, daher habe ich beschlossen, bei einem Aufruf keine zusätzliche Codezeile zu schreiben </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arguments</span>(<span class="hljs-params">aiomisc_unused_port, migrated_postgres</span>):</span>
    <span class="hljs-keyword">return</span> parser.parse_args(<font></font>
        [<font></font>
            <span class="hljs-string">'--log-level=debug'</span>,
            <span class="hljs-string">'--api-address=127.0.0.1'</span>,
            <span class="hljs-string">f'--api-port=<span class="hljs-subst">{aiomisc_unused_port}</span>'</span>,
            <span class="hljs-string">f'--pg-url=<span class="hljs-subst">{migrated_postgres}</span>'</span><font></font>
        ]<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Tests mit Handlern implizieren Anforderungen an die REST-API. Eine direkte Arbeit mit der Anwendung ist </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht erforderlich. </font><font style="vertical-align: inherit;">Aus diesem Grund habe ich ein Gerät erstellt, das die Anwendung startet und mithilfe der Factory </font></font><code>aiohttp_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einen Standardtest-Client erstellt und zurückgibt, der mit der Anwendung verbunden ist </font></font><code>aiohttp.test_utils.TestClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api_client</span>(<span class="hljs-params">aiohttp_client, arguments</span>):</span><font></font>
    app = create_app(arguments)<font></font>
    client = <span class="hljs-keyword">await</span> aiohttp_client(app, server_kwargs={
        <span class="hljs-string">'port'</span>: arguments.api_port<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> client
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie nun in den Testparametern eine Vorrichtung angeben </font></font><code>api_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, geschieht Folgendes:</font></font><br>
<br>
<ol>
<li> <code>postgres</code>    (  <code>migrated_postgres</code>).</li>
<li> <code>alembic_config</code>    Alembic,      (  <code>migrated_postgres</code>).</li>
<li> <code>migrated_postgres</code>   (  <code>arguments</code>).</li>
<li> <code>aiomisc_unused_port</code>    (  <code>arguments</code>).</li>
<li> <code>arguments</code>     (  <code>api_client</code>).</li>
<li> <code>api_client</code>          .</li>
<li> .</li>
<li> <code>api_client</code>     .</li>
<li> <code>postgres</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit Fixtures können Sie Doppelcode vermeiden, aber zusätzlich zur Vorbereitung der Umgebung in den Tests gibt es einen weiteren potenziellen Ort, an dem viele der gleichen Code-Anwendungsanforderungen auftreten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir eine Anfrage stellen, erwarten wir zunächst einen bestimmten HTTP-Status. Zweitens, wenn der Status mit dem erwarteten übereinstimmt, müssen Sie vor dem Arbeiten mit den Daten sicherstellen, dass sie das richtige Format haben. Es ist leicht, hier einen Fehler zu machen und einen Handler zu schreiben, der die richtigen Berechnungen durchführt und </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">das richtige Ergebnis zurückgibt, aber aufgrund des falschen Antwortformats keine automatische Validierung besteht</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (vergessen Sie beispielsweise, die Antwort mit einem Schlüssel in ein Wörterbuch zu packen </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Alle diese Überprüfungen könnten an einem Ort durchgeführt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Modul</font></font><code>analyzer.testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ich habe für jeden Handler eine Hilfsfunktion vorbereitet, die den Status von HTTP sowie das Antwortformat mit Marshmallow überprüft. </font></font><br>
<br>
<a name="test_citizens_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Bürger</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe beschlossen, mit einem Handler zu beginnen, der Bewohner zurückgibt, da dies sehr nützlich ist, um die Ergebnisse anderer Handler zu überprüfen, die den Status der Datenbank ändern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe absichtlich keinen Code verwendet, der der Datenbank Daten vom Handler hinzufügt </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, obwohl es nicht schwierig ist, daraus eine separate Funktion zu machen. </font><font style="vertical-align: inherit;">Der Code der Handler kann geändert werden. Wenn der Code, der der Datenbank hinzugefügt wird, einen Fehler enthält, funktioniert der Test möglicherweise nicht mehr wie beabsichtigt und implizit für Entwickler werden keine Fehler mehr angezeigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für diesen Test habe ich folgende Testdatensätze definiert:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entladen mit mehreren Verwandten. </font><font style="vertical-align: inherit;">Überprüft, ob für jeden Einwohner eine Liste mit Kennungen von Verwandten korrekt erstellt wird.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entladen mit einem Bewohner ohne Verwandte. </font><font style="vertical-align: inherit;">Überprüft, ob das Feld </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine leere Liste ist (aufgrund </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der SQL-Abfrage kann die Liste der Verwandten gleich sein </font></font><code>[None]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entladen mit einem Bewohner, der ein Verwandter von sich selbst ist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leeres Entladen. </font><font style="vertical-align: inherit;">Überprüft, ob der Handler das Hinzufügen eines leeren Entladens zulässt und nicht mit einem Fehler abstürzt.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den gleichen Test bei jedem Upload separat durchzuführen, habe ich einen anderen sehr leistungsfähigen Pytest-Mechanismus verwendet - die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parametrisierung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mit diesem Mechanismus können Sie die Testfunktion in den Dekorator einbinden </font></font><code>pytest.mark.parametrize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und darin beschreiben, welche Parameter die Testfunktion für jeden einzelnen Testfall annehmen soll.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So parametrisieren Sie einen Test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
datasets = [<font></font>
    <span class="hljs-comment">#    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">3</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   </span><font></font>
    [<font></font>
        generate_citizen(relatives=[])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   ,    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, name=<span class="hljs-string">''</span>, gender=<span class="hljs-string">'male'</span>,<font></font>
                         birth_date=<span class="hljs-string">'17.02.2020'</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    [],<font></font>
]<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.mark.parametrize('dataset', datasets)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_citizens</span>(<span class="hljs-params">api_client, dataset</span>):</span>
    <span class="hljs-string">"""
        4 ,    
    """</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Test fügt also den Upload zur Datenbank hinzu. Anschließend erhält er mithilfe einer Anfrage an den Handler Informationen zu den Bewohnern und vergleicht den Referenz-Upload mit dem empfangenen. Aber wie vergleicht man die Bewohner? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder Bewohner besteht aus Skalarfeldern und einem Feld </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- einer Liste von Kennungen von Verwandten. Eine Liste in Python ist ein geordneter Typ, und beim Vergleichen der Reihenfolge der Elemente jeder Liste spielt dies eine Rolle. Beim Vergleichen von Listen mit Geschwistern sollte die Reihenfolge jedoch keine Rolle spielen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vor dem Vergleich zum Set </font><font style="vertical-align: inherit;">bringen </font><font style="vertical-align: inherit;">, funktioniert es beim Vergleich nicht, eine Situation zu finden, in der einer der Bewohner des Feldes </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Duplikate hat. Wenn Sie die Liste mit den Kennungen von Verwandten sortieren, wird das Problem der unterschiedlichen Reihenfolge der Kennungen von Verwandten umgangen, gleichzeitig werden jedoch Duplikate erkannt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Vergleich zweier Listen mit Bewohnern kann es zu einem ähnlichen Problem kommen: Technisch gesehen ist die Reihenfolge der Bewohner beim Entladen nicht wichtig, es ist jedoch wichtig zu erkennen, ob sich bei einem Entladen zwei Bewohner mit denselben Kennungen befinden und bei dem anderen nicht. </font><font style="vertical-align: inherit;">Zusätzlich zum Sortieren der Liste mit Verwandten müssen Verwandte für jeden Bewohner die Bewohner bei jedem Entladen arrangieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da sich die Aufgabe des Vergleichs von Bewohnern mehr als einmal stellen wird, habe ich zwei Funktionen implementiert: eine zum Vergleichen von zwei Bewohnern und die zweite zum Vergleichen von zwei Listen mit Bewohnern:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bewohner vergleichen</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Iterable, Mapping<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_citizen</span>(<span class="hljs-params">citizen</span>):</span>
    <span class="hljs-string">"""
         
    """</span>
    <span class="hljs-keyword">return</span> {**citizen, <span class="hljs-string">'relatives'</span>: sorted(citizen[<span class="hljs-string">'relatives'</span>])}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizens</span>(<span class="hljs-params">left: Mapping, right: Mapping</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
      
    """</span>
    <span class="hljs-keyword">return</span> normalize_citizen(left) == normalize_citizen(right)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizen_groups</span>(<span class="hljs-params">left: Iterable, right: Iterable</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
          ,   
      
    """</span>
    left = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> left]<font></font>
    left.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])<font></font>
<font></font>
    right = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> right]<font></font>
    right.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])
    <span class="hljs-keyword">return</span> left == right
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um sicherzustellen, dass dieser Handler keine Bewohner anderer Entladungen zurückgibt, habe ich beschlossen, vor jedem Test eine zusätzliche Entladung mit einem Einwohner hinzuzufügen.</font></font><br>
<br>
<a name="test_imports_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / Importe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe die folgenden Datensätze zum Testen des Handlers definiert:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Richtige Daten, die voraussichtlich erfolgreich zur Datenbank hinzugefügt werden.</font></font></b><br>
 <br>
<ul>
<li>    ( ).<br>
<br>
      .    ,     ,    insert    ,    .</li>
<li>   ( , ).<br>
<br>
,            .<br>
 </li>
<li>    .<br>
<br>
     ,       . :)<br>
 </li>
<li>    <br>
<br>
,  aiohttp             PostgreSQL    32 767  (    ).<br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leeres Entladen </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Handler sollte einen solchen Fall berücksichtigen und nicht fallen und versuchen, mit den Bewohnern eine leere Einfügung in den Tisch durchzuführen.</font></font><br>
 </li>
</ul><br>
 </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bei fehlerhaften Daten wird eine HTTP-Antwort von 400: Bad Request erwartet.</font></font></b><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geburtsdatum ist falsch (Zukunftsform).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bürger_id ist innerhalb des Uploads nicht eindeutig.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine Verwandtschaft wird falsch angegeben (es gibt nur von einem Bewohner zum anderen, aber es gibt keine Rückmeldung).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Bewohner hat einen nicht existierenden Verwandten beim Entladen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Familienbande sind nicht einzigartig.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der Prozessor erfolgreich funktioniert hat und die Daten hinzugefügt wurden, müssen Sie die Bewohner zur Datenbank hinzufügen und sie mit dem Standardentladen vergleichen. </font><font style="vertical-align: inherit;">Um die Bewohner zu erreichen, habe ich den bereits getesteten Handler </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und zum Vergleich eine Funktion verwendet </font></font><code>compare_citizen_groups</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="test_update_citizen_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / bürger / $ bürger_id</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Validierung von Daten ähnelt in vielerlei Hinsicht der im Handler beschriebenen, </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit wenigen Ausnahmen: Es gibt nur einen Bewohner, und der Client kann </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nur die gewünschten Felder übergeben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe beschlossen, die folgenden Sätze mit falschen Daten zu verwenden, um zu überprüfen, ob der Handler eine HTTP-Antwort zurückgibt </font></font><code>400: Bad request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Feld ist angegeben, hat jedoch einen falschen Datentyp und / oder ein falsches Format</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Geburtsdatum ist falsch (zukünftige Zeit).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Feld </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enthält einen Verwandten, der beim Entladen nicht vorhanden ist.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es muss auch überprüft werden, ob der Handler die Informationen über den Bewohner und seine Verwandten korrekt aktualisiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie dazu einen Upload mit drei Einwohnern, von denen zwei Verwandte sind, und senden Sie eine Anfrage mit neuen Werten für alle Skalarfelder und einer neuen relativen Kennung im Feld </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um sicherzustellen, dass der Handler vor dem Test zwischen Bewohnern unterschiedlicher Entladungen unterscheidet (und beispielsweise Bewohner mit denselben Kennungen nicht von anderen Entladungen ändert), habe ich eine zusätzliche Entladung mit drei Bewohnern mit denselben Kennungen erstellt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Handler muss die neuen Werte der Skalarfelder speichern, einen neuen angegebenen Verwandten hinzufügen und die Beziehung zu einem alten, nicht angegebenen Verwandten entfernen. </font><font style="vertical-align: inherit;">Alle Verwandtschaftsänderungen sollten bilateral sein. </font><font style="vertical-align: inherit;">Bei anderen Entladungen sollten sich keine Änderungen ergeben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da ein solcher Handler möglicherweise einer Rennbedingung unterliegt (dies wurde im Abschnitt "Entwicklung" erläutert), habe ich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zwei zusätzliche Tests</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hinzugefügt </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Einer reproduziert das Problem mit dem Race-Status (erweitert die Handler-Klasse und entfernt die Sperre), der zweite beweist, dass das Problem mit dem Race-Status nicht reproduziert wird.</font></font><br>
<br>
<a name="test_citizen_birthdays_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Bürger / Geburtstage</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um diesen Handler zu testen, habe ich die folgenden Datensätze ausgewählt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine Entladung, bei der ein Bewohner in einem Monat einen Verwandten und in einem anderen zwei Verwandte hat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entladen mit einem Bewohner ohne Verwandte. </font><font style="vertical-align: inherit;">Überprüft, ob der Handler dies bei den Berechnungen nicht berücksichtigt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leeres Entladen. </font><font style="vertical-align: inherit;">Überprüft, ob der Handler nicht fehlschlägt und das richtige Wörterbuch mit einer Antwort von 12 Monaten zurückgibt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entladen mit einem Bewohner, der ein Verwandter von sich selbst ist. </font><font style="vertical-align: inherit;">Überprüft, ob ein Bewohner ein Geschenk für den Monat seiner Geburt kauft.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Handler muss alle Monate in der Antwort zurückgeben, auch wenn in diesen Monaten keine Geburtstage vorliegen. </font><font style="vertical-align: inherit;">Um Doppelarbeit zu vermeiden, habe ich eine Funktion erstellt, an die Sie das Wörterbuch übergeben können, damit es mit Werten für fehlende Monate ergänzt wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um sicherzustellen, dass der Handler zwischen Bewohnern unterschiedlicher Entladungen unterscheidet, habe ich eine zusätzliche Entladung mit zwei Verwandten hinzugefügt. </font><font style="vertical-align: inherit;">Wenn der Handler sie fälschlicherweise in den Berechnungen verwendet, sind die Ergebnisse falsch und der Handler fällt mit einem Fehler aus.</font></font><br>
<br>
<a name="test_town_age_stat_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / Towns / Stat / Perzentil / Alter</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Besonderheit dieses Tests ist, dass die Ergebnisse seiner Arbeit von der aktuellen Zeit abhängen: Das Alter der Einwohner wird anhand des aktuellen Datums berechnet. </font><font style="vertical-align: inherit;">Um sicherzustellen, dass sich die Testergebnisse im Laufe der Zeit nicht ändern, müssen das aktuelle Datum, das Geburtsdatum der Bewohner und die erwarteten Ergebnisse aufgezeichnet werden. </font><font style="vertical-align: inherit;">Dies macht es einfach, auch Randfälle zu reproduzieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist das beste Fixdatum? </font><font style="vertical-align: inherit;">Im Handler wird zur Berechnung des Alters der Bewohner eine PostgreSQL-Funktion verwendet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>AGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die den ersten Parameter als Datum verwendet, für das das Alter berechnet werden muss, und den zweiten als Basisdatum (definiert durch eine Konstante </font></font><code>TownAgeStatView.CURRENT_DATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir ersetzen das Basisdatum im Handler durch die Testzeit</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@patch('analyzer.api.handlers.TownAgeStatView.CURRENT_DATE', new=CURRENT_DATE)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_ages</span>(<span class="hljs-params">...</span>):</span>
    ...</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Testen des Handlers habe ich die folgenden Datensätze ausgewählt (für alle Einwohner habe ich eine Stadt angegeben, da der Handler die Ergebnisse nach Stadt aggregiert):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entladen mit mehreren Bewohnern, deren Geburtstag morgen ist (Alter - mehrere Jahre und 364 Tage). </font><font style="vertical-align: inherit;">Überprüft, ob der Prozessor nur die Anzahl der vollen Jahre für die Berechnungen verwendet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entladen mit einem Bewohner, dessen Geburtstag heute ist (Alter - genau einige Jahre). </font><font style="vertical-align: inherit;">Es prüft den regionalen Fall - das Alter eines Bewohners, dessen Geburtstag heute ist, sollte nicht als um 1 Jahr verkürzt berechnet werden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leeres Entladen. </font><font style="vertical-align: inherit;">Der Handler sollte nicht darauf fallen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der </font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Benchmark </font><font style="vertical-align: inherit;">für die Berechnung von Perzentilen - </font><font style="vertical-align: inherit;">mit linearer Interpolation - und die Benchmark-Ergebnisse für Tests, die ich für sie berechnet habe. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie müssen auch die gebrochenen Perzentilwerte auf zwei Dezimalstellen runden. </font><font style="vertical-align: inherit;">Wenn Sie PostgreSQL zum Runden im Handler und Python zum Berechnen der Referenzdaten verwendet haben, stellen Sie möglicherweise fest, dass das </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Runden in Python 3 und PostgreSQL zu unterschiedlichen Ergebnissen führen kann</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zum Beispiel</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># Python 3<font></font>
round(2.5)<font></font>
&gt; 2<font></font>
<font></font>
-- PostgreSQL<font></font>
SELECT ROUND(2.5)<font></font>
&gt; 3<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsache ist, dass Python die Bankrundung </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf die nächste</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gerade </font><font style="vertical-align: inherit;">verwendet </font><font style="vertical-align: inherit;">und PostgreSQL </font><font style="vertical-align: inherit;">die </font><font style="vertical-align: inherit;">mathematische (Halbierung) verwendet. </font><font style="vertical-align: inherit;">Wenn Berechnungen und Rundungen in PostgreSQL durchgeführt werden, ist es richtig, die mathematische Rundung auch in Tests zu verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst habe ich Datensätze mit Geburtsdaten in einem Textformat beschrieben, aber es war unpraktisch, einen Test in diesem Format zu lesen: Jedes Mal musste ich das Alter jedes Bewohners in meinem Kopf berechnen, um mich daran zu erinnern, was ein bestimmter Datensatz überprüfte. </font><font style="vertical-align: inherit;">Natürlich könnten Sie mit den Kommentaren im Code auskommen, aber ich habe mich entschlossen, etwas weiter zu gehen und eine Funktion geschrieben </font></font><code>age2date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mit der Sie das Geburtsdatum in Form des Alters beschreiben können: die Anzahl der Jahre und Tage.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zum Beispiel so</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">age2date</span>(<span class="hljs-params">years: int, days: int = <span class="hljs-number">0</span>, base_date=CURRENT_DATE</span>) -&gt; str:</span><font></font>
    birth_date = copy(base_date).replace(year=base_date.year - years)<font></font>
    birth_date -= timedelta(days=days)<font></font>
    <span class="hljs-keyword">return</span> birth_date.strftime(BIRTH_DATE_FORMAT)<font></font>
<font></font>
<span class="hljs-comment">#    ?  ,     ?</span>
generate_citizen(birth_date=<span class="hljs-string">'17.02.2009'</span>)<font></font>
<font></font>
<span class="hljs-comment">#   11       </span>
generate_citizen(birth_date=age2date(years=<span class="hljs-number">11</span>))
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um sicherzustellen, dass der Handler zwischen Bewohnern unterschiedlicher Entladungen unterscheidet, habe ich eine zusätzliche Entladung mit einem Bewohner einer anderen Stadt hinzugefügt: Wenn der Handler sie versehentlich verwendet, wird in den Ergebnissen eine zusätzliche Stadt angezeigt und der Test wird abgebrochen.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine interessante Tatsache: Als ich diesen Test am 29. Februar 2020 schrieb, hörte ich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aufgrund eines Fehlers in Faker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plötzlich auf, Entladungen mit Anwohnern </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">zu</font></a><font style="vertical-align: inherit;"> generieren </font><font style="vertical-align: inherit;">(2020 ist ein Schaltjahr, und andere Jahre, die Faker gewählt hatte, waren nicht immer auch Schaltjahre in ihnen war nicht der 29. Februar). </font><font style="vertical-align: inherit;">Denken Sie daran, Daten aufzuzeichnen und Randfälle zu testen!</font></font></blockquote><br>
<a name="test_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrationen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Migrationscode scheint auf den ersten Blick offensichtlich und am wenigsten fehleranfällig. Warum sollten Sie ihn testen? Dies ist ein sehr gefährlicher Fehler: Die heimtückischsten Fehler von Migrationen können sich im ungünstigsten Moment manifestieren. Selbst wenn sie die Daten nicht verderben, können sie unnötige Ausfallzeiten verursachen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die im Projekt vorhandene </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anfängliche</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Migration ändert die Struktur der Datenbank, jedoch nicht die Daten. Welche häufigen Fehler können vor solchen Migrationen geschützt werden?</font></font><br>
<br>
<ul>
<li>  <code>downgrade</code>           (     ,      ,     ).<br>
<br>
   ,        (--):         ,        —    .<br>
 </li>
<li>C   .</li>
<li>    ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die meisten dieser Fehler werden beim </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treppentest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erkannt </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Seine Idee - eine einzige Migration zu verwenden, konsequent die Methoden der </font><font style="vertical-align: inherit;">Durchführung </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für jede Migration. </font><font style="vertical-align: inherit;">Ein solcher Test reicht aus, um dem Projekt einmal hinzugefügt zu werden. Er erfordert keine Unterstützung und dient treu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Migration jedoch zusätzlich zur Struktur die Daten ändern würde, müsste mindestens ein separater Test geschrieben werden, um zu überprüfen, ob sich die Daten in der Methode korrekt ändern </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und in den Ausgangszustand zurückkehren </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nur für den Fall: Ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projekt mit Beispielen zum Testen verschiedener Migrationen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das ich für einen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bericht über Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Moscow Python </font><font style="vertical-align: inherit;">vorbereitet habe </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="build"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versammlung</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das letzte Artefakt, das wir bereitstellen werden und das wir als Ergebnis der Assembly erhalten möchten, ist ein Docker-Image. Zum Erstellen müssen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie das Basis-Image</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit Python </font><b><font style="vertical-align: inherit;">auswählen</font></b><font style="vertical-align: inherit;"> . Das offizielle Image </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>python:latest</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiegt ~ 1 GB und wenn es als Basis-Image verwendet wird, ist das Image mit der Anwendung riesig. Es gibt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bilder, die auf dem alpinen Betriebssystem basieren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und deren Größe viel kleiner ist. Mit der wachsenden Anzahl installierter Pakete wächst jedoch die Größe des endgültigen Bildes, und infolgedessen wird auch das auf der Grundlage von Alpine gesammelte Bild nicht so klein sein. Ich habe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snakepacker / Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> als Basis-Image gewählt </font><font style="vertical-align: inherit;">- es wiegt etwas mehr als Alpine-Images, basiert jedoch auf Ubuntu, das eine riesige Auswahl an Paketen und Bibliotheken bietet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein anderer Weg</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reduzieren Sie die Größe des Images mit der Anwendung.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fügen Sie im endgültigen Image nicht den Compiler, die Bibliotheken und Dateien mit Headern für die Assembly ein, die für die Funktion der Anwendung nicht erforderlich sind. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu können Sie die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mehrstufige Baugruppe von</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker verwenden:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie </font><font style="vertical-align: inherit;">mit einem „schweren“ Image </font><font style="vertical-align: inherit;">(~ 1 GB, ~ 500 MB komprimiert) eine virtuelle Umgebung, installieren Sie alle Abhängigkeiten und das Anwendungspaket darin. </font><font style="vertical-align: inherit;">Dieses Image wird ausschließlich für die Assembly benötigt. Es kann einen Compiler, alle erforderlichen Bibliotheken und Dateien mit Headern enthalten.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#   </span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/*</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir kopieren die fertige virtuelle Umgebung in ein "leichtes" Image </font></font><code>snakepacker/python:3.8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 100 MB, komprimiert ~ 50 MB), das nur den Interpreter der erforderlichen Version von Python enthält. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wichtig: In einer virtuellen Umgebung werden absolute Pfade verwendet, daher muss sie an dieselbe Adresse kopiert werden, an der sie im Kollektorcontainer zusammengestellt wurde.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#       builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Zeit zum Erstellen des Images</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu </font><b><font style="vertical-align: inherit;">verkürzen</font></b><font style="vertical-align: inherit;"> , können die anwendungsabhängigen Module installiert werden, bevor sie in der virtuellen Umgebung installiert werden. </font><font style="vertical-align: inherit;">Dann werden sie von Docker zwischengespeichert und nicht neu installiert, wenn sie nicht geändert wurden.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile vollständig</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">###############      ################</span>
<span class="hljs-comment">#  — «» (~1 ,    ~500 )    </span>
<span class="hljs-comment">#    </span>
FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#      pip</span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
RUN /usr/share/python3/app/bin/pip install -U pip<font></font>
<font></font>
<span class="hljs-comment">#   ,  .   </span>
<span class="hljs-comment"># Docker   ,  requirements.txt  </span><font></font>
COPY requirements.txt /mnt/<font></font>
RUN /usr/share/python3/app/bin/pip install -Ur /mnt/requirements.txt<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/* \<font></font>
    &amp;&amp; /usr/share/python3/app/bin/pip check<font></font>
<font></font>
<span class="hljs-comment">###########################   ############################</span>
<span class="hljs-comment">#    «» (~100 ,    ~50 )   Python</span>
FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#         builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Vereinfachung der Montage habe ich einen Befehl hinzugefügt </font></font><code>make upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, der das Docker-Image sammelt und auf hub.docker.com hochlädt.</font></font><br>
<br>
<a name="ci"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem der Code mit Tests abgedeckt ist und wir ein Docker-Image erstellen können, ist es Zeit, diese Prozesse zu automatisieren. Das erste, was Ihnen in den Sinn kommt: Führen Sie Tests zum Erstellen von Poolanforderungen durch, und sammeln Sie beim Hinzufügen von Änderungen zum Hauptzweig ein neues Docker-Image und laden Sie es auf den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (oder </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub-Pakete</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , wenn Sie das Image nicht öffentlich verteilen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">möchten) hoch</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe dieses Problem mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub Actions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gelöst </font><font style="vertical-align: inherit;">. Dazu musste eine YAML-Datei in einem Ordner erstellt </font></font><code>.github/workflows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und darin ein Workflow (mit zwei Aufgaben: </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) beschrieben werden, den ich benannt habe </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Aufgabe </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird bei jedem Start des Workflows </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mithilfe von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diensten ausgeführt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nimmt einen Container mit PostgreSQL auf, wartet darauf, dass er verfügbar ist, und startet </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Container </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Aufgabe </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird nur ausgeführt, wenn die Änderungen dem Zweig hinzugefügt wurden </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und die Aufgabe </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erfolgreich war. </font><font style="vertical-align: inherit;">Es sammelt die Quellverteilung durch den Container </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sammelt und lädt dann das Docker-Image mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>docker/build-push-action@v1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vollständige Beschreibung des Workflows</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">name: CI<font></font>
<font></font>
# Workflow      <font></font>
#   -  master<font></font>
on:<font></font>
  push:<font></font>
    branches: [ master ]<font></font>
  pull_request:<font></font>
    branches: [ master ]<font></font>
<font></font>
jobs:<font></font>
  #       workflow<font></font>
  test:<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    services:<font></font>
      postgres:<font></font>
        image: docker://postgres<font></font>
        ports:<font></font>
          - 5432:5432<font></font>
        env:<font></font>
          POSTGRES_USER: user<font></font>
          POSTGRES_PASSWORD: hackme<font></font>
          POSTGRES_DB: analyzer<font></font>
<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: test<font></font>
        uses: docker://snakepacker/python:all<font></font>
        env:<font></font>
          CI_ANALYZER_PG_URL: postgresql://user:hackme@postgres/analyzer<font></font>
        with:<font></font>
          args: /bin/bash -c "pip install -U '.[dev]' &amp;&amp; pylama &amp;&amp; wait-for-port postgres:5432 &amp;&amp; pytest -vv --cov=analyzer --cov-report=term-missing tests"<font></font>
<font></font>
  #    Docker-  <font></font>
  publish:<font></font>
    #        master<font></font>
    if: github.event_name == 'push' &amp;&amp; github.ref == 'refs/heads/master'<font></font>
    # ,   test   <font></font>
    needs: test<font></font>
    runs-on: ubuntu-latest<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: sdist<font></font>
        uses: docker://snakepacker/python:all<font></font>
        with:<font></font>
          args: make sdist<font></font>
<font></font>
      - name: build-push<font></font>
        uses: docker/build-push-action@v1<font></font>
        with:<font></font>
          username: ${{ secrets.REGISTRY_LOGIN }}<font></font>
          password: ${{ secrets.REGISTRY_TOKEN }}<font></font>
          repository: alvassin/backendschool2019<font></font>
          target: api<font></font>
          tags: 0.0.1, latest<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie nun auf der Registerkarte Aktionen auf GitHub Änderungen am Master hinzufügen, können Sie den Start von Tests, das Zusammenstellen und Laden des Docker-Images sehen: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/qx/pm/r5qxpmy7mlttqniibfvxadvzitw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie eine Poolanforderung im Master-Zweig erstellen, werden auch die Ergebnisse der Aufgabe darin angezeigt </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/d9/nk/pzd9nkmxq7a75fnlcw2tx37i308.png"><br>
<br>
<a name="deployment"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bereitstellen</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Anwendung auf dem bereitgestellten Server bereitzustellen, müssen Sie Docker, Docker Compose installieren, die Container mit der Anwendung und PostgreSQL starten und die Migrationen anwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Schritte können mithilfe des Konfigurationsmanagementsystems von Ansible automatisiert werden. Es ist in Python geschrieben, benötigt keine speziellen Agenten (stellt eine direkte Verbindung über ssh her), verwendet Jinja-Vorlagen und ermöglicht die deklarative Beschreibung des gewünschten Status in YAML-Dateien. Der deklarative Ansatz ermöglicht es Ihnen, nicht über den aktuellen Status des Systems und die erforderlichen Aktionen nachzudenken, um das System in den gewünschten Status zu bringen. All diese Arbeit ruht auf den Schultern der Ansible-Module. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit Ansible können Sie logisch verwandte Aufgaben in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rollen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gruppieren </font><font style="vertical-align: inherit;">und dann wiederverwenden. Wir brauchen zwei Rollen:</font></font><code>docker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(installiert und konfiguriert Docker) und </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(installiert und konfiguriert die Anwendung). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Rolle</font></font><code>docker</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fügt dem System ein Repository mit Docker hinzu, installiert und konfiguriert Pakete </font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Optional können Sie festlegen, dass die REST-API nach einem Neustart des Servers automatisch fortgesetzt wird. Mit Ubuntu können Sie dieses Problem mithilfe eines Initialisierungssystems lösen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>systemd</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Es steuert Einheiten, die verschiedene Ressourcen darstellen (Dämonen, Sockets, Mount-Punkte und andere). Um systemd eine neue Einheit hinzuzufügen, müssen Sie deren Konfiguration in einer separaten .service-Datei beschreiben und diese Datei in einem der speziellen Ordner ablegen, z </font></font><code>/etc/systemd/system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dann kann das Gerät gestartet und das automatische Laden aktiviert werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Während der Installation wird automatisch eine Datei mit der Gerätekonfiguration erstellt. Sie müssen nur sicherstellen, dass sie ausgeführt wird und sich beim Systemstart einschaltet. </font><font style="vertical-align: inherit;">Für Docker wird Compose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>  docker-compose@.service</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">von Ansible erstellt. </font><font style="vertical-align: inherit;">Das Symbol </font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Namen zeigt systemd an, dass das Gerät eine Vorlage ist. </font><font style="vertical-align: inherit;">Auf diese Weise können Sie den Dienst </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einem Parameter </font><font style="vertical-align: inherit;">starten, </font><font style="vertical-align: inherit;">z. B. mit dem Namen unseres Dienstes, der anstelle der </font></font><code>%i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerätekonfigurationsdatei ersetzt wird:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=%i service with docker compose<font></font>
Requires=docker.service<font></font>
After=docker.service<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
RemainAfterExit=true<font></font>
WorkingDirectory=/etc/docker/compose/%i<font></font>
ExecStart=/usr/local/bin/docker-compose up -d --remove-orphans<font></font>
ExecStop=/usr/local/bin/docker-compose down<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Rolle</font></font><code>analyzer</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> generiert eine Datei aus der Vorlage </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an der Adresse </font></font><code>/etc/docker/compose/analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, registriert die Anwendung als automatisch gestarteten Dienst in </font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und wendet die Migration an. </font><font style="vertical-align: inherit;">Wenn die Rollen fertig sind, müssen Sie das Playbook beschreiben.</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Gathering facts<font></font>
  hosts: all<font></font>
  become: yes<font></font>
  gather_facts: yes<font></font>
<font></font>
- name: Install docker<font></font>
  hosts: docker<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - docker<font></font>
<font></font>
- name: Install analyzer<font></font>
  hosts: api<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Liste der Hosts sowie die in den Rollen verwendeten Variablen können in der Inventardatei angegeben werden </font></font><code>hosts.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">[api]<font></font>
130.193.51.154<font></font>
<font></font>
[docker:children]<font></font>
api<font></font>
<font></font>
[api:vars]<font></font>
analyzer_image = alvassin/backendschool2019<font></font>
analyzer_pg_user = user<font></font>
analyzer_pg_password = hackme<font></font>
analyzer_pg_dbname = analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem alle Ansible-Dateien fertig sind, führen Sie sie aus:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ansible-playbook -i hosts.ini deploy.yml</code></pre><br>
<a name="load_testing"></a><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Über Stresstests</font></font></b>
                        <div class="spoiler_text">,   ,     .      ,      -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.     :      ,    —   ,         10 . ,         (, ,   CI-):           .<br>
<br>
,     ,      ,        10 .   ?  ,          ,   .  ,     ,       .<br>
<br>
          RPS,      :      . ,    ,     <code>import_id</code>,    <code>POST /imports</code>      .      . <br>
<br>
,       Python 3,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Locust</a>. <br>
<br>
   ,      <code>locustfile.py</code>     <code>locust</code>.         -     .<br>
<br>
 Locust   .    ,        .       <br>
 <code>self.round</code>           .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    locustfile.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># locustfile.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus<font></font>
<font></font>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, constant, task, TaskSet
<span class="hljs-keyword">from</span> locust.exception <span class="hljs-keyword">import</span> RescheduleTask<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.handlers <span class="hljs-keyword">import</span> (<font></font>
    CitizenBirthdaysView, CitizensView, CitizenView, TownAgeStatView<font></font>
)<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen, generate_citizens, url_for<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyzerTaskSet</span>(<span class="hljs-params">TaskSet</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.round = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_dataset</span>(<span class="hljs-params">self</span>):</span><font></font>
        citizens = [<font></font>
            <span class="hljs-comment">#     .   </span>
            <span class="hljs-comment"># PATCH-  relatives    </span>
            <span class="hljs-comment"># ,     - </span>
            <span class="hljs-comment"># (     ,    </span>
            <span class="hljs-comment"># ).</span>
            generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>]),<font></font>
            generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
            *generate_citizens(citizens_num=<span class="hljs-number">9998</span>, relations_num=<span class="hljs-number">1000</span>,<font></font>
                               start_citizen_id=<span class="hljs-number">3</span>)<font></font>
        ]<font></font>
        <span class="hljs-keyword">return</span> {citizen[<span class="hljs-string">'citizen_id'</span>]: citizen <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> citizens}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, method, path, expected_status, **kwargs</span>):</span>
        <span class="hljs-keyword">with</span> self.client.request(<font></font>
                method, path, catch_response=<span class="hljs-literal">True</span>, **kwargs<font></font>
        ) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">if</span> resp.status_code != expected_status:<font></font>
                resp.failure(<span class="hljs-string">f'expected status <span class="hljs-subst">{expected_status}</span>, '</span>
                             <span class="hljs-string">f'got <span class="hljs-subst">{resp.status_code}</span>'</span>)<font></font>
            logging.info(<font></font>
                <span class="hljs-string">'round %r: %s %s, http status %d (expected %d), took %rs'</span>,<font></font>
                self.round, method, path, resp.status_code, expected_status,<font></font>
                resp.elapsed.total_seconds()<font></font>
            )<font></font>
            <span class="hljs-keyword">return</span> resp<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_import</span>(<span class="hljs-params">self, dataset</span>):</span>
        resp = self.request(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/imports'</span>, HTTPStatus.CREATED,<font></font>
                            json={<span class="hljs-string">'citizens'</span>: list(dataset.values())})
        <span class="hljs-keyword">if</span> resp.status_code != HTTPStatus.CREATED:
            <span class="hljs-keyword">raise</span> RescheduleTask
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">'data'</span>][<span class="hljs-string">'import_id'</span>]<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_citizens</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizensView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_citizen</span>(<span class="hljs-params">self, import_id</span>):</span>
        url = url_for(CitizenView.URL_PATH, import_id=import_id, citizen_id=<span class="hljs-number">1</span>)<font></font>
        self.request(<span class="hljs-string">'PATCH'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/{citizen_id}'</span>,<font></font>
                     json={<span class="hljs-string">'relatives'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)]})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_birthdays</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizenBirthdaysView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/birthdays'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_town_stats</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(TownAgeStatView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/towns/stat/percentile/age'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @task</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">workflow</span>(<span class="hljs-params">self</span>):</span>
        self.round += <span class="hljs-number">1</span><font></font>
        dataset = self.make_dataset()<font></font>
<font></font>
        import_id = self.create_import(dataset)<font></font>
        self.get_citizens(import_id)<font></font>
        self.update_citizen(import_id)<font></font>
        self.get_birthdays(import_id)<font></font>
        self.get_town_stats(import_id)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><font></font>
    task_set = AnalyzerTaskSet<font></font>
    wait_time = constant(<span class="hljs-number">1</span>)</code></pre></div>
                    </div><br>
 100  c  ,  ,        :<br>
<br>
<img src="https://habrastorage.org/webt/qx/ri/b3/qxrib3jily9gzmexxhupu35tipa.png"><br>
<br>
       ,           ( — 95 ,  — ).        .<br>
<br>
<img src="https://habrastorage.org/webt/dn/px/fn/dnpxfn5ly7vttziqnnfpvvdsl9g.png"><br>
<br>
      —     Ansible       ~20.15  ~20.30    Locust.<br>
<br>
<img src="https://habrastorage.org/webt/om/1e/ok/om1eoknqvzqmyez-plpgykhz8io.png"></div>
                    </div><br>
<a name="whatelse"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was kann man noch tun?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Profilerstellung der Anwendung ergab, dass etwa ein Viertel der gesamten Ausführungszeit für Abfragen für die JSON-Serialisierung und -Deserialisierung aufgewendet wird: Es werden viele Daten vom Dienst gesendet und empfangen. Diese Prozesse können mithilfe der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orjson-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek erheblich beschleunigt werden </font><font style="vertical-align: inherit;">, der Service muss jedoch ein wenig vorbereitet werden - </font></font><code>orjson</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es handelt sich nicht um einen Ersatz für das Standardmodul. </font></font><code>json</code> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Normalerweise erfordert die Produktion mehrere Kopien des Service, um Fehlertoleranz zu gewährleisten und die Last zu bewältigen. Um eine Gruppe von Diensten zu verwalten, benötigen Sie ein Tool, das anzeigt, ob eine Kopie des Dienstes "lebendig" ist. Dieses Problem kann durch einen Handler gelöst werden </font></font><code>/health</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, der alle für die Arbeit erforderlichen Ressourcen abfragt, in unserem Fall eine Datenbank. Wenn</font></font><code>SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In weniger als einer Sekunde ausgeführt, ist der Dienst aktiv. Wenn nicht, müssen Sie darauf achten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn eine Anwendung sehr intensiv mit einem Netzwerk arbeitet, </font><font style="vertical-align: inherit;">kann </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uvloop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> die Leistung kühl steigern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein wichtiger Faktor ist die Lesbarkeit des Codes. Einer meiner Kollegen, Yuri Shikanov, hat ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">graues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modul geschrieben, das mehrere Tools </font><font style="vertical-align: inherit;">zur automatischen Überprüfung und Ausführung von Code </font><font style="vertical-align: inherit;">kombiniert </font><font style="vertical-align: inherit;">, das einfach zu einem </font></font><code>pre-commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Git-Hook </font><font style="vertical-align: inherit;">hinzugefügt werden kann </font><font style="vertical-align: inherit;">, der mit einer einzigen Konfigurationsdatei oder Umgebungsvariablen eingerichtet wurde. Mit Grau können Sie Importe sortieren ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), Python-Ausdrücke nach neuen Versionen der Sprache optimieren ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyupgrade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), am Ende von Funktionsaufrufen, Importen, Listen usw. Kommas hinzufügen (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add-trailing-comma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) und Anführungszeichen für ein einzelnes Formular ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<a name="final"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* * *</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist alles für mich: Wir haben den Service entwickelt, mit Tests abgedeckt, zusammengestellt und bereitgestellt sowie Lasttests durchgeführt.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Danksagung</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich möchte den Jungs, die sich die Zeit genommen haben, diesen Artikel zu schreiben, den Code zu überprüfen, meine Ideen und Kommentare vorzustellen, meinen tiefen Dank aussprechen: Maria Zelenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zelma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Vladimir Solomatin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leenr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Anastasia Semenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">morkov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Yuri Shikanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dizballanze</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Shushpanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Missgeschick</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Pavel Mosein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pavkazzz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und besonders an Dmitry Orlov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orlovdl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de499518/index.html">Videokonferenzen sind jetzt ein Markt und neue Technologien. Longrid, Teil eins</a></li>
<li><a href="../de499522/index.html">Alle Innovationen von Windows 10 2004 (20H1)</a></li>
<li><a href="../de499524/index.html">Quarkus: Anwendungs-Upgrades anhand des Beispiels helloworld von JBoss EAP Quickstart</a></li>
<li><a href="../de499528/index.html">Eine "atemberaubende" mathematische Brücke, die über Fermats großen Satz hinausgeht</a></li>
<li><a href="../de499532/index.html">Wörter in Zahlen: kostenlose Blog-Analyse habravebinary mit Yandex.Metrica</a></li>
<li><a href="../de499536/index.html">Growbox als Methode, sich selbst zu kennen</a></li>
<li><a href="../de499540/index.html">So funktioniert das Rendern von 3D-Spielen: Texturierung und Texturfilterung</a></li>
<li><a href="../de499542/index.html">Top Fakapov Cyan</a></li>
<li><a href="../de499544/index.html">Lernen Sie neuronale Netze in Google Sheets</a></li>
<li><a href="../de499546/index.html">Firmware-Entwicklung für eine analoge Videokamera EVR-Y2022F</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>