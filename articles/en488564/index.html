<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçî üë©üèø‚ÄçüöÄ üõÉ Your first neural network on a graphics processing unit (GPU). Beginner's Guide üéÉ üë©üèæ‚Äçüéì üö£üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will tell you how to set up a machine learning environment in 30 minutes, create a neural network for image recognition, and then r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Your first neural network on a graphics processing unit (GPU). Beginner's Guide</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488564/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wg/sv/g2/wgsvg24lytktztdczee_4rteb28.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, I will tell you how to set up a machine learning environment in 30 minutes, create a neural network for image recognition, and then run the same network on a graphics processing unit (GPU). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, let's define what a neural network is. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, this is a mathematical model, as well as its software or hardware implementation, built on the principle of organization and functioning of biological neural networks - networks of nerve cells of a living organism. This concept arose in the study of processes occurring in the brain, and in an attempt to simulate these processes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neural networks are not programmed in the usual sense of the word, they are trained. </font><font style="vertical-align: inherit;">Learning ability is one of the main advantages of neural networks over traditional algorithms. </font><font style="vertical-align: inherit;">Technically, training consists in finding the coefficients of connections between neurons. </font><font style="vertical-align: inherit;">In the learning process, the neural network is able to identify complex relationships between input and output, as well as perform generalization. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the point of view of machine learning, a neural network is a special case of pattern recognition methods, discriminant analysis, clustering methods and other methods.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equipment</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, let's deal with the equipment. We need a server with the Linux operating system installed on it. Equipment for the operation of machine learning systems requires a sufficiently powerful and, as a consequence, expensive. For those who do not have a good car at hand, I recommend paying attention to the offer of cloud providers. The necessary server can be rented quickly and pay only for the time of use.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In projects where it is necessary to create neural networks, I use the servers of one of the Russian cloud providers. </font><font style="vertical-align: inherit;">The company offers rental cloud servers specifically for machine learning with powerful Tesla V100 graphics processing units (GPUs) from NVIDIA. </font><font style="vertical-align: inherit;">In short: using a server with a GPU can be dozens of times more efficient (fast) compared to a server similar in cost where a CPU is used for calculations (a well-known central processor). </font><font style="vertical-align: inherit;">This is achieved due to the specifics of the GPU architecture, which handles calculations faster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To perform the examples described below, we purchased the following server for several days:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 GB SSD</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM 32 GB</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tesla V100 16 Gb processor with 4 cores</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ubuntu 18.04 was installed on the machine.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set the environment</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now install on the server everything you need to work. </font><font style="vertical-align: inherit;">Since our article is primarily for beginners, I will talk in it about some points that will be useful to them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lot of work when setting up the environment is done through the command line. </font><font style="vertical-align: inherit;">Most of the users use Windows as a working OS. </font><font style="vertical-align: inherit;">The standard console in this OS leaves much to be desired. </font><font style="vertical-align: inherit;">Therefore, we will use the convenient </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cmder /</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tool </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Download the mini version and run Cmder.exe. </font><font style="vertical-align: inherit;">Next, you need to connect to the server via SSH:</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@server-ip-or-hostname</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instead of server-ip-or-hostname, specify the IP address or DNS name of your server. </font><font style="vertical-align: inherit;">Next, enter the password and upon successful connection, we should get something like this.</font></font><br>
<br>
<pre><code class="bash hljs">Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-74-generic x86_64)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main language for developing ML models is Python. </font><font style="vertical-align: inherit;">And the most popular platform for using it on Linux is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anaconda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install it on our server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start by updating the local package manager:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install curl (command line utility):</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install curl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download the latest version of Anaconda Distribution:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /tmp<font></font>
curl ‚ÄìO https://repo.anaconda.com/archive/Anaconda3-2019.10-Linux-x86_64.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start the installation:</font></font><br>
<br>
<pre><code class="bash hljs">bash Anaconda3-2019.10-Linux-x86_64.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the installation process, you will need to confirm the license agreement. </font><font style="vertical-align: inherit;">On successful installation, you should see this:</font></font><br>
<br>
<pre><code class="bash hljs">Thank you <span class="hljs-keyword">for</span> installing Anaconda3!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To develop ML models, many frameworks are now created, we work with the most popular: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyTorch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tensorflow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the framework allows you to increase the speed of development and use ready-made tools for standard tasks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this example, we will work with PyTorch. </font><font style="vertical-align: inherit;">Install it:</font></font><br>
<br>
<pre><code class="bash hljs">conda install pytorch torchvision cudatoolkit=10.1 -c pytorch</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to launch the Jupyter Notebook - a popular development tool among ML specialists. </font><font style="vertical-align: inherit;">It allows you to write code and immediately see the results of its execution. </font><font style="vertical-align: inherit;">Jupyter Notebook is part of Anaconda and is already installed on our server. </font><font style="vertical-align: inherit;">You need to connect to it from our desktop system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we first run Jupyter on the server by specifying port 8080:</font></font><br>
<br>
<pre><code class="bash hljs">jupyter notebook --no-browser --port=8080 --allow-root</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, opening another tab in our Cmder console (the top menu is the New console dialog), connect on port 8080 to the server via SSH:</font></font><br>
<br>
<pre><code class="plaintext hljs">ssh -L 8080:localhost:8080 root@server-ip-or-hostname</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you enter the first command, we will be offered links to open Jupyter in our browser:</font></font><br>
<br>
<pre><code class="bash hljs">To access the notebook, open this file <span class="hljs-keyword">in</span> a browser:<font></font>
        file:///root/.<span class="hljs-built_in">local</span>/share/jupyter/runtime/nbserver-18788-open.html<font></font>
    Or copy and paste one of these URLs:<font></font>
        http://localhost:8080/?token=cca0bd0b30857821194b9018a5394a4ed2322236f116d311<font></font>
     or http://127.0.0.1:8080/?token=cca0bd0b30857821194b9018a5394a4ed2322236f116d311<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use the link for localhost: 8080. </font><font style="vertical-align: inherit;">Copy the full path and paste into the address bar of the local browser of your PC. </font><font style="vertical-align: inherit;">The Jupyter Notebook opens. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's create a new laptop: New - Notebook - Python 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Check the correct operation of all the components that we installed. </font><font style="vertical-align: inherit;">We introduce a PyTorch code example into Jupyter and start the execution (Run button):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function
<span class="hljs-keyword">import</span> torch<font></font>
x = torch.rand(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)<font></font>
print(x)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result should be something like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ps/o8/su/pso8sugii4txi_beqrbx13nsry8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have a similar result, then we all set up correctly and can begin to develop a neural network!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a neural network</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will create a neural network for image recognition. </font><font style="vertical-align: inherit;">We take this </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">guide as a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> basis </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To train the network, we will use the publicly available CIFAR10 dataset. </font><font style="vertical-align: inherit;">He has classes: ‚Äúairplane‚Äù, ‚Äúcar‚Äù, ‚Äúbird‚Äù, ‚Äúcat‚Äù, ‚Äúdeer‚Äù, ‚Äúdog‚Äù, ‚Äúfrog‚Äù, ‚Äúhorse‚Äù, ‚Äúship‚Äù, ‚Äútruck‚Äù. </font><font style="vertical-align: inherit;">Images in CIFAR10 have a size of 3x32x32, i.e. 3-channel color images of 32x32 pixels.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wg/sv/g2/wgsvg24lytktztdczee_4rteb28.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For work, we will use the created PyTorch package for working with images - torchvision. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will take the following steps in order:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download and normalize training and test data sets</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neural network definition</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network training on training data</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing the network with test data</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repeat GPU training and testing</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All the code below we will execute in the Jupyter Notebook.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download and normalize CIFAR10</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copy and execute the following code in Jupyter:</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torchvision
<span class="hljs-keyword">import</span> torchvision.transforms <span class="hljs-keyword">as</span> transforms<font></font>
<font></font>
transform = transforms.Compose(<font></font>
    [transforms.ToTensor(),<font></font>
     transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))])<font></font>
<font></font>
trainset = torchvision.datasets.CIFAR10(root=<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">True</span>,<font></font>
                                        download=<span class="hljs-literal">True</span>, transform=transform)<font></font>
trainloader = torch.utils.data.DataLoader(trainset, batch_size=<span class="hljs-number">4</span>,<font></font>
                                          shuffle=<span class="hljs-literal">True</span>, num_workers=<span class="hljs-number">2</span>)<font></font>
<font></font>
testset = torchvision.datasets.CIFAR10(root=<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">False</span>,<font></font>
                                       download=<span class="hljs-literal">True</span>, transform=transform)<font></font>
testloader = torch.utils.data.DataLoader(testset, batch_size=<span class="hljs-number">4</span>,<font></font>
                                         shuffle=<span class="hljs-literal">False</span>, num_workers=<span class="hljs-number">2</span>)<font></font>
<font></font>
classes = (<span class="hljs-string">'plane'</span>, <span class="hljs-string">'car'</span>, <span class="hljs-string">'bird'</span>, <span class="hljs-string">'cat'</span>,
           <span class="hljs-string">'deer'</span>, <span class="hljs-string">'dog'</span>, <span class="hljs-string">'frog'</span>, <span class="hljs-string">'horse'</span>, <span class="hljs-string">'ship'</span>, <span class="hljs-string">'truck'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The answer should be like this:</font></font><br>
<br>
<pre><code class="python hljs">Downloading https://www.cs.toronto.edu/~kriz/cifar<span class="hljs-number">-10</span>-python.tar.gz to ./data/cifar<span class="hljs-number">-10</span>-python.tar.gz<font></font>
Extracting ./data/cifar<span class="hljs-number">-10</span>-python.tar.gz to ./data<font></font>
Files already downloaded <span class="hljs-keyword">and</span> verified</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will derive several training images for checking:</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<font></font>
<font></font>
<span class="hljs-comment"># functions to show an image</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">imshow</span>(<span class="hljs-params">img</span>):</span>
    img = img / <span class="hljs-number">2</span> + <span class="hljs-number">0.5</span>     <span class="hljs-comment"># unnormalize</span><font></font>
    npimg = img.numpy()<font></font>
    plt.imshow(np.transpose(npimg, (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>)))<font></font>
    plt.show()<font></font>
<font></font>
<span class="hljs-comment"># get some random training images</span><font></font>
dataiter = iter(trainloader)<font></font>
images, labels = dataiter.next()<font></font>
<font></font>
<span class="hljs-comment"># show images</span><font></font>
imshow(torchvision.utils.make_grid(images))<font></font>
<span class="hljs-comment"># print labels</span>
print(<span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[labels[j]] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))
</code></pre><br>
<img src="https://habrastorage.org/webt/yy/w4/xw/yyw4xwjhaa6kfy41fvnylvz6qdy.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neural network definition</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let us first examine how a neural network for image recognition works. </font><font style="vertical-align: inherit;">This is a simple direct connection network. </font><font style="vertical-align: inherit;">It takes input, passes it through several layers one by one, and then finally gives the output. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/4m/yg/t84mygi1sjuzssoezguistupmeo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's create a similar network in our environment:</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Net</span>(<span class="hljs-params">nn.Module</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><font></font>
        super(Net, self).__init__()<font></font>
        self.conv1 = nn.Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>)<font></font>
        self.pool = nn.MaxPool2d(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<font></font>
        self.conv2 = nn.Conv2d(<span class="hljs-number">6</span>, <span class="hljs-number">16</span>, <span class="hljs-number">5</span>)<font></font>
        self.fc1 = nn.Linear(<span class="hljs-number">16</span> * <span class="hljs-number">5</span> * <span class="hljs-number">5</span>, <span class="hljs-number">120</span>)<font></font>
        self.fc2 = nn.Linear(<span class="hljs-number">120</span>, <span class="hljs-number">84</span>)<font></font>
        self.fc3 = nn.Linear(<span class="hljs-number">84</span>, <span class="hljs-number">10</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, x</span>):</span><font></font>
        x = self.pool(F.relu(self.conv1(x)))<font></font>
        x = self.pool(F.relu(self.conv2(x)))<font></font>
        x = x.view(<span class="hljs-number">-1</span>, <span class="hljs-number">16</span> * <span class="hljs-number">5</span> * <span class="hljs-number">5</span>)<font></font>
        x = F.relu(self.fc1(x))<font></font>
        x = F.relu(self.fc2(x))<font></font>
        x = self.fc3(x)<font></font>
        <span class="hljs-keyword">return</span> x<font></font>
<font></font>
net = Net()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also define the loss function and the optimizer </font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<font></font>
<font></font>
criterion = nn.CrossEntropyLoss()<font></font>
optimizer = optim.SGD(net.parameters(), lr=<span class="hljs-number">0.001</span>, momentum=<span class="hljs-number">0.9</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network training on training data</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We begin training our neural network. </font><font style="vertical-align: inherit;">I draw your attention to the fact that after this, as you run this code, you will need to wait a while until the work is completed. </font><font style="vertical-align: inherit;">It took me 5 minutes. </font><font style="vertical-align: inherit;">Networking takes time.</font></font><br>
<br>
<pre><code class="python hljs"> <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):  <span class="hljs-comment"># loop over the dataset multiple times</span><font></font>
<font></font>
    running_loss = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">for</span> i, data <span class="hljs-keyword">in</span> enumerate(trainloader, <span class="hljs-number">0</span>):
        <span class="hljs-comment"># get the inputs; data is a list of [inputs, labels]</span><font></font>
        inputs, labels = data<font></font>
<font></font>
        <span class="hljs-comment"># zero the parameter gradients</span><font></font>
        optimizer.zero_grad()<font></font>
<font></font>
        <span class="hljs-comment"># forward + backward + optimize</span><font></font>
        outputs = net(inputs)<font></font>
        loss = criterion(outputs, labels)<font></font>
        loss.backward()<font></font>
        optimizer.step()<font></font>
<font></font>
        <span class="hljs-comment"># print statistics</span><font></font>
        running_loss += loss.item()<font></font>
        <span class="hljs-keyword">if</span> i % <span class="hljs-number">2000</span> == <span class="hljs-number">1999</span>:    <span class="hljs-comment"># print every 2000 mini-batches</span>
            print(<span class="hljs-string">'[%d, %5d] loss: %.3f'</span> %<font></font>
                  (epoch + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>, running_loss / <span class="hljs-number">2000</span>))<font></font>
            running_loss = <span class="hljs-number">0.0</span><font></font>
<font></font>
print(<span class="hljs-string">'Finished Training'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get the following result: We </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sw/05/k2/sw05k2ewk-gu9fiyrv3xncxjaki.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
save our trained model:</font></font><br>
<br>
<pre><code class="python hljs">PATH = <span class="hljs-string">'./cifar_net.pth'</span>
torch.save(net.state_dict(), PATH)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing the network with test data</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We trained the network using a set of training data. </font><font style="vertical-align: inherit;">But we need to check if the network has learned anything at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will verify this by predicting the class label that the neural network outputs, and checking for truth. </font><font style="vertical-align: inherit;">If the forecast is correct, we add the sample to the list of correct forecasts. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's show the image from the test suite:</font></font><br>
<br>
<pre><code class="python hljs">dataiter = iter(testloader)<font></font>
images, labels = dataiter.next()<font></font>
<font></font>
<span class="hljs-comment"># print images</span><font></font>
imshow(torchvision.utils.make_grid(images))<font></font>
print(<span class="hljs-string">'GroundTruth: '</span>, <span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[labels[j]] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))</code></pre><br>
<img src="https://habrastorage.org/webt/hp/ph/zm/hpphzma6rus04gw-edxsowf1ifu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now ask the neural network to tell us what is in these pictures:</font></font><br>
<br>
<pre><code class="python hljs"><font></font>
net = Net()<font></font>
net.load_state_dict(torch.load(PATH))<font></font>
<font></font>
outputs = net(images)<font></font>
<font></font>
_, predicted = torch.max(outputs, <span class="hljs-number">1</span>)<font></font>
<font></font>
print(<span class="hljs-string">'Predicted: '</span>, <span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[predicted[j]]
                              <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))
</code></pre><br>
<img src="https://habrastorage.org/webt/j2/vp/uc/j2vpucdaps0fuci2yg38ip2fbdo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The results seem pretty good: the network correctly identified three of the four pictures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see how the network works in the entire data set.</font></font><br>
<br>
<pre><code class="python hljs">
correct = <span class="hljs-number">0</span>
total = <span class="hljs-number">0</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> testloader:<font></font>
        images, labels = data<font></font>
        outputs = net(images)<font></font>
        _, predicted = torch.max(outputs.data, <span class="hljs-number">1</span>)<font></font>
        total += labels.size(<span class="hljs-number">0</span>)<font></font>
        correct += (predicted == labels).sum().item()<font></font>
<font></font>
print(<span class="hljs-string">'Accuracy of the network on the 10000 test images: %d %%'</span> % (
    <span class="hljs-number">100</span> * correct / total))</code></pre><br>
<img src="https://habrastorage.org/webt/fy/i4/cn/fyi4cnkjgimshkhhbsva4udixhw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks like the network knows and works. </font><font style="vertical-align: inherit;">If he defined classes at random, then the accuracy would be 10%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see what classes the network defines better:</font></font><br>
<br>
<pre><code class="python hljs">class_correct = list(<span class="hljs-number">0.</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>))<font></font>
class_total = list(<span class="hljs-number">0.</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>))
<span class="hljs-keyword">with</span> torch.no_grad():
    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> testloader:<font></font>
        images, labels = data<font></font>
        outputs = net(images)<font></font>
        _, predicted = torch.max(outputs, <span class="hljs-number">1</span>)<font></font>
        c = (predicted == labels).squeeze()<font></font>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>):<font></font>
            label = labels[i]<font></font>
            class_correct[label] += c[i].item()<font></font>
            class_total[label] += <span class="hljs-number">1</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<font></font>
    print(<span class="hljs-string">'Accuracy of %5s : %2d %%'</span> % (<font></font>
        classes[i], <span class="hljs-number">100</span> * class_correct[i] / class_total[i]))</code></pre><br>
<img src="https://habrastorage.org/webt/l9/s9/qu/l9s9quxd-lzx2kh7wphxe9-2qzs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that the network determines cars and ships best: 71% accuracy. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So the network is working. </font><font style="vertical-align: inherit;">Now let's try to transfer its work to the graphic processor (GPU) and see what changes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU neural network training</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, I‚Äôll briefly explain what CUDA is. </font><font style="vertical-align: inherit;">CUDA (Compute Unified Device Architecture) is a parallel computing platform developed by NVIDIA for general computing on GPUs. </font><font style="vertical-align: inherit;">With CUDA, developers can significantly accelerate computing applications using the capabilities of GPUs. </font><font style="vertical-align: inherit;">On our server that we purchased, this platform is already installed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's first define our GPU as the first visible cuda device.</font></font><br>
<br>
<pre><code class="python hljs">device = torch . device ( <span class="hljs-string">"cuda:0"</span> <span class="hljs-keyword">if</span> torch . cuda . is_available () <span class="hljs-keyword">else</span> <span class="hljs-string">"cpu"</span> )
<span class="hljs-comment"># Assuming that we are on a CUDA machine, this should print a CUDA device:</span>
<span class="hljs-keyword">print</span> ( device )</code></pre><br>
<img src="https://habrastorage.org/webt/n2/2k/bf/n22kbfvilr6kn30eel6dfhaose4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Send the network to the GPU:</font></font><br>
 <br>
<pre><code class="python hljs">net.to(device)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will also have to send inputs and goals at every step and to the GPU:</font></font><br>
<br>
<pre><code class="python hljs">inputs, labels = data[<span class="hljs-number">0</span>].to(device), data[<span class="hljs-number">1</span>].to(device)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the network retraining already on the GPU: </font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<font></font>
<font></font>
criterion = nn.CrossEntropyLoss()<font></font>
optimizer = optim.SGD(net.parameters(), lr=<span class="hljs-number">0.001</span>, momentum=<span class="hljs-number">0.9</span>)
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):  <span class="hljs-comment"># loop over the dataset multiple times</span><font></font>
<font></font>
    running_loss = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">for</span> i, data <span class="hljs-keyword">in</span> enumerate(trainloader, <span class="hljs-number">0</span>):
        <span class="hljs-comment"># get the inputs; data is a list of [inputs, labels]</span>
    inputs, labels = data[<span class="hljs-number">0</span>].to(device), data[<span class="hljs-number">1</span>].to(device)<font></font>
<font></font>
        <span class="hljs-comment"># zero the parameter gradients</span><font></font>
        optimizer.zero_grad()<font></font>
<font></font>
        <span class="hljs-comment"># forward + backward + optimize</span><font></font>
        outputs = net(inputs)<font></font>
        loss = criterion(outputs, labels)<font></font>
        loss.backward()<font></font>
        optimizer.step()<font></font>
<font></font>
        <span class="hljs-comment"># print statistics</span><font></font>
        running_loss += loss.item()<font></font>
        <span class="hljs-keyword">if</span> i % <span class="hljs-number">2000</span> == <span class="hljs-number">1999</span>:    <span class="hljs-comment"># print every 2000 mini-batches</span>
            print(<span class="hljs-string">'[%d, %5d] loss: %.3f'</span> %<font></font>
                  (epoch + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>, running_loss / <span class="hljs-number">2000</span>))<font></font>
            running_loss = <span class="hljs-number">0.0</span><font></font>
<font></font>
print(<span class="hljs-string">'Finished Training'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This time, network training lasted about 3 minutes. </font><font style="vertical-align: inherit;">Recall that the same stage on a regular processor lasted 5 minutes. </font><font style="vertical-align: inherit;">The difference is not significant, this is because our network is not so big. </font><font style="vertical-align: inherit;">When using large arrays for training, the difference between the speed of the GPU and the traditional processor will increase. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That seems to be all. </font><font style="vertical-align: inherit;">What we managed to do:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We examined what the GPU is and chose the server on which it is installed;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We set up a software environment for creating a neural network;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We created a neural network for image recognition and trained it;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We repeated the training of the network using the GPU and received an increase in speed.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will be glad to answer questions in the comments.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488548/index.html">Experiment: how to learn to create popular texts in English (and why the English-speaking Habrists read so little)</a></li>
<li><a href="../en488550/index.html">Who wants to make cooperatives out of IT giants</a></li>
<li><a href="../en488552/index.html">Apple FAS and Parental Control Developers</a></li>
<li><a href="../en488558/index.html">Ensuring high availability of applications with Kafka Streams</a></li>
<li><a href="../en488560/index.html">Free Telegram bot hosting on Google Cloud Platform</a></li>
<li><a href="../en488566/index.html">How a QA engineer saved an entire day by linking AutoTests in Visual Studio and Test IT</a></li>
<li><a href="../en488568/index.html">Do neural networks dream of electric money?</a></li>
<li><a href="../en488570/index.html">How the US Secret Service confused cyberpunk RPG with a textbook for hackers</a></li>
<li><a href="../en488572/index.html">Unity Analyzers Now Open-Source</a></li>
<li><a href="../en488574/index.html">Students write Uart driver for STM32F411</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>