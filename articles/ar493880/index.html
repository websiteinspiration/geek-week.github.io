<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¹ğŸ¾ ğŸŒ¡ï¸ ğŸï¸ BPF Ù„Ù„ØµØºØ§Ø± ØŒ Ø§Ù„Ø¬Ø²Ø¡ ØµÙØ±: BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ ğŸ´ ğŸ‘ ğŸ¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ÙÙ„Ø§ØªØ± Berkeley Packet Filters (BPF) Ù‡ÙŠ ØªÙ‚Ù†ÙŠØ© Linux kernel ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ø¹Ø¯Ø© Ø³Ù†ÙˆØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø§Ù„Ù…...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>BPF Ù„Ù„ØµØºØ§Ø± ØŒ Ø§Ù„Ø¬Ø²Ø¡ ØµÙØ±: BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493880/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÙÙ„Ø§ØªØ± Berkeley Packet Filters (BPF) Ù‡ÙŠ ØªÙ‚Ù†ÙŠØ© Linux kernel ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ø¹Ø¯Ø© Ø³Ù†ÙˆØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø§Ù„Ù…Ø¤ØªÙ…Ø±Ø§Øª Ù…Ù„ÙŠØ¦Ø© Ø¨ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØªØ·ÙˆÙŠØ± BPF. Ø¯ÙŠÙÙŠØ¯ Ù…ÙŠÙ„Ù„Ø± ØŒ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ø´Ø¨ÙƒØ© Linux ØŒ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÙŠØµÙ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ø­Ø¯ÙŠØ«Ù‡ ÙÙŠ Linux Plumbers 2018 </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">"Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯ÙŠØ« Ù„Ø§ ÙŠØªØ¹Ù„Ù‚ Ø¨Ù€ XDP"</font></a><font style="vertical-align: inherit;"> (XDP Ù‡ÙŠ Ø¥Ø­Ø¯Ù‰ Ø·Ø±Ù‚ Ø§Ø³ØªØ®Ø¯Ø§Ù… BPF). ÙŠÙ‚Ø±Ø£ Brendan Gregg Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙŠ ØªØ³Ù…Ù‰ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux BPF Superpowers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÙŠØ¶Ø­Ùƒ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Toke HÃ¸iland-JÃ¸rgensen </font><font style="vertical-align: inherit;">Ø£Ù† Ø§Ù„Ù‚Ù„Ø¨ Ø£ØµØ¨Ø­ Ø§Ù„Ø¢Ù† microkernel. ÙŠØµÙ ØªÙˆÙ…Ø§Ø³ ØºØ±Ø§Ù ÙÙƒØ±Ø© Ø£Ù† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF Ù‡ÙŠ Ø¬Ø§ÙØ§ Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ù„Ù†ÙˆØ§Ø©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† ÙˆØµÙ Ù…Ù†Ù‡Ø¬ÙŠ Ù„Ù€ BPF Ø¹Ù„Ù‰ Habr ØŒ ÙˆØ¨Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø³Ù„Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø³Ø£Ø­Ø§ÙˆÙ„ Ø£Ù† Ø£Ø®Ø¨Ø± Ø¹Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ ØŒ ÙˆÙˆØµÙ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ± ØŒ ÙˆØªØ­Ø¯ÙŠØ¯ Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆÙ…Ù…Ø§Ø±Ø³Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… BPF. </font><font style="vertical-align: inherit;">ÙÙŠ Ù‡Ø°Ø§ ÙˆØ§Ø­Ø¯ØŒ Ø§Ù„ØµÙØ±ØŒ ÙˆÙ‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø§Ø¯Ø© ÙŠÙ†Ø§Ù‚Ø´ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ù…Ù† BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ©ØŒ ÙˆØªÙƒØ´Ù Ø£Ø³Ø±Ø§Ø± Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„ØªØ´ØºÙŠÙ„ </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ØŒ </font></font><code>seccomp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ØŒ </font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ØŒ ÙˆØ£ÙƒØ«Ø± Ù…Ù† Ø°Ù„Ùƒ.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªØ·ÙˆÙŠØ± BPF Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø¬ØªÙ…Ø¹ Ø´Ø¨ÙƒØ© Linux ØŒ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù€ BPF Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© ØŒ ÙˆØ¨Ø§Ù„ØªØ§Ù„ÙŠ ØŒ Ø¨Ø¹Ø¯ Ø¥Ø°Ù† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eucariot @</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ØŒ Ù‚Ù…Øª Ø¨ØªØ³Ù…ÙŠØ© BPF Ù„Ø£ØµØºØ± Ø³Ù„Ø³Ù„Ø© Ø¹Ù„Ù‰ Ø´Ø±Ù Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø±Ø§Ø¦Ø¹Ø© Ù…Ù† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø§Ù„Ø´Ø¨ÙƒØ§Øª Ù„Ø£ØµØºØ±Ù‡Ø§</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p><a name="habracut"></a><br>
<h2 id="kratkiy-kurs-istorii-bpfbcb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ØªØ§Ø±ÙŠØ® Ù…ÙˆØ¬Ø² Ù„ BPF ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø¬</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ØªÙ‚Ù†ÙŠØ© BPF Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ù‡ÙŠ Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø© ÙˆÙ…Ø¹Ø²Ø²Ø© Ù…Ù† ØªÙ‚Ù†ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø© ØªØ­Ù…Ù„ Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ØŒ ØªØ³Ù…Ù‰ Ø§Ù„Ø¢Ù† ØŒ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ùƒ ØŒ BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ©. ÙˆØ¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ©ØŒ ÙˆÙ‡ÙŠ Ø§Ù„Ø£Ø¯Ø§Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ© </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ØŒ ÙˆÙ‡ÙŠ Ø¢Ù„ÙŠØ© </font></font><code>seccomp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ØŒ ÙØ¶Ù„Ø§ Ø¹Ù† ÙˆØ­Ø¯Ø© Ø£Ù‚Ù„ Ù…Ø¹Ø±ÙˆÙØ© </font></font><code>xt_bpf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ù„ </font></font><code>iptables</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÙˆØ§Ù„Ù…ØµÙ†Ù ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ </font></font><code>cls_bpf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. ÙÙŠ Ù„ÙŠÙ†ÙƒØ³ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© ØŒ ØªØªÙ… ØªØ±Ø¬Ù…Ø© Ø¨Ø±Ø§Ù…Ø¬ BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ù‰ Ø´ÙƒÙ„ Ø¬Ø¯ÙŠØ¯ ØŒ ÙˆÙ…Ø¹ Ø°Ù„Ùƒ ØŒ Ù…Ù† ÙˆØ¬Ù‡Ø© Ù†Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØŒ Ø¸Ù„Øª ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙÙŠ Ù…ÙƒØ§Ù†Ù‡Ø§ ÙˆÙ„Ø§ ØªØ²Ø§Ù„ Ù‡Ù†Ø§Ùƒ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ© ØŒ ÙƒÙ…Ø§ Ø³Ù†Ø±Ù‰ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‚Ø§Ù„Ø©. Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¨Ø¨ ØŒ ÙˆØ£ÙŠØ¶Ù‹Ø§ Ù„Ø£Ù† Ø§ØªØ¨Ø§Ø¹ ØªØ§Ø±ÙŠØ® ØªØ·ÙˆØ± BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ ÙÙŠ Linux ØŒ Ø³ÙŠØµØ¨Ø­ Ù…Ù† Ø§Ù„ÙˆØ§Ø¶Ø­ ÙƒÙŠÙ ÙˆÙ„Ù…Ø§Ø°Ø§ ØªØ·ÙˆØ±Øª Ø¥Ù„Ù‰ Ø´ÙƒÙ„ Ø­Ø¯ÙŠØ« ØŒ Ù‚Ø±Ø±Øª Ø£Ù† Ø£Ø¨Ø¯Ø£ Ø¨Ù…Ù‚Ø§Ù„ Ø­ÙˆÙ„ BPF Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ÙÙŠ Ø£ÙˆØ§Ø®Ø± Ø§Ù„Ø«Ù…Ø§Ù†ÙŠÙ†ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ù…Ø§Ø¶ÙŠ ØŒ Ø£ØµØ¨Ø­ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙˆÙ† Ù…Ù† Ù…Ø®ØªØ¨Ø± Ù„ÙˆØ±Ù†Ø³ Ø¨ÙŠØ±ÙƒÙ„ÙŠ Ø§Ù„Ø´Ù‡ÙŠØ± Ù…Ù‡ØªÙ…ÙŠÙ† Ø¨Ù…Ø³Ø£Ù„Ø© ÙƒÙŠÙÙŠØ© ØªØµÙÙŠØ© Ø­Ø²Ù… Ø§Ù„Ø´Ø¨ÙƒØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ÙÙŠ Ø£ÙˆØ§Ø®Ø± Ø§Ù„Ø«Ù…Ø§Ù†ÙŠÙ†ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ù…Ø§Ø¶ÙŠ. ÙƒØ§Ù†Øª ÙÙƒØ±Ø© Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØŒ Ø§Ù„ØªÙŠ ØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§ ÙÙŠ Ø§Ù„Ø£ØµÙ„ ÙÙŠ ØªÙ‚Ù†ÙŠØ© CSPF (CMU / Stanford Packet Filter) ØŒ Ù‡ÙŠ ØªØµÙÙŠØ© Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ø²Ø§Ø¦Ø¯Ø© ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ† ØŒ Ø£ÙŠ ÙÙŠ Ù…Ø³Ø§Ø­Ø© kernel ØŒ Ù„Ø£Ù† Ù‡Ø°Ø§ ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨Ø¹Ø¯Ù… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ù„Ø¶Ù…Ø§Ù† Ø£Ù…Ø§Ù† ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„ØªØ´ØºÙŠÙ„ Ø±Ù…Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù…Ø³Ø§Ø­Ø© kernel ØŒ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù‡Ø§Ø² Ø§ÙØªØ±Ø§Ø¶ÙŠ - ÙˆØ¶Ø¹ Ø§Ù„Ø­Ù…Ø§ÙŠØ©.</font></font></p><br>
<p>                  RISC     .      Berkeley Labs     BPF (Berkeley Packet Filters),          Motorola 6502 â€”       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">Apple II</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">NES</a>.              .</p><br>
<h2 id="arhitektura-mashiny-bpf">  BPF</h2><br>
<p>    -,  .      ,         32- ,  <code>A</code>    <code>X</code>, 64   (16 ),      ,         .           ,            , ..,  ,   .</p><br>
<p>    .      BPF ,   <em>-</em>   (,  ),      <em>-</em>     (,  â€”       ).       (,  ),      <em>-</em>    (,   ).</p><br>
<p>      ,    :         .                ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">The BSD Packet Filter</a> /    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">Documentation/networking/filter.txt</a>   .  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>libpcap</code>: An Architecture and Optimization Methodology for Packet Capture</a>,   McCanne,    BPF,     <code>libpcap</code>.</p><br>
<p>          BPF  Linux: <code>tcpdump</code> (<code>libpcap</code>), seccomp, <code>xt_bpf</code>, <code>cls_bpf</code>.</p><br>
<h2 id="tcpdump">tcpdump</h2><br>
<p> BPF         â€”    <code>tcpdump</code>. ,            BPF,     ,       .</p><br>
<p>(        Linux <code>5.6.0-rc6</code>.       .)</p><br>
<h3 id="primer-nablyudaem-ipv6-pakety">:  IPv6 </h3><br>
<p>,       IPv6    <code>eth0</code>.       <code>tcpdump</code>    <code>ip6</code>:</p><br>
<pre><code class="plaintext hljs">$ sudo tcpdump -i eth0 ip6</code></pre><br>
<p>  <code>tcpdump</code>   <code>ip6</code>  -  BPF      (.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Tcpdump: </a>).       ,    <code>eth0</code>.      <code>n</code>,   <code>n</code>              <code>tcpdump</code>.</p><br>
<p><img src="https://habrastorage.org/webt/nr/ic/k2/nrick2ybbxd1zccf_hevtdof2a0.png"></p><br>
<p>,           <code>tcpdump</code>    <code>tcpdump</code>,      <code>-d</code>:</p><br>
<pre><code class="plaintext hljs">$ sudo tcpdump -i eth0 -d ip6<font></font>
(000) ldh      [12]<font></font>
(001) jeq      #0x86dd          jt 2    jf 3<font></font>
(002) ret      #262144<font></font>
(003) ret      #0</code></pre><br>
<p>      <code>ldh [12]</code>,    Â«   <code>A</code> - (16 ),    12Â»    â€”      ?    ,    <code>x</code>  <code>(x+1)</code>-    .     Ethernet  <code>eth0</code>,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>,      (   ,     VLAN ):</p><br>
<pre><code class="plaintext hljs">       6              6          2<font></font>
|Destination MAC|Source MAC|Ether Type|...|</code></pre><br>
<p>    <code>ldh [12]</code>   <code>A</code>   <code>Ether Type</code> â€”     Ethernet- .   1     <code>A</code> ( ) c <code>0x86dd</code>,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a>    IPv6.   1        â€” <code>jt 2</code>  <code>jf 3</code> â€” ,         (<code>A == 0x86dd</code>)  . ,    (IPv6)     2,    â€”   3.   3     0 (  ),   2     262144 (   256  ).</p><br>
<h3 id="primer-poslozhnee-smotrim-na-tcp-pakety-po-portu-naznacheniya"> :   TCP    </h3><br>
<p>   ,    TCP     666.    IPv4,    IPv6 .    ,          IPv6 (<code>ip6 and tcp dst port 666</code>)      (<code>tcp dst port 666</code>). ,      :</p><br>
<pre><code class="plaintext hljs">$ sudo tcpdump -i eth0 -d ip and tcp dst port 666<font></font>
(000) ldh      [12]<font></font>
(001) jeq      #0x800           jt 2    jf 10<font></font>
(002) ldb      [23]<font></font>
(003) jeq      #0x6             jt 4    jf 10<font></font>
(004) ldh      [20]<font></font>
(005) jset     #0x1fff          jt 10   jf 6<font></font>
(006) ldxb     4*([14]&amp;0xf)<font></font>
(007) ldh      [x + 16]<font></font>
(008) jeq      #0x29a           jt 9    jf 10<font></font>
(009) ret      #262144<font></font>
(010) ret      #0</code></pre><br>
<p>   0  1   .   2   ,   IPv4  (Ether Type = <code>0x800</code>)     <code>A</code> 24-  .    </p><br>
<pre><code class="plaintext hljs">       14            8      1     1<font></font>
|ethernet header|ip fields|ttl|protocol|...|</code></pre><br>
<p>      <code>A</code>  Protocol  IP,  ,       TCP .   Protocol  <code>0x6</code> (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>IPPROTO_TCP</code></a>)   3.</p><br>
<p>  4  5   ,    20,     <code>jset</code> ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a> â€”    <code>jset</code>    .      ,      IP ,   ,      .        .         ,      .</p><br>
<p> 6 â€”     .  <code>ldxb 4*([14]&amp;0xf)</code> ,      <code>X</code>      ,   4.      â€”   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">Internet Header Length</a>  IPv4,       ,       4. ,   <code>4*([14]&amp;0xf)</code> â€”     ,            <code>X</code>, ..      <code>ldb 4*([14]&amp;0xf)</code>  <code>ldxb 5*([14]&amp;0xf)</code> (     offset, , <code>ldxb 4*([16]&amp;0xf)</code>). ,        BPF   ,    <code>X</code> ( )   IPv4.</p><br>
<p> ,   7    -,   <code>(X+16)</code>. ,  14    Ethernet,  <code>X</code>    IPv4,  ,   <code>A</code>    TCP:</p><br>
<pre><code class="plaintext hljs">       14           X           2             2<font></font>
|ethernet header|ip header|source port|destination port|</code></pre><br>
<p>,   8           9  10   â€”    .</p><br>
<h3 id="tcpdump-zagruzka">Tcpdump: </h3><br>
<p>         ,     BPF      .  , <code>tcpdump</code>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>tcpdump</code></a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>libpcap</code></a>. ,        <code>libpcap</code>,   :</p><br>
<ul>
<li>   <code>pcap_t</code>   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>pcap_create</code></a>,</li>
<li> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>pcap_activate</code></a>,</li>
<li> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>pcap_compile</code></a>,</li>
<li> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>pcap_setfilter</code></a>.</li>
</ul><br>
<p> ,     <code>pcap_setfilter</code>   Linux,   <code>strace</code> (   ):</p><br>
<pre><code class="plaintext hljs">$ sudo strace -f -e trace=%network tcpdump -p -i eth0 ip<font></font>
socket(AF_PACKET, SOCK_RAW, 768)        = 3<font></font>
bind(3, {sa_family=AF_PACKET, sll_protocol=htons(ETH_P_ALL), sll_ifindex=if_nametoindex("eth0"), sll_hatype=ARPHRD_NETROM, sll_pkttype=PACKET_HOST, sll_halen=0}, 20) = 0<font></font>
setsockopt(3, SOL_SOCKET, SO_ATTACH_FILTER, {len=4, filter=0xb00bb00bb00b}, 16) = 0<font></font>
...</code></pre><br>
<p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">raw </a>    Ethernet       <code>eth0</code>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">  </a>  ,   <code>ip</code>     BPF ,      ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>SO_ATTACH_FILTER</code></a>   <code>setsockopt</code>       4.     .</p><br>
<p> ,    BPF         ,     BPF           .</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><p>      :</p><br>
<pre><code class="plaintext hljs">$ sudo strace -f -e trace=%network tcpdump -p -i eth0 ip<font></font>
socket(AF_PACKET, SOCK_RAW, 768)        = 3<font></font>
bind(3, {sa_family=AF_PACKET, sll_protocol=htons(ETH_P_ALL), sll_ifindex=if_nametoindex("eth0"), sll_hatype=ARPHRD_NETROM, sll_pkttype=PACKET_HOST, sll_halen=0}, 20) = 0<font></font>
setsockopt(3, SOL_SOCKET, SO_ATTACH_FILTER, {len=1, filter=0xbeefbeefbeef}, 16) = 0<font></font>
recvfrom(3, 0x7ffcad394257, 1, MSG_TRUNC, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)<font></font>
setsockopt(3, SOL_SOCKET, SO_ATTACH_FILTER, {len=4, filter=0xb00bb00bb00b}, 16) = 0<font></font>
...</code></pre><br>
<p>   ,           5,      3  4? ,  <code>libpcap</code>    â€”  ,        ,   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>   <code>ret #0</code> (  ),          ,      .</p></div></div><br>
<p>,     Linux    BPF,        <code>struct sock_fprog</code>   ,            <code>setsockopt</code>.</p><br>
<p>,       ,    raw.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a> ,   ,        UDP . (    ,    .)</p><br>
<p>   <code>setsockopt</code>    .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">socket(7)</a>,       <code>struct sock_fprog</code>   <code>tcpdump</code>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="> BPF    </a>.</p><br>
<h2 id="klassicheskiy-bpf-i-xxi-vek"> BPF  XXI </h2><br>
<p>BPF    Linux  1997        <code>libpcap</code>    (Linux- , , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>,      ).    ,  BPF     2011 ,  Eric Dumazet  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>,    Just In Time Compiler â€”     BPF   <code>x86_64</code> .</p><br>
<p>JIT compiler     :  2012  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">seccomp</a>,  BPF,   2013  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>  <code>xt_bpf</code>,     <code>iptables</code>   BPF,    2013  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>    <code>cls_bpf</code>,     BPF  .</p><br>
<p>      ,             BPF,   ,   <code>libpcap</code>  ( : ,  <code>libpcap</code>      â€” 0  0x40000)  ,    seccomp, .</p><br>
<h2 id="programmiruem-bpf-pri-pomoschi-sobstvennyh-ruk"> BPF    </h2><br>
<p>     BPF,   :</p><br>
<pre><code class="plaintext hljs">   16    8    8     32<font></font>
| code | jt | jf |  k  |</code></pre><br>
<p>   64 ,    16  â€”   ,     , <code>jt</code>  <code>jf</code>,  32    <code>K</code>,       . ,  <code>ret</code>,      <code>6</code>,       <code>K</code>.   C   BPF    </p><br>
<pre><code class="plaintext hljs">struct sock_filter {<font></font>
        __u16   code;<font></font>
        __u8    jt;<font></font>
        __u8    jf;<font></font>
        __u32   k;<font></font>
}</code></pre><br>
<p>   â€”   </p><br>
<pre><code class="plaintext hljs">struct sock_fprog {<font></font>
        unsigned short len;<font></font>
        struct sock_filter *filter;<font></font>
}</code></pre><br>
<p> ,      (  , ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">[1]</a>).      <code>ip6</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">  </a>:</p><br>
<pre><code class="plaintext hljs">struct sock_filter code[] = {<font></font>
        { 0x28, 0, 0, 0x0000000c },<font></font>
        { 0x15, 0, 1, 0x000086dd },<font></font>
        { 0x06, 0, 0, 0x00040000 },<font></font>
        { 0x06, 0, 0, 0x00000000 },<font></font>
};<font></font>
struct sock_fprog prog = {<font></font>
        .len = ARRAY_SIZE(code),<font></font>
        .filter = code,<font></font>
};</code></pre><br>
<p> <code>prog</code>      </p><br>
<pre><code class="plaintext hljs">setsockopt(sk, SOL_SOCKET, SO_ATTACH_FILTER, &amp;prog, sizeof(prog))</code></pre><br>
<p>        ,    (,  ,  -,      ..).     <code>&lt;linux/filter.h&gt;</code>  - â€”   ,   ,     </p><br>
<pre><code class="plaintext hljs">struct sock_filter code[] = {<font></font>
        BPF_STMT(BPF_LD|BPF_H|BPF_ABS, 12),<font></font>
        BPF_JUMP(BPF_JMP|BPF_JEQ|BPF_K, ETH_P_IPV6, 0, 1),<font></font>
        BPF_STMT(BPF_RET|BPF_K, 0x00040000),<font></font>
        BPF_STMT(BPF_RET|BPF_K, 0),<font></font>
}</code></pre><br>
<p>,     - .      Linux     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>tools/bpf</code></a>           BPF.</p><br>
<p>       <code>tcpdump</code>,        . ,  ,    ,  TCP/IPv4:</p><br>
<pre><code class="plaintext hljs">$ cat /tmp/tcp-over-ipv4.bpf<font></font>
ldh [12]<font></font>
jne #0x800, drop<font></font>
ldb [23]<font></font>
jneq #6, drop<font></font>
ret #-1<font></font>
drop: ret #0</code></pre><br>
<p>       <code>&lt; &gt;,&lt;code1&gt; &lt;jt1&gt; &lt;jf1&gt; &lt;k1&gt;,...</code>,     TCP </p><br>
<pre><code class="plaintext hljs">$ tools/bpf/bpf_asm /tmp/tcp-over-ipv4.bpf<font></font>
6,40 0 0 12,21 0 3 2048,48 0 0 23,21 0 1 6,6 0 0 4294967295,6 0 0 0,</code></pre><br>
<p>  C      :</p><br>
<pre><code class="plaintext hljs">$ tools/bpf/bpf_asm -c /tmp/tcp-over-ipv4.bpf<font></font>
{ 0x28,  0,  0, 0x0000000c },<font></font>
{ 0x15,  0,  3, 0x00000800 },<font></font>
{ 0x30,  0,  0, 0x00000017 },<font></font>
{ 0x15,  0,  1, 0x00000006 },<font></font>
{ 0x06,  0,  0, 0xffffffff },<font></font>
{ 0x06,  0,  0, 0000000000 },</code></pre><br>
<p>        <code>struct sock_filter</code>,        .</p><br>
<h3 id="rasshireniya-linux-i-netsniff-ng"> Linux  netsniff-ng</h3><br>
<p>   BPF, Linux  <code>tools/bpf/bpf_asm</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a>.  ,        <code>struct sk_buff</code>,     . ,   -  ,  <code>ldw cpu</code>    <code>A</code>     <code>raw_smp_processor_id()</code>. (   BPF           kernel helpers    , ,   .)    ,          ,   <code>poff</code>, payload offset:</p><br>
<pre><code class="plaintext hljs">ld poff<font></font>
ret a</code></pre><br>
<p> BPF     <code>tcpdump</code>,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>netsniff-ng</code></a>, ,   ,    <code>netsniff-ng</code>, ,     BPF      ,   ,  <code>tools/bpf/bpf_asm</code>,  BPF   <code>bpfc</code>.     , .     .</p><br>
<h2 id="seccomp">seccomp</h2><br>
<p>,     BPF         ,    â€”   seccomp,     BPF       ,      .</p><br>
<p>  seccomp      2005      ,       â€”    ,  , : <code>read</code>, <code>write</code>, <code>exit</code>  <code>sigreturn</code>,  ,      <code>SIGKILL</code>.   2012   seccomp     BPF ,             . (,         Chrome,       Chrome   KRSI,     BPF    Linux Security Modules.)         .</p><br>
<p>,         seccomp,  -     ( )   .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">  : seccomp</a>    seccomp,   2007 ,      BPF (    libseccomp),    seccomp  Docker,      .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">   systemd  Â«   Docker  !Â»</a> ,  ,  ,             systemd.</p><br>
<p>         <code>seccomp</code>   C     <code>libseccomp</code>         ,     seccomp   <code>strace</code>.</p><br>
<h3 id="pishem-i-zagruzhaem-filtry-dlya-seccomp">     seccomp</h3><br>
<p>    BPF         seccomp.      ,        .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>seccomp(2)</code></a>:</p><br>
<pre><code class="plaintext hljs">seccomp(SECCOMP_SET_MODE_FILTER, flags, &amp;filter)</code></pre><br>
<p> <code>&amp;filter</code> â€”        <code>struct sock_fprog</code>, ..  BPF.</p><br>
<p>     seccomp    ?  .   ,    ,  ,    seccomp    </p><br>
<pre><code class="plaintext hljs">struct seccomp_data {<font></font>
    int   nr;<font></font>
    __u32 arch;<font></font>
    __u64 instruction_pointer;<font></font>
    __u64 args[6];<font></font>
};</code></pre><br>
<p> <code>nr</code> â€”     , <code>arch</code> â€”   (  ), <code>args</code> â€”     ,  <code>instruction_pointer</code> â€”       ,     .  , ,        <code>A</code>   </p><br>
<pre><code class="plaintext hljs">ldw [0]</code></pre><br>
<p>  seccomp    , ,       32-     -   â€”     <code>ldh [0]</code>   <code>seccomp</code>  <code>EINVAL</code>.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><code>seccomp_check_filter()</code></a> . ( ,   ,   seccomp,          <code>mod</code> (  )      seccomp BPF ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a> ABI.)</p><br>
<p> ,    ,     seccomp .           ,  </p><br>
<pre><code class="plaintext hljs">ld [0]<font></font>
jeq #304, bad<font></font>
jeq #176, bad<font></font>
jeq #239, bad<font></font>
jeq #279, bad<font></font>
good: ret #0x7fff0000 /* SECCOMP_RET_ALLOW */<font></font>
bad: ret #0</code></pre><br>
<p>         304, 176, 239, 279.      ?     ,          .   seccomp <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>       (       <code>arch</code>  <code>struct seccomp_data</code>).        :</p><br>
<pre><code class="plaintext hljs">ld [4]<font></font>
jne #0xc000003e, bad_arch ; SCMP_ARCH_X86_64</code></pre><br>
<p>         .</p><br>
<h3 id="pishem-i-zagruzhaem-filtry-dlya-seccomp-pri-pomoschi-libseccomp">     seccomp   <code>libseccomp</code></h3><br>
<p>        BPF      ,          /  .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">libseccomp</a>,         .</p><br>
<p>, ,  ,       , , ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="> </a> (    ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>):</p><br>
<pre><code class="plaintext hljs">#include &lt;seccomp.h&gt;<font></font>
#include &lt;unistd.h&gt;<font></font>
#include &lt;err.h&gt;<font></font>
<font></font>
static int sys_numbers[] = {<font></font>
        __NR_mount,<font></font>
        __NR_umount2,<font></font>
       // ...  40   ...<font></font>
        __NR_vmsplice,<font></font>
        __NR_perf_event_open,<font></font>
};<font></font>
<font></font>
int main(int argc, char **argv)<font></font>
{<font></font>
        scmp_filter_ctx ctx = seccomp_init(SCMP_ACT_ALLOW);<font></font>
<font></font>
        for (size_t i = 0; i &lt; sizeof(sys_numbers)/sizeof(sys_numbers[0]); i++)<font></font>
                seccomp_rule_add(ctx, SCMP_ACT_TRAP, sys_numbers[i], 0);<font></font>
<font></font>
        seccomp_load(ctx);<font></font>
<font></font>
        execvp(argv[1], &amp;argv[1]);<font></font>
        err(1, "execlp: %s", argv[1]);<font></font>
}</code></pre><br>
<p>    <code>sys_numbers</code>  40+     . ,   <code>ctx</code>   ,     (<code>SCMP_ACT_ALLOW</code>)    - (   ). ,   ,        .           <code>SCMP_ACT_TRAP</code>,    seccomp    <code>SIGSYS</code>   ,      . ,        <code>seccomp_load</code>,             <code>seccomp(2)</code>.</p><br>
<p>        <code>libseccomp</code>, :</p><br>
<pre><code class="plaintext hljs">cc -std=c17 -Wall -Wextra -c -o seccomp_lib.o seccomp_lib.c<font></font>
cc -o seccomp_lib seccomp_lib.o -lseccomp</code></pre><br>
<p>  :</p><br>
<pre><code class="plaintext hljs">$ ./seccomp_lib echo ok<font></font>
ok</code></pre><br>
<p>   :</p><br>
<pre><code class="plaintext hljs">$ sudo ./seccomp_lib mount -t bpf bpf /tmp<font></font>
Bad system call</code></pre><br>
<p> <code>strace</code>,   :</p><br>
<pre><code class="plaintext hljs">$ sudo strace -e seccomp ./seccomp_lib mount -t bpf bpf /tmp<font></font>
seccomp(SECCOMP_SET_MODE_FILTER, 0, {len=50, filter=0x55d8e78428e0}) = 0<font></font>
--- SIGSYS {si_signo=SIGSYS, si_code=SYS_SECCOMP, si_call_addr=0xboobdeadbeef, si_syscall=__NR_mount, si_arch=AUDIT_ARCH_X86_64} ---<font></font>
+++ killed by SIGSYS (core dumped) +++<font></font>
Bad system call</code></pre><br>
<p>   ,     -     <code>mount(2)</code>.</p><br>
<p>,       <code>libseccomp</code>,      .              ,    â€”    .     libseccomp  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a>,     <code>SCMP_FLTATR_CTL_OPTIMIZE</code>.      2,        .</p><br>
<p>        ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a>,      BPF     , :</p><br>
<pre><code class="plaintext hljs">$ echo 1 3 6 8 13 | ./generate_bin_search_bpf.py<font></font>
ld [0]<font></font>
jeq #6, bad<font></font>
jgt #6, check8<font></font>
jeq #1, bad<font></font>
jeq #3, bad<font></font>
ret #0x7fff0000<font></font>
check8:<font></font>
jeq #8, bad<font></font>
jeq #13, bad<font></font>
ret #0x7fff0000<font></font>
bad: ret #0</code></pre><br>
<p>      ,    BPF       (   , , <code>jmp A</code>  <code>jmp [label+X]</code>)     .</p><br>
<h3 id="seccomp-i-strace">seccomp  strace</h3><br>
<p>   <code>strace</code> â€”        Linux. ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">  </a>    .   ,  <code>strace</code>    <code>ptrace(2)</code>,        ,          , .., , </p><br>
<pre><code class="plaintext hljs">$ time strace du /usr/share/ &gt;/dev/null 2&gt;&amp;1<font></font>
<font></font>
real    0m3.081s<font></font>
user    0m0.531s<font></font>
sys     0m2.073s</code></pre><br>
<p></p><br>
<pre><code class="plaintext hljs">$ time strace -e open du /usr/share/ &gt;/dev/null 2&gt;&amp;1<font></font>
<font></font>
real    0m2.404s<font></font>
user    0m0.193s<font></font>
sys     0m1.800s</code></pre><br>
<p>       ,           .</p><br>
<p>  <code>--seccomp-bpf</code>,   <code>strace</code>  5.3,                  :</p><br>
<pre><code class="plaintext hljs">$ time strace --seccomp-bpf -e open du /usr/share/ &gt;/dev/null 2&gt;&amp;1<font></font>
<font></font>
real    0m0.148s<font></font>
user    0m0.017s<font></font>
sys     0m0.131s<font></font>
<font></font>
$ time du /usr/share/ &gt;/dev/null 2&gt;&amp;1<font></font>
<font></font>
real    0m0.140s<font></font>
user    0m0.024s<font></font>
sys     0m0.116s</code></pre><br>
<p>(, ,     ,         .    , , <code>newfsstat</code>,  <code>strace</code>     ,    <code>--seccomp-bpf</code>.)</p><br>
<p>    ?   <code>strace</code>         <code>PTRACE_SYSCALL</code>.     ()  ,   <code>strace</code>,            <code>PTRACE_SYSCALL</code>.                <code>strace</code>,           <code>PTRACE_SYSCALL</code>,  ..</p><br>
<p><img src="https://habrastorage.org/webt/dj/j8/a4/djj8a4dctzklio2sa4id4crjyfu.png"></p><br>
<p>  seccomp, ,      ,    . ,         <code>X</code>,     BPF ,   <code>X</code>   <code>SECCOMP_RET_TRACE</code>,       â€” <code>SECCOMP_RET_ALLOW</code>:</p><br>
<pre><code class="plaintext hljs">ld [0]<font></font>
jneq #X, ignore<font></font>
trace: ret #0x7ff00000<font></font>
ignore: ret #0x7fff0000</code></pre><br>
<p>   <code>strace</code>     <code>PTRACE_CONT</code>,       ,     <code>X</code>,    ,    <code>X</code>,  seccomp   <code>strace</code>,         <code>PTRACE_SYSCALL</code> (   seccomp         ).    , <code>strace</code>     <code>PTRACE_CONT</code>       seccomp.</p><br>
<p><img src="https://habrastorage.org/webt/ab/_w/hq/ab_whqf0ydyk7dpwaeem7md2poe.png"></p><br>
<p>   <code>--seccomp-bpf</code>   . -,        ( <code>-p</code>  <code>strace</code>),      seccomp. -,   <em></em>    ,   seccomp         .</p><br>
<p>       <code>strace</code>   <code>seccomp</code>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a>.        ,   BPF   seccomp     .</p><br>
<h2 id="xt_bpf"><code>xt_bpf</code></h2><br>
<p>     .</p><br>
<p>: -,  2007 ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>  <code>xt_u32</code>  netfilter.            <code>cls_u32</code>        iptables     :  32          . ,</p><br>
<pre><code class="plaintext hljs">sudo iptables -A INPUT -m u32 --u32 "6&amp;0xFF=1" -j LOG --log-prefix "seen-by-xt_u32"</code></pre><br>
<p> 32   IP,    6,      <code>0xFF</code> (  ).  â€”  <code>protocol</code>  IP      1 (ICMP).       ,      <code>@</code> â€”   X  . , </p><br>
<pre><code class="plaintext hljs">iptables -m u32 --u32 "6&amp;0xFF=0x6 &amp;&amp; 0&gt;&gt;22&amp;0x3C@4=0x29"</code></pre><br>
<p>,    TCP Sequence Number <code>0x29</code>.      ,    ,        .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">BPF â€” the forgotten bytecode</a>,           <code>xt_u32</code>. .      .</p><br>
<p>  2013     <code>xt_u32</code>     BPF  <code>xt_bpf</code>.           :   BPF    iptables.    , , :</p><br>
<pre><code class="plaintext hljs">iptables -A INPUT -m bpf --bytecode &lt;&gt; -j LOG</code></pre><br>
<p> <code>&lt;&gt;</code> â€”       <code>bpf_asm</code> -, ,</p><br>
<pre><code class="plaintext hljs">$ cat /tmp/test.bpf<font></font>
ldb [9]<font></font>
jneq #17, ignore<font></font>
ret #1<font></font>
ignore: ret #0<font></font>
<font></font>
$ bpf_asm /tmp/test.bpf<font></font>
4,48 0 0 9,21 0 1 17,6 0 0 1,6 0 0 0,<font></font>
<font></font>
# iptables -A INPUT -m bpf --bytecode "$(bpf_asm /tmp/test.bpf)" -j LOG</code></pre><br>
<p>      UDP .   BPF    <code>xt_bpf</code>, ,    ,   iptables â€”    IPv4.    BPF  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"></a>,  <code>false</code> ,    .</p><br>
<p>,   <code>xt_bpf</code>    ,    .        Cloudfare.       <code>xt_bpf</code>    DDoS .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">Introducing the BPF Tools</a>    ( )   BPF           . ,    <code>bpfgen</code>   BPF ,   DNS-   <code>habr.com</code>:</p><br>
<pre><code class="plaintext hljs">$ ./bpfgen --assembly dns -- habr.com<font></font>
ldx 4*([0]&amp;0xf)<font></font>
ld #20<font></font>
add x<font></font>
tax<font></font>
<font></font>
lb_0:<font></font>
    ld [x + 0]<font></font>
    jneq #0x04686162, lb_1<font></font>
    ld [x + 4]<font></font>
    jneq #0x7203636f, lb_1<font></font>
    ldh [x + 8]<font></font>
    jneq #0x6d00, lb_1<font></font>
    ret #65535<font></font>
<font></font>
lb_1:<font></font>
    ret #0</code></pre><br>
<p>       <code>X</code>    <code>\x04habr\x03com\x00</code>  UDP-    : <code>0x04686162 &lt;-&gt; "\x04hab"</code>  ..</p><br>
<p>  Cloudfare    p0f -&gt; BPF.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">Introducing the p0f BPF compiler</a>    ,   p0f    p0f   BPF:</p><br>
<pre><code class="plaintext hljs">$ ./bpfgen p0f -- 4:64:0:0:*,0::ack+:0<font></font>
39,0 0 0 0,48 0 0 8,37 35 0 64,37 0 34 29,48 0 0 0,<font></font>
84 0 0 15,21 0 31 5,48 0 0 9,21 0 29 6,40 0 0 6,<font></font>
...</code></pre><br>
<p>   Cloudfare    <code>xt_bpf</code>,      XDP â€”       BPF, . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">L4Drop: XDP DDoS Mitigations</a>.</p><br>
<h2 id="cls_bpf"><code>cls_bpf</code></h2><br>
<p>     BPF   â€”   <code>cls_bpf</code>      Linux,   Linux   2013      <code>cls_u32</code>.</p><br>
<p>, ,      <code>cls_bpf</code>,         BPF      â€”      .   ,   ,   Extended BPF,        .</p><br>
<p>        BPF c <code>cls_bpf</code>   ,     Extended BPF       :              .</p><br>
<p>       BPF    .</p><br>
<h2 id="proschanie-s-classic-bpf">  classic BPF</h2><br>
<p>   ,   BPF,              . ,       RISC,      BPF,      32-  64-    BPF  .  ,   BPF       â€”         BPF ,      ,     ,       <code>sk_buff</code>    -,       .</p><br>
<p>  ,      BPF  Linux   API ,      ,       seccomp,     , Extended BPF. (          .)</p><br>
<p>      2013 ,       BPF.  2014    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a>  .   ,       JIT-compiler      64- ,            Linux.</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø³ØªØªØ­Ø¯Ø« Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø¹Ù† Ø¨Ù†ÙŠØ© ÙˆØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØŒ Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª ØªØ¹Ø±Ù Ø£ØµÙ„Ø§Ù‹ Ø¨Ø§Ø³Ù… BPF Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ØŒ Ø«Ù… Ù…Ø¯Ø¯Øª BPF ØŒ ÙˆØ§Ù„Ø¢Ù† Ø¨Ø¨Ø³Ø§Ø·Ø© BPF.</font></font></p><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹</font></font></b><div class="spoiler_text"><ol>
<li>Steven McCanne and Van Jacobson, "The BSD Packet Filter: A New Architecture for User-level Packet Capture", <code>https://www.tcpdump.org/papers/bpf-usenix93.pdf</code></li>
<li>Steven McCanne, "libpcap: An Architecture and Optimization Methodology for Packet Capture", <code>https://sharkfestus.wireshark.org/sharkfest.11/presentations/McCanne-Sharkfest'11_Keynote_Address.pdf</code></li>
<li><code>tcpdump</code>, <code>libpcap</code>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">https://www.tcpdump.org/</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">IPtable U32 Match Tutorial</a>.</li>
<li>BPF â€” the forgotten bytecode: <code>https://blog.cloudflare.com/bpf-the-forgotten-bytecode/</code></li>
<li>Introducing the BPF Tool: <code>https://blog.cloudflare.com/introducing-the-bpf-tools/</code></li>
<li><code>bpf_cls</code>: <code>http://man7.org/linux/man-pages/man8/tc-bpf.8.html</code></li>
<li>A seccomp overview: <code>https://lwn.net/Articles/656307/</code></li>
<li><code>https://github.com/torvalds/linux/blob/master/Documentation/userspace-api/seccomp_filter.rst</code></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">habr:   : seccomp</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">habr:    systemd  Â«   Docker  !Â»</a></li>
<li>Paul Chaignon, "strace --seccomp-bpf: a look under the hood", <code>https://fosdem.org/2020/schedule/event/debugging_strace_bpf/</code></li>
<li><code>netsniff-ng</code>: <code>http://netsniff-ng.org/</code></li>
</ol></div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar493862/index.html">Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø« Sauber Alfa Romeo F1 Ù…Ø¬Ù‡Ø² Ø¨Ù€ 143 Ø¬Ø²Ø¡ Ù…Ø·Ø¨ÙˆØ¹ Ø¹Ù„Ù‰ Ø·Ø§Ø¨Ø¹Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</a></li>
<li><a href="../ar493864/index.html">Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù†Ø§Ø´Ø¦Ø© Ù…Ù† Ø³ÙŠÙƒÙˆÙŠØ§ ÙƒØ§Ø¨ÙŠØªØ§Ù„ Ø¨Ø´Ø£Ù† ÙÙŠØ±ÙˆØ³Ø§Øª Ø§Ù„ØªØ§Ø¬ÙŠØ©</a></li>
<li><a href="../ar493866/index.html">Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø¨ÙˆØ§Ø¨Ø© Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„ØµÙØ±</a></li>
<li><a href="../ar493870/index.html">Biogelx ÙˆØ¯ÙˆØ± Ø§Ù„Ø­Ø¨Ø± Ø§Ù„Ø­ÙŠÙˆÙŠ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</a></li>
<li><a href="../ar493872/index.html">NodeJS: Ø¨Ø¯Ø§ÙŠØ© Ø³Ø±ÙŠØ¹Ø©</a></li>
<li><a href="../ar493882/index.html">Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø¢Ù„ÙŠØ©: Ø§Ù„ØªØ£Ù‡ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø±Ø´Ø§Ø¯ ÙˆØ§Ù„Ø¥Ø±Ù‡Ø§Ù‚</a></li>
<li><a href="../ar493884/index.html">STM32MP1 - kernels + Linux = Ù…ØªØ­ÙƒÙ… Ù…Ø«Ø§Ù„ÙŠ</a></li>
<li><a href="../ar493890/index.html">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ÙˆØ¹ roguelike: Ù…Ù† Rogue Ø¥Ù„Ù‰ Binding of Isaac</a></li>
<li><a href="../ar493892/index.html">ÙƒÙŠÙ ØªØ¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…Ù†Ø²Ù„. Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Deletedman</a></li>
<li><a href="../ar493896/index.html">Intel Pohoiki Springs - Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø¹ØµØ¨ÙŠØ© Ø¨Ù‚ÙˆØ© ÙØ£Ø±Ø© ÙˆØ§Ø­Ø¯Ø©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>