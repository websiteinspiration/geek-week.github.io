<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤶🏾 😙 🕴🏼 RESTinioでC ++テンプレートの4階を構築しています。なぜ、どうやって？ 🐩 🔶 👸🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="RESTinioは比較的小さなプロジェクトで、C ++アプリケーションに組み込まれた非同期HTTPサーバーです。その特徴的な機能は、C ++テンプレートが広く使用されていることです。実装とパブリックAPIの両方で。
 

RESTinioのC ++テンプレートは非常に活発に使用されているため、Hab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>RESTinioでC ++テンプレートの4階を構築しています。なぜ、どうやって？</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456632/"><p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RESTinio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は比較的小さなプロジェクトで、C ++アプリケーションに組み込まれた非同期HTTPサーバーです。</font><font style="vertical-align: inherit;">その特徴的な機能は、C ++テンプレートが広く使用されていることです。</font><font style="vertical-align: inherit;">実装とパブリックAPIの両方で。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RESTinioのC ++テンプレートは非常に活発に使用されているため、HabrでのRESTinioについて述べた最初の記事は、「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">人の顔が埋め込まれた非同期HTTPサーバーの実装における3階建てのC ++テンプレート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」と呼ば</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れていました</font></a><font style="vertical-align: inherit;">。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3階建てテンプレート。</font><font style="vertical-align: inherit;">そして、これは一般的に、台詞ではありませんでした。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして最近、再びRESTinioを更新し、バージョン0.5.1に新しい機能を追加するために、テンプレートの「階数」をさらに高くする必要がありました。</font><font style="vertical-align: inherit;">そのため、RESTinioのC ++テンプレートはすでに4階建てです。</font></font></p><br>
<p><img src="https://habrastorage.org/webt/vz/t3/vw/vzt3vwbp8snyu3y7hhrcr6crela.jpeg"></p><br>
<p>  -          ,    ,     .  C++       - ,     C++    ,     /  .    " ".</p><a name="habracut"></a><br>
<h1 id="slushatel-sostoyaniya-podklyucheniy">  </h1><br>
<p> ,     0.5.1, —      ,     HTTP- . ,  ""         ,     .</p><br>
<p>              .  ..       ,  ,     :  -   ,       ,            RESTinio.</p><br>
<p>    HTTP-  RESTinio   "" (traits),   /         .</p><br>
<h2 id="kak-polzovatel-zadaet-sobstvennogo-slushatelya-sostoyaniya-podklyucheniy">      ?</h2><br>
<p> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>     .</p><br>
<p> №1:   ,       state_changed  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">state_changed</span><span class="hljs-params">(
   <span class="hljs-keyword">const</span> restinio::connection_state::<span class="hljs-keyword">notice_t</span> &amp; notice)</span> <span class="hljs-keyword">noexcept</span></span>;</code></pre><br>
<p>,    - :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">my_state_listener</span> {</span>
   <span class="hljs-built_in">std</span>::mutex lock_;<font></font>
   ...<font></font>
<span class="hljs-keyword">public</span>:
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">state_changed</span><span class="hljs-params">(<span class="hljs-keyword">const</span> restinio::connection_state::<span class="hljs-keyword">notice_t</span> &amp; notice)</span> <span class="hljs-keyword">noexcept</span> </span>{
      <span class="hljs-built_in">std</span>::lock_guard&lt;<span class="hljs-built_in">std</span>::mutex&gt; l{lock_};<font></font>
      ....<font></font>
   }<font></font>
   ...<font></font>
};</code></pre><br>
<p> №2:      typedef   <code>connection_state_listener_t</code>,         №1 :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">my_traits</span> :</span> <span class="hljs-keyword">public</span> restinio::<span class="hljs-keyword">default_traits_t</span> {
   <span class="hljs-keyword">using</span> <span class="hljs-keyword">connection_state_listener_t</span> = my_state_listener;<font></font>
};</code></pre><br>
<p>,        HTTP-:</p><br>
<pre><code class="cpp hljs">restinio::run(restinio::on_thread_pool&lt;my_traits&gt;(<span class="hljs-number">8</span>)...);</code></pre><br>
<p> №3:            shared_ptr   :</p><br>
<pre><code class="cpp hljs">restinio::run(<font></font>
   restinio::on_thread_pool&lt;my_traits&gt;(<span class="hljs-number">8</span>)<font></font>
      .port(<span class="hljs-number">8080</span>)<font></font>
      .address(<span class="hljs-string">"localhost"</span>)<font></font>
      .request_handler(...)<font></font>
      .connection_state_listener(<span class="hljs-built_in">std</span>::make_shared&lt;my_state_listener&gt;(...))<font></font>
   )<font></font>
);</code></pre><br>
<p>      <code>connection_state_listener</code>,    HTTP-   :    ,      ,      .</p><br>
<h3 id="a-esli-ne-zadavat-connection_state_listener_t">    connection_state_listener_t?</h3><br>
<p>       <code>connection_state_listener_t</code>,      <code>connection_state_listener</code>    .       <code>connection_state_listener_t</code>?</p><br>
<p>           <code>connection_state_listener_t</code>,         <code>restinio::connection_state::noop_listener_t</code>.</p><br>
<p> ,  :  RESTinio    trait-   <code>connection_state_listener_t</code>. - :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">namespace</span> restinio {<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">default_traits_t</span> {</span>
   <span class="hljs-keyword">using</span> <span class="hljs-keyword">time_manager_t</span> = <span class="hljs-keyword">asio_time_manager_t</span>;
   <span class="hljs-keyword">using</span> <span class="hljs-keyword">logger_t</span> = <span class="hljs-keyword">null_logger_t</span>;<font></font>
   ...<font></font>
   <span class="hljs-keyword">using</span> <span class="hljs-keyword">connection_state_listener_t</span> = connection_state::<span class="hljs-keyword">noop_listener_t</span>;<font></font>
};<font></font>
<font></font>
} <span class="hljs-comment">/* namespace restinio */</span></code></pre><br>
<p>     <code>restinio::default_traits_t</code>,      <code>connection_state_listener_t</code>.    -    <code>connection_state_listener_t</code>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">my_traits</span> :</span> <span class="hljs-keyword">public</span> restinio::<span class="hljs-keyword">default_traits_t</span> {
   <span class="hljs-keyword">using</span> <span class="hljs-keyword">connection_state_listener_t</span> = my_state_listener;<font></font>
   ...<font></font>
};</code></pre><br>
<p>       <code>connection_state_listener_t</code>.     ,     .</p><br>
<p> ,        <code>connection_state_listener_t</code>,  RESTinio     , <code>noop_listener_t</code>,   RESTinio  . :</p><br>
<ul>
<li>RESTinio       shared_ptr  <code>connection_state_listener_t</code>. , ,    <code>connection_state_listener</code>  (       );</li>
<li>RESTinio      ,     .</li>
</ul><br>
<p>    ,         .</p><br>
<h2 id="kak-eto-realizovano-v-restinio">    RESTinio?</h2><br>
<p>,   RESTinio  ,     <code>connection_state_listener_t</code>    ,     :</p><br>
<ul>
<li>     shared_ptr    <code>connecton_state_listener_t</code>;</li>
<li>     <code>connection_state_listener</code>    HTTP-;</li>
<li>          <code>connection_state_listener_t</code>    HTTP-;</li>
<li>      <code>state_changed</code>      .</li>
</ul><br>
<p>      ,  RESTinio      C++14,       C++17 (  if constexpr).</p><br>
<p>     :        <code>restinio::connection_state::noop_listener_t</code>. ,     shared_ptr    <code>connection_state_listener_t</code>   .  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span>&lt; <span class="hljs-keyword">typename</span> Listener &gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">connection_state_listener_holder_t</span>
{</span>
    ... <span class="hljs-comment">//  compile-time .</span><font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt; Listener &gt; m_connection_state_listener;<font></font>
<font></font>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">bool</span> has_actual_connection_state_listener = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span>
    <span class="hljs-title">check_valid_connection_state_listener_pointer</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
        <span class="hljs-keyword">if</span>( !m_connection_state_listener )
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">exception_t</span>{ <span class="hljs-string">"connection state listener is not specified"</span> };<font></font>
    }<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">template</span>&lt;&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">connection_state_listener_holder_t</span>&lt; connection_state::noop_listener_t &gt;
{</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">bool</span> has_actual_connection_state_listener = <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span>
    <span class="hljs-title">check_valid_connection_state_listener_pointer</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span>
    </span>{
        <span class="hljs-comment">// Nothing to do.</span><font></font>
    }<font></font>
};</code></pre><br>
<p>   ,     ,  .     <code>noop_listener_t</code>     .</p><br>
<p>  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> Derived, <span class="hljs-keyword">typename</span> Traits&gt;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">basic_server_settings_t</span>
    :</span>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">socket_type_dependent_settings_t</span>&lt;<font></font>
            Derived, <span class="hljs-keyword">typename</span> Traits::<span class="hljs-keyword">stream_socket_t</span> &gt;<font></font>
    ,   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">connection_state_listener_holder_t</span>&lt;
            <span class="hljs-keyword">typename</span> Traits::<span class="hljs-keyword">connection_state_listener_t</span> &gt;<font></font>
    ,   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">ip_blocker_holder_t</span>&lt; <span class="hljs-keyword">typename</span> Traits::<span class="hljs-keyword">ip_blocker_t</span> &gt;<font></font>
{<font></font>
...<font></font>
};</code></pre><br>
<p>,     HTTP-,   <code>connection_state_listener_holder_t</code>.        shared_ptr    <code>connection_state_listener_t</code>,   .</p><br>
<p> ,      shared_ptr   —  .       ,          <code>basic_server_settings_t</code>     <code>connection_state_listener_t</code>   <code>noop_listener_t</code>.</p><br>
<p>    ,     " ".       <code>std::enable_if</code>    .     static_asser-:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function">Derived &amp;
<span class="hljs-title">connection_state_listener</span><span class="hljs-params">(
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt; <span class="hljs-keyword">typename</span> Traits::<span class="hljs-keyword">connection_state_listener_t</span> &gt; listener )</span> &amp;
</span>{
    <span class="hljs-keyword">static_assert</span>(<font></font>
            has_actual_connection_state_listener,<font></font>
            <span class="hljs-string">"connection_state_listener(listener) can't be used "</span>
            <span class="hljs-string">"for the default connection_state::noop_listener_t"</span> );<font></font>
<font></font>
    <span class="hljs-keyword">this</span>-&gt;m_connection_state_listener = <span class="hljs-built_in">std</span>::move(listener);
    <span class="hljs-keyword">return</span> reference_to_derived();<font></font>
}<font></font>
<font></font>
<span class="hljs-function">Derived &amp;&amp;
<span class="hljs-title">connection_state_listener</span><span class="hljs-params">(
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt; <span class="hljs-keyword">typename</span> Traits::<span class="hljs-keyword">connection_state_listener_t</span> &gt; listener )</span> &amp;&amp;
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::move(<span class="hljs-keyword">this</span>-&gt;connection_state_listener(<span class="hljs-built_in">std</span>::move(listener)));<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt; <span class="hljs-keyword">typename</span> Traits::<span class="hljs-keyword">connection_state_listener_t</span> &gt; &amp;
<span class="hljs-title">connection_state_listener</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">noexcept</span>
</span>{
    <span class="hljs-keyword">static_assert</span>(<font></font>
            has_actual_connection_state_listener,<font></font>
            <span class="hljs-string">"connection_state_listener() can't be used "</span>
            <span class="hljs-string">"for the default connection_state::noop_listener_t"</span> );<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>-&gt;m_connection_state_listener;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">ensure_valid_connection_state_listener</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">this</span>-&gt;check_valid_connection_state_listener_pointer();<font></font>
}</code></pre><br>
<p>     ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> ,   C++ if constexpr  ,  static if   D</a>.     C++14    :(</p><br>
<p>      <code>ensure_valid_connection_state_listener</code>.      <code>http_server_t</code>   ,       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> D&gt;
<span class="hljs-title">http_server_t</span><span class="hljs-params">(
    <span class="hljs-keyword">io_context_holder_t</span> io_context,
    <span class="hljs-keyword">basic_server_settings_t</span>&lt; D, Traits &gt; &amp;&amp; settings )</span>
    :   m_io_context</span>{ io_context.giveaway_context() }<font></font>
    ,   m_cleanup_functor{ settings.giveaway_cleanup_func() }<font></font>
{<font></font>
    <span class="hljs-comment">// Since v.0.5.1 the presence of custom connection state</span>
    <span class="hljs-comment">// listener should be checked before the start of HTTP server.</span><font></font>
    settings.ensure_valid_connection_state_listener();<font></font>
...</code></pre><br>
<p>   <code>ensure_valid_connection_state_listener</code>    <code>connection_state_listener_holder_t</code>  <code>check_valid_connection_state_listener_pointer</code>,    <code>connection_state_listener_holder_t</code>    ,    .</p><br>
<p>     ,     <code>state_changed</code>,      ,       .</p><br>
<p>      <code>state_listener_holder_t</code>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">namespace</span> connection_settings_details<font></font>
{<font></font>
<font></font>
<span class="hljs-keyword">template</span>&lt; <span class="hljs-keyword">typename</span> Listener &gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">state_listener_holder_t</span>
{</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt; Listener &gt; m_connection_state_listener;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt; <span class="hljs-keyword">typename</span> Settings &gt;
    <span class="hljs-title">state_listener_holder_t</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> Settings &amp; settings )</span>
        :   m_connection_state_listener</span>{ settings.connection_state_listener() }<font></font>
    {}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt; <span class="hljs-keyword">typename</span> Lambda &gt;
    <span class="hljs-keyword">void</span>
    <span class="hljs-title">call_state_listener</span><span class="hljs-params">( Lambda &amp;&amp; lambda )</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">noexcept</span>
    </span>{<font></font>
        m_connection_state_listener-&gt;state_changed( lambda() );<font></font>
    }<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">template</span>&lt;&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">state_listener_holder_t</span>&lt; connection_state::noop_listener_t &gt;
{</span>
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt; <span class="hljs-keyword">typename</span> Settings &gt;
    <span class="hljs-title">state_listener_holder_t</span><span class="hljs-params">( <span class="hljs-keyword">const</span> Settings &amp; )</span> </span>{ <span class="hljs-comment">/* nothing to do */</span> }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt; <span class="hljs-keyword">typename</span> Lambda &gt;
    <span class="hljs-keyword">void</span>
    <span class="hljs-title">call_state_listener</span><span class="hljs-params">( Lambda &amp;&amp; <span class="hljs-comment">/*lambda*/</span> )</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">noexcept</span>
    </span>{
        <span class="hljs-comment">/* nothing to do */</span><font></font>
    }<font></font>
};<font></font>
<font></font>
} <span class="hljs-comment">/* namespace connection_settings_details */</span></code></pre><br>
<p>   <code>connection_state_listener_holder_t</code>,                 (..    <code>basic_server_settings_t</code>),  <code>state_listener_holder_t</code>     ,       ,   :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt; <span class="hljs-keyword">typename</span> Traits &gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">connection_settings_t</span> <span class="hljs-title">final</span>
    :</span>   <span class="hljs-keyword">public</span> <span class="hljs-built_in">std</span>::enable_shared_from_this&lt; <span class="hljs-keyword">connection_settings_t</span>&lt; Traits &gt; &gt;<font></font>
    ,   <span class="hljs-keyword">public</span> connection_settings_details::<span class="hljs-keyword">state_listener_holder_t</span>&lt;
                <span class="hljs-keyword">typename</span> Traits::<span class="hljs-keyword">connection_state_listener_t</span> &gt;<font></font>
{<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">connection_state_listener_holder_t</span> =<font></font>
            connection_settings_details::<span class="hljs-keyword">state_listener_holder_t</span>&lt;
                    <span class="hljs-keyword">typename</span> Traits::<span class="hljs-keyword">connection_state_listener_t</span> &gt;;<font></font>
...</code></pre><br>
<p>   .</p><br>
<p>-,  <code>state_listener_holder_t</code>.   ,  .       <code>state_listener_holder_t</code>.   <code>connection_settings_t</code>  ""  <code>state_listener_holder_t</code>,  ,   :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt; <span class="hljs-keyword">typename</span> Settings &gt;
<span class="hljs-keyword">connection_settings_t</span>(<font></font>
    Settings &amp;&amp; settings,<font></font>
    http_parser_settings parser_settings,<font></font>
    <span class="hljs-keyword">timer_manager_handle_t</span> timer_manager )<font></font>
    :   <span class="hljs-keyword">connection_state_listener_holder_t</span>{ settings }<font></font>
    ,   m_request_handler{ settings.request_handler() }</code></pre><br>
<p>    <code>state_listener_holder_t</code>    ,      (   -          <code>state_listener_holder_t</code>).</p><br>
<p>-,   <code>state_listner_holder_t::call_state_listener</code>,     <code>state_changed</code>   .   ,    .   <code>call_state_listener</code>  ,   RESTinio    . ,  ,    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">close</span><span class="hljs-params">()</span>
</span>{<font></font>
    m_logger.trace( [&amp;]{<font></font>
        <span class="hljs-keyword">return</span> fmt::format( <span class="hljs-string">"[connection:{}] close"</span>, connection_id() );<font></font>
    } );<font></font>
...<font></font>
    <span class="hljs-comment">// Inform state listener if it used.</span>
    m_settings-&gt;call_state_listener( [<span class="hljs-keyword">this</span>]() <span class="hljs-keyword">noexcept</span> {
            <span class="hljs-keyword">return</span> connection_state::<span class="hljs-keyword">notice_t</span>{
                    <span class="hljs-keyword">this</span>-&gt;connection_id(),
                    <span class="hljs-keyword">this</span>-&gt;m_remote_endpoint,<font></font>
                    connection_state::<span class="hljs-keyword">cause_t</span>::closed };<font></font>
        } );<font></font>
}</code></pre><br>
<p> <code>call_state_listener</code>  ,     <code>notice_t</code>     .    ,      ,        <code>state_changed</code>.</p><br>
<p>,   ,  <code>call_state_listener</code>   , ,     .  ,         <code>call_state_listener</code>.           ,       .</p><br>
<h1 id="esche-i-ip-blocker">  IP-blocker</h1><br>
<p> RESTinio-0.5.1          ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">IP-blocker</a>. ..    ,  RESTinio  ""     .  IP-blocker ,     ,  RESTinio      (   ,  request-handler,  -  ..).    IP-blocker    ,  RESTinio           .</p><br>
<p>    IP-blocker   .   IP-blocker    .   HTTP-.        .    IP-blocker-  RESTinio     ,     .       ,  IP-blocker   RESTinio.    ,    IP-blocker,         .</p><br>
<h2 id="razbor-shtatnogo-primera-ip_blocker">   ip_blocker</h2><br>
<p>  0.5.1     RESTinio    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ip_blocker</a>.   ,           IP-.</p><br>
<p>     IP-blocker,       .     .    ,       .</p><br>
<p>   IP-blocker-,         .     —   ,  IP-blocker        .</p><br>
<p> ,     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">blocker_t</span>
{</span>
    <span class="hljs-built_in">std</span>::mutex m_lock;<font></font>
<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">connections_t</span> = <span class="hljs-built_in">std</span>::<span class="hljs-built_in">map</span>&lt;<font></font>
            restinio::asio_ns::ip::address,<font></font>
            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt; restinio::<span class="hljs-keyword">connection_id_t</span> &gt; &gt;;<font></font>
<font></font>
    <span class="hljs-keyword">connections_t</span> m_connections;<font></font>
<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">//   IP-blocker-.</span>
    restinio::<span class="hljs-function">ip_blocker::<span class="hljs-keyword">inspection_result_t</span>
    <span class="hljs-title">inspect</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> restinio::ip_blocker::<span class="hljs-keyword">incoming_info_t</span> &amp; info )</span> <span class="hljs-keyword">noexcept</span>
    </span>{...}<font></font>
<font></font>
    <span class="hljs-comment">//     .</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">state_changed</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> restinio::connection_state::<span class="hljs-keyword">notice_t</span> &amp; notice )</span> <span class="hljs-keyword">noexcept</span>
    </span>{...}<font></font>
};</code></pre><br>
<p>       -      .     —   <code>state_changed</code>.   .</p><br>
<p>        IP-blocker-:  <code>inspect</code>    ? !   .</p><br>
<p>      HTTP-:</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">my_traits_t</span> :</span> <span class="hljs-keyword">public</span> restinio::<span class="hljs-keyword">default_traits_t</span><font></font>
{<font></font>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">logger_t</span> = restinio::<span class="hljs-keyword">shared_ostream_logger_t</span>;<font></font>
<font></font>
    <span class="hljs-comment">//      .</span>
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">connection_state_listener_t</span> = <span class="hljs-keyword">blocker_t</span>;
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">ip_blocker_t</span> = <span class="hljs-keyword">blocker_t</span>;<font></font>
};</code></pre><br>
<p>      <code>blocker_t</code>      HTTP-:</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">auto</span> blocker = <span class="hljs-built_in">std</span>::make_shared&lt;<span class="hljs-keyword">blocker_t</span>&gt;();<font></font>
<font></font>
restinio::run(<font></font>
    ioctx,<font></font>
    restinio::on_thread_pool&lt;<span class="hljs-keyword">my_traits_t</span>&gt;( <span class="hljs-built_in">std</span>::thread::hardware_concurrency() )<font></font>
        .port( <span class="hljs-number">8080</span> )<font></font>
        .address( <span class="hljs-string">"localhost"</span> )<font></font>
        .connection_state_listener( blocker )<font></font>
        .ip_blocker( blocker )<font></font>
        .max_pipelined_requests( <span class="hljs-number">4</span> )<font></font>
        .handle_request_timeout( <span class="hljs-built_in">std</span>::chrono::seconds{<span class="hljs-number">20</span>} )<font></font>
        .request_handler( [&amp;ioctx](<span class="hljs-keyword">auto</span> req) {
                <span class="hljs-keyword">return</span> handler( ioctx, <span class="hljs-built_in">std</span>::move(req) );<font></font>
            } )<font></font>
);</code></pre><br>
<h1 id="zaklyuchenie"></h1><br>
<h2 id="o-cnyh-shablonah"> C++ </h2><br>
<p>  , C++  —  ,   "too big gun". ..   ,      ,     .   C++ community       .</p><br>
<p>        .   ,        ,    .            .</p><br>
<p>   ( ), ,          C++.  ,   —        C++   . ,   ,  C++ —   .    ,      (         ),         .</p><br>
<p>   ,  ,    RESTinio,         HTTP-  ,    .         . ,  ,       ,   .</p><br>
<p>,   ,  ,    C++     .         ,      .   -   ,            -   SFINAE         .</p><br>
<p>  ,    C++ .    ,       ,      ,  ,     C++ ,    cppreference  stackoverflow  10-15 .</p><br>
<h2 id="o-tekuschem-sostoyanii-restinio-i-buduschey-funkcionalnosti-restinio-i-ne-tolko-restinio">   RESTinio    RESTinio.    RESTinio</h2><br>
<p>   RESTinio    "     ". ,  2018   2019-    RESTinio     .    ,   ,   -     .</p><br>
<p>     2019-   RESTinio      RESTinio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0.5.0</a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0.5.1</a>.         . ..        RESTinio  ,     ,  RESTinio  .</p><br>
<p>,  RESTinio     .    ?</p><br>
<p>    :  RESTinio    ,    .       RESTinio -   ,        (,  issues  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">GitHub-</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">BitBucket-</a>,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Google-</a>,     ,  ).    —     ;)</p><br>
<p>,        ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">SObjectizer-</a>.          .</p><br>
<p>        ,     RESTinio: ,  <del></del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">傷ついていない。</font><font style="vertical-align: inherit;">突然それが好きです。</font><font style="vertical-align: inherit;">そして、それが気に入らない場合は、正確に共有してください。</font><font style="vertical-align: inherit;">これはRESTinioをさらに便利で機能的なものにするのに役立ちます。</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja456616/index.html">コーディングできる人には300万ルーブル</a></li>
<li><a href="../ja456618/index.html">ララビールモスクワ-6月21日</a></li>
<li><a href="../ja456622/index.html">クラスI保護に従って認定されたOSを作成する方法</a></li>
<li><a href="../ja456624/index.html">便利なPythonツール</a></li>
<li><a href="../ja456630/index.html">Airflowを導入してiviでSparkジョブを管理する：希望と松葉杖</a></li>
<li><a href="../ja456634/index.html">Nginxレシピ：CAS（中央承認サービス）</a></li>
<li><a href="../ja456638/index.html">Rust、Haskell、C ++、Python、Scala、OCamlで同じプロジェクトを比較する</a></li>
<li><a href="../ja456640/index.html">PHDays 9での競争情報コンテストの分析</a></li>
<li><a href="../ja456642/index.html">JetBrainsコーポレートマスタープログラムとITMO大学の最初の卒業</a></li>
<li><a href="../ja456644/index.html">より安価なフォトポリマー3DプリンターがKickstarterに登場</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>