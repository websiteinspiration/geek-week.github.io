<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìß üïπÔ∏è üåô Et encore une fois sur l'embarqu√©: la recherche de bugs dans le projet Embox ‚ùï üë∂üèª ü§πüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Embox est un syst√®me d'exploitation multiplateforme en temps r√©el multi-t√¢ches pour les syst√®mes embarqu√©s. Il est con√ßu pour fonctionner avec de faib...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Et encore une fois sur l'embarqu√©: la recherche de bugs dans le projet Embox</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/499986/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/20f/e3c/e6220fe3c8d556e40580a1cf49eab7cb.png" alt="Figure 2"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embox est un syst√®me d'exploitation multiplateforme en temps r√©el multi-t√¢ches pour les syst√®mes embarqu√©s. Il est con√ßu pour fonctionner avec de faibles ressources informatiques et vous permet d'ex√©cuter des applications bas√©es sur Linux sur des microcontr√¥leurs sans utiliser Linux lui-m√™me. Bien s√ªr, comme toute autre application, les bugs Embox ne sont pas non plus √©pargn√©s. Cet article est consacr√© √† l'analyse des erreurs trouv√©es dans le code du projet Embox.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a quelques mois, j'ai d√©j√† √©crit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur la v√©rification de FreeRTOS, un autre OS pour les syst√®mes embarqu√©s. </font><font style="vertical-align: inherit;">Je n'y ai pas trouv√© d'erreurs √† l'√©poque, mais je les ai trouv√©es dans des biblioth√®ques ajout√©es par les gars d'Amazon lors du d√©veloppement de leur propre version de FreeRTOS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'article que vous voyez maintenant devant vous, dans un sens, reprend le th√®me du pr√©c√©dent. </font><font style="vertical-align: inherit;">Nous avons souvent re√ßu des demandes de v√©rification de FreeRTOS, et nous l'avons fait. </font><font style="vertical-align: inherit;">Cette fois, il n'y a eu aucune demande de v√©rification sur un projet sp√©cifique, mais j'ai commenc√© √† recevoir des lettres et des commentaires de d√©veloppeurs embarqu√©s qui l'ont aim√© et qui en veulent plus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, le nouveau num√©ro de PVS-Studio for Embedded magazine a m√ªri et vous attend. </font><font style="vertical-align: inherit;">Profitez de regarder!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une analyse</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'analyse a √©t√© r√©alis√©e √† l'aide de PVS-Studio - un analyseur de code statique pour C, C ++, C # et Java. Avant l'analyse, le projet doit √™tre assembl√© - nous serons donc s√ªrs que le code du projet fonctionne, et nous donnerons √©galement √† l'analyseur la possibilit√© de collecter les informations d'assemblage qui peuvent √™tre utiles pour une meilleure v√©rification du code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les instructions dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©f√©rentiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Embox </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">officiel</font></a><font style="vertical-align: inherit;"> offrent la possibilit√© de construire sous diff√©rents syst√®mes (Arch Linux, macOS, Debian) et en utilisant Docker. J'ai d√©cid√© d'ajouter de la vari√©t√© √† ma vie et de construire et d'analyser sous Debian, que j'ai r√©cemment install√© sur ma machine virtuelle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'assembl√©e s'est bien d√©roul√©e. </font><font style="vertical-align: inherit;">Il fallait √† pr√©sent effectuer une analyse. </font><font style="vertical-align: inherit;">Debian est l'un des syst√®mes bas√©s sur PVS-Studio Linux pris en charge. </font><font style="vertical-align: inherit;">Un moyen pratique de v√©rifier les projets sous Linux est de compiler la trace. </font><font style="vertical-align: inherit;">Il s'agit d'un mode sp√©cial dans lequel l'analyseur collecte toutes les informations n√©cessaires sur l'assemblage afin que vous puissiez ensuite d√©marrer l'analyse en un seul clic. </font><font style="vertical-align: inherit;">Tout ce que je devais faire √©tait: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) T√©l√©charger et installer PVS-Studio; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Lancez le suivi de l'assemblage en allant dans le dossier avec Embox et en tapant dans le terminal</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -- make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Apr√®s avoir attendu la fin de l'assemblage, ex√©cutez la commande:</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -o /path/to/output.<span class="hljs-built_in">log</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Convertissez le rapport brut en n'importe quel format qui vous convient. </font><font style="vertical-align: inherit;">L'analyseur est livr√© avec un utilitaire sp√©cial PlogConverter, avec lequel vous pouvez le faire. </font><font style="vertical-align: inherit;">Par exemple, la commande pour convertir le rapport en liste des t√¢ches (pour l'affichage, par exemple, dans QtCreator) ressemblera √† ceci:</font></font><br>
<br>
<pre><code class="cpp hljs">plog-converter -t tasklist -o /path/to/output.tasks /path/to/project</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout! </font><font style="vertical-align: inherit;">Il ne m'a pas fallu plus de 15 minutes pour compl√©ter ces points. </font><font style="vertical-align: inherit;">Le rapport est pr√™t, vous pouvez maintenant voir les erreurs. </font><font style="vertical-align: inherit;">Eh bien, commen√ßons :)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cycle √©trange</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une des erreurs trouv√©es par l'analyseur √©tait l'√©trange boucle while:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span> ) {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
<font></font>
    dp.skip --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span>);       <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">do</span> {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    ....<font></font>
<font></font>
    dp.count --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.count != <span class="hljs-number">0</span>);<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">PVS-Studio: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">V715</font></a><font style="vertical-align: inherit;"> L'op√©rateur 'while' a un corps vide. </font><font style="vertical-align: inherit;">Motif suspect d√©tect√©: 'while (expr) {...} while (dp.skip! = 0);'. </font><font style="vertical-align: inherit;">dd.c 225 hm </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. </font><font style="vertical-align: inherit;">Boucle vraiment bizarre. </font><font style="vertical-align: inherit;">L'expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while (dp.skip! = 0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est √©crite deux fois, une fois juste au-dessus de la boucle et la seconde juste en dessous. </font><font style="vertical-align: inherit;">En fait, il s'agit maintenant de deux cycles diff√©rents: l'un contient des expressions entre accolades et le second est vide. </font><font style="vertical-align: inherit;">Dans ce cas, le deuxi√®me cycle ne sera jamais ex√©cut√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous trouverez ci-dessous une boucle do ... while avec une condition similaire, ce qui m'am√®ne √† penser: l'√©trange boucle √©tait √† l'origine con√ßue comme do ... while, mais quelque chose s'est mal pass√©. </font><font style="vertical-align: inherit;">Je pense que ce morceau de code avec une forte probabilit√© contient une erreur logique.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuites de m√©moire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oui, pas sans eux.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">krename</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *oldpath, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *newpath)</span> </span>{<font></font>
  <font></font>
  <span class="hljs-keyword">char</span> *newpatharg, *oldpatharg;<font></font>
<font></font>
  ....<font></font>
<font></font>
  oldpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(oldpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));<font></font>
  newpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(newpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == oldpatharg || <span class="hljs-literal">NULL</span> == newpatharg) {<font></font>
    SET_ERRNO(ENOMEM);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissements de PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V773</a> The function was exited without releasing the 'newpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V773</a> The function was exited without releasing the 'oldpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction cr√©e les variables locales </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oldpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en elle-m√™me </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ces pointeurs re√ßoivent les adresses des nouveaux emplacements de m√©moire allou√©s en interne √† l'aide de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si un probl√®me se produit lors de l'allocation de m√©moire, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoie un pointeur nul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que faire si un seul bloc de m√©moire est allou√©? </font><font style="vertical-align: inherit;">La fonction se bloque sans lib√©rer de m√©moire. </font><font style="vertical-align: inherit;">Le site allou√© restera en m√©moire sans possibilit√© d'y acc√©der √† nouveau et de le lib√©rer pour une utilisation ult√©rieure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre exemple de fuite de m√©moire est un peu plus brillant:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">block_dev_test</span><span class="hljs-params">(....)</span> </span>{
  <span class="hljs-keyword">int8_t</span> *read_buf, *write_buf;<font></font>
  <font></font>
  ....<font></font>
<font></font>
  read_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
  write_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (read_buf == <span class="hljs-literal">NULL</span> || write_buf == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to allocate memory for buffer!\n"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (read_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(read_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (write_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(write_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> -ENOMEM;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (s_block &gt;= blocks) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Starting block should be less than number of blocks\n"</span>);
    <span class="hljs-keyword">return</span> -EINVAL;            <span class="hljs-comment">// &lt;=</span><font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissements de PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V773</a> The function was exited without releasing the 'read_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V773</a> The function was exited without releasing the 'write_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, le programmeur a d√©j√† montr√© de la pr√©cision et trait√© correctement le cas dans lequel il √©tait possible d'allouer une seule pi√®ce de m√©moire. </font><font style="vertical-align: inherit;">Trait√© correctement ... et litt√©ralement dans l'expression suivante a fait une autre erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gr√¢ce √† une v√©rification correctement √©crite, nous pouvons √™tre s√ªrs qu'au moment o√π l'expression est ex√©cut√©e, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return -EINVAL; </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous aurons certainement de la m√©moire allou√©e pour </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ainsi, avec un tel retour de la fonction, nous aurons deux fuites √† la fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense qu'obtenir une fuite de m√©moire sur un appareil embarqu√© peut √™tre plus douloureux que sur un PC classique. </font><font style="vertical-align: inherit;">Dans des conditions o√π les ressources sont s√©v√®rement limit√©es, vous devez les surveiller particuli√®rement attentivement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipulation des pointeurs</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code d'erreur suivant est concis et assez simple:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">scsi_write</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">char</span> *buffer,
                      <span class="hljs-keyword">size_t</span> count, <span class="hljs-keyword">blkno_t</span> blkno)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_dev</span> *<span class="hljs-title">sdev</span>;</span>
  <span class="hljs-keyword">int</span> blksize;<font></font>
<font></font>
  ....<font></font>
<font></font>
  sdev = bdev-&gt;privdata;<font></font>
  blksize = sdev-&gt;blk_size; <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!sdev) {              <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">return</span> -ENODEV;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le pointeur 'sdev' a √©t√© utilis√© avant d'√™tre v√©rifi√© par rapport √† nullptr. V√©rifiez les lignes: 116, 118. scsi_disk.c 116 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le pointeur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©r√©f√©renc√© juste avant qu'il ne soit v√©rifi√© pour NULL. Il est logique de supposer que si quelqu'un a √©crit une telle v√©rification, alors ce pointeur peut √™tre nul. Dans ce cas, nous avons le d√©r√©f√©rencement potentiel du pointeur nul dans la cha√Æne </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'erreur est que la v√©rification ne se trouve pas l√† o√π elle est n√©cessaire. Il aurait d√ª venir apr√®s la ligne " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev = bdev-&gt; privdata;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", mais avant la ligne " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Ensuite, l'appel potentiel √† l'adresse z√©ro pourrait √™tre √©vit√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio a trouv√© deux autres erreurs dans le code suivant:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xdrrec_create</span><span class="hljs-params">(....)</span>
</span>{
  <span class="hljs-keyword">char</span> *buff;<font></font>
<font></font>
  ....<font></font>
<font></font>
  buff = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(sendsz + recvsz);<font></font>
  assert(buff != <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  ....<font></font>
<font></font>
  xs-&gt;extra.rec.in_base = xs-&gt;extra.rec.in_curr = buff;<font></font>
  xs-&gt;extra.rec.in_boundry <font></font>
    = xs-&gt;extra.rec.in_base + recvsz;                    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
  xs-&gt;extra.rec.out_base<font></font>
    = xs-&gt;extra.rec.out_hdr = buff + recvsz;             <span class="hljs-comment">// &lt;= </span><font></font>
  xs-&gt;extra.rec.out_curr <font></font>
    = xs-&gt;extra.rec.out_hdr + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">union</span> xdrrec_hdr);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissements de PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">pointeur</font></a><font style="vertical-align: inherit;"> 'xs-&gt; extra.rec.in_base' dans l'expression 'xs-&gt; extra.rec.in_base + recvsz' pourrait √™tre nullptr. </font><font style="vertical-align: inherit;">Dans ce cas, la valeur r√©sultante sera insens√©e et ne doit pas √™tre utilis√©e. </font><font style="vertical-align: inherit;">V√©rifiez les lignes: 56, 48. xdr_rec.c 56</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le pointeur 'buff' dans l'expression 'buff + recvsz' pourrait √™tre nullptr. </font><font style="vertical-align: inherit;">Dans ce cas, la valeur r√©sultante sera insens√©e et ne doit pas √™tre utilis√©e. </font><font style="vertical-align: inherit;">V√©rifiez les lignes: 61, 48. xdr_rec.c 61</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le pointeur buf est initialis√© avec </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis sa valeur est utilis√©e pour initialiser d'autres pointeurs. La fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut renvoyer un pointeur nul, et cela doit toujours √™tre v√©rifi√©. Il semblerait que voici un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> v√©rifiant </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et tout devrait fonctionner correctement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais non! Le fait est que les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assertions</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont utilis√©es pour le d√©bogage, et lors de la construction du projet dans la configuration Release, cette </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assertion</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sera supprim√©e. Il s'av√®re que lorsque vous travaillez dans Debug, le programme fonctionnera correctement, et lors de la g√©n√©ration dans Release, le pointeur nul "va" plus loin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utiliser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans les op√©rations arithm√©tiques est incorrect, car le r√©sultat d'une telle op√©ration n'aura aucun sens et un tel r√©sultat ne peut pas √™tre utilis√©. </font><font style="vertical-align: inherit;">C'est ce que l'analyseur nous avertit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certains pourraient affirmer que ne pas v√©rifier le pointeur apr√®s </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est sans peur. </font><font style="vertical-align: inherit;">Comme au premier acc√®s par un pointeur nul, un signal / exception se produira et il n'y aura rien de mal. </font><font style="vertical-align: inherit;">En pratique, tout est beaucoup plus compliqu√©, et si le manque de v√©rification ne vous semble pas dangereux, je vous propose de lire l'article ¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi est-il important de v√©rifier ce que la fonction malloc a renvoy√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipulation incorrecte des tableaux</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'erreur suivante est tr√®s similaire √† l'exemple avant-dernier:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fat_read_filename</span><span class="hljs-params">(struct fat_file_info *fi,
                      <span class="hljs-keyword">void</span> *p_scratch,
                      <span class="hljs-keyword">char</span> *name)</span> </span>{
  <span class="hljs-keyword">int</span> offt = <span class="hljs-number">1</span>;<font></font>
<font></font>
  ....<font></font>
<font></font>
  offt = <span class="hljs-built_in">strlen</span>(name);
  <span class="hljs-keyword">while</span> (name[offt - <span class="hljs-number">1</span>] == <span class="hljs-string">' '</span> &amp;&amp; offt &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// &lt;=</span>
    name[--offt] = <span class="hljs-string">'\0'</span>;<font></font>
  }<font></font>
  log_debug(<span class="hljs-string">"name(%s)"</span>, name);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> DFS_OK;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V781</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La valeur de l'index 'offt' est v√©rifi√©e apr√®s son utilisation. </font><font style="vertical-align: inherit;">Il y a peut-√™tre une erreur dans la logique du programme. </font><font style="vertical-align: inherit;">fat_common.c 1813 La </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offt est d'</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> abord utilis√©e √† l'int√©rieur de l'op√©ration d'indexation, et alors seulement il est v√©rifi√© que sa valeur est sup√©rieure √† z√©ro. </font><font style="vertical-align: inherit;">Mais que se passe-t-il si le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nom</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s'av√®re √™tre une cha√Æne vide? </font><font style="vertical-align: inherit;">La fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puis un coup fort dans la jambe. </font><font style="vertical-align: inherit;">Le programme acc√©dera √† un indice n√©gatif, ce qui entra√Ænera un comportement ind√©fini. </font><font style="vertical-align: inherit;">Tout peut arriver, y compris un plantage du programme. </font><font style="vertical-align: inherit;">D√©sordre!</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8d/fde/b0d/a8dfdeb0d70054257d1d08162bbd39aa.png" alt="Image 1"></div> <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conditions suspectes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et o√π sans eux? </font><font style="vertical-align: inherit;">Nous trouvons de telles erreurs litt√©ralement dans chaque projet que nous v√©rifions.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">index_descriptor_cloexec_set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> cloexec)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idesc_table</span> *<span class="hljs-title">it</span>;</span><font></font>
<font></font>
  it = task_resource_idesc_table(task_self());<font></font>
  assert(it);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (cloexec | FD_CLOEXEC) {<font></font>
    idesc_cloexec_set(it-&gt;idesc_table[fd]);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    idesc_cloexec_clear(it-&gt;idesc_table[fd]);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V617</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Envisagez d'inspecter l'√©tat. L'argument '0x0010' du '|' l'op√©ration au niveau du bit contient une valeur non nulle. index_descriptor.c 55 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comprendre en quoi consiste l'erreur, regardez la d√©finition de la constante </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FD_CLOEXEC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FD_CLOEXEC 0x0010</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'av√®re que dans l'expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (cloexec | FD_CLOEXEC) √†</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> droite du ¬´ou¬ª au niveau du bit, il y a toujours une constante non nulle. </font><font style="vertical-align: inherit;">Le r√©sultat d'une telle op√©ration sera toujours un nombre diff√©rent de z√©ro. </font><font style="vertical-align: inherit;">Ainsi, cette expression sera toujours √©quivalente √† l'expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (true)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et nous ne traiterons toujours que la branche alors de l'expression if. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je soup√ßonne que cette constante de macro est utilis√©e pour pr√©configurer le syst√®me d'exploitation Embox, mais m√™me dans ce cas, cette condition toujours vraie semble √©trange. </font><font style="vertical-align: inherit;">Peut-√™tre voulaient-ils utiliser l'op√©rateur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&amp;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ici </font><font style="vertical-align: inherit;">, mais ils ont fait une faute de frappe.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Division enti√®re</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'erreur suivante est li√©e √† une fonctionnalit√© du langage C:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SBSIZE    1024</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2fs_format</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">void</span> *priv)</span> </span>{
  <span class="hljs-keyword">size_t</span> dev_bsize;
  <span class="hljs-keyword">float</span> dev_factor;<font></font>
<font></font>
  ....<font></font>
<font></font>
  dev_size = block_dev_size(bdev);<font></font>
  dev_bsize = block_dev_block_size(bdev);<font></font>
  dev_factor = SBSIZE / dev_bsize;            <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ext2_dflt_sb(&amp;sb, dev_size, dev_factor);<font></font>
  ext2_dflt_gd(&amp;sb, &amp;gd);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">PVS-Studio: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">V636</font></a><font style="vertical-align: inherit;"> L' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">expression</font></a><font style="vertical-align: inherit;"> '1024 / dev_bsize' a √©t√© implicitement convertie du type 'int' en type 'float'. Pensez √† utiliser un transtypage de type explicite pour √©viter la perte d'une partie fractionnaire. Un exemple: double A = (double) (X) / Y;. ext2.c 777 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette fonctionnalit√© est la suivante: si nous divisons deux valeurs enti√®res, le r√©sultat de la division sera entier. Ainsi, la division se produira sans reste, ou, en d'autres termes, la partie fractionnaire sera rejet√©e du r√©sultat de la division. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, les programmeurs l'oublient et des erreurs comme celle-ci sont commises. La constante SBSIZE et la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ont un type entier (int et size_t respectivement). Par cons√©quent, le r√©sultat de l' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expression SBSIZE / dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera √©galement de type entier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais attendez un instant. </font><font style="vertical-align: inherit;">La variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est de type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">De toute √©vidence, le programmeur s'attendait √† obtenir un r√©sultat de division fractionnaire. </font><font style="vertical-align: inherit;">Cela peut √™tre v√©rifi√© davantage si vous faites attention √† l'utilisation ult√©rieure de cette variable. </font><font style="vertical-align: inherit;">Par exemple, la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_dflt_sb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o√π </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pass√© en tant que troisi√®me param√®tre, a la signature suivante:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ext2_dflt_sb</span><span class="hljs-params">(struct ext2sb *sb, <span class="hljs-keyword">size_t</span> dev_size, <span class="hljs-keyword">float</span> dev_factor)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De m√™me, dans d'autres endroits o√π la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><i><font style="vertical-align: inherit;">utilis√©e</font></i><font style="vertical-align: inherit;"> : tout indique qu'un nombre √† virgule flottante est attendu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour corriger cette erreur, il suffit de transtyper l'un des op√©randes de division en type r√©el. </font><font style="vertical-align: inherit;">Par exemple:</font></font><br>
<br>
<pre><code class="cpp hljs">dev_factor = <span class="hljs-keyword">float</span>(SBSIZE) / dev_bsize;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©sultat de la division sera alors un nombre fractionnaire.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entr√©e non v√©rifi√©e</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'erreur suivante est associ√©e √† l'utilisation de donn√©es non v√©rifi√©es re√ßues de l'ext√©rieur du programme.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> ret;
  <span class="hljs-keyword">char</span> text[SMTP_TEXT_LEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == fgets(&amp;text[<span class="hljs-number">0</span>], <span class="hljs-keyword">sizeof</span> text - <span class="hljs-number">2</span>, <span class="hljs-comment">/* for \r\n */</span>
      <span class="hljs-built_in">stdin</span>)) { ret = -EIO; <span class="hljs-keyword">goto</span> error; }<font></font>
    text[<span class="hljs-built_in">strlen</span>(&amp;text[<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>] = <span class="hljs-string">'\0'</span>; <span class="hljs-comment">/* remove \n */</span>    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Les</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> donn√©es contamin√©es non </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">contr√¥l√©es</font></a><font style="vertical-align: inherit;"> sont utilis√©es dans l'index: 'strlen (&amp; text [0])'. </font><font style="vertical-align: inherit;">sendmail.c 102 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, consid√©rez ce que la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoie </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En cas de lecture r√©ussie d'une ligne, la fonction renvoie un pointeur sur cette ligne. </font><font style="vertical-align: inherit;">Si la lecture rencontre une </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fin de fichier</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avant qu'au moins un √©l√©ment ne soit lu, ou si une erreur d'entr√©e se produit, la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, l'expression est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL == fgets (....)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√©rifie si l'entr√©e re√ßue est correcte. Mais il y a une mise en garde. Si vous transf√©rez un terminal nul comme premier caract√®re √† lire (cela peut √™tre fait, par exemple, en appuyant sur Ctrl + 2 en mode h√©rit√© de la ligne de commande Windows), la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets le</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consid√®re sans retourner </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans ce cas, la ligne sur laquelle l'enregistrement est effectu√© n'aura qu'un seul √©l√©ment - ' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que va-t-il se passer ensuite? L'expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen (&amp; text [0])</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renverra </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En cons√©quence, nous obtenons un appel d'index n√©gatif:</font></font><br>
<br>
<pre><code class="cpp hljs">text[ <span class="hljs-number">0</span> - <span class="hljs-number">1</span> ] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, nous pouvons ¬´renverser¬ª le programme en passant simplement le caract√®re de terminaison de ligne √† l'entr√©e. </font><font style="vertical-align: inherit;">Ceci est g√™nant et pourrait potentiellement √™tre utilis√© pour attaquer des syst√®mes utilisant Embox. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon coll√®gue, qui d√©veloppait cette r√®gle de diagnostic, a m√™me fait une note avec un exemple d'une telle attaque contre le projet NcFTP:</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8DBQjvPQ7tk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je recommande de voir si vous ne croyez toujours pas √† une telle opportunit√© :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, l'analyseur a trouv√© deux autres endroits avec la m√™me erreur:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Les donn√©es corrompues non contr√¥l√©es sont utilis√©es dans l'index: 'strlen (&amp; from [0])'. </font><font style="vertical-align: inherit;">sendmail.c 55</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Les donn√©es contamin√©es non contr√¥l√©es sont utilis√©es dans l'index: 'strlen (&amp; to [0])'. </font><font style="vertical-align: inherit;">sendmail.c 65</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Misra</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA est un ensemble de directives et de directives pour l'√©criture de code C et C ++ s√©curis√© pour les syst√®mes embarqu√©s hautement responsables. </font><font style="vertical-align: inherit;">Dans un sens, il s'agit d'un manuel de formation, qui vous permettra de vous d√©barrasser non seulement des soi-disant ¬´odeurs de code¬ª, mais aussi de prot√©ger votre programme contre les vuln√©rabilit√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA est utilis√© l√† o√π la vie humaine d√©pend de la qualit√© de votre syst√®me embarqu√©: dans les secteurs m√©dical, automobile, a√©ronautique et militaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio dispose d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un ensemble complet de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r√®gles </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">de</font></a><font style="vertical-align: inherit;"> diagnostic qui vous permettent de v√©rifier la conformit√© de votre code avec les normes MISRA C et MISRA C ++. </font><font style="vertical-align: inherit;">Par d√©faut, le mode avec ces diagnostics est d√©sactiv√©, mais comme nous recherchons des erreurs dans le projet de syst√®mes embarqu√©s, je ne pourrais tout simplement pas me passer de MISRA.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici ce que j'ai r√©ussi √† trouver:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* find and read symlink file */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2_read_symlink</span><span class="hljs-params">(struct nas *nas,
                             <span class="hljs-keyword">uint32_t</span> parent_inumber,
                             <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **cp)</span> </span>{
  <span class="hljs-keyword">char</span> namebuf[MAXPATHLEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  *cp = namebuf;              <span class="hljs-comment">// &lt;=</span>
  <span class="hljs-keyword">if</span> (*namebuf != <span class="hljs-string">'/'</span>) {<font></font>
    inumber = parent_inumber;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    inumber = (<span class="hljs-keyword">uint32_t</span>) EXT2_ROOTINO;<font></font>
  }<font></font>
  rc = ext2_read_inode(nas, inumber);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
} </code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] L'adresse du tableau local 'namebuf' ne doit pas √™tre stock√©e en dehors de la port√©e de ce tableau. ext2.c 298 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'analyseur a d√©tect√© une affectation suspecte qui pourrait potentiellement conduire √† un comportement non d√©fini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons de plus pr√®s le code. Ici, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un tableau cr√©√© dans la port√©e locale de la fonction, et le pointeur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><font style="vertical-align: inherit;">pass√© √† la fonction par pointeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon la syntaxe C, le nom du tableau est un pointeur vers le premier √©l√©ment de la zone m√©moire dans laquelle le tableau est stock√©. Il s'av√®re que l'expression </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* cp = namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> assignera l'adresse du tableau </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† la variable point√©e par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Puisque </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pass√© √† la fonction par un pointeur, un changement de la valeur vers laquelle il pointe sera refl√©t√© √† l'endroit o√π la fonction a √©t√© appel√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'av√®re qu'apr√®s que la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_read_symlink a termin√©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son travail, son troisi√®me param√®tre indiquera la zone que le tableau </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> occupait autrefois </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a qu'un ¬´mais¬ª: puisque </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un tableau r√©serv√© sur la pile, il sera supprim√© √† la sortie de la fonction. Ainsi, un pointeur qui existe en dehors de la fonction pointera vers la m√©moire lib√©r√©e.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que sera √† cette adresse? </font><font style="vertical-align: inherit;">C'est impossible √† pr√©voir. </font><font style="vertical-align: inherit;">Il est possible que pendant un certain temps le contenu du tableau continue √† √™tre en m√©moire, ou il est possible que le programme efface imm√©diatement cette zone avec autre chose. </font><font style="vertical-align: inherit;">En g√©n√©ral, l'acc√®s √† une telle adresse renvoie une valeur non d√©finie et l'utilisation d'une telle valeur est une erreur grossi√®re. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'analyseur a √©galement trouv√© une autre erreur avec le m√™me avertissement:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] L'adresse de la variable locale 'dst_haddr' ne doit pas √™tre stock√©e en dehors de la port√©e de cette variable. </font><font style="vertical-align: inherit;">net_tx.c 82</font></font></li>
</ul><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ba/353/6e6/2ba3536e675a564e65b802a3e596fa36.png" alt="Figure 6"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai aim√© travailler avec le projet Embox. Malgr√© le fait que je n'ai pas √©crit toutes les erreurs trouv√©es dans l'article, le nombre total d'avertissements √©tait relativement faible et, en g√©n√©ral, le code du projet a √©t√© √©crit avec une haute qualit√©. Par cons√©quent, j'exprime ma gratitude aux d√©veloppeurs, ainsi qu'√† ceux qui ont contribu√© au projet au nom de la communaut√©. Vous √™tes formidable! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'en profite pour transmettre mes salutations aux d√©veloppeurs de Tula. Je vais croire qu'√† Saint-P√©tersbourg il ne fait pas tr√®s froid en ce moment :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est l√† que mon article se termine. J'esp√®re que vous avez appr√©ci√© sa lecture et que vous avez trouv√© quelque chose de nouveau pour vous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous √™tes int√©ress√© par PVS-Studio et que vous souhaitez v√©rifier ind√©pendamment un projet en l'utilisant, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√©l√©chargez-le et essayez-le</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cela ne prendra pas plus de 15 minutes.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: George Gribkov. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä nouveau int√©gr√©: recherche de bogues dans le projet Embox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499970/index.html">Nous √©tudions le moteur VoIP Mediastreamer2. Partie 12</a></li>
<li><a href="../fr499972/index.html">Les √©v√©nements en ligne de mai r√©sument</a></li>
<li><a href="../fr499974/index.html">Jeux 3D sur Instagram Javascript, ou trajectoire de vol de saucisse</a></li>
<li><a href="../fr499978/index.html">Traduction du livre d'Andrew Un, Passion for Machine Learning, chapitres 36 et 37</a></li>
<li><a href="../fr499982/index.html">Plan de testeur d√©butant: de "Enter IT" √† "I Am an Engineer!"</a></li>
<li><a href="../fr499988/index.html">Sucre et COVID-19</a></li>
<li><a href="../fr499990/index.html">G√©ocodage Comment lier 250 mille adresses √† des coordonn√©es en 10 minutes?</a></li>
<li><a href="../fr499992/index.html">Concevoir des technologies pour la mise en ≈ìuvre de syst√®mes de facturation pour les entreprises clientes (partie 2)</a></li>
<li><a href="../fr499994/index.html">Quand le coronavirus prendra fin</a></li>
<li><a href="../fr500000/index.html">√Ä Radio Day. Communication - les nerfs de la guerre</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>