<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è¨ üê∫ üßòüèΩ Making SQL Server and PerfMon Friends üìÅ üìâ ‚ö∞Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the photo there is a scene from the good old comedy ‚ÄúAirplane‚Äù - the boomers remember it. 
 
 
 
 She is not here by chance. But useful later.
 
 D...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Making SQL Server and PerfMon Friends</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497238/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the photo there is a scene from the good old comedy ‚ÄúAirplane‚Äù - the boomers remember it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/if/dn/lnifdnnc4rrtbmkaivipqr0gbks.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
She is not here by chance. </font><font style="vertical-align: inherit;">But useful later.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dba don't like perfmon</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs not at all because the PerfMon interface has not changed with Windows NT 3.1 (?) And gives back the warmth of two thousandths. By the way, maybe someone knows the explanation for this strange fact. The control panel is rewritten several times a year. Even the calculator was rewritten. But not perfMon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBA thinks with cover words. When a good DBA doctor arrives at a sick SQL server, he opens his suitcase, and in the suitcase there is a huge number of quarters that serve him faithfully. He takes the shortest of them from memory. Sometimes a DBA can look into PerfMon's metrics - Physical disk, or Disk Queue Length. However, a real DBA will get its own SQL server metrics, not through PerfMon, but with a patch, for example, like this:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> sys.dm_os_performance_counters 
  <span class="hljs-keyword">where</span> object_name=<span class="hljs-string">'SQLServer:Buffer Manager'</span> 
    <span class="hljs-keyword">and</span> counter_name <span class="hljs-keyword">like</span> <span class="hljs-string">'Page life expectancy%'</span> 
	<span class="hljs-keyword">and</span> instance_name=<span class="hljs-string">''</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When IT representatives, divorced from the DBA sphere, ask him, ‚Äúwhat metrics do you want us to collect?‚Äù </font><font style="vertical-align: inherit;">(well, there are all sorts of splunk, squared-up, etc.), then the DBA begins to think about scripts, and the rest about perfmon metrics. </font><font style="vertical-align: inherit;">At the same time, as a rule, they try to dump all the metrics on the DBA. </font><font style="vertical-align: inherit;">When this happens, the picture is useless in its congestion. </font><font style="vertical-align: inherit;">And then a short </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video clip from the movie "Airplane"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will help me </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, DBA writes keri, which write statistics every N minutes to some plate in the DBAtasks database. </font><font style="vertical-align: inherit;">Do you recognize yourself?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advocate Devil (perfmon)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nevertheless, perfmon counters are a standard tool. </font><font style="vertical-align: inherit;">They can be logged, set alerts, but most importantly, there are a large number of systems that "merge" these metrics from many machines into a centralized repository, allow you to analyze them and build beautiful (and not like perfmon) charts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Turns out we can make friends with the SQL world and PerfMon world! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below I will show how.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now the specifics will go</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an example, we will show how to export metrics that SQL itself does not publish to PerfMon. </font><font style="vertical-align: inherit;">For example, the query below:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span>
  <span class="hljs-keyword">convert</span>(<span class="hljs-built_in">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<span class="hljs-keyword">round</span>(((<span class="hljs-keyword">sum</span>(version_store_reserved_page_count)*<span class="hljs-number">1.0</span>)/<span class="hljs-number">128.00</span>),<span class="hljs-number">2</span>)),
  <span class="hljs-keyword">convert</span>(<span class="hljs-built_in">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<span class="hljs-keyword">round</span>(((<span class="hljs-keyword">sum</span>(user_object_reserved_page_count)*<span class="hljs-number">1.0</span>)/<span class="hljs-number">128.00</span>),<span class="hljs-number">2</span>)),
  <span class="hljs-keyword">convert</span>(<span class="hljs-built_in">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<span class="hljs-keyword">round</span>(((<span class="hljs-keyword">sum</span>(internal_object_reserved_page_count)*<span class="hljs-number">1.0</span>)/<span class="hljs-number">128.00</span>),<span class="hljs-number">2</span>))
<span class="hljs-keyword">from</span>
  tempdb.sys.dm_db_file_space_usage;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
returns the amount of tempdb space used by the version store (for snapshot), user objects (#tab and ## tab) and sort / temporary storage space. </font><font style="vertical-align: inherit;">Let's create metrics for them (18+, teams are undocumented)</font></font><br>
<br>
<pre><code class="sql hljs">dbcc addinstance ('SQLServer:User Settable', 'TempDB version store KB')<font></font>
dbcc addinstance ('SQLServer:User Settable', 'TempDB user store KB')<font></font>
dbcc addinstance ('SQLServer:User Settable', 'TempDB sort store KB')<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This will create three metrics in SQLServer -&gt; UserSettable -&gt; Query. </font><font style="vertical-align: inherit;">The metrics are integers - int (not bigint). </font><font style="vertical-align: inherit;">In addition, their meaning is interpreted as is. </font><font style="vertical-align: inherit;">That is, if you need a delta from the previous value, then this is your concern. </font><font style="vertical-align: inherit;">But in this case, we just need to assign values ‚Äã‚Äãto the metrics:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">declare</span> @TEMPDBver <span class="hljs-built_in">int</span>, @TEMPDBuser <span class="hljs-built_in">int</span>, @TEMPDBsort <span class="hljs-built_in">int</span>
<span class="hljs-keyword">select</span><font></font>
<font></font>
@TEMPDBver = <span class="hljs-keyword">convert</span>(<span class="hljs-built_in">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<span class="hljs-keyword">round</span>(((<span class="hljs-keyword">sum</span>(version_store_reserved_page_count) *<span class="hljs-number">1.0</span>)/<span class="hljs-number">128.00</span>),<span class="hljs-number">2</span>)),<font></font>
@TEMPDBuser = <span class="hljs-keyword">convert</span>(<span class="hljs-built_in">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<span class="hljs-keyword">round</span>(((<span class="hljs-keyword">sum</span>(user_object_reserved_page_count) *<span class="hljs-number">1.0</span>)/<span class="hljs-number">128.00</span>),<span class="hljs-number">2</span>)),<font></font>
@TEMPDBsort = <span class="hljs-keyword">convert</span>(<span class="hljs-built_in">numeric</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<span class="hljs-keyword">round</span>(((<span class="hljs-keyword">sum</span>(internal_object_reserved_page_count) *<span class="hljs-number">1.0</span>)/<span class="hljs-number">128.00</span>),<span class="hljs-number">2</span>))
<span class="hljs-keyword">from</span> tempdb.sys.dm_db_file_space_usage;<font></font>
<font></font>
if @TEMPDBver is not null    <font></font>
  dbcc setinstance ('SQLServer:User Settable', 'Query', <font></font>
    'TempDB version store KB', @TEMPDBver)<font></font>
if @TEMPDBuser is not null   <font></font>
  dbcc setinstance ('SQLServer:User Settable', 'Query', <font></font>
   'TempDB user store KB', @TEMPDBuser)<font></font>
if @TEMPDBsort is not null   <font></font>
  dbcc setinstance ('SQLServer:User Settable', 'Query', <font></font>
    'TempDB sort store KB', @TEMPDBsort)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, that's all. </font><font style="vertical-align: inherit;">Now just call this code regularly and everything will work.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta Counters</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's make a delta counter. </font><font style="vertical-align: inherit;">This will be the lock timeout in ms.</font></font><br>
<br>
<pre><code class="sql hljs">dbcc addinstance ('SQLServer:User Settable', '<span class="hljs-keyword">LOCK</span> ms per s<span class="hljs-string">')
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you can object to me that such a metric already exists:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> sys.dm_os_performance_counters 
  <span class="hljs-keyword">where</span> counter_name <span class="hljs-keyword">like</span> <span class="hljs-string">'Lock Wait Time (ms)%'</span> 
    <span class="hljs-keyword">and</span> instance_name=<span class="hljs-string">'_Total'</span>
    <span class="hljs-keyword">and</span> object_name=<span class="hljs-string">'SQLServer:Locks'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But this metric is only eventually consistent. </font><font style="vertical-align: inherit;">As you remember, if protons are unstable, then any database in the universe is eventually consistent. </font><font style="vertical-align: inherit;">That is, if you create a lock and look at the value of this metric, then it will not grow! </font><font style="vertical-align: inherit;">And only at the end of the lock its value will jump sharply for the full waiting time. </font><font style="vertical-align: inherit;">On the graph, instead of the expected 'plateau', you will get a sharp peak, which also spoils your scale along the Y axis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same problem is with kvery:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> <span class="hljs-keyword">sum</span>(wait_time_ms) 
  <span class="hljs-keyword">from</span> sys.dm_os_wait_stats 
  <span class="hljs-keyword">where</span> wait_type <span class="hljs-keyword">like</span> <span class="hljs-string">'LCK_%'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we must add the time of the current ones to the time of the 'completed' locks:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">declare</span> @NEWlock <span class="hljs-built_in">bigint</span>
<span class="hljs-keyword">select</span> @NEWlock=<span class="hljs-keyword">sum</span>(wait_time_ms) 
  <span class="hljs-keyword">from</span> sys.dm_os_wait_stats 
  <span class="hljs-keyword">where</span> wait_type <span class="hljs-keyword">like</span> <span class="hljs-string">'LCK_%'</span> <span class="hljs-comment">-- finished waits</span>
<span class="hljs-keyword">select</span> @NEWlock=@NEWlock+<span class="hljs-keyword">isnull</span>(<span class="hljs-keyword">sum</span>(waittime),<span class="hljs-number">0</span>) 
  <span class="hljs-keyword">from</span> master.dbo.sysprocesses 
  <span class="hljs-keyword">where</span> blocked&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> lastwaittype <span class="hljs-keyword">like</span> <span class="hljs-string">'LCK_%'</span> <span class="hljs-comment">-- waits in progress</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This querie already gives the correct plateau on the chart. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to consider the delta from the previous value. </font><font style="vertical-align: inherit;">There are two ways:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design a process as a job that is called frequently (say, once per minute). </font><font style="vertical-align: inherit;">Create a label to store previous values. </font><font style="vertical-align: inherit;">In fact, it is often bad to call job (overhead + competition for the execution history of Jobs), and you can do without an additional plate:</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a process that runs in an endless loop with waitfor. </font><font style="vertical-align: inherit;">The process remembers the previous value in the variable. </font><font style="vertical-align: inherit;">We will process the process as a job with two schedule: at startup and once an hour (in case job falls, then it will restart)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the second case, it is quite possible to do a cycle every five seconds or even more often. </font><font style="vertical-align: inherit;">So, we get:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">declare</span> @OLDlock <span class="hljs-built_in">bigint</span>, @NEWlock <span class="hljs-built_in">bigint</span>
<span class="hljs-keyword">declare</span> @<span class="hljs-keyword">lock</span> <span class="hljs-built_in">int</span>, @<span class="hljs-keyword">seconds</span> <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span> <span class="hljs-comment">-- must match WAITFOR</span>
<span class="hljs-keyword">loop</span>:
  <span class="hljs-keyword">set</span> @OLDlock=@NEWlock <span class="hljs-comment">-- shift new to old</span>
  <span class="hljs-keyword">select</span> @NEWlock=<span class="hljs-keyword">sum</span>(wait_time_ms) 
    <span class="hljs-keyword">from</span> sys.dm_os_wait_stats 
	<span class="hljs-keyword">where</span> wait_type <span class="hljs-keyword">like</span> <span class="hljs-string">'LCK_%'</span> <span class="hljs-comment">-- finished waits</span>
  <span class="hljs-keyword">select</span> @NEWlock=@NEWlock+<span class="hljs-keyword">isnull</span>(<span class="hljs-keyword">sum</span>(waittime),<span class="hljs-number">0</span>) 
    <span class="hljs-keyword">from</span> master.dbo.sysprocesses 
	<span class="hljs-keyword">where</span> blocked&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> lastwaittype <span class="hljs-keyword">like</span> <span class="hljs-string">'LCK_%'</span> <span class="hljs-comment">-- waits in progress</span>
  <span class="hljs-keyword">set</span> @<span class="hljs-keyword">lock</span>=(@NEWlock-@OLDlock)/@<span class="hljs-keyword">seconds</span> <span class="hljs-comment">-- this is delta</span>
  <span class="hljs-keyword">if</span> @<span class="hljs-keyword">lock</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>    
    dbcc setinstance (<span class="hljs-string">'SQLServer:User Settable'</span>, <span class="hljs-string">'Query'</span>, 
	  <span class="hljs-string">'LOCK ms per s'</span>, @<span class="hljs-keyword">lock</span>)<font></font>
  waitfor delay <span class="hljs-string">'00:00:05'</span> 
<span class="hljs-keyword">goto</span> <span class="hljs-keyword">loop</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Please note that the first time you run a DBCC loop, it will be skipped (which is correct), since @OLDlock (and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) will be null.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497226/index.html">Webinar "Remote monitoring and diagnostics of equipment in modern production"</a></li>
<li><a href="../en497228/index.html">Parsing CTF Tasks with Information Security Experts</a></li>
<li><a href="../en497230/index.html">Compression (compression) of images of various formats</a></li>
<li><a href="../en497232/index.html">Nikolay Petrov: ‚ÄúOpenStreetMap is a project where it is not necessary to communicate with people‚Äù</a></li>
<li><a href="../en497234/index.html">Modifying MQTT Proxy</a></li>
<li><a href="../en497240/index.html">Analysis of Baruch Sadogursky's report ‚ÄúDevOps for developers (or against them ?!)‚Äù</a></li>
<li><a href="../en497242/index.html">Homemade half mask respirator from improvised materials in 10 minutes</a></li>
<li><a href="../en497248/index.html">Microservices or modular systems? How can a customer choose an approach to the IT architecture of a product</a></li>
<li><a href="../en497254/index.html">Cisco HyperFlex: Launch, Configure, Cloud Integration - April 21-22</a></li>
<li><a href="../en497258/index.html">Tcl / Tk. Alternative file explorer for Linux and Android platforms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>