<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆑 🧑🏿‍🤝‍🧑🏾 🔍 Kami memantau basis data PostgreSQL - siapa yang harus disalahkan dan apa yang harus dilakukan 🦁 👨🏾‍🚀 👨🏾‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya sudah berbicara tentang bagaimana kita "menangkap" masalah PostgreSQL menggunakan pemantauan log massal pada ratusan server secara bersamaan. Tap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kami memantau basis data PostgreSQL - siapa yang harus disalahkan dan apa yang harus dilakukan</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/502478/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya sudah berbicara tentang </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bagaimana kita "menangkap" masalah PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menggunakan pemantauan log massal pada ratusan server secara bersamaan. Tapi selain log, DBMS ini juga memberi kita </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">banyak alat untuk menganalisis kondisinya</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - itu adalah dosa untuk tidak menggunakannya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Benar, jika Anda hanya melihatnya dari konsol, Anda dapat dengan cepat berputar tanpa manfaat apa pun, karena jumlah data yang tersedia bagi kami melebihi semua batas yang masuk akal.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s1/za/d-/s1zad-d3claa2klkewtgrj8zdaa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oleh karena itu, agar situasi tetap terkendali, kami </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengembangkan add-on untuk Zabbix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> yang memberikan metrik, membentuk layar, dan membuat </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aturan pemantauan yang seragam</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk semua server dan database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artikel hari ini adalah tentang kesimpulan apa yang bisa ditarik dengan mengamati secara dinamis berbagai metrik basis server PostgreSQL, dan di mana masalahnya mungkin disembunyikan.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Status hubungan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hal pertama yang dimulai dari semua pembongkaran pada topik "apa yang terjadi pada basis data / buruk" adalah memantau status ringkasan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_activity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/az/zv/9k/azzv9kl_xmnaxjdfgsgjkmikr48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada grafik kiri kita melihat semua koneksi yang menunggu sesuatu, di sebelah kanan - yang merupakan sesuatu melakukan. </font><font style="vertical-align: inherit;">Tergantung pada versi PG, status koneksi ditentukan oleh </font></font><code>pg_stat_activity.state/wait_event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan / atau teks dari permintaan itu sendiri. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang harus dicari</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terlalu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sedikit</font></font><code>idle</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pada beberapa titik aplikasi Anda mungkin tidak memiliki cukup koneksi yang sudah terbuka ke database, dan ketika Anda mencoba untuk membuka yang lain, Anda akan berakhir menunggu proses untuk menginisialisasi untuk melayani koneksi baru.</font></font></li>
<li> <b> <code>idle</code></b>      «»    ,         <code>max_connections</code>.</li>
<li><b> <code>idle in transaction</code></b> —  ,    -  pgbouncer.            .<br>
<br>
        ,  <b>   </b>  ,     <code>idle_in_transaction_session_timeout</code>.</li>
<li><b> <code>wait</code></b> —   - «»  .       —     .<br>
<br>
     ,  <b>  «» </b>  <code>pg_terminate_backend(pid)</code>.</li>
<li><b> <code>active</code></b> ( max-) ,        «».     -     (, « »)      ,   ,    …<br>
<br>
   —       ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">«» </a>.</li>
<li><b><code>maintenance</code></b> —    ,     - :<br>
<br>
<pre><code class="plaintext hljs">query ~* E'^(\\s*(--[^\\n]*\\n|/\\*.*\\*/|\\n))*(autovacuum|VACUUM|ANALYZE|REINDEX|CLUSTER|CREATE|ALTER|TRUNCATE|DROP)'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kebanyakan kasus, akan ada jumlah autovacuum / autoanalyze yang bekerja pada saat yang sama, yang salah satunya adalah penggunaan sumber daya server untuk kasus "asing". </font><font style="vertical-align: inherit;">Jika ini penting untuk Anda - putar </font></font><code>autovacuum_max_workers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>autovacuum_naptime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tapi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">matikan sepenuhnya - Anda tidak boleh</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi jika </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pada saat yang sama mulai tumbuh </font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan</font></font><code>maintenance</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ini adalah kesempatan untuk melihat apakah seseorang telah memutuskan untuk mengeluarkan DBA atau kode pengembang, misalnya, memblokir setengah peluang aplikasi fungsional.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena penting bagi kami untuk menghapus tidak hanya banyak metrik, tetapi juga untuk melakukannya seefisien mungkin, kami mencoba memotret beberapa dari mereka secara bersamaan dalam kerangka satu permintaan:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Koneksi dan status kunci</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> event_types(wait_event_type) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'lwlock'</span>)<font></font>
  , (<span class="hljs-string">'lock'</span>)<font></font>
  , (<span class="hljs-string">'bufferpin'</span>)<font></font>
  , (<span class="hljs-string">'client'</span>)<font></font>
  , (<span class="hljs-string">'extension'</span>)<font></font>
  , (<span class="hljs-string">'ipc'</span>)<font></font>
  , (<span class="hljs-string">'timeout'</span>)<font></font>
  , (<span class="hljs-string">'io'</span>)<font></font>
)<font></font>
, <span class="hljs-keyword">events</span>(wait_event) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'walwritelock'</span>)<font></font>
  , (<span class="hljs-string">'wal_insert'</span>)<font></font>
  , (<span class="hljs-string">'buffer_content'</span>)<font></font>
  , (<span class="hljs-string">'buffer_io'</span>)<font></font>
  , (<span class="hljs-string">'lock_manager'</span>)<font></font>
  , (<span class="hljs-string">'relation'</span>)<font></font>
  , (<span class="hljs-string">'extend'</span>)<font></font>
  , (<span class="hljs-string">'page'</span>)<font></font>
  , (<span class="hljs-string">'tuple'</span>)<font></font>
  , (<span class="hljs-string">'transactionid'</span>)<font></font>
  , (<span class="hljs-string">'virtualxid'</span>)<font></font>
  , (<span class="hljs-string">'speculative token'</span>)<font></font>
  , (<span class="hljs-string">'object'</span>)<font></font>
  , (<span class="hljs-string">'userlock'</span>)<font></font>
  , (<span class="hljs-string">'advisory'</span>)<font></font>
  , (<span class="hljs-string">'clientread'</span>)<font></font>
  , (<span class="hljs-string">'datafileextend'</span>)<font></font>
  , (<span class="hljs-string">'datafileread'</span>)<font></font>
  , (<span class="hljs-string">'datafilewrite'</span>)<font></font>
  , (<span class="hljs-string">'slruread'</span>)<font></font>
  , (<span class="hljs-string">'slruwrite'</span>)<font></font>
)<font></font>
, states(state) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'running'</span>)<font></font>
  , (<span class="hljs-string">'maintenance'</span>)<font></font>
  , (<span class="hljs-string">'waiting'</span>)<font></font>
  , (<span class="hljs-string">'transaction'</span>)<font></font>
  , (<span class="hljs-string">'idle'</span>)<font></font>
)<font></font>
, stats <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">SELECT</span><font></font>
    pid<font></font>
  , datname<font></font>
  , state<font></font>
  , <span class="hljs-keyword">lower</span>(wait_event_type) wait_event_type<font></font>
  , <span class="hljs-keyword">lower</span>(wait_event) wait_event<font></font>
  , <span class="hljs-keyword">query</span>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_stat_activity<font></font>
  <span class="hljs-keyword">WHERE</span><font></font>
    pid &lt;&gt; pg_backend_pid()<font></font>
)<font></font>
, dbs <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">SELECT</span><font></font>
    datname<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_database db<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> db.datistemplate<font></font>
)<font></font>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(s.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , states.state<font></font>
  , <span class="hljs-literal">true</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span><font></font>
    states<font></font>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , <span class="hljs-keyword">CASE</span>
          <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">query</span> ~* E<span class="hljs-string">'^(\\s*(--[^\\n]*\\n|/\\*.*\\*/|\\n))*(autovacuum|VACUUM|ANALYZE|REINDEX|CLUSTER|CREATE|ALTER|TRUNCATE|DROP)'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'maintenance'</span>
          <span class="hljs-keyword">WHEN</span> wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
            wait_event &lt;&gt; <span class="hljs-string">'clientread'</span> <span class="hljs-keyword">AND</span>
            state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'waiting'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'running'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'idle'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'idle'</span>
          <span class="hljs-keyword">WHEN</span> state <span class="hljs-keyword">IN</span> (<span class="hljs-string">'idle in transaction'</span>, <span class="hljs-string">'idle in transaction (aborted)'</span>) <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'transaction'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'fastpath function call'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'fastpath'</span>
          <span class="hljs-keyword">ELSE</span>
            <span class="hljs-string">'disabled'</span>
        <span class="hljs-keyword">END</span> state<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) s<font></font>
<span class="hljs-keyword">UNION</span>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(t.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , event_types.wait_event_type<font></font>
  , <span class="hljs-literal">false</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span><font></font>
    event_types<font></font>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , wait_event_type<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">WHERE</span>
        wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) t<font></font>
<span class="hljs-keyword">UNION</span>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(e.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , events.wait_event<font></font>
  , <span class="hljs-literal">false</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span>
    <span class="hljs-keyword">events</span>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , wait_event<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">WHERE</span>
        wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) e;<font></font>
</code></pre></div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kunci</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena kami menyentuh tentang pemblokiran pemantauan pada paragraf sebelumnya, perlu dicatat bahwa PostgreSQL suka overlay kanan dan kiri: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nz/jl/vd/nzjlvdmvxaaqxdotpshnyuhydlo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami paling tertarik pada dua jenis:</font></font><br>
<br>
<ul>
<li><b><code>Exclusive</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - biasanya terjadi ketika mengunci pada catatan tertentu.</font></font></li>
<li><b><code>AccessExclusive</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - saat melakukan operasi pemeliharaan di atas meja.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi jangan lupa bahwa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jumlah kunci bukan karet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baik kunci penasihat dan reguler disimpan di area memori bersama, yang ukurannya ditentukan oleh parameter konfigurasi </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Penting agar memori ini memadai, karena </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jika tidak server tidak akan dapat mengeluarkan </font><font style="vertical-align: inherit;">kunci </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apa pun</font></font></u><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dengan demikian, jumlah kunci yang direkomendasikan yang dapat dikeluarkan oleh server biasanya terbatas pada puluhan atau ratusan ribu, tergantung pada konfigurasi server.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biasanya, situasi ini muncul jika aplikasi Anda "mengalir" dan sumber daya tidak dirilis: koneksi ke database, konteks transaksi, atau </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kunci penasihat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Karena itu, perhatikan dinamika keseluruhan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transaksi per detik (TPS)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mendapatkan informasi tentang perubahan dalam konteks database saat ini, Anda dapat menggunakan tampilan sistem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_database</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tetapi jika ada banyak database di server, akan lebih mudah untuk melakukan ini segera untuk mereka semua, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terhubung ke</font></font><code>postgres</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPS &amp; tupel</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">extract</span>(epoch <span class="hljs-keyword">from</span> <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
, datname dbname<font></font>
, pg_stat_get_db_tuples_returned(<span class="hljs-keyword">oid</span>) tup_returned<font></font>
, pg_stat_get_db_tuples_fetched(<span class="hljs-keyword">oid</span>) tup_fetched<font></font>
, pg_stat_get_db_tuples_inserted(<span class="hljs-keyword">oid</span>) tup_inserted<font></font>
, pg_stat_get_db_tuples_updated(<span class="hljs-keyword">oid</span>) tup_updated<font></font>
, pg_stat_get_db_tuples_deleted(<span class="hljs-keyword">oid</span>) tup_deleted<font></font>
, pg_stat_get_db_xact_commit(<span class="hljs-keyword">oid</span>) xact_commit<font></font>
, pg_stat_get_db_xact_rollback(<span class="hljs-keyword">oid</span>) xact_rollback
<span class="hljs-keyword">FROM</span><font></font>
  pg_database<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">NOT</span> datistemplate;
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya ingin menekankan secara terpisah - jangan abaikan output dari </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nilai maksimal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> metrik! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ls/yn/yt/lsynyt4rkawj8hvp2pcrnvjiozk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam grafik ini, kita dapat dengan jelas melihat situasi peningkatan puncak tiba-tiba dalam jumlah </font></font><b><code>commit</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transaksi yang </font><font style="vertical-align: inherit;">dilakukan ( </font><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Ini bukan satu-satu sesuai dengan beban di server dan transaksi dapat dengan kompleksitas yang berbeda-beda, tetapi pertumbuhan 4 kali lipat jelas menunjukkan bahwa server </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">harus memiliki cadangan kinerja tertentu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk bertahan dari puncak seperti itu tanpa masalah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nah, rollback ( </font></font><b><code>rollback</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) dari transaksi adalah kesempatan untuk memeriksa apakah aplikasi Anda secara sadar dieksekusi </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, atau apakah server secara otomatis melakukan ini sebagai akibat dari kesalahan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jumlah operasi pada catatan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, perhatikan catatan yang kita kurangi dari indeks / tabel:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/av/sw/dmavswryoevflquj7krtbykqgtw.png"><br>
<br>
<ul>
<li><b><code>tuples.returned</code></b> —   ,   «»   .</li>
<li><b><code>tuples.fetched</code></b> —   ,     « »   <code>Rows Removed by Filter</code>,   «»   .</li>
<li><b><code>tuples.ratio</code></b> — ,    ,  <b>   1</b>,   —  .   ,  ,       ,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda mengamati </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puncak yang tajam</font></font><code>tuples.ratio</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Anda dapat yakin bahwa beberapa permintaan tidak efisien dari kategori yang dijelaskan dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel tentang resep untuk perawatan mereka</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> akan menemukan Anda di log </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun, meski </font></font><code>ratio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idealnya sama dengan 1, tetapi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puncaknya jatuh</font></font><code>returned/fetched</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - juga jangan berharap bagus. Biasanya ini dapat berarti bahwa ada beberapa masalah dalam rencana, seperti:</font></font><br>
<br>
<pre><code class="plaintext hljs">Hash Join<font></font>
  - Hash<font></font>
    - Seq Scan on BIG_TABLE<font></font>
  - Index Scan ...</code></pre><br>
<pre><code class="plaintext hljs">Merge Join<font></font>
  - Index Scan on BIG_INDEX<font></font>
  - Index Scan ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena kami mulai memeriksa apa yang sedang dibaca di sana, mari kita lihat bagaimana itu terjadi. </font><font style="vertical-align: inherit;">Yaitu, berapa banyak catatan yang kita baca berdasarkan indeks, dan seberapa banyak hasilnya </font></font><b><code>Seq Scan</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7y/3o/xq/7y3oxqadodpa_zgrhyv0nfxzzua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jelas bahwa di sini setiap pertumbuhan indikator yang tidak direncanakan harus menimbulkan kecurigaan. </font><font style="vertical-align: inherit;">Misalnya, jika karena alasan tertentu Anda perlu membaca sepiring penuh catatan 10 juta setiap malam, maka penampilan puncak seperti itu di siang hari adalah alasan pembongkaran. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Serta setiap sisipan / pembaruan / penghapusan masal-anomali massal:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/85/pn/dl/85pndlf5hstls4os3jwmtsuserc.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan cache data</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memahami bagaimana pengoreksian ulang rekaman yang benar-benar memperburuk kehidupan server, mari kita lihat bagaimana server bekerja dengan halaman data dan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perbandingannya</font></font><code>block.read/hit</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dalam dunia yang ideal, server tidak boleh "membaca" dari disk ( </font></font><code>shared read</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pada node rencana) sama sekali tidak ada, semuanya harus sudah ada dalam memori ( </font></font><code>shared hit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), karena </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengakses disk selalu lambat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada kenyataannya, ini tidak sepenuhnya benar, dan merupakan alasan untuk analisis menyeluruh permintaan sekitar waktu puncak:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/ue/xl/btuexl-qt3d384qarrm0n6chlr0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permintaan / Transaksi Terpanjang</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk MVCC, permintaan jangka panjang dan transaksi dalam sistem sibuk adalah bencana kinerja. </font><font style="vertical-align: inherit;">Detail dan gambar tentang ini bisa dibaca di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - bagaimana Anda masih bisa bertahan dalam kondisi seperti itu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a0/jl/ls/a0jllsvlvmsny6hhyq_mjnhnmli.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menangkap penjahat seperti itu membantu kita </font></font><code>pg_stat_activity.query_start/xact_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang ditunjukkan oleh pengalaman kami, representasi visual dari metrik ini sudah cukup untuk secara kasar menunjukkan di mana "menggali" lebih lanjut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mencari kebocoran sumber daya dalam aplikasi</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimalkan permintaan yang gagal</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">letakkan perangkat keras yang lebih produktif</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... atau pastikan bahwa beban ditempatkan dengan benar pada waktunya</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id502460/index.html">Apa yang diharapkan di arena startup Ukraina pada tahun 2020?</a></li>
<li><a href="../id502462/index.html">Acara digital di Moskow dari 18 hingga 24 Mei</a></li>
<li><a href="../id502464/index.html">Acara digital di St. Petersburg dari 18 hingga 24 Mei</a></li>
<li><a href="../id502466/index.html">RIT ++ baru dalam kondisi baru</a></li>
<li><a href="../id502472/index.html">Pemantauan Prometheus untuk aplikasi layanan mikro. Vitaly Levchenko</a></li>
<li><a href="../id502480/index.html">Apa itu DHCP Snooping dan bagaimana cara kerjanya?</a></li>
<li><a href="../id502486/index.html">Buku "Perlombaan dengan epidemi. Antibiotik terhadap bakteri super "</a></li>
<li><a href="../id502490/index.html">Melanggar kepercayaan yang membatasi. Untuk apa dan apa yang diberikannya</a></li>
<li><a href="../id502492/index.html">Inovasi di Zextras Suite dan Zimbra OSE</a></li>
<li><a href="../id502494/index.html">7 kesalahan satu Black Friday dan bagaimana Magento Cloud bekerja - video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>