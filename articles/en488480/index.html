<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶É üèª üîº A smart lamp for the "rich" with their "lazy" hands, it‚Äôs "simple" and convenient ü§∂üèª üòç üë©üèº‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction
 He made a ‚Äúmodern‚Äù lighting in the kitchen for a sink, stove and cutting table on the basis of LED strip controlled by arduino (let it b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>A smart lamp for the "rich" with their "lazy" hands, it‚Äôs "simple" and convenient</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488480/"><img src="https://habrastorage.org/webt/os/hi/gl/oshiglmjknpmabuu6ivivauqzdw.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He made a ‚Äúmodern‚Äù lighting in the kitchen for a sink, stove and cutting table on the basis of LED strip controlled by arduino (let it be called lamp 1). </font><font style="vertical-align: inherit;">This design worked for 2 years, until the power part of the "brains" has deteriorated. </font><font style="vertical-align: inherit;">This is an excellent occasion to reinvent the wheel from the ‚Äúimprovised trash‚Äù again (lamp 2). </font><font style="vertical-align: inherit;">True, this time the "trash" will be expensive and compatible with the Z-wave smart home. </font><font style="vertical-align: inherit;">The following is a story about replacing arduino with ZUNo (an arduino compatible module for creating a Z-wave device) with maximum code saving and an explanation of the necessary changes.</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What happened before I appeared there</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once upon a time, in order to wash dishes or cook food, it was necessary to turn on the lamp above the sink. </font><font style="vertical-align: inherit;">It was a redone table lamp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did not like to press the small switch with wet hands because it switched 220 volts to the incandescent lamp. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/yz/dq/tlyzdqgfcsedxxsswsqlekygins.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, the light from the lamp fell mainly on the sink, but I wanted to better illuminate the cooking table and stove. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Objectives:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Make the on / off light in the kitchen contactless;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Evenly illuminate the sink, cooking table and stove;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Save energy by replacing incandescent bulbs with LEDs.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He assembled the lamp 1. It consisted of a 2-meter aluminum box with a diffuser for RGB tape and a control unit. A box and a diffuser were bought ready-made at the store, there was a tape, and the control unit had long been in the corner and was waiting in the wings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The case was industrial (dustproof, waterproof). Since the tape is 12 volts, the power supply unit from 220 V to 12 V is located in the unit, the galvanic isolation board for controlling the tape based on TLP250 (optocoupler) also controlled all this arduino in a compact design.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 I got the galvanic isolation from the old project. Once I made a backlight for a minibar in my nightstand. When the door was opened, the touch pad recorded a change in capacity and turned on softly shimmering light. That is, the board was well suited for the current project, all that remained was to cut off everything unnecessary. There was a 5-volt linear converter on the board, it was powered by ZUNo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was planned to turn on the lamp with a hand tray to the ultrasonic distance meter. He mounted it in the lid, and all the other parts got into the box. All "reliably" fixed with hot-melt adhesive. At the time of testing, I made a nearby button to supply power to the control unit from a light switch for external installation.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/dn/tj/r2dntjzjoijyn-g7vk4vdkg-d5y.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Turning on the lights has become more convenient and safer. </font><font style="vertical-align: inherit;">It was attached upside down to the bottom of the kitchen cabinet and it was harder to get water from wet hands from inside.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions from the previous control unit</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lighting of the working area of ‚Äã‚Äãthe kitchen became more even and pleasant, due to the unnatural color rendering of my LED strip, the color of some products changed. </font><font style="vertical-align: inherit;">For example: carrots seemed much more appetizing due to the brighter color. </font><font style="vertical-align: inherit;">But it didn‚Äôt interfere much, and I hope it didn‚Äôt do much harm. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With contactless on / off, everything turned out to be worse. </font><font style="vertical-align: inherit;">It worked. </font><font style="vertical-align: inherit;">But after 5 minutes in the off state, flashes began on the LED strip. </font><font style="vertical-align: inherit;">I did not begin to redo the circuit on optocouplers and left everything as it is. </font><font style="vertical-align: inherit;">Only to turn on and off began to use the new switch. </font><font style="vertical-align: inherit;">Everyone liked its location and shape.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Over two years of use, fat and other compounds secreted during cooking accumulated on the body and inside it. </font><font style="vertical-align: inherit;">This plaque partially penetrated into the housing through the holes for the entry of wires. </font><font style="vertical-align: inherit;">But due to the glossy surface of the body, this substance condenses into a gelatinous mass. </font><font style="vertical-align: inherit;">It‚Äôs pleasant to the touch, odorless and ... (I didn‚Äôt taste it). </font><font style="vertical-align: inherit;">I took some photos of the spot in the form of a dragon germ. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jz/fr/ys/jzfrystsmthfk7fy5j_o70kkcfm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/ot/br/mg/otbrmglxan7uooc1a1e4n88z9iq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the walls, this substance turns into a terrible raid, which is not just laundered.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What has become</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having rummaged in bins I found an unfinished expansion module for ZUNo. </font><font style="vertical-align: inherit;">ZUNo is an arduino-like board for designing your own device compatible with the Z-Wave smart home. </font><font style="vertical-align: inherit;">It is programmed from the environment of arduino.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manufacturer Specifications:</font></font></b><div class="spoiler_text"><ul>
<li>28 kB Flash memory for your sketches</li>
<li>2 kB RAM available</li>
<li>Z-Wave RF transmitter at 9.6/40/100 kbps</li>
<li>26 GPIO (overlaps with special hardware controllers)</li>
<li>4 ADC</li>
<li>5 PWM</li>
<li>2 UART</li>
<li>1 USB (serial port)</li>
<li>16 kB EEPROM</li>
<li>1 SPI (master or slave)</li>
<li>4 IR controllers, 1 IR learn capability</li>
<li>1 TRIAC/ZEROX to control dimmer</li>
<li>3 Interrupts</li>
<li>1 Timer 4 MHz</li>
<li>I2C (software)</li>
<li>1-Wire (software)</li>
<li>8x6 Keypad Scanner (software)</li>
<li>2 service LED, 1 service button</li>
<li>1 user test LED</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The expansion module makes ZUNo a full-fledged debug board, which, after debugging the prototype, can be used as a complete device. </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some information from the manufacturer:</font></font></b><div class="spoiler_text"><ul>
<li>One 0-10 V analog output ‚Äî control industrial dimmers</li>
<li>Up to four PWM or switch outputs (up to 5 A per channel) ‚Äî control contactors, switches, halogen bulbs or LED strips</li>
<li>Up to eight digital 0/3 V inputs or outputs ‚Äî connect various low voltage digital senors and actors</li>
<li>Up to four digital 0/3, 0/5 or 0/12 V digital or analog inputs ‚Äî connect industrial 10 V sensors or any Arduino-compatible sensor</li>
<li>RS485 or UART ‚Äî for industial meters</li>
<li>OneWire ‚Äî for DS18B20 or other sensors</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For my project, I need 3 powerful transistors for switching 12 volts to an LED strip and a converter from 12 volts to 5 volts to power ZUNo. </font><font style="vertical-align: inherit;">The rest of the periphery of the expansion module is not soldered or tested. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4j/kr/tt/4jkrtt63ocqqrkugav0nrtfvtn8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this part of the circuit, there is not enough diode for power supply, for protection against "polarity reversal", and resistors on the gates of power field-effect transistors had to be connected to the gate, and not in front of the limiting resistor. </font><font style="vertical-align: inherit;">I will write more about this in the conclusions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This expansion module is supplied in a housing from Gainta. </font><font style="vertical-align: inherit;">My previous control unit was also in the case from this company, but of a different size. </font><font style="vertical-align: inherit;">Unfortunately, the fastenings on the module did not fit the old case, and I did not want to drill a new one, I left the old case. </font><font style="vertical-align: inherit;">The board was "planted" on hot melt adhesive.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wm/ls/ah/wmlsahydh07_hxmpqaryl1atchs.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit about programming Arduino and ZUNo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Z-wave devices must have a certain number of classes. Classes describe device functions and interaction interfaces. For example, my lamp controls an LED strip consisting of three colors (red, green, blue). These functions are performed by the Switch multilevel class. If we add it to the sketch, we can remotely change the brightness of one of the colors. To control three colors, you need to make three instances of this class. I will not talk about this in more detail and detail. Because routine class manipulation is hidden for ZUNo users by the notion of ‚Äúchannel‚Äù. For example, I need three classes of Switch multilevel, so in the code should appear 3 channels of Switch multilevel and several callback functions for radio control. How to do this? You also need to add the Switch basic class,to turn the lamp on and off at the touch of a button (from the network controller interface), and not to configure 3 channels each time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You need to go to the developers website, where examples of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z-uno.z-wave.me/Reference/ZUNO_SWITCH_MULTILEVEL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are laid out </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Each class supported by ZUNo has a description and an example. </font><font style="vertical-align: inherit;">Next, copy and paste the proposed functions into your sketch. </font><font style="vertical-align: inherit;">Now in the sketch there are three switch multilevel channels and 6 callback functions for responding to commands on the radio. </font><font style="vertical-align: inherit;">I'm not very sophisticated in Z-Wave classes, so my previous LED strip device worked with this set of classes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The channels were declared like this:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spoiler heading</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">ZUNO_SETUP_CHANNELS(<font></font>
      ZUNO_SWITCH_MULTILEVEL(getRed, setRed),<font></font>
      ZUNO_SWITCH_MULTILEVEL(getGreen, setGreen),<font></font>
      ZUNO_SWITCH_MULTILEVEL(getBlue, setBlue),<font></font>
      ZUNO_SWITCH_BINARY(switch_getter, switch_setter)<font></font>
);</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This led to the generation of the following widgets in the controller after adding to the network: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/to/-y/if/to-yif5eaf9xkuxdk4t2oxp6ph4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To adjust the color, it was necessary to open and configure each color in the controller menu separately. </font><font style="vertical-align: inherit;">It is not convenient and slow. </font><font style="vertical-align: inherit;">However, I was lucky. </font><font style="vertical-align: inherit;">It turned out I'm not alone. </font><font style="vertical-align: inherit;">They thought about us and made the channel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z-uno.z-wave.me/Reference/ZUNO_SWITCH_COLOR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Now there is only one channel and two callback functions in the sketch. </font><font style="vertical-align: inherit;">In the controller‚Äôs menu, the color setting is performed separately for each color, as well as for all at once, by selecting from the palette.</font></font><br>
<br>
<pre><code class="cpp hljs">ZUNO_SETUP_CHANNELS(ZUNO_SWITCH_COLOR(SWITCH_COLOR_FLAGS_RED|SWITCH_COLOR_FLAGS_GREEN|SWITCH_COLOR_FLAGS_BLUE, getterFunction, setterFunction));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in the controller menu it looks like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m3/zn/qk/m3znqkbwue228cttqmqmhggvwxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next function responds to requests via radio. </font><font style="vertical-align: inherit;">A request to read the status of one of the color channels may come.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">BYTE <span class="hljs-title">getterFunction</span><span class="hljs-params">(BYTE component)</span> </span>{
  <span class="hljs-keyword">switch</span>(component)<font></font>
  {<font></font>
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_RED:
      <span class="hljs-keyword">return</span> pwmR;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_GREEN:
      <span class="hljs-keyword">return</span> pwmG;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_BLUE:
      <span class="hljs-keyword">return</span> pwmB;
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And this is a function for setting colors from the controller interface.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setterFunction</span><span class="hljs-params">(BYTE component, BYTE newValue)</span> 
</span>{
  <span class="hljs-keyword">switch</span>(component)<font></font>
  {<font></font>
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_RED:<font></font>
      pwmR = newValue;<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_GREEN:<font></font>
      pwmG = newValue;<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_BLUE:<font></font>
      pwmB = newValue;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  radio_action = <span class="hljs-number">1</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all the code you need to add to turn an arduino sketch into a sketch for ZUNo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After assembly and installation, all declared tasks were completed. </font><font style="vertical-align: inherit;">However, the habit of turning on the light with the switch remained (it turned out to be very convenient). </font><font style="vertical-align: inherit;">Contactless inclusion option also works. </font><font style="vertical-align: inherit;">Among the shortcomings, I want to note the flickering of the LED lamp for a second after applying power to the control unit. </font><font style="vertical-align: inherit;">This is due to the long initialization of the ZUNo peripherals. </font><font style="vertical-align: inherit;">At this point, the legs are unpredictable. </font><font style="vertical-align: inherit;">I think the pull-up resistor on the gate of the transistor will correct the situation if you put it after the limiting resistor. </font><font style="vertical-align: inherit;">If the initialization code adjusts the legs to the output and changes the logic levels purposefully, you can experiment with the RC filter, which will not pass short pulses. </font><font style="vertical-align: inherit;">I haven‚Äôt done it yet, and maybe I won‚Äôt ever do it!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZUNo and its expansion module greatly simplify ‚Äúhome technical creativity‚Äù. However, I consider these products to be very expensive and if I worked elsewhere and Z-Wave equipment wasn‚Äôt lying around, I would do everything on ESP8266. During development I learned a new ‚Äústandard‚Äù for marking wires from the power supply.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sx/c4/4h/sxc44hipyu2ml_agdxtaqthtvrs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now not only the earth is marked with a black stripe, but like in my case the ‚Äúpositive" wire. For the expansion module, this turned out to be important. The 5-volt LM2594 converter has failed (the price in Chip and Dip is about 200 rubles). I hope that in the next version of the expansion module there will be a protective diode against ‚Äúpolarity reversal‚Äù. And I will check the polarity of the supply wires. Another drawback is associated with the body. The case looks good, but I could not connect the wires without tweezers to the terminal blocks. I hope that there will be a version with other terminal blocks (for connecting wires from above, or at an angle). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I do not like to store photos on cloud services and often make backups. Therefore, most of the photographs associated with the design process and the lamp 1 are irretrievably corrupted.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zz/wz/ov/zzwzovgton7f2yxvy-2bd4zhucu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is all that remains of the assembly and debugging process. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And it looks like the backlight put into operation, if you bend a little. </font><font style="vertical-align: inherit;">If you straighten, then the box and the switch is not visible.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ya/qj/hn/yaqjhnpkhd7ge2ohejbp9ywkqpq.jpeg"> <br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sketch for ZUNo. </font><font style="vertical-align: inherit;">I attach, only to confirm that everything is elementary</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"EEPROM.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"EEPR.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">int</span> readPin = <span class="hljs-number">9</span>;
<span class="hljs-keyword">int</span> triggerPin = <span class="hljs-number">10</span>;<font></font>
byte controlState = <span class="hljs-number">0</span>;<font></font>
word lastValue;<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REDPIN   PWM1     <span class="hljs-comment">// pin connection R </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GREENPIN PWM2     <span class="hljs-comment">// pin connection G</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BLUEPIN  PWM3     <span class="hljs-comment">// pin connection B</span></span><font></font>
<font></font>
ZUNO_SETUP_CHANNELS(ZUNO_SWITCH_COLOR(SWITCH_COLOR_FLAGS_RED|SWITCH_COLOR_FLAGS_GREEN|SWITCH_COLOR_FLAGS_BLUE, getterFunction, setterFunction));<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ON 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> OFF 0</span>
<span class="hljs-keyword">uint8_t</span> switch_=OFF;<font></font>
<font></font>
<span class="hljs-keyword">uint8_t</span> pwmR=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> pwmG=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> pwmB=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> b_pwmR=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> b_pwmG=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> b_pwmB=<span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-keyword">enum</span><font></font>
{<font></font>
  DEF_R = <span class="hljs-number">255</span>,<font></font>
  DEF_G = <span class="hljs-number">255</span>,<font></font>
  DEF_B = <span class="hljs-number">255</span><font></font>
};<font></font>
<span class="hljs-keyword">uint8_t</span> radio_action = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> 
</span>{ <font></font>
  init_EEPROM();<font></font>
  Serial.begin();<font></font>
  pinMode(readPin, INPUT);<font></font>
  pinMode(triggerPin, OUTPUT);<font></font>
  digitalWrite(triggerPin, LOW);<font></font>
  pinMode(REDPIN, OUTPUT);<font></font>
  pinMode(GREENPIN, OUTPUT);<font></font>
  pinMode(BLUEPIN, OUTPUT);<font></font>
  analogWrite(REDPIN, pwmR &amp; <span class="hljs-number">0xff</span>);<font></font>
  analogWrite(GREENPIN, pwmG &amp; <span class="hljs-number">0xff</span>);<font></font>
  analogWrite(BLUEPIN, pwmB &amp; <span class="hljs-number">0xff</span>);<font></font>
  <font></font>
} <font></font>
<span class="hljs-keyword">int</span> act=<span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> actf = <span class="hljs-number">0</span>;
<span class="hljs-keyword">int</span> cnt=<span class="hljs-number">57</span>; <font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> tmp;
  <span class="hljs-comment">// trigger measurement</span><font></font>
  digitalWrite(triggerPin, LOW);<font></font>
  delayMicroseconds(<span class="hljs-number">10</span>);<font></font>
  digitalWrite(triggerPin, HIGH);<font></font>
  delayMicroseconds(<span class="hljs-number">10</span>);<font></font>
  digitalWrite(triggerPin, LOW);<font></font>
  <span class="hljs-comment">// read pulse width</span>
  tmp = pulseIn(readPin, HIGH, <span class="hljs-number">100000</span>);<font></font>
  lastValue = tmp / <span class="hljs-number">58</span>;<font></font>
  Serial.print(<span class="hljs-string">" cm= "</span>);<font></font>
  Serial.println(lastValue);<font></font>
  <span class="hljs-keyword">if</span> (lastValue &lt; <span class="hljs-number">30</span>)<font></font>
  {<font></font>
    cnt++;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    cnt--;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (cnt &gt; <span class="hljs-number">55</span>)<font></font>
  { <font></font>
    act=<span class="hljs-number">1</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (cnt &gt; <span class="hljs-number">60</span>)<font></font>
    cnt= <span class="hljs-number">60</span>;
  <span class="hljs-keyword">if</span> (cnt &lt; <span class="hljs-number">50</span>)<font></font>
  {<font></font>
    act=<span class="hljs-number">0</span>;<font></font>
    actf=<span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (cnt &lt; <span class="hljs-number">45</span> )<font></font>
    cnt = <span class="hljs-number">45</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> ((act == <span class="hljs-number">1</span>) &amp;&amp; (actf == <span class="hljs-number">0</span>))<font></font>
  {  <font></font>
    actf = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (switch_ == OFF)<font></font>
    {<font></font>
      switch_=ON;<font></font>
      b_pwmG = pwmG;<font></font>
      b_pwmB = pwmB;<font></font>
      b_pwmR = pwmR;<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
      switch_=OFF;<font></font>
      b_pwmR=<span class="hljs-number">0</span>;<font></font>
      b_pwmG=<span class="hljs-number">0</span>;<font></font>
      b_pwmB=<span class="hljs-number">0</span>;<font></font>
    }<font></font>
    analogWrite(REDPIN, b_pwmR &amp; <span class="hljs-number">0xff</span>);<font></font>
    analogWrite(GREENPIN, b_pwmG &amp; <span class="hljs-number">0xff</span>);<font></font>
    analogWrite(BLUEPIN, b_pwmB &amp; <span class="hljs-number">0xff</span>); <font></font>
  } <font></font>
  <font></font>
  Serial.print(<span class="hljs-string">"cnt = "</span>);    <font></font>
  Serial.print(cnt);  <font></font>
  Serial.print(<span class="hljs-string">" || "</span>);    <font></font>
  Serial.print(pwmR);  <font></font>
  Serial.print(<span class="hljs-string">" "</span>);      <font></font>
  Serial.print(pwmG);  <font></font>
  Serial.print(<span class="hljs-string">" "</span>);<font></font>
  Serial.print(pwmB);  <font></font>
  Serial.print(<span class="hljs-string">" "</span>);<font></font>
  Serial.println(<span class="hljs-string">""</span>);
 <span class="hljs-comment">// delay(10);</span><font></font>
<font></font>
 <span class="hljs-keyword">if</span>(radio_action)<font></font>
 {<font></font>
    radio_action = <span class="hljs-number">0</span>;<font></font>
    eepr_save_col();<font></font>
    analogWrite(REDPIN, pwmR &amp; <span class="hljs-number">0xff</span>);<font></font>
    analogWrite(GREENPIN, pwmG &amp; <span class="hljs-number">0xff</span>);<font></font>
    analogWrite(BLUEPIN, pwmB &amp; <span class="hljs-number">0xff</span>);<font></font>
 }<font></font>
}<font></font>
<font></font>
<span class="hljs-function">BYTE <span class="hljs-title">getterFunction</span><span class="hljs-params">(BYTE component)</span> </span>{
  <span class="hljs-keyword">switch</span>(component)<font></font>
  {<font></font>
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_RED:
      <span class="hljs-keyword">return</span> pwmR;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_GREEN:
      <span class="hljs-keyword">return</span> pwmG;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_BLUE:
      <span class="hljs-keyword">return</span> pwmB;
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setterFunction</span><span class="hljs-params">(BYTE component, BYTE newValue)</span> 
</span>{
  <span class="hljs-keyword">switch</span>(component)<font></font>
  {<font></font>
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_RED:<font></font>
      pwmR = newValue;<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_GREEN:<font></font>
      pwmG = newValue;<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_BLUE:<font></font>
      pwmB = newValue;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  radio_action = <span class="hljs-number">1</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488470/index.html">Kim Dotcom: Caught, the most wanted person online. Part 4</a></li>
<li><a href="../en488472/index.html">Weekend Reading: 10 materials about audio gadgets - from Soviet car radios to noise-canceling plugs</a></li>
<li><a href="../en488474/index.html">About color, sound and ‚Äúcrowd exploration‚Äù as a separate kind of beautiful</a></li>
<li><a href="../en488476/index.html">Tesla Tube Coil</a></li>
<li><a href="../en488478/index.html">Transfer all MS SQL Server databases to another machine</a></li>
<li><a href="../en488482/index.html">How much is Appium for the people</a></li>
<li><a href="../en488484/index.html">SQL Launch - Microsoft SQL Server 2019 event</a></li>
<li><a href="../en488488/index.html">For OpenBSD. A bit of delight</a></li>
<li><a href="../en488490/index.html">Likbez on respirators. Does the respirator help with virus infection? Overview of 11 respirators</a></li>
<li><a href="../en488492/index.html">Tesla will issue new shares for $ 2 billion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>