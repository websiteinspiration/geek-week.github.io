<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👗 🙈 ☝🏾 VPN / Mikrotik Zwei-Faktor-Authentifizierung - einfach und skalierbar 🌷 🐔 🙋🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo! 
 
 Zum Schreiben dieses Artikels wurde ich aufgefordert, den ähnlichen Inhalt eines Benutzerartikels zu lesennkusnetsov. Die Anzahl der Aufruf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>VPN / Mikrotik Zwei-Faktor-Authentifizierung - einfach und skalierbar</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506708/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Schreiben dieses Artikels wurde ich aufgefordert, den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ähnlichen Inhalt eines</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Benutzerartikels </font><font style="vertical-align: inherit;">zu lesen</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nkusnetsov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Die Anzahl der Aufrufe zeigt, dass die Community an diesem Thema interessiert ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus diesem Grund habe ich beschlossen, Ihnen meine eigene Lösung mitzuteilen, die zuvor von mir implementiert wurde und in ihrer Grundform Folgendes aufweist:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geringe Eingabe und Einfachheit des Codes (zum Verständnis / Debuggen durch einen anderen Mitarbeiter)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einfache ROS-Skripte erzeugen keine Last und funktionieren sogar mit hAP Lite</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skalierbarkeit - Die Möglichkeit, eine große Anzahl von VPN-Gateways zu verbinden, um die Last oder die geografische Verteilung zu verringern</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Möglichkeit, Mikrotik CHR als VPN-Server zu verwenden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"1xN" - 1 SMS-Gateway für eine unbegrenzte Anzahl von Routern mit der Möglichkeit der Erweiterung mit zunehmender Last</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Möglichkeit, einen separaten Router an ein "bestimmtes" Modem zu binden (wofür? - dazu später mehr)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden von nur einem PHP-Skript auf einem Remote-Server</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es spielt keine Rolle, welches Gerät die VPN-Verbindung initiiert hat, Autorisierung durch den Link von SMS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Möglichkeit, Mitarbeiterberechtigungen auf dem Server zu protokollieren</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erhöhen Sie die Fehlertoleranz und reduzieren Sie die Systemlast, indem Sie zufällig SMS von mehreren Modems senden</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD 1.0 - PHP-Code aktualisiert. </font><font style="vertical-align: inherit;">Jetzt werden alle Anforderungen im Skript protokolliert und Nachrichten zufällig über mehrere Gateways gesendet, wenn mehr als eine angegeben ist.</font></font><br>
<br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erklärung des Problems und der Lösung</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aufgabe 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Entwicklung dieser Lösung wurde die Aufgabe gestellt, die Anzahl der USB-Modems zu minimieren - die Betriebskosten zu senken, die Verwaltung zu vereinfachen, Modems an einem Ort zu lokalisieren und dadurch die Wartbarkeit des Systems zu verbessern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde beschlossen, einen auf dem „zuverlässigen Kanal“ installierten Router als grundlegendes SMS-Gateway zu verwenden. </font><font style="vertical-align: inherit;">Das einzige, was ich nicht wusste, war die Belastung des Systems, die Modems würden damit fertig werden und ob der Bediener es blockieren würde. </font><font style="vertical-align: inherit;">Daher habe ich es möglich gemacht, mehrere Modems anzuschließen und das System weiter in Gruppen zu unterteilen. </font><font style="vertical-align: inherit;">Darüber hinaus können zusätzliche Modems über einen einfachen USB-Hub mit dem Basis-Gateway verbunden werden. </font><font style="vertical-align: inherit;">Für eine vollständige Funktion mit minimaler Funktionalität benötigen Sie jedoch ein Modem, unabhängig von der Anzahl der Router.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aufgabe 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bereitstellung der Möglichkeit der Verwendung lokaler SIM-Karten im Installationsbereich des Routers. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispiel: Ein breites Filialnetz mit mehreren Filialen in Kasachstan. </font><font style="vertical-align: inherit;">Das Senden einer SMS-Nachricht aus der Russischen Föderation ist ziemlich teuer. </font><font style="vertical-align: inherit;">Diese Lösung ermöglicht es Mitarbeitern aus Kasachstan, SMS von einer lokalen Nummer zu erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Reflexionsprozess stellte sich jedoch heraus, dass die Lösung bereits in Aufgabe 1 gefunden und implementiert worden war.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aufgabe 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tunnelautorisierung von einem mobilen Gerät, ohne sich physisch auf dem autorisierten Gerät befinden zu müssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ziel ist die Möglichkeit, nicht nur Benutzertunnel, sondern auch alle VPN-Verbindungen zu autorisieren: Mikrotik-&gt; Mikrotik, Server-&gt; Mikrotik usw. In diesem Fall muss der für diese Tunnel verantwortliche Benutzer nur dem Link aus der SMS-Nachricht folgen, in der auch Welcher Tunnel sich anmelden möchte, wird angezeigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für die Möglichkeit einer Autorisierung auf diese Weise wurde es erforderlich, das Skript auf eine externe Ressource zu übertragen - einen Server, auf den von überall aus zugegriffen werden kann - und den Autorisierungscode auch zum Markieren der Adressliste in der Firewall und zum anschließenden Entsperren zu verwenden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Lösung dieses Problems implizierte bereits eindeutig die Verwendung der RouterOS-API (oder SSH). </font><font style="vertical-align: inherit;">API gewann als einfachste Option.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logik</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Benutzer meldet sich mit vorab hinzugefügtem Benutzernamen und Passwort an</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das VPN-Gateway stellt seine IP in die Adresswarteliste und sendet eine POST-Anfrage an den Server</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Server empfängt Daten, prüft, generiert einen Autorisierungscode und sendet eine SMS an die Kontaktnummer des Formulars: "Um die Verbindung des Benutzers 79001112233 zu autorisieren, öffnen Sie - http_: //synome.ru/? Ruid = vrG7yYMbZ6 &amp; auth = YU6zc"</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Benutzer folgt dem Link von jedem Gerät aus</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Server stellt eine Anfrage an den Router und prüft, ob in der Adressliste des Eintrags der Autorisierungscode im Kommentar vorhanden ist. </font><font style="vertical-align: inherit;">Wenn ein Datensatz gefunden wird, wird er gelöscht und der Benutzer zeigt eine erfolgreiche Anmeldeseite an</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In allen anderen Fällen erhält der Benutzer einen Anforderungsfehler, wenn etwas den Test nicht besteht.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setup und Code</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kommen wir nun vom konzeptionellen Teil zum Einrichten von Mikrotik, dem Code und ihrer Beschreibung. </font><i><font style="vertical-align: inherit;">Erläuterung: Diese Skripte und der PHP-Code sind für alle Arten von VPN-Servern</font></i><font style="vertical-align: inherit;"> geeignet </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn Sie einen Servertyp (PPP / L2TP / SSTP) auswählen, ein Profil und einen Tunnel einrichten - Sie wählen "nach Ihrem Geschmack", werde ich ein allgemeines Beispiel für eine schnelle Konfiguration geben.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zu Mikrotik hinzufügen:</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firewall</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stellen Sie sicher, dass Sie eine Liste der zulässigen Ressourcen erstellen, darunter: eigene MT-Adresse, öffentliches DNS, Serveradresse, auf der die Autorisierung stattfinden wird</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">/ip firewall address-list<font></font>
add address=10.10.0.1 list=Allow-list<font></font>
add address=8.8.8.8 list=Allow-list<font></font>
add address=synome.ru list=Allow-list</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fügen Sie eine Regel hinzu, die den Datenverkehr von VPN-Benutzern von der Warteliste zu einem anderen als dem zulässigen Host blockiert</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">/ip firewall raw<font></font>
add action=drop chain=prerouting dst-address-list=!Allow-list src-address-list=VPN-blocked disabled=no</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPP-Profil</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie ein Profil, in dem wir das Zeitlimit für die Leerlaufverbindung festlegen. </font><font style="vertical-align: inherit;">Die Zeit sollte kürzer sein als im folgenden On-Up-Skript angegeben. Wenn andernfalls keine Autorisierung erfolgt ist, erhält der Benutzer nach dem Entfernen der Liste aus der Adressliste Zugriff für eine Zeit, die der Differenz entspricht (Zeitlimit für Leerlauf minus Zeitlimit für Adressliste).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profil hinzufügen</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">/ppp profile<font></font>
add dns-server=10.10.0.1 idle-timeout=59m local-address=10.10.1.1 name=2F-VPN use-compression=no use-encryption=no use-mpls=no</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als nächstes fügen Sie auf der letzten Registerkarte des Skripts Folgendes hinzu:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auf nach oben</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">:global ruid "#ROUTERLOGIN#";<font></font>
:global pass "#ROUTER_PASSWORD#";<font></font>
:local userip [/ppp active get [find name=$user] address];<font></font>
# if phone number stored in comment<font></font>
#:local userphone [/ppp secret get [find name=$user] comment];<font></font>
# if phone number = username<font></font>
:local userphone $user;<font></font>
<font></font>
:local authkey [/tool fetch http-method=post http-data="ruid=$ruid&amp;pass=$pass&amp;tel=$userphone" url="https://yourwebsite.ru/" mode=https as-value output=user];<font></font>
<font></font>
/ip firewall address-list remove [find address=$userip];<font></font>
/ip firewall address-list add address=$userip list=VPN-blocked timeout=1h comment=($authkey-&gt;"data");<font></font>
<font></font>
:log info message="User connect:";<font></font>
:log info message=$userphone;<font></font>
:log info message=$userip;<font></font>
:log info message=($authkey-&gt;"data");</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auf runter</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">:local userip [/ppp secret get [find name=$user] remote-address];<font></font>
/ip firewall address-list remove [find address=$userip];<font></font>
:log info message="User disconnect:";<font></font>
:log info message=$user;<font></font>
:log info message=$userip;</code></pre><br>
</div>
                    </div><br>
<i> <br>
<br>
 :         ,     .        (      )   ip-.  POST-        .  ip-  address-list VPN-blocked       -  1     .    .<br>
<br>
 :  ip- ,    address-list  .    .</i><br>
<br>
<h4>PPP Secrets</h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"> </b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">/ppp secret<font></font>
add comment="70001112233" name=70001112233 password=testuser profile=2F-VPN remote-address=10.10.1.100</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Telefonnummer kann direkt im Namen angegeben werden. Wenn Sie jedoch eine Nummer für mehrere Konten angeben möchten (für die Autorisierung mehrerer Tunnel), geben Sie die Nummer im Kommentar an, während Sie im On-Up-Skript den Kommentar der Zeilen ändern müssen</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ändern (zweite öffnen, vierte schließen)</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># if phone number stored in comment<font></font>
:local userphone [/ppp secret get [find name=$user] comment];<font></font>
# if phone number = username<font></font>
#:local userphone $user;</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schalten Sie vor allem den PPTP- oder L2TP-Server ein. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit ist mit Mikrotik die Arbeit abgeschlossen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-Backend</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unten ist der Code. </font><font style="vertical-align: inherit;">Er hat ausführlich genug kommentiert, so dass ich keinen zusätzlichen Text schreiben werde. </font><font style="vertical-align: inherit;">Das Wichtigste ist, die Daten in $ host und $ ruid_data durch Ihre eigenen zu ersetzen.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index.php</font></font></b>
                        <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<span class="hljs-comment">// ------------------------------------------------------------------------------</span>
<span class="hljs-comment">//   Copyright () 2020</span>
<span class="hljs-comment">//  Author: Dmitri Agababaev, d.agababaev@duncat.net</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Copyright by authors for used RouterOS PHP API class in the source code files</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Redistributions and use of source code, with or without modification, are</span>
<span class="hljs-comment">//  permitted that retain the above copyright notice</span>
<span class="hljs-comment">// ------------------------------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-keyword">require_once</span>(<span class="hljs-string">'routeros_api.class.php'</span>);<font></font>
<font></font>
<span class="hljs-comment">// -------------------------</span>
<span class="hljs-comment">//   </span>
<span class="hljs-comment">// BASE SETTINGS</span>
<span class="hljs-comment">// -------------------------</span><font></font>
<font></font>
$uselog = <span class="hljs-literal">true</span>; <span class="hljs-comment">// //  ? | Use log? true | false</span>
$log_path = <span class="hljs-string">'mt2Fvpn.log'</span>; <span class="hljs-comment">//     | Log file path</span>
$host = <span class="hljs-string">'https://yourwebsite.com/'</span>; <span class="hljs-comment">//       | Full address that this script awalible</span><font></font>
<font></font>
<span class="hljs-comment">//    /VPN- | ROUTERS DATA ARRAY USED AS VPN-SERVERS</span>
$ruid_data = <span class="hljs-keyword">array</span>(
    <span class="hljs-comment">//   md5,  ip-,    , , SMS-     SMS</span>
    <span class="hljs-comment">// password in md5, global ip-address, mikrotik login, password, SMS-gateway-key will be use to send sms</span>
    <span class="hljs-string">'#ROUTERLOGIN#'</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">'mdpass'</span> =&gt; <span class="hljs-string">'#ROUTER_MD5_PASSWORD#'</span>,
                          <span class="hljs-string">'ip'</span> =&gt; <span class="hljs-string">'XXX.XXX.X.X'</span>,
                          <span class="hljs-string">'login'</span> =&gt; <span class="hljs-string">'#ROSAPI_LOGIN#'</span>,
                          <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'#PASSWORD#'</span>,
                          <span class="hljs-string">'smsgw'</span> =&gt; <span class="hljs-keyword">array</span>(
                                           <span class="hljs-comment">//    SMS     (   )</span>
                                           <span class="hljs-comment">// If you want send SMS randomly from any SMS-gateways, add one here (low modem load)</span>
                                           <span class="hljs-number">0</span> =&gt; <span class="hljs-string">'SMS_gw1'</span>)<font></font>
                          )<font></font>
    );<font></font>
<font></font>
<span class="hljs-comment">//       SMS- | ROUTERS DATA ARRAY WILL BE USED TO SEND AUTHERIZATION SMS</span>
$SMS_gateway = <span class="hljs-keyword">array</span>(
    <span class="hljs-comment">// ip-  (        ), , ,  USB-,  USB-</span>
    <span class="hljs-comment">// ip-address (global or local if used in one local network with server), login, password, USB-modem port, USB-modem channel</span>
    <span class="hljs-string">'SMS_gw1'</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">'ip'</span> =&gt; <span class="hljs-string">'XXX.XXX.X.X'</span>, <span class="hljs-string">'login'</span> =&gt; <span class="hljs-string">'#ROSAPI_LOGIN#'</span>, <span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">'#PASSWORD#'</span>, <span class="hljs-string">'port'</span> =&gt; <span class="hljs-string">'#USB_PORT#'</span>, <span class="hljs-string">'channel'</span> =&gt; <span class="hljs-string">'#USB_CHANNEL#'</span>)<font></font>
    );<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// -------------------------</span>
<span class="hljs-comment">//   </span>
<span class="hljs-comment">// INPUT DATA CHECK</span>
<span class="hljs-comment">// -------------------------</span>
<span class="hljs-keyword">if</span> (!$_REQUEST) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>); <span class="hljs-comment">//    –  | if request free - reset</span>
<span class="hljs-keyword">if</span> (!$_REQUEST[<span class="hljs-string">'ruid'</span>]) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>); <span class="hljs-comment">//    ruid -  | if ruid not isset – reset</span>
<span class="hljs-keyword">if</span> (!array_key_exists($_REQUEST[<span class="hljs-string">'ruid'</span>], $ruid_data)) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>); <span class="hljs-comment">//     –  | if router does not exist – reset</span>
<span class="hljs-keyword">if</span> ($_REQUEST[<span class="hljs-string">'auth'</span>]) autorize(); <span class="hljs-comment">//    ,        | if auth request allow without password</span>
<span class="hljs-keyword">if</span> (!ruid_auth()) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>); <span class="hljs-comment">//      SMS | check ruid password</span>
<span class="hljs-keyword">if</span> ($_REQUEST[<span class="hljs-string">'tel'</span>]) send_authcode(); <span class="hljs-comment">//    ,  SMS | if phone number isset – sending SMS</span><font></font>
<font></font>
<span class="hljs-comment">//          </span>
<span class="hljs-comment">// CHECK FOR ROUTER (ruid) IS IN ALLOWED LIST</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ruid_auth</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">global</span> $ruid_data;
  <span class="hljs-keyword">if</span> (!$_REQUEST[<span class="hljs-string">'pass'</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">//     –  | if password not set - reset</span>
  <span class="hljs-comment">//  md5-  | check password md5-hash</span>
  <span class="hljs-keyword">if</span> (md5($_REQUEST[<span class="hljs-string">'pass'</span>]) == $ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'mdpass'</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ---------------------------------------------------------</span>
<span class="hljs-comment">//        ROS API</span>
<span class="hljs-comment">// SEND AUTHERIZATION SMS VIA ROS API FUNCTION</span>
<span class="hljs-comment">// ---------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send_authcode</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">global</span> $ruid_data;
  <span class="hljs-keyword">global</span> $host;<font></font>
<font></font>
  <span class="hljs-comment">//    | Get random SMS-gateway</span>
  $sms_gw = $ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'smsgw'</span>][array_rand($ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'smsgw'</span>], <span class="hljs-number">1</span>)]; <span class="hljs-comment">//  sms-</span>
  <span class="hljs-comment">//         | Generate auth-code and add to REQUEST array</span>
  $_REQUEST[<span class="hljs-string">'authcode'</span>] = substr(str_shuffle(<span class="hljs-string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNPQRSTUVWXYZ123456789'</span>), <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
  <span class="hljs-comment">//   | connect class</span>
  $API = <span class="hljs-keyword">new</span> RouterosAPI();
  <span class="hljs-comment">//     –  eng  </span>
  <span class="hljs-comment">// Create message that will be sent to user</span>
  $message = <span class="hljs-string">'To autorize user '</span>.$_REQUEST[<span class="hljs-string">'tel'</span>].<span class="hljs-string">' connection open – '</span>.$host.<span class="hljs-string">'?ruid='</span>.$_REQUEST[<span class="hljs-string">'ruid'</span>].<span class="hljs-string">'&amp;auth='</span>.$auth_code;
  <span class="hljs-comment">//    SMS | if connected successfully - sending message</span>
  <span class="hljs-keyword">if</span> ($API-&gt;connect($SMS_gateway[$sms_gw][<span class="hljs-string">'ip'</span>], $SMS_gateway[$sms_gw][<span class="hljs-string">'login'</span>], $SMS_gateway[$sms_gw][<span class="hljs-string">'password'</span>])) {
      <span class="hljs-comment">//   SMS | SMS send command</span>
      $ARRAY = $API-&gt;comm(<span class="hljs-string">"/tool/sms/send"</span>, <span class="hljs-keyword">array</span>(
      <span class="hljs-string">"port"</span>=&gt;$SMS_gateway[$sms_gw][<span class="hljs-string">'port'</span>],
      <span class="hljs-string">"channel"</span>=&gt;$SMS_gateway[$sms_gw][<span class="hljs-string">'channel'</span>],
      <span class="hljs-string">"phone-number"</span>=&gt;$_REQUEST[<span class="hljs-string">'tel'</span>],
      <span class="hljs-string">"message"</span>=&gt;<span class="hljs-string">"To autorize user "</span>.$_REQUEST[<span class="hljs-string">'tel'</span>].<span class="hljs-string">" connection open – "</span>.$host.<span class="hljs-string">"?ruid="</span>.$_REQUEST[<span class="hljs-string">'ruid'</span>].<span class="hljs-string">"&amp;auth="</span>.$_REQUEST[<span class="hljs-string">'authcode'</span>],));
      <span class="hljs-comment">//        ,     usb   </span>
      <span class="hljs-comment">// Checking if send failed and error message return, will make usb power-reset to restart modem</span>
      <span class="hljs-keyword">if</span>($ARRAY[<span class="hljs-string">'!trap'</span>]) {<font></font>
        $API-&gt;comm(<span class="hljs-string">"/system/routerboard/usb/power-reset"</span>);
        <span class="hljs-comment">//   | save log</span>
        <span class="hljs-comment">//       | Add error to array and save all array to log</span>
        $_REQUEST[<span class="hljs-string">'ERROR'</span>] = $ARRAY[<span class="hljs-string">'!trap'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'message'</span>];<font></font>
        writelog(<span class="hljs-string">'MODEM ERROR'</span>);
        <span class="hljs-keyword">die</span>(<span class="hljs-string">'Stop with error: '</span>.$ARRAY[<span class="hljs-string">'!trap'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'message'</span>].<span class="hljs-string">' Making power reset of usb-port'</span>);}<font></font>
  }<font></font>
<font></font>
  $API-&gt;disconnect();<font></font>
  <span class="hljs-comment">//   | save log</span>
  writelog(<span class="hljs-string">'SEND AUTH CODE'</span>);
  <span class="hljs-keyword">die</span>($_REQUEST[<span class="hljs-string">'authcode'</span>]);<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// --------------------------------------------------------------------</span>
<span class="hljs-comment">//    ROS API –   ADDRESS-LIST</span>
<span class="hljs-comment">// AUTHERIZATION USING ROS API FUNCTION – DELETE LIST FROM ADDRESS-LIST</span>
<span class="hljs-comment">// --------------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">autorize</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">global</span> $ruid_data;
  <span class="hljs-comment">//   | connect class</span>
  $API = <span class="hljs-keyword">new</span> RouterosAPI();
  <span class="hljs-keyword">if</span> ($API-&gt;connect($ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'ip'</span>], $ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'login'</span>], $ruid_data[$_REQUEST[<span class="hljs-string">'ruid'</span>]][<span class="hljs-string">'password'</span>])) {
    <span class="hljs-comment">//     | if connected successfully - sending command</span>
    $API-&gt;write(<span class="hljs-string">'/ip/firewall/address-list/print'</span>, <span class="hljs-literal">false</span>);<font></font>
    $API-&gt;write(<span class="hljs-string">'?comment='</span>.$_REQUEST[<span class="hljs-string">'auth'</span>], <span class="hljs-literal">false</span>);<font></font>
    $API-&gt;write(<span class="hljs-string">'=.proplist=.id'</span>);
    <span class="hljs-comment">//   | get response</span><font></font>
    $ARRAYS = $API-&gt;read();<font></font>
    <span class="hljs-comment">//      - - </span>
    <span class="hljs-comment">// IF NO RECORD IN FIREWALL ADDRESS_LIST – RESET</span>
    <span class="hljs-keyword">if</span> (!$ARRAYS[<span class="hljs-number">0</span>]) <span class="hljs-keyword">die</span>(<span class="hljs-string">'Request error'</span>);
    <span class="hljs-comment">//   | delete firewall address-list</span>
    $API-&gt;write(<span class="hljs-string">'/ip/firewall/address-list/remove'</span>, <span class="hljs-literal">false</span>);<font></font>
    $API-&gt;write(<span class="hljs-string">'=.id='</span> . $ARRAYS[<span class="hljs-number">0</span>][<span class="hljs-string">'.id'</span>]);<font></font>
    $READ = $API-&gt;read();<font></font>
  }<font></font>
  $API-&gt;disconnect();<font></font>
  <span class="hljs-comment">//   | save log</span>
  writelog(<span class="hljs-string">'AUTHERIZATION'</span>);<font></font>
<font></font>
  <span class="hljs-comment">//     </span>
  <span class="hljs-comment">// SHOW SUCCESS PAGE TO USER</span>
  <span class="hljs-keyword">die</span>(<span class="hljs-string">'
      &lt;!DOCTYPE html&gt;
      &lt;html lang="ru"&gt;
      &lt;meta http-equiv="Content-Type" content="charset=utf-8" /&gt;
      &lt;body style="font-family: Verdana, Arial, Helvetica, sans-serif; background-color: #282c34; color: #fff; height: 100vh; display: flex;"&gt;
        &lt;div style="margin: auto; max-width: 50%;"&gt;
          &lt;p style="font-size: 24pt; font-weight: bold; margin: -300px 0 50px;"&gt;
            VPN-   ,   
          &lt;/p&gt;
          &lt;p style="font-size: 14pt; color: #aaa;"&gt;
                     &lt;br/&gt;
          &lt;/p&gt;
        &lt;/div&gt;
      &lt;/body&gt;
      &lt;/html&gt;
    '</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ------------------------</span>
<span class="hljs-comment">//   </span>
<span class="hljs-comment">// SAVE LOG FUNCTION</span>
<span class="hljs-comment">// ------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writelog</span>(<span class="hljs-params">$type</span>) </span>{
  <span class="hljs-keyword">global</span> $uselog;
  <span class="hljs-keyword">global</span> $log_path;
  <span class="hljs-comment">//  $uselog == false – </span>
  <span class="hljs-keyword">if</span> (!$uselog) <span class="hljs-keyword">return</span>;
  <span class="hljs-comment">//   | save log</span>
  $fp = fopen($log_path, <span class="hljs-string">'a'</span>);<font></font>
  fputs($fp, <span class="hljs-string">"\n\nDate = "</span> . date(<span class="hljs-string">"Y-m-d H:i:s"</span>).<span class="hljs-string">"\n"</span>);<font></font>
  fputs($fp, $type.<span class="hljs-string">"\n"</span>);<font></font>
  fputs($fp, print_r($_REQUEST, <span class="hljs-literal">true</span>));<font></font>
  fclose($fp);<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">?&gt;</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die im Code verwendete RouterOS-API-Klasse PHP kann </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf GitHub verwendet werden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank für Ihre Aufmerksamkeit. </font><font style="vertical-align: inherit;">Ich freue mich über Kommentare.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de506698/index.html">Requiem für "Sea Launch"</a></li>
<li><a href="../de506700/index.html">Wir konfigurieren GitHub-Aktionen für Android mit der anschließenden Bereitstellung in PlayMarket</a></li>
<li><a href="../de506702/index.html">Die zuverlässigsten Festplatten nach Backblaze Q1 2020</a></li>
<li><a href="../de506704/index.html">Warum 2020 in PHP schreiben? Holivarim ist diesen Donnerstag ein interaktiver Podcast auf Youtube</a></li>
<li><a href="../de506706/index.html">Die Leistung von modernem Java beim Arbeiten mit großen Datenmengen, Teil 1</a></li>
<li><a href="../de506710/index.html">Verwalten Sie mehrere Adressbücher in der Open-Source-Edition der Zimbra Collaboration Suite</a></li>
<li><a href="../de506716/index.html">Lineare Multithread-Liste: Elementexistenzproblem, Produktivitätsverbesserung und STL-Beziehung</a></li>
<li><a href="../de506726/index.html">Erfahrung in der Verwendung der Rutoken-Technologie zur Registrierung und Autorisierung von Benutzern im System (Teil 2)</a></li>
<li><a href="../de506730/index.html">Schnauben oder Suricata. Teil 1: Wählen Sie ein kostenloses IDS / IPS, um das Unternehmensnetzwerk zu schützen</a></li>
<li><a href="../de506732/index.html">Organisationsweite Wiederverwendung von UI-Komponenten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>