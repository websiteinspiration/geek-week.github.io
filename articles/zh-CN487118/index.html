<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍💼 👰🏽 💎 Loki-使用Prometheus方法收集日志 👨🏿‍🚒 🚫 🎇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="敬礼，哈布里沃派！期待着新的DevOps实践和工具课程的开始，我们已经为您准备了有趣的材料的翻译。
 
 
 
 
 本文是Loki的简要介绍。Loki项目由Grafana支持，旨在集中收集（从服务器或容器中）日志。
 
 Loki的主要灵感来源是普罗米修斯，他的想法是应用其日志管理方法：
 
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Loki-使用Prometheus方法收集日志</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/487118/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">敬礼，哈布里沃派！</font><font style="vertical-align: inherit;">期待着新的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DevOps实践和工具</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">课程的开始</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">，我们已经</font></a><font style="vertical-align: inherit;">为您准备了有趣的材料的翻译。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/rb/vv/kv/rbvvkvqoi8amlv_ndkojxwj283q.png"><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本文是Loki的简要介绍。</font><font style="vertical-align: inherit;">Loki项目</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由Grafana支持</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，旨在集中收集（从服务器或容器中）日志。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Loki的主要灵感来源是</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">普罗米修斯</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，他的想法是应用其日志管理方法：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用标签（标签）进行数据存储</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">资源消耗低</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将回到普罗米修斯的原则，并举例说明其在Kubernetes中的用法。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于普罗米修斯的几句话 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要完全了解Loki的工作原理，重要的是退后一步，回顾一下普罗米修斯。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometheus的显着特征之一是（通过导出器）从收集点中提取指标，并将其存储在TSDB（时间序列数据库，时间序列数据库）中，并以标签形式添加元数据。</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么有必要</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近，Prometheus已成为容器和Kubernetes领域的事实上的标准：它的安装非常简单，并且Kubernetes集群最初具有Prometheus的终结点。</font><font style="vertical-align: inherit;">Prometheus还可以从容器中部署的应用程序检索指标，同时保留某些标签。</font><font style="vertical-align: inherit;">因此，监视应用程序非常容易实现。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不幸的是，仍然没有用于管理日志的交钥匙解决方案，您必须为自己找到一个解决方案：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于集中日志的托管云服务（AWS，Azure或Google）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为服务监视服务（例如，Datadog）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建您自己的日志收集服务。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于第三个选项，我传统上使用Elasticsearch，尽管我并不总是对此感到满意（特别是它的严重性和设置的复杂性）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Loki旨在根据以下原则简化实施：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上手容易</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消耗很少的资源</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独立工作，无需任何特殊维护</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">补充Prometheus以帮助调查错误</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，通过一些折衷可以实现这种简单性。</font><font style="vertical-align: inherit;">其中之一是不索引内容。</font><font style="vertical-align: inherit;">因此，文本搜索不是非常有效或丰富，并且不允许统计文本内容。</font><font style="vertical-align: inherit;">但是由于Loki希望成为grep的一部分并补充Prometheus，所以这不是缺陷。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事故调查</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了更好地理解Loki为什么不需要索引，让我们回到Loki开发人员使用的事件调查方法：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9x/sp/rn/9xsprnklb6bomy1xmhkegiywwpw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 Alert→2仪表板→3 Adhoc查询→4 Log Aggregation→5 Distributed Tracing→6 Fix！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（1警告→2仪表板→3临时查询→4日志聚合→5分布式跟踪→6更正！）</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
这个想法是，我们会得到一些警报（Slack Notification，SMS等），然后：</font></font><br>
<br>
<ul>
<li>  Grafana</li>
<li>   (,  Prometheus)</li>
<li>   (,  Elasticsearch)</li>
<li>,     (Jaeger, Zipkin  .)</li>
<li>, ,   .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，对于Grafana + Prometheus + Elasticsearch + Zipkin堆栈，您将不得不使用四个不同的工具。</font><font style="vertical-align: inherit;">为了减少时间，最好使用一种工具执行所有这些步骤：Grafana。</font><font style="vertical-align: inherit;">值得注意的是，此研究方法自版本6起已在Grafana中实施。因此，可以直接从Grafana访问Prometheus数据。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r4/ur/bg/r4urbgqrnkgms5wiga5jvbvw4li.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Prometheus和Loki之间拆分的Explorer屏幕</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
在此屏幕上，您可以使用拆分屏幕概念查看与Prometheus指标相关的Loki日志。</font><font style="vertical-align: inherit;">从6.5版开始，Grafana允许您处理Loki日志条目中的跟踪ID，以跟踪指向您喜欢的分布式跟踪工具（Jaeger）的链接。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loki本地测试</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本地测试Loki的最简单方法是使用docker-compose。</font><font style="vertical-align: inherit;">docker-compose文件位于Loki存储库中。</font><font style="vertical-align: inherit;">您可以使用以下命令获取存储库</font></font><code>git</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="go hljs">$ git clone https:<span class="hljs-comment">//github.com/grafana/loki.git</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，您需要转到生产目录：</font></font><br>
<br>
<pre><code class="go hljs">$ cd production</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，您可以获得最新版本的Docker映像：</font></font><br>
<br>
<pre><code class="go hljs">$ docker-compose pull</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，使用以下命令启动Loki堆栈：</font></font><br>
<br>
<pre><code class="go hljs">$ docker-compose up</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">洛基建筑</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是Loki体系结构的小图：Loki体系结构的</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7z/-5/hd/7z-5hd6ycmdocdvzsrcmwjydsbs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原理</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Web客户端在服务器上启动应用程序，Promtail收集日志并将其发送给Loki，Web客户端还将元数据发送给Loki。</font><font style="vertical-align: inherit;">Loki将所有内容汇总并转移到Grafana。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Loki已启动并正在运行。</font><font style="vertical-align: inherit;">要查看可用的组件，请运行以下命令：</font></font><br>
<br>
<pre><code class="go hljs">$ docker ps</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于全新安装的Docker，该命令应返回以下结果：</font></font><br>
<br>
<pre><code class="go hljs">IMAGE               PORTS                  NAMES<font></font>
grafana/promtail:                          production_promtail_1<font></font>
grafana/grafana: m  <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">3000</span>-&gt;<span class="hljs-number">3000</span>/tcp production_grafana_1<font></font>
grafana/loki: late  <span class="hljs-number">80</span>/tcp,<span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">3100.</span>.. production_loki_1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们看到以下组件：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promtail：用于集中日志的代理</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana：著名的仪表盘工具 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loki：数据集中化守护进程</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在传统基础架构（例如，基于虚拟机）的框架内，必须在每台计算机上部署Promtail代理。</font><font style="vertical-align: inherit;">Grafana和Loki可以安装在同一台计算机上。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes部署</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Kubernetes上安装Loki组件的步骤如下：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">daemonSet用于在服务器群集中的每台计算机上部署Promtail代理</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部署Loki</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后是Grafana的部署。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸运的是，Loki是作为Helm软件包提供的，因此易于部署。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过头盔安装</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
头盔应已安装。</font><font style="vertical-align: inherit;">可以从项目的GitHub存储库下载。</font><font style="vertical-align: inherit;">通过解压缩与您的体系结构相匹配的档案并将其添加到Helm中，可以进行安装</font></font><code>$PATH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<blockquote><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Helm 3.0.0版是最近发布的。</font><font style="vertical-align: inherit;">由于其中有很多更改，建议读者稍等一会再使用</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></blockquote><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为头盔添加源</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一步是使用以下命令添加“ loki”存储库：</font></font><br>
<br>
<pre><code class="go hljs">$ helm add loki https:<span class="hljs-comment">//grafana.github.io/loki/charts</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，您可以搜索名为“ loki”的软件包：</font></font><br>
<br>
<pre><code class="go hljs">$ helm search loki</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果：</font></font><br>
<br>
<pre><code class="go hljs">loki/loki       <span class="hljs-number">0.17</span><span class="hljs-number">.2</span> v0<span class="hljs-number">.4</span><span class="hljs-number">.0</span> Loki: like Prometheus, but <span class="hljs-keyword">for</span> logs.<font></font>
loki/loki-stack <span class="hljs-number">0.19</span><span class="hljs-number">.1</span> v0<span class="hljs-number">.4</span><span class="hljs-number">.0</span> Loki: like Prometheus, but <span class="hljs-keyword">for</span> logs.<font></font>
loki/fluent-bit <span class="hljs-number">0.0</span><span class="hljs-number">.2</span>  v0<span class="hljs-number">.0</span><span class="hljs-number">.1</span> Uses fluent-bit Loki <span class="hljs-keyword">go</span> plugin <span class="hljs-keyword">for</span>...<font></font>
loki/promtail   <span class="hljs-number">0.13</span><span class="hljs-number">.1</span> v0<span class="hljs-number">.4</span><span class="hljs-number">.0</span> Responsible <span class="hljs-keyword">for</span> gathering logs and...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些软件包具有以下功能：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loki / loki</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">软件包</font><font style="vertical-align: inherit;">仅与Loki服务器匹配</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loki / fluent-bit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">软件包</font><font style="vertical-align: inherit;">允许您使用fluent-bin部署DaemonSet来收集日志而不是Promtail</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loki / promtail</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含收集代理日志文件</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loki / loki-stack</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">软件包</font><font style="vertical-align: inherit;">使您可以立即将Prokitail与Loki一起部署。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装Loki</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要将Loki部署到Kubernetes，请在“监视”名称空间中运行以下命令：</font></font><br>
<br>
<pre><code class="go hljs">$ helm upgrade --install loki loki/loki-stack --namespace monitoring</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要保存到磁盘，请添加选项 </font></font><code>--set loki.persistence.enabled = true:</code><br>
<br>
<pre><code class="go hljs">$ helm upgrade --install loki loki/loki-stack \<font></font>
              --namespace monitoring \<font></font>
              --set loki.persistence.enabled=<span class="hljs-literal">true</span></code></pre><br>
<blockquote><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果要同时部署Grafana，请添加参数</font></font><code>--set grafana.enabled = true</code></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行此命令时，应获得以下输出：</font></font><br>
<br>
<pre><code class="go hljs">LAST DEPLOYED: Tue Nov <span class="hljs-number">19</span> <span class="hljs-number">15</span>:<span class="hljs-number">56</span>:<span class="hljs-number">54</span> <span class="hljs-number">2019</span><font></font>
NAMESPACE: monitoring<font></font>
STATUS: DEPLOYED<font></font>
RESOURCES:<font></font>
==&gt; v1/ClusterRole<font></font>
NAME AGE<font></font>
loki-promtail-clusterrole <span class="hljs-number">189</span>d<font></font>
…<font></font>
NOTES:<font></font>
The Loki stack has been deployed to your cluster. Loki can now be added as a datasource in Grafana.<font></font>
See &lt;a href=<span class="hljs-string">"http://docs.grafana.org/features/datasources/loki/"</span>&gt;http:<span class="hljs-comment">//docs.grafana.org/features/datasources/loki/&lt;/a&gt; for more details.</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查看“监视”名称空间中的炉床状态，我们会看到一切都在扩展：</font></font><br>
<br>
<pre><code class="go hljs">$ kubectl -n monitoring get pods -l release=loki</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果：</font></font><br>
<br>
<pre><code class="go hljs">NAME                 READY  STATUS   RESTARTS  AGE<font></font>
loki<span class="hljs-number">-0</span>               <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">147</span>m<font></font>
loki-promtail<span class="hljs-number">-9</span>zjvc  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">3</span>h25m<font></font>
loki-promtail-f6brf  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">11</span>h<font></font>
loki-promtail-hdcj7  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">3</span>h23m<font></font>
loki-promtail-jbqhc  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">11</span>h<font></font>
loki-promtail-mj642  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">62</span>m<font></font>
loki-promtail-nm64g  <span class="hljs-number">1</span>/<span class="hljs-number">1</span>    Running  <span class="hljs-number">0</span>         <span class="hljs-number">24</span>m</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有Pod正在运行。</font><font style="vertical-align: inherit;">现在是时候做一些测试了！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">连接到Grafana </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要在Kubernetes下连接到Grafana，您需要在其底部打开一个隧道。</font><font style="vertical-align: inherit;">下面是打开Grafana壁炉的端口3000的命令：</font></font><br>
<br>
<pre><code class="go hljs">$ kubectl -n port-forward monitoring svc/loki-grafana <span class="hljs-number">3000</span>:<span class="hljs-number">80</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另一个重要点是需要恢复Grafana管理员密码。</font><font style="vertical-align: inherit;">密码</font><font style="vertical-align: inherit;">在base64格式</font></font><code>loki-grafana</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的字段</font></font><code>.data.admin-user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中</font><font style="vertical-align: inherit;">保密</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要还原它，必须运行以下命令：</font></font><br>
<br>
<pre><code class="go hljs">$ kubectl -n monitoring get secret loki-grafana \<font></font>
 --template <span class="hljs-string">'{{index .data "admin-password" | base64decode}}'</span>; echo</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用此密码和默认管理员帐户（admin）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Grafana中定义Loki数据源 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，请确保已创建Loki数据源（配置/数据源）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一个示例：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zu/0r/e6/zu0re6d6tzo5izslpttqpeaglz4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为Loki设置数据源</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的示例</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过单击“测试”，您可以检查与Loki的连接。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向Loki提出请求</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在转到Grafana的“探索”部分。</font><font style="vertical-align: inherit;">当从容器接收日志时，Loki会从Kubernetes添加元数据。</font><font style="vertical-align: inherit;">因此，可以查看特定容器的日志。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
：例如，以下查询提示用于选择容器日志</font></font><code>{container_name = "promtail"}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另外，请确保在此处选择您的Loki数据源。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该请求将返回容器的活动，如下所示：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hc/jh/0h/hcjh0htns_lqzhmwmtd01wa4-5k.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafana中的请求结果</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加到仪表板</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从Grafana 6.4开始，您可以将有关日志的信息直接放在仪表板上。</font><font style="vertical-align: inherit;">之后，用户将能够在其站点上的请求数量与应用程序跟踪之间快速切换。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下是实现此交互</font><i><font style="vertical-align: inherit;">的仪表板</font></i><font style="vertical-align: inherit;">的</font><i><font style="vertical-align: inherit;">示例</font></i><font style="vertical-align: inherit;">：</font><i><font style="vertical-align: inherit;">具有Prometheus指标和Loki日志的仪表板</font></i><font style="vertical-align: inherit;">的</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/xo/0w/acxo0wom7hyf0bfne2xtc2lyt6a.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">示例</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未来loki</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我从5月/ 6月开始使用Loki的0.1版本。今天，版本1已经发布，甚至是1.1和1.2。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
诚然，版本0.1不够稳定。但是0.3已经显示出真正的成熟迹象，下一个版本（0.4，然后是1.0）仅增强了这种印象。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在1.0.0之后，没有人可以没有任何借口不使用这个出色的工具。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
进一步的改进不应该与Loki有关，而应与出色的Grafana集成。实际上，Grafana 6.4已与仪表板很好地集成。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近发布的Grafana 6.5通过自动识别JSON格式的日志内容进一步改善了此集成。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下视频显示了此机制的一个小示例：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/de/hk/vi/dehkvinzf3xh6ed6yud7ptt4aye.gif"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Grafana中显示的Loki字符串</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
可以使用JSON字段之一，例如：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部工具链接</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过滤日志内容</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，您可以单击traceId转到Zipkin或Jaeger。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
传统上，我们一直在等待您的评论，我们邀请您参加</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个公开网络研讨会</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们将讨论2019年DevOps行业的发展情况，并讨论2020年的可能发展道路。</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN487106/index.html">PVS-Studio分析仪RunUO检查</a></li>
<li><a href="../zh-CN487108/index.html">手机游戏玩家资料：MyTracker研究</a></li>
<li><a href="../zh-CN487110/index.html">Slurm SRE。由Booking.com和Google.com的专家进行的完整实验</a></li>
<li><a href="../zh-CN487112/index.html">疯狂边缘：基本圈子</a></li>
<li><a href="../zh-CN487116/index.html">为什么Discord从Go变成Rust</a></li>
<li><a href="../zh-CN487120/index.html">如何散发小猫</a></li>
<li><a href="../zh-CN487122/index.html">Google JavaScript样式指南翻译</a></li>
<li><a href="../zh-CN487124/index.html">Borey Yangel采访了有关Yandex自驾和爱丽丝的创作故事</a></li>
<li><a href="../zh-CN487126/index.html">公司开发团队如何使用GitLab和Mattermost ChatOps加快开发速度</a></li>
<li><a href="../zh-CN487132/index.html">我们如何将数百人的分布式团队转移到SAAS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>