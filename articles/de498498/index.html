<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüöí üëéüèæ üöû Untersuchung: Was ist h√∂her als die Thread-Priorit√§ten in Windows? ‚ú® üçù üêÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Diese Untersuchung begann, wie viele andere, mit der Tatsache, dass ich mein eigenes Gesch√§ft machte und nicht versuchte, nach Problemen f√ºr mich selb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Untersuchung: Was ist h√∂her als die Thread-Priorit√§ten in Windows?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498498/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diese Untersuchung begann, wie viele andere, mit der Tatsache, dass ich mein eigenes Gesch√§ft machte und nicht versuchte, nach Problemen f√ºr mich selbst zu suchen. Dieses Mal habe ich nur den Deckel des Laptops ge√∂ffnet und versucht, mich beim System anzumelden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum ersten Mal, als dies zu einer Verz√∂gerung von zwanzig Sekunden f√ºhrte, ignorierte ich das Problem in der Hoffnung, dass es sich von selbst l√∂sen w√ºrde. Die n√§chsten Male habe ich √ºber die Untersuchung nachgedacht, aber Leistungsprobleme, die auftreten, noch bevor Sie sich angemeldet haben, sind schwieriger zu l√∂sen, und ich war faul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als ich bemerkte, dass ich das Schlie√üen des Laptops vermeiden wollte, weil ich Angst vor diesen zu h√§ufigen Verz√∂gerungen hatte, wurde mir klar, dass es Zeit war, dies ernsthaft zu tun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gl√ºcklicherweise habe ich k√ºrzlich den </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">UIforETW-</font></a><font style="vertical-align: inherit;"> Ringpuffer- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trace behoben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um es zuverl√§ssig zu machen, habe ich es gestartet und auf das n√§chste Verz√∂gerungsereignis gewartet. Ich musste nicht lange warten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mehrere Male </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gebraucht</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um die </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ETW-Spur</font></a><font style="vertical-align: inherit;"> f√ºr mich vollst√§ndig in Ordnung zu bringen </font><font style="vertical-align: inherit;">. Und da mir dieses Gebiet unbekannt war, dauerte es einige Zeit, um herauszufinden, was geschah. Ich habe das Problem immer noch nicht vollst√§ndig verstanden, aber 90% haben die Gr√ºnde f√ºr sein Auftreten verstanden. Ich habe viel gelernt, einschlie√ülich einiger neuer Details zum Windows-Scheduler, und ich habe auch eine absolut effektive L√∂sung gefunden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die ideale Ablaufverfolgung, die ich beim Laden in Microsoft Windows Performance Analyzer (WPA) aufgezeichnet habe, sieht folgenderma√üen aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/349/031/72d/34903172d4e4c5f85b33a02255942315.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standardereignisse, Fokusfenster und CPU-Auslastung.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Diese Tabelle und zwei Diagramme enthalten eine Menge Informationen. Die obere Tabelle ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Allgemeine Ereignisse</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) zeigt die aufgezeichneten Tastenanschl√§ge f√ºr UIforETW. Ich habe versucht, einmal pro Sekunde eine Taste (virtueller Schl√ºsselcode 162) zu dr√ºcken, bis ein Passworteingabefeld angezeigt wird. Da diese 17 Tastenanschl√§ge ausgew√§hlt sind, werden sie in der folgenden Grafik mit vertikalen blauen Linien angezeigt, um die Ausf√ºhrungszeit kritischer Ereignisse zu vereinfachen. Die x-Achse repr√§sentiert die Zeit in Sekunden.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die horizontalen Balken im oberen Diagramm ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fenster im Fokus</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) zeigen, welcher Prozess w√§hrend dieser Zeit fokussiert ist. </font><font style="vertical-align: inherit;">Insgesamt gibt es sechs verschiedene Prozesse. </font><font style="vertical-align: inherit;">Die </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√ºckverfolgungsperiode</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist die kurze Zeit, in der der Laptop geschlossen wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das untere Diagramm zeigt die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU-Auslastung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Informationen werden aus Kontextwechseldaten erhalten, daher m√ºssen sie vollst√§ndig genau und vollst√§ndig sein. </font><font style="vertical-align: inherit;">In dieser Ablaufverfolgung gibt ein Wert von 100% den Moment an, in dem alle acht logischen Prozessoren meines Vier-Kern-Acht-Thread-Notebooks verwendet wurden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich die Trace-Daten erhalten hatte, musste ich herausfinden, was mein Laptop heimlich tut, wenn die Abdeckung geschlossen ist und bis ich zum System zur√ºckkehre.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sturm vor der Flaute</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir sehen k√∂nnen, ist der Laptop am Anfang der Spur des Laptops relativ einfach, wie es sein sollte. Dann schloss ich den Deckel. Dies scheint zu einem Anstieg der CPU-Aktivit√§t und einer √Ñnderung des Fokus von Windows gef√ºhrt zu haben. </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Fenster im Fokus wurde</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> von UIforETW in Idle, dann in csrss, zur√ºck in Idle, in LogonUI und dann zur√ºck in Idle ge√§ndert. Wer h√§tte das gedacht?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
W√§hrend dieses Intervalls f√ºhrte der Laptop ungef√§hr 17 Sekunden CPU-Verarbeitung verschiedener Typen durch. Ein Teil davon ist die Arbeit, die zum Abschalten ben√∂tigt wird. Teil - Dies sind Programme (einschlie√ülich interner Google-Tools), die im Taskplaner f√ºr die Ausf√ºhrung von "Wenn ein Benutzer eine Workstation sperrt" registriert sind. Dies ist sinnvoll. Mir ist sogar aufgefallen, dass daran gearbeitet wird, UI-Elemente f√ºr die Anmeldung zu erstellen, wenn der Benutzer weiter arbeitet - Sie m√ºssen im Voraus vorbereitet sein, oder?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
17 Sekunden CPU - ziemlich lange, bis der Laptop in den Ruhezustand wechselt. </font><font style="vertical-align: inherit;">Selbst auf meinem Laptop mit vier Kernen und acht Threads dauert der Vorgang mehr als vier Sekunden. </font><font style="vertical-align: inherit;">Auf meinem Heim-Laptop dauert es mehr als 13 Sekunden CPU-Zeit, um einzuschlafen, und fast alle gehen zu Windows-Code. </font><font style="vertical-align: inherit;">Muss der </font><font style="vertical-align: inherit;">Diagnoserichtliniendienst </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wirklich</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einige SruDbTableSearches ausf√ºhren, bevor der Laptop ruhen kann? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich denke, diese √ºberm√§√üige Arbeit beim Schlafengehen ist </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auch ein</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem, aber das ist nicht </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">genau das</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem, das ich suche. </font><font style="vertical-align: inherit;">Also habe ich beschlossen, ihr den R√ºcken zu kehren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und erst viel sp√§ter wurde mir klar, dass in dieser Zeit die K√∂rner der Zerst√∂rung meines K√§fers geworfen wurden ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlaf</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem Blockieren des Laptops erfolgt keine CPU-Aktivit√§t. </font><font style="vertical-align: inherit;">In diesem speziellen Test wurde der Laptop f√ºr ungef√§hr 16 Sekunden gesperrt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Krampfhaftes Erwachen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Aktivit√§t der CPU beim √úbergang in den Ruhezustand ist nicht mit der Aktivit√§t zu vergleichen, als sie zu erwachen begann. </font><font style="vertical-align: inherit;">W√§hrend dieser Zeit ben√∂tigte mein √ºberlasteter Laptop 22,6 Sekunden lang ungef√§hr 172 Sekunden CPU-Zeit (!!!). </font><font style="vertical-align: inherit;">Das ist viel Arbeit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eines der R√§tsel dieses Prozesses ist, dass die CPU-Auslastung etwa eine Sekunde nach dem ersten Aktivit√§tsausbruch auf nahezu Null sinkt. </font><font style="vertical-align: inherit;">Diese kurze Ausfallzeit erscheint angesichts des Chaos eher ungew√∂hnlich. </font><font style="vertical-align: inherit;">Aber ich denke, dass diese Funktion nicht mit dem Problem zusammenh√§ngt, deshalb habe ich nicht darauf geachtet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiteres R√§tsel ist, warum </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">so viele</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programme werden nach dieser kurzen Pause zum Leben erweckt. Es ist lustig, dass der schwerwiegendste Eindringling, der f√ºr 31,6 von 172 Sekunden der CPU verantwortlich war, Windows Performance Analyzer (WPA) war - genau das Programm, mit dem ich Spuren analysiere. Die drei Kopien, die ich noch laufen lie√ü, arbeiten hart daran, meine Benutzeroberfl√§che zu rendern, obwohl sie noch nicht sichtbar ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au√üerdem treten beim Initialisieren von Laptop-Ger√§ten dunkle Muster auf. KeStallExecutionProcessor ist eine Warteschleife, und es war seltsam zu sehen, dass dies die ausf√ºhrbarste Funktion des gesamten Systems ist. Ist ein zweiter ungerader Wartezyklus der einzige Weg, um die Ausr√ºstung zu starten? </font><font style="vertical-align: inherit;">Ist es </font><font style="vertical-align: inherit;">wirklich notwendig, 700 ms CPU-Zeit f√ºr die Initialisierung von </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maus und Tastatur aufzuwenden</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? Sollten Microsoft und Intel die Empfehlung von Microsoft ignorieren?</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maximal 50 Mikrosekunden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa7/c4e/cf4/fa7c4ecf4fe56c7c9014ee252f4557b0.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treiber eines Wartezyklus. </font><font style="vertical-align: inherit;">i8042prt.sys wurde von Microsoft geschrieben. </font><font style="vertical-align: inherit;">Die folgenden beiden wurden von Intel erstellt. </font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Letztendlich laufen in dieser Zeit </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viele</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Programme </font><font style="vertical-align: inherit;">aktiv </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Die meisten von ihnen scheinen mit dem gleichen Problem wie WPA konfrontiert zu sein - sie m√∂chten unbedingt Pixel auf einem versteckten Bildschirm zeichnen, was auf einen Windows-Fehler hinweist. </font><font style="vertical-align: inherit;">Aber auch ohne diesen Fehler suchen explorer.exe und andere Programme aktiv nach </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etwas</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu tun. </font><font style="vertical-align: inherit;">Obwohl diese √ºberm√§√üige CPU-Auslastung ein notwendiger </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil des</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problems ist, ist sie </font><font style="vertical-align: inherit;">letztendlich </font><font style="vertical-align: inherit;">nicht </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">das eigentliche</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Problem. </font><font style="vertical-align: inherit;">Also h√∂rte ich wieder auf, auf sie zu achten.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fokus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der Analyse von Spuren ist es wichtig herauszufinden, wann wichtige Aktionen ausgef√ºhrt werden. Der Hauptbeweis waren Eingabeereignisse, da ich auf das Steuerelement geklickt habe, nachdem das Kennworteingabeformular angezeigt wurde. Hier sind die letzten drei Tastenanschl√§ge der Steuertaste in ungef√§hrer Form im </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fenster "Fenster im Fokus</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/158/50d/6f9/15850d6f9eecb243c2984cd4988c6bb1.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass die kritischen Ereignisse den Fokus von LockApp.exe erhalten, wonach der Fokus fast sofort LogonUI.exe erh√§lt. </font><font style="vertical-align: inherit;">Vermutlich habe ich das Passwort in LogonUI.exe eingegeben (es ist praktisch, dass der Trace keine Tastaturereignisse abfing), wonach der Fokus kurz auf Explorer und dann auf UIforETW umgeschaltet wurde, von dem aus ich gestartet bin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sieht auch so aus, als ob LogonUI.exe vor LockApp.exe nicht fokussiert werden kann - dieses Muster wiederholt sich in allen von mir untersuchten Spuren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach mehr als tausend Worten zur L√∂sung dieses R√§tsels haben wir endlich eine klare Frage, die wir untersuchen k√∂nnen: Warum wird LockApp.exe nach Beendigung der Ausfallzeit fokussiert, es dauert zwanzig Sekunden?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben eine Frage? </font><font style="vertical-align: inherit;">Gro√üartig, lass es uns beantworten</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unter </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwendung von</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Daten zur </font><em><font style="vertical-align: inherit;">CPU-Auslastung (Pr√§zision)</font></em><font style="vertical-align: inherit;"> , die beim Wechseln von Inhalten erhalten wurden, stellte </font><font style="vertical-align: inherit;">ich schnell fest, dass LockApp.exe innerhalb von 20 Sekunden nach dem Aufwecken weniger als eine Millisekunde CPU-Zeit erhielt und l√§nger als 14 Sekunden (von 35,158 s bis 49,827 s) nicht funktionierte allgemein:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f50/5dc/954/f505dc954915bdbf5a857eac5c4303f4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LockApp funktioniert lange Zeit √ºberhaupt nicht</font></font></i><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Dokumentation zur Bedeutung der Spalten in den Tabellen zur CPU-Auslastung (Pr√§zise) finden Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ein Prozess oder Thread seit einiger Zeit nicht mehr ausgef√ºhrt wird und Sie herausfinden m√∂chten, warum, finden Sie in der Regel wichtige Hinweise beim ersten Kontextwechsel nach einer langen Pause, n√§mlich beim Umschalten auf 49,827 Sekunden Ablaufverfolgung. </font><font style="vertical-align: inherit;">Ich habe die Spalten neu angeordnet, um mehr Daten von diesem Kontextwechsel anzuzeigen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7f4/23d/7ca/7f423d7cad82b87f4c5556551b0e8fec.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LockApp wird vorbereitet, aber nicht ausgef√ºhrt. Seltsam ...</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Anzahl gleich 1 bedeutet, dass wir die Daten f√ºr einen einzelnen Kontextwechsel betrachten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Time Since Last (38,2 Millionen Mikrosekunden) bedeutet, dass dieser Thread nicht innerhalb von 38,2 Sekunden ausgef√ºhrt wird. Das an sich ist weder gut noch schlecht. Leerlaufstr√∂me sparen Energie, und am Ende war der Laptop f√ºr einige Zeit in einem Traum. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Einschaltzeit sagt uns einfach, wann genau der Thread in die CPU passt - wann der Kontext zu diesem Thread wechselt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und jetzt gehen wir zur Spalte Bereit. Er sagt uns, wie lange der Thread </font><font style="vertical-align: inherit;">zur Ausf√ºhrung </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bereit war</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber nicht ausgef√ºhrt wurde. Mit anderen Worten, dieser Thread hat </font><font style="vertical-align: inherit;">auf </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etwas</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gewartet (Schloss, Griff) und das </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist etwas</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wurde freigegeben oder initiiert, aber der Thread wurde </font><font style="vertical-align: inherit;">19.493 Sekunden lang </font><font style="vertical-align: inherit;">immer </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noch nicht ausgef√ºhrt</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Spalte </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bereit (uns)</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> besser zu verstehen </font><font style="vertical-align: inherit;">, k√∂nnen Sie sich die </font><font style="vertical-align: inherit;">Spalte </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bereitschaftszeit (en)</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ansehen </font><font style="vertical-align: inherit;">. Er sagt uns, wann der Stream vorbereitet ist. Wir sehen, dass dieser Thread f√ºr 30,333 Sekunden Ablaufverfolgung f√ºr die Ausf√ºhrung vorbereitet wurde, aber erst 49,827 Sekunden ausgef√ºhrt wurde. Dies scheint wichtig zu sein. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Anordnung der Spalten zeigt uns ansonsten den gleichen Kontextwechsel:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/07f/b5c/c85/07fb5cc85d3dfc066a6c3cbd508ef7d7.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neuer Thread-Stapel und fertiger Thread-Stapel</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dieser Thread (von dem der neue Thread-Stapel NtWaitForWorkViaWorkerFactory erwartete) musste kurz nach dem √ñffnen des Notebook-Deckels f√ºr 30,333 Sekunden nachverfolgt werden (der Systemprozess, der KeSetEvent aufruft). </font><font style="vertical-align: inherit;">Aber es begann nicht dann (was "gut" w√§re), sondern nach 19.494 s, und das ist schlecht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ich eine solche Analyse der Erwartungen durchf√ºhre, verbringe ich normalerweise viel Zeit damit, herauszufinden, warum der Stream wartet und warum er nicht bereit ist. </font><font style="vertical-align: inherit;">Dies war jedoch das erste Mal, dass ich eine Analyse der Erwartungen durchf√ºhrte, bei der dies nicht wichtig war, und die Frage war, warum dieser vorgefertigte Thread nicht ausgef√ºhrt wird.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√§lle ...</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die meisten Menschen verbringen nicht so viel Zeit damit, ETW-Spuren zu studieren, daher ist hier eine Erkl√§rung erforderlich. </font><font style="vertical-align: inherit;">Das ist </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sehr</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seltsam. </font><font style="vertical-align: inherit;">Wenn der Thread fertig ist, startet er normalerweise sofort oder nach einigen Millisekunden. </font><font style="vertical-align: inherit;">Die Bereitschaft des Streams bedeutet, </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wie der Name schon sagt</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dass der Stream zur Ausf√ºhrung bereit ist und fast nichts ihn st√∂ren kann. </font><font style="vertical-align: inherit;">Aber lassen Sie uns herausfinden, was die Ausf√ºhrung eines fertigen Threads verhindern kann.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thread-Priorit√§t</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst schlug ich vor, dass dies ein einfacher Fall von CPU-Hunger ist. Dutzende von Prozessen erfordern CPU-Zeit, und aus diesem Grund erh√§lt LockApp erst dann die richtige, wenn die Last abnimmt. Diese Theorie </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entspricht jedoch nicht ganz</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> den Symptomen, da der LockApp-Prozess </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auch</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ohne CPU-Zeit </font><font style="vertical-align: inherit;">etwa 18 Sekunden dauern </font><font style="vertical-align: inherit;">kann.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die CPU-Hungertheorie ist gut, weil sie √ºberpr√ºfbar ist. Es ist mir gelungen, die Priorit√§t des LockApp-Prozesses mithilfe des Task-Managers zu erh√∂hen (w√§hrend einer der kurzen Zeitr√§ume, in denen er nicht vom UWP-System angehalten wurde). Daher wurde LockApp in der letzten Ablaufverfolgung, die ich f√ºr diesen Beitrag verwendet habe, mit hoher Priorit√§t ausgef√ºhrt. Ein normaler Windows-Thread wird mit einer Priorit√§t von ca. 8-10 ausgef√ºhrt. Die h√∂chste Priorit√§t, mit der ein regul√§rer Windows-Thread (nicht in Echtzeit) ausgef√ºhrt werden kann, ist 15. Meine ETW-Traces zeigten, dass LockApp immer mit Priorit√§t 13 oder h√∂her arbeitete. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist eine CPU-Zeitleiste f√ºr kritische 19,494 Sekunden, gruppiert und gef√§rbt nach Priorit√§t des Threads ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New In Pri</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die aktuelle Priorit√§t, die dem Thread zugewiesen wurde). </font><font style="vertical-align: inherit;">Wir sehen, dass Threads mit den Priorit√§ten 4, 8, 9 und 10 den gr√∂√üten Teil der CPU-Zeit beanspruchen, insbesondere am Ende:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/81b/7d5/431/81b7d5431d0a307a93d2250fec9f2b1c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden der CPU nach Priorit√§t</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hier ist ein weiteres Bild mit ausgeblendeten Threads mit den Priorit√§ten 0-12. </font><font style="vertical-align: inherit;">Jedes Mal, wenn das Diagramm unter 12,5% f√§llt (was einen logischen Prozessor der CPU-Zeit meines Acht-Thread-Notebooks bedeutet), </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muss</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LockApp </font><font style="vertical-align: inherit;">gestartet werden, und es wird absolut unglaublich, dass die Priorit√§t verhindert, dass es so oft ausgef√ºhrt wird, wenn viele Threads mit niedrigerer oder gleicher Priorit√§t ausgef√ºhrt werden Holen Sie sich eine Menge Zeit.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ec/c2c/66b/2ecc2c66b4df4902a3c5be388596524f.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU-Auslastung mit Priorit√§t, nur Threads mit hoher Priorit√§t</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beseitigen Sie die Priorit√§tsinversion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wird spekuliert, dass Windows-Priorit√§tsinversionsalgorithmen anderen Threads so f√∂rderlich sind, dass LockApp.exe blockiert wird. </font><font style="vertical-align: inherit;">Da die oben gezeigten Grafiken jedoch zeigen, dass bei Planungsentscheidungen echte Priorit√§ten verwendet werden, muss diese (immer nicht √ºberzeugende) Annahme aufgegeben werden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entladen des Stapelkerns</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als ich auf Twitter √ºber dieses R√§tsel sprach, schlug einer der Kommentatoren vor, dass </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Thread-Core-Stack entladen wurde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ich war mit dieser Situation nicht vertraut, aber nach </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">John Werths</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erkl√§rungen </font><font style="vertical-align: inherit;">(er versteht auf seinem Gebiet) habe ich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">das Austauschen des Kernel-Stacks ausgeschaltet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und den Computer neu gestartet. </font><font style="vertical-align: inherit;">Nichts hat sich ge√§ndert. </font><font style="vertical-align: inherit;">Tats√§chlich dachte ich nicht, dass dies helfen w√ºrde, da ich 32 GB Speicher habe und das Problem wiederholt und h√§ufig auftritt. </font><font style="vertical-align: inherit;">aber es war besser, sich dessen sicher zu sein.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prozess anhalten</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da LockApp eine moderne UWP-Anwendung ist, unterliegt sie √§hnlichen Einschr√§nkungen wie Smartphone-Apps. Dies bedeutet unter anderem, dass es angehalten werden kann, wenn es nicht im Vordergrund steht, und dann ‚Äûwieder eingefroren‚Äú werden kann, wenn es wieder in den Vordergrund zur√ºckkehrt. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">James Forshaw</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> schlug vor </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Microsoft-Windows-Kernel-Process ETW aufzuzeichnen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um Daten dazu zu erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ereignisse sollen maximale Verwirrung stiften. Der Name der Aufgabe " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prozess</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> einfrieren" </font><em><font style="vertical-align: inherit;">wird</font></em><font style="vertical-align: inherit;"> sowohl f√ºr "Auftauen" als auch f√ºr "Einfrieren" verwendet. Die Version des Ereignisses " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">win: Stop"</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bedeutet, dass der Prozess </font><em><font style="vertical-align: inherit;">gestartet</font></em><font style="vertical-align: inherit;"> wird (er hat das Einfrieren gestoppt), und die Version von " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">win: Start"</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bedeutet, dass der Prozess stoppt (beginnt einzufrieren). All dies ist √§u√üerst logisch, aber sehr verwirrend. Wenn die Ereignisnamen in Einfrieren und Auftauen unterteilt w√§ren, w√ºrde es weniger Verwirrung geben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt keine Dokumentation f√ºr diese Ereignisse, aber dank der Analyse habe ich festgestellt, dass diese Ereignisse immer vom </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hintergrundaufgaben- / Broker-Infrastrukturdienst erstellt werden</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Der Name und die Prozess-ID des entsprechenden Prozesses werden im Feld FrozenProcessID angegeben.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e04/32f/424/e0432f42442fa30ad0f7e6ed77f8d1c2.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProcessFreeze-Ereignisse (auch zum Abtauen verwendet) Es</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
war interessant, diesen Anbieter zu untersuchen - er hat viele vielversprechende Ereignisse -, aber am Ende stellte sich heraus, dass LockApp w√§hrend der Ablaufverfolgung nicht pausierte oder abtaute. </font><font style="vertical-align: inherit;">Dieser Anbieter schien jedoch sehr n√ºtzlich zu sein, daher habe ich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UIforETW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> so </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ge√§ndert</font></a><font style="vertical-align: inherit;"> , dass zuk√ºnftige Versionen ihn immer aufschrieben.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben bereits alles ausgeschlossen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keine der oben beschriebenen Theorien schien mir sehr wahrscheinlich, und jetzt haben wir sie alle ausgeschlossen. </font><font style="vertical-align: inherit;">Ich begann nach Hilfe zu suchen und bat mich, mir Ideen von einem Microsoft-Freund zu geben. </font><font style="vertical-align: inherit;">In diesem Moment stellte ich fest, dass die in Windows so bekannte Flusspriorit√§t 0-31 nur f√ºnf Bits mit niedriger Priorit√§t eines </font><font style="vertical-align: inherit;">Systems mit </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voller</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Priorit√§t sind.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwendung der offiziellen Position</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellte sich heraus, dass meine Unwissenheit meine eigene Schuld war. </font><font style="vertical-align: inherit;">Wenn ich alle 108 Seiten des Abschnitts " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Threads</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">von </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Internals, 7. Ausgabe, Teil 1</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">sorgf√§ltig lesen </font><font style="vertical-align: inherit;">w√ºrde, w√ºrde ich verstehen, was passiert. </font><font style="vertical-align: inherit;">Wenn Sie weiterspringen m√∂chten, finden Sie dieses Thema auf den Seiten </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">287 bis 295</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Feld mit hoher Priorit√§t, von dem ich nichts wusste, hei√üt </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rang</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es wird in WPA als versteckte Standardspalte (um es zu finden, m√ºssen Sie den </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansichtseditor</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √∂ffnen) mit dem Namen </font><em><font style="vertical-align: inherit;">NewThreadRank angezeigt</font></em><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Bei der Planung von Threads hat der Thread-Rang Vorrang vor der Priorit√§t. </font><font style="vertical-align: inherit;">Fast alle Streams haben Rang 0, und ein Stream mit Rang 0 hat immer eine h√∂here Priorit√§t als ein Stream mit Rang 2. Durch Einf√ºgen einer Spalte</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NewThreadRank</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font><em><font style="vertical-align: inherit;">wenn</font></em><font style="vertical-align: inherit;"> wir auf die linke Seite der Tabelle schauen, k√∂nnen wir das Problem sofort erkennen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/374/745/f0e/374745f0eeaee797c6a8472f62d5b3f4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Rang ist wichtiger als die Priorit√§t</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
. LockApp.exe-Streams haben Rang 2, was bedeutet, dass sie trotz Priorit√§t 14 die niedrigste Priorit√§t im System haben.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine fast vollst√§ndige Erkl√§rung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da sich herausstellte, dass LockApp.exe-Threads Rang 2 haben, k√∂nnen sie nur ausgef√ºhrt werden, wenn </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keiner</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der Threads mit Rang 0 ausgef√ºhrt werden soll. </font><font style="vertical-align: inherit;">Da viele Anwendungen (aus unbekannten Gr√ºnden) ihre unsichtbaren Bildschirme aktiv rendern, k√§mpfen sie um jede Menge CPU-Zeit und lassen nichts f√ºr h√∂here R√§nge √ºbrig. </font><font style="vertical-align: inherit;">Sobald LockApp.exe einen winzigen Bruchteil der CPU-Zeit erh√§lt, wechselt es schnell auf Rang 0 (und die CPU-Last sinkt). Danach wird der Anmeldevorgang auf die √ºbliche Weise ausgef√ºhrt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich diese Informationen erfahren hatte, begann ich zu untersuchen, wie sich der Rang von LockApp im Laufe der Zeit √§ndert. In den letzten Sekunden wechselte LockApp pl√∂tzlich von Rang 0 auf Rang 2, bevor es in den Ruhezustand ging. Der Rang soll verhindern, dass die CPU zu viel Zeit in Anspruch nimmt, z. B. wenn </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows Photos zu sehr auf unerw√ºnschte Hintergrundverarbeitung bedacht ist</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und den √úbergang vornimmt von Rang 2 bis 19:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cbc/b93/e8b/cbcb93e8bc2145f78e5ea10edba3fa8e.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft.Photos geht den Rang runter</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aus der Dokumentation geht hervor, dass der Hauptzweck des Stream-Ranges die gerechte Aufteilung der CPU-Zeit zwischen Sitzungen auf dem Computer ist, damit die Prozesse eines Benutzers anderen nicht schaden. Beide Optionen f√ºr die Verwendung des Rangs machen deutlich, dass der Rang des Streams nur erh√∂ht werden sollte, wenn viel CPU-Zeit verbraucht wird. Wenn der Laptop in den Ruhezustand versetzt wurde, verwendete LockApp.exe nur 79,3 ms CPU-Zeit und der Rest des Systems - 17 von der CPU-Zeit . Trotzdem hat das Betriebssystem aus irgendeinem Grund beschlossen, LockApp im Ruhezustand auf 2 herunterzustufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Betriebssystem √§ndert den Rang des Streams nur, wenn er zur ‚ÄûPlanungsgruppe‚Äú ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KSCHEDULING_GROUP) geh√∂rt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) und die meisten Threads in einer typischen Windows-Installation sind keine Mitglieder. </font><font style="vertical-align: inherit;">Folglich unterliegen die meisten Threads keiner Rang√§nderung, sodass sie die CPU-Zeit so verbringen k√∂nnen, wie sie m√∂chten.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbleibende R√§tsel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider ist immer noch unklar, warum LockApp.exe vor dem Einschalten des Ruhezustands auf Rang 2 f√§llt. Ich gehe davon aus, dass LockApp in der Planungsgruppe ist und sich wahrscheinlich einer der Algorithmen falsch verh√§lt. Aber ich konnte keine API finden, um dies zu untersuchen, und die Zeit lief davon. Wenn Sie Details kennen, schreiben Sie in die Kommentare zum Originalartikel. Das Prinzip, Rang als wichtigste Komponente bei Planungsentscheidungen zu verwenden, sollte meines Erachtens unvermeidlich zusammenbrechen, wenn die meisten Prozesse im System nicht daran beteiligt sind - Threads in Planungsgruppen laufen immer Gefahr, ohne die erforderlichen Ressourcen zu bleiben. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamic Resource Allocation Planning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DFSS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ist zum Scheitern verurteilt, wenn die meisten Threads nicht beteiligt sind.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich wei√ü auch nicht, warum so viele Anwendungen nach dem Schlafengehen aktiv bleiben. Dies wird normalerweise durch die Tatsache erkl√§rt, dass ‚Äûviele Timer enden, wenn sich der Laptop mehrere Stunden im Ruhemodus befindet‚Äú. Diese Erkl√§rung ist jedoch nicht geeignet, wenn der Laptop nur einige Sekunden im Traum war und das WPA-Rendering-Verhalten anzeigt, dass im Fenstersystem etwas passiert etwas stimmt nicht. F√ºgen Sie dazu Anwendungen mit schlechtem Verhalten und Wartezyklus-Treiber hinzu, und alles wird im Laufe der Zeit von der CPU gestapelt.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Tatsache, dass CPU-St√ºrme nachlassen und LockApp gleichzeitig gestartet wird, f√ºhrt zu einer offensichtlichen Erkl√§rung: LockApp kann nur funktionieren, wenn die CPU-Nachfrage sinkt. </font><font style="vertical-align: inherit;">Es gibt jedoch eine ebenso √ºberzeugende Erkl√§rung: Sobald LockApp die F√§higkeit zum Ausf√ºhren erh√§lt (oder m√∂glicherweise von LogonUI), sinkt die CPU-Nachfrage. </font><font style="vertical-align: inherit;">Beide Erkl√§rungen funktionieren, aber ich denke, die zweite ist plausibler, weil wir sonst nicht erkl√§ren k√∂nnen, warum das scheinbar endlose Rendern von WPA pl√∂tzlich aufh√∂rt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√∂sung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobald ich feststellte, dass LockApp.exe eine separate Anwendung ist, die Probleme beim Starten hat und das Erh√∂hen der Priorit√§t nicht hilft, habe ich sie deaktiviert. </font><font style="vertical-align: inherit;">Die Datei DisableLockScreen.reg hat mir dabei geholfen:</font></font><br>
<br>
<blockquote>Windows Registry Editor Version 5.00<br>
[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Personalization]<br>
‚ÄúNoLockScreen‚Äù=dword:00000001</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durch Ausschalten des Sperrbildschirms wird der Laptop sofort nach dem √ñffnen der Abdeckung aktiviert. </font><font style="vertical-align: inherit;">Ich habe weder Bremsen noch St√ºrme der CPU bemerkt, und jetzt dauert es einen Schritt weniger, um einzutreten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erste Twitter-Beitrag, den</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ich gepostet habe, als ich zum ersten Mal auf das Problem gesto√üen bin, enth√§lt eine Zeitleiste f√ºr eine Untersuchung, die f√ºr jemanden n√ºtzlich sein kann. </font><font style="vertical-align: inherit;">Au√üerdem kamen dank ihnen viele kluge Leute von Twitter zu dem Beitrag. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als ich zu dem Artikel zur√ºckkehrte, stellte ich fest, dass das Problem nach dem erneuten Einschalten des Sperrbildschirms verschwand. </font><font style="vertical-align: inherit;">Ein einfacher Neustart hat das Problem nicht behoben. Im Februar habe ich viele Male neu gestartet, aber wir wissen wahrscheinlich nicht, warum es verloren gegangen ist.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diskussionen</font></font></h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r / Programmierung</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r / Windows10</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hacker-News</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de498486/index.html">So erweitern Sie die englischsprachige Semantik f√ºr Suchmaschinenwerbung in einer engen Nische</a></li>
<li><a href="../de498490/index.html">Ein effektives Zertifizierungssystem, mit dem Sie ein besserer Marktf√ºhrer werden k√∂nnen</a></li>
<li><a href="../de498492/index.html">Schatz, wir t√∂ten B√ºrokratie: Wie die Digitalisierung den Dialog zwischen Lieferanten und X5 ver√§ndert</a></li>
<li><a href="../de498494/index.html">JEP 360: Versiegelte Typen (Vorschau)</a></li>
<li><a href="../de498496/index.html">Ank√ºndigung des Online-Mitap PiterJS # 46: Leistung, komplexe UI-Komponenten und CSS-in-TS</a></li>
<li><a href="../de498500/index.html">Was gibt es in Quarant√§ne zu sehen? Eine Auswahl von Materialien aus Technostream (Teil 1)</a></li>
<li><a href="../de498504/index.html">Neujahrsgr√º√üe und COVID-19: Wie Hacker die Nachrichten nutzen</a></li>
<li><a href="../de498510/index.html">X. X. Eine √úbersicht √ºber die Box-Version von Telefonie und Verbindung zu einem Remote-Standort</a></li>
<li><a href="../de498512/index.html">Staus in einer kleinen Stadt f√ºr ein kleines Budget bek√§mpfen: Ergebnisse von 6 Monaten des Projekts</a></li>
<li><a href="../de498516/index.html">Postbote - AutoMetrica-Metriken in AppMetrica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>