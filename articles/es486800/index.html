<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÜ üìú üö° Cassandra C√≥mo no morir si solo conoces a Oracle üë©üèø‚Äçüé§ üë®‚Äçüé® üëãüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr 
 
 Mi nombre es Misha Butrimov, me gustar√≠a hablar un poco sobre Cassandra. Mi historia ser√° √∫til para aquellos que nunca se han encontrado...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cassandra C√≥mo no morir si solo conoces a Oracle</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qiwi/blog/486800/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mi nombre es Misha Butrimov, me gustar√≠a hablar un poco sobre Cassandra. Mi historia ser√° √∫til para aquellos que nunca se han encontrado con las bases de datos NoSQL: tiene muchas caracter√≠sticas de implementaci√≥n y dificultades que debes conocer. Y si, aparte de Oracle o cualquier otra base relacional, no has visto nada, estas cosas te salvar√°n la vida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© tiene de bueno Cassandra? Esta es una base de datos NoSQL dise√±ada sin un solo punto de falla, que se adapta bien. Si necesita agregar un par de terabytes para cualquier base, simplemente agregue nodos al anillo. ¬øExtenderlo a otro centro de datos? Agregar nodos al cl√∫ster. Aumentar RPS procesados? Agregar nodos al cl√∫ster. La otra forma tambi√©n funciona.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/4s/4m/jn/4s4mjnltsraqofl5-ey4g2fi9t0.png" width="700"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øEn qu√© m√°s es buena? </font><font style="vertical-align: inherit;">Es para manejar muchas solicitudes. </font><font style="vertical-align: inherit;">¬øPero cu√°nto es cu√°nto? </font><font style="vertical-align: inherit;">10, 20, 30, 40 mil solicitudes por segundo: esto no es mucho. </font><font style="vertical-align: inherit;">100 mil solicitudes por segundo para grabaci√≥n, tambi√©n. </font><font style="vertical-align: inherit;">Hay compa√±√≠as que dijeron que tienen 2 millones de solicitudes por segundo. </font><font style="vertical-align: inherit;">Aqu√≠ probablemente tengan que creer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y, en principio, Cassandra tiene una gran diferencia con los datos relacionales: no se parece en absoluto a ellos. </font><font style="vertical-align: inherit;">Y esto es muy importante para recordar.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No todo lo que se ve igual funciona igual</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez que un colega vino a m√≠ y me pregunt√≥: ‚ÄúAqu√≠ est√° el lenguaje de consulta CQL Cassandra, y tiene una declaraci√≥n select, tiene d√≥nde, tiene y. Escribo cartas y no funciona. ¬øPor qu√©?". Si tratas a Cassandra como una base de datos relacional, entonces esta es una manera ideal de terminar tu vida con un brutal suicidio. Y no defiendo, est√° prohibido en Rusia. Solo est√°s dise√±ando algo mal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, un cliente se acerca a nosotros y nos dice: ‚ÄúConstruyamos una base de datos para programas de televisi√≥n o una base de datos para un directorio de recetas. Tendremos platos de comida all√≠ o una lista de series y actores ‚Äù. Decimos con alegr√≠a: "¬°Vamos!". Son dos bytes para enviar, un par de placas y todo est√° listo, todo funcionar√° de manera muy r√°pida y confiable. Y todo est√° bien hasta que los clientes vengan y digan que las amas de casa tambi√©n est√°n resolviendo el problema inverso: tienen una lista de productos y quieren saber qu√© plato quieren cocinar. Est√°s muerto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto se debe a que Cassandra es una base de datos h√≠brida: es un valor clave y almacena datos en columnas anchas. Hablando en Java o Kotlin, podr√≠a describirse as√≠:</font></font><br>
<br>
<code>Map&lt;RowKey, SortedMap&lt;ColumnKey, ColumnValue&gt;&gt;</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, un mapa, dentro del cual tambi√©n hay un mapa ordenado. La primera clave de este mapa es la clave de fila o la clave de partici√≥n: la clave de partici√≥n. La segunda clave, que es la clave del mapa ya ordenado, es la clave de agrupaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ilustrar la distribuci√≥n de la base de datos, dibujamos tres nodos. Ahora necesita comprender c√≥mo descomponer los datos en nodos. Porque si ponemos todo en uno (por cierto, puede haber mil, dos mil, cinco, tantos como desee), esto no se trata realmente de distribuci√≥n. Por lo tanto, necesitamos una funci√≥n matem√°tica que devuelva un n√∫mero. Solo un n√∫mero, un int largo que caer√° en alg√∫n rango. Y tenemos un nodo que ser√° responsable de un rango, el segundo - para el segundo, n-√©simo - para el n-√©simo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vl/xn/mn/vlxnmnvvigtwc_ho-wkjqy5r60e.png" width="900"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este n√∫mero se toma utilizando una funci√≥n hash que se aplica solo a lo que llamamos la tecla Partici√≥n. </font><font style="vertical-align: inherit;">Esta es la columna que se especifica en la directiva Clave primaria, y esta es la columna que ser√° la primera y m√°s b√°sica clave de mapa. </font><font style="vertical-align: inherit;">Determina qu√© nodo obtiene qu√© datos. </font><font style="vertical-align: inherit;">Se crea una tabla en Cassandra con casi la misma sintaxis que en SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (<font></font>
	user_id uu <span class="hljs-keyword">id</span>,
	<span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>,
	<span class="hljs-keyword">year</span> <span class="hljs-built_in">int</span>,<font></font>
	salary <span class="hljs-built_in">float</span>,<font></font>
	PRIMARY <span class="hljs-keyword">KEY</span>(user_id)<font></font>
<font></font>
)<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clave primaria en este caso consiste en una columna, y tambi√©n es una clave de partici√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo caer√°n los usuarios con nosotros? </font><font style="vertical-align: inherit;">Parte recaer√° en una nota, parte en otra y parte en una tercera. </font><font style="vertical-align: inherit;">Resulta una tabla hash ordinaria, tambi√©n es un mapa, tambi√©n es un diccionario en Python, tambi√©n es una estructura de valores clave simple desde la cual podemos leer todos los valores, leer y escribir por clave.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vp/3_/xa/vp3_xa1bupu1wawi77ytwk0pike.png" width="900"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seleccione: cuando permitir el filtrado se convierte en escaneo completo, o c√≥mo no hacerlo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos a escribir alguna declaraci√≥n al selecto El: </font></font><code>select * from users where, userid = </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Resulta, al parecer, como en Oracle: escribimos select, especificamos condiciones y todo funciona, los usuarios lo entienden. Pero si selecciona, por ejemplo, un usuario con un determinado a√±o de nacimiento, Cassandra jura que no puede cumplir con la solicitud. Debido a que no sabe nada acerca de c√≥mo distribuimos los datos sobre el a√±o de nacimiento, solo tiene una columna especificada como clave. Entonces ella dice: "Est√° bien, todav√≠a puedo cumplir con esta solicitud. Agregar permitir filtrado ". Agregamos una directiva, todo funciona. Y en ese momento sucede algo terrible.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando manejamos datos de prueba, todo est√° bien. Y cuando cumple con la solicitud en producci√≥n, donde, por ejemplo, tenemos 4 millones de registros, entonces no todo es muy bueno para nosotros. Debido a que permitir el filtrado es una directiva que permite a Cassandra recopilar todos los datos de esta tabla de todos los nodos, todos los centros de datos (si hay muchos de ellos en este cl√∫ster), y solo luego filtrarlos. Este es un an√°logo de Full Scan, y casi nadie est√° encantado con √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si solo necesit√°ramos usuarios por identificadores, esto nos convendr√≠a. Pero a veces necesitamos escribir otras consultas e imponer otras restricciones a la selecci√≥n. Por lo tanto, recordamos: todos tenemos un mapa, que tiene una clave de partici√≥n, pero dentro de √©l hay un mapa ordenado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ella tambi√©n tiene una clave, que llamamos Clustering Key. Esta clave, que, a su vez, consiste en las columnas que seleccionamos, con las que Cassandra comprende c√≥mo se ordenan f√≠sicamente sus datos y se ubicar√°n en cada nodo. Es decir, para alguna clave de partici√≥n, la clave de agrupaci√≥n le dir√° exactamente c√≥mo insertar los datos en este √°rbol, qu√© lugar ocupar√°n all√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es realmente un √°rbol, simplemente se llama un comparador all√≠, en el que pasamos un cierto conjunto de columnas en forma de un objeto, y tambi√©n se configura en forma de una enumeraci√≥n de columnas.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_by_year_salary_id (<font></font>
	user_id <span class="hljs-keyword">uuid</span>,
	<span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>,
	<span class="hljs-keyword">year</span> <span class="hljs-built_in">int</span>,<font></font>
	salary <span class="hljs-built_in">float</span>,<font></font>
	PRIMARY <span class="hljs-keyword">KEY</span>((<span class="hljs-keyword">year</span>), salary, user_id)
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Preste atenci√≥n a la directiva de la clave primaria, tiene el primer argumento (en nuestro caso el a√±o) es siempre la clave de partici√≥n. </font><font style="vertical-align: inherit;">Puede constar de una o varias columnas, no importa. </font><font style="vertical-align: inherit;">Si hay varias columnas, debe eliminarlo nuevamente entre par√©ntesis para que el preprocesador del idioma comprenda que esta es la clave Primaria, y detr√°s de ella todas las dem√°s columnas: la clave de Agrupaci√≥n. </font><font style="vertical-align: inherit;">En este caso, se transmitir√°n en el comparador en el orden en que van. </font><font style="vertical-align: inherit;">Es decir, la primera columna es m√°s significativa, la segunda es menos significativa y as√≠ sucesivamente. </font><font style="vertical-align: inherit;">A medida que escribimos para clases de datos, por ejemplo, campos iguales: enumeramos campos, y para ellos escribimos cu√°les son m√°s grandes y cu√°les son m√°s peque√±os. </font><font style="vertical-align: inherit;">En Cassandra, este es, relativamente hablando, el campo de clase de datos al que se aplicar√°n los iguales escritos para √©l.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecemos el tipo, imponemos restricciones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debe recordarse que el orden de clasificaci√≥n (decreciente, creciente, no importa) se establece al mismo tiempo que se crea la clave, y luego no puede cambiarla m√°s tarde. Determina f√≠sicamente c√≥mo se ordenar√°n los datos y c√≥mo se encontrar√°n. Si necesita cambiar la clave de agrupaci√≥n o el orden de clasificaci√≥n, deber√° crear una nueva tabla y verter datos en ella. Con el existente esto no funcionar√°. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qh/qt/kgqhqtjece2c4irbhyll0mxsl10.png" width="900"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Llenamos nuestra mesa con usuarios y vimos que entraron en un anillo, primero por a√±o de nacimiento, y luego dentro de cada nodo por salario y por identificaci√≥n de usuario. Ahora podemos seleccionar, imponiendo restricciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro trabajo aparece de nuevo</font></font><code>where, and</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y los usuarios llegan a nosotros, y todo vuelve a estar bien. </font><font style="vertical-align: inherit;">Pero si tratamos de usar solo la parte clave de Clustering, la menos significativa, Cassandra jurar√° de inmediato que no podemos encontrar en nuestro mapa d√≥nde este objeto tiene estos campos para el comparador nulo, pero este se acaba de configurar - Donde yace. </font><font style="vertical-align: inherit;">Tendr√© que recoger todos los datos de este nodo nuevamente y filtrarlos. </font><font style="vertical-align: inherit;">Y esto es un an√°logo de Full Scan dentro del nodo, esto es malo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cualquier situaci√≥n incomprensible, cree una nueva tabla</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si queremos poder obtener usuarios por ID o por edad o por salario, ¬øqu√© debemos hacer? Nada. Solo usa dos tablas. Si necesita obtener usuarios de tres maneras diferentes, habr√° tres tablas. Atr√°s quedaron los d√≠as en que ahorramos espacio en el tornillo. Este es el recurso m√°s barato. Cuesta mucho menos que el tiempo de respuesta, que puede ser fatal para el usuario. El usuario es mucho m√°s amable de obtener algo en un segundo que en 10 minutos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intercambiamos espacio excesivo, datos desnormalizados para la capacidad de escalar bien, trabajar de manera confiable. De hecho, en realidad, un cl√∫ster que consta de tres centros de datos, cada uno de los cuales tiene cinco nodos, con un nivel aceptable de almacenamiento de datos (cuando no se pierde nada con seguridad), puede sobrevivir completamente a la muerte de un centro de datos. Y dos nodos m√°s en cada uno de los dos restantes. Y solo despu√©s de eso comienzan los problemas. Esta es una redundancia bastante buena, cuesta un par de unidades y procesadores ssd innecesarios. Por lo tanto, para usar Cassandra, que nunca es SQL, en el que no hay relaciones ni claves for√°neas, debe conocer reglas simples.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dise√±amos todo desde una solicitud. Lo principal no son los datos, sino c√≥mo va a funcionar la aplicaci√≥n con ellos. Si necesita recibir diferentes datos de diferentes maneras o los mismos datos de diferentes maneras, debemos ponerlos de la manera que sea conveniente para la aplicaci√≥n. De lo contrario, fallaremos en Full Scan y Cassandra no nos dar√° ninguna ventaja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La desnormalizaci√≥n de datos es la norma. Olv√≠date de las formas normales, ya no tenemos bases de datos relacionales. Ponemos algo 100 veces, mentir√° 100 veces. Es m√°s barato que detenerlo de todos modos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seleccionamos las claves para particionar para que se distribuyan normalmente. </font><font style="vertical-align: inherit;">No necesitamos que el hash de nuestras teclas caiga en un rango estrecho. </font><font style="vertical-align: inherit;">Es decir, el a√±o de nacimiento en el ejemplo anterior es un mal ejemplo. </font><font style="vertical-align: inherit;">M√°s bien, es bueno si nuestros usuarios se distribuyen normalmente por a√±o de nacimiento, y malo si hablamos de estudiantes de 5to grado; no ser√° muy bueno dividir all√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La ordenaci√≥n se selecciona una vez durante la creaci√≥n de la clave de agrupaci√≥n. </font><font style="vertical-align: inherit;">Si necesita cambiarlo, tendr√° que llenar en exceso nuestra tabla con una clave diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y lo m√°s importante: si necesitamos recopilar los mismos datos de 100 formas diferentes, tendremos 100 tablas diferentes.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es486800/">https://habr.com/ru/post/es486800/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es486788/index.html">Seminario web ‚ÄúMonitoreo remoto y diagn√≥stico de equipos. Estudios de caso de soluciones CNC de Winnum ¬ª</a></li>
<li><a href="../es486790/index.html">Y de nuevo Qbot: una nueva variedad de troyanos bancarios</a></li>
<li><a href="../es486792/index.html">El camino del robot hacia el sat√©lite helado de otro planeta comienza en las profundidades de la Ant√°rtida.</a></li>
<li><a href="../es486794/index.html">Los procesos de las neuronas humanas mostraron una capacidad inesperada para calcular</a></li>
<li><a href="../es486798/index.html">¬øHay un GameDev en Sakhalin? Final</a></li>
<li><a href="../es486802/index.html">La gente conoce los sistemas de recomendaci√≥n. Factorizaci√≥n</a></li>
<li><a href="../es486804/index.html">Inform√°tica sanitaria mundial: tecnolog√≠as en la nube</a></li>
<li><a href="../es486808/index.html">Prueba de embarazo electr√≥nica de una farmacia: c√≥mo funciona</a></li>
<li><a href="../es486810/index.html">Nueva interfaz de Odnoklassniki: lanzamiento de React en Java. Parte II</a></li>
<li><a href="../es486814/index.html">Zabbix: la topolog√≠a de red es clara y autom√°tica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>