<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔙 🏞️ 😛 Comment fonctionne l'histogramme Prometheus? 👨🏽‍💼 🤾🏻 👰🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une traduction de l'article a été préparée avant le début du cours «Monitoring and Logging: Zabbix, Prometheus, ELK» .
 
 
 
 Plus tôt, nous avons exa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment fonctionne l'histogramme Prometheus?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501978/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une traduction de l'article a été préparée avant le début du cours </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Monitoring and Logging: Zabbix, Prometheus, ELK»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/bb/b2/rl/bbb2rlroxgbryy_noc1mg9urkos.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tôt, nous avons examiné </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un compteur</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une jauge</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un résumé</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Parlons maintenant du fonctionnement de l'histogramme dans Prométhée.</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'histogramme présente quelques similitudes avec le résumé. </font><font style="vertical-align: inherit;">Un histogramme est une combinaison de différents compteurs. </font><font style="vertical-align: inherit;">Comme les métriques récapitulatives, les métriques d'histogramme sont utilisées pour suivre les indicateurs dimensionnels des événements, souvent leur durée, à l'aide de la méthode </font></font><code>observe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Les outils de chronométrage sont généralement les mêmes que les bulletins. </font><font style="vertical-align: inherit;">Ce qui les différencie, c'est le traitement des quantiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un exemple de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">format d'</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> étiquette Prometheus </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">pour l'exposition</font></a></font><code>handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="xml hljs"># HELP prometheus_http_request_duration_seconds Histogram of latencies for HTTP requests.<font></font>
# TYPE prometheus_http_request_duration_seconds histogram<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.1"} 25547<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.2"} 26688<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.4"} 27760<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="1"} 28641<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="3"} 28782<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="8"} 28844<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="20"} 28855<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="60"} 28860<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="120"} 28860<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="+Inf"} 28860<font></font>
prometheus_http_request_duration_seconds_sum{handler="/"} 1863.80491025699<font></font>
prometheus_http_request_duration_seconds_count{handler="/"} 28860</code></pre><br>
<code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ils </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonctionnent exactement de la même manière que pour le résumé, et peuvent être utilisés pour obtenir le temps d'exécution moyen au cours des cinq dernières minutes:</font></font><br>
<br>
<pre><code class="xml hljs"> rate(prometheus_http_request_duration_seconds_sum[5m]<font></font>
/<font></font>
  rate(prometheus_http_request_duration_seconds_count[5m])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, il existe de très rares cas où il est </font></font><code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">absent, par exemple, dans certaines mesures de l'exportateur MySQLd. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une partie notable de l'histogramme est la série chronologique </font></font><code>_bucket</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui est en fait la partie histogramme de la métrique. Plus précisément, ce sont des compteurs qui forment un histogramme cumulatif. </font></font><code>le</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dénoter inférieur ou égal à. Ainsi, 26688 demandes ont pris moins ou égal à 200 ms, 27 760 demandes ont pris moins ou égal à 400 ms, et il y avait 28860 demandes au total. Les valeurs dans le compartiment seront monotones non décroissantes et le </font></font><code>+Inf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compartiment aura la plus grande valeur. </font></font><code>+Inf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le compartiment doit toujours être présent et correspondre à la valeur </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour calculer, disons, un quantile de 0,9 (le 90e centile), vous devez utiliser:</font></font><br>
<br>
<pre><code class="xml hljs">histogram_quantile(0.9, <font></font>
  rate(prometheus_http_request_duration_seconds_bucket[5m])<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un gros avantage des histogrammes sur les résumés est que vous pouvez agréger des seaux avant de calculer le quantile - en prenant soin de ne pas perdre l'étiquette </font></font><code>le</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">histogram_quantile(0.9, <font></font>
  sum without (handler)(<font></font>
    rate(prometheus_http_request_duration_seconds_bucket[5m])<font></font>
  )<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de l'agrégation, les histogrammes sont moins chers pour le client, car les compteurs sont rapidement incrémentés. </font><font style="vertical-align: inherit;">Alors pourquoi ne pas toujours utiliser des histogrammes? </font><font style="vertical-align: inherit;">Il y a une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">longue réponse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais la version courte est qu'avec les histogrammes, vous devez d'abord sélectionner votre compartiment, et les coûts sont transférés du client à Prometheus lui-même en raison du nombre d'éléments du compartiment. Par défaut, dix compartiments couvrent un service Web typique avec un délai allant de quelques millisecondes à une seconde, et dans certains cas, vous devrez peut-être changer cela. Ici, par exemple, ils ont été redéfinis pour mieux suivre les requêtes PromQL, qui par défaut ont un délai de deux minutes. Avoir plus d'une douzaine de seaux donnera des résultats plus précis, mais peut également produire de nombreuses séries chronologiques. Surtout en combinaison avec d'autres balises.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous utilisez un système de surveillance en temps réel tel que Prometheus, l'objectif doit être de fournir une valeur analytique suffisante pour prendre des décisions d'ingénierie basées sur celui-ci. Par exemple, savoir que le retard du 90e centile a augmenté de 50 ms est plus important que de savoir s'il est maintenant de 562 ms ou 563 ms, et généralement dix tranches suffisent pour cela. Si vous avez besoin d'une réponse exacte, vous pouvez toujours la calculer ultérieurement à partir de vos journaux. S'il y a trop de compartiments, ils peuvent être supprimés pendant le traitement des données, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme indiqué précédemment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans les cas les plus extrêmes, vous pouvez ignorer complètement la série de </font></font><code>_bucket</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s et vous fier à la moyenne de </font></font><code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conclusion, les histogrammes permettent de calculer des quantiles agrégés, bien que le nombre d'éléments doive être pris en compte. </font><font style="vertical-align: inherit;">N'oubliez pas qu'un résumé sans quantiles est une option moins chère si vous n'avez pas besoin d'histogramme.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur le cours</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr501960/index.html">Mise à l'échelle de la recherche. Elasticsearch Ses avantages et exigences de base pour l'installation</a></li>
<li><a href="../fr501964/index.html">À quoi servent les ordinateurs industriels?</a></li>
<li><a href="../fr501968/index.html">Modèle architectural MVI dans Kotlin Multiplatform, Partie 1</a></li>
<li><a href="../fr501970/index.html">De quoi avez-vous besoin pour créer un bon donjon en RPG?</a></li>
<li><a href="../fr501976/index.html">Comment apprendre à tester des logiciels</a></li>
<li><a href="../fr501980/index.html">L'histoire d'un projet ou comment j'ai créé un PBX de 7 ans basé sur Asterisk et Php</a></li>
<li><a href="../fr501982/index.html">Comment transférer un shader d'un moteur de jeu vers Substance Painter</a></li>
<li><a href="../fr501984/index.html">Que voir en quarantaine? Une sélection de matériaux de Technostream (partie 4)</a></li>
<li><a href="../fr501986/index.html">Les secrets de l'incroyable succès des Apple AirPods</a></li>
<li><a href="../fr501988/index.html">Comment s'affiche l'écran de message VK?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>