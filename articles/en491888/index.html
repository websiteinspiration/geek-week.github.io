<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôçüèº üë®üèº‚Äçüé® ü§ú GitLab CI: 6 features from the latest releases that we have been waiting for ‚ö™Ô∏è üìë üî∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the era of ubiquitous CI / CD, we are faced with a wide range of related tools, including CI systems. However, it was GitLab that became the closes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GitLab CI: 6 features from the latest releases that we have been waiting for</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/491888/"><img src="https://habrastorage.org/webt/gw/s2/_l/gws2_lpk_xse3zwysoxi7yhgedi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the era of ubiquitous CI / CD, we are faced with a wide range of related tools, including CI systems. However, it was GitLab that became the closest for us, truly ‚Äúnative‚Äù. He gained notable popularity in the industry as a whole *. The developers of the product did not lag behind the growing interest in its use, regularly delighting the community of developers and DevOps engineers with new versions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/lp/fl/lelpfl_26qkmpjz5qf5cjq4bbd0.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab repository month and tag aggregation</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab is the case when active development brings many new and interesting features. If for potential users this is just one of the factors of choosing a tool, for existing ones, the situation is as follows: if you have not updated your GitLab installation in the last month, then with a high probability you missed something interesting. Including regularly emerging security updates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
About the most significant - i.e. demanded by our DevOps engineers and customers - innovations in the latest releases of the Community edition of GitLab, and this article will be discussed.</font></font><a name="habracut"></a><br>
<br>
<i>*   5  ,  ¬´GitLab¬ª,   : ¬´,   GitHub?¬ª.     ‚Äî ,  Google Trends <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>  5-    ¬´gitlab¬ª   .     ¬´¬ª  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.     ,   ,     ¬´¬ª   .</i><br>
<br>
<h2>‚Ññ1: needs</h2><br>
<ul>
<li>     job'.</li>
<li>    GitLab: 12.2.</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thought </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>dependencies</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is what you need? Probably, we were not the only ones who made the mistake of assigning this directive ... It is needed to list the previous jobs, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artifacts</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of which will be required. It is artifacts, and not dependence on the performance of the previous task. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose it happened that in one stage there are jobs that are not necessary to be performed, but for some reason there is no possibility or just desire to take them out to a separate stage (laziness is the engine of progress, but do not get carried away). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Situation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/sa/k1/_usak1lrpdqpjtxln69r3ktc5ag.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, stage </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains buttons for rolling out both production and stage, and job </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selenium tests</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for some reason is not executed. </font><font style="vertical-align: inherit;">It's simple: he waits until all jobs from the previous stage are successfully completed. </font><font style="vertical-align: inherit;">However, in the framework of the same pipeline, we do not need to deploy stage now to run the tests (it was pumped out earlier not within the tag). </font><font style="vertical-align: inherit;">What to do? </font><font style="vertical-align: inherit;">Then come to the rescue </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">needs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We list only the necessary previous jobs to run our tests:</font></font><br>
<br>
<pre><code class="plaintext hljs">  needs:<font></font>
    - To production (Cluster 1)<font></font>
    - To production (Cluster 2)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... and we get a job, which is automatically called after only the listed jobs are executed: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jm/9y/8z/jm9y8zesapj3neflq_xmn7er70i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conveniently, right? </font><font style="vertical-align: inherit;">But once I expected that the directive would work something like this </font></font><code>dependencies</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No. 2: extends</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Enhanced YAML anchors and aliases.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduced since GitLab 11.3.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#extends</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tired of reading rolls </font></font><code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Missing the code reuse principle? Then you have already tried and probably successfully brought yours </font></font><code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to a state like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: &amp;base_deploy<font></font>
  stage: deploy<font></font>
  script:<font></font>
    - my_deploy_command.sh<font></font>
  variables:<font></font>
    CLUSTER: "default-cluster"<font></font>
    MY_VAR: "10"<font></font>
<font></font>
Deploy Test:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  environment:<font></font>
    url: test.example.com<font></font>
    name: test<font></font>
<font></font>
Deploy Production:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  environment:<font></font>
    url: production.example.com<font></font>
    name: production<font></font>
  variables:<font></font>
    CLUSTER: "prod-cluster"<font></font>
    MY_VAR: "10"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sounds great? However, if you look closely, something catches your eye ... Why did we change in production not only </font></font><code>variables.CLUSTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but also prescribed a second time </font></font><code>variables.MY_VAR=10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Should this variable be taken from </font></font><code>base_deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? It turns out that it shouldn't: YAML works so that, redefining what is received from the anchor, it </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not expand the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contents of the matching fields, but </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">replaces it</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Therefore, we are forced to list the variables already known to us in the matching paragraph. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, ‚Äúexpands‚Äù is the right word: this is exactly what the feature in question is called. </font></font><code>Extends</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">They allow us not just to rewrite the field, as it happens with anchor, but to conduct a smart merge for it:</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: <font></font>
  stage: deploy<font></font>
  script:<font></font>
    - my_deploy_command.sh<font></font>
  variables:<font></font>
    CLUSTER: "default-cluster"<font></font>
    MY_VAR: "10"<font></font>
<font></font>
Deploy Production:<font></font>
  extends: .base_deploy<font></font>
  environment:<font></font>
    url: production.example.com<font></font>
    name: production<font></font>
  variables:<font></font>
    CLUSTER: "prod-cluster"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here in the final job </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy Production there</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be both a variable </font></font><code>MY_VAR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a default value and an overridden one </font></font><code>CLUSTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that this is such a trifle, but imagine: you have one </font></font><code>base_deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and 20 circuits deployed similarly. </font><font style="vertical-align: inherit;">They need to be passed on to others </font></font><code>cluster</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>environment.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while preserving a certain set of variables or other matching fields ... This small pleasantness allowed us to reduce the deployment description of the set of dev-circuits by 2-3 times.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No. 3: include</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We divide huge YAML into several and reuse in other projects.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduced in Core since version 11.4.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#include</font></font></a></li>
</ul><br>
<code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it still looks </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">like a folding instruction for a vacuum cleaner in 20 languages ‚Äã‚Äã(of which you only understand your native one) is</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it difficult when you need to deal with one of its sections without changing in the face of unknown jobs encountered on the way? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A long-time programming friend will help </font></font><code>include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">stages:<font></font>
  - test<font></font>
  - build<font></font>
  - deploy<font></font>
<font></font>
variables:<font></font>
  VAR_FOR_ALL: 42<font></font>
<font></font>
include:<font></font>
  - local: .gitlab/ci/test.yml<font></font>
  - local: .gitlab/ci/build.yml<font></font>
  - local: .gitlab/ci/deploy-base.yml<font></font>
  - local: .gitlab/ci/deploy-production.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Those. </font><font style="vertical-align: inherit;">Now we are boldly editing the deployment in production, while testers are busy modifying their file, which we may not even look at. </font><font style="vertical-align: inherit;">In addition, this helps to avoid merge conflicts: it‚Äôs not always fun to understand someone else‚Äôs code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But what if we know the pipeline of our 20 projects along and across, can we explain the logic of each job from it? </font><font style="vertical-align: inherit;">How will this help us? </font><font style="vertical-align: inherit;">For those who have achieved enlightenment in code reuse and for all who have many similar projects, you can:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - include GitLab CI files from another repository of the same GitLab instance,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: template</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - collections of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ready-made GitLab templates</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include: remote</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - an external file (accessible via HTTPS).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A dozen of the same type of projects with different code, but deployed the same way - easily and without maintaining up-to-date CI in all repositories! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of practical use </font></font><code>include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was also given in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No. 4: only / except refs</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comprehensive conditions, including variables and file changes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since this is a whole family of functions, some parts began to appear in GitLab 10.0, while others (for example, </font></font><code>changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">began to appear in </font><font style="vertical-align: inherit;">11.4.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#onlyexcept-advanced</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes it seems to me that this is not a pipeline listening to us, but we him. </font><font style="vertical-align: inherit;">An excellent management tool are </font></font><code>only</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>except</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- now integrated. </font><font style="vertical-align: inherit;">What does this mean? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the simplest (and perhaps the most pleasant) case, skipping stages:</font></font><br>
<br>
<pre><code class="plaintext hljs">Tests:<font></font>
  only:<font></font>
    - master<font></font>
  except:<font></font>
    refs:<font></font>
    - schedules<font></font>
    - triggers<font></font>
    variables:<font></font>
    - $CI_COMMIT_MESSAGE =~ /skip tests/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the example job, it runs only on a branch of the master, but cannot be triggered by a schedule or trigger (GitLab shares API calls and triggers, although this is essentially the same API). </font><font style="vertical-align: inherit;">Job will not be executed if there is a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skip tests</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> passphrase in the commit message </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For example, a typo in the </font></font><code>README.md</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">project or documentation has </font><font style="vertical-align: inherit;">been fixed </font><font style="vertical-align: inherit;">- why wait for the test results? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚ÄúHey, 2020 is outside!‚Äù </font><font style="vertical-align: inherit;">Why should I each time explain to the iron box that it is not necessary to run tests when changing the documentation? ‚Äù </font><font style="vertical-align: inherit;">And really: </font></font><code>only:changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it allows you to run tests when changing files only in certain directories. </font><font style="vertical-align: inherit;">For instance:</font></font><br>
<br>
<pre><code class="plaintext hljs">  only:<font></font>
    refs:<font></font>
      - master<font></font>
      - merge_requests<font></font>
    changes:<font></font>
      - "front/**/*"<font></font>
      - "jest.config.js"<font></font>
      - "package.json"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And for the reverse action - i.e. </font><font style="vertical-align: inherit;">do not run - yes </font></font><code>except:changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No. 5: rules</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Individual job rules.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduced in GitLab 12.3.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#rules</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This directive is very similar to the previous ones </font></font><code>only:*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but with an important difference: it allows you to control the parameter </font></font><code>when</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For example, if you want not to completely remove the possibility of starting a job. </font><font style="vertical-align: inherit;">You can simply leave the button, which, if desired, will be called independently, without launching a new pipeline or without making commit.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 6: environment: auto_stop_in</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Stop environments in the absence of activity.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Introduced in GitLab 12.8.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#environmentauto_stop_in</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We learned about this opportunity right before the publication of the article and have not yet had enough time to try it out in practice, but this is definitely ‚Äúthe same thing‚Äù that was so expected in several projects. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can specify a parameter in GitLab environments </font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- it is very useful when you want to create and delete environments dynamically, for example, to each branch. The job marked with k </font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is executed, for example, when the merge of MR is in the master branch or when the MR is closed (or even just by clicking on the button), due to which the unnecessary environment is automatically deleted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is convenient, logical, works ... if not for the human factor. Many developers merge MRs not by clicking a button in GitLab, but locally via </font></font><code>git merge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. You can understand them: it's convenient! But in this case, the logic</font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it doesn‚Äôt work, we have accumulated forgotten surroundings ... This is where the long-awaited come in handy </font></font><code>auto_stop_in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus: temporary huts when there are not enough opportunities</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite all these (and many others) new, demanded functions of GitLab, unfortunately, sometimes the conditions for fulfilling a job are simply impossible to describe within the framework of the currently available capabilities. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab is not perfect, but it provides the basic tools for building a dream pipeline ... if you are ready to go beyond the modest DSL, plunging into the world of scripting. </font><font style="vertical-align: inherit;">Here are a few solutions from our experience, which in no way pretend to be ideologically correct or recommended, but are presented more to demonstrate different possibilities with a lack of built-in API functionality.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Workaround No. 1: launch two jobs with one button</font></font></h3><br>
<pre><code class="plaintext hljs">script:<font></font>
  - &gt; <font></font>
    export CI_PROD_CL1_JOB_ID=`curl -s -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs" | \<font></font>
      jq '[.[] | select(.name == "Deploy (Cluster 1)")][0] | .id'`<font></font>
  - &gt; <font></font>
    export CI_PROD_CL2_JOB_ID=`curl -s -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs" | \<font></font>
      jq '[.[] | select(.name == "Deploy (Cluster 2)")][0] | .id'`<font></font>
  - &gt; <font></font>
    curl -s --request POST -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/jobs/$CI_PROD_CL1_JOB_ID/play"<font></font>
  - &gt; <font></font>
    curl -s --request POST -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/jobs/$CI_PROD_CL2_JOB_ID/play"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And why not, if you really want to?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Workaround No. 2: transfer changed in MR rb-files for rubocop inside the image</font></font></h3><br>
<pre><code class="plaintext hljs">Rubocop:<font></font>
  stage: test<font></font>
  allow_failure: false<font></font>
  script:<font></font>
    ...<font></font>
    - export VARFILE=$(mktemp)<font></font>
    - export MASTERCOMMIT=$(git merge-base origin/master HEAD)<font></font>
    - echo -ne 'CHANGED_FILES=' &gt; ${VARFILE}<font></font>
    - if [ $(git --no-pager diff --name-only ${MASTERCOMMIT} | grep '.rb$' | wc -w |awk '{print $1}') -gt 0 ]; then<font></font>
        git --no-pager diff --name-only ${MASTERCOMMIT} | grep '.rb$' |tr '\n' ' ' &gt;&gt; ${VARFILE} ;<font></font>
      fi<font></font>
    - if [ $(wc -w ${VARFILE} | awk '{print $1}') -gt 1 ]; then<font></font>
        werf --stages-storage :local run rails-dev --docker-options="--rm --user app --env-file=${VARFILE}" -- bash -c /scripts/rubocop.sh ;<font></font>
      fi<font></font>
    - rm ${VARFILE}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is no image inside </font></font><code>.git</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so I had to get out to check only the changed files. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: This is not a very standard situation and a desperate attempt to comply with many conditions of the problem, the description of which is not included in the scope of this article.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Workaround # 3: trigger to start jobs from other repositories when rolling out</font></font></h3><br>
<pre><code class="plaintext hljs">  before_script:<font></font>
    - |<font></font>
      echo '### Trigger review: infra'<font></font>
      curl -s -X POST \<font></font>
        -F "token=$REVIEW_TOKEN_INFRA" \<font></font>
        -F "ref=master" \<font></font>
        -F "variables[REVIEW_NS]=$CI_ENVIRONMENT_SLUG" \<font></font>
        -F "variables[ACTION]=auto_review_start" \<font></font>
        https://gitlab.example.com/api/v4/projects/${INFRA_PROJECT_ID}/trigger/pipeline</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would seem that such a simple and necessary (in the world of microservices) thing is rolling out another microservice into a freshly created circuit as a dependency. </font><font style="vertical-align: inherit;">But it is not, therefore, an API call and an already familiar (described above) feature are required:</font></font><br>
<br>
<pre><code class="plaintext hljs">  only:<font></font>
    refs:<font></font>
    - triggers<font></font>
    variables:<font></font>
    - $ACTION == "auto_review_start"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Job on trigger is designed to be tied to passing a variable to the API, similarly to example No. 1. </font><font style="vertical-align: inherit;">It is more logical to implement this on the API with the job name passed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yes, the function is in the commercial (EE) version of GitLab, but we do not consider it.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab tries to keep up with the trends, gradually implementing features that are pleasant and in demand by the DevOps community. </font><font style="vertical-align: inherit;">They are quite easy to use, and when the basic capabilities are not enough, they can always be expanded with scripts. </font><font style="vertical-align: inherit;">And if we see that it turns out not so elegantly and conveniently in support ... it remains to wait for new releases of GitLab - or to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">help the project with our contribution</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read also in our blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembly and deployment of the same type of microservices with werf and GitLab CI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JUnit in GitLab CI with Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">werf ‚Äî    CI/CD  Kubernetes (   )</a>¬ª <i>( ; 27  2019  DevOpsConf)</i>;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">       GitLab CI</a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">GitLab CI       production</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491876/index.html">MosQA # 2 - materials from mitap and search for all flags from the quest</a></li>
<li><a href="../en491880/index.html">5 stages of inevitability of adoption of ISO / IEC 27001 certification. Anger</a></li>
<li><a href="../en491882/index.html">Automate input to SecureCRT using scripts</a></li>
<li><a href="../en491884/index.html">Holistic knowledge management in an IT company</a></li>
<li><a href="../en491886/index.html">KnowledgeConf 2020 Online: implementing step-by-step knowledge management</a></li>
<li><a href="../en491890/index.html">Drive Anatomy: SSD</a></li>
<li><a href="../en491896/index.html">How we at Cyan improve a product through user experience research</a></li>
<li><a href="../en491900/index.html">Flexibility and automation in machine learning</a></li>
<li><a href="../en491902/index.html">Writing a simple WYSIWYG editor with ProseMirror</a></li>
<li><a href="../en491904/index.html">How to write safe Python code. Meals Kushal Das</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>