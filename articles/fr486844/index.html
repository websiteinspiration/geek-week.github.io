<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèø‚Äçü§ù‚Äçüßëüèº üë©üèæ‚Äçüç≥ üë©üèΩ‚Äçü§ù‚Äçüë©üèº L'√©volution du traitement des webhooks Facebook: de z√©ro √† 25 000 par seconde üòØ üë©üèæ‚Äçü§ù‚Äçüë®üèΩ ‚ôÇÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tr√®s probablement, personne n'a besoin de dire ce que sont les webhooks. Mais juste au cas o√π: les webhooks sont un m√©canisme pour signaler des √©v√©nem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>L'√©volution du traitement des webhooks Facebook: de z√©ro √† 25 000 par seconde</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tr√®s probablement, personne n'a besoin de dire ce que sont les webhooks. Mais juste au cas o√π: les webhooks sont un m√©canisme pour signaler des √©v√©nements dans un syst√®me externe. Par exemple, sur l'achat dans une boutique en ligne via une caisse en ligne, l'envoi d'un code √† un r√©f√©rentiel GitHub ou les actions des utilisateurs dans les chats. Dans une API typique, vous devez constamment interroger le serveur si l'utilisateur a √©crit quelque chose dans le chat. En utilisant le m√©canisme de webhook, vous pouvez vous "abonner" aux notifications, et le serveur lui-m√™me enverra une requ√™te HTTP lorsqu'un √©v√©nement se produit. C'est plus pratique et plus rapide que de demander constamment de nouvelles donn√©es sur le serveur.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChat est une plateforme qui aide les entreprises √† communiquer avec leurs clients via le chat dans les messageries instantan√©es. Les webhooks sont l'une des parties importantes de ManyChat, car c'est √† travers eux que l'entreprise communique avec les clients. Et ils communiquent beaucoup - par exemple, via un syst√®me, les entreprises envoient des milliards de messages par mois √† leurs clients. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart des messages sont envoy√©s via Facebook Messenger. Il a une fonctionnalit√© - une API lente. Lorsqu'un client √©crit un message pour commander une pizza, Facebook envoie un webhook √† ManyChat. La plateforme la traite, renvoie la demande et l'utilisateur re√ßoit un message. En raison de la lenteur de l'API, certaines requ√™tes durent quelques secondes. Mais lorsque la plate-forme ne r√©pond pas pendant longtemps, l'entreprise perd le client et Facebook peut d√©connecter l'application des webhooks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, le traitement des webhooks est l'une des principales t√¢ches d'ing√©nierie de la plateforme. </font><font style="vertical-align: inherit;">Pour r√©soudre le probl√®me, ManyChat a chang√© son architecture de traitement √† plusieurs reprises au cours de trois ans, passant d'un simple contr√¥leur dans Yii √† un syst√®me distribu√© avec Galaxies. </font><font style="vertical-align: inherit;">En savoir plus √† ce sujet sous la coupe Dmitry Kushnikov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancellarius</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kushnikov dirige le d√©veloppement chez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et programme professionnellement en PHP depuis 2001. </font><font style="vertical-align: inherit;">Dmitry vous expliquera comment l'architecture a chang√© avec la croissance du service et de la charge, quelles solutions et technologies ont √©t√© appliqu√©es √† diff√©rentes √©tapes, comment le traitement des webhooks a √©volu√© et comment la plate-forme parvient √† faire face √† une charge √©norme en utilisant des ressources modestes en PHP. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque. </font><font style="vertical-align: inherit;">L'article est bas√© sur le rapport de Dmitry ¬´L'√©volution du traitement des webhooks Facebook: de z√©ro √† 12500 par seconde¬ª dans </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russie 2019</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais pendant qu'il se pr√©parait, les indicateurs ont atteint 25 000.</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce que ManyChat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, je vais vous pr√©senter le contexte de nos t√¢ches. ManyChat est un service qui aide les entreprises √† utiliser les messageries instantan√©es pour le marketing, les ventes et le support. Le produit principal est la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plateforme de Messenger Marketing sur Facebook Messenger</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pendant trois ans, plus d'un million d'entreprises de 100 pays du monde ont utilis√© le service pour communiquer avec 700 millions de leurs clients. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√¥t√© client,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √ßa ressemble √† √ßa. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boutons, images et galeries dans les bo√Ætes de dialogue de Facebook Messenger.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Il s'agit de l'interface Facebook Messenger. En plus des messages texte, vous pouvez y envoyer des √©l√©ments interactifs pour interagir avec les clients, engager un dialogue, augmenter l'int√©r√™t pour vos produits et vendre. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Du c√¥t√© des entreprises</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout a l'air diff√©rent. </font><font style="vertical-align: inherit;">Il s'agit de l'interface de notre application Web o√π, √† l'aide d'une interface visuelle, les repr√©sentants commerciaux cr√©ent et programment des scripts de dialogue. </font><font style="vertical-align: inherit;">L'image est un exemple de sc√©nario. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le c≈ìur de notre syst√®me est le composant Flow Builder. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ensemble de scripts et de r√®gles d'automatisation que nous appelons un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par cons√©quent, pour simplifier, nous pouvons dire que ManyChat est un concepteur de bot. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de bot. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le client de l'entreprise qui participe au dialogue est appel√© l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abonn√©</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car pour l'interaction, le client </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">souscrit au bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi Facebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi Facebook Messenger, nous sommes le pays du t√©l√©gramme survivant? </font><font style="vertical-align: inherit;">Il y a des raisons pour cela.</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     ‚Ññ1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'interaction avec Facebook est organis√©e comme suit: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Business utilise une application Web pour configurer la logique du bot. </font><font style="vertical-align: inherit;">Lorsqu'un client interagit avec le bot via le t√©l√©phone, Facebook re√ßoit des informations √† ce sujet et nous envoie un webhook. </font><font style="vertical-align: inherit;">ManyChat le traite en fonction de la logique programm√©e par l'entreprise et renvoie la demande. </font><font style="vertical-align: inherit;">Facebook remet ensuite le message sur le t√©l√©phone de l'utilisateur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pile technologique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous faisons tout cela sur une pile modeste. </font><font style="vertical-align: inherit;">Au c≈ìur, bien s√ªr, se trouve PHP. </font><font style="vertical-align: inherit;">Le serveur Web ex√©cute Nginx, la base de donn√©es principale est PostgreSQL, et il existe √©galement Redis et Elasticsearch. </font><font style="vertical-align: inherit;">Tout tourne dans les nuages ‚Äã‚Äãd'Amazon Web Services.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion du Webhook Facebook</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemble la webcam de Facebook: il s'agit d'une demande avec une charge utile au format JSON.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les webhooks ne repr√©sentent que 10% de notre charge, mais la partie la plus importante du syst√®me. </font><font style="vertical-align: inherit;">Gr√¢ce √† eux, l'entreprise communique avec les utilisateurs. </font><font style="vertical-align: inherit;">Si les messages ralentissent ou ne sont pas envoy√©s, l'utilisateur refuse d'interagir avec le bot et l'entreprise perd le client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetons un ≈ìil √† l'√©volution de notre architecture depuis le lancement du produit. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mai 2016</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous venons de lancer notre service: 20 bots, dont 10 tests et 20 abonn√©s. </font><font style="vertical-align: inherit;">La charge √©tait de 0 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le sch√©ma d'interaction ressemblait √† ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demande est envoy√©e √† nginx.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx acc√®de √† PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM prend l'application jusqu'√† Yii.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le contr√¥leur de webhook traite la logique et envoie des demandes √† Facebook conform√©ment √† celle-ci.</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un tas de Nginx et PHP-FPM</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juin 2016.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un mois plus tard, nous avons annonc√© ManyChat sur ProductHunt et le nombre de bots est pass√© √† 2 000. </font><font style="vertical-align: inherit;">Le nombre d'abonn√©s est pass√© √† 7 mille. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce moment, le premier probl√®me est apparu dans le syst√®me. </font><font style="vertical-align: inherit;">L'API Facebook n'est pas tr√®s rapide: certaines requ√™tes peuvent prendre plusieurs secondes, et plusieurs requ√™tes peuvent prendre des dizaines de secondes. </font><font style="vertical-align: inherit;">Mais le serveur webhook veut que nous r√©pondions rapidement. </font><font style="vertical-align: inherit;">En raison de la lenteur de l'API, nous ne r√©pondons pas longtemps: le serveur jure d'abord, puis il peut compl√®tement d√©connecter l'application des webhooks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a peu d'utilisateurs, nous d√©veloppons toujours l'application, nous recherchons notre march√©, notre audience et le probl√®me de charge est d√©j√† apparu. </font><font style="vertical-align: inherit;">Mais nous avons √©t√© sauv√©s par une solution simple: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au moment o√π le contr√¥leur d√©marre, nous interrompons l'acc√®s √† Facebook</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nous disons √† Facebook que tout va bien, mais en arri√®re-plan, nous traitons les demandes et le webhook.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Files d'attente sur PostgreSQL</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©cembre 2016. Le</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service a augment√© de 5 √† 10 fois: 10 000 bots et 700 000 abonn√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parall√®lement, nous avons travaill√© sur de nouvelles t√¢ches: affichage des statistiques, remise des messages, conversion des impressions et des transitions. </font><font style="vertical-align: inherit;">√âgalement impl√©ment√© le chat en direct. </font><font style="vertical-align: inherit;">En plus d'automatiser les interactions, il donne aux entreprises la possibilit√© d'√©crire des messages directement √† leur abonn√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La r√©solution de ces probl√®mes a multipli√© par 4 le nombre de crochets suivis. </font><font style="vertical-align: inherit;">Pour chaque message que nous avons envoy√©, nous avons re√ßu 3 webhooks suppl√©mentaires. </font><font style="vertical-align: inherit;">Le syst√®me de traitement devait encore √™tre am√©lior√©. </font><font style="vertical-align: inherit;">Nous sommes une petite plate-forme, seules deux personnes ont travaill√© sur le backend, nous avons donc choisi la solution la plus simple - les files d'attente sur PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne souhaitons pas encore impl√©menter de syst√®mes complexes, nous partageons donc simplement les flux de traitement. </font><font style="vertical-align: inherit;">Les webhooks qui doivent √™tre trait√©s rapidement pour que l'utilisateur re√ßoive une r√©ponse sont trait√©s de mani√®re synchrone. </font><font style="vertical-align: inherit;">Tous les autres sont envoy√©s dans des files d'attente pour les demandes asynchrones.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Files d'attente chez Redis</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juin 2017. Le</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service se d√©veloppe: 75 000 bots, 7 millions d'abonn√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous mettons en ≈ìuvre une autre nouvelle fonctionnalit√©. Tous les webhooks que nous avons trait√©s concernaient uniquement les communications dans le messager. Mais maintenant, nous avons d√©cid√© de donner aux entreprises la possibilit√© de communiquer </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec les abonn√©s des pages commerciales</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font><font style="vertical-align: inherit;">avons </font><font style="vertical-align: inherit;">commenc√© √† traiter de nouveaux types de webhooks - ceux qui se rapportent au flux de la page elle-m√™me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les flux de pages d'entreprise ne sont pas rarement mis √† jour. Les sp√©cialistes du marketing publient souvent quelque chose, puis ils se suivent et les comptent. Il n'y a pas de trafic √©norme sur les pages professionnelles. Mais il y a des situations inverses, par exemple, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Katy Perry Day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Katy Perry est une c√©l√®bre chanteuse am√©ricaine avec un grand nombre de fans √† travers le monde. </font><font style="vertical-align: inherit;">Il y a 64 millions d'abonn√©s dans son seul groupe Facebook. </font><font style="vertical-align: inherit;">√Ä un moment donn√©, les sp√©cialistes du marketing du chanteur ont d√©cid√© de faire un bot sur Facebook Messenger et ont choisi notre plate-forme. </font><font style="vertical-align: inherit;">√Ä ce moment, lorsqu'ils ont publi√© un message appelant √† s'abonner au bot, notre charge a augment√© de 3 √† 4 fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette situation nous a permis de comprendre que sans l'impl√©mentation normale des files d'attente, nous ne pouvons rien faire. </font><font style="vertical-align: inherit;">Comme solution, ils ont choisi Redis.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choisir Redis pour les files d'attente est une tr√®s bonne d√©cision.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il a aid√© √† r√©soudre un grand nombre de probl√®mes. D√©sormais, chaque seconde via notre cluster Redis transmet 1 million de demandes diff√©rentes. Nous l'utilisons non seulement pour toutes les files d'attente en cascade, mais √©galement pour d'autres t√¢ches, par exemple la surveillance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les files d'attente sur Redis n'ont pas √©t√© impl√©ment√©es du premier coup. Lorsque nous avons commenc√© √† plier les webhooks dans Redis et √† les traiter en un seul processus, nous avons √©largi l'entonnoir en haut: il y avait √©galement plus de webhooks entrants trait√©s, mais le processus lui-m√™me prenait encore un certain temps. Cette premi√®re d√©cision n'a pas abouti.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'ils ont essay√© d'augmenter le nombre de ces demandes, il y a eu un l√©ger effondrement. La file d'attente peut accumuler des demandes de diff√©rentes pages, mais les demandes d'une page peuvent aller de suite. Si un gestionnaire est lent, les demandes d'un abonn√© et d'un bot seront trait√©es dans le mauvais ordre. L'utilisateur envoie des messages, effectue certaines actions avec le bot, mais re√ßoit une r√©ponse au hasard. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble √™tre un cas rare, mais des tests sur nos charges de travail ont montr√© que cela se produira fr√©quemment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons commenc√© √† chercher une autre solution. Ici, la simplicit√© et la puissance de Redis sont venues √† la rescousse - nous avons d√©cid√© de faire une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file d'attente pour chaque bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment √ßa fonctionne? Les messages relatifs √† chaque bot sont ajout√©s √† la file d'attente. Afin de ne pas augmenter le gestionnaire √† chaque file d'attente, nous avons cr√©√© une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file d'attente de contr√¥le</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Elle travaille comme √ßa. Chaque fois qu'une demande provient d'un bot, deux messages sont publi√©s dans Redis: un dans la file d'attente du bot, le second dans le contr√¥le. Le gestionnaire surveille le contr√¥le et chaque fois qu'il d√©marre le d√©mon lorsqu'il y a une t√¢che pour traiter le bot. Le d√©mon ratisse la file d'attente du bot correspondant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de la t√¢che principale, nous avons r√©solu le probl√®me des ¬´voisins bruyants¬ª. C'est √† ce moment-l√† qu'un bot a g√©n√©r√© une √©norme masse de webhooks et cela ralentit le syst√®me, car d'autres pages sont en attente de traitement. Pour r√©soudre le probl√®me, il suffit d' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©voluer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : lorsque la file d'attente de contr√¥le est pleine, nous ajoutons de nouveaux gestionnaires.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">files d'attente sont virtuelles</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ce ne sont que des cellules de la m√©moire Redis. </font><font style="vertical-align: inherit;">Quand il n'y a rien dans la file d'attente, √ßa n'existe pas, √ßa n'occupe rien.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janvier 2018</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nous avons atteint 1 milliard de publications par mois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La charge √©tait de 5 000 RPS par syst√®me. Ce n'est pas une charge de pointe, mais standard. Lorsque des bots de chanteurs c√©l√®bres apparaissent, tout cro√Æt d√©j√† plusieurs fois √† partir de cette figure. Mais ce n'est pas un probl√®me. Le probl√®me est en PHP-FPM: il ne peut plus supporter la charge de 5 000 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout le monde √† l'√©poque parlait de traitement asynchrone √† la mode. Nous l'avons regard√© de plus pr√®s, avons vu ReactPHP, effectu√© des tests rapides, l'avons remplac√© par PHP-FPM et avons instantan√©ment obtenu une augmentation de 4 fois. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous n'avons pas r√©√©crit le traitement de notre traitement - ReactPHP a augment√© le cadre Yii. Tout d'abord, nous avons lev√© 4 services ReactPHP, et plus tard nous en avons atteint 30. Pendant longtemps, nous avons v√©cu sur eux, et le framework a fait face √† la charge.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√®s que nous avons √©largi l'entonnoir, un autre effondrement s'est produit: apr√®s avoir d√©marr√© l'entonnoir √† la r√©ception, le traitement a recommenc√© √† souffrir. </font><font style="vertical-align: inherit;">Pour r√©soudre ce probl√®me d√©j√†, nous avons d√©cid√© de s√©parer le traitement en clusters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clusters</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont pris des bots, les ont r√©partis en clusters et ont construit des cha√Ænes logiques √† partir de Redis, Postgres et d'un gestionnaire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous avons form√© le concept de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Galaxie¬ª - une abstraction physique logique sur le traitement</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il se compose d'instances: Redis, PostgreSQL et un ensemble de services PHP. </font><font style="vertical-align: inherit;">Chaque bot appartient √† un cluster particulier et ReactPHP sait dans quel cluster le message pour ce bot doit √™tre plac√©. </font><font style="vertical-align: inherit;">Le sch√©ma ci-dessus fonctionne plus loin. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'Univers est en expansion, l'Univers de nos syst√®mes aussi, et nous ajoutons un nouveau ¬´Galaxy¬ª lorsque cela se produit.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les galaxies sont notre m√©thode de mise √† l'√©chelle.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remplacer ReactPHP par un tas de Nginx et Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours des six prochains mois, nous avons poursuivi notre croissance: 200 millions d'abonn√©s et 3 milliards de messages par mois. </font><font style="vertical-align: inherit;">Imaginez un site pour 200 millions d'utilisateurs enregistr√©s - la m√™me charge. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un nouveau probl√®me est apparu. </font><font style="vertical-align: inherit;">Les webhooks sont de petites t√¢ches du m√™me type et PHP n'est pas adapt√© pour les r√©soudre. </font><font style="vertical-align: inherit;">M√™me ReactPHP n'a plus aid√©.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il ne pouvait pas supporter la charge de 10 000 RPS - depuis l'introduction de ReactPHP, la charge a augment√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il √©tait n√©cessaire de le red√©marrer m√™me avec des d√©ploiements, d'ailleurs, s√©quentiellement, car vous ne pouvez pas interrompre le traitement des webhooks entrants. </font><font style="vertical-align: inherit;">Facebook d√©sactive l'application lorsqu'il se rend compte qu'il a des probl√®mes. </font><font style="vertical-align: inherit;">Pour ManyChat, c'est un d√©sastre - 650 000 entreprises actives ne nous pardonneront pas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, nous avons progressivement supprim√© une logique diff√©rente de ReactPHP, l'avons transmise aux processeurs et isol√© de nouvelles files d'attente. Dans le processus, ils ont remarqu√© que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP effectue une t√¢che simple - il prend un webhook et le place dans une file d'attente</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tout le reste se fait par traitements. Existe-t-il des analogues pour une t√¢che aussi simple? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous nous sommes souvenus que Nginx avait des modules et </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avons</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> remarqu√© la biblioth√®que </font><strong><font style="vertical-align: inherit;">OpenResty</font></strong><font style="vertical-align: inherit;"> . En plus de prendre en charge le langage de programmation Lua, elle avait un module pour travailler avec Redis. Un test √©crit en 3 heures a montr√© que tout le travail de 30 services sur ReactPHP peut se faire directement du c√¥t√© nginx. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici comment cela s'est av√©r√©: nous traitons une sorte de point de terminaison, r√©cup√©rons le corps de la demande et l'ajoutons directement √† Redis.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty et Lua ont contribu√© √† augmenter le d√©bit. </font><font style="vertical-align: inherit;">Nous continuons √† faire face √† notre charge de travail, le service continue, tout le monde est heureux.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Am√©liorer la solution sur Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La derni√®re √©tape ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">note: au moment du rapport</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√©vrier 2019</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">500 millions d'abonn√©s envoient et re√ßoivent 7 millions de messages d'un million de bots chaque mois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est une √©tape pour am√©liorer notre solution sur Lua. </font><font style="vertical-align: inherit;">Supprimez progressivement une partie de la logique des files d'attente et transf√©rez le traitement principal de la distribution des webhooks entre les syst√®mes √† Lua. </font><font style="vertical-align: inherit;">Maintenant, nos syst√®mes sont plus productifs et moins d√©pendants. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous maintenons </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un traitement s√©par√© et un traitement asynchrone</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le traitement concerne les statistiques et d'autres choses - c'est maintenant un syst√®me compl√®tement diff√©rent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le syst√®me semble simple, mais il ne l'est pas. </font><font style="vertical-align: inherit;">Sous le capot, 500 services traitent leurs demandes. </font><font style="vertical-align: inherit;">L'ensemble du syst√®me fonctionne sur 50 instances Amazon: Redis, PostgreSQL et les gestionnaires PHP eux-m√™mes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evolution du traitement</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La charge √©lev√©e peut √™tre cool √† faire en PHP.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rappelez-vous bri√®vement comment nous l'avons fait dans le cadre du d√©veloppement du syst√®me.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commenc√© avec Nginx normal et PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout de files d'attente √† PostgreSQL, puis √† Redis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout de clustering.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Impl√©mentation de ReactPHP.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons remplac√© ReactPHP par un groupe de Nginx et Lua, puis d√©plac√© la logique vers le groupe.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'apr√®s notre exp√©rience, nous avons d√©couvert qu'il est possible de d√©velopper et de construire une architecture en changeant successivement les parties vuln√©rables, en utilisant des approches simples et bien connues et en m√™me temps sans √©tendre la pile.</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr486844/">https://habr.com/ru/post/fr486844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486824/index.html">Mauvais conseils lorsque vous travaillez avec ANTLR</a></li>
<li><a href="../fr486826/index.html">Cr√©ation d'un Viberbot √† part enti√®re sur Django 2 et l'API Viber REST. Premi√®re partie - Webhook</a></li>
<li><a href="../fr486828/index.html">Food Design Digest, janvier 2020</a></li>
<li><a href="../fr486832/index.html">Combien d'ann√©es vont la ta√Øga - ne comprends pas</a></li>
<li><a href="../fr486842/index.html">Consul + iptables =: 3</a></li>
<li><a href="../fr486850/index.html">Nouveau si√®ge r√©serv√© - comme un h√¥tel capsule</a></li>
<li><a href="../fr486858/index.html">Cr√©ation d'un Viberbot √† part enti√®re. Deuxi√®me partie - premier contact ou "conversion_started"</a></li>
<li><a href="../fr486860/index.html">ATX12VO - Manger d'une nouvelle fa√ßon</a></li>
<li><a href="../fr486862/index.html">5 raisons pour lesquelles le Motion Design vous aide √† vous connecter avec les gens</a></li>
<li><a href="../fr486864/index.html">Migration d'OpenVPN vers WireGuard pour joindre des r√©seaux en un seul r√©seau L2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>