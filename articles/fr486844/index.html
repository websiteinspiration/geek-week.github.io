<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏿‍🤝‍🧑🏼 👩🏾‍🍳 👩🏽‍🤝‍👩🏼 L'évolution du traitement des webhooks Facebook: de zéro à 25 000 par seconde 😯 👩🏾‍🤝‍👨🏽 ♂️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Très probablement, personne n'a besoin de dire ce que sont les webhooks. Mais juste au cas où: les webhooks sont un mécanisme pour signaler des événem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>L'évolution du traitement des webhooks Facebook: de zéro à 25 000 par seconde</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Très probablement, personne n'a besoin de dire ce que sont les webhooks. Mais juste au cas où: les webhooks sont un mécanisme pour signaler des événements dans un système externe. Par exemple, sur l'achat dans une boutique en ligne via une caisse en ligne, l'envoi d'un code à un référentiel GitHub ou les actions des utilisateurs dans les chats. Dans une API typique, vous devez constamment interroger le serveur si l'utilisateur a écrit quelque chose dans le chat. En utilisant le mécanisme de webhook, vous pouvez vous "abonner" aux notifications, et le serveur lui-même enverra une requête HTTP lorsqu'un événement se produit. C'est plus pratique et plus rapide que de demander constamment de nouvelles données sur le serveur.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChat est une plateforme qui aide les entreprises à communiquer avec leurs clients via le chat dans les messageries instantanées. Les webhooks sont l'une des parties importantes de ManyChat, car c'est à travers eux que l'entreprise communique avec les clients. Et ils communiquent beaucoup - par exemple, via un système, les entreprises envoient des milliards de messages par mois à leurs clients. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart des messages sont envoyés via Facebook Messenger. Il a une fonctionnalité - une API lente. Lorsqu'un client écrit un message pour commander une pizza, Facebook envoie un webhook à ManyChat. La plateforme la traite, renvoie la demande et l'utilisateur reçoit un message. En raison de la lenteur de l'API, certaines requêtes durent quelques secondes. Mais lorsque la plate-forme ne répond pas pendant longtemps, l'entreprise perd le client et Facebook peut déconnecter l'application des webhooks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, le traitement des webhooks est l'une des principales tâches d'ingénierie de la plateforme. </font><font style="vertical-align: inherit;">Pour résoudre le problème, ManyChat a changé son architecture de traitement à plusieurs reprises au cours de trois ans, passant d'un simple contrôleur dans Yii à un système distribué avec Galaxies. </font><font style="vertical-align: inherit;">En savoir plus à ce sujet sous la coupe Dmitry Kushnikov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancellarius</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kushnikov dirige le développement chez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et programme professionnellement en PHP depuis 2001. </font><font style="vertical-align: inherit;">Dmitry vous expliquera comment l'architecture a changé avec la croissance du service et de la charge, quelles solutions et technologies ont été appliquées à différentes étapes, comment le traitement des webhooks a évolué et comment la plate-forme parvient à faire face à une charge énorme en utilisant des ressources modestes en PHP. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque. </font><font style="vertical-align: inherit;">L'article est basé sur le rapport de Dmitry «L'évolution du traitement des webhooks Facebook: de zéro à 12500 par seconde» dans </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russie 2019</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais pendant qu'il se préparait, les indicateurs ont atteint 25 000.</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce que ManyChat</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, je vais vous présenter le contexte de nos tâches. ManyChat est un service qui aide les entreprises à utiliser les messageries instantanées pour le marketing, les ventes et le support. Le produit principal est la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plateforme de Messenger Marketing sur Facebook Messenger</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pendant trois ans, plus d'un million d'entreprises de 100 pays du monde ont utilisé le service pour communiquer avec 700 millions de leurs clients. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Côté client,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ça ressemble à ça. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boutons, images et galeries dans les boîtes de dialogue de Facebook Messenger.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Il s'agit de l'interface Facebook Messenger. En plus des messages texte, vous pouvez y envoyer des éléments interactifs pour interagir avec les clients, engager un dialogue, augmenter l'intérêt pour vos produits et vendre. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Du côté des entreprises</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout a l'air différent. </font><font style="vertical-align: inherit;">Il s'agit de l'interface de notre application Web où, à l'aide d'une interface visuelle, les représentants commerciaux créent et programment des scripts de dialogue. </font><font style="vertical-align: inherit;">L'image est un exemple de scénario. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le cœur de notre système est le composant Flow Builder. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ensemble de scripts et de règles d'automatisation que nous appelons un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par conséquent, pour simplifier, nous pouvons dire que ManyChat est un concepteur de bot. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de bot. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le client de l'entreprise qui participe au dialogue est appelé l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abonné</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car pour l'interaction, le client </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">souscrit au bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi Facebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi Facebook Messenger, nous sommes le pays du télégramme survivant? </font><font style="vertical-align: inherit;">Il y a des raisons pour cela.</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     №1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'interaction avec Facebook est organisée comme suit: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Business utilise une application Web pour configurer la logique du bot. </font><font style="vertical-align: inherit;">Lorsqu'un client interagit avec le bot via le téléphone, Facebook reçoit des informations à ce sujet et nous envoie un webhook. </font><font style="vertical-align: inherit;">ManyChat le traite en fonction de la logique programmée par l'entreprise et renvoie la demande. </font><font style="vertical-align: inherit;">Facebook remet ensuite le message sur le téléphone de l'utilisateur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pile technologique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous faisons tout cela sur une pile modeste. </font><font style="vertical-align: inherit;">Au cœur, bien sûr, se trouve PHP. </font><font style="vertical-align: inherit;">Le serveur Web exécute Nginx, la base de données principale est PostgreSQL, et il existe également Redis et Elasticsearch. </font><font style="vertical-align: inherit;">Tout tourne dans les nuages ​​d'Amazon Web Services.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion du Webhook Facebook</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici à quoi ressemble la webcam de Facebook: il s'agit d'une demande avec une charge utile au format JSON.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les webhooks ne représentent que 10% de notre charge, mais la partie la plus importante du système. </font><font style="vertical-align: inherit;">Grâce à eux, l'entreprise communique avec les utilisateurs. </font><font style="vertical-align: inherit;">Si les messages ralentissent ou ne sont pas envoyés, l'utilisateur refuse d'interagir avec le bot et l'entreprise perd le client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetons un œil à l'évolution de notre architecture depuis le lancement du produit. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mai 2016</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous venons de lancer notre service: 20 bots, dont 10 tests et 20 abonnés. </font><font style="vertical-align: inherit;">La charge était de 0 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le schéma d'interaction ressemblait à ceci:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demande est envoyée à nginx.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx accède à PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM prend l'application jusqu'à Yii.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le contrôleur de webhook traite la logique et envoie des demandes à Facebook conformément à celle-ci.</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un tas de Nginx et PHP-FPM</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juin 2016.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un mois plus tard, nous avons annoncé ManyChat sur ProductHunt et le nombre de bots est passé à 2 000. </font><font style="vertical-align: inherit;">Le nombre d'abonnés est passé à 7 mille. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce moment, le premier problème est apparu dans le système. </font><font style="vertical-align: inherit;">L'API Facebook n'est pas très rapide: certaines requêtes peuvent prendre plusieurs secondes, et plusieurs requêtes peuvent prendre des dizaines de secondes. </font><font style="vertical-align: inherit;">Mais le serveur webhook veut que nous répondions rapidement. </font><font style="vertical-align: inherit;">En raison de la lenteur de l'API, nous ne répondons pas longtemps: le serveur jure d'abord, puis il peut complètement déconnecter l'application des webhooks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a peu d'utilisateurs, nous développons toujours l'application, nous recherchons notre marché, notre audience et le problème de charge est déjà apparu. </font><font style="vertical-align: inherit;">Mais nous avons été sauvés par une solution simple: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au moment où le contrôleur démarre, nous interrompons l'accès à Facebook</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nous disons à Facebook que tout va bien, mais en arrière-plan, nous traitons les demandes et le webhook.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Files d'attente sur PostgreSQL</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Décembre 2016. Le</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service a augmenté de 5 à 10 fois: 10 000 bots et 700 000 abonnés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parallèlement, nous avons travaillé sur de nouvelles tâches: affichage des statistiques, remise des messages, conversion des impressions et des transitions. </font><font style="vertical-align: inherit;">Également implémenté le chat en direct. </font><font style="vertical-align: inherit;">En plus d'automatiser les interactions, il donne aux entreprises la possibilité d'écrire des messages directement à leur abonné. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La résolution de ces problèmes a multiplié par 4 le nombre de crochets suivis. </font><font style="vertical-align: inherit;">Pour chaque message que nous avons envoyé, nous avons reçu 3 webhooks supplémentaires. </font><font style="vertical-align: inherit;">Le système de traitement devait encore être amélioré. </font><font style="vertical-align: inherit;">Nous sommes une petite plate-forme, seules deux personnes ont travaillé sur le backend, nous avons donc choisi la solution la plus simple - les files d'attente sur PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne souhaitons pas encore implémenter de systèmes complexes, nous partageons donc simplement les flux de traitement. </font><font style="vertical-align: inherit;">Les webhooks qui doivent être traités rapidement pour que l'utilisateur reçoive une réponse sont traités de manière synchrone. </font><font style="vertical-align: inherit;">Tous les autres sont envoyés dans des files d'attente pour les demandes asynchrones.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Files d'attente chez Redis</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juin 2017. Le</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> service se développe: 75 000 bots, 7 millions d'abonnés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous mettons en œuvre une autre nouvelle fonctionnalité. Tous les webhooks que nous avons traités concernaient uniquement les communications dans le messager. Mais maintenant, nous avons décidé de donner aux entreprises la possibilité de communiquer </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec les abonnés des pages commerciales</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font><font style="vertical-align: inherit;">avons </font><font style="vertical-align: inherit;">commencé à traiter de nouveaux types de webhooks - ceux qui se rapportent au flux de la page elle-même. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les flux de pages d'entreprise ne sont pas rarement mis à jour. Les spécialistes du marketing publient souvent quelque chose, puis ils se suivent et les comptent. Il n'y a pas de trafic énorme sur les pages professionnelles. Mais il y a des situations inverses, par exemple, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Katy Perry Day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Katy Perry est une célèbre chanteuse américaine avec un grand nombre de fans à travers le monde. </font><font style="vertical-align: inherit;">Il y a 64 millions d'abonnés dans son seul groupe Facebook. </font><font style="vertical-align: inherit;">À un moment donné, les spécialistes du marketing du chanteur ont décidé de faire un bot sur Facebook Messenger et ont choisi notre plate-forme. </font><font style="vertical-align: inherit;">À ce moment, lorsqu'ils ont publié un message appelant à s'abonner au bot, notre charge a augmenté de 3 à 4 fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette situation nous a permis de comprendre que sans l'implémentation normale des files d'attente, nous ne pouvons rien faire. </font><font style="vertical-align: inherit;">Comme solution, ils ont choisi Redis.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choisir Redis pour les files d'attente est une très bonne décision.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il a aidé à résoudre un grand nombre de problèmes. Désormais, chaque seconde via notre cluster Redis transmet 1 million de demandes différentes. Nous l'utilisons non seulement pour toutes les files d'attente en cascade, mais également pour d'autres tâches, par exemple la surveillance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les files d'attente sur Redis n'ont pas été implémentées du premier coup. Lorsque nous avons commencé à plier les webhooks dans Redis et à les traiter en un seul processus, nous avons élargi l'entonnoir en haut: il y avait également plus de webhooks entrants traités, mais le processus lui-même prenait encore un certain temps. Cette première décision n'a pas abouti.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'ils ont essayé d'augmenter le nombre de ces demandes, il y a eu un léger effondrement. La file d'attente peut accumuler des demandes de différentes pages, mais les demandes d'une page peuvent aller de suite. Si un gestionnaire est lent, les demandes d'un abonné et d'un bot seront traitées dans le mauvais ordre. L'utilisateur envoie des messages, effectue certaines actions avec le bot, mais reçoit une réponse au hasard. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela semble être un cas rare, mais des tests sur nos charges de travail ont montré que cela se produira fréquemment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons commencé à chercher une autre solution. Ici, la simplicité et la puissance de Redis sont venues à la rescousse - nous avons décidé de faire une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file d'attente pour chaque bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment ça fonctionne? Les messages relatifs à chaque bot sont ajoutés à la file d'attente. Afin de ne pas augmenter le gestionnaire à chaque file d'attente, nous avons créé une </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">file d'attente de contrôle</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Elle travaille comme ça. Chaque fois qu'une demande provient d'un bot, deux messages sont publiés dans Redis: un dans la file d'attente du bot, le second dans le contrôle. Le gestionnaire surveille le contrôle et chaque fois qu'il démarre le démon lorsqu'il y a une tâche pour traiter le bot. Le démon ratisse la file d'attente du bot correspondant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de la tâche principale, nous avons résolu le problème des «voisins bruyants». C'est à ce moment-là qu'un bot a généré une énorme masse de webhooks et cela ralentit le système, car d'autres pages sont en attente de traitement. Pour résoudre le problème, il suffit d' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">évoluer</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : lorsque la file d'attente de contrôle est pleine, nous ajoutons de nouveaux gestionnaires.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, les </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">files d'attente sont virtuelles</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ce ne sont que des cellules de la mémoire Redis. </font><font style="vertical-align: inherit;">Quand il n'y a rien dans la file d'attente, ça n'existe pas, ça n'occupe rien.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janvier 2018</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nous avons atteint 1 milliard de publications par mois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La charge était de 5 000 RPS par système. Ce n'est pas une charge de pointe, mais standard. Lorsque des bots de chanteurs célèbres apparaissent, tout croît déjà plusieurs fois à partir de cette figure. Mais ce n'est pas un problème. Le problème est en PHP-FPM: il ne peut plus supporter la charge de 5 000 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout le monde à l'époque parlait de traitement asynchrone à la mode. Nous l'avons regardé de plus près, avons vu ReactPHP, effectué des tests rapides, l'avons remplacé par PHP-FPM et avons instantanément obtenu une augmentation de 4 fois. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous n'avons pas réécrit le traitement de notre traitement - ReactPHP a augmenté le cadre Yii. Tout d'abord, nous avons levé 4 services ReactPHP, et plus tard nous en avons atteint 30. Pendant longtemps, nous avons vécu sur eux, et le framework a fait face à la charge.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dès que nous avons élargi l'entonnoir, un autre effondrement s'est produit: après avoir démarré l'entonnoir à la réception, le traitement a recommencé à souffrir. </font><font style="vertical-align: inherit;">Pour résoudre ce problème déjà, nous avons décidé de séparer le traitement en clusters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clusters</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont pris des bots, les ont répartis en clusters et ont construit des chaînes logiques à partir de Redis, Postgres et d'un gestionnaire. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, nous avons formé le concept de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Galaxie» - une abstraction physique logique sur le traitement</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il se compose d'instances: Redis, PostgreSQL et un ensemble de services PHP. </font><font style="vertical-align: inherit;">Chaque bot appartient à un cluster particulier et ReactPHP sait dans quel cluster le message pour ce bot doit être placé. </font><font style="vertical-align: inherit;">Le schéma ci-dessus fonctionne plus loin. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'Univers est en expansion, l'Univers de nos systèmes aussi, et nous ajoutons un nouveau «Galaxy» lorsque cela se produit.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les galaxies sont notre méthode de mise à l'échelle.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remplacer ReactPHP par un tas de Nginx et Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours des six prochains mois, nous avons poursuivi notre croissance: 200 millions d'abonnés et 3 milliards de messages par mois. </font><font style="vertical-align: inherit;">Imaginez un site pour 200 millions d'utilisateurs enregistrés - la même charge. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un nouveau problème est apparu. </font><font style="vertical-align: inherit;">Les webhooks sont de petites tâches du même type et PHP n'est pas adapté pour les résoudre. </font><font style="vertical-align: inherit;">Même ReactPHP n'a plus aidé.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il ne pouvait pas supporter la charge de 10 000 RPS - depuis l'introduction de ReactPHP, la charge a augmenté.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il était nécessaire de le redémarrer même avec des déploiements, d'ailleurs, séquentiellement, car vous ne pouvez pas interrompre le traitement des webhooks entrants. </font><font style="vertical-align: inherit;">Facebook désactive l'application lorsqu'il se rend compte qu'il a des problèmes. </font><font style="vertical-align: inherit;">Pour ManyChat, c'est un désastre - 650 000 entreprises actives ne nous pardonneront pas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, nous avons progressivement supprimé une logique différente de ReactPHP, l'avons transmise aux processeurs et isolé de nouvelles files d'attente. Dans le processus, ils ont remarqué que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP effectue une tâche simple - il prend un webhook et le place dans une file d'attente</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tout le reste se fait par traitements. Existe-t-il des analogues pour une tâche aussi simple? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous nous sommes souvenus que Nginx avait des modules et </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avons</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> remarqué la bibliothèque </font><strong><font style="vertical-align: inherit;">OpenResty</font></strong><font style="vertical-align: inherit;"> . En plus de prendre en charge le langage de programmation Lua, elle avait un module pour travailler avec Redis. Un test écrit en 3 heures a montré que tout le travail de 30 services sur ReactPHP peut se faire directement du côté nginx. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici comment cela s'est avéré: nous traitons une sorte de point de terminaison, récupérons le corps de la demande et l'ajoutons directement à Redis.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty et Lua ont contribué à augmenter le débit. </font><font style="vertical-align: inherit;">Nous continuons à faire face à notre charge de travail, le service continue, tout le monde est heureux.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Améliorer la solution sur Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dernière étape ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">note: au moment du rapport</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">février 2019</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">500 millions d'abonnés envoient et reçoivent 7 millions de messages d'un million de bots chaque mois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est une étape pour améliorer notre solution sur Lua. </font><font style="vertical-align: inherit;">Supprimez progressivement une partie de la logique des files d'attente et transférez le traitement principal de la distribution des webhooks entre les systèmes à Lua. </font><font style="vertical-align: inherit;">Maintenant, nos systèmes sont plus productifs et moins dépendants. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous maintenons </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un traitement séparé et un traitement asynchrone</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le traitement concerne les statistiques et d'autres choses - c'est maintenant un système complètement différent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le système semble simple, mais il ne l'est pas. </font><font style="vertical-align: inherit;">Sous le capot, 500 services traitent leurs demandes. </font><font style="vertical-align: inherit;">L'ensemble du système fonctionne sur 50 instances Amazon: Redis, PostgreSQL et les gestionnaires PHP eux-mêmes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evolution du traitement</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La charge élevée peut être cool à faire en PHP.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rappelez-vous brièvement comment nous l'avons fait dans le cadre du développement du système.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commencé avec Nginx normal et PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout de files d'attente à PostgreSQL, puis à Redis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout de clustering.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implémentation de ReactPHP.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons remplacé ReactPHP par un groupe de Nginx et Lua, puis déplacé la logique vers le groupe.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'après notre expérience, nous avons découvert qu'il est possible de développer et de construire une architecture en changeant successivement les parties vulnérables, en utilisant des approches simples et bien connues et en même temps sans étendre la pile.</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr486844/">https://habr.com/ru/post/fr486844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486824/index.html">Mauvais conseils lorsque vous travaillez avec ANTLR</a></li>
<li><a href="../fr486826/index.html">Création d'un Viberbot à part entière sur Django 2 et l'API Viber REST. Première partie - Webhook</a></li>
<li><a href="../fr486828/index.html">Food Design Digest, janvier 2020</a></li>
<li><a href="../fr486832/index.html">Combien d'années vont la taïga - ne comprends pas</a></li>
<li><a href="../fr486842/index.html">Consul + iptables =: 3</a></li>
<li><a href="../fr486850/index.html">Nouveau siège réservé - comme un hôtel capsule</a></li>
<li><a href="../fr486858/index.html">Création d'un Viberbot à part entière. Deuxième partie - premier contact ou "conversion_started"</a></li>
<li><a href="../fr486860/index.html">ATX12VO - Manger d'une nouvelle façon</a></li>
<li><a href="../fr486862/index.html">5 raisons pour lesquelles le Motion Design vous aide à vous connecter avec les gens</a></li>
<li><a href="../fr486864/index.html">Migration d'OpenVPN vers WireGuard pour joindre des réseaux en un seul réseau L2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>