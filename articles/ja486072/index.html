<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍒 🥝 💖 SQLハウツー：クエリで直接whileループを記述する、または「基本的な3方向」 🧖🏾 😵 🙅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="必要な合計レコード数を入力するまで、一連のキーの関連データを見つけるタスクが定期的に発生します。
 
 最も「重要な」例は、従業員のリストにリストされている最も古い20のタスク（たとえば、同じユニット内）を導出することです。現場で簡単に絞られるさまざまな経営上の「ダッシュボード」では、同様のトピック...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SQLハウツー：クエリで直接whileループを記述する、または「基本的な3方向」</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/486072/"><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要な合計レコード数を入力するまで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、一連のキーの関連データを見つけるタスクが定期的に発生し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も「重要な」例は</font><b><font style="vertical-align: inherit;">、従業員のリストにリスト</font></b><font style="vertical-align: inherit;">さ</font><b><font style="vertical-align: inherit;">れている</font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最も古い20のタスク</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（たとえば、同じユニット内）</font><font style="vertical-align: inherit;">を導出すること</font><font style="vertical-align: inherit;">です。現場で簡単に絞られるさまざまな経営上の「ダッシュボード」では、同様のトピックが必要になることがよくあります。</font><font style="vertical-align: inherit;">
記事では、我々はこのような問題を解決する「ナイーブ」バージョンのPostgreSQLの上の実装を検討する、「賢く」と非常に複雑な</font><b><font style="vertical-align: inherit;">SQL「サイクル」</font></b><font style="vertical-align: inherit;">アルゴリズム</font><b><font style="vertical-align: inherit;">見つかったデータから出口までの条件付き</font></b><font style="vertical-align: inherit;">一般的な開発のためにと他の似たようなケースで使用するために、両方の役に立つことができ、 。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/wg/ym/ro/wgymroccelufplrzf4niaa5cdta.png"><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
からテストデータセットを取得します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">表示されたレコードが、ソートされた値が一致するときに時々「ジャンプ」しないように、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主キーを追加して件名インデックスを拡張します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">同時に、これによりすぐに一意性が得られ、並べ替え順序の一意性が保証されます。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> task(owner_id, task_date, <span class="hljs-keyword">id</span>);
<span class="hljs-comment">--   - </span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> task_owner_id_task_date_idx;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聞かれるように書いてあります</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配列</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の実行者のIDを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">入力パラメーターとして</font></a><font style="vertical-align: inherit;">渡し、リクエストの最も単純なバージョンの概要を示し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  task<font></font>
<span class="hljs-keyword">WHERE</span>
  owner_id = <span class="hljs-keyword">ANY</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512}'</span>::<span class="hljs-built_in">integer</span>[])
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  task_date, <span class="hljs-keyword">id</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/i_/nu/pd/i_nupdxu_ngr4ngjrsex4usjpki.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
少し悲しいです-注文したレコードは20件だけで、Index Scanは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">960行</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を返しました</font><font style="vertical-align: inherit;">。後でソートする必要がありました...そして、少しだけ読んでみましょう。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unnest + ARRAY</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
役立つ最初の考慮事項は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソートされた</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レコードが</font><b><font style="vertical-align: inherit;">20だけ</font></b><font style="vertical-align: inherit;">必要な場合</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、各</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キー</font><i><font style="vertical-align: inherit;">に対して同じ順序でソートされた</font></i><font style="vertical-align: inherit;">レコード</font><i><font style="vertical-align: inherit;">を20以下しか</font></i><font style="vertical-align: inherit;">読め</font><i><font style="vertical-align: inherit;">ないことです</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">幸い、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">適切なインデックス</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（owner_id、task_date、id）があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、抽出しての「列に反転させる」ために同じメカニズムを使用する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全体的なテーブルエントリ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のように</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">また、関数を使用して配列にたたみ込みを適用します</font></font><code>ARRAY()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">unnest</span>(<span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span><font></font>
        t<font></font>
      <span class="hljs-keyword">FROM</span><font></font>
        task t<font></font>
      <span class="hljs-keyword">WHERE</span>
        owner_id = <span class="hljs-keyword">unnest</span>
      <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
        task_date, <span class="hljs-keyword">id</span>
      <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span> <span class="hljs-comment">--  ...</span><font></font>
    )) r<font></font>
  <span class="hljs-keyword">FROM</span>
    <span class="hljs-keyword">unnest</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512}'</span>::<span class="hljs-built_in">integer</span>[])<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  (r).*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  T<font></font>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  (r).task_date, (r).id<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>; <span class="hljs-comment">-- ...   - </span></code></pre><br>
<img src="https://habrastorage.org/webt/lw/gl/bd/lwglbdeknjvlkl4bmdq6z8rgo-g.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ああ、もうかなり良いです！</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40％高速で、4.5分の1のデータ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を読み取る必要がありました。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTEによるテーブルエントリの具体化</font></font></b><div class="spoiler_text"> ,  <i>  </i>           ,  «»  CTE    <b>«» InitPlan</b>     :<br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  ((<font></font>
    <span class="hljs-keyword">SELECT</span><font></font>
      t<font></font>
    <span class="hljs-keyword">FROM</span><font></font>
      task t<font></font>
    <span class="hljs-keyword">WHERE</span>
      owner_id = <span class="hljs-number">1</span>
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
      task_date, <span class="hljs-keyword">id</span>
    <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>
  ).*);</code></pre><br>
<pre><code class="plaintext hljs">Result  (cost=4.77..4.78 rows=1 width=16) (actual time=0.063..0.063 rows=1 loops=1)<font></font>
  Buffers: shared hit=16<font></font>
  InitPlan 1 (returns $0)<font></font>
    -&gt;  Limit  (cost=0.42..1.19 rows=1 width=48) (actual time=0.031..0.032 rows=1 loops=1)<font></font>
          Buffers: shared hit=4<font></font>
          -&gt;  Index Scan using task_owner_id_task_date_id_idx on task t  (cost=0.42..387.57 rows=500 width=48) (actual time=0.030..0.030 rows=1 loops=1)<font></font>
                Index Cond: (owner_id = 1)<font></font>
                Buffers: shared hit=4<font></font>
  InitPlan 2 (returns $1)<font></font>
    -&gt;  Limit  (cost=0.42..1.19 rows=1 width=48) (actual time=0.008..0.009 rows=1 loops=1)<font></font>
          Buffers: shared hit=4<font></font>
          -&gt;  Index Scan using task_owner_id_task_date_id_idx on task t_1  (cost=0.42..387.57 rows=500 width=48) (actual time=0.008..0.008 rows=1 loops=1)<font></font>
                Index Cond: (owner_id = 1)<font></font>
                Buffers: shared hit=4<font></font>
  InitPlan 3 (returns $2)<font></font>
    -&gt;  Limit  (cost=0.42..1.19 rows=1 width=48) (actual time=0.008..0.008 rows=1 loops=1)<font></font>
          Buffers: shared hit=4<font></font>
          -&gt;  Index Scan using task_owner_id_task_date_id_idx on task t_2  (cost=0.42..387.57 rows=500 width=48) (actual time=0.008..0.008 rows=1 loops=1)<font></font>
                Index Cond: (owner_id = 1)<font></font>
                Buffers: shared hit=4"<font></font>
  InitPlan 4 (returns $3)<font></font>
    -&gt;  Limit  (cost=0.42..1.19 rows=1 width=48) (actual time=0.009..0.009 rows=1 loops=1)<font></font>
          Buffers: shared hit=4<font></font>
          -&gt;  Index Scan using task_owner_id_task_date_id_idx on task t_3  (cost=0.42..387.57 rows=500 width=48) (actual time=0.009..0.009 rows=1 loops=1)<font></font>
                Index Cond: (owner_id = 1)<font></font>
                Buffers: shared hit=4<font></font>
</code></pre><br>
     «» 4 …   PostgreSQL 11    ,    «»  CTE,         .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再帰バッテリー</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前のバージョンでは</font><font style="vertical-align: inherit;">、必要な20のために</font><font style="vertical-align: inherit;">合計</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">200行</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を読み取りました</font><font style="vertical-align: inherit;">。すでに960ではありませんが、それより少ないですが、それは可能ですか？</font><b><font style="vertical-align: inherit;">20</font></b><font style="vertical-align: inherit;">エントリ</font><b><font style="vertical-align: inherit;">しか</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
必要</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">という知識を使用してみましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">つまり、必要な量に達するまで、データの校正を繰り返すだけです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ1：リストを開始する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、20エントリの「ターゲット」リストは、owner_idキーの1つの「最初の」エントリで始まる必要があります。</font><font style="vertical-align: inherit;">したがって、最初に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、各キーに対してその</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ような</font><b><font style="vertical-align: inherit;">「非常に最初」</font></b><font style="vertical-align: inherit;">を見つけ、</font><font style="vertical-align: inherit;">それをリストに入れ、希望する順序でソートします-（task_date、id）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fg/4v/mx/fg4vmxjnrahhsxdfhemzvn3ni94.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ2：「次の」エントリを見つける</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、リストから最初のレコードを取得し</font><font style="vertical-align: inherit;">、owner_idキーを保持しながら</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">さらに「ステップ」し</font></b><font style="vertical-align: inherit;">始めると</font><font style="vertical-align: inherit;">、見つかったすべてのレコードが結果の選択の次のレコードになります。もちろん、</font><font style="vertical-align: inherit;">リストの2番目のエントリの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションキーを通過するまで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のみ</font><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のレコードを「クロス」したことが判明した場合</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、最初に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（同じowner_idで）の</font><b><font style="vertical-align: inherit;">代わりに最後に読み取ったレコードをリストに追加する必要があります</font></b><font style="vertical-align: inherit;">。その後、リストを再度ソートします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8o/34/ys/8o34ys-xy6jx3xssklqneevd3-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、リストには各キーのレコードが1つしかないことが常にわかります（レコードが終わったが、「クロス」しなかった場合、リストの最初のレコードは単に非表示になり、何も追加されません）。それらは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常にソートされます。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> アプリケーションキー（task_date、id）の昇順。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k6/ep/l7/k6epl7igxmourdb6-gi1zzlxlvw.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ3：レコードをフィルタリングして「拡張」する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再帰的な選択の行の一部で、いくつかのエントリが</font></font><code>rv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重複し</font><font style="vertical-align: inherit;">ています。</font><font style="vertical-align: inherit;">最初に「リストの2番目のエントリの交差する境界」などを見つけてから、リストの最初の</font><font style="vertical-align: inherit;">エントリ</font><font style="vertical-align: inherit;">として置き換えます。</font><font style="vertical-align: inherit;">したがって、最初の外観はフィルタリングする必要があります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怖い最終クエリ</font></font></b><div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> T <span class="hljs-keyword">AS</span> (
  <span class="hljs-comment">-- #1 :    ""      </span>
  <span class="hljs-keyword">WITH</span> wrap <span class="hljs-keyword">AS</span> ( <span class="hljs-comment">-- "" record',        InitPlan/SubPlan</span>
    <span class="hljs-keyword">WITH</span> T <span class="hljs-keyword">AS</span> (
      <span class="hljs-keyword">SELECT</span><font></font>
        (<font></font>
          <span class="hljs-keyword">SELECT</span><font></font>
            r<font></font>
          <span class="hljs-keyword">FROM</span><font></font>
            task r<font></font>
          <span class="hljs-keyword">WHERE</span>
            owner_id = <span class="hljs-keyword">unnest</span>
          <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
            task_date, <span class="hljs-keyword">id</span>
          <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span><font></font>
        ) r<font></font>
      <span class="hljs-keyword">FROM</span>
        <span class="hljs-keyword">unnest</span>(<span class="hljs-string">'{1,2,4,8,16,32,64,128,256,512}'</span>::<span class="hljs-built_in">integer</span>[])<font></font>
    )<font></font>
    <span class="hljs-keyword">SELECT</span>
      array_agg(r <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (r).task_date, (r).id) <span class="hljs-keyword">list</span> <span class="hljs-comment">--     </span>
    <span class="hljs-keyword">FROM</span><font></font>
      T<font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">list</span>
  , <span class="hljs-keyword">list</span>[<span class="hljs-number">1</span>] rv<font></font>
  , <span class="hljs-literal">FALSE</span> not_cross<font></font>
  , <span class="hljs-number">0</span> <span class="hljs-keyword">size</span>
  <span class="hljs-keyword">FROM</span><font></font>
    wrap<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  <span class="hljs-comment">-- #2 :   1-   ,      2-</span>
  <span class="hljs-keyword">SELECT</span>
    <span class="hljs-keyword">CASE</span>
      <span class="hljs-comment">--       1- </span>
      <span class="hljs-keyword">WHEN</span> X._r <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span>
        T.list[<span class="hljs-number">2</span>:] <span class="hljs-comment">--    </span>
      <span class="hljs-comment">--       2- </span>
      <span class="hljs-keyword">WHEN</span> X.not_cross <span class="hljs-keyword">THEN</span>
        T.list <span class="hljs-comment">--       </span>
      <span class="hljs-comment">--      2- </span>
      <span class="hljs-keyword">WHEN</span> T.list[<span class="hljs-number">2</span>] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span>
        <span class="hljs-comment">--    </span>
        <span class="hljs-string">'{}'</span>
      <span class="hljs-comment">--  ,  1-      </span>
      <span class="hljs-keyword">ELSE</span> (
        <span class="hljs-keyword">SELECT</span>
          <span class="hljs-keyword">coalesce</span>(T.list[<span class="hljs-number">2</span>] || array_agg(r <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (r).task_date, (r).id), <span class="hljs-string">'{}'</span>)
        <span class="hljs-keyword">FROM</span>
          <span class="hljs-keyword">unnest</span>(T.list[<span class="hljs-number">3</span>:] || X._r) r<font></font>
      )<font></font>
    <span class="hljs-keyword">END</span><font></font>
  , X._r<font></font>
  , X.not_cross<font></font>
  , T.size + X.not_cross::<span class="hljs-built_in">integer</span>
  <span class="hljs-keyword">FROM</span><font></font>
    T<font></font>
  , <span class="hljs-keyword">LATERAL</span>(
      <span class="hljs-keyword">WITH</span> wrap <span class="hljs-keyword">AS</span> ( <span class="hljs-comment">-- "" record</span>
        <span class="hljs-keyword">SELECT</span>
          <span class="hljs-keyword">CASE</span>
            <span class="hljs-comment">--  - ""  2- </span>
            <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">NOT</span> T.not_cross
              <span class="hljs-comment">--    -   </span>
              <span class="hljs-keyword">THEN</span> T.list[<span class="hljs-number">1</span>]
            <span class="hljs-keyword">ELSE</span> ( <span class="hljs-comment">--   ,        -   </span>
              <span class="hljs-keyword">SELECT</span><font></font>
                _r<font></font>
              <span class="hljs-keyword">FROM</span><font></font>
                task _r<font></font>
              <span class="hljs-keyword">WHERE</span>
                owner_id = (rv).owner_id <span class="hljs-keyword">AND</span>
                (task_date, <span class="hljs-keyword">id</span>) &gt; ((rv).task_date, (rv).id)
              <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
                task_date, <span class="hljs-keyword">id</span>
              <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span><font></font>
            )<font></font>
          <span class="hljs-keyword">END</span> _r<font></font>
      )<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        _r<font></font>
      , <span class="hljs-keyword">CASE</span>
          <span class="hljs-comment">--  2-     ,    - </span>
          <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">list</span>[<span class="hljs-number">2</span>] <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span> _r <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-literal">TRUE</span>
          <span class="hljs-keyword">ELSE</span> <span class="hljs-comment">--     ""</span>
            <span class="hljs-keyword">coalesce</span>(((_r).task_date, (_r).id) &lt; ((<span class="hljs-keyword">list</span>[<span class="hljs-number">2</span>]).task_date, (<span class="hljs-keyword">list</span>[<span class="hljs-number">2</span>]).id), <span class="hljs-literal">FALSE</span>)
        <span class="hljs-keyword">END</span> not_cross
      <span class="hljs-keyword">FROM</span><font></font>
        wrap<font></font>
    ) X<font></font>
  <span class="hljs-keyword">WHERE</span>
    T.size &lt; <span class="hljs-number">20</span> <span class="hljs-keyword">AND</span> <span class="hljs-comment">--   </span>
    T.list <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">'{}'</span> <span class="hljs-comment">--     </span><font></font>
)<font></font>
<span class="hljs-comment">-- #3 : ""  -    </span>
<span class="hljs-keyword">SELECT</span><font></font>
  (rv).*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  T<font></font>
<span class="hljs-keyword">WHERE</span>
  not_cross; <span class="hljs-comment">--   "" </span></code></pre></div></div><br>
<img src="https://habrastorage.org/webt/qu/bf/zh/qubfzhs-uv6fk5_nhdnat2lwdb4.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[explain.tensor.ruを見てください]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
したがって、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ読み取りの50％をランタイムの20％に交換しました</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">つまり、読み取りが長くなる可能性があると考える理由がある場合（たとえば、データがキャッシュにないことが多く、そのためにディスクにアクセスする必要がある場合）、この方法では、読み取りを少なくして依存できます。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いずれにしても、実行時間は「ナイーブ」な最初のバージョンよりも優れています。</font><font style="vertical-align: inherit;">しかし、これらの3つのオプションのどれを使用するか-あなたが選択します。</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja486060/index.html">ITの混乱の中で秩序を見つける：独自の開発を組織する</a></li>
<li><a href="../ja486062/index.html">QMLのハードウェアアクセラレーションビデオの単純なゼロコピーレンダリング</a></li>
<li><a href="../ja486064/index.html">アニメーション化されたCSSスライドショーを作成する</a></li>
<li><a href="../ja486066/index.html">アクセスエリア。ポイントからエリアまでの距離を検出し、逆ジオコーディングの要求を減らす</a></li>
<li><a href="../ja486070/index.html">ACLスイッチの詳細</a></li>
<li><a href="../ja486076/index.html">地上からFPVクワッドコプターへ：はじめに</a></li>
<li><a href="../ja486080/index.html">ご紹介しましょう：Veeam Availability Suite v10</a></li>
<li><a href="../ja486082/index.html">ダガズ：テクノロジーの総和</a></li>
<li><a href="../ja486084/index.html">Linuxでの小さなディスクから大きなディスクへの置き換え</a></li>
<li><a href="../ja486092/index.html">マリーナアレックス、ビジネス大学アジリティのCEO：「アジャイルはITの外にあります。アジャイル-IT以上</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>