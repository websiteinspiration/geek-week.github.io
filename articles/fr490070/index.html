<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•Å üî∑ üñêüèæ Comme j'ai √©crit mon messager üßíüèª üòã üë©üèº‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un soir, apr√®s une autre journ√©e frustrante, remplie de tentatives d'√©quilibrer le jeu, j'ai d√©cid√© que j'avais un besoin urgent de repos. Je vais pas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comme j'ai √©crit mon messager</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490070/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un soir, apr√®s une autre journ√©e frustrante, remplie de tentatives d'√©quilibrer le jeu, j'ai d√©cid√© que j'avais un besoin urgent de repos. </font><font style="vertical-align: inherit;">Je vais passer √† un autre projet, le faire rapidement, rendre l‚Äôestime de soi qui a baiss√© au cours du d√©veloppement du jeu et qui va prendre le jeu par la temp√™te avec une vigueur renouvel√©e! </font><font style="vertical-align: inherit;">L'essentiel est de choisir un projet agr√©able et relaxant ... Ecrivez votre propre messager? </font><font style="vertical-align: inherit;">Ha! </font><font style="vertical-align: inherit;">√Ä quel point cela peut-il √™tre dur? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code peut √™tre trouv√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><img src="https://habrastorage.org/webt/_b/cw/av/_bcwavbn-h0r3vgv8zzhdkaq09y.jpeg"></td>
<td><img src="https://habrastorage.org/webt/97/4x/qd/974xqd470ltfwu6gge0hfnaqry4.jpeg"></td>
</tr>
</tbody></table></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bref historique</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendant pr√®s d'un an avant de commencer √† travailler sur le messager, il travaillait sur le jeu en ligne multijoueur Line Tower Wars. </font><font style="vertical-align: inherit;">La programmation s'est bien pass√©e, tout le reste (√©quilibre et visuel en particulier) n'√©tait pas tr√®s bon. </font><font style="vertical-align: inherit;">Soudain, il s'est av√©r√© que faire un jeu et faire un jeu amusant (amusant pour quelqu'un d'autre que lui-m√™me) sont deux choses diff√©rentes. </font><font style="vertical-align: inherit;">Apr√®s un an d'√©preuve, j'avais besoin de me laisser distraire, alors j'ai d√©cid√© de m'essayer √† autre chose. </font><font style="vertical-align: inherit;">Le choix s'est port√© sur le d√©veloppement mobile, √† savoir Flutter. </font><font style="vertical-align: inherit;">J'ai entendu beaucoup de bonnes choses √† propos de Flutter, et j'ai aim√© la fl√©chette apr√®s une courte exp√©rience. </font><font style="vertical-align: inherit;">J'ai d√©cid√© d'√©crire mon propre messager. </font><font style="vertical-align: inherit;">Tout d'abord, il est recommand√© d'impl√©menter √† la fois le client et le serveur. </font><font style="vertical-align: inherit;">Deuxi√®mement, il y aura quelque chose d'important √† mettre dans le portefeuille pour chercher du travail, je suis juste dans le processus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonctionnalit√© planifi√©e</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Discussions priv√©es et en groupe</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de texte, d'images et de vid√©os</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appels audio et vid√©o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirmation de r√©ception et lecture (ticks de Votsap)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Impressions ..."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherche par code QR et g√©olocalisation</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'avenir, je peux dire avec fiert√© (et avec soulagement) que presque tout ce qui est pr√©vu a √©t√© mis en ≈ìuvre, et qui n'a pas encore √©t√© mis en ≈ìuvre - le sera dans un proche avenir.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://player.vimeo.com/video/393246625" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©lection de la langue</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas r√©fl√©chi longtemps au choix de la langue. </font><font style="vertical-align: inherit;">Au d√©but, il √©tait tentant d'utiliser la fl√©chette pour le client et le serveur, mais une inspection plus d√©taill√©e a montr√© qu'il n'y avait pas beaucoup de pilotes pour les fl√©chettes disponibles, et ceux qui n'inspiraient pas beaucoup de confiance. </font><font style="vertical-align: inherit;">Bien que je ne me porte pas garant de parler de l'instant pr√©sent, la situation s'est peut-√™tre am√©lior√©e. </font><font style="vertical-align: inherit;">Mon choix s'est donc port√© sur C #, avec lequel j'ai travaill√© dans Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a commenc√© par r√©fl√©chir √† l'architecture. </font><font style="vertical-align: inherit;">Bien s√ªr, √©tant donn√© que 3 personnes et demie utiliseront tr√®s probablement mon messager, on n'aurait pas √† se soucier de l'architecture en g√©n√©ral. </font><font style="vertical-align: inherit;">Vous prenez et faites comme dans d'innombrables tutoriels. </font><font style="vertical-align: inherit;">Voici le n≈ìud, voici le mongo, voici les sockets web. </font><font style="vertical-align: inherit;">Termin√©. </font><font style="vertical-align: inherit;">Et Firebase est ici. </font><font style="vertical-align: inherit;">Mais ce n'est pas int√©ressant. </font><font style="vertical-align: inherit;">J'ai d√©cid√© de cr√©er un messager qui peut facilement √©voluer horizontalement, comme si j'attendais des millions de clients simultan√©s. </font><font style="vertical-align: inherit;">Cependant, n'ayant aucune exp√©rience dans ce domaine, j'ai d√ª tout apprendre en pratique par la m√©thode des erreurs et encore des erreurs.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'architecture finale ressemble √† ceci</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/xp/jc/n7/xpjcn7otuw8am5jv9yztpp1sgyu.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne pr√©tends pas qu'une telle architecture est super cool et fiable, mais elle est viable et </font><font style="vertical-align: inherit;">devrait </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en th√©orie</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> r√©sister √† de lourdes charges et √©voluer horizontalement, mais je ne comprends pas vraiment comment v√©rifier. </font><font style="vertical-align: inherit;">Et j'esp√®re que je n'ai pas manqu√© un moment √©vident qui est connu de tout le monde sauf moi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous trouverez ci-dessous une description d√©taill√©e des composants individuels.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur frontal</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant m√™me de commencer √† cr√©er le jeu, j'√©tais fascin√© par le concept d'un serveur asynchrone √† thread unique. </font><font style="vertical-align: inherit;">Effectivement et sans race'ov potentielle - que pouvez-vous demander d'autre. </font><font style="vertical-align: inherit;">Afin de comprendre comment ces serveurs sont organis√©s, j'ai commenc√© √† me plonger dans le module de </font></font><code>asyncio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">langage python. </font><font style="vertical-align: inherit;">La solution que j'ai vue semblait tr√®s √©l√©gante. </font><font style="vertical-align: inherit;">En bref, la solution de pseudo-code ressemble √† ceci.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-comment">//  ,      ,    </span>
<span class="hljs-comment">//       .      socket.Receive</span>
<span class="hljs-comment">//     , :</span>
<span class="hljs-keyword">var</span> bytesReceived = Completer&lt;<span class="hljs-keyword">object</span>&gt;();<font></font>
selector.Register(<font></font>
    socket,<font></font>
    SocketEvent.Receive,<font></font>
    () =&gt; bytesReceived.Complete(<span class="hljs-literal">null</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">await</span> bytesReceived.Future;<font></font>
<font></font>
<span class="hljs-keyword">int</span> n = socket.Receive(...); <span class="hljs-comment">//   </span><font></font>
<font></font>
<span class="hljs-comment">// selector -     poll.   </span>
<span class="hljs-comment">//        (Receive </span>
<span class="hljs-comment">//  ), ,    ,  .</span>
<span class="hljs-comment">//   completer,      ,</span>
<span class="hljs-comment">//        , ,     .</span>
<span class="hljs-comment">//     ,       .</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant cette technique simple, nous pouvons servir un grand nombre de sockets dans un seul thread. </font><font style="vertical-align: inherit;">Nous ne bloquons jamais un flux en attendant la r√©ception ou l'envoi d'octets. </font><font style="vertical-align: inherit;">Le flux est toujours occup√© par un travail utile. </font><font style="vertical-align: inherit;">Concurrence, en un mot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les serveurs frontaux sont impl√©ment√©s de cette fa√ßon. </font><font style="vertical-align: inherit;">Ils sont tous √† un seul thread et asynchrones. </font><font style="vertical-align: inherit;">Par cons√©quent, pour des performances maximales, vous devez ex√©cuter autant de serveurs sur une seule machine que de c≈ìurs (4 sur la photo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur Frontend lit le message du client et, en fonction du code du message, l'envoie √† l'une des rubriques de Kafka.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une petite note de bas de page pour ceux qui ne connaissent pas kafa</font></font></b><div class="spoiler_text">   ,          RabbitMQ.    .       ,              (   authentication backend     authentication, ).  ?      -  ,         (partition).      ,      .      ,   ,       . ,             ( ,   ,  ,     (headers)).<br>
<br>
  ?     ?      .   (consumer)         (  consumer'),    ( )      . , ,      ,    2 ,       .   3 ‚Äî     2.                .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur frontal envoie un message √† la kafka sans cl√© (lorsqu'il n'y a pas de cl√©, la kafka envoie simplement des messages √† la partie √† son tour). Le message est extrait de la rubrique par l'un des serveurs principaux correspondants. Le serveur traite le message et ... et ensuite? Et ce qui d√©pend en plus du type de message. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas le plus courant, un cycle demande-r√©ponse se produit. Par exemple, pour une demande d'inscription, il suffit de donner une r√©ponse au client ( </font></font><code>Success</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code>EmailAlreadyInUse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, etc). Mais √† un message contenant une invitation √† un chat existant de nouveaux membres (Vasya, Emil et Julia), nous devons r√©pondre imm√©diatement avec trois types de messages diff√©rents. Le premier type - vous devez informer l'invitateur du r√©sultat de l'op√©ration (soudain, une erreur de serveur s'est produite). Le deuxi√®me type - vous devez informer tous les membres actuels du chat qu'il y a maintenant tel ou tel nouveau membre dans le chat. La troisi√®me consiste √† envoyer des invitations √† Vasya, Emil et Yulia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, cela ne semble pas tr√®s difficile, mais pour envoyer un message √† un client, nous devons: 1) savoir √† quel serveur frontal ce client est connect√© (nous ne choisissons pas le serveur auquel le client se connectera, l'√©quilibreur d√©cide pour nous); 2) envoyer un message du serveur principal au serveur frontal souhait√©; 3) en fait, envoyez un message au client.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour impl√©menter les points 1 et 2, j'ai d√©cid√© d'utiliser une rubrique distincte (rubrique "serveurs frontaux"). La s√©paration des th√®mes d'authentification, de session et d'appel en partitions sert de m√©canisme de parall√©lisation. Nous voyons que le serveur de session est lourdement charg√©? Nous venons d'ajouter quelques nouveaux serveurs de partition et de session, et Kafka redistribuera la charge pour nous, d√©chargeant les serveurs de session existants. La s√©paration de la rubrique "serveurs frontaux" dans la partition sert de m√©canisme de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">routage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque serveur frontal correspond √† une partie de la rubrique "serveurs frontaux" (avec le m√™me index que le serveur lui-m√™me). Autrement dit, serveur 0 - partition 0, et ainsi de suite. Kafka permet de souscrire non seulement √† un sujet sp√©cifique, mais aussi √† une partie sp√©cifique d'un certain sujet. Tous les serveurs frontaux des startups s'abonnent √† la partition correspondante. Ainsi, le serveur principal est capable d'envoyer un message √† un serveur frontal sp√©cifique en envoyant un message √† une partition sp√©cifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, maintenant, lorsque le client se joint, il vous suffit d'enregistrer quelque part une paire de UserId - Frontend Server Index. En cas de d√©connexion - supprimer. √Ä ces fins, n'importe laquelle des nombreuses bases de donn√©es de valeurs-cl√©s en m√©moire fera l'affaire. J'ai choisi un radis.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä quoi cela ressemble dans la pratique. </font><font style="vertical-align: inherit;">Tout d'abord, une fois la connexion √©tablie, le client Andrey envoie un message au serveur </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le serveur frontend re√ßoit le message et le transmet √† la rubrique de session, en ajoutant pr√©alablement l'en-t√™te ¬´Frontend Server¬ª: {index}. </font><font style="vertical-align: inherit;">L'un des serveurs de session d'arri√®re-plan recevra un message, lira le jeton d'autorisation, d√©terminera le type d'utilisateur auquel il s'est joint, lira l'index ajout√© par le serveur frontal et √©crira UserId - Index sur le radis. </font><font style="vertical-align: inherit;">√Ä partir de ce moment, le client est consid√©r√© comme √©tant en ligne, et maintenant nous savons par quel serveur frontal (et, par cons√©quent, par quelle partie de la rubrique "serveurs frontaux") nous pouvons "tendre la main" lorsque d'autres clients envoient des messages √† Andrey. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* En fait, le processus est un peu plus compliqu√© que je l'ai d√©crit. </font><font style="vertical-align: inherit;">Vous pouvez le trouver dans le code source.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pseudo-code du serveur frontal</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-comment">// Frontend Server 6</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">// Consume from "Frontend Servers" topic, partition 6</span>
    <span class="hljs-keyword">var</span> messageToClient = consumer.Consume();
    <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {<font></font>
        relayMessageToClient(messageToClient);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> callbacks = selector.Poll();
    <span class="hljs-keyword">while</span> (callbacks.TryDequeue(<span class="hljs-keyword">out</span> callback)) {<font></font>
        callback();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
    <span class="hljs-keyword">while</span> (!callAtQueue.IsEmpty &amp;&amp; callAtQueue.PeekPriority() &lt;= now) {<font></font>
        callAtQueue.Dequeue()();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (messagesToRelayToBackendServers.TryDequeue(<span class="hljs-keyword">out</span> messageFromClient)) {
        <span class="hljs-comment">// choose topic</span><font></font>
        producer.Produce(topic, messageFromClient);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a quelques astuces ici. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><code>relayMessageToClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ce sera une erreur de prendre simplement le socket que vous voulez et de commencer imm√©diatement √† lui envoyer un message, car nous </font><font style="vertical-align: inherit;">envoyons </font><font style="vertical-align: inherit;">peut-√™tre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©j√†</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un autre message au client. Si nous commen√ßons √† envoyer des octets sans v√©rifier si le socket est actuellement occup√©, les messages seront m√©lang√©s. Comme dans de nombreux autres endroits o√π un traitement ordonn√© des donn√©es est requis, l'astuce consiste √† utiliser une file d'attente, √† savoir une file d'attente de Completers ( </font></font><code>TaskCompletionSource</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en C #).</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-keyword">async</span> <span class="hljs-title">relayMessageToClient</span>(<span class="hljs-params">message</span>)</span> {
    <span class="hljs-comment">// find client</span>
    <span class="hljs-keyword">await</span> client.ReadyToSend();
    <span class="hljs-keyword">await</span> sendMessage(client, message);<font></font>
    client.CompleteSend();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> {
    <span class="hljs-comment">// ...</span>
    sendMessageQueue = <span class="hljs-keyword">new</span> LinkedList&lt;Completer&lt;<span class="hljs-keyword">object</span>&gt;&gt;();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">async</span> Future <span class="hljs-title">ReadyToSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = Completer&lt;<span class="hljs-keyword">object</span>&gt;();
	<span class="hljs-keyword">if</span> (sendMessageQueue.IsEmpty) {<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	} <span class="hljs-keyword">else</span> {
	    <span class="hljs-keyword">var</span> prevSendMessage = sendMessageQueue.Last;<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	    <span class="hljs-keyword">await</span> prevSendMessage.Future;<font></font>
	}<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CompleteSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = sendMessageQueue.RemoveFirst();<font></font>
	sendMessage.Complete(<span class="hljs-literal">null</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la file d'attente n'est pas vide, le socket est d√©j√† occup√© pour le moment. Cr√©ez-en un nouveau </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ajoutez-le √† la file d'attente et √† </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√©c√©dente</font></font></i> <code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ainsi, lorsque le message pr√©c√©dent est envoy√©, il </font></font><code>CompleteSend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se termine </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ce qui am√®ne le serveur √† commencer √† envoyer le message suivant. Une telle file d'attente permet √©galement de propager en douceur des exceptions. Supposons qu'une erreur s'est produite lors de l'envoi d'un message √† un client. Dans ce cas, nous devons terminer, √† l'exception de l'envoi non seulement de ce message, mais aussi de tous les messages qui sont actuellement en attente dans la file d'attente (attendez </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'ah). Si nous ne le faisons pas, ils continueront de se bloquer et nous recevrons une fuite de m√©moire. Par souci de concision, le code qui fait cela n'est pas affich√© ici. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2)</font></font><code>selector.Poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En fait, ce n‚Äôest m√™me pas une astuce, mais juste une tentative pour aplanir les lacunes de l‚Äôimpl√©mentation de la m√©thode </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>selector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- juste un wrapper sur cette m√©thode). Selon le syst√®me d'exploitation sous le capot, cette m√©thode utilise soit </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mais ce n'est pas important ici. L'important est de savoir comment cette m√©thode fonctionne avec les listes que nous alimentons en entr√©e (liste des sockets pour la lecture, l'√©criture, la v√©rification des erreurs). Cette m√©thode prend des listes, interroge les sockets et ne laisse que les sockets dans les listes qui sont pr√™ts √† effectuer l'op√©ration requise. Toutes les autres sockets sont supprim√©es des listes. "Coup de pied" se produit √† travers</font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(c'est-√†-dire que tous les √©l√©ments suivants sont d√©cal√©s, ce qui est inefficace). De plus, comme nous devons interroger toutes les sockets enregistr√©es √† chaque it√©ration du cycle, un tel ¬´nettoyage¬ª est g√©n√©ralement nuisible, nous devons √† nouveau remplir les listes √† chaque fois. Nous pouvons contourner tous ces probl√®mes en utilisant un probl√®me personnalis√© </font></font><code>List</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dont la </font><font style="vertical-align: inherit;">m√©thode </font><font style="vertical-align: inherit;">ne supprime pas l'√©l√©ment de la liste, mais le marque simplement comme supprim√©. La classe </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est mon impl√©mentation d'une telle liste. </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne fonctionne qu'avec la m√©thode </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ne convient √† rien d'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3)</font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dans la plupart des cas, le serveur frontal, apr√®s avoir envoy√© le message client au serveur principal, attend une r√©ponse (confirmation que l'op√©ration a r√©ussi, ou une erreur en cas de probl√®me). S'il n'attend pas de r√©ponse dans un d√©lai configurable, il envoie une erreur au client pour qu'il n'attende pas une r√©ponse qui ne viendra jamais. </font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est une file d'attente prioritaire. Imm√©diatement apr√®s que le serveur envoie le message √† Kafka, il fait quelque chose comme ceci:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
callAtQueue.Enqueue(callback, now + config.WaitForReplyMSec);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le rappel, l'attente d'une r√©ponse est annul√©e et l'envoi de l'erreur du serveur commence. Si une r√©ponse du serveur principal est re√ßue, le rappel ne fait rien. </font><font style="vertical-align: inherit;">Il n'y a aucun moyen de l' </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
utiliser </font></font><code>await Task.WhenAny(answerReceivedTask, Task.Delay(x))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, car le code apr√®s son </font></font><code>Task.Delay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ex√©cution est ex√©cut√© sur le thread du pool. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, en fait, tout sur les serveurs frontaux. Une l√©g√®re correction s'impose ici. En fait, le serveur n'est pas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compl√®tement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filetage simple. Bien s√ªr, kafka sous le capot utilise des threads, mais je veux dire le code de l'application. Le fait est que l'envoi d'un message sur le sujet de la kafka (produit) peut ne pas r√©ussir. En cas d'√©chec, Kafka r√©p√®te l'envoi d'un certain nombre de fois configurable, mais, si les d√©parts r√©p√©t√©s √©chouent, Kafka abandonne cette activit√© comme d√©sesp√©r√©e. Vous pouvez v√©rifier si le message a √©t√© envoy√© avec succ√®s ou non dans </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lequel nous passons √† la m√©thode </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kafka appelle ce gestionnaire dans le thread d'E / S du producteur (le thread qui envoie des messages). Nous devons nous assurer que le message a √©t√© envoy√© avec succ√®s, et sinon, annuler l'attente d'une r√©ponse du serveur principal (la r√©ponse ne viendra pas car la demande n'a pas √©t√© envoy√©e) et envoyer une erreur au client. Autrement dit, nous ne pouvons pas √©viter d'interagir avec un autre fil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Lors de la r√©daction d'un article, je me suis soudain rendu compte que nous ne pouvions pas passer </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† la m√©thode </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou simplement ignorer toutes les erreurs kafka (l'erreur sera toujours envoy√©e au client dans le d√©lai que j'ai d√©crit plus t√¥t) - alors tout notre code sera monotrame. </font><font style="vertical-align: inherit;">Maintenant, je pense √† mieux faire.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi, en fait, du kafka, pas du lapin?</font></font></b><div class="spoiler_text">,        ,   ,  , ,   RabbitMQ?        .  , ,   .     ?    ,         frontend .   ,     backend ,      ,          .    ,       ,     .   ,       error-prone.  ,     <code>basicGet</code> ,    ,   ,      .     .      <code>basicGet</code>,      ,       .          .<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur backend</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par rapport au serveur frontal, il n'y a pratiquement pas de points int√©ressants ici. </font><font style="vertical-align: inherit;">Tous les serveurs principaux fonctionnent de la m√™me mani√®re. </font><font style="vertical-align: inherit;">Au d√©marrage, le serveur s'abonne √† la rubrique (authentification, session ou appel selon le r√¥le), et la kafka lui assigne une ou plusieurs partitions. </font><font style="vertical-align: inherit;">Le serveur re√ßoit le message de Kafka, traite et envoie g√©n√©ralement un ou plusieurs messages en r√©ponse. </font><font style="vertical-align: inherit;">Code presque r√©el:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">long</span> lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">var</span> consumeResult = consumer.Consume(<font></font>
            TimeSpan.FromMilliseconds(config.Consumer.PollTimeoutMSec)<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (consumeResult != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> workUnit = <span class="hljs-keyword">new</span> WorkUnit() {<font></font>
                ConsumeResult = consumeResult,<font></font>
            };<font></font>
<font></font>
            LinkedList&lt;WorkUnit&gt; workUnits;<font></font>
            <span class="hljs-keyword">if</span> (partitionToWorkUnits.ContainsKey(consumeResult.Partition)) {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition];<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition] =<font></font>
                    <span class="hljs-keyword">new</span> LinkedList&lt;WorkUnit&gt;();<font></font>
            }<font></font>
<font></font>
            workUnits.AddLast(workUnit);<font></font>
<font></font>
            handleWorkUnit(workUnit);<font></font>
        }<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (<font></font>
            DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - lastCommitTime &gt;=<font></font>
            config.Consumer.CommitIntervalMSec<font></font>
        ) {<font></font>
            commitOffsets();<font></font>
	    lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quel genre de compensations engager?</font></font></b><div class="spoiler_text">       .   ‚Äî   (offset)    (0, 1  ).         0.        <code>TopicPartitionOffset</code>.    (consume)   ,   <code>ConsumeResult</code>, ,   ,   <code>TopicPartitionOffset</code>.     ?<br>
<br>
  at least once delivery,  ,              (    ).     ,           (commited) . ,  consumer         16,  ,  16 ,   ,      ,   .     -  consumer'     consumer'        ,    16 + 1 (   + 1).    17   .        N ,       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d√©sactiv√© la validation automatique et je me suis engag√©. Ceci est n√©cessaire car </font></font><code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lorsque le traitement du message est effectivement effectu√©, il s'agit d'une </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©thode, il n'y a donc aucune garantie que le message 5 sera trait√© avant le message 6. Kafka ne stocke qu'un seul d√©calage valid√© (et non un ensemble de d√©calage), respectivement, avant de valider le d√©calage 6, nous devons √©galement nous assurer que tous les messages pr√©c√©dents ont √©t√© trait√©s. En outre, un serveur principal peut consommer des messages de plusieurs partitions en m√™me temps et doit donc s'assurer qu'il valide le d√©calage correct sur la partition correspondante. Pour cela, nous utilisons une carte de hachage de la partition de formulaire: unit√©s de travail. Voici √† quoi ressemble le code </font></font><code>commitOffsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(du vrai code cette fois):</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commitOffsets</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">foreach</span> (LinkedList&lt;WorkUnit&gt; workUnits <span class="hljs-keyword">in</span> partitionToWorkUnits.Values) {<font></font>
        WorkUnit lastFinishedWorkUnit = <span class="hljs-literal">null</span>;<font></font>
        LinkedListNode&lt;WorkUnit&gt; workUnit;<font></font>
        <span class="hljs-keyword">while</span> ((workUnit = workUnits.First) != <span class="hljs-literal">null</span> &amp;&amp; workUnit.Value.IsFinished) {<font></font>
            lastFinishedWorkUnit = workUnit.Value;<font></font>
            workUnits.RemoveFirst();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (lastFinishedWorkUnit != <span class="hljs-literal">null</span>) {<font></font>
            offsets.Add(lastFinishedWorkUnit.ConsumeResult.TopicPartitionOffset);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (offsets.Count &gt; <span class="hljs-number">0</span>) {<font></font>
        consumer.Commit(offsets);<font></font>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> offset <span class="hljs-keyword">in</span> offsets) {<font></font>
            logger.Debug(<font></font>
                <span class="hljs-string">"{Identifier}: Commited offset {TopicPartitionOffset}"</span>,<font></font>
                identifier,<font></font>
                offset<font></font>
            );<font></font>
        }<font></font>
        offsets.Clear();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, nous parcourons les unit√©s, trouvons la derni√®re unit√© termin√©e √† ce moment, apr√®s quoi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'y en a pas de incompl√®te</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et validons le d√©calage correspondant. </font><font style="vertical-align: inherit;">Une telle boucle nous permet d'√©viter les commits "trou√©s". </font><font style="vertical-align: inherit;">Par exemple, si nous avons actuellement 4 unit√©s ( </font></font><code>0: Finished, 1: Not Finished, 2: Finished, 3: Finished</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), nous ne pouvons valider que la 0√®me unit√©, car si nous validons la 3√®me imm√©diatement, cela peut entra√Æner la perte potentielle de la 1√®re, si le serveur meurt en ce moment.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkUnit</span> {
    <span class="hljs-keyword">public</span> ConsumeResult&lt;Null, <span class="hljs-keyword">byte</span>[]&gt; ConsumeResult { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> finished = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsFinished =&gt; finished == <span class="hljs-number">1</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Finish</span>(<span class="hljs-params"></span>)</span> {<font></font>
        Interlocked.Increment(<span class="hljs-keyword">ref</span> finished);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
<code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme cela a √©t√© dit, la </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©thode et, en cons√©quence, est compl√®tement envelopp√©e </font></font><code>try-catch-finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En </font></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il appelle le service n√©cessaire, et en </font></font><code>finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>workUnit.Finish()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les services sont assez banals. </font><font style="vertical-align: inherit;">Ici, par exemple, quel code est ex√©cut√© lorsque l'utilisateur envoie un nouveau message:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;ServiceResult&gt; <span class="hljs-title">createShareItem</span>(<span class="hljs-params">CreateShareItemMessage msg</span>)</span> {
    <span class="hljs-keyword">byte</span>[] message;
    <span class="hljs-keyword">byte</span>[] messageToPals1 = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">int</span>?[] partitions1 = <span class="hljs-literal">null</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  UserId  .</span>
    <span class="hljs-keyword">long</span>? userId = hashService.ValidateSessionIdentifier(msg.SessionIdentifier);
    <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> shareItem = <span class="hljs-keyword">new</span> ShareItemModel(<font></font>
            requestIdentifier: msg.RequestIdentifier,<font></font>
            roomIdentifier: msg.RoomIdentifier,<font></font>
            creatorId: userId,<font></font>
            timeOfCreation: <span class="hljs-literal">null</span>,<font></font>
            type: msg.ShareItemType,<font></font>
            content: msg.Content<font></font>
        );<font></font>
<font></font>
        <span class="hljs-comment">//      null,</span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">long</span>? timeOfCreation = <span class="hljs-keyword">await</span> storageService.CreateShareItem(shareItem);
        <span class="hljs-keyword">if</span> (timeOfCreation != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//      .</span>
            List&lt;<span class="hljs-keyword">long</span>&gt; pals = <span class="hljs-keyword">await</span> inMemoryStorageService.GetRoomPals(<font></font>
                msg.RoomIdentifier<font></font>
            );<font></font>
            <span class="hljs-keyword">if</span> (pals == <span class="hljs-literal">null</span>) {
            	<span class="hljs-comment">//     -       .</span>
                pals = <span class="hljs-keyword">await</span> storageService.GetRoomPals(msg.RoomIdentifier);
                <span class="hljs-keyword">await</span> inMemoryStorageService.SaveRoomPals(msg.RoomIdentifier, pals);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-comment">//    ,  .</span><font></font>
            pals.Remove(userId.Value);<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (pals.Count &gt; <span class="hljs-number">0</span>) {
            	<span class="hljs-comment">//  ack,  ,    </span>
                <span class="hljs-comment">//    .</span>
                <span class="hljs-keyword">await</span> storageService.CreateAck(<font></font>
                    msg.RequestIdentifier, userId.Value, msg.RoomIdentifier,<font></font>
                    timeOfCreation.Value, pals<font></font>
                );<font></font>
<font></font>
                <span class="hljs-comment">// in -  UserId, out -   frontend ,</span>
                <span class="hljs-comment">//    .  -   -</span>
                <span class="hljs-comment">//   null.</span>
                partitions1 = <span class="hljs-keyword">await</span> inMemoryStorageService.GetUserPartitions(pals);<font></font>
<font></font>
                List&lt;<span class="hljs-keyword">long</span>&gt; onlinePals = getOnlinePals(pals, partitions1);<font></font>
<font></font>
                <span class="hljs-comment">//    ,       .</span>
                <span class="hljs-comment">//         .</span>
                <span class="hljs-keyword">if</span> (onlinePals.Count &gt; <span class="hljs-number">0</span>) {<font></font>
                    messageToPals1 = converterService.EncodeNewShareItemMessage(<font></font>
                        userId.Value, timeOfCreation.Value, onlinePals, shareItem<font></font>
                    );<font></font>
                    nullRepeatedPartitions(partitions1);<font></font>
                    <span class="hljs-comment">// -         </span>
                    <span class="hljs-comment">// frontend ,    null' .</span><font></font>
                }<font></font>
            }<font></font>
<font></font>
            message = converterService.EncodeSuccessfulShareItemCreationMessage(<font></font>
                msg.RequestIdentifier, timeOfCreation.Value<font></font>
            );<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            message = converterService.EncodeMessage(<font></font>
                MessageCode.RoomNotFound, msg.RequestIdentifier<font></font>
            );<font></font>
        }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        message = converterService.EncodeMessage(<font></font>
            MessageCode.UserNotFound, msg.RequestIdentifier<font></font>
        );<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServiceResult(<font></font>
        message: message, <span class="hljs-comment">//    .</span>
        messageToPals1: messageToPals1, <span class="hljs-comment">//  -    .</span><font></font>
        partitions1: partitions1<font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de donn√©es</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart des fonctionnalit√©s des services appel√©s par les serveurs backend consistent simplement √† ajouter de nouvelles donn√©es √† la base de donn√©es et √† traiter celles existantes. De toute √©vidence, la fa√ßon dont la base de donn√©es est organis√©e et comment nous fonctionnons est tr√®s importante pour le messager, et ici, je voudrais dire que j'ai abord√© la question du choix d'une base de donn√©es tr√®s soigneusement apr√®s avoir soigneusement √©tudi√© toutes les options, mais ce n'est pas le cas. Je viens de choisir CockroachDb car il promet beaucoup avec un minimum d'effort et poss√®de une syntaxe compatible postgres (j'ai d√©j√† travaill√© avec postgres). Il y avait des pens√©es d'utiliser Cassandra, mais √† la fin j'ai d√©cid√© de m'attarder sur quelque chose de familier. Je n'avais jamais travaill√© avec Kafka, ni avec Rabbit, ni avec Flutter and Dart, ni avec WebRtc, alors j'ai d√©cid√© de ne pas tra√Æner Cassandra aussi, parce que j'avais peur de me noyer dans une multitude de nouvelles technologies pour moi.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toutes les parties de mon projet, la conception de bases de donn√©es est la chose dont je doute le plus. Je ne suis pas s√ªr que les d√©cisions que j'ai prises soient vraiment de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bonnes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d√©cisions. Tout fonctionne, mais pourrait √™tre mieux fait. Par exemple, il existe des tables ShareRooms (lorsque j'appelle des chats) et ShareItems (lorsque j'appelle des messages). Ainsi, tous les utilisateurs entrant dans une pi√®ce sont enregistr√©s dans le champ jsonb de cette pi√®ce. C'est pratique, mais √©videmment tr√®s lent, donc je vais probablement le refaire en utilisant des cl√©s √©trang√®res. Ou, par exemple, la table ShareItems stocke </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tous les</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> messages. Ce qui est √©galement pratique, mais puisque ShareItems est l'une des tables les plus charg√©es (persistantes </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), il pourrait √™tre utile de cr√©er une nouvelle table pour chaque pi√®ce ou quelque chose comme √ßa. Kokroach diffuse des enregistrements sur diff√©rents n≈ìuds, en cons√©quence, vous devez soigneusement r√©fl√©chir √† l'enregistrement qui ira afin d'obtenir des performances maximales, mais je ne l'ai pas fait. En g√©n√©ral, comme on peut le comprendre √† partir de tout ce qui pr√©c√®de, les bases de donn√©es ne sont pas mon point fort. En ce moment, je teste g√©n√©ralement tout pour les postgres, et non les kokroach, car il y a moins de charge sur ma machine de travail, elle est d√©j√† si pauvre en charges qu'elle va bient√¥t d√©coller. Heureusement, le code pour postgres et kokroach diff√®re beaucoup, donc la commutation n'est pas difficile.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, je suis en train d'√©tudier le fonctionnement r√©el du cocroach (comment le mappage se produit entre SQL et la valeur-cl√© (le cocroach utilise RocksDb sous le capot), comment il r√©partit les donn√©es entre les n≈ìuds, les r√©pliques, etc.). Il valait bien s√ªr la peine d'√©tudier le cocotier avant de l'utiliser, mais mieux vaut tard que jamais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense que la base subira de grands changements lorsque je comprendrai mieux cette question. En ce moment, la table Acks me hante. Dans ce tableau, je stocke des donn√©es sur qui n'a pas encore re√ßu et qui n'a pas encore lu le message (pour afficher les coches de l'utilisateur). Il est facile d'informer l'utilisateur que son message a √©t√© lu si l'utilisateur est en ligne maintenant, mais sinon, nous devons enregistrer ces informations afin d'avertir l'utilisateur plus tard. Et comme les discussions de groupe sont disponibles, il ne suffit pas de stocker l'indicateur, vous avez besoin de donn√©es sur les utilisateurs individuels. Donc, ici, nous demandons directement l'utilisation de cha√Ænes de bits (une ligne pour les utilisateurs qui n'ont pas encore re√ßu, la seconde - pour ceux qui n'ont pas encore lu). Surtout le support kokroach </font></font><code>bit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>bit varying</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cependant, je n'ai jamais compris comment mettre en ≈ìuvre cette activit√©, √©tant donn√© que la composition des pi√®ces peut constamment changer. Pour que les cha√Ænes de bits conservent leur signification, les utilisateurs dans la salle doivent rester dans le m√™me ordre, ce qui est assez difficile √† faire lorsque, par exemple, certains utilisateurs quittent la salle. Il y a des options ici. Il vaut peut-√™tre la peine d'√©crire -1 au lieu de supprimer l'utilisateur du champ jsonb afin que l'ordre soit pr√©serv√©, ou d'utiliser une m√©thode de versioning, afin que nous sachions que cette cha√Æne de bits fait r√©f√©rence √† l'ordre des utilisateurs, qui √©tait alors √† l'√©poque, et non dans l'ordre actuel des utilisateurs. Je suis toujours en train de r√©fl√©chir √† une meilleure impl√©mentation de cette activit√©, mais pour le moment, ceux qui n'ont pas encore re√ßu et n'ont pas lu les utilisateurs ne sont que des champs jsonb. √âtant donn√© que la table Acks est √©crite avec chaque message, la quantit√© de donn√©es est importante.Bien que l'enregistrement, bien s√ªr, soit supprim√© lorsque le message est re√ßu et lu par tout le monde.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Battement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendant longtemps, j'ai travaill√© c√¥t√© serveur et utilis√© des clients de console simples pour le test, donc je n'ai m√™me pas cr√©√© de projet Flutter. </font><font style="vertical-align: inherit;">Et quand je l'ai cr√©√©, je pensais que la partie serveur √©tait une </font><font style="vertical-align: inherit;">partie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complexe</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et l'application est comme √ßa, poubelle, je vais le comprendre dans quelques jours. </font><font style="vertical-align: inherit;">En travaillant sur le serveur, j'ai cr√©√© Hello Worlds pour flutter plusieurs fois pour avoir une id√©e du cadre, et comme le messager n'a pas besoin d'interface utilisateur complexe, je pensais qu'il √©tait compl√®tement pr√™t. </font><font style="vertical-align: inherit;">Donc, l'interface utilisateur, vraiment, est une ordure, mais la mise en ≈ìuvre de la fonctionnalit√© m'a pos√© des probl√®mes (et elle sera toujours livr√©e, car tout n'est pas pr√™t).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion de l'√âtat</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le sujet le plus populaire. Il existe mille fa√ßons de g√©rer votre √©tat et l'approche recommand√©e est modifi√©e tous les six mois. Maintenant, le courant dominant est le fournisseur. Personnellement, j'ai choisi 2 fa√ßons pour moi: bloc et redux. Bloc (Business Logic Component) pour la gestion de l'√©tat local et redux pour la gestion globale. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloc n'est pas une sorte de biblioth√®que (bien que, bien s√ªr, il y ait aussi une biblioth√®que qui r√©duit le passe-partout, mais je ne l'utilise pas). Bloc est une approche bas√©e sur les flux. En g√©n√©ral, le dart est une langue assez agr√©able et les flux sont g√©n√©ralement si doux. L'essence de cette approche est que nous poussons toute la logique m√©tier dans les services et que nous communiquons entre l'interface utilisateur et les services via un contr√¥leur qui nous fournit diff√©rents flux. L'utilisateur a-t-il cliqu√© sur le bouton ¬´rechercher un contact¬ª? En utilisant</font></font><code>sink</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(l'autre extr√©mit√© du flux) nous envoyons un √©v√©nement au contr√¥leur </font></font><code>SearchContactsEvent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le contr√¥leur appellera le service souhait√©, attendra le r√©sultat et renverra la liste des utilisateurs √† l'interface utilisateur √©galement via le flux. L'interface utilisateur attend les r√©sultats √† l'aide de </font></font><code>StreamBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(widget qui est reconstruit chaque fois que de nouvelles donn√©es arrivent dans le flux auquel elles sont abonn√©es). En fait, c'est tout. Dans certains cas, nous devons mettre √† jour l'interface utilisateur sans aucune intervention de l'utilisateur (par exemple, lorsqu'un nouveau message est arriv√©), mais cela se fait √©galement facilement via les flux. En fait, un simple MVC avec des flux, pas de magie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par rapport √† d'autres approches, le bloc n√©cessite plus de passe-partout, mais, √† mon avis, il est pr√©f√©rable d'utiliser des solutions natives sans la participation de biblioth√®ques tierces, sauf si l'utilisation d'une solution tierce donne </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avantages. </font><font style="vertical-align: inherit;">Plus il y a d'abstractions en haut, plus il est difficile de comprendre ce qu'est l'erreur lorsqu'une erreur se produit. </font><font style="vertical-align: inherit;">Je ne consid√®re pas que les avantages du fournisseur soient suffisamment importants pour y basculer. </font><font style="vertical-align: inherit;">Mais j'ai peu d'exp√©rience dans ce domaine, il est donc probable que je changerai de camp √† l'avenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, √† propos de redux, et donc tout le monde sait tout, donc il n'y a rien √† dire. </font><font style="vertical-align: inherit;">De plus, je l'ai coup√© de l'application :) Je l'ai utilis√© pour g√©rer mon compte, mais ensuite, r√©alisant que dans ce cas il n'y a pas d'avantages particuliers par rapport au bloc, je l'ai coup√© pour ne pas trop tra√Æner. </font><font style="vertical-align: inherit;">Mais en g√©n√©ral, je consid√®re que redux est une chose utile pour g√©rer l'√©tat global.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La partie la plus atroce</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que dois-je faire si l'utilisateur envoie un message, mais avant qu'il ne soit envoy√©, la connexion Internet est perdue? Que dois-je faire si l'utilisateur a re√ßu une confirmation de lecture, mais qu'il a ferm√© l'application avant la mise √† jour de l'enregistrement correspondant dans la base de donn√©es? Que dois-je faire si l'utilisateur a invit√© son ami dans la chambre, mais avant que l'invitation ne soit envoy√©e, sa batterie est morte? Avez-vous d√©j√† pos√© des questions similaires? Je suis ici. Avant. Mais dans le processus de d√©veloppement, j'ai commenc√© √† me demander. √âtant donn√© que la connexion peut dispara√Ætre √† tout moment et que le t√©l√©phone s'√©teint √† tout moment, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> doit √™tre </font><b><font style="vertical-align: inherit;">confirm√©</font></b><font style="vertical-align: inherit;"> . Pas dr√¥le. Par cons√©quent, le tout premier message que le client envoie au serveur ( </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si vous vous en souvenez) n'est pas seulement </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Bonjour je suis en ligne¬ª</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Bonjour, je suis en ligne et voici les salles non confirm√©es, voici les remerciements non confirm√©s, voici les op√©rations d'adh√©sion aux salles non confirm√©es, et voici les derniers messages re√ßus par chambre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">" </font></i><font style="vertical-align: inherit;">Et le serveur r√©pond avec une feuille similaire: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Pendant que vous √©tiez hors ligne, tel ou tel vos messages ont √©t√© lus par tel ou tel utilisateur, et ils ont √©galement invit√© Petya dans cette salle, et Sveta a quitt√© cette salle, et vous avez √©t√© invit√© dans cette salle, mais pour ces deux salles ont 40 nouveaux postes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">" </font></i><font style="vertical-align: inherit;">J'aimerais vraiment savoir comment des choses similaires sont faites dans d'autres messagers, car ma mise en ≈ìuvre ne brille pas avec gr√¢ce.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Images</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le moment, vous pouvez envoyer du texte, du texte + des images et seulement des images. </font><font style="vertical-align: inherit;">Le t√©l√©chargement de vid√©os n'a pas encore √©t√© mis en ≈ìuvre. </font><font style="vertical-align: inherit;">Les images sont un peu compress√©es et enregistr√©es dans le stockage Firebase. </font><font style="vertical-align: inherit;">Le message lui-m√™me contient des liens. </font><font style="vertical-align: inherit;">√Ä la r√©ception du message, le client t√©l√©charge des images, g√©n√®re des miniatures et enregistre tout dans le syst√®me de fichiers. </font><font style="vertical-align: inherit;">Les chemins d'acc√®s aux fichiers sont √©crits dans la base de donn√©es. </font><font style="vertical-align: inherit;">Soit dit en passant, la g√©n√©ration de miniatures est le seul code ex√©cut√© sur un thread s√©par√©, car il s'agit d'une op√©ration lourde en calcul. </font><font style="vertical-align: inherit;">Je d√©marre simplement un flux de travail, je lui donne une image et en retour, je re√ßois une miniature. </font><font style="vertical-align: inherit;">Le code est extr√™mement simple, car dart fournit des abstractions pratiques pour travailler avec des flux.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThumbnailGeneratorService</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThumbnailGeneratorService</span> </span>{<font></font>
  SendPort _sendPort;<font></font>
  final Queue&lt;Completer&lt;Uint8List&gt;&gt; _completerQueue =<font></font>
      Queue&lt;Completer&lt;Uint8List&gt;&gt;();<font></font>
<font></font>
  ThumbnailGeneratorService() {<font></font>
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    Isolate.spawn(startWorker, receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((data) {<font></font>
      <span class="hljs-keyword">if</span> (data is SendPort) {<font></font>
        _sendPort = data;<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> completer = _completerQueue.removeFirst();<font></font>
        completer.complete(data);<font></font>
      }<font></font>
    });<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> startWorker(SendPort sendPort) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    sendPort.send(receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((imageBytes) {<font></font>
      Image image = decodeImage(imageBytes);<font></font>
      Image thumbnail = copyResize(image, <span class="hljs-attr">width</span>: min(image.width, <span class="hljs-number">200</span>));<font></font>
<font></font>
      sendPort.send(Uint8List.fromList(encodePng(thumbnail)));<font></font>
    });<font></font>
  }<font></font>
<font></font>
  Future&lt;Uint8List&gt; generate(Uint8List imageBytes) {<font></font>
    <span class="hljs-keyword">var</span> completer = Completer&lt;Uint8List&gt;();<font></font>
    _completerQueue.add(completer);<font></font>
    <font></font>
    _sendPort.send(imageBytes);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> completer.future;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'authentification Firebase est √©galement utilis√©e, mais uniquement pour l'autorisation d'acc√®s au stockage Firebase (afin que l'utilisateur ne puisse pas, par exemple, remplir la photo de profil pour </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quelqu'un d'autre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Toutes les autres autorisations se font via mes serveurs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Format du message</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous √™tes probablement horrifi√© ici, car j'utilise des tableaux d'octets r√©guliers. Json dispara√Æt car l'efficacit√© est requise, et je ne connaissais pas protobuf lorsque j'ai commenc√©. L'utilisation de tableaux n√©cessite beaucoup de prudence car un index est incorrect et les choses tournent mal. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 4 premiers octets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> correspondent √† la longueur du message. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'octet suivant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le code du message. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 16 octets suivants</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont l'identifiant de la demande (uuid). </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 40 octets suivants</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> constituent le jeton d'autorisation. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le reste du message</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Longueur du message</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requis, car je n'utilise pas de sockets http ou web, ou un autre protocole qui permet de s√©parer un message d'un autre. Mes serveurs frontaux ne voient que les flux d'octets, et ils ont besoin de savoir o√π un message se termine et un autre commence. Il existe plusieurs fa√ßons de s√©parer les messages (par exemple, utiliser un type de caract√®re jamais trouv√© dans les messages comme s√©parateur), mais j'ai pr√©f√©r√© sp√©cifier la longueur, car cette m√©thode est la plus simple, bien qu'elle entra√Æne des frais g√©n√©raux, car la plupart des messages sont manquants et un octet pour indiquer la longueur. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code du message</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'est qu'un des membres de l'√©num√©ration</font></font><code>MessageCode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le routage est effectu√© selon le code, et comme nous pouvons extraire le code du tableau sans d√©s√©rialisation pr√©alable, le serveur frontal d√©cide dans quel sujet de la kafka envoyer un message au lieu de d√©l√©guer cette responsabilit√© √† quelqu'un d'autre. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identifiant de demande</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√©sent dans la plupart des postes, mais pas dans tous. Il remplit 2 fonctions: par cet identifiant, le client √©tablit la correspondance entre la demande envoy√©e et la r√©ponse re√ßue (si le client a envoy√© les messages A, B, C dans cet ordre, cela ne signifie pas que les r√©ponses viendront √©galement dans l'ordre). La deuxi√®me fonction est d'√©viter les doublons. Comme mentionn√© pr√©c√©demment, kafka garantit au moins une fois la livraison. Autrement dit, dans de rares cas, les messages peuvent toujours √™tre dupliqu√©s. En ajoutant la colonne RequestIdentifier avec une contrainte unique √† la table de base de donn√©es souhait√©e, nous pouvons √©viter d'ins√©rer un doublon. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeton d'autorisation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est un UserId (8 octets) + 32 octets de signature HmacSha256. </font><font style="vertical-align: inherit;">Je ne pense pas que cela vaille la peine d'utiliser Jwt ici. </font><font style="vertical-align: inherit;">Jwt est environ 7 √† 8 fois plus grand pour quoi? </font><font style="vertical-align: inherit;">Mes utilisateurs n'ont aucune r√©clamation, donc une simple signature hmac est tr√®s bien. </font><font style="vertical-align: inherit;">L'autorisation par le biais d'autres services n'est pas et n'est pas pr√©vue.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appels audio et vid√©o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est dr√¥le que j'ai d√©lib√©r√©ment report√© la mise en ≈ìuvre des appels audio et vid√©o, car j'√©tais s√ªr que je ne serais pas en mesure de r√©soudre les probl√®mes, mais en fait, il s'est av√©r√© que c'√©tait l'une des fonctionnalit√©s les plus faciles √† mettre en ≈ìuvre. </font><font style="vertical-align: inherit;">Au moins la fonctionnalit√© de base. </font><font style="vertical-align: inherit;">En g√©n√©ral, l'ajout de WebRtc √† l'application et l'obtention de la premi√®re session vid√©o n'ont pris que quelques heures et, miraculeusement, le premier test a r√©ussi. </font><font style="vertical-align: inherit;">Avant cela, je pensais que le code qui fonctionnait la premi√®re fois √©tait un mythe. </font><font style="vertical-align: inherit;">Habituellement, le premier test d'une nouvelle fonctionnalit√© √©choue toujours en raison d'une sorte d'erreur stupide comme ¬´a ajout√© un service, mais ne l'a pas enregistr√© dans un conteneur DI¬ª.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas tr√®s bref sur WebRtc pour les non-initi√©s</font></font></b><div class="spoiler_text">WebRtc ‚Äî  ,   peer-to-peer    , ,    peer-to-peer  ,     .   - ,     ,      .      ,      .<br>
<br>
          (peer-to-peer),     <i></i> ,  3   (     <i></i> ,  3  .           3 ).<br>
<br>
    ‚Äî stun .   stun  ,    ‚Äî  Source IP  Source Port      ,    <i></i> .    ?        - .       IP .      - , ,    ,   Source IP  Source Port    IP  -        NAT  [ Source IP | Source Port | Router External IP | Router Port ].     - ,   Dest IP  Dest Port     Router External IP  Router Port  NAT, ,    Source IP ‚Äî Source Port     ,   .   , ,       ,      , ,    ,      NAT .       stun     NAT .     stun     Router External IP ‚Äî Router Port.   ‚Äî <i></i>   .     ,  ¬´¬ª    NAT (NAT traversal)  ,      NAT  ,     stun .<br>
*  NAT ,      . ,     ,  WebRtc    .<br>
<br>
  ‚Äî turn.  ,       ,   peer-to-peer . Fallback .    , ,  ,  ,   ,   peer-to-peer     .    turn  ‚Äî coturn,      .<br>
<br>
  ‚Äî .    <i> </i>  ,    .       ,    .   ‚Äî           .       .    ,          , ,     :)       ‚Äî   .<br>
<br>
 WebRtc  3   : offer, answer  candidate.    offer     ,    answer,       .    , ,  ,    ,       .    (     )   ,  .<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La technologie WebRtc elle-m√™me √©tablit une connexion et est engag√©e dans le transfert de flux aller-retour, mais ce n'est pas un cadre pour cr√©er des appels √† part enti√®re. Par appel, je veux dire une session de communication avec la possibilit√© d'annuler, de rejeter et d'accepter l'appel, ainsi que de raccrocher. De plus, vous devez faire savoir √† l'appelant si l'autre partie est d√©j√† prise. Et aussi pour impl√©menter de petites choses comme "attendre une r√©ponse √† l'appel N secondes, puis r√©initialiser". Si vous impl√©mentez simplement WebRtc dans l'application sous une forme nue, alors avec un appel entrant, la cam√©ra et la vid√©o s'allumeront spontan√©ment, ce qui, bien s√ªr, est inacceptable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans sa forme pure, WebRtc implique g√©n√©ralement l'envoi de candidats √† l'autre partie d√®s que possible afin que les n√©gociations commencent le plus rapidement possible, ce qui est logique. Lors de mes tests, les candidats au parti d'accueil sont g√©n√©ralement </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toujours</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commenc√© √† venir avant m√™me que l'offre arrive. Ces candidats ¬´pr√©coces¬ª ne peuvent pas √™tre √©cart√©s, ils doivent √™tre m√©moris√©s pour que plus tard, lorsque l'offre arrive et </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est cr√©√©e, les ajouter √† la connexion. Le fait que les candidats puissent commencer √† arriver avant m√™me l'offre, ainsi que d'autres raisons, font de la mise en ≈ìuvre d'appels √† part enti√®re une t√¢che non triviale. Que faire si plusieurs utilisateurs nous appellent en m√™me temps? Nous recevrons des candidats de tous, et bien que nous puissions s√©parer les candidats d'un utilisateur d'un autre, il devient difficile de savoir quels candidats rejeter, car nous ne savons pas quelle offre viendra plus t√¥t. Il y aura √©galement des probl√®mes si les candidats commencent √† venir vers nous et ensuite une offre au moment o√π </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appelons </font><font style="vertical-align: inherit;">nous- </font><i><font style="vertical-align: inherit;">m√™mes</font></i><font style="vertical-align: inherit;"> quelqu'un.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir test√© plusieurs options avec WebRtc nu, je suis arriv√© √† la conclusion que tenter de faire des appels sous cette forme serait probl√©matique et lourd de fuites de m√©moire, j'ai donc d√©cid√© d'ajouter une autre √©tape au processus de n√©gociation WebRtc. J'appelle cette √©tape </font></font><code>Inquire - Grant/Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'id√©e est tr√®s simple, mais il m'a fallu un certain temps pour y arriver. L'appelant avant m√™me de cr√©er le flux et </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(et g√©n√©ralement avant d'ex√©cuter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code li√© √† WebRtc) envoie un message via le serveur de signaux de l'autre c√¥t√© </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Du c√¥t√© de la r√©ception, il est v√©rifi√© si l'utilisateur est actuellement dans une autre session de communication ( </font></font><code>bool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">champ </font><font style="vertical-align: inherit;">simple </font><font style="vertical-align: inherit;">). Si c'est le cas, un message est renvoy√©.</font></font><code>Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et de cette fa√ßon, nous faisons savoir √† l'appelant que l'utilisateur est occup√©, et le r√©cepteur - que tel ou tel t√©l√©phone a appel√© alors qu'il √©tait occup√© par une autre conversation. Si l'utilisateur est actuellement libre, il est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©serv√©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L' </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identifiant de session est envoy√© </font><font style="vertical-align: inherit;">dans le message </font><font style="vertical-align: inherit;">, et cet identifiant est d√©fini comme l'identifiant de la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">courant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> session. Si l'utilisateur est r√©serv√©, il rejettera tous les </font></font><code>Inquire/Offer/Candidate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">messages avec des identifiants de session autres que celui en cours. Apr√®s la r√©servation, le r√©cepteur envoie un message via le serveur de signaux √† l'appelant </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il convient de dire que ce processus n'est pas visible pour l'utilisateur r√©cepteur, car il n'y a pas encore d'appel. Et l'essentiel ici n'est pas d'oublier de raccrocher un timeout c√¥t√© r√©ception. Du coup, nous r√©serverons une session, et aucune offre ne suivra.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appelant re√ßoit </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et c'est l√† que WebRtc commence par les offres, les candidats, et c'est tout pour tout le monde. </font><font style="vertical-align: inherit;">L'offre vole vers le destinataire et celui-ci, √† la r√©ception, affiche un √©cran avec les boutons R√©pondre / Rejeter. </font><font style="vertical-align: inherit;">Mais les candidats, comme d'habitude, n'attendent personne. </font><font style="vertical-align: inherit;">Ils recommencent √† arriver encore plus t√¥t que l'offre, car il n'y a aucune raison d'attendre que l'utilisateur r√©ponde √† l'appel. </font><font style="vertical-align: inherit;">Il peut ne pas r√©pondre, mais rejeter ou attendre l'expiration du d√©lai d'expiration - les candidats seront simplement expuls√©s.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Situation actuelle et plans futurs</font></font></h2><br>
<ul>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Discussions priv√©es et en groupe</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de texte, d'images</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de vid√©os</font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appels audio et vid√©o</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accus√© de r√©ception et lecture</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Impressions ..."</font></font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherche par code QR et g√©olocalisation</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recherche par code QR est, de mani√®re inattendue, assez probl√©matique √† mettre en ≈ìuvre, car presque tous les plugins pour l'analyse de code que j'ai essay√© refusent de d√©marrer ou ne fonctionnent pas correctement. </font><font style="vertical-align: inherit;">Mais je pense que les probl√®mes seront r√©solus ici. </font><font style="vertical-align: inherit;">Et pour la mise en ≈ìuvre de la recherche de g√©olocalisation, je n'ai pas encore repris. </font><font style="vertical-align: inherit;">En th√©orie, il ne devrait pas y avoir de probl√®mes particuliers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notifications en cours, ainsi que l'envoi de vid√©os.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que faut-il faire d'autre?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh, beaucoup. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il n'y a pas de tests. Les coll√®gues √©crivaient des tests, alors je me suis compl√®tement d√©tendu. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxi√®mement, il</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'est actuellement pas possible d'inviter des utilisateurs √† un chat existant et de quitter le chat. Le code serveur est pr√™t pour cela, le code client ne l'est pas. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troisi√®mement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si la gestion des erreurs sur le serveur est plus ou moins, il n'y a pas de gestion des erreurs sur le client. Il ne suffit pas de faire une entr√©e de journal; vous devez r√©essayer l'op√©ration. D√©sormais, par exemple, le m√©canisme de renvoi des messages n'est pas impl√©ment√©. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quatri√®mement, le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> serveur ne fait pas de ping sur le client, donc la d√©connexion n'est pas d√©tect√©e si, par exemple, le client a perdu Internet. La d√©connexion n'est d√©tect√©e que lorsque le client ferme l'application. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cinqui√®mement, les</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> index ne sont pas utilis√©s dans la base de donn√©es.</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sixi√®mement, l'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimisation. Le code a un grand nombre d'endroits o√π quelque chose comme est √©crit </font></font><code>// @@TODO: Pool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La plupart des tableaux ne sont que </font></font><code>new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cela. Le serveur principal cr√©e de nombreux tableaux de longueur fixe, donc ici vous pouvez et devez utiliser le pool. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Septi√®mement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il existe de nombreux emplacements sur le client o√π le code </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se termine, bien que cela ne soit pas n√©cessaire. L'envoi d'images, par exemple, semble donc lent car le code</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il enregistre les images dans le syst√®me de fichiers et g√©n√®re des miniatures avant d'afficher le message, bien que cela ne doive pas √™tre fait. Ou, par exemple, si vous ouvrez l'application et pendant votre absence, ils vous ont envoy√© des images, le d√©marrage sera lent, car √† nouveau toutes ces images sont t√©l√©charg√©es, enregistr√©es dans le syst√®me, des vignettes sont g√©n√©r√©es, et seulement apr√®s que le d√©marrage se termine et que vous √™tes jet√© de l'√©cran de d√©marrage sur l'√©cran d'accueil. Tous ces redondants </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ont √©t√© con√ßus pour faciliter le d√©bogage, mais, bien s√ªr, vous devez vous d√©barrasser des attentes inutiles avant la publication. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Huiti√®me</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'interface utilisateur est maintenant √† moiti√© pr√™te, car je n'ai pas encore d√©cid√© comment je veux la voir. Par cons√©quent, maintenant tout n'est pas intuitif, la moiti√© des boutons ne savent pas ce qu'ils font. Et les boutons ne sont souvent pas enfonc√©s la premi√®re fois, car maintenant ils ne sont plus que des ic√¥nes avec </font></font><code>GestureDetector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et sans remplissage, il n‚Äôest donc pas toujours possible d‚Äôy entrer. De plus, dans certains endroits, le d√©passement de pixels n'est pas r√©solu. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neuvi√®mement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il est d√©sormais impossible de se connecter √† un compte, il suffit de s'inscrire. Par cons√©quent, si vous d√©sinstallez l'application et la r√©installez, vous ne pourrez pas vous connecter √† votre compte :) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dixi√®mement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le code de v√©rification n'est pas envoy√© par la poste. Maintenant, le code est g√©n√©ralement toujours le m√™me, car il est plus facile √† d√©boguer. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Onzi√®me</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le principe de la responsabilit√© unique est viol√© dans de nombreux endroits. Besoin d'un refactor. Les classes charg√©es d'interagir avec la base de donn√©es (√† la fois sur le client et sur le serveur) sont g√©n√©ralement tr√®s gonfl√©es, car elles sont engag√©es dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toutes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les op√©rations de base de donn√©es. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Douzi√®mement, le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> serveur frontal attend d√©sormais toujours une r√©ponse du serveur principal, m√™me si le message n'implique pas l'envoi d'une r√©ponse (par exemple, un message avec un code </font></font><code>IsTyping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et certains messages li√©s √† WebRtc). Par cons√©quent, sans attendre de r√©ponse, il √©crit une erreur dans la console, bien que ce ne soit pas une erreur. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treizi√®mement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les images compl√®tes ne s'ouvrent pas au toucher. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions de cinqui√®mes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">certains messages qui doivent √™tre envoy√©s par lots sont envoy√©s s√©par√©ment. La m√™me chose s'applique √† certaines op√©rations de base de donn√©es. Au lieu d'ex√©cuter une seule commande, les commandes sont ex√©cut√©es en boucle avec </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(brr ..). </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions de sixi√®mes,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> certaines valeurs sont cod√©es en dur, au lieu d'√™tre configurables. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent un million septi√®mes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la journalisation sur le serveur se fait d√©sormais uniquement sur la console, et sur le client en g√©n√©ral, directement sur le widget. Sur l'√©cran principal, il y a un onglet Journaux, o√π tous les journaux sur le robinet sont supprim√©s. Le fait est que ma machine de travail refuse d'ex√©cuter √† la fois l'√©mulateur et tout ce qui est n√©cessaire pour le serveur (kafka, base de donn√©es, radis et tous les serveurs). Le d√©bit avec un appareil connect√© n'a pas fonctionn√© non plus, tout √©tait bien suspendu dans la moiti√© des cas, car l'ordinateur ne pouvait pas supporter les charges. Par cons√©quent, vous devez cr√©er une version √† chaque fois, la d√©poser sur l'appareil, l'installer et la tester comme ceci. Pour voir les journaux, je les d√©pose directement dans le widget. Perversion, je sais, mais il n'y a pas le choix. Pour la m√™me raison, de nombreuses m√©thodes renvoient </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ils le sont (pour intercepter l'exception et les lancer dans le widget), mais ils ne devraient pas. Si vous regardez le code, vous verrez une </font></font><code>_logError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©thode </font><font style="vertical-align: inherit;">laide </font><font style="vertical-align: inherit;">dans de nombreuses classes qui fait cela. Bien s√ªr, cela ira √©galement √† la poubelle. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions huit,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas de sons. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions et neuvi√®me,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous devez utiliser davantage la mise en cache. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions de dixi√®mes,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beaucoup de code r√©p√©titif. Par exemple, de nombreuses actions v√©rifient tout d'abord la validit√© du jeton, et s'il n'est pas valide, elles envoient une erreur. Je pense que vous devez impl√©menter un pipeline de middleware simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et beaucoup de petites choses, comme la concat√©nation de cha√Ænes au lieu d'utiliser </font></font><code>StringBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'a,</font></font><code>Dispose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on ne l'appelle pas partout o√π il faut, et ainsi de suite. </font><font style="vertical-align: inherit;">En g√©n√©ral, l'√©tat normal du projet est en cours d'√©laboration. </font><font style="vertical-align: inherit;">Tout ce qui pr√©c√®de est r√©soluble, mais il y a un probl√®me fondamental auquel je n'ai pas pens√© jusqu'au dernier moment, car cela m'a √©chapp√©: le messager devrait fonctionner m√™me lorsque l'application n'est pas ouverte et la mienne ne fonctionne pas. </font><font style="vertical-align: inherit;">Pour √™tre honn√™te, la solution √† ce probl√®me ne m'a pas encore travers√© l'esprit. </font><font style="vertical-align: inherit;">Ici, apparemment, vous ne pouvez pas vous passer du code natif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'√©valuerais l'√©tat de pr√©paration du projet √† 70%.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Six mois se sont √©coul√©s depuis le d√©but des travaux sur le projet. </font><font style="vertical-align: inherit;">Combin√© avec un travail √† temps partiel et a pris de longues pauses, mais il a quand m√™me fallu beaucoup de temps et d'√©nergie. </font><font style="vertical-align: inherit;">Je pr√©vois de mettre en ≈ìuvre toutes les fonctionnalit√©s d√©clar√©es + ajouter quelque chose d'inhabituel comme du tic-tac-toe ou des √©bauches directement dans la pi√®ce. </font><font style="vertical-align: inherit;">Sans raison, juste parce que c'est int√©ressant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez des questions, √©crivez. </font><font style="vertical-align: inherit;">Le courrier est sur github.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490054/index.html">17 surprises pour ma premi√®re ann√©e d'utilisation du Tesla Model 3</a></li>
<li><a href="../fr490056/index.html">Black Box: oubliez la journalisation</a></li>
<li><a href="../fr490060/index.html">Graphique de connaissances de recherche: cr√©ation √† partir de plusieurs sources</a></li>
<li><a href="../fr490066/index.html">De la Chine au p√¥le Sud: unir nos forces pour r√©soudre le puzzle de la masse des neutrinos</a></li>
<li><a href="../fr490068/index.html">Falsification du caract√®re al√©atoire et de la transformation par tri de s√©quences pseudo-al√©atoires</a></li>
<li><a href="../fr490076/index.html">Classement sportif des disciplines e-sports</a></li>
<li><a href="../fr490080/index.html">Comment les concurrents peuvent facilement bloquer votre site</a></li>
<li><a href="../fr490082/index.html">Analyse du code g√©n√©tique I</a></li>
<li><a href="../fr490084/index.html">Comprendre la sp√©cification ECMAScript, partie 1</a></li>
<li><a href="../fr490086/index.html">Guide de surf d√©butant ou vie de programmeur au Portugal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>