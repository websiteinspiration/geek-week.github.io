<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥁 🔷 🖐🏾 Comme j'ai écrit mon messager 🧒🏻 😋 👩🏼‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un soir, après une autre journée frustrante, remplie de tentatives d'équilibrer le jeu, j'ai décidé que j'avais un besoin urgent de repos. Je vais pas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comme j'ai écrit mon messager</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490070/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un soir, après une autre journée frustrante, remplie de tentatives d'équilibrer le jeu, j'ai décidé que j'avais un besoin urgent de repos. </font><font style="vertical-align: inherit;">Je vais passer à un autre projet, le faire rapidement, rendre l’estime de soi qui a baissé au cours du développement du jeu et qui va prendre le jeu par la tempête avec une vigueur renouvelée! </font><font style="vertical-align: inherit;">L'essentiel est de choisir un projet agréable et relaxant ... Ecrivez votre propre messager? </font><font style="vertical-align: inherit;">Ha! </font><font style="vertical-align: inherit;">À quel point cela peut-il être dur? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code peut être trouvé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><img src="https://habrastorage.org/webt/_b/cw/av/_bcwavbn-h0r3vgv8zzhdkaq09y.jpeg"></td>
<td><img src="https://habrastorage.org/webt/97/4x/qd/974xqd470ltfwu6gge0hfnaqry4.jpeg"></td>
</tr>
</tbody></table></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bref historique</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendant près d'un an avant de commencer à travailler sur le messager, il travaillait sur le jeu en ligne multijoueur Line Tower Wars. </font><font style="vertical-align: inherit;">La programmation s'est bien passée, tout le reste (équilibre et visuel en particulier) n'était pas très bon. </font><font style="vertical-align: inherit;">Soudain, il s'est avéré que faire un jeu et faire un jeu amusant (amusant pour quelqu'un d'autre que lui-même) sont deux choses différentes. </font><font style="vertical-align: inherit;">Après un an d'épreuve, j'avais besoin de me laisser distraire, alors j'ai décidé de m'essayer à autre chose. </font><font style="vertical-align: inherit;">Le choix s'est porté sur le développement mobile, à savoir Flutter. </font><font style="vertical-align: inherit;">J'ai entendu beaucoup de bonnes choses à propos de Flutter, et j'ai aimé la fléchette après une courte expérience. </font><font style="vertical-align: inherit;">J'ai décidé d'écrire mon propre messager. </font><font style="vertical-align: inherit;">Tout d'abord, il est recommandé d'implémenter à la fois le client et le serveur. </font><font style="vertical-align: inherit;">Deuxièmement, il y aura quelque chose d'important à mettre dans le portefeuille pour chercher du travail, je suis juste dans le processus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonctionnalité planifiée</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Discussions privées et en groupe</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de texte, d'images et de vidéos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appels audio et vidéo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirmation de réception et lecture (ticks de Votsap)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Impressions ..."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherche par code QR et géolocalisation</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'avenir, je peux dire avec fierté (et avec soulagement) que presque tout ce qui est prévu a été mis en œuvre, et qui n'a pas encore été mis en œuvre - le sera dans un proche avenir.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://player.vimeo.com/video/393246625" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sélection de la langue</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas réfléchi longtemps au choix de la langue. </font><font style="vertical-align: inherit;">Au début, il était tentant d'utiliser la fléchette pour le client et le serveur, mais une inspection plus détaillée a montré qu'il n'y avait pas beaucoup de pilotes pour les fléchettes disponibles, et ceux qui n'inspiraient pas beaucoup de confiance. </font><font style="vertical-align: inherit;">Bien que je ne me porte pas garant de parler de l'instant présent, la situation s'est peut-être améliorée. </font><font style="vertical-align: inherit;">Mon choix s'est donc porté sur C #, avec lequel j'ai travaillé dans Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a commencé par réfléchir à l'architecture. </font><font style="vertical-align: inherit;">Bien sûr, étant donné que 3 personnes et demie utiliseront très probablement mon messager, on n'aurait pas à se soucier de l'architecture en général. </font><font style="vertical-align: inherit;">Vous prenez et faites comme dans d'innombrables tutoriels. </font><font style="vertical-align: inherit;">Voici le nœud, voici le mongo, voici les sockets web. </font><font style="vertical-align: inherit;">Terminé. </font><font style="vertical-align: inherit;">Et Firebase est ici. </font><font style="vertical-align: inherit;">Mais ce n'est pas intéressant. </font><font style="vertical-align: inherit;">J'ai décidé de créer un messager qui peut facilement évoluer horizontalement, comme si j'attendais des millions de clients simultanés. </font><font style="vertical-align: inherit;">Cependant, n'ayant aucune expérience dans ce domaine, j'ai dû tout apprendre en pratique par la méthode des erreurs et encore des erreurs.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'architecture finale ressemble à ceci</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/xp/jc/n7/xpjcn7otuw8am5jv9yztpp1sgyu.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne prétends pas qu'une telle architecture est super cool et fiable, mais elle est viable et </font><font style="vertical-align: inherit;">devrait </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en théorie</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> résister à de lourdes charges et évoluer horizontalement, mais je ne comprends pas vraiment comment vérifier. </font><font style="vertical-align: inherit;">Et j'espère que je n'ai pas manqué un moment évident qui est connu de tout le monde sauf moi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous trouverez ci-dessous une description détaillée des composants individuels.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur frontal</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant même de commencer à créer le jeu, j'étais fasciné par le concept d'un serveur asynchrone à thread unique. </font><font style="vertical-align: inherit;">Effectivement et sans race'ov potentielle - que pouvez-vous demander d'autre. </font><font style="vertical-align: inherit;">Afin de comprendre comment ces serveurs sont organisés, j'ai commencé à me plonger dans le module de </font></font><code>asyncio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">langage python. </font><font style="vertical-align: inherit;">La solution que j'ai vue semblait très élégante. </font><font style="vertical-align: inherit;">En bref, la solution de pseudo-code ressemble à ceci.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-comment">//  ,      ,    </span>
<span class="hljs-comment">//       .      socket.Receive</span>
<span class="hljs-comment">//     , :</span>
<span class="hljs-keyword">var</span> bytesReceived = Completer&lt;<span class="hljs-keyword">object</span>&gt;();<font></font>
selector.Register(<font></font>
    socket,<font></font>
    SocketEvent.Receive,<font></font>
    () =&gt; bytesReceived.Complete(<span class="hljs-literal">null</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">await</span> bytesReceived.Future;<font></font>
<font></font>
<span class="hljs-keyword">int</span> n = socket.Receive(...); <span class="hljs-comment">//   </span><font></font>
<font></font>
<span class="hljs-comment">// selector -     poll.   </span>
<span class="hljs-comment">//        (Receive </span>
<span class="hljs-comment">//  ), ,    ,  .</span>
<span class="hljs-comment">//   completer,      ,</span>
<span class="hljs-comment">//        , ,     .</span>
<span class="hljs-comment">//     ,       .</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant cette technique simple, nous pouvons servir un grand nombre de sockets dans un seul thread. </font><font style="vertical-align: inherit;">Nous ne bloquons jamais un flux en attendant la réception ou l'envoi d'octets. </font><font style="vertical-align: inherit;">Le flux est toujours occupé par un travail utile. </font><font style="vertical-align: inherit;">Concurrence, en un mot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les serveurs frontaux sont implémentés de cette façon. </font><font style="vertical-align: inherit;">Ils sont tous à un seul thread et asynchrones. </font><font style="vertical-align: inherit;">Par conséquent, pour des performances maximales, vous devez exécuter autant de serveurs sur une seule machine que de cœurs (4 sur la photo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur Frontend lit le message du client et, en fonction du code du message, l'envoie à l'une des rubriques de Kafka.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une petite note de bas de page pour ceux qui ne connaissent pas kafa</font></font></b><div class="spoiler_text">   ,          RabbitMQ.    .       ,              (   authentication backend     authentication, ).  ?      -  ,         (partition).      ,      .      ,   ,       . ,             ( ,   ,  ,     (headers)).<br>
<br>
  ?     ?      .   (consumer)         (  consumer'),    ( )      . , ,      ,    2 ,       .   3 —     2.                .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le serveur frontal envoie un message à la kafka sans clé (lorsqu'il n'y a pas de clé, la kafka envoie simplement des messages à la partie à son tour). Le message est extrait de la rubrique par l'un des serveurs principaux correspondants. Le serveur traite le message et ... et ensuite? Et ce qui dépend en plus du type de message. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas le plus courant, un cycle demande-réponse se produit. Par exemple, pour une demande d'inscription, il suffit de donner une réponse au client ( </font></font><code>Success</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code>EmailAlreadyInUse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, etc). Mais à un message contenant une invitation à un chat existant de nouveaux membres (Vasya, Emil et Julia), nous devons répondre immédiatement avec trois types de messages différents. Le premier type - vous devez informer l'invitateur du résultat de l'opération (soudain, une erreur de serveur s'est produite). Le deuxième type - vous devez informer tous les membres actuels du chat qu'il y a maintenant tel ou tel nouveau membre dans le chat. La troisième consiste à envoyer des invitations à Vasya, Emil et Yulia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, cela ne semble pas très difficile, mais pour envoyer un message à un client, nous devons: 1) savoir à quel serveur frontal ce client est connecté (nous ne choisissons pas le serveur auquel le client se connectera, l'équilibreur décide pour nous); 2) envoyer un message du serveur principal au serveur frontal souhaité; 3) en fait, envoyez un message au client.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour implémenter les points 1 et 2, j'ai décidé d'utiliser une rubrique distincte (rubrique "serveurs frontaux"). La séparation des thèmes d'authentification, de session et d'appel en partitions sert de mécanisme de parallélisation. Nous voyons que le serveur de session est lourdement chargé? Nous venons d'ajouter quelques nouveaux serveurs de partition et de session, et Kafka redistribuera la charge pour nous, déchargeant les serveurs de session existants. La séparation de la rubrique "serveurs frontaux" dans la partition sert de mécanisme de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">routage</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque serveur frontal correspond à une partie de la rubrique "serveurs frontaux" (avec le même index que le serveur lui-même). Autrement dit, serveur 0 - partition 0, et ainsi de suite. Kafka permet de souscrire non seulement à un sujet spécifique, mais aussi à une partie spécifique d'un certain sujet. Tous les serveurs frontaux des startups s'abonnent à la partition correspondante. Ainsi, le serveur principal est capable d'envoyer un message à un serveur frontal spécifique en envoyant un message à une partition spécifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'accord, maintenant, lorsque le client se joint, il vous suffit d'enregistrer quelque part une paire de UserId - Frontend Server Index. En cas de déconnexion - supprimer. À ces fins, n'importe laquelle des nombreuses bases de données de valeurs-clés en mémoire fera l'affaire. J'ai choisi un radis.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À quoi cela ressemble dans la pratique. </font><font style="vertical-align: inherit;">Tout d'abord, une fois la connexion établie, le client Andrey envoie un message au serveur </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le serveur frontend reçoit le message et le transmet à la rubrique de session, en ajoutant préalablement l'en-tête «Frontend Server»: {index}. </font><font style="vertical-align: inherit;">L'un des serveurs de session d'arrière-plan recevra un message, lira le jeton d'autorisation, déterminera le type d'utilisateur auquel il s'est joint, lira l'index ajouté par le serveur frontal et écrira UserId - Index sur le radis. </font><font style="vertical-align: inherit;">À partir de ce moment, le client est considéré comme étant en ligne, et maintenant nous savons par quel serveur frontal (et, par conséquent, par quelle partie de la rubrique "serveurs frontaux") nous pouvons "tendre la main" lorsque d'autres clients envoient des messages à Andrey. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* En fait, le processus est un peu plus compliqué que je l'ai décrit. </font><font style="vertical-align: inherit;">Vous pouvez le trouver dans le code source.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pseudo-code du serveur frontal</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-comment">// Frontend Server 6</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">// Consume from "Frontend Servers" topic, partition 6</span>
    <span class="hljs-keyword">var</span> messageToClient = consumer.Consume();
    <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {<font></font>
        relayMessageToClient(messageToClient);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> callbacks = selector.Poll();
    <span class="hljs-keyword">while</span> (callbacks.TryDequeue(<span class="hljs-keyword">out</span> callback)) {<font></font>
        callback();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
    <span class="hljs-keyword">while</span> (!callAtQueue.IsEmpty &amp;&amp; callAtQueue.PeekPriority() &lt;= now) {<font></font>
        callAtQueue.Dequeue()();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (messagesToRelayToBackendServers.TryDequeue(<span class="hljs-keyword">out</span> messageFromClient)) {
        <span class="hljs-comment">// choose topic</span><font></font>
        producer.Produce(topic, messageFromClient);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a quelques astuces ici. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><code>relayMessageToClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ce sera une erreur de prendre simplement le socket que vous voulez et de commencer immédiatement à lui envoyer un message, car nous </font><font style="vertical-align: inherit;">envoyons </font><font style="vertical-align: inherit;">peut-être </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déjà</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un autre message au client. Si nous commençons à envoyer des octets sans vérifier si le socket est actuellement occupé, les messages seront mélangés. Comme dans de nombreux autres endroits où un traitement ordonné des données est requis, l'astuce consiste à utiliser une file d'attente, à savoir une file d'attente de Completers ( </font></font><code>TaskCompletionSource</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en C #).</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-keyword">async</span> <span class="hljs-title">relayMessageToClient</span>(<span class="hljs-params">message</span>)</span> {
    <span class="hljs-comment">// find client</span>
    <span class="hljs-keyword">await</span> client.ReadyToSend();
    <span class="hljs-keyword">await</span> sendMessage(client, message);<font></font>
    client.CompleteSend();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> {
    <span class="hljs-comment">// ...</span>
    sendMessageQueue = <span class="hljs-keyword">new</span> LinkedList&lt;Completer&lt;<span class="hljs-keyword">object</span>&gt;&gt;();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">async</span> Future <span class="hljs-title">ReadyToSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = Completer&lt;<span class="hljs-keyword">object</span>&gt;();
	<span class="hljs-keyword">if</span> (sendMessageQueue.IsEmpty) {<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	} <span class="hljs-keyword">else</span> {
	    <span class="hljs-keyword">var</span> prevSendMessage = sendMessageQueue.Last;<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	    <span class="hljs-keyword">await</span> prevSendMessage.Future;<font></font>
	}<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CompleteSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = sendMessageQueue.RemoveFirst();<font></font>
	sendMessage.Complete(<span class="hljs-literal">null</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la file d'attente n'est pas vide, le socket est déjà occupé pour le moment. Créez-en un nouveau </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ajoutez-le à la file d'attente et à </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">précédente</font></font></i> <code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ainsi, lorsque le message précédent est envoyé, il </font></font><code>CompleteSend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se termine </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ce qui amène le serveur à commencer à envoyer le message suivant. Une telle file d'attente permet également de propager en douceur des exceptions. Supposons qu'une erreur s'est produite lors de l'envoi d'un message à un client. Dans ce cas, nous devons terminer, à l'exception de l'envoi non seulement de ce message, mais aussi de tous les messages qui sont actuellement en attente dans la file d'attente (attendez </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'ah). Si nous ne le faisons pas, ils continueront de se bloquer et nous recevrons une fuite de mémoire. Par souci de concision, le code qui fait cela n'est pas affiché ici. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2)</font></font><code>selector.Poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En fait, ce n’est même pas une astuce, mais juste une tentative pour aplanir les lacunes de l’implémentation de la méthode </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>selector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- juste un wrapper sur cette méthode). Selon le système d'exploitation sous le capot, cette méthode utilise soit </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mais ce n'est pas important ici. L'important est de savoir comment cette méthode fonctionne avec les listes que nous alimentons en entrée (liste des sockets pour la lecture, l'écriture, la vérification des erreurs). Cette méthode prend des listes, interroge les sockets et ne laisse que les sockets dans les listes qui sont prêts à effectuer l'opération requise. Toutes les autres sockets sont supprimées des listes. "Coup de pied" se produit à travers</font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(c'est-à-dire que tous les éléments suivants sont décalés, ce qui est inefficace). De plus, comme nous devons interroger toutes les sockets enregistrées à chaque itération du cycle, un tel «nettoyage» est généralement nuisible, nous devons à nouveau remplir les listes à chaque fois. Nous pouvons contourner tous ces problèmes en utilisant un problème personnalisé </font></font><code>List</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dont la </font><font style="vertical-align: inherit;">méthode </font><font style="vertical-align: inherit;">ne supprime pas l'élément de la liste, mais le marque simplement comme supprimé. La classe </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est mon implémentation d'une telle liste. </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne fonctionne qu'avec la méthode </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ne convient à rien d'autre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3)</font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dans la plupart des cas, le serveur frontal, après avoir envoyé le message client au serveur principal, attend une réponse (confirmation que l'opération a réussi, ou une erreur en cas de problème). S'il n'attend pas de réponse dans un délai configurable, il envoie une erreur au client pour qu'il n'attende pas une réponse qui ne viendra jamais. </font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est une file d'attente prioritaire. Immédiatement après que le serveur envoie le message à Kafka, il fait quelque chose comme ceci:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
callAtQueue.Enqueue(callback, now + config.WaitForReplyMSec);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le rappel, l'attente d'une réponse est annulée et l'envoi de l'erreur du serveur commence. Si une réponse du serveur principal est reçue, le rappel ne fait rien. </font><font style="vertical-align: inherit;">Il n'y a aucun moyen de l' </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
utiliser </font></font><code>await Task.WhenAny(answerReceivedTask, Task.Delay(x))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, car le code après son </font></font><code>Task.Delay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exécution est exécuté sur le thread du pool. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, en fait, tout sur les serveurs frontaux. Une légère correction s'impose ici. En fait, le serveur n'est pas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complètement</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filetage simple. Bien sûr, kafka sous le capot utilise des threads, mais je veux dire le code de l'application. Le fait est que l'envoi d'un message sur le sujet de la kafka (produit) peut ne pas réussir. En cas d'échec, Kafka répète l'envoi d'un certain nombre de fois configurable, mais, si les départs répétés échouent, Kafka abandonne cette activité comme désespérée. Vous pouvez vérifier si le message a été envoyé avec succès ou non dans </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lequel nous passons à la méthode </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kafka appelle ce gestionnaire dans le thread d'E / S du producteur (le thread qui envoie des messages). Nous devons nous assurer que le message a été envoyé avec succès, et sinon, annuler l'attente d'une réponse du serveur principal (la réponse ne viendra pas car la demande n'a pas été envoyée) et envoyer une erreur au client. Autrement dit, nous ne pouvons pas éviter d'interagir avec un autre fil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Lors de la rédaction d'un article, je me suis soudain rendu compte que nous ne pouvions pas passer </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à la méthode </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou simplement ignorer toutes les erreurs kafka (l'erreur sera toujours envoyée au client dans le délai que j'ai décrit plus tôt) - alors tout notre code sera monotrame. </font><font style="vertical-align: inherit;">Maintenant, je pense à mieux faire.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi, en fait, du kafka, pas du lapin?</font></font></b><div class="spoiler_text">,        ,   ,  , ,   RabbitMQ?        .  , ,   .     ?    ,         frontend .   ,     backend ,      ,          .    ,       ,     .   ,       error-prone.  ,     <code>basicGet</code> ,    ,   ,      .     .      <code>basicGet</code>,      ,       .          .<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur backend</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par rapport au serveur frontal, il n'y a pratiquement pas de points intéressants ici. </font><font style="vertical-align: inherit;">Tous les serveurs principaux fonctionnent de la même manière. </font><font style="vertical-align: inherit;">Au démarrage, le serveur s'abonne à la rubrique (authentification, session ou appel selon le rôle), et la kafka lui assigne une ou plusieurs partitions. </font><font style="vertical-align: inherit;">Le serveur reçoit le message de Kafka, traite et envoie généralement un ou plusieurs messages en réponse. </font><font style="vertical-align: inherit;">Code presque réel:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">long</span> lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">var</span> consumeResult = consumer.Consume(<font></font>
            TimeSpan.FromMilliseconds(config.Consumer.PollTimeoutMSec)<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (consumeResult != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> workUnit = <span class="hljs-keyword">new</span> WorkUnit() {<font></font>
                ConsumeResult = consumeResult,<font></font>
            };<font></font>
<font></font>
            LinkedList&lt;WorkUnit&gt; workUnits;<font></font>
            <span class="hljs-keyword">if</span> (partitionToWorkUnits.ContainsKey(consumeResult.Partition)) {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition];<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition] =<font></font>
                    <span class="hljs-keyword">new</span> LinkedList&lt;WorkUnit&gt;();<font></font>
            }<font></font>
<font></font>
            workUnits.AddLast(workUnit);<font></font>
<font></font>
            handleWorkUnit(workUnit);<font></font>
        }<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (<font></font>
            DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - lastCommitTime &gt;=<font></font>
            config.Consumer.CommitIntervalMSec<font></font>
        ) {<font></font>
            commitOffsets();<font></font>
	    lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quel genre de compensations engager?</font></font></b><div class="spoiler_text">       .   —   (offset)    (0, 1  ).         0.        <code>TopicPartitionOffset</code>.    (consume)   ,   <code>ConsumeResult</code>, ,   ,   <code>TopicPartitionOffset</code>.     ?<br>
<br>
  at least once delivery,  ,              (    ).     ,           (commited) . ,  consumer         16,  ,  16 ,   ,      ,   .     -  consumer'     consumer'        ,    16 + 1 (   + 1).    17   .        N ,       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai désactivé la validation automatique et je me suis engagé. Ceci est nécessaire car </font></font><code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lorsque le traitement du message est effectivement effectué, il s'agit d'une </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">méthode, il n'y a donc aucune garantie que le message 5 sera traité avant le message 6. Kafka ne stocke qu'un seul décalage validé (et non un ensemble de décalage), respectivement, avant de valider le décalage 6, nous devons également nous assurer que tous les messages précédents ont été traités. En outre, un serveur principal peut consommer des messages de plusieurs partitions en même temps et doit donc s'assurer qu'il valide le décalage correct sur la partition correspondante. Pour cela, nous utilisons une carte de hachage de la partition de formulaire: unités de travail. Voici à quoi ressemble le code </font></font><code>commitOffsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(du vrai code cette fois):</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commitOffsets</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">foreach</span> (LinkedList&lt;WorkUnit&gt; workUnits <span class="hljs-keyword">in</span> partitionToWorkUnits.Values) {<font></font>
        WorkUnit lastFinishedWorkUnit = <span class="hljs-literal">null</span>;<font></font>
        LinkedListNode&lt;WorkUnit&gt; workUnit;<font></font>
        <span class="hljs-keyword">while</span> ((workUnit = workUnits.First) != <span class="hljs-literal">null</span> &amp;&amp; workUnit.Value.IsFinished) {<font></font>
            lastFinishedWorkUnit = workUnit.Value;<font></font>
            workUnits.RemoveFirst();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (lastFinishedWorkUnit != <span class="hljs-literal">null</span>) {<font></font>
            offsets.Add(lastFinishedWorkUnit.ConsumeResult.TopicPartitionOffset);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (offsets.Count &gt; <span class="hljs-number">0</span>) {<font></font>
        consumer.Commit(offsets);<font></font>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> offset <span class="hljs-keyword">in</span> offsets) {<font></font>
            logger.Debug(<font></font>
                <span class="hljs-string">"{Identifier}: Commited offset {TopicPartitionOffset}"</span>,<font></font>
                identifier,<font></font>
                offset<font></font>
            );<font></font>
        }<font></font>
        offsets.Clear();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, nous parcourons les unités, trouvons la dernière unité terminée à ce moment, après quoi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'y en a pas de incomplète</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et validons le décalage correspondant. </font><font style="vertical-align: inherit;">Une telle boucle nous permet d'éviter les commits "troués". </font><font style="vertical-align: inherit;">Par exemple, si nous avons actuellement 4 unités ( </font></font><code>0: Finished, 1: Not Finished, 2: Finished, 3: Finished</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), nous ne pouvons valider que la 0ème unité, car si nous validons la 3ème immédiatement, cela peut entraîner la perte potentielle de la 1ère, si le serveur meurt en ce moment.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkUnit</span> {
    <span class="hljs-keyword">public</span> ConsumeResult&lt;Null, <span class="hljs-keyword">byte</span>[]&gt; ConsumeResult { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> finished = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsFinished =&gt; finished == <span class="hljs-number">1</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Finish</span>(<span class="hljs-params"></span>)</span> {<font></font>
        Interlocked.Increment(<span class="hljs-keyword">ref</span> finished);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
<code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comme cela a été dit, la </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">méthode et, en conséquence, est complètement enveloppée </font></font><code>try-catch-finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En </font></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il appelle le service nécessaire, et en </font></font><code>finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>workUnit.Finish()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les services sont assez banals. </font><font style="vertical-align: inherit;">Ici, par exemple, quel code est exécuté lorsque l'utilisateur envoie un nouveau message:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;ServiceResult&gt; <span class="hljs-title">createShareItem</span>(<span class="hljs-params">CreateShareItemMessage msg</span>)</span> {
    <span class="hljs-keyword">byte</span>[] message;
    <span class="hljs-keyword">byte</span>[] messageToPals1 = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">int</span>?[] partitions1 = <span class="hljs-literal">null</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  UserId  .</span>
    <span class="hljs-keyword">long</span>? userId = hashService.ValidateSessionIdentifier(msg.SessionIdentifier);
    <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> shareItem = <span class="hljs-keyword">new</span> ShareItemModel(<font></font>
            requestIdentifier: msg.RequestIdentifier,<font></font>
            roomIdentifier: msg.RoomIdentifier,<font></font>
            creatorId: userId,<font></font>
            timeOfCreation: <span class="hljs-literal">null</span>,<font></font>
            type: msg.ShareItemType,<font></font>
            content: msg.Content<font></font>
        );<font></font>
<font></font>
        <span class="hljs-comment">//      null,</span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">long</span>? timeOfCreation = <span class="hljs-keyword">await</span> storageService.CreateShareItem(shareItem);
        <span class="hljs-keyword">if</span> (timeOfCreation != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//      .</span>
            List&lt;<span class="hljs-keyword">long</span>&gt; pals = <span class="hljs-keyword">await</span> inMemoryStorageService.GetRoomPals(<font></font>
                msg.RoomIdentifier<font></font>
            );<font></font>
            <span class="hljs-keyword">if</span> (pals == <span class="hljs-literal">null</span>) {
            	<span class="hljs-comment">//     -       .</span>
                pals = <span class="hljs-keyword">await</span> storageService.GetRoomPals(msg.RoomIdentifier);
                <span class="hljs-keyword">await</span> inMemoryStorageService.SaveRoomPals(msg.RoomIdentifier, pals);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-comment">//    ,  .</span><font></font>
            pals.Remove(userId.Value);<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (pals.Count &gt; <span class="hljs-number">0</span>) {
            	<span class="hljs-comment">//  ack,  ,    </span>
                <span class="hljs-comment">//    .</span>
                <span class="hljs-keyword">await</span> storageService.CreateAck(<font></font>
                    msg.RequestIdentifier, userId.Value, msg.RoomIdentifier,<font></font>
                    timeOfCreation.Value, pals<font></font>
                );<font></font>
<font></font>
                <span class="hljs-comment">// in -  UserId, out -   frontend ,</span>
                <span class="hljs-comment">//    .  -   -</span>
                <span class="hljs-comment">//   null.</span>
                partitions1 = <span class="hljs-keyword">await</span> inMemoryStorageService.GetUserPartitions(pals);<font></font>
<font></font>
                List&lt;<span class="hljs-keyword">long</span>&gt; onlinePals = getOnlinePals(pals, partitions1);<font></font>
<font></font>
                <span class="hljs-comment">//    ,       .</span>
                <span class="hljs-comment">//         .</span>
                <span class="hljs-keyword">if</span> (onlinePals.Count &gt; <span class="hljs-number">0</span>) {<font></font>
                    messageToPals1 = converterService.EncodeNewShareItemMessage(<font></font>
                        userId.Value, timeOfCreation.Value, onlinePals, shareItem<font></font>
                    );<font></font>
                    nullRepeatedPartitions(partitions1);<font></font>
                    <span class="hljs-comment">// -         </span>
                    <span class="hljs-comment">// frontend ,    null' .</span><font></font>
                }<font></font>
            }<font></font>
<font></font>
            message = converterService.EncodeSuccessfulShareItemCreationMessage(<font></font>
                msg.RequestIdentifier, timeOfCreation.Value<font></font>
            );<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            message = converterService.EncodeMessage(<font></font>
                MessageCode.RoomNotFound, msg.RequestIdentifier<font></font>
            );<font></font>
        }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        message = converterService.EncodeMessage(<font></font>
            MessageCode.UserNotFound, msg.RequestIdentifier<font></font>
        );<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServiceResult(<font></font>
        message: message, <span class="hljs-comment">//    .</span>
        messageToPals1: messageToPals1, <span class="hljs-comment">//  -    .</span><font></font>
        partitions1: partitions1<font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de données</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La plupart des fonctionnalités des services appelés par les serveurs backend consistent simplement à ajouter de nouvelles données à la base de données et à traiter celles existantes. De toute évidence, la façon dont la base de données est organisée et comment nous fonctionnons est très importante pour le messager, et ici, je voudrais dire que j'ai abordé la question du choix d'une base de données très soigneusement après avoir soigneusement étudié toutes les options, mais ce n'est pas le cas. Je viens de choisir CockroachDb car il promet beaucoup avec un minimum d'effort et possède une syntaxe compatible postgres (j'ai déjà travaillé avec postgres). Il y avait des pensées d'utiliser Cassandra, mais à la fin j'ai décidé de m'attarder sur quelque chose de familier. Je n'avais jamais travaillé avec Kafka, ni avec Rabbit, ni avec Flutter and Dart, ni avec WebRtc, alors j'ai décidé de ne pas traîner Cassandra aussi, parce que j'avais peur de me noyer dans une multitude de nouvelles technologies pour moi.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toutes les parties de mon projet, la conception de bases de données est la chose dont je doute le plus. Je ne suis pas sûr que les décisions que j'ai prises soient vraiment de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bonnes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> décisions. Tout fonctionne, mais pourrait être mieux fait. Par exemple, il existe des tables ShareRooms (lorsque j'appelle des chats) et ShareItems (lorsque j'appelle des messages). Ainsi, tous les utilisateurs entrant dans une pièce sont enregistrés dans le champ jsonb de cette pièce. C'est pratique, mais évidemment très lent, donc je vais probablement le refaire en utilisant des clés étrangères. Ou, par exemple, la table ShareItems stocke </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tous les</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> messages. Ce qui est également pratique, mais puisque ShareItems est l'une des tables les plus chargées (persistantes </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), il pourrait être utile de créer une nouvelle table pour chaque pièce ou quelque chose comme ça. Kokroach diffuse des enregistrements sur différents nœuds, en conséquence, vous devez soigneusement réfléchir à l'enregistrement qui ira afin d'obtenir des performances maximales, mais je ne l'ai pas fait. En général, comme on peut le comprendre à partir de tout ce qui précède, les bases de données ne sont pas mon point fort. En ce moment, je teste généralement tout pour les postgres, et non les kokroach, car il y a moins de charge sur ma machine de travail, elle est déjà si pauvre en charges qu'elle va bientôt décoller. Heureusement, le code pour postgres et kokroach diffère beaucoup, donc la commutation n'est pas difficile.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, je suis en train d'étudier le fonctionnement réel du cocroach (comment le mappage se produit entre SQL et la valeur-clé (le cocroach utilise RocksDb sous le capot), comment il répartit les données entre les nœuds, les répliques, etc.). Il valait bien sûr la peine d'étudier le cocotier avant de l'utiliser, mais mieux vaut tard que jamais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense que la base subira de grands changements lorsque je comprendrai mieux cette question. En ce moment, la table Acks me hante. Dans ce tableau, je stocke des données sur qui n'a pas encore reçu et qui n'a pas encore lu le message (pour afficher les coches de l'utilisateur). Il est facile d'informer l'utilisateur que son message a été lu si l'utilisateur est en ligne maintenant, mais sinon, nous devons enregistrer ces informations afin d'avertir l'utilisateur plus tard. Et comme les discussions de groupe sont disponibles, il ne suffit pas de stocker l'indicateur, vous avez besoin de données sur les utilisateurs individuels. Donc, ici, nous demandons directement l'utilisation de chaînes de bits (une ligne pour les utilisateurs qui n'ont pas encore reçu, la seconde - pour ceux qui n'ont pas encore lu). Surtout le support kokroach </font></font><code>bit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>bit varying</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cependant, je n'ai jamais compris comment mettre en œuvre cette activité, étant donné que la composition des pièces peut constamment changer. Pour que les chaînes de bits conservent leur signification, les utilisateurs dans la salle doivent rester dans le même ordre, ce qui est assez difficile à faire lorsque, par exemple, certains utilisateurs quittent la salle. Il y a des options ici. Il vaut peut-être la peine d'écrire -1 au lieu de supprimer l'utilisateur du champ jsonb afin que l'ordre soit préservé, ou d'utiliser une méthode de versioning, afin que nous sachions que cette chaîne de bits fait référence à l'ordre des utilisateurs, qui était alors à l'époque, et non dans l'ordre actuel des utilisateurs. Je suis toujours en train de réfléchir à une meilleure implémentation de cette activité, mais pour le moment, ceux qui n'ont pas encore reçu et n'ont pas lu les utilisateurs ne sont que des champs jsonb. Étant donné que la table Acks est écrite avec chaque message, la quantité de données est importante.Bien que l'enregistrement, bien sûr, soit supprimé lorsque le message est reçu et lu par tout le monde.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Battement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pendant longtemps, j'ai travaillé côté serveur et utilisé des clients de console simples pour le test, donc je n'ai même pas créé de projet Flutter. </font><font style="vertical-align: inherit;">Et quand je l'ai créé, je pensais que la partie serveur était une </font><font style="vertical-align: inherit;">partie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complexe</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et l'application est comme ça, poubelle, je vais le comprendre dans quelques jours. </font><font style="vertical-align: inherit;">En travaillant sur le serveur, j'ai créé Hello Worlds pour flutter plusieurs fois pour avoir une idée du cadre, et comme le messager n'a pas besoin d'interface utilisateur complexe, je pensais qu'il était complètement prêt. </font><font style="vertical-align: inherit;">Donc, l'interface utilisateur, vraiment, est une ordure, mais la mise en œuvre de la fonctionnalité m'a posé des problèmes (et elle sera toujours livrée, car tout n'est pas prêt).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion de l'État</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le sujet le plus populaire. Il existe mille façons de gérer votre état et l'approche recommandée est modifiée tous les six mois. Maintenant, le courant dominant est le fournisseur. Personnellement, j'ai choisi 2 façons pour moi: bloc et redux. Bloc (Business Logic Component) pour la gestion de l'état local et redux pour la gestion globale. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bloc n'est pas une sorte de bibliothèque (bien que, bien sûr, il y ait aussi une bibliothèque qui réduit le passe-partout, mais je ne l'utilise pas). Bloc est une approche basée sur les flux. En général, le dart est une langue assez agréable et les flux sont généralement si doux. L'essence de cette approche est que nous poussons toute la logique métier dans les services et que nous communiquons entre l'interface utilisateur et les services via un contrôleur qui nous fournit différents flux. L'utilisateur a-t-il cliqué sur le bouton «rechercher un contact»? En utilisant</font></font><code>sink</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(l'autre extrémité du flux) nous envoyons un événement au contrôleur </font></font><code>SearchContactsEvent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le contrôleur appellera le service souhaité, attendra le résultat et renverra la liste des utilisateurs à l'interface utilisateur également via le flux. L'interface utilisateur attend les résultats à l'aide de </font></font><code>StreamBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(widget qui est reconstruit chaque fois que de nouvelles données arrivent dans le flux auquel elles sont abonnées). En fait, c'est tout. Dans certains cas, nous devons mettre à jour l'interface utilisateur sans aucune intervention de l'utilisateur (par exemple, lorsqu'un nouveau message est arrivé), mais cela se fait également facilement via les flux. En fait, un simple MVC avec des flux, pas de magie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par rapport à d'autres approches, le bloc nécessite plus de passe-partout, mais, à mon avis, il est préférable d'utiliser des solutions natives sans la participation de bibliothèques tierces, sauf si l'utilisation d'une solution tierce donne </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avantages. </font><font style="vertical-align: inherit;">Plus il y a d'abstractions en haut, plus il est difficile de comprendre ce qu'est l'erreur lorsqu'une erreur se produit. </font><font style="vertical-align: inherit;">Je ne considère pas que les avantages du fournisseur soient suffisamment importants pour y basculer. </font><font style="vertical-align: inherit;">Mais j'ai peu d'expérience dans ce domaine, il est donc probable que je changerai de camp à l'avenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, à propos de redux, et donc tout le monde sait tout, donc il n'y a rien à dire. </font><font style="vertical-align: inherit;">De plus, je l'ai coupé de l'application :) Je l'ai utilisé pour gérer mon compte, mais ensuite, réalisant que dans ce cas il n'y a pas d'avantages particuliers par rapport au bloc, je l'ai coupé pour ne pas trop traîner. </font><font style="vertical-align: inherit;">Mais en général, je considère que redux est une chose utile pour gérer l'état global.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La partie la plus atroce</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que dois-je faire si l'utilisateur envoie un message, mais avant qu'il ne soit envoyé, la connexion Internet est perdue? Que dois-je faire si l'utilisateur a reçu une confirmation de lecture, mais qu'il a fermé l'application avant la mise à jour de l'enregistrement correspondant dans la base de données? Que dois-je faire si l'utilisateur a invité son ami dans la chambre, mais avant que l'invitation ne soit envoyée, sa batterie est morte? Avez-vous déjà posé des questions similaires? Je suis ici. Avant. Mais dans le processus de développement, j'ai commencé à me demander. Étant donné que la connexion peut disparaître à tout moment et que le téléphone s'éteint à tout moment, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> doit être </font><b><font style="vertical-align: inherit;">confirmé</font></b><font style="vertical-align: inherit;"> . Pas drôle. Par conséquent, le tout premier message que le client envoie au serveur ( </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si vous vous en souvenez) n'est pas seulement </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Bonjour je suis en ligne»</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , c'est</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Bonjour, je suis en ligne et voici les salles non confirmées, voici les remerciements non confirmés, voici les opérations d'adhésion aux salles non confirmées, et voici les derniers messages reçus par chambre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">" </font></i><font style="vertical-align: inherit;">Et le serveur répond avec une feuille similaire: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Pendant que vous étiez hors ligne, tel ou tel vos messages ont été lus par tel ou tel utilisateur, et ils ont également invité Petya dans cette salle, et Sveta a quitté cette salle, et vous avez été invité dans cette salle, mais pour ces deux salles ont 40 nouveaux postes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">" </font></i><font style="vertical-align: inherit;">J'aimerais vraiment savoir comment des choses similaires sont faites dans d'autres messagers, car ma mise en œuvre ne brille pas avec grâce.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Images</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le moment, vous pouvez envoyer du texte, du texte + des images et seulement des images. </font><font style="vertical-align: inherit;">Le téléchargement de vidéos n'a pas encore été mis en œuvre. </font><font style="vertical-align: inherit;">Les images sont un peu compressées et enregistrées dans le stockage Firebase. </font><font style="vertical-align: inherit;">Le message lui-même contient des liens. </font><font style="vertical-align: inherit;">À la réception du message, le client télécharge des images, génère des miniatures et enregistre tout dans le système de fichiers. </font><font style="vertical-align: inherit;">Les chemins d'accès aux fichiers sont écrits dans la base de données. </font><font style="vertical-align: inherit;">Soit dit en passant, la génération de miniatures est le seul code exécuté sur un thread séparé, car il s'agit d'une opération lourde en calcul. </font><font style="vertical-align: inherit;">Je démarre simplement un flux de travail, je lui donne une image et en retour, je reçois une miniature. </font><font style="vertical-align: inherit;">Le code est extrêmement simple, car dart fournit des abstractions pratiques pour travailler avec des flux.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThumbnailGeneratorService</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThumbnailGeneratorService</span> </span>{<font></font>
  SendPort _sendPort;<font></font>
  final Queue&lt;Completer&lt;Uint8List&gt;&gt; _completerQueue =<font></font>
      Queue&lt;Completer&lt;Uint8List&gt;&gt;();<font></font>
<font></font>
  ThumbnailGeneratorService() {<font></font>
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    Isolate.spawn(startWorker, receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((data) {<font></font>
      <span class="hljs-keyword">if</span> (data is SendPort) {<font></font>
        _sendPort = data;<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> completer = _completerQueue.removeFirst();<font></font>
        completer.complete(data);<font></font>
      }<font></font>
    });<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> startWorker(SendPort sendPort) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    sendPort.send(receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((imageBytes) {<font></font>
      Image image = decodeImage(imageBytes);<font></font>
      Image thumbnail = copyResize(image, <span class="hljs-attr">width</span>: min(image.width, <span class="hljs-number">200</span>));<font></font>
<font></font>
      sendPort.send(Uint8List.fromList(encodePng(thumbnail)));<font></font>
    });<font></font>
  }<font></font>
<font></font>
  Future&lt;Uint8List&gt; generate(Uint8List imageBytes) {<font></font>
    <span class="hljs-keyword">var</span> completer = Completer&lt;Uint8List&gt;();<font></font>
    _completerQueue.add(completer);<font></font>
    <font></font>
    _sendPort.send(imageBytes);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> completer.future;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'authentification Firebase est également utilisée, mais uniquement pour l'autorisation d'accès au stockage Firebase (afin que l'utilisateur ne puisse pas, par exemple, remplir la photo de profil pour </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quelqu'un d'autre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Toutes les autres autorisations se font via mes serveurs.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Format du message</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous êtes probablement horrifié ici, car j'utilise des tableaux d'octets réguliers. Json disparaît car l'efficacité est requise, et je ne connaissais pas protobuf lorsque j'ai commencé. L'utilisation de tableaux nécessite beaucoup de prudence car un index est incorrect et les choses tournent mal. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 4 premiers octets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> correspondent à la longueur du message. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'octet suivant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le code du message. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 16 octets suivants</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont l'identifiant de la demande (uuid). </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 40 octets suivants</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> constituent le jeton d'autorisation. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le reste du message</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Longueur du message</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requis, car je n'utilise pas de sockets http ou web, ou un autre protocole qui permet de séparer un message d'un autre. Mes serveurs frontaux ne voient que les flux d'octets, et ils ont besoin de savoir où un message se termine et un autre commence. Il existe plusieurs façons de séparer les messages (par exemple, utiliser un type de caractère jamais trouvé dans les messages comme séparateur), mais j'ai préféré spécifier la longueur, car cette méthode est la plus simple, bien qu'elle entraîne des frais généraux, car la plupart des messages sont manquants et un octet pour indiquer la longueur. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code du message</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'est qu'un des membres de l'énumération</font></font><code>MessageCode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le routage est effectué selon le code, et comme nous pouvons extraire le code du tableau sans désérialisation préalable, le serveur frontal décide dans quel sujet de la kafka envoyer un message au lieu de déléguer cette responsabilité à quelqu'un d'autre. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identifiant de demande</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">présent dans la plupart des postes, mais pas dans tous. Il remplit 2 fonctions: par cet identifiant, le client établit la correspondance entre la demande envoyée et la réponse reçue (si le client a envoyé les messages A, B, C dans cet ordre, cela ne signifie pas que les réponses viendront également dans l'ordre). La deuxième fonction est d'éviter les doublons. Comme mentionné précédemment, kafka garantit au moins une fois la livraison. Autrement dit, dans de rares cas, les messages peuvent toujours être dupliqués. En ajoutant la colonne RequestIdentifier avec une contrainte unique à la table de base de données souhaitée, nous pouvons éviter d'insérer un doublon. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeton d'autorisation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Est un UserId (8 octets) + 32 octets de signature HmacSha256. </font><font style="vertical-align: inherit;">Je ne pense pas que cela vaille la peine d'utiliser Jwt ici. </font><font style="vertical-align: inherit;">Jwt est environ 7 à 8 fois plus grand pour quoi? </font><font style="vertical-align: inherit;">Mes utilisateurs n'ont aucune réclamation, donc une simple signature hmac est très bien. </font><font style="vertical-align: inherit;">L'autorisation par le biais d'autres services n'est pas et n'est pas prévue.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appels audio et vidéo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est drôle que j'ai délibérément reporté la mise en œuvre des appels audio et vidéo, car j'étais sûr que je ne serais pas en mesure de résoudre les problèmes, mais en fait, il s'est avéré que c'était l'une des fonctionnalités les plus faciles à mettre en œuvre. </font><font style="vertical-align: inherit;">Au moins la fonctionnalité de base. </font><font style="vertical-align: inherit;">En général, l'ajout de WebRtc à l'application et l'obtention de la première session vidéo n'ont pris que quelques heures et, miraculeusement, le premier test a réussi. </font><font style="vertical-align: inherit;">Avant cela, je pensais que le code qui fonctionnait la première fois était un mythe. </font><font style="vertical-align: inherit;">Habituellement, le premier test d'une nouvelle fonctionnalité échoue toujours en raison d'une sorte d'erreur stupide comme «a ajouté un service, mais ne l'a pas enregistré dans un conteneur DI».</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pas très bref sur WebRtc pour les non-initiés</font></font></b><div class="spoiler_text">WebRtc —  ,   peer-to-peer    , ,    peer-to-peer  ,     .   - ,     ,      .      ,      .<br>
<br>
          (peer-to-peer),     <i></i> ,  3   (     <i></i> ,  3  .           3 ).<br>
<br>
    — stun .   stun  ,    —  Source IP  Source Port      ,    <i></i> .    ?        - .       IP .      - , ,    ,   Source IP  Source Port    IP  -        NAT  [ Source IP | Source Port | Router External IP | Router Port ].     - ,   Dest IP  Dest Port     Router External IP  Router Port  NAT, ,    Source IP — Source Port     ,   .   , ,       ,      , ,    ,      NAT .       stun     NAT .     stun     Router External IP — Router Port.   — <i></i>   .     ,  «»    NAT (NAT traversal)  ,      NAT  ,     stun .<br>
*  NAT ,      . ,     ,  WebRtc    .<br>
<br>
  — turn.  ,       ,   peer-to-peer . Fallback .    , ,  ,  ,   ,   peer-to-peer     .    turn  — coturn,      .<br>
<br>
  — .    <i> </i>  ,    .       ,    .   —           .       .    ,          , ,     :)       —   .<br>
<br>
 WebRtc  3   : offer, answer  candidate.    offer     ,    answer,       .    , ,  ,    ,       .    (     )   ,  .<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La technologie WebRtc elle-même établit une connexion et est engagée dans le transfert de flux aller-retour, mais ce n'est pas un cadre pour créer des appels à part entière. Par appel, je veux dire une session de communication avec la possibilité d'annuler, de rejeter et d'accepter l'appel, ainsi que de raccrocher. De plus, vous devez faire savoir à l'appelant si l'autre partie est déjà prise. Et aussi pour implémenter de petites choses comme "attendre une réponse à l'appel N secondes, puis réinitialiser". Si vous implémentez simplement WebRtc dans l'application sous une forme nue, alors avec un appel entrant, la caméra et la vidéo s'allumeront spontanément, ce qui, bien sûr, est inacceptable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans sa forme pure, WebRtc implique généralement l'envoi de candidats à l'autre partie dès que possible afin que les négociations commencent le plus rapidement possible, ce qui est logique. Lors de mes tests, les candidats au parti d'accueil sont généralement </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toujours</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commencé à venir avant même que l'offre arrive. Ces candidats «précoces» ne peuvent pas être écartés, ils doivent être mémorisés pour que plus tard, lorsque l'offre arrive et </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est créée, les ajouter à la connexion. Le fait que les candidats puissent commencer à arriver avant même l'offre, ainsi que d'autres raisons, font de la mise en œuvre d'appels à part entière une tâche non triviale. Que faire si plusieurs utilisateurs nous appellent en même temps? Nous recevrons des candidats de tous, et bien que nous puissions séparer les candidats d'un utilisateur d'un autre, il devient difficile de savoir quels candidats rejeter, car nous ne savons pas quelle offre viendra plus tôt. Il y aura également des problèmes si les candidats commencent à venir vers nous et ensuite une offre au moment où </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appelons </font><font style="vertical-align: inherit;">nous- </font><i><font style="vertical-align: inherit;">mêmes</font></i><font style="vertical-align: inherit;"> quelqu'un.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir testé plusieurs options avec WebRtc nu, je suis arrivé à la conclusion que tenter de faire des appels sous cette forme serait problématique et lourd de fuites de mémoire, j'ai donc décidé d'ajouter une autre étape au processus de négociation WebRtc. J'appelle cette étape </font></font><code>Inquire - Grant/Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'idée est très simple, mais il m'a fallu un certain temps pour y arriver. L'appelant avant même de créer le flux et </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(et généralement avant d'exécuter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code lié à WebRtc) envoie un message via le serveur de signaux de l'autre côté </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Du côté de la réception, il est vérifié si l'utilisateur est actuellement dans une autre session de communication ( </font></font><code>bool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">champ </font><font style="vertical-align: inherit;">simple </font><font style="vertical-align: inherit;">). Si c'est le cas, un message est renvoyé.</font></font><code>Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et de cette façon, nous faisons savoir à l'appelant que l'utilisateur est occupé, et le récepteur - que tel ou tel téléphone a appelé alors qu'il était occupé par une autre conversation. Si l'utilisateur est actuellement libre, il est </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réservé</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . L' </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identifiant de session est envoyé </font><font style="vertical-align: inherit;">dans le message </font><font style="vertical-align: inherit;">, et cet identifiant est défini comme l'identifiant de la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">courant</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> session. Si l'utilisateur est réservé, il rejettera tous les </font></font><code>Inquire/Offer/Candidate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">messages avec des identifiants de session autres que celui en cours. Après la réservation, le récepteur envoie un message via le serveur de signaux à l'appelant </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il convient de dire que ce processus n'est pas visible pour l'utilisateur récepteur, car il n'y a pas encore d'appel. Et l'essentiel ici n'est pas d'oublier de raccrocher un timeout côté réception. Du coup, nous réserverons une session, et aucune offre ne suivra.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appelant reçoit </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et c'est là que WebRtc commence par les offres, les candidats, et c'est tout pour tout le monde. </font><font style="vertical-align: inherit;">L'offre vole vers le destinataire et celui-ci, à la réception, affiche un écran avec les boutons Répondre / Rejeter. </font><font style="vertical-align: inherit;">Mais les candidats, comme d'habitude, n'attendent personne. </font><font style="vertical-align: inherit;">Ils recommencent à arriver encore plus tôt que l'offre, car il n'y a aucune raison d'attendre que l'utilisateur réponde à l'appel. </font><font style="vertical-align: inherit;">Il peut ne pas répondre, mais rejeter ou attendre l'expiration du délai d'expiration - les candidats seront simplement expulsés.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Situation actuelle et plans futurs</font></font></h2><br>
<ul>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Discussions privées et en groupe</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de texte, d'images</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de vidéos</font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appels audio et vidéo</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accusé de réception et lecture</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Impressions ..."</font></font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recherche par code QR et géolocalisation</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recherche par code QR est, de manière inattendue, assez problématique à mettre en œuvre, car presque tous les plugins pour l'analyse de code que j'ai essayé refusent de démarrer ou ne fonctionnent pas correctement. </font><font style="vertical-align: inherit;">Mais je pense que les problèmes seront résolus ici. </font><font style="vertical-align: inherit;">Et pour la mise en œuvre de la recherche de géolocalisation, je n'ai pas encore repris. </font><font style="vertical-align: inherit;">En théorie, il ne devrait pas y avoir de problèmes particuliers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notifications en cours, ainsi que l'envoi de vidéos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que faut-il faire d'autre?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh, beaucoup. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il n'y a pas de tests. Les collègues écrivaient des tests, alors je me suis complètement détendu. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxièmement, il</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'est actuellement pas possible d'inviter des utilisateurs à un chat existant et de quitter le chat. Le code serveur est prêt pour cela, le code client ne l'est pas. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troisièmement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si la gestion des erreurs sur le serveur est plus ou moins, il n'y a pas de gestion des erreurs sur le client. Il ne suffit pas de faire une entrée de journal; vous devez réessayer l'opération. Désormais, par exemple, le mécanisme de renvoi des messages n'est pas implémenté. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quatrièmement, le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> serveur ne fait pas de ping sur le client, donc la déconnexion n'est pas détectée si, par exemple, le client a perdu Internet. La déconnexion n'est détectée que lorsque le client ferme l'application. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cinquièmement, les</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> index ne sont pas utilisés dans la base de données.</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sixièmement, l'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> optimisation. Le code a un grand nombre d'endroits où quelque chose comme est écrit </font></font><code>// @@TODO: Pool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La plupart des tableaux ne sont que </font></font><code>new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cela. Le serveur principal crée de nombreux tableaux de longueur fixe, donc ici vous pouvez et devez utiliser le pool. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Septièmement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il existe de nombreux emplacements sur le client où le code </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se termine, bien que cela ne soit pas nécessaire. L'envoi d'images, par exemple, semble donc lent car le code</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il enregistre les images dans le système de fichiers et génère des miniatures avant d'afficher le message, bien que cela ne doive pas être fait. Ou, par exemple, si vous ouvrez l'application et pendant votre absence, ils vous ont envoyé des images, le démarrage sera lent, car à nouveau toutes ces images sont téléchargées, enregistrées dans le système, des vignettes sont générées, et seulement après que le démarrage se termine et que vous êtes jeté de l'écran de démarrage sur l'écran d'accueil. Tous ces redondants </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ont été conçus pour faciliter le débogage, mais, bien sûr, vous devez vous débarrasser des attentes inutiles avant la publication. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Huitième</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'interface utilisateur est maintenant à moitié prête, car je n'ai pas encore décidé comment je veux la voir. Par conséquent, maintenant tout n'est pas intuitif, la moitié des boutons ne savent pas ce qu'ils font. Et les boutons ne sont souvent pas enfoncés la première fois, car maintenant ils ne sont plus que des icônes avec </font></font><code>GestureDetector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et sans remplissage, il n’est donc pas toujours possible d’y entrer. De plus, dans certains endroits, le dépassement de pixels n'est pas résolu. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neuvièmement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il est désormais impossible de se connecter à un compte, il suffit de s'inscrire. Par conséquent, si vous désinstallez l'application et la réinstallez, vous ne pourrez pas vous connecter à votre compte :) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dixièmement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le code de vérification n'est pas envoyé par la poste. Maintenant, le code est généralement toujours le même, car il est plus facile à déboguer. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Onzième</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le principe de la responsabilité unique est violé dans de nombreux endroits. Besoin d'un refactor. Les classes chargées d'interagir avec la base de données (à la fois sur le client et sur le serveur) sont généralement très gonflées, car elles sont engagées dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toutes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les opérations de base de données. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Douzièmement, le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> serveur frontal attend désormais toujours une réponse du serveur principal, même si le message n'implique pas l'envoi d'une réponse (par exemple, un message avec un code </font></font><code>IsTyping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et certains messages liés à WebRtc). Par conséquent, sans attendre de réponse, il écrit une erreur dans la console, bien que ce ne soit pas une erreur. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treizièmement,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les images complètes ne s'ouvrent pas au toucher. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions de cinquièmes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">certains messages qui doivent être envoyés par lots sont envoyés séparément. La même chose s'applique à certaines opérations de base de données. Au lieu d'exécuter une seule commande, les commandes sont exécutées en boucle avec </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(brr ..). </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions de sixièmes,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> certaines valeurs sont codées en dur, au lieu d'être configurables. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent un million septièmes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la journalisation sur le serveur se fait désormais uniquement sur la console, et sur le client en général, directement sur le widget. Sur l'écran principal, il y a un onglet Journaux, où tous les journaux sur le robinet sont supprimés. Le fait est que ma machine de travail refuse d'exécuter à la fois l'émulateur et tout ce qui est nécessaire pour le serveur (kafka, base de données, radis et tous les serveurs). Le débit avec un appareil connecté n'a pas fonctionné non plus, tout était bien suspendu dans la moitié des cas, car l'ordinateur ne pouvait pas supporter les charges. Par conséquent, vous devez créer une version à chaque fois, la déposer sur l'appareil, l'installer et la tester comme ceci. Pour voir les journaux, je les dépose directement dans le widget. Perversion, je sais, mais il n'y a pas le choix. Pour la même raison, de nombreuses méthodes renvoient </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ils le sont (pour intercepter l'exception et les lancer dans le widget), mais ils ne devraient pas. Si vous regardez le code, vous verrez une </font></font><code>_logError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">méthode </font><font style="vertical-align: inherit;">laide </font><font style="vertical-align: inherit;">dans de nombreuses classes qui fait cela. Bien sûr, cela ira également à la poubelle. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions huit,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas de sons. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions et neuvième,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous devez utiliser davantage la mise en cache. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cent millions de dixièmes,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beaucoup de code répétitif. Par exemple, de nombreuses actions vérifient tout d'abord la validité du jeton, et s'il n'est pas valide, elles envoient une erreur. Je pense que vous devez implémenter un pipeline de middleware simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et beaucoup de petites choses, comme la concaténation de chaînes au lieu d'utiliser </font></font><code>StringBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'a,</font></font><code>Dispose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on ne l'appelle pas partout où il faut, et ainsi de suite. </font><font style="vertical-align: inherit;">En général, l'état normal du projet est en cours d'élaboration. </font><font style="vertical-align: inherit;">Tout ce qui précède est résoluble, mais il y a un problème fondamental auquel je n'ai pas pensé jusqu'au dernier moment, car cela m'a échappé: le messager devrait fonctionner même lorsque l'application n'est pas ouverte et la mienne ne fonctionne pas. </font><font style="vertical-align: inherit;">Pour être honnête, la solution à ce problème ne m'a pas encore traversé l'esprit. </font><font style="vertical-align: inherit;">Ici, apparemment, vous ne pouvez pas vous passer du code natif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'évaluerais l'état de préparation du projet à 70%.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Six mois se sont écoulés depuis le début des travaux sur le projet. </font><font style="vertical-align: inherit;">Combiné avec un travail à temps partiel et a pris de longues pauses, mais il a quand même fallu beaucoup de temps et d'énergie. </font><font style="vertical-align: inherit;">Je prévois de mettre en œuvre toutes les fonctionnalités déclarées + ajouter quelque chose d'inhabituel comme du tic-tac-toe ou des ébauches directement dans la pièce. </font><font style="vertical-align: inherit;">Sans raison, juste parce que c'est intéressant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez des questions, écrivez. </font><font style="vertical-align: inherit;">Le courrier est sur github.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490054/index.html">17 surprises pour ma première année d'utilisation du Tesla Model 3</a></li>
<li><a href="../fr490056/index.html">Black Box: oubliez la journalisation</a></li>
<li><a href="../fr490060/index.html">Graphique de connaissances de recherche: création à partir de plusieurs sources</a></li>
<li><a href="../fr490066/index.html">De la Chine au pôle Sud: unir nos forces pour résoudre le puzzle de la masse des neutrinos</a></li>
<li><a href="../fr490068/index.html">Falsification du caractère aléatoire et de la transformation par tri de séquences pseudo-aléatoires</a></li>
<li><a href="../fr490076/index.html">Classement sportif des disciplines e-sports</a></li>
<li><a href="../fr490080/index.html">Comment les concurrents peuvent facilement bloquer votre site</a></li>
<li><a href="../fr490082/index.html">Analyse du code génétique I</a></li>
<li><a href="../fr490084/index.html">Comprendre la spécification ECMAScript, partie 1</a></li>
<li><a href="../fr490086/index.html">Guide de surf débutant ou vie de programmeur au Portugal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>