<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∑üèª üõåüèø üë®üèª‚Äçüåæ E, novamente, sobre incorporado: procurando bugs no projeto Embox üß¢ üèõÔ∏è üëÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Embox √© um sistema operacional em tempo real, multiplataforma, multiplataforma, para sistemas embarcados. Ele foi projetado para funcionar com pouco...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>E, novamente, sobre incorporado: procurando bugs no projeto Embox</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/499986/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/20f/e3c/e6220fe3c8d556e40580a1cf49eab7cb.png" alt="Figura 2"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Embox √© um sistema operacional em tempo real, multiplataforma, multiplataforma, para sistemas embarcados. Ele foi projetado para funcionar com poucos recursos de computa√ß√£o e permite executar aplicativos baseados em Linux em microcontroladores sem usar o pr√≥prio Linux. Obviamente, como qualquer outro aplicativo, os erros da Embox tamb√©m n√£o s√£o poupados. Este artigo √© dedicado √† an√°lise de erros encontrados no c√≥digo do projeto Embox.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguns meses atr√°s, eu j√° escrevi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre a verifica√ß√£o do FreeRTOS, outro sistema operacional para sistemas embarcados. </font><font style="vertical-align: inherit;">Eu n√£o encontrei erros nele, mas os encontrei nas bibliotecas adicionadas pelos caras da Amazon ao desenvolver sua pr√≥pria vers√£o do FreeRTOS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O artigo que voc√™ v√™ agora √† sua frente, em certo sentido, continua o tema do artigo anterior. </font><font style="vertical-align: inherit;">Frequentemente receb√≠amos pedidos para verificar o FreeRTOS e o fizemos. </font><font style="vertical-align: inherit;">Dessa vez, n√£o houve pedidos para verificar um projeto espec√≠fico, mas comecei a receber cartas e coment√°rios de desenvolvedores incorporados que gostavam e queriam mais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, a nova edi√ß√£o da revista PVS-Studio for Embedded amadureceu e est√° √† sua frente. </font><font style="vertical-align: inherit;">Gostam de assistir!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lise</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A an√°lise foi realizada no PVS-Studio - um analisador de c√≥digo est√°tico para C, C ++, C # e Java. Antes da an√°lise, o projeto precisa ser montado - para garantir que o c√≥digo do projeto esteja funcionando e tamb√©m daremos ao analisador a oportunidade de coletar as informa√ß√µes da montagem que podem ser √∫teis para uma melhor verifica√ß√£o do c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As instru√ß√µes no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reposit√≥rio oficial da</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Embox oferecem a capacidade de compilar em diferentes sistemas (Arch Linux, macOS, Debian) e usar o Docker. Decidi adicionar um pouco de variedade √† minha vida e criar e analisar no Debian, que eu instalei recentemente na minha m√°quina virtual.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A assembl√©ia correu bem. </font><font style="vertical-align: inherit;">Agora era necess√°rio realizar uma an√°lise. </font><font style="vertical-align: inherit;">O Debian √© um dos sistemas suportados pelo PVS-Studio Linux. </font><font style="vertical-align: inherit;">Uma maneira conveniente de verificar projetos no Linux √© compilar o rastreamento. </font><font style="vertical-align: inherit;">Esse √© um modo especial no qual o analisador coleta todas as informa√ß√µes necess√°rias sobre a montagem para que voc√™ possa iniciar a an√°lise com um clique. </font><font style="vertical-align: inherit;">Tudo o que eu precisava fazer era: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Baixe e instale o PVS-Studio; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Inicie o rastreamento de montagem indo para a pasta com a Embox e digitando no terminal</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -- make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Ap√≥s aguardar a montagem, execute o comando:</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -o /path/to/output.<span class="hljs-built_in">log</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Converta o relat√≥rio bruto para qualquer formato conveniente para voc√™. </font><font style="vertical-align: inherit;">O analisador vem com um utilit√°rio especial PlogConverter, com o qual voc√™ pode fazer isso. </font><font style="vertical-align: inherit;">Por exemplo, o comando para converter o relat√≥rio em lista de tarefas (para exibi√ß√£o, por exemplo, no QtCreator) ter√° a seguinte apar√™ncia:</font></font><br>
<br>
<pre><code class="cpp hljs">plog-converter -t tasklist -o /path/to/output.tasks /path/to/project</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos! </font><font style="vertical-align: inherit;">N√£o demorei mais de 15 minutos para concluir esses pontos. </font><font style="vertical-align: inherit;">O relat√≥rio est√° pronto, agora voc√™ pode visualizar os erros. </font><font style="vertical-align: inherit;">Bem, vamos come√ßar :)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciclo estranho</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dos erros encontrados pelo analisador foi o estranho loop while:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span> ) {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
<font></font>
    dp.skip --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span>);       <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">do</span> {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    ....<font></font>
<font></font>
    dp.count --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.count != <span class="hljs-number">0</span>);<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">PVS-Studio: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">V715</font></a><font style="vertical-align: inherit;"> O operador 'while' possui o corpo vazio. </font><font style="vertical-align: inherit;">Padr√£o suspeito detectado: 'while (expr) {...} while (dp.skip! = 0);'. </font><font style="vertical-align: inherit;">dd.c 225 hm </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. </font><font style="vertical-align: inherit;">Loop realmente estranho. </font><font style="vertical-align: inherit;">A express√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while (dp.skip! = 0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© escrita duas vezes, uma logo acima do loop e a segunda logo abaixo. </font><font style="vertical-align: inherit;">De fato, agora existem dois ciclos diferentes: um cont√©m express√µes entre chaves e o segundo est√° vazio. </font><font style="vertical-align: inherit;">Nesse caso, o segundo ciclo nunca ser√° executado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abaixo est√° um loop do ... while com uma condi√ß√£o semelhante, o que me leva a pensar: o loop estranho foi originalmente concebido como o ... while, mas algo deu errado. </font><font style="vertical-align: inherit;">Eu acho que esse peda√ßo de c√≥digo com uma alta probabilidade cont√©m um erro l√≥gico.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perdas de mem√≥ria</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, n√£o sem eles.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">krename</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *oldpath, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *newpath)</span> </span>{<font></font>
  <font></font>
  <span class="hljs-keyword">char</span> *newpatharg, *oldpatharg;<font></font>
<font></font>
  ....<font></font>
<font></font>
  oldpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(oldpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));<font></font>
  newpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(newpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == oldpatharg || <span class="hljs-literal">NULL</span> == newpatharg) {<font></font>
    SET_ERRNO(ENOMEM);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avisos do PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V773</a> The function was exited without releasing the 'newpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V773</a> The function was exited without releasing the 'oldpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o cria as vari√°veis ‚Äã‚Äãlocais </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oldpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dentro de si </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esses ponteiros recebem os endere√ßos dos novos locais de mem√≥ria alocados internamente usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se ocorrer um problema ao alocar mem√≥ria, o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar√° um ponteiro nulo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E se apenas um bloco de mem√≥ria for alocado? </font><font style="vertical-align: inherit;">A fun√ß√£o trava sem que nenhuma mem√≥ria seja liberada. </font><font style="vertical-align: inherit;">O site que foi alocado permanecer√° na mem√≥ria sem qualquer oportunidade de acess√°-lo novamente e liber√°-lo para uso posterior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro exemplo de vazamento de mem√≥ria √© um pouco mais claro:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">block_dev_test</span><span class="hljs-params">(....)</span> </span>{
  <span class="hljs-keyword">int8_t</span> *read_buf, *write_buf;<font></font>
  <font></font>
  ....<font></font>
<font></font>
  read_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
  write_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (read_buf == <span class="hljs-literal">NULL</span> || write_buf == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to allocate memory for buffer!\n"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (read_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(read_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (write_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(write_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> -ENOMEM;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (s_block &gt;= blocks) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Starting block should be less than number of blocks\n"</span>);
    <span class="hljs-keyword">return</span> -EINVAL;            <span class="hljs-comment">// &lt;=</span><font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avisos do PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V773</a> The function was exited without releasing the 'read_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V773</a> The function was exited without releasing the 'write_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, o programador j√° mostrou precis√£o e processou corretamente o caso em que foi poss√≠vel alocar apenas uma parte da mem√≥ria. </font><font style="vertical-align: inherit;">Processado corretamente ... e literalmente na pr√≥xima express√£o cometeu outro erro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gra√ßas a uma verifica√ß√£o escrita corretamente, podemos ter certeza de que, no momento em que a express√£o √© executada, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorne -EINVAL; </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√≥s definitivamente teremos mem√≥ria alocada para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Assim, com esse retorno da fun√ß√£o, teremos dois vazamentos ao mesmo tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu acho que conseguir um vazamento de mem√≥ria em um dispositivo incorporado pode ser mais doloroso do que em um PC cl√°ssico. </font><font style="vertical-align: inherit;">Em condi√ß√µes em que os recursos s√£o severamente limitados, √© necess√°rio monitor√°-los com cuidado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manuseio incorreto de ponteiros</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O seguinte c√≥digo de erro √© conciso e simples o suficiente:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">scsi_write</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">char</span> *buffer,
                      <span class="hljs-keyword">size_t</span> count, <span class="hljs-keyword">blkno_t</span> blkno)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_dev</span> *<span class="hljs-title">sdev</span>;</span>
  <span class="hljs-keyword">int</span> blksize;<font></font>
<font></font>
  ....<font></font>
<font></font>
  sdev = bdev-&gt;privdata;<font></font>
  blksize = sdev-&gt;blk_size; <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!sdev) {              <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">return</span> -ENODEV;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O ponteiro 'sdev' foi utilizado antes de ser verificado no nullptr. Verifique as linhas: 116, 118. scsi_disk.c 116 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ponteiro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> desreferenciado logo antes de ser verificado como NULL. √â l√≥gico supor que, se algu√©m escreveu essa verifica√ß√£o, esse ponteiro pode ser nulo. Nesse caso, temos a poss√≠vel desreferencia√ß√£o do ponteiro nulo na string </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O erro √© que a verifica√ß√£o n√£o est√° localizada onde √© necess√°ria. Deveria ter vindo ap√≥s a linha " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev = bdev-&gt; privdata;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", mas antes da linha " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Em seguida, o apelo potencial ao endere√ßo zero poderia ser evitado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O PVS-Studio encontrou mais dois erros no c√≥digo a seguir:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xdrrec_create</span><span class="hljs-params">(....)</span>
</span>{
  <span class="hljs-keyword">char</span> *buff;<font></font>
<font></font>
  ....<font></font>
<font></font>
  buff = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(sendsz + recvsz);<font></font>
  assert(buff != <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  ....<font></font>
<font></font>
  xs-&gt;extra.rec.in_base = xs-&gt;extra.rec.in_curr = buff;<font></font>
  xs-&gt;extra.rec.in_boundry <font></font>
    = xs-&gt;extra.rec.in_base + recvsz;                    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
  xs-&gt;extra.rec.out_base<font></font>
    = xs-&gt;extra.rec.out_hdr = buff + recvsz;             <span class="hljs-comment">// &lt;= </span><font></font>
  xs-&gt;extra.rec.out_curr <font></font>
    = xs-&gt;extra.rec.out_hdr + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">union</span> xdrrec_hdr);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avisos do PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O ponteiro 'xs-&gt; extra.rec.in_base' na express√£o 'xs-&gt; extra.rec.in_base + recvsz' pode ser nullptr. </font><font style="vertical-align: inherit;">Nesse caso, o valor resultante ser√° insensato e n√£o deve ser usado. </font><font style="vertical-align: inherit;">Verifique as linhas: 56, 48. xdr_rec.c 56</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O ponteiro 'buff' na express√£o 'buff + recvsz' pode ser nullptr. </font><font style="vertical-align: inherit;">Nesse caso, o valor resultante ser√° insensato e n√£o deve ser usado. </font><font style="vertical-align: inherit;">Verifique as linhas: 61, 48. xdr_rec.c 61</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ponteiro buf √© inicializado com </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e, em seguida, seu valor √© usado para inicializar outros ponteiros. A fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode retornar um ponteiro nulo, e isso sempre deve ser verificado. Parece que aqui est√° uma </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">declara√ß√£o de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verifica√ß√£o de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e tudo deve funcionar bem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas n√£o! O fato √© que as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afirma√ß√µes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o usadas para depura√ß√£o e, ao criar o projeto na configura√ß√£o do Release, essa </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afirma√ß√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ser√° exclu√≠da. Acontece que, ao trabalhar no Debug, o programa funcionar√° corretamente e, ao criar no Release, o ponteiro nulo "avan√ßa". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nas opera√ß√µes aritm√©ticas est√° incorreto, porque o resultado dessa opera√ß√£o n√£o far√° sentido e esse resultado n√£o pode ser usado. </font><font style="vertical-align: inherit;">√â sobre isso que o analisador nos alerta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguns podem argumentar que n√£o verificar o ponteiro ap√≥s </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© destemido. </font><font style="vertical-align: inherit;">Como, no primeiro acesso por um ponteiro nulo, um sinal / exce√ß√£o ocorrer√° e n√£o haver√° nada errado. </font><font style="vertical-align: inherit;">Na pr√°tica, tudo √© muito mais complicado e, se a falta de verifica√ß√£o n√£o parecer perigosa para voc√™, sugiro que voc√™ d√™ uma olhada no artigo ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que √© importante verificar o que a fun√ß√£o malloc retornou</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manuseio incorreto de matrizes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O erro a seguir √© muito semelhante ao exemplo anterior ao √∫ltimo:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fat_read_filename</span><span class="hljs-params">(struct fat_file_info *fi,
                      <span class="hljs-keyword">void</span> *p_scratch,
                      <span class="hljs-keyword">char</span> *name)</span> </span>{
  <span class="hljs-keyword">int</span> offt = <span class="hljs-number">1</span>;<font></font>
<font></font>
  ....<font></font>
<font></font>
  offt = <span class="hljs-built_in">strlen</span>(name);
  <span class="hljs-keyword">while</span> (name[offt - <span class="hljs-number">1</span>] == <span class="hljs-string">' '</span> &amp;&amp; offt &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// &lt;=</span>
    name[--offt] = <span class="hljs-string">'\0'</span>;<font></font>
  }<font></font>
  log_debug(<span class="hljs-string">"name(%s)"</span>, name);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> DFS_OK;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V781</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O valor do √≠ndice 'offt' √© verificado ap√≥s ser utilizado. </font><font style="vertical-align: inherit;">Talvez haja um erro na l√≥gica do programa. </font><font style="vertical-align: inherit;">fat_common.c 1813 A </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offt √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usada pela primeira vez dentro da opera√ß√£o de indexa√ß√£o e somente ent√£o √© verificado que seu valor √© maior que zero. </font><font style="vertical-align: inherit;">Mas o que acontece se o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nome</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for uma string vazia? </font><font style="vertical-align: inherit;">A fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 e</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , em seguida, um tiro alto na perna. </font><font style="vertical-align: inherit;">O programa acessar√° em um √≠ndice negativo, o que levar√° a um comportamento indefinido. </font><font style="vertical-align: inherit;">Tudo pode acontecer, incluindo uma falha no programa. </font><font style="vertical-align: inherit;">Bagun√ßa!</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8d/fde/b0d/a8dfdeb0d70054257d1d08162bbd39aa.png" alt="Imagem 1"></div> <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condi√ß√µes suspeitas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E onde sem eles? </font><font style="vertical-align: inherit;">Encontramos esses erros literalmente em todos os projetos que verificamos.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">index_descriptor_cloexec_set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> cloexec)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idesc_table</span> *<span class="hljs-title">it</span>;</span><font></font>
<font></font>
  it = task_resource_idesc_table(task_self());<font></font>
  assert(it);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (cloexec | FD_CLOEXEC) {<font></font>
    idesc_cloexec_set(it-&gt;idesc_table[fd]);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    idesc_cloexec_clear(it-&gt;idesc_table[fd]);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V617</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Considere inspecionar a condi√ß√£o. O argumento '0x0010' do '|' opera√ß√£o bit a bit cont√©m um valor diferente de zero. index_descriptor.c 55 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender em que consiste o erro, consulte a defini√ß√£o da constante </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FD_CLOEXEC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FD_CLOEXEC 0x0010</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acontece que na express√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (cloexec | FD_CLOEXEC) √†</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> direita do bit a bit ‚Äúou‚Äù sempre existe uma constante diferente de zero. </font><font style="vertical-align: inherit;">O resultado dessa opera√ß√£o sempre ser√° um n√∫mero diferente de zero. </font><font style="vertical-align: inherit;">Portanto, essa express√£o sempre ser√° equivalente √† express√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (true)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e sempre processaremos apenas o ramo ent√£o da express√£o if. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu suspeito que essa constante macro seja usada para pr√©-configurar o sistema operacional Embox, mas mesmo assim essa condi√ß√£o sempre verdadeira parece estranha. </font><font style="vertical-align: inherit;">Talvez eles quisessem usar o operador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&amp;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aqui </font><font style="vertical-align: inherit;">, mas cometeram um erro de digita√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divis√£o inteira</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O erro a seguir est√° relacionado a um recurso do idioma C:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SBSIZE    1024</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2fs_format</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">void</span> *priv)</span> </span>{
  <span class="hljs-keyword">size_t</span> dev_bsize;
  <span class="hljs-keyword">float</span> dev_factor;<font></font>
<font></font>
  ....<font></font>
<font></font>
  dev_size = block_dev_size(bdev);<font></font>
  dev_bsize = block_dev_block_size(bdev);<font></font>
  dev_factor = SBSIZE / dev_bsize;            <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ext2_dflt_sb(&amp;sb, dev_size, dev_factor);<font></font>
  ext2_dflt_gd(&amp;sb, &amp;gd);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviso do </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">PVS-Studio: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">V636</font></a><font style="vertical-align: inherit;"> A </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">express√£o</font></a><font style="vertical-align: inherit;"> '1024 / dev_bsize' foi convertida implicitamente do tipo 'int' para o tipo 'float'. Considere utilizar uma convers√£o de tipo expl√≠cita para evitar a perda de uma parte fracion√°ria. Um exemplo: double A = (double) (X) / Y; ext2.c 777 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse recurso √© o seguinte: se dividirmos dois valores inteiros, o resultado da divis√£o ser√° inteiro. Assim, a divis√£o ocorrer√° sem restos ou, em outras palavras, a parte fracion√°ria ser√° descartada do resultado da divis√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, os programadores esquecem e erros como esse s√£o cometidos. A constante SBSIZE e a vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> t√™m um tipo inteiro (int e size_t respectivamente). Portanto, o resultado da </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">express√£o SBSIZE / dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tamb√©m ser√° do tipo inteiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas espere um momento. </font><font style="vertical-align: inherit;">A vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© do tipo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Obviamente, o programador esperava obter um resultado de divis√£o fracion√°ria. </font><font style="vertical-align: inherit;">Isso pode ser verificado ainda mais se voc√™ prestar aten√ß√£o ao uso adicional dessa vari√°vel. </font><font style="vertical-align: inherit;">Por exemplo, a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_dflt_sb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , em que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> passada como o terceiro par√¢metro, possui a seguinte assinatura:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ext2_dflt_sb</span><span class="hljs-params">(struct ext2sb *sb, <span class="hljs-keyword">size_t</span> dev_size, <span class="hljs-keyword">float</span> dev_factor)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da mesma forma, em outros lugares onde a vari√°vel </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><i><font style="vertical-align: inherit;">usada</font></i><font style="vertical-align: inherit;"> : tudo indica que √© esperado um n√∫mero de ponto flutuante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para corrigir esse erro, basta converter um dos operandos de divis√£o em um tipo real. </font><font style="vertical-align: inherit;">Por exemplo:</font></font><br>
<br>
<pre><code class="cpp hljs">dev_factor = <span class="hljs-keyword">float</span>(SBSIZE) / dev_bsize;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o o resultado da divis√£o ser√° um n√∫mero fracion√°rio.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entrada n√£o verificada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O erro a seguir est√° associado ao uso de dados n√£o verificados recebidos de fora do programa.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> ret;
  <span class="hljs-keyword">char</span> text[SMTP_TEXT_LEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == fgets(&amp;text[<span class="hljs-number">0</span>], <span class="hljs-keyword">sizeof</span> text - <span class="hljs-number">2</span>, <span class="hljs-comment">/* for \r\n */</span>
      <span class="hljs-built_in">stdin</span>)) { ret = -EIO; <span class="hljs-keyword">goto</span> error; }<font></font>
    text[<span class="hljs-built_in">strlen</span>(&amp;text[<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>] = <span class="hljs-string">'\0'</span>; <span class="hljs-comment">/* remove \n */</span>    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dados contaminados n√£o verificados s√£o usados ‚Äã‚Äãno √≠ndice: 'strlen (&amp; text [0])'. </font><font style="vertical-align: inherit;">sendmail.c 102 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, considere o que a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retorna </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">No caso de uma leitura bem-sucedida de uma linha, a fun√ß√£o retorna um ponteiro para essa linha. </font><font style="vertical-align: inherit;">Se a leitura encontrar um </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">final de arquivo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes de pelo menos um elemento ser lido, ou se ocorrer um erro de entrada, a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a express√£o √© </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL == fgets (....)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verifica se a entrada recebida est√° correta. Mas h√° uma ressalva. Se voc√™ transferir um terminal nulo como o primeiro caractere a ser lido (isso pode ser feito, por exemplo, pressionando Ctrl + 2 no modo Legado da linha de comando do Windows), a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> considera sem retornar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nesse caso, a linha na qual a grava√ß√£o √© feita ter√° apenas um elemento - ' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que vai acontecer √† seguir? A express√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen (&amp; text [0])</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Como resultado, recebemos uma chamada de √≠ndice negativa:</font></font><br>
<br>
<pre><code class="cpp hljs">text[ <span class="hljs-number">0</span> - <span class="hljs-number">1</span> ] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, podemos "derrubar" o programa simplesmente passando o caractere de termina√ß√£o da linha para a entrada. </font><font style="vertical-align: inherit;">Isso √© constrangedor e pode potencialmente ser usado para atacar sistemas usando o Embox. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meu colega, que estava desenvolvendo essa regra de diagn√≥stico, at√© fez uma anota√ß√£o com um exemplo de um ataque desse tipo ao projeto NcFTP:</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8DBQjvPQ7tk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu recomendo ver se voc√™ ainda n√£o acredita nessa oportunidade :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, o analisador encontrou mais dois lugares com o mesmo erro:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Dados contaminados n√£o verificados s√£o usados ‚Äã‚Äãno √≠ndice: 'strlen (&amp; from [0])'. </font><font style="vertical-align: inherit;">sendmail.c 55</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Dados contaminados n√£o verificados s√£o usados ‚Äã‚Äãno √≠ndice: 'strlen (&amp; a [0])'. </font><font style="vertical-align: inherit;">sendmail.c 65</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Misra</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA √© um conjunto de diretrizes e diretrizes para escrever c√≥digo C e C ++ seguro para sistemas embarcados altamente respons√°veis. </font><font style="vertical-align: inherit;">De certa forma, este √© um manual de treinamento, que permitir√° que voc√™ se livre n√£o apenas dos chamados "odores de c√≥digo", mas tamb√©m proteja seu programa contra vulnerabilidades. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O MISRA √© usado onde as vidas humanas dependem da qualidade do seu sistema embarcado: nas ind√∫strias m√©dica, automotiva, aeron√°utica e militar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O PVS-Studio possui </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um extenso conjunto de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> regras </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">de</font></a><font style="vertical-align: inherit;"> diagn√≥stico que permitem verificar seu c√≥digo quanto √† conformidade com os padr√µes MISRA C e MISRA C ++. </font><font style="vertical-align: inherit;">Por padr√£o, o modo com esses diagn√≥sticos est√° desativado, mas como estamos procurando erros no projeto de sistemas embarcados, simplesmente n√£o poderia ficar sem o MISRA.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° o que eu consegui encontrar:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* find and read symlink file */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2_read_symlink</span><span class="hljs-params">(struct nas *nas,
                             <span class="hljs-keyword">uint32_t</span> parent_inumber,
                             <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **cp)</span> </span>{
  <span class="hljs-keyword">char</span> namebuf[MAXPATHLEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  *cp = namebuf;              <span class="hljs-comment">// &lt;=</span>
  <span class="hljs-keyword">if</span> (*namebuf != <span class="hljs-string">'/'</span>) {<font></font>
    inumber = parent_inumber;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    inumber = (<span class="hljs-keyword">uint32_t</span>) EXT2_ROOTINO;<font></font>
  }<font></font>
  rc = ext2_read_inode(nas, inumber);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
} </code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio Warning: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] O endere√ßo da matriz local 'namebuf' n√£o deve ser armazenado fora do escopo desta matriz. ext2.c 298 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O analisador detectou uma atribui√ß√£o suspeita que poderia levar a um comportamento indefinido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos dar uma olhada no c√≥digo. Aqui, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma matriz criada no escopo local da fun√ß√£o e o ponteiro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><font style="vertical-align: inherit;">passado para a fun√ß√£o pelo ponteiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acordo com a sintaxe C, o nome da matriz √© um ponteiro para o primeiro elemento na √°rea de mem√≥ria na qual a matriz est√° armazenada. Acontece que a express√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* cp = namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atribuir√° o endere√ßo da matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† vari√°vel apontada por </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp √©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> passado para a fun√ß√£o pelo ponteiro, uma altera√ß√£o no valor para o qual ela aponta ser√° refletida no local em que a fun√ß√£o foi chamada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acontece que ap√≥s a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_read_symlink terminar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seu trabalho, seu terceiro par√¢metro indicar√° a √°rea que a matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ocupou uma vez </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° apenas um "mas": como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma matriz reservada na pilha, ela ser√° exclu√≠da quando a fun√ß√£o sair. Assim, um ponteiro que exista fora da fun√ß√£o apontar√° para a mem√≥ria liberada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qual ser√° esse endere√ßo? </font><font style="vertical-align: inherit;">√â imposs√≠vel prever. </font><font style="vertical-align: inherit;">√â poss√≠vel que por algum tempo o conte√∫do da matriz continue na mem√≥ria, ou √© poss√≠vel que o programa apague imediatamente essa √°rea com outra coisa. </font><font style="vertical-align: inherit;">Em geral, o acesso a um endere√ßo retornar√° um valor indefinido e o uso desse valor √© um erro grave. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O analisador tamb√©m encontrou outro erro com o mesmo aviso:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] O endere√ßo da vari√°vel local 'dst_haddr' n√£o deve ser armazenado fora do escopo desta vari√°vel. </font><font style="vertical-align: inherit;">net_tx.c 82</font></font></li>
</ul><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ba/353/6e6/2ba3536e675a564e65b802a3e596fa36.png" alt="Figura 6"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gostei de trabalhar com o projeto Embox. Apesar de n√£o ter anotado todos os erros encontrados no artigo, o n√∫mero total de avisos foi relativamente pequeno e, em geral, o c√≥digo do projeto foi escrito com alta qualidade. Portanto, expresso minha gratid√£o aos desenvolvedores, bem como √†queles que contribu√≠ram para o projeto em nome da comunidade. Voc√™ √© √≥timo! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aproveito esta oportunidade para transmitir sauda√ß√µes aos desenvolvedores de Tula. Eu acredito que em S√£o Petersburgo n√£o est√° muito frio agora :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â aqui que o meu artigo chega ao fim. Espero que tenham gostado de ler e tenham encontrado algo novo para si. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ est√° interessado no PVS-Studio e gostaria de verificar independentemente algum projeto usando-o, fa√ßa o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">download e experimente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Isso n√£o levar√° mais que 15 minutos.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: George Gribkov. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre incorporado novamente: pesquisando bugs no projeto Embox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499970/index.html">Estudamos o mecanismo VoIP do Mediastreamer2. Parte 12</a></li>
<li><a href="../pt499972/index.html">Os eventos on-line podem ser digeridos</a></li>
<li><a href="../pt499974/index.html">Jogos em 3D no Instagram Javascript ou rota de salsicha</a></li>
<li><a href="../pt499978/index.html">Tradu√ß√£o do livro de Andrew Un, Passion for Machine Learning, Cap√≠tulos 36 e 37</a></li>
<li><a href="../pt499982/index.html">Plano do testador iniciante: de "Insira TI" a "Eu sou um engenheiro!"</a></li>
<li><a href="../pt499988/index.html">A√ß√∫car e COVID-19</a></li>
<li><a href="../pt499990/index.html">Geocodifica√ß√£o Como vincular 250 mil endere√ßos a coordenadas em 10 minutos?</a></li>
<li><a href="../pt499992/index.html">Projetar tecnologias para a implementa√ß√£o de sistemas de cobran√ßa para clientes corporativos (parte 2)</a></li>
<li><a href="../pt499994/index.html">Quando o coronav√≠rus terminar√°</a></li>
<li><a href="../pt500000/index.html">Para o dia do r√°dio. Comunica√ß√£o - os nervos da guerra</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>