<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ï üåá üßÄ Como ajudamos as escolas a mudar para o ensino a dist√¢ncia e lidamos com a carga üë©üèª‚Äçü§ù‚Äçüë®üèº ‚è∫Ô∏è üèáüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Meu nome √© Alexey Vakhov, sou o diretor t√©cnico do Uchi.ru. Em meados de mar√ßo, quando as escolas come√ßaram a mudar para o ensino a dist√¢nci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como ajudamos as escolas a mudar para o ensino a dist√¢ncia e lidamos com a carga</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/uchi_ru/blog/498906/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° Habr! Meu nome √© Alexey Vakhov, sou o diretor t√©cnico do Uchi.ru. Em meados de mar√ßo, quando as escolas come√ßaram a mudar para o ensino a dist√¢ncia, fornecemos aos professores e alunos v√°rios servi√ßos para aulas on-line. De acordo com nossos c√°lculos, t√≠nhamos uma margem de seguran√ßa para suportar no m√°ximo de 1,5 a 2 vezes a carga. Em meados de abril, nosso tr√°fego cresceu 8 vezes. Eu tive que fazer muito para me manter √† tona. Talvez algu√©m precise de nossa experi√™ncia para sobreviver a essa ou a uma crise futura.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o esper√°vamos tais surpresas e n√£o est√°vamos preparados para elas, provavelmente nem uma √∫nica empresa na R√∫ssia, nem no mundo, estava pronta para isso. Geralmente em mar√ßo, a atividade no Uchi.ru √© mais baixa em rela√ß√£o ao outono devido √† primavera e √†s pr√≥ximas f√©rias de ver√£o, quando j√° estamos nos preparando para setembro: estamos vendo recursos, refatorando, realizando mudan√ßas arquitet√¥nicas em larga escala e realizando outra rotina agrad√°vel. No entanto, desta vez foi diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O n√∫mero m√°ximo de usu√°rios √∫nicos no site chegou a 240 mil, registramos o m√°ximo anterior do ano letivo atual em 30 mil pessoas. Nesse ponto, a carga aumentava todos os dias e trabalhamos o tempo todo para estabilizar o site.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando essa carga cai no site, geralmente s√£o formados aplicativos, servi√ßos, balanceadores, bases, web e canais. </font><font style="vertical-align: inherit;">Todos os "gargalos" da infraestrutura est√£o expostos. </font><font style="vertical-align: inherit;">Em tais condi√ß√µes, √© dif√≠cil diagnosticar problemas - sintomaticamente, tudo est√° com erros. </font><font style="vertical-align: inherit;">√â f√°cil reparar quando o tr√°fego cresce sem problemas e uma coisa falha. </font><font style="vertical-align: inherit;">Quando a carga ocorre rapidamente, um dos grandes problemas √© entender as causas das falhas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A estrat√©gia para trabalhar nessas condi√ß√µes √© eliminar o que mais atinge o site e, em seguida, encontrar o pr√≥ximo ponto mais doloroso, ao mesmo tempo, procurar problemas em potencial e corrigi-los, e assim por diante. </font><font style="vertical-align: inherit;">Aqui est√£o algumas das coisas mais not√°veis ‚Äã‚Äãque fizemos para estabilizar a plataforma.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confie em si mesmos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante uma crise antes do tr√¢nsito, voc√™, como equipe, se torna um. Depende de seus funcion√°rios se voc√™ encontrar√° solu√ß√µes, lidar√° com a crise ou n√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o h√° pessoas no setor que entrem, examinem seu sistema complexo, fa√ßam algo imediatamente e tudo ficar√° bem. Obviamente, no mundo existem especialistas suficientes que lidar√£o com a tarefa se houver tempo. Mas quando uma solu√ß√£o fundamental √© necess√°ria no momento, voc√™ pode confiar apenas em sua equipe, que conhece o sistema e suas especificidades. O resultado e a responsabilidade para o neg√≥cio est√£o com a equipe. O exame externo √© aconselh√°vel para conectar no sentido hor√°rio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A coordena√ß√£o operacional da equipe anti-crise em um bate-papo especial no Slack nos ajudou a navegar rapidamente e a criar trabalho - todos os problemas foram resolvidos aqui e agora. </font><font style="vertical-align: inherit;">Dividimos as √°reas de responsabilidade entre os funcion√°rios para que n√£o houvesse cruzamentos e os rapazes n√£o fizessem o dobro do trabalho. </font><font style="vertical-align: inherit;">Nos dias mais dif√≠ceis, eu tinha que estar em contato o tempo todo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuvem expandida</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ n√£o pode segurar todas as crises, mas √© importante ser flex√≠vel. </font><font style="vertical-align: inherit;">A pilha de nuvens nos deu tanta plasticidade e uma chance de permanecer √† tona mesmo com um aumento t√£o dram√°tico na carga. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, aumentamos os recursos com o aumento da carga, mas em algum momento atingimos as cotas da regi√£o do nosso provedor de nuvem. </font><font style="vertical-align: inherit;">Os problemas surgiram em seu n√≠vel: nossos servidores virtuais foram afetados por vizinhos, nos quais o tr√°fego tamb√©m cresceu, o que causou falhas na opera√ß√£o de nossos aplicativos. </font><font style="vertical-align: inherit;">Isso era esperado: dependemos do provedor e de sua infraestrutura, que tamb√©m sofreram uma carga alta. </font><font style="vertical-align: inherit;">Liberamos alguns recursos de m√°quinas virtuais n√£o priorit√°rias para o site principal. </font><font style="vertical-align: inherit;">Com o provedor, concordamos com um recurso dedicado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferramentas de monitoramento atualizadas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante a crise, o alerta n√£o cumpriu sua fun√ß√£o. </font><font style="vertical-align: inherit;">Todos os membros da equipe j√° monitoravam todos os sistemas o tempo todo, e o gerenciamento de incidentes era reduzido ao trabalho constante em todas as frentes. </font><font style="vertical-align: inherit;">Para diagnosticar completamente os problemas que encontramos, t√≠nhamos poucos dados. </font><font style="vertical-align: inherit;">Por exemplo, para monitorar m√°quinas virtuais, usamos o Node Exporter padr√£o para Prometheus. </font><font style="vertical-align: inherit;">Ele √© bom em ver o quadro geral, pois uma an√°lise mais detalhada de uma √∫nica m√°quina virtual come√ßou a usar o NetData.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Armazenamento em cache otimizado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m surgiu um problema com os armazenamentos de valores-chave. </font><font style="vertical-align: inherit;">Em um dos aplicativos, o Redis n√£o conseguiu lidar - em uma √∫nica c√≥pia, ele pode funcionar em apenas um n√∫cleo. </font><font style="vertical-align: inherit;">Portanto, eles usaram um fork Redis chamado KeyDB, que pode funcionar em v√°rios threads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para aumentar a largura de banda em outro aplicativo, aumentamos 10 Redis'ov independentes. </font><font style="vertical-align: inherit;">Eles s√£o enviados por proxy pelo nosso Service Mesh, que tamb√©m fragmenta as chaves. </font><font style="vertical-align: inherit;">Mesmo se um ou dois Redis travarem, isso n√£o causar√° problemas devido ao hash consistente. </font><font style="vertical-align: inherit;">Al√©m disso, eles praticamente n√£o precisam ser administrados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expandiu a rede</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ sabe, 640 Kb √© suficiente para todos. </font><font style="vertical-align: inherit;">Sempre usamos sub-redes privadas / 24, mas no contexto da quarentena, tivemos que expandir urgentemente para / 22. </font><font style="vertical-align: inherit;">Agora, a rede acomoda quatro vezes mais servidores, esperamos que seja suficiente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PgBouncer realizado separadamente</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como banco de dados relacional, usamos o PostgreSQL em qualquer lugar, em pequenas inst√¢ncias virtuais e em algum lugar - a instala√ß√£o de v√°rios grandes servidores dedicados para o mestre e as r√©plicas. O gargalo √≥bvio dessa arquitetura √© o mestre, que, no caso ideal, √© usado apenas para grava√ß√£o e n√£o √© dimensionado horizontalmente. Com o crescimento do tr√°fego, come√ßamos a descansar na CPU.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, usamos o PgBouncer, que foi instalado no assistente e em cada r√©plica, para gerenciar as conex√µes. </font><font style="vertical-align: inherit;">Em uma porta, ele pode usar n√£o mais que um n√∫cleo de processador; portanto, em cada servidor, t√≠nhamos v√°rios bouncers. </font><font style="vertical-align: inherit;">Em algum momento, ficou claro que o pr√≥prio PgBouncer retirou a parte tang√≠vel da CPU da base e, com carga m√°xima, experimentamos um r√°pido aumento na m√©dia de carga e uma queda no desempenho do sistema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Movemos os seguran√ßas para um servidor separado, o que nos ajudou a economizar 20 a 25% da CPU em cada servidor de banco de dados.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diante de surpresas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apenas uma ferramenta n√£o pode ser confi√°vel, especialmente em tempos de crise. Pelo contr√°rio, a redund√¢ncia de ferramentas ajuda, porque permite ver uma imagem mais objetiva. As ferramentas familiares come√ßam a falhar por v√°rios motivos. Por exemplo, geralmente para estimar o n√∫mero de pessoas em um site, geralmente usamos um relat√≥rio do Google Analytics em tempo real, que √© uma m√©trica sens√≠vel e precisa. Mas, √†s vezes, √© um erro e, dessa vez, tivemos que analisar m√©tricas internas, como o n√∫mero de eventos de exibi√ß√£o de p√°gina e o n√∫mero de solicita√ß√µes por segundo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para registro centralizado, usamos ELK. </font><font style="vertical-align: inherit;">Nosso pipeline de entrega de logs √© baseado no Apache Kafka e Elastic Filebeat. </font><font style="vertical-align: inherit;">Sob alta carga, o transportador de entrega de logs parou de gerenciar, os logs come√ßaram a se perder ou atrasar. </font><font style="vertical-align: inherit;">Aumentamos a velocidade da transfer√™ncia de log e da indexa√ß√£o de armazenamento, manipulando os √≠ndices Elasticsearch, aumentando o n√∫mero de parti√ß√µes no Kafka e no Filebeat e otimizando a compacta√ß√£o em todos os est√°gios. </font><font style="vertical-align: inherit;">Devido ao fato de o pipeline de coleta de logs ser separado da produ√ß√£o, os problemas com o aumento do tr√°fego dos logs n√£o afetaram o funcionamento do site.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aceitou as regras do jogo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â imposs√≠vel se preparar com anteced√™ncia para cada crise, mas voc√™ pode inicialmente tentar construir um sistema flex√≠vel. </font><font style="vertical-align: inherit;">Startups ou empresas que deixam de ser gradualmente startups, em um per√≠odo silencioso, nem sempre √© racional se preparar para um crescimento anormal do tr√°fego: os recursos da equipe s√£o limitados. </font><font style="vertical-align: inherit;">Se deixarmos de lado sua prepara√ß√£o para algo que nunca pode acontecer, n√£o haver√° mais for√ßa para o produto principal. </font><font style="vertical-align: inherit;">√â muito mais importante reagir corretamente no momento e n√£o ter medo de decis√µes ousadas. </font><font style="vertical-align: inherit;">Como regra, a sa√≠da da crise √© uma sa√≠da para um n√≠vel qualitativamente novo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° uma primavera t√£o divertida este ano. </font><font style="vertical-align: inherit;">Quando parece que tudo foi feito, √†s vezes acontece que isso √© apenas o come√ßo.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt498892/index.html">A √∫ltima revis√£o da API Renga</a></li>
<li><a href="../pt498894/index.html">Voo normal</a></li>
<li><a href="../pt498898/index.html">Redes neurais para crian√ßas: explique o mais simples poss√≠vel</a></li>
<li><a href="../pt498900/index.html">Escola Java de Rosbank - resultados de aprendizagem</a></li>
<li><a href="../pt498904/index.html">Adicionando computa√ß√£o paralela ao Pandas</a></li>
<li><a href="../pt498910/index.html">Astron√°utica comercial - mitos e realidade</a></li>
<li><a href="../pt498912/index.html">Se√ß√£o anti-crise de Habr</a></li>
<li><a href="../pt498914/index.html">IA crescente - algoritmos gen√©ticos: uma introdu√ß√£o</a></li>
<li><a href="../pt498918/index.html">Sua declara√ß√£o est√° 100% correta, apenas perde o objetivo</a></li>
<li><a href="../pt498920/index.html">Sistemas de pagamento. Competi√ß√£o de Armadura e Casca</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>