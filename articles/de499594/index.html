<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😄 💆 🐃 So begrenzen Sie die Häufigkeit von Anforderungen in HAProxy: Schritt-für-Schritt-Anleitung 🤘🏻 👿 🤾🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Autor erklärt, wie die Geschwindigkeitsbegrenzung (Ratenbegrenzung) für HAProxy- Abfragen mit bestimmten IP-Adressen implementiert wird . Das Mail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>So begrenzen Sie die Häufigkeit von Anforderungen in HAProxy: Schritt-für-Schritt-Anleitung</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499594/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/000/ebc/00e/000ebc00ecfca624add0621c731f2405.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Autor erklärt, wie die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geschwindigkeitsbegrenzung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Ratenbegrenzung) </font><font style="vertical-align: inherit;">für HAProxy- </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Abfragen</font></a><font style="vertical-align: inherit;"> mit bestimmten IP-Adressen </font><font style="vertical-align: inherit;">implementiert wird </font><font style="vertical-align: inherit;">. Das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Team hat </font><font style="vertical-align: inherit;">seinen Artikel übersetzt - wir hoffen, dass Sie damit nicht so viel Zeit und Mühe darauf verwenden müssen, wie Sie es aufwenden mussten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsache ist, dass dies eine der beliebtesten Methoden zum Schutz eines Servers vor DoS-Angriffen ist, es jedoch schwierig ist, im Internet klare Anweisungen zur spezifischen Konfiguration zu finden. Durch Versuch und Irrtum zwang der Autor HAProxy, die Häufigkeit von Anforderungen in einer Liste von IP-Adressen zu begrenzen, die in Echtzeit aktualisiert wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für die Konfiguration von HAProxy sind keine Vorkenntnisse erforderlich, da alle erforderlichen Schritte im Folgenden beschrieben werden.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open Source und kostenlos HAProxy ist ein leicht zugänglicher Load Balancer und Proxy-Server. </font><font style="vertical-align: inherit;">In den letzten Jahren ist es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sehr beliebt geworden,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> weil es eine hohe Leistung mit einem Minimum an Ressourcen bietet. </font><font style="vertical-align: inherit;">Im Gegensatz zu alternativen Programmen bietet die gemeinnützige Version von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAProxy Community Edition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> genügend Funktionen für einen zuverlässigen Lastausgleich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Programm ist zunächst ziemlich schwer herauszufinden. </font><font style="vertical-align: inherit;">Sie verfügt jedoch über eine sehr sorgfältige und detaillierte technische </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Der Autor sagt, dass dies die detaillierteste Dokumentation unter allen Open-Source-Programmen ist, die er jemals verwendet hat. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist eine Schritt-für-Schritt-Anleitung.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurieren eines Load Balancers</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Zeit zu sparen und sich nicht von der Einrichtung der Infrastruktur ablenken zu lassen, nehmen Sie die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Compose-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Images </font><font style="vertical-align: inherit;">und starten Sie die Hauptkomponenten schnell. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die erste Aufgabe besteht darin, die Arbeitsinstanz des HAProxy-Load-Balancers mit mehreren Apache-Backend-Servern zu erhöhen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klonen Sie das Repository</font></font></h4><br>
<pre><code class="bash hljs">$ git <span class="hljs-built_in">clone</span> git@github.com:stargazer/haproxy-ratelimiter.git<font></font>
$ <span class="hljs-built_in">cd</span> haproxy-ratelimiter</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können </font><font style="vertical-align: inherit;">Installationsparameter anzeigen </font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anzeigen. Ihre Diskussion würde den Rahmen dieses Artikels sprengen. Lassen Sie uns daher auf die Tatsache eingehen, dass sie eine funktionierende HAProxy-Instanz namens </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zwei Backend-Server </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und erstellt haben </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Um HAProxy zu konfigurieren, verwenden wir zunächst die Datei </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und wechseln dann zu </font></font><code>haproxy-ratelimiting.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Einfachheit halber wurde die Konfigurationsdatei </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf das Nötigste reduziert und von Überschüssen befreit. Schauen wir es uns an:</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
use_backend api<font></font>
<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Abschnitt wird festgelegt </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dass HAProxy Port 80 überwacht und alle Anforderungen an den Serverpool </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im Backend </font><font style="vertical-align: inherit;">weiterleitet </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
KATEGORIE </font></font><code>backend api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gibt an </font><font style="vertical-align: inherit;">Backend - </font><font style="vertical-align: inherit;">Pool </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit zwei Back - </font><font style="vertical-align: inherit;">End - </font><font style="vertical-align: inherit;">Servern </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und die </font><font style="vertical-align: inherit;">entsprechenden Adressen. </font><font style="vertical-align: inherit;">Der Server für die Bearbeitung jeder eingehenden Anforderung wird vom Lastausgleichsalgorithmus ausgewählt </font></font><code>roundrobin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dh die beiden verfügbaren Server werden nacheinander verwendet.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lassen Sie uns alle drei unserer Container starten</font></font></h4><br>
<pre><code class="bash hljs">$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt haben wir einen Container </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, der Anforderungen an zwei Backends </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font><font style="vertical-align: inherit;">Server umleitet </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wir werden eine Antwort von einem von ihnen erhalten, wenn wir in die Adressleiste eingeben </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist interessant, die Seite mehrmals zu aktualisieren und die Protokolle anzuzeigen </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 09 +0000] "GET / HTTP / 1.1" 200 45</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen können, verarbeiten zwei Server </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nacheinander Anforderungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben jetzt eine HAProxy-Instanz mit einer sehr einfachen Lastausgleichskonfiguration und wir haben eine Vorstellung davon, wie es funktioniert.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fügen Sie ein Limit für die Anzahl der Anforderungen hinzu</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Anzahl der Anforderungen an den Load Balancer zu begrenzen, müssen Sie die Konfigurationsdatei in der HAProxy-Instanz ändern. </font><font style="vertical-align: inherit;">Stellen Sie sicher, dass der Container </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Konfigurationsdatei verwendet </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ändern Sie einfach die Docker-Datei, um die Konfigurationsdatei zu ersetzen.</font></font><br>
<br>
<pre><code class="plaintext hljs">FROM haproxy:1.7<font></font>
COPY haproxy-ratelimiter.cfg /usr/local/etc/haproxy/haproxy.cfg</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grenzen setzen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Einstellungen werden in der Konfigurationsdatei registriert </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Lass es uns sorgfältig studieren.</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80<font></font>
<font></font>
backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HAProxy bietet eine Reihe von Grundelementen auf niedriger Ebene, die mehr Flexibilität bieten und für eine Vielzahl von Anwendungsfällen geeignet sind. </font><font style="vertical-align: inherit;">Seine Zähler erinnern mich oft an das akkumulative Register (Addierer) in der CPU. </font><font style="vertical-align: inherit;">Sie speichern Zwischenergebnisse, verwenden unterschiedliche Semantiken als Eingabe, aber am Ende sind sie nur Zahlen. </font><font style="vertical-align: inherit;">Um alles gut zu verstehen, ist es sinnvoll, am Ende der Konfigurationsdatei zu beginnen.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tabelle </font></font><code>Abuse</code></h4><br>
<pre><code class="plaintext hljs">backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier haben wir ein Dummy-Backend namens </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">("Missbrauch") eingerichtet. </font><font style="vertical-align: inherit;">Fiktiv, weil es nur für Stick-Tabellen verwendet wird, auf die sich der Rest der Konfiguration mit Namen beziehen kann </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eine Stick-Tabelle ist eine im Prozessspeicher gespeicherte Tabelle, in der Sie für jeden Datensatz die Lebensdauer bestimmen können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unsere Tabelle hat folgende Eigenschaften:</font></font><br>
<br>
<ul>
<li><code>type ip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Anfragen werden in der Tabelle nach IP-Adresse als Schlüssel gespeichert. </font><font style="vertical-align: inherit;">Anfragen von derselben IP-Adresse beziehen sich daher auf denselben Datensatz. </font><font style="vertical-align: inherit;">Dies bedeutet im Wesentlichen, dass wir IP-Adressen und zugehörige Daten verfolgen.</font></font><br>
</li>
<li><code>size 100K</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Die Tabelle enthält maximal 100.000 Datensätze.</font></font><br>
</li>
<li><code>expire 30m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Die Aufbewahrungsdauer für Datensätze beträgt 30 Minuten Inaktivität.</font></font><br>
</li>
<li><code>store gpc0,http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Der Zähler </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und die Anzahl der IP-Adressanforderungen für die letzten 10 Sekunden werden </font><font style="vertical-align: inherit;">mit Einträgen gespeichert </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mithilfe der Hilfe können </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wir verfolgen, wie oft die IP-Adresse bei Missbrauch bemerkt wird. </font><font style="vertical-align: inherit;">Tatsächlich bedeutet ein positiver Zählerwert, dass die IP-Adresse bereits als verdächtig markiert ist. </font><font style="vertical-align: inherit;">Nennen wir diesen Zähler </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">können Sie anhand </font><font style="vertical-align: inherit;">der Tabelle </font><font style="vertical-align: inherit;">verfolgen, ob die IP-Adresse als verdächtig markiert ist und wie häufig Anfragen von dieser Adresse aktuell sind. </font><font style="vertical-align: inherit;">Daher haben wir eine Historie von Aufzeichnungen sowie Echtzeitinformationen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fahren wir nun mit dem Abschnitt fort </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und sehen, was dort neu ist.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACL-Funktionen und -Regeln</font></font></h4><br>
<pre><code class="plaintext hljs">frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zugriffssteuerungslisten (Access Control Lists, ACLs) sind Funktionsdeklarationen, die nur aufgerufen werden, wenn die Regel festgelegt ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Schauen wir uns alle drei ACL-Einträge genauer an. </font><font style="vertical-align: inherit;">Beachten Sie, dass alle explizit auf eine Tabelle verweisen </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in der IP-Adressen als Schlüssel verwendet werden. Daher gilt jede Funktion für die Anforderungs-IP-Adresse:</font></font><br>
<br>
<ul>
<li><code>acl is_abuse src_http_req_rate(Abuse) ge 10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Die Funktion wird </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zurückgegeben, </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenn die aktuelle Anforderungsfrequenz größer oder gleich zehn ist.</font></font><br>
</li>
<li><code>acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Die Funktion wird </font></font><code>inc_abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zurückgegeben, </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenn der Inkrementwert </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">größer als Null ist. </font><font style="vertical-align: inherit;">Da der Anfangswert </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Null ist, gibt diese Funktion immer zurück </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mit anderen Worten, es erhöht den Wert </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und signalisiert im Wesentlichen Missbrauch von dieser IP-Adresse.</font></font><br>
</li>
<li><code>acl abuse_cnt src_get_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Die Funktion wird </font></font><code>abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zurückgegeben, </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenn der Wert </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">größer als Null ist. </font><font style="vertical-align: inherit;">Mit anderen Worten, er sagt, wenn diese IP-Adresse bereits bei Missbrauch entdeckt wurde.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie bereits erwähnt, sind ACLs einfach Deklarationen, dh Funktionsdeklarationen. </font><font style="vertical-align: inherit;">Sie gelten nicht für eingehende Anforderungen, bis eine Regel ausgelöst wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist sinnvoll, die im selben Abschnitt definierten Regeln zu betrachten </font></font><code>frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Die Regeln werden nacheinander auf jede eingehende Anforderung angewendet - und führen die Funktionen über die soeben definierte ACL aus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, was jede Regel tut:</font></font><br>
<br>
<ul>
<li><code>tcp-request connection track-sc0 src table Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Fügt der Tabelle eine Abfrage hinzu </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Da der Schlüssel die IP-Adresse in der Tabelle ist, wird diese Regel zur Liste der IP-Adressen hinzugefügt.</font></font><br>
</li>
<li><code>tcp-request connection reject if abuse_cnt</code>:   TCP-,  IP-    ,     abuse.  ,   TCP-   IP-.<br>
</li>
<li><code>http-request deny if abuse_cnt</code>:  ,  IP-    .        IP-,      abuse.<br>
</li>
<li><code>http-request deny if is_abuse inc_abuse_cnt</code>:  ,  <code>is_abuse</code>  <code>inc_abuse_cnt</code>   <code>True</code>.  ,    ,    IP-        ,    IP-    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Wesentlichen führen wir zwei Arten von Überprüfungen ein: in Echtzeit und in der Blacklist aus dem Abfrageverlauf. </font><font style="vertical-align: inherit;">Die zweite Regel lehnt alle neuen TCP-Verbindungen ab, wenn die IP-Adresse bei Missbrauch festgestellt wurde. </font><font style="vertical-align: inherit;">Die dritte Regel verbietet den Dienst von HTTP-Anforderungen für eine IP-Adresse aus der schwarzen Liste, unabhängig von der aktuellen Häufigkeit von Anforderungen von dieser Adresse. </font><font style="vertical-align: inherit;">Die vierte Regel stellt sicher, dass HTTP-Anforderungen von einer IP-Adresse sofort abgelehnt werden, sobald der Schwellenwert für die Anforderungshäufigkeit überschritten wurde. </font><font style="vertical-align: inherit;">Daher funktioniert die zweite Regel hauptsächlich bei neuen TCP-Verbindungen, die dritte und vierte bei bereits eingerichteten Verbindungen, wobei die erste eine historische Prüfung und die zweite eine Echtzeitprüfung ist.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probieren wir den Filter in Aktion aus!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt können wir unsere Container wieder zusammenbauen und starten.</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo docker-compose down<font></font>
$ sudo docker-compose build<font></font>
$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Load Balancer sollte vor den beiden Backend-Servern gestartet werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leiten wir unseren Browser an </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn wir die Seite ein Dutzend Mal schnell aktualisieren, überschreiten wir den Schwellenwert von zehn Anfragen in einem Intervall von zehn Sekunden - und unsere Anfragen werden abgelehnt. </font><font style="vertical-align: inherit;">Wenn wir die Seite weiterhin aktualisieren, werden neue Anforderungen sofort abgelehnt - noch bevor die TCP-Verbindung hergestellt wurde.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragen</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum sind maximal zehn Anfragen pro zehn Sekunden zulässig?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Tabelle </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bestimmt </font></font><code>http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dh die Häufigkeit von Anforderungen wird in einem Fenster von zehn Sekunden gemessen. </font><font style="vertical-align: inherit;">Eine Funktion </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aus der ACL wird </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einer Anforderungsrate von ≥ 10 innerhalb des angegebenen Intervalls zurückgegeben. </font><font style="vertical-align: inherit;">Missbrauch wird daher als Häufigkeit von Anfragen von zehn oder mehr Anfragen in zehn Sekunden angesehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Artikel haben wir beispielsweise beschlossen, eine Untergrenze festzulegen, um die Überprüfung der Funktion des Begrenzers zu vereinfachen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist der Unterschied zwischen den Verbindungsregeln für http-Anfragen und TCP-Anfragen?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://cbonte.github.io/haproxy-dconv/1.7/configuration.html&amp;usg=ALkJrhhthq8lgLGK6rtJTyGXGEi5sECuiA#4.2-"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http-request: Die http-request-Anweisung definiert eine Reihe von Regeln, die auf der Netzwerkebene 7 gelten. [OSI-Modell]</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP-Anforderungsverbindung: Ausführen einer Aktion für eine eingehende Verbindung in Abhängigkeit von einer Bedingung auf der Netzwerkschicht 4</font></font></i></blockquote><br>
<h3>  HTTP-,        TCP-?</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stellen Sie sich vor, HTTP-Anforderungen an den Server senden mehrere TCP-Verbindungen von derselben IP-Adresse. </font><font style="vertical-align: inherit;">Die Häufigkeit von HTTP-Anforderungen überschreitet schnell die Schwellenwerte. </font><font style="vertical-align: inherit;">Dann tritt die vierte Regel in Kraft, die Anforderungen verwirft und die IP-Adresse auf die schwarze Liste setzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt ist es durchaus möglich, dass HTTP-Verbindungen von derselben IP-Adresse offen bleiben (siehe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dauerhafte HTTP-Verbindung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) und die Häufigkeit von HTTP-Anforderungen unter den Schwellenwert gefallen ist. </font><font style="vertical-align: inherit;">Die dritte Regel garantiert das fortgesetzte Blockieren von HTTP-Anforderungen, da diese </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf dieser IP ausgelöst werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, nach einigen Minuten versucht dieselbe IP, TCP-Verbindungen herzustellen. </font><font style="vertical-align: inherit;">Sie werden sofort gelöscht, da die zweite Regel gilt: Sie sieht die gekennzeichnete IP-Adresse und trennt die Verbindung sofort.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst kann es schwierig sein, die Begrenzung der Verarbeitungsgeschwindigkeit von Anforderungen mit HAProxy zu verstehen. </font><font style="vertical-align: inherit;">Um alles richtig zu machen, benötigen Sie ein ziemlich "niedriges" Denken und eine Reihe nicht intuitiver Aktionen. </font><font style="vertical-align: inherit;">Die Dokumentation in diesem Teil ist wahrscheinlich zu technisch und leidet unter dem Fehlen grundlegender Beispiele. </font><font style="vertical-align: inherit;">Wir hoffen, dass dieser Leitfaden das Manko ausgleicht und allen, die diesen Weg einschlagen möchten, die Richtung zeigt. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was noch zu lesen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie fehlertolerante Architektur in der Mail.ru Cloud Solutions-Plattform implementiert wird</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Top 10 Kubernetes Tricks und Tipps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unser Telegrammkanal zur digitalen Transformation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de499582/index.html">Predator-Prey-Modell bei Node.js.</a></li>
<li><a href="../de499584/index.html">Industrieller Touch-Monitor FPM-215W</a></li>
<li><a href="../de499586/index.html">Wie man die Navigation in mobilen Anwendungen durchdenkt</a></li>
<li><a href="../de499588/index.html">Authentifizierung in .NET Core gRpc mit JWT</a></li>
<li><a href="../de499592/index.html">AI: Die Welt von morgen ergänzen</a></li>
<li><a href="../de499598/index.html">Und wir werden nach Norden gehen! Wird es möglich sein, wetterbedingte Kühlung von Rechenzentren einzusparen?</a></li>
<li><a href="../de499600/index.html">Wie man zusammenarbeitet, getrennt arbeitet</a></li>
<li><a href="../de499602/index.html">Eine Konferenz online verschieben: InnerSource Commons Summit Experience</a></li>
<li><a href="../de499604/index.html">4 Argumente, um einen Direktor davon zu überzeugen, eine USV in einem kleinen Unternehmen zu kaufen</a></li>
<li><a href="../de499606/index.html">Videokonferenzsoftware: Skype, Hangouts und Zoom-Halbblut</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>