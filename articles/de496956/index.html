<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧘🏾 👨🏻‍🎨 🚴🏾 Warum wurden asynchrone Webserver angezeigt? 🏇🏾 👐🏽 💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo alle zusammen. In Kontakt Vladislav Rodin. Ich bin derzeit Leiter des High Load Architect-Kurses bei OTUS und unterrichte auch Kurse über Softwa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Warum wurden asynchrone Webserver angezeigt?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/496956/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo alle zusammen. </font><font style="vertical-align: inherit;">In Kontakt Vladislav Rodin. </font><font style="vertical-align: inherit;">Ich bin derzeit Leiter des High Load Architect-Kurses bei OTUS und unterrichte auch Kurse über Softwarearchitektur. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie Sie sehen, habe ich nicht nur unterrichtet, sondern auch für ein Blog-Copyright-Material OTUS Habré geschrieben. Der heutige Artikel möchte mit dem Beginn des Kurses </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Linux Administrator» zusammenfallen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , der jetzt geöffnet ist.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/mq/fl/9f/mqfl9f73j0kklcb2wikqonkd4rk.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einführung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum verlangsamt sich die Webanwendung und hält die Last nicht? </font><font style="vertical-align: inherit;">Die Entwickler, die als erste auf eine solche Frage stießen und einige Systeme erforschten, kamen zu dem enttäuschenden Ergebnis, dass die Optimierung einer Geschäftslogik allein nicht ausreichen würde. </font><font style="vertical-align: inherit;">Die Antwort auf diese Frage liegt auf einer niedrigeren Ebene - auf der Ebene des Betriebssystems. </font><font style="vertical-align: inherit;">Damit Ihre Anwendung die Last halten kann, muss das Architekturkonzept so überarbeitet werden, dass es auf dieser Ebene effektiv funktioniert. </font><font style="vertical-align: inherit;">Dies führte zur Entstehung asynchroner Webserver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider konnte ich kein einziges Material finden, mit dem ich alle kausalen Zusammenhänge in der Entwicklung von Webservern auf einmal wiederherstellen kann. </font><font style="vertical-align: inherit;">So kam die Idee auf, diesen Artikel zu schreiben, der hoffentlich zu einem solchen Material wird.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux-Betriebssystemfunktionen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor ich über die Modelle von Webservern spreche, erlaube ich mir, einige Funktionen der Prozesse und Threads unter Linux abzurufen. </font><font style="vertical-align: inherit;">Wir werden dies benötigen, wenn wir die Vor- und Nachteile der oben genannten Modelle analysieren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kontextwechsel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Höchstwahrscheinlich wird jeder Benutzer, der weiß, dass nur ein Programm gleichzeitig auf einem Prozessorkern ausgeführt werden kann, fragen: "Warum können 20 Programme gleichzeitig auf meinem 4-Kern-Prozessor gestartet werden?". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tatsächlich liegt dies an der Tatsache, dass </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">präventives Multitasking</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> stattfindet </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Das Betriebssystem weist eine bestimmte Zeitspanne (~ 50 μs) zu und setzt das Programm während dieser Zeit auf dem Kernel aus. </font><font style="vertical-align: inherit;">Nach Ablauf der Zeit wird der </font><b><font style="vertical-align: inherit;">Kontextwechsel </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unterbrochen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">umgeschaltet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Das heißt, das Betriebssystem setzt einfach das nächste auszuführende Programm. </font><font style="vertical-align: inherit;">Da häufig gewechselt wird, haben wir den Eindruck, dass alle Programme gleichzeitig arbeiten. </font><font style="vertical-align: inherit;">Achten Sie auf die hohe Schaltfrequenz, dies ist wichtig für die nachfolgende Präsentation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Kontextwechsel wurde oben erwähnt. </font><font style="vertical-align: inherit;">Was beinhaltet es? </font><font style="vertical-align: inherit;">Beim Umschalten des Kontexts müssen die Prozessorregister gespeichert, die Befehlspipeline gelöscht und die dem Prozess zugewiesenen Speicherbereiche gespeichert werden. </font><font style="vertical-align: inherit;">Im Allgemeinen ist die Operation ziemlich teuer. </font><font style="vertical-align: inherit;">Es dauert ~ 0,5 μs, während die Ausführung einer einfachen Codezeile ~ 1 ns beträgt. </font><font style="vertical-align: inherit;">Darüber hinaus steigt mit zunehmender Anzahl von Prozessen pro Prozessorkern der Overhead für die Kontextumschaltung.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webserver-Modelle</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Derzeit existieren die folgenden Webservermodelle:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeiter</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorgabel</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchron</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kombiniert</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns jeden von ihnen einzeln diskutieren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeiter und Vorgabel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Historisch gesehen begann mit diesen Modellen alles. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Wesentliche ist sehr einfach</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Wenn ein Kunde zu uns kommt, wählen wir einen separaten Handler für ihn aus, der den eingehenden Kunden von Anfang bis Ende verarbeitet. Ein Handler kann entweder ein Prozess (Prefork) oder ein Thread (Worker) sein. Ein Beispiel für einen solchen Webserver ist der bekannte Apache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde sofort eine Reservierung vornehmen: Das Erstellen eines neuen Handlers für jeden Kunden ist teuer. Erstens führt bei einer konstanten Anzahl von Kernen eine Erhöhung der Anzahl von Prozessoren zu einer Erhöhung der Latenz (aufgrund von Kontextwechseln). Zweitens wächst die erforderliche Speichermenge linear mit der Zunahme der Clients, da selbst wenn Sie Threads mit gemeinsamer Speicherung verwenden, jeder Thread seinen eigenen Stapel hat. Somit ist die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzahl der gleichzeitig verarbeiteten Clients begrenzt.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Größe des Pools hängt wiederum von der Anzahl der Prozessorkerne ab. </font><font style="vertical-align: inherit;">Das Problem wird mit vertikalen Skalierungsmethoden gelöst. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein weiterer grundlegender Nachteil solcher Server ist die nicht optimale Nutzung der Ressourcen. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prozesse (oder Threads) sind die meiste Zeit inaktiv</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Stellen Sie sich die folgende Situation vor: Während der Clientverarbeitung müssen einige Daten von der Festplatte abgerufen, eine Anforderung an die Datenbank gestellt oder etwas in das Netzwerk geschrieben werden. </font><font style="vertical-align: inherit;">Da das Lesen von einer Festplatte unter Linux ein </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blockierender Vorgang ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , bleibt der Prozess (oder Thread) hängen und wartet auf eine Antwort, nimmt jedoch weiterhin an der Zuweisung der Prozessorzeit teil.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arbeiter gegen Vorgabel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arbeiter und Vorgabel haben einige grundlegende Unterschiede. </font><font style="vertical-align: inherit;">Streams sind im Speicher etwas wirtschaftlicher, weil sie ihn gemeinsam nutzen. </font><font style="vertical-align: inherit;">Aus dem gleichen Grund ist ein Kontextwechsel zwischen ihnen einfacher als zwischen Prozessen. </font><font style="vertical-align: inherit;">Im Fall eines Workers wird der Code jedoch multithreaded, da die Threads synchronisiert werden müssen. </font><font style="vertical-align: inherit;">Als Ergebnis erhalten wir alle „Reize“ von Multithread-Code: Es wird schwieriger, ihn zu schreiben, zu lesen, zu testen und zu debuggen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchrones Modell</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Worker und Prefork erlauben es daher aufgrund der begrenzten Poolgröße nicht, eine große Anzahl von Clients gleichzeitig zu verarbeiten, und nutzen Ressourcen aufgrund von Kontextwechsel und Blockieren von Systemaufrufen nicht optimal. Wie Sie sehen können, ist das Problem Multithreading und ein schwerer OS-Scheduler. Dies führt zu der folgenden Idee: Lassen Sie uns Clients in nur einem Thread verarbeiten, aber zu 100% laden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solche Server basieren auf einer Ereignisschleife und einer Reaktorvorlage ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ereignismaschine</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Der Client-Code, der eine E / A-Operation initiiert, registriert einen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rückruf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einer Prioritätswarteschlange (Priorität ist Bereitschaftszeit). Die Ereignisschleife fragt die auf E / A wartenden Deskriptoren ab und aktualisiert dann die Priorität (falls verfügbar). Darüber hinaus zieht die Ereignisschleife Ereignisse aus der Prioritätswarteschlange heraus, wodurch Rückrufe am Ende die Steuerung an die Ereignisschleife zurückgeben. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit diesem Modell können Sie eine große Anzahl von Clients verwalten und so den Overhead vermeiden, den Kontext zu wechseln</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dieses Modell ist nicht perfekt und hat mehrere Nachteile. Erstens wird </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht mehr als ein Prozessorkern verbraucht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da es nur einen Prozess gibt. Dies wird unter Verwendung eines kombinierten Modells behandelt, das unten diskutiert wird. Zweitens sind </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kunden durch diesen Prozess verbunden.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Der Code muss sorgfältig geschrieben werden. </font><font style="vertical-align: inherit;">Speicherlecks, Fehler führen dazu, dass alle Clients auf einmal abfallen. </font><font style="vertical-align: inherit;">Darüber hinaus sollte dieser Prozess durch nichts blockiert werden. Ein Rückruf sollte nicht darin bestehen, einige schwierige Aufgaben zu lösen, da alle Clients blockiert werden. </font><font style="vertical-align: inherit;">Drittens ist </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchroner Code viel komplizierter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es ist notwendig, einen zusätzlichen Rückruf zu registrieren, damit die Daten nicht kommen, um das Problem der korrekten Verzweigung usw. zu lösen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kombiniertes Modell</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Modell wird in realen Servern verwendet. </font><font style="vertical-align: inherit;">Dieses Modell verfügt über einen Pool von Prozessen, von denen jeder über einen Pool von Threads verfügt, von denen jeder wiederum ein Verarbeitungsmodell verwendet, das auf asynchroner Eingabe / Ausgabe basiert. </font><font style="vertical-align: inherit;">Nginx präsentiert ein kombiniertes Modell.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ausgehend von den Grundlagen des Betriebssystems haben wir die konzeptionellen Unterschiede zwischen den in Apache und Nginx verwendeten Webservermodellen untersucht. </font><font style="vertical-align: inherit;">Jeder von ihnen hat seine eigenen Vor- und Nachteile, so dass ihre Kombination häufig in der Produktion verwendet wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Idee der asynchronen Verarbeitung hat sich weiterentwickelt: Auf der Ebene der Sprachplattformen entstanden die Konzepte der grünen Fäden / Fasern / Goroutinen, mit denen Sie die Asynchronität von Eingabe und Ausgabe "unter der Haube verstecken" können, sodass der Entwickler mit einem schönen synchronen Code zufrieden ist. </font><font style="vertical-align: inherit;">Dieses Konzept verdient jedoch einen separaten Artikel.</font></font><br>
<br>
<hr><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Erfahren Sie mehr über den Kurs.</font></font></a></b><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de496944/index.html">Digitale Veranstaltungen in St. Petersburg vom 13. bis 19. April</a></li>
<li><a href="../de496946/index.html">Noch einmal über GPG-Hardwareschlüssel für einen Cent</a></li>
<li><a href="../de496950/index.html">Design ist Design, nicht die Schönheit von Bildern.</a></li>
<li><a href="../de496952/index.html">Qualcomm QCC3020 - der Aufstieg der chinesischen TWS-Kopfhörer</a></li>
<li><a href="../de496954/index.html">Entwicklung bei Wargaming - Treffen mit Maxim Baryshnikov, Leiter der Plattform (Teil I)</a></li>
<li><a href="../de496958/index.html">Interessante CSS-Funde im neuen Facebook-Design</a></li>
<li><a href="../de496960/index.html">Beschleunigen von Diagrammen mit OffscreenCanvas</a></li>
<li><a href="../de496962/index.html">Wie räume ich einen überlasteten Server auf?</a></li>
<li><a href="../de496964/index.html">IBM wöchentliche Seminare - April 2020</a></li>
<li><a href="../de496966/index.html">CSS LCH Farben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>