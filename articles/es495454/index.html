<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí™üèø üìà ‚óΩÔ∏è Breve introducci√≥n a BPF y eBPF üï∫üèº ü§õüèæ üóûÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Le informamos que nos estamos preparando para lanzar el libro " Observabilidad de Linux con BPF ".
 
 
 A medida que la m√°quina virtual BPF...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Breve introducci√≥n a BPF y eBPF</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/495454/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! </font><font style="vertical-align: inherit;">Le informamos que nos estamos preparando para lanzar el libro " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observabilidad de Linux con BPF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pw/bv/rl/pwbvrl5-5goay7zxvi8tb3fisrc.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A medida que la m√°quina virtual BPF contin√∫a evolucionando y se aplica activamente en la pr√°ctica, hemos traducido un art√≠culo para usted que describe sus caracter√≠sticas principales y su estado actual.</font></font><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los √∫ltimos a√±os, las herramientas y t√©cnicas de programaci√≥n han comenzado a ganar popularidad, dise√±adas para compensar las limitaciones del kernel de Linux en los casos en que se requiere un procesamiento de paquetes de alto rendimiento. Uno de los m√©todos m√°s populares de este tipo se llama </font><font style="vertical-align: inherit;">omitir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el kernel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (omisi√≥n de kernel) y permite que los n√∫cleos de capa de red que pasan realicen todo el procesamiento de paquetes desde el espacio del usuario. Omitir el n√∫cleo tambi√©n implica administrar la tarjeta de red desde </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el espacio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del </font><i><font style="vertical-align: inherit;">usuario</font></i><font style="vertical-align: inherit;"> . En otras palabras, cuando trabajamos con una tarjeta de red, confiamos en el controlador de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espacio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del </font><i><font style="vertical-align: inherit;">usuario</font></i><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al transferir el control total sobre la tarjeta de red al programa desde el espacio del usuario, reducimos los costos asociados con el kernel (cambio de contexto, procesamiento del nivel de red, interrupciones, etc.), lo cual es bastante importante cuando se trabaja a velocidades de 10 Gb / so m√°s. El bypass del kernel m√°s una combinaci√≥n de otras caracter√≠sticas ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">procesamiento por lotes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) y un ajuste preciso del rendimiento ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contabilidad NUMA</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aislamiento de la CPU</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc.) corresponden a los principios b√°sicos del procesamiento de red de alto rendimiento en el espacio del usuario. Quiz√°s un ejemplo modelo de este nuevo enfoque para el procesamiento de paquetes es </font><font style="vertical-align: inherit;">el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DPDK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de Intel ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kit de desarrollo de plano de datos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), aunque existen otras herramientas y t√©cnicas bien conocidas, como VPP de Cisco (Vector Packet Processing), Netmap y, por supuesto, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snabb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La organizaci√≥n de las interacciones de red en el espacio del usuario tiene una serie de desventajas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El n√∫cleo del sistema operativo es el nivel de abstracci√≥n para los recursos de hardware. </font><font style="vertical-align: inherit;">Debido a que los programas de espacio de usuario deben administrar sus recursos directamente, tambi√©n deben administrar su propio hardware. </font><font style="vertical-align: inherit;">Esto a menudo significa que necesita programar sus propios controladores.</font></font></li>
<li>      ,        ,  .        , , ,      .</li>
<li>    ,               .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esencia, cuando se organizan interacciones de red en el espacio del usuario, se logra aumentar la productividad al transferir el procesamiento de paquetes desde el n√∫cleo al espacio del usuario. XDP hace exactamente lo contrario: mueve los programas de red desde el espacio del usuario (filtros, convertidores, enrutamiento, etc.) al √°rea del kernel. XDP nos permite realizar una funci√≥n de red tan pronto como el paquete llega a la interfaz de red y antes de que comience a subir al subsistema de red del n√∫cleo. Como resultado, la velocidad de procesamiento de paquetes aumenta significativamente. Sin embargo, ¬øc√≥mo permite el n√∫cleo al usuario ejecutar sus programas en el espacio del n√∫cleo? Antes de responder esta pregunta, veamos qu√© es BPF. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF y eBPF</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesar del nombre no tan claro BPF (filtrado de paquetes, Berkeley), es, de hecho, un modelo de m√°quina virtual. </font><font style="vertical-align: inherit;">Esta m√°quina virtual fue dise√±ada originalmente para manejar el filtrado de paquetes, de ah√≠ el nombre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una de las herramientas m√°s conocidas que utilizan BPF es </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Al capturar paquetes con, el </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usuario puede especificar una expresi√≥n para filtrar paquetes. </font><font style="vertical-align: inherit;">Solo se capturar√°n los paquetes que coincidan con esta expresi√≥n. </font><font style="vertical-align: inherit;">Por ejemplo, la expresi√≥n " </font></font><code>tcp dst port 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" se aplica a todos los paquetes TCP que llegan al puerto 80. El compilador puede acortar esta expresi√≥n al convertirla en c√≥digo de bytes BPF. </font><font style="vertical-align: inherit;">
Esto es lo que b√°sicamente hace el programa anterior:</font></font><br>
<br>
<code>$ sudo tcpdump -d "tcp dst port 80"<br>
(000) ldh [12]<br>
(001) jeq #0x86dd jt 2 jf 6<br>
(002) ldb [20]<br>
(003) jeq #0x6 jt 4 jf 15<br>
(004) ldh [56]<br>
(005) jeq #0x50 jt 14 jf 15<br>
(006) jeq #0x800 jt 7 jf 15<br>
(007) ldb [23]<br>
(008) jeq #0x6 jt 9 jf 15<br>
(009) ldh [20]<br>
(010) jset #0x1fff jt 15 jf 11<br>
(011) ldxb 4*([14]&amp;0xf)<br>
(012) ldh [x + 16]<br>
(013) jeq #0x50 jt 14 jf 15<br>
(014) ret #262144<br>
(015) ret #0</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instrucci√≥n (000): descarga un paquete en el desplazamiento 12 como una palabra de 16 bits en la bater√≠a. </font><font style="vertical-align: inherit;">Un desplazamiento de 12 corresponde a un paquete ethertype.</font></font></li>
<li> (001):      0x86dd,  ,  ethertype-  IPv6.    true,       (002),    ‚Äì   (006).</li>
<li> (006):    0x800 (ethertype-  IPv4).   true,     (007),   ‚Äì   (015).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y as√≠ sucesivamente, hasta que el programa de filtrado de paquetes devuelva un resultado. Esto suele ser un bulean. Devolver un valor distinto de cero (instrucci√≥n (014)) significa que el paquete se ha acercado, y devolver cero (instrucci√≥n (015)) significa que el paquete no ha llegado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√°quina virtual BPF y su </font><font style="vertical-align: inherit;">c√≥digo de bytes </font><font style="vertical-align: inherit;">fueron propuestos por Steve McCann y Van Jacobson a fines de 1992 cuando su art√≠culo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSD Packet Filter: A New Architecture for Packet Capture at User Level</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se present√≥ por primera vez en una conferencia de Usenix en el invierno de 1993.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como BPF es una m√°quina virtual, define el entorno en el que se ejecutan los programas. Adem√°s del c√≥digo de bytes, tambi√©n define un modelo de memoria por lotes (las instrucciones de arranque se aplican impl√≠citamente al paquete), los registros (A y X; registros de bater√≠a e √≠ndice), almacenamiento de memoria temporal y un contador de programa impl√≠cito. Curiosamente, el c√≥digo de bytes BPF fue modelado despu√©s del Motorola 6502 ISA. Como Steve McCann record√≥ en su </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">charla plenaria</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en Sharkfest '11, hab√≠a estado familiarizado con la construcci√≥n 6502 desde la escuela secundaria cuando program√≥ en Apple II, y este conocimiento influy√≥ en su trabajo en el dise√±o del c√≥digo de bytes BPF.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El soporte para BPF se implementa en el kernel de Linux en la versi√≥n v2.5 y superior, agregado principalmente por los esfuerzos de Jay Schullist. El c√≥digo BPF permaneci√≥ sin cambios hasta 2011, cuando Eric Dumazett rehizo el int√©rprete BPF para que funcione en modo JIT (Fuente: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIT para filtros de paquetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Despu√©s de eso, el n√∫cleo, en lugar de interpretar el c√≥digo de bytes BPF, podr√≠a convertir directamente los programas BPF a la arquitectura de destino: x86, ARM, MIPS, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√°s tarde, en 2014, Alexey Starovoitov propuso un nuevo mecanismo JIT para BPF. </font><font style="vertical-align: inherit;">De hecho, este nuevo JIT se ha convertido en la nueva arquitectura basada en BPF y se llama eBPF. </font><font style="vertical-align: inherit;">Creo que durante alg√∫n tiempo ambas m√°quinas virtuales coexistieron, pero actualmente el filtrado de paquetes se implementa en base a eBPF. </font><font style="vertical-align: inherit;">De hecho, en muchos ejemplos de documentaci√≥n moderna, se entiende que BPF significa eBPF, y el BPF cl√°sico ahora se conoce como cBPF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPF extiende la cl√°sica m√°quina virtual BPF de varias maneras:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basado en arquitecturas modernas de 64 bits. </font><font style="vertical-align: inherit;">eBPF utiliza registros de 64 bits y aumenta el n√∫mero de registros disponibles de 2 (bater√≠a y X) a 10. eBPF tambi√©n proporciona c√≥digos de operaci√≥n adicionales (BPF_MOV, BPF_JNE, BPF_CALL ...).</font></font></li>
<li>    . BPF      .      ,     ,   . ,   eBPF            . ,   eBPF    tracepoint   kprobe.      eBPF,            .   eBPF    : kernel/bpf.</li>
<li>     .  ‚Äì    ¬´-¬ª,         .  eBPF    .</li>
<li> .  ,   ,      .            .  ,   eBPF    .</li>
<li> .    eBPF  4096 .      eBPF    eBPF-       (     32 ).</li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF: un ejemplo</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hay varios ejemplos para eBPF en las fuentes del kernel de Linux. </font><font style="vertical-align: inherit;">Est√°n disponibles en samples / bpf /. </font><font style="vertical-align: inherit;">Para compilar estos ejemplos, simplemente ingrese: </font></font><br>
<br>
<code>$ sudo make samples/bpf/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No escribir√© un nuevo ejemplo para eBPF, pero usar√© una de las muestras disponibles en samples / bpf /. </font><font style="vertical-align: inherit;">Ver√© algunas secciones del c√≥digo y explicar√© c√≥mo funciona. </font><font style="vertical-align: inherit;">Como ejemplo, eleg√≠ un programa </font></font><code>tracex4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, cada uno de los ejemplos en samples / bpf / consta de dos archivos. </font><font style="vertical-align: inherit;">En este caso:</font></font><br>
<br>
<ul>
<li><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contiene el c√≥digo fuente que debe ejecutarse en el n√∫cleo como c√≥digo de bytes eBPF.</font></font></li>
<li><code>tracex4_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contiene un programa desde el espacio del usuario.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, necesitamos compilar el </font></font><code> tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF en bytecode. </font><font style="vertical-align: inherit;">Actualmente </font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no hay ninguna parte del servidor para eBPF. </font><font style="vertical-align: inherit;">Afortunadamente, </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede emitir bytecode eBPF. </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Makefile</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utiliza </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para compilar </font></font><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un archivo objeto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mencion√© anteriormente que una de las caracter√≠sticas m√°s interesantes de eBPF son las tarjetas. </font><font style="vertical-align: inherit;">tracex4_kern define un mapa:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> {</span><font></font>
    u64 val;<font></font>
    u64 ip;<font></font>
};  <font></font>
<font></font>
<span class="hljs-function">struct bpf_map_def <span class="hljs-title">SEC</span><span class="hljs-params">(<span class="hljs-string">"maps"</span>)</span> my_map </span>= {<font></font>
    .type = BPF_MAP_TYPE_HASH,<font></font>
    .key_size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>),<font></font>
    .value_size = <span class="hljs-keyword">sizeof</span>(struct pair),<font></font>
    .max_entries = <span class="hljs-number">1000000</span>,<font></font>
};</code></pre><br>
<code>BPF_MAP_TYPE_HASH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Uno de los muchos tipos de tarjetas que ofrece eBPF. </font><font style="vertical-align: inherit;">En este caso, es solo un hash. </font><font style="vertical-align: inherit;">Tambi√©n puede haber notado un anuncio </font></font><code>SEC("maps")</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">SEC es una macro utilizada para crear una nueva secci√≥n de un archivo binario. </font><font style="vertical-align: inherit;">En realidad, el ejemplo </font></font><code>tracex4_kern</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define dos secciones m√°s:</font></font><br>
<br>
<pre><code class="cpp hljs">SEC(<span class="hljs-string">"kprobe/kmem_cache_free"</span>)
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog1</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{   
    <span class="hljs-keyword">long</span> ptr = PT_REGS_PARM2(ctx);<font></font>
<font></font>
    bpf_map_delete_elem(&amp;my_map, &amp;ptr); <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
    <font></font>
SEC(<span class="hljs-string">"kretprobe/kmem_cache_alloc_node"</span>) 
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog2</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{
    <span class="hljs-keyword">long</span> ptr = PT_REGS_RC(ctx);
    <span class="hljs-keyword">long</span> ip = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  ip-   kmem_cache_alloc_node() </span><font></font>
    BPF_KRETPROBE_READ_RET_IP(ip, ctx);<font></font>
<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> <span class="hljs-title">v</span> = {</span><font></font>
        .val = bpf_ktime_get_ns(),<font></font>
        .ip = ip,<font></font>
    };<font></font>
    <font></font>
    bpf_map_update_elem(&amp;my_map, &amp;ptr, &amp;v, BPF_ANY);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estas dos funciones le permiten eliminar una entrada de la tarjeta ( </font></font><code>kprobe/kmem_cache_free</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) y agregar un nuevo registro ( </font></font><code>kretprobe/kmem_cache_alloc_node</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">a la tarjeta </font><font style="vertical-align: inherit;">. Todos los nombres de funciones escritos en may√∫sculas corresponden a las macros definidas en </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bpf_helpers.h</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si produzco un volcado de secciones del archivo de objeto, deber√≠a ver que estas nuevas secciones ya est√°n definidas: </font><font style="vertical-align: inherit;">
Todav√≠a all√≠ </font><font style="vertical-align: inherit;">, el programa principal. B√°sicamente, este programa escucha eventos </font><font style="vertical-align: inherit;">. Cuando ocurre tal evento, se ejecuta el c√≥digo eBPF correspondiente. El c√≥digo almacena el atributo IP del objeto en el mapa, y luego este objeto se muestra c√≠clicamente en el programa principal. Ejemplo: </font><font style="vertical-align: inherit;">
¬øC√≥mo se relacionan el programa de espacio de usuario y el programa eBPF? En la inicializaci√≥n, </font><font style="vertical-align: inherit;">carga un archivo de objeto </font><font style="vertical-align: inherit;">usando una funci√≥n </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<code>$ objdump -h tracex4_kern.o<br>
<br>
tracex4_kern.o: file format elf64-little<br>
<br>
Sections:<br>
Idx Name Size VMA LMA File off Algn<br>
 0 .text 00000000 0000000000000000 0000000000000000 00000040 2**2<br>
 CONTENTS, ALLOC, LOAD, READONLY, CODE<br>
 1 kprobe/kmem_cache_free 00000048 0000000000000000 0000000000000000 00000040 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 2 kretprobe/kmem_cache_alloc_node 000000c0 0000000000000000 0000000000000000 00000088 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 3 maps 0000001c 0000000000000000 0000000000000000 00000148 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 4 license 00000004 0000000000000000 0000000000000000 00000164 2**0<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 5 version 00000004 0000000000000000 0000000000000000 00000168 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 6 .eh_frame 00000050 0000000000000000 0000000000000000 00000170 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</code><br>
<br><font style="vertical-align: inherit;"></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tracex4_user.c</a></code><font style="vertical-align: inherit;"></font><code>kmem_cache_alloc_node</code><font style="vertical-align: inherit;"></font><br>
<br>
<code>$ sudo ./tracex4<br>
obj 0xffff8d6430f60a00 is 2sec old was allocated at ip ffffffff9891ad90<br>
obj 0xffff8d6062ca5e00 is 23sec old was allocated at ip ffffffff98090e8f<br>
obj 0xffff8d5f80161780 is 6sec old was allocated at ip ffffffff98090e8f</code><br>
<br><font style="vertical-align: inherit;"></font><code>tracex4_user.c</code><font style="vertical-align: inherit;"></font><code>tracex4_kern.o</code><font style="vertical-align: inherit;"></font><code>load_bpf_file</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> ac, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">r</span> = {</span>RLIM_INFINITY, RLIM_INFINITY};
    <span class="hljs-keyword">char</span> filename[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
    <span class="hljs-built_in">snprintf</span>(filename, <span class="hljs-keyword">sizeof</span>(filename), <span class="hljs-string">"%s_kern.o"</span>, argv[<span class="hljs-number">0</span>]);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (setrlimit(RLIMIT_MEMLOCK, &amp;r)) {<font></font>
        perror(<span class="hljs-string">"setrlimit(RLIMIT_MEMLOCK, RLIM_INFINITY)"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (load_bpf_file(filename)) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, bpf_log_buf);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; ; i++) {<font></font>
        print_old_objects(map_fd[<span class="hljs-number">1</span>]);<font></font>
        sleep(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se ejecuta, </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">load_bpf_file</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se agregan </font><font style="vertical-align: inherit;">las </font><font style="vertical-align: inherit;">sondas definidas en el archivo eBPF </font></font><code>/sys/kernel/debug/tracing/kprobe_events</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ahora estamos escuchando estos eventos, y nuestro programa puede hacer algo cuando suceden. </font><font style="vertical-align: inherit;">
Todos los dem√°s programas en sample / bpf / est√°n estructurados de manera similar. </font><font style="vertical-align: inherit;">Siempre tienen dos archivos:</font></font><br>
<br>
<code>$ sudo cat /sys/kernel/debug/tracing/kprobe_events<br>
p:kprobes/kmem_cache_free kmem_cache_free<br>
r:kprobes/kmem_cache_alloc_node kmem_cache_alloc_node</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><code>XXX_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: programa eBPF.</font></font></li>
<li><code>XXX_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: programa principal.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El programa eBPF define las tarjetas y funciones asociadas con la secci√≥n. </font><font style="vertical-align: inherit;">Cuando el kernel lanza un evento de cierto tipo (por ejemplo, </font></font><code>tracepoint</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), se ejecutan las funciones enlazadas. </font><font style="vertical-align: inherit;">Los mapas proporcionan intercambio de datos entre el programa del n√∫cleo y el programa de espacio de usuario. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Este art√≠culo describi√≥ BPF y eBPF. </font><font style="vertical-align: inherit;">S√© que hoy hay mucha informaci√≥n y recursos sobre eBPF, por lo que recomiendo algunos materiales m√°s para estudiar m√°s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recomiendo leer:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF: la m√°quina virtual universal en el n√∫cleo de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jonathan Corbett. </font><font style="vertical-align: inherit;">Una introducci√≥n a BPF y c√≥mo evolucion√≥ a eBPF.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">A thorough introduction to eBPF</a>  .    LWN.net.      eBPF           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>.</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Notes on BPF &amp; eBPF</a>  .      ‚ÄúThe BSD Packet Filter: A New Architecture for User-level Packet Capture‚Äù.        .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">eBPF, part1: Past, Present and Future</a>  .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>,   .      eBPF,   .</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495440/index.html">Los servidores en los Pa√≠ses Bajos est√°n a punto de finalizar: es posible que no se puedan cumplir los nuevos pedidos, ¬øterminar√°n el VPS y el Internet?</a></li>
<li><a href="../es495446/index.html">La antigravedad no es lo que pensabas</a></li>
<li><a href="../es495448/index.html">Mitaps en l√≠nea para toda la semana en back, front, QA, PM, DevOps y un poco en robots, a partir del 3 de abril</a></li>
<li><a href="../es495450/index.html">Depuraci√≥n de aplicaciones Golang muy cargadas o c√≥mo buscamos un problema en Kubernetes que no estaba all√≠</a></li>
<li><a href="../es495452/index.html">C√≥mo preparar un sitio para el crecimiento de la carga.</a></li>
<li><a href="../es495456/index.html">Revisi√≥n de 14 complementos nuevos para Figma que ayudar√°n a aumentar la productividad mientras todos</a></li>
<li><a href="../es495458/index.html">C√≥mo escribir c√≥digo cuando los ni√±os corren a tu alrededor y te preguntan: "¬øPara qu√© trabajar√°s?"</a></li>
<li><a href="../es495460/index.html">Una burbuja de gas 22,000 veces el tama√±o de la Tierra explot√≥ en Urano</a></li>
<li><a href="../es495462/index.html">.NET Core: intr√≠nseca x86_64 en m√°quinas virtuales</a></li>
<li><a href="../es495464/index.html">Mensaje de informaci√≥n 404: no solo un error, sino tambi√©n un feriado</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>