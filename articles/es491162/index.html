<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧙🏾 🙅 🧙 PostgreSQL Antipatterns: una historia sobre el refinamiento iterativo de la búsqueda por nombre u "Optimización de ida y vuelta" 📐 📡 🤘🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Miles de gerentes de oficinas de ventas en todo el país registran decenas de miles de contactos en nuestro sistema CRM  todos los días , hechos de com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL Antipatterns: una historia sobre el refinamiento iterativo de la búsqueda por nombre u "Optimización de ida y vuelta"</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/491162/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Miles de gerentes de oficinas de ventas en todo el país registran </font><b><font style="vertical-align: inherit;">decenas de miles de contactos</font></b><font style="vertical-align: inherit;"> en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuestro sistema CRM </font></font></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos los días</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , hechos de comunicación con clientes potenciales o que ya trabajan con nosotros. Y para este cliente primero debe encontrar, y preferiblemente muy rápidamente. Y esto sucede con mayor frecuencia por su nombre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, no es sorprendente que, una vez más analizando las solicitudes "pesadas" en una de las bases de datos más cargadas, nuestra propia </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuenta VLSI corporativa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , encontré "en la parte superior" una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitud de búsqueda "rápida" por nombre</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de tarjetas de empresa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, una investigación adicional reveló un ejemplo interesante de </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimización y luego degradación del rendimiento.</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solicitud en su posterior refinamiento por varios equipos, cada uno de los cuales actuó únicamente con buenas intenciones.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0: qué quería el usuario</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/du/k9/mg/duk9mgzeofw0ka5_lrg8lewch7k.png"></div><font color="#c0c0c0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[KDPV </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desde aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
¿Qué quiere decir usualmente el usuario cuando dice "búsqueda rápida" por nombre? </font><font style="vertical-align: inherit;">Casi nunca resulta ser una búsqueda "honesta" en una subcadena de tipo </font></font><code>... LIKE '%%'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, porque entonces no solo </font><font style="vertical-align: inherit;">y </font><font style="vertical-align: inherit;">, sino </font><font style="vertical-align: inherit;">incluso, incluso </font><font style="vertical-align: inherit;">obtienen el resultado </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
El usuario implica a nivel de hogar que le proporcionará una </font><b><font style="vertical-align: inherit;">búsqueda al comienzo de una palabra</font></b><font style="vertical-align: inherit;"> en el título y mostrará más relevante lo que </font><b><font style="vertical-align: inherit;">comienza con el</font></b><font style="vertical-align: inherit;"> ingresado. </font><font style="vertical-align: inherit;">Y hágalo </font><b><font style="vertical-align: inherit;">casi instantáneamente</font></b><font style="vertical-align: inherit;"> , con entrada interlineal.</font></font><code>'<u></u>'</code><font style="vertical-align: inherit;"></font><code>' <u></u>'</code><font style="vertical-align: inherit;"></font><code>'<u></u>'</code><font style="vertical-align: inherit;"></font><code>'  <u></u>'</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1: limitar la tarea</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aún más, una persona no ingresará específicamente </font></font><code>' '</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que tenga que buscar cada prefijo de palabra. </font><font style="vertical-align: inherit;">No, es mucho más fácil para el usuario responder a una pista rápida para la última palabra que "omitir" deliberadamente las anteriores; vea cómo funciona cualquier motor de búsqueda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, </font><font style="vertical-align: inherit;">formular </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">correctamente los</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> requisitos para una tarea es más de la mitad de la solución. </font><font style="vertical-align: inherit;">A veces, un análisis cuidadoso del caso de uso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede afectar significativamente el resultado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué hace el desarrollador abstracto?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.0: motor de búsqueda externo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh, buscar es difícil, no quiero hacer nada en absoluto, ¡vamos a dárselo a los devops! </font><font style="vertical-align: inherit;">Permítanos desplegarnos un motor de búsqueda externo en relación con la base de datos: Sphinx, ElasticSearch, ... Una </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
opción que funciona, aunque consume mucho tiempo, en términos de sincronización y velocidad de cambio. </font><font style="vertical-align: inherit;">Pero no en nuestro caso, ya que la búsqueda se realiza para cada cliente solo en el marco de los datos de su cuenta. </font><font style="vertical-align: inherit;">Y los datos tienen una variabilidad bastante alta, y si el administrador ahora ha insertado la tarjeta </font></font><code>' '</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, después de 5-10 segundos ya puede recordar que olvidó indicar el correo electrónico allí y desea encontrarlo y corregirlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, busquemos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"directamente en la base de datos"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Afortunadamente, PostgreSQL nos permite hacer esto, y no solo una opción: las consideraremos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1: subcadena "honesta"</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos aferramos a la palabra "subcadena". </font><font style="vertical-align: inherit;">Pero exactamente para la búsqueda de índice por subcadena (¡e incluso por expresiones regulares!) ¡Hay un excelente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">módulo pg_trgm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Solo entonces será necesario ordenar correctamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tratemos de tomar un plato para simplificar el modelo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> firms(
  <span class="hljs-keyword">id</span>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">text</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Completamos allí 7.8 millones de registros de organizaciones reales e indexamos:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> EXTENSION pg_trgm;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms <span class="hljs-keyword">USING</span> gin(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) gin_trgm_ops);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Busquemos las primeras 10 entradas para la búsqueda entre líneas:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'(^|\s)'</span> || <span class="hljs-string">''</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--  " "</span>
, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;
</code></pre><br>
<img src="https://habrastorage.org/webt/0m/pk/su/0mpksuspk5xdasdj7mtg5ch4jvw.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[eche un vistazo a explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Bueno, eso es ... </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">26 ms, 31 MB de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> datos leídos y más de 1.700 registros filtrados, para 10 personas </font><font style="vertical-align: inherit;">La sobrecarga es demasiado alta, ¿es posible ser de alguna manera más eficiente?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2: búsqueda de texto? </font><font style="vertical-align: inherit;">es FTS!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, PostgreSQL proporciona un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mecanismo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muy poderoso </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">para la búsqueda de texto completo</font></a><font style="vertical-align: inherit;"> (Búsqueda de texto completo), incluida la posibilidad de búsqueda de prefijos. </font><font style="vertical-align: inherit;">¡Una gran opción, incluso las extensiones no necesitan ser instaladas! </font><font style="vertical-align: inherit;">Intentemos:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms <span class="hljs-keyword">USING</span> gin(to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)));</code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)) @@ to_tsquery(<span class="hljs-string">'simple'</span>, <span class="hljs-string">':*'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span>
, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/wd/ln/tq/wdlntqgqo_zvb4sbhcq-wln_jrw.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aquí la paralelización de la ejecución de consultas nos ayudó un poco, reduciendo el tiempo a la mitad a </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11 ms</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sí, y tuvimos que leer 1,5 veces menos, solo </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20 MB</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Y aquí, cuanto más pequeño, mejor, porque cuanto mayor sea la cantidad que restamos, mayores serán las posibilidades de perder el caché, y cada página adicional de datos leída del disco es un "freno" potencial para la solicitud.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3: ¿Aún ME GUSTA?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La solicitud anterior es buena para todos, pero solo si la extrae cien mil veces al día, se </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acumularán 2 TB de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> datos leídos. </font><font style="vertical-align: inherit;">En el mejor de los casos, desde la memoria, pero si no tienes suerte, desde el disco. </font><font style="vertical-align: inherit;">Así que tratemos de hacerlo más pequeño. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recuerde que el usuario quiere ver </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primero "que comienza con ..."</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">¡Así que esto es en su forma pura una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">búsqueda de prefijo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con </font></font><code>text_pattern_ops</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">Y solo si "no somos suficientes" hasta 10 registros requeridos, tendremos que leerlos usando la búsqueda de FTS:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) text_pattern_ops);</code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/_7/e_/jx/_7e_jxpnkc7n97e9rj2rbbk2ukq.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Excelente rendimiento: ¡solo </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">0.05 ms </font></a></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y un poco más de 100 KB de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lectura! </font><font style="vertical-align: inherit;">Solo nos olvidamos de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ordenar por nombre</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que el usuario no se pierda en los resultados:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ku/d4/r1/kud4r1oipobzbsljhvbavzd2ypa.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Oh, algo ya no es tan bonito: parece que hay un índice, pero la clasificación pasa volando ... Es, por supuesto, muchas veces más efectivo que la versión anterior, pero ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4: "modificar con un archivo"</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero hay un índice que le permite buscar por rango, y es normal usar la clasificación: </font><font style="vertical-align: inherit;">¡ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">btree normal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo una solicitud para ello deberá "ensamblarse manualmente":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &gt;= <span class="hljs-string">''</span> <span class="hljs-keyword">AND</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &lt;= (<span class="hljs-string">''</span> || <span class="hljs-keyword">chr</span>(<span class="hljs-number">65535</span>)) <span class="hljs-comment">--  UTF8,   - chr(255)</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
   <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/eh/o3/-i/eho3-irvjqbcpgpmmp7fuheb9nm.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mire explicar.tensor.ru] ¡</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Genial, tanto los trabajos de clasificación como el consumo de recursos siguen siendo "microscópicos", </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">miles de veces más eficientes que el FTS "puro"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Queda por recopilar en una sola solicitud:</font></font><br>
<br>
<pre><code class="sql hljs">(
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    firms<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &gt;= <span class="hljs-string">''</span> <span class="hljs-keyword">AND</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &lt;= (<span class="hljs-string">''</span> || <span class="hljs-keyword">chr</span>(<span class="hljs-number">65535</span>)) <span class="hljs-comment">--  UTF8,    - chr(255)</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
     <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
(<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    firms<font></font>
  <span class="hljs-keyword">WHERE</span>
    to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)) @@ to_tsquery(<span class="hljs-string">'simple'</span>, <span class="hljs-string">':*'</span>) <span class="hljs-keyword">AND</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>) <span class="hljs-comment">-- " "    </span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--    ,     btree-</span>
  , <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observo que la segunda subconsulta </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solo se</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ejecuta </font><b><font style="vertical-align: inherit;">si la primera devuelve menos del</font></b></font><code>LIMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> número de filas </font><b><font style="vertical-align: inherit;">esperado por la</font></b><font style="vertical-align: inherit;"> última </font><font style="vertical-align: inherit;">. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya escribí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre este método de optimización de consultas </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces sí, ahora tenemos btree y gin en la mesa al mismo tiempo, pero estadísticamente resultó que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menos del 10% de las solicitudes llegan al segundo bloque</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es decir, con tales limitaciones típicas tan conocidas para la tarea, ¡pudimos reducir el consumo total de recursos del servidor en casi mil veces!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 *: prescindir del archivo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arriba se </font></font><code>LIKE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nos impidió usar el tipo incorrecto. </font><font style="vertical-align: inherit;">Pero se puede "establecer en el camino verdadero" especificando la declaración USING:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El valor predeterminado es implícito </font></font><code>ASC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Además, puede especificar el nombre de un operador de clasificación específico en una oración </font></font><code>USING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El operador de clasificación debe ser miembro menor o mayor que una determinada familia de operadores de árbol B. </font></font><code>ASC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generalmente equivalente </font></font><code>USING &lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>DESC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generalmente equivalente </font></font><code>USING &gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En nuestro caso, "menos" es </font></font><code>~&lt;~</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">USING</span> ~&lt;~
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/s8/6r/4u/s86r4ujfiklgl9rqwn0fl7_g44i.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[mira explicar.tensor.ru]</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2: cómo "agriar" solicitudes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora dejamos nuestra solicitud de "insistir" durante medio año o un año, y con sorpresa lo volvemos a encontrar "en la parte superior" con indicadores del "bombeo" total diario de memoria ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buffers hit compartido</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.5TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir, incluso más de lo que era originalmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, por supuesto, nuestro negocio ha crecido y la carga ha aumentado, ¡pero no tanto! </font><font style="vertical-align: inherit;">Entonces algo está sucio aquí, vamos a resolverlo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1: el nacimiento de la paginación</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En algún momento, otro equipo de desarrollo quería hacer posible "saltar" al registro desde una búsqueda rápida de subíndices con los mismos resultados, pero ampliados. </font><font style="vertical-align: inherit;">¿Y qué registro sin navegación de página? </font><font style="vertical-align: inherit;">¡A la mierda!</font></font><br>
<br>
<pre><code class="sql hljs">( ... LIMIT &lt;N&gt; + 10)<font></font>
UNION ALL<font></font>
( ... LIMIT &lt;N&gt; + 10)<font></font>
LIMIT 10 OFFSET &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora era posible sin esfuerzo para el desarrollador mostrar el registro de resultados de búsqueda con la carga de "página de tipo". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, de hecho, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para cada página de datos siguiente, se está leyendo más y más</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (todo el tiempo anterior, que descartamos, más la "cola" deseada), es decir, este es un antipatrón inequívoco. </font><font style="vertical-align: inherit;">Y sería más correcto comenzar la búsqueda en la próxima iteración desde la clave almacenada en la interfaz, pero al respecto, en otra ocasión.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2: quiere exótico</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En algún momento, el desarrollador quería </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diversificar la selección resultante con datos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de otra tabla, para lo cual se envió toda la solicitud anterior al CTE:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> q <span class="hljs-keyword">AS</span> (<font></font>
  ...<font></font>
  <span class="hljs-keyword">LIMIT</span> &lt;N&gt; + <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
, (<span class="hljs-keyword">SELECT</span> ...) sub_query <span class="hljs-comment">-- -    </span>
<span class="hljs-keyword">FROM</span><font></font>
  q<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aún así, no está mal, porque una subconsulta se calcula solo para 10 registros devueltos, si no ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3: DISTINTO sin sentido y despiadado</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En algún lugar del proceso de tal evolución, </font><b><font style="vertical-align: inherit;">se </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perdió</font></font><code>NOT LIKE</code><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> una </font><b><font style="vertical-align: inherit;">condición</font></b><font style="vertical-align: inherit;"> de la segunda subconsulta </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Está claro que después de eso </font></font><code>UNION ALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comencé a devolver </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">algunos registros dos veces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , primero encontrados al comienzo de la línea, y luego nuevamente, al comienzo de la primera palabra de esta línea. </font><font style="vertical-align: inherit;">En el límite, todos los registros de la segunda subconsulta podrían coincidir con los registros de la primera. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué hace un desarrollador en lugar de buscar una razón? .. ¡Sin dudas!</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">duplicar el tamaño de las</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muestras originales</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ponga DISTINCT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que obtengamos solo instancias individuales de cada fila</font></font></li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> q <span class="hljs-keyword">AS</span> (<font></font>
  ( ... <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span>)
  <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  ( ... <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span>)
  <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span><font></font>
  *<font></font>
, (<span class="hljs-keyword">SELECT</span> ...) sub_query
<span class="hljs-keyword">FROM</span><font></font>
  q<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, está claro que el resultado, al final, es exactamente el mismo, pero la posibilidad de "volar" a la segunda subconsulta CTE se ha vuelto mucho mayor, y sin esto, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">claramente se lee más</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero esto no es lo más triste. </font><font style="vertical-align: inherit;">Como el desarrollador me pidió que seleccionara, </font></font><b><code>DISTINCT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no por específico, sino inmediatamente por todos los campos del</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> registro, el campo sub_query, el resultado de la subconsulta, también llegó allí automáticamente. </font><font style="vertical-align: inherit;">Ahora, para la ejecución </font></font><code>DISTINCT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la base de datos tenía que ejecutar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no 10 subconsultas, ¡sino todas &lt;2 * N&gt; + 10</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4: ¡cooperación sobre todo!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, los desarrolladores vivieron, no se molestaron, porque en el registro fueron "parcheados" a valores significativos de N con una desaceleración crónica en la recepción de cada "página" siguiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasta que los desarrolladores de otro departamento acudieron a ellos y no quisieron utilizar un método tan conveniente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para la búsqueda iterativa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir, tomamos una pieza de alguna muestra, filtramos por condiciones adicionales, dibujamos el resultado, luego la siguiente pieza (que en nuestro caso se logra mediante aumentar N), y así sucesivamente hasta que llenemos la pantalla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, en el espécimen capturado, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N alcanzó valores de casi 17K</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y en solo 24 horas, al menos 4K, tales solicitudes se ejecutaron "en la cadena". </font><font style="vertical-align: inherit;">El último de ellos ya escaneado audazmente</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 GB de memoria en cada iteración</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ...</font></font><br>
<br>
<h2></h2><br>
<img src="https://habrastorage.org/webt/zt/yx/ss/ztyxssr661ga_wndmpmqmvgtrq0.png"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es491138/index.html">Satélite y torre de integración Ansible</a></li>
<li><a href="../es491146/index.html">UML para desarrolladores</a></li>
<li><a href="../es491150/index.html">Cómo pirateé a los estafadores, o solo el interior de los paneles de phishing</a></li>
<li><a href="../es491154/index.html">Búsqueda de cursos: cómo construir una ruta de aprendizaje</a></li>
<li><a href="../es491156/index.html">Empatía medible: predicción de simpatía por IRM cerebral</a></li>
<li><a href="../es491164/index.html">Cómo programar un diploma para escribir. Guía completa</a></li>
<li><a href="../es491170/index.html">Cómo Amplifer usa Logux, una herramienta para la comunicación entre el cliente y el servidor</a></li>
<li><a href="../es491172/index.html">Cuándo un desarrollador front-end debería cambiar de React a Vue, y cuándo complicará el desarrollo</a></li>
<li><a href="../es491174/index.html">No escriba lo mismo: cómo los componentes React reutilizados ayudarán a los desarrolladores front-end a crear aplicaciones más rápido</a></li>
<li><a href="../es491176/index.html">5 signos de un producto it para ser vendido</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>