<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙎🏾 🕊️ 🌿 Banana Pi R64 The best router for OpenWrt, or not? 👆🏿 🎨 🐯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello my name is Dmitry and today I will review the Banana Pi R64 single-board computer. We will learn how to install OpenWrt on it and how to assembl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Banana Pi R64 The best router for OpenWrt, or not?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497842/"><img src="https://habrastorage.org/webt/m3/tf/d0/m3tfd0vvgmxborwa6szqr7tfu-y.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello my name is Dmitry and today I will review the Banana Pi R64 single-board computer. </font><font style="vertical-align: inherit;">We will learn how to install OpenWrt on it and how to assemble the firmware for this computer itself.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, on Habré there is already an overview on this computer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here it is,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> but there the author uses Armbian as the OS. </font><font style="vertical-align: inherit;">I tried this OS, as well as Debian, and came to the conclusion that there is no better OS for creating a router than OpenWrt, here are the reasons:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On OpenWrt, the network is configured automatically without any involvement on your part. </font><font style="vertical-align: inherit;">On Debian and Armbian, you need to configure the network yourself, through the configuration files.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The OpenWrt web interface is designed for router management. </font><font style="vertical-align: inherit;">Debian and Armbian also have web interfaces (Webmin, etc.), but they are designed for general server management.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of the advantages of Debian and Armbian, a simpler file system can be noted, which is displayed as is. </font><font style="vertical-align: inherit;">OpenWrt has a very complex file system. </font><font style="vertical-align: inherit;">Consisting of several mount points, some of which have a read-only attribute.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to install openwrt</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This manual is taken from the official Banana PI forum: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forum.banana-pi.org/c/Banana-Pi-BPI-R2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To install OpenWrt you will need:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Micro sd card</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enternet Cable</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usb-uart adapter</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Win32 diskimager</font></font></a> </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TFTP server</font></font></a> </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Putty</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sd image for card</font></font></a> </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Img image that you upload to the device’s internal memory </font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The preloader needed to download this image</font></font></a></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Procedure:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fill the sd image onto the sd card using Win32 Diskimager</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connect the Usb-Uart adapter to the corresponding contacts on the board (tx router - rx converter, rx router - tx converter, connect the ground), go into Putty and connect to the Com port, the data transfer speed is 115200. You can see which Com port you need in Device Manager is usually COM4.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insert the card into Banana PI and turn it on.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the U-boot menu, select 'b. </font><font style="vertical-align: inherit;">System Load flashimage then write to Flash via TFTP '(TFTP server must be enabled. The image file must be placed in the same folder as the TFTP server. In the network card settings, you must specify the IP address and the Main gateway).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the firmware, we return to the U-Boot menu with the bootmenu command and the '7 option. </font><font style="vertical-align: inherit;">System Load Preloader then write to Flash via TFTP 'fill in the preloader (This file should also be in the folder with the TFTP server).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We reboot the router and see OpenWrt. </font><font style="vertical-align: inherit;">U-boot menu is now available without an SD card, now it will always appear for 3 seconds at boot.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, the image that we uploaded to the device is very old. </font><font style="vertical-align: inherit;">Therefore, for example, you cannot install additional applications (packages) on it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where to get OpenWrt?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I must say that at the time of this writing there is no stable version of OpenWrt for Bpi-R64. There is support for this device in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">development branch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but at the moment the compatibility is not complete. That is, you can load the initramfs image and it will work. But this image was created for familiarization with OpenWrt, it exists only in the RAM and after rebooting the device, all settings and installed applications will be lost. The sysupgrade image is currently not working, and if you install it, the device will simply restart constantly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, the only way to get a working sysupgrade image is to build it yourself using patches from the official Banana PI forum. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have already assembled the OpenWrt image from April 16, 2020. This image</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It includes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transmission with web interface</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTFS-3G driver </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">details here</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samba</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mc, nano, htop and other utilities</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To install this image, go to the U-boot menu and select the option: 2) System Load Linux Kernel then write to Flash via TFTP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But if you want to build your own image, then here's how to do it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to build a working OpenWrt image</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the process of assembly and preparation for it is very voluminous, I will describe only the main points. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) To build you need a virtual machine and a Linux image. How to prepare them and where to get them is described </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . I want to note that in the settings of the virtual machine, be sure to specify the number of cores of your processor (by default it is 1). The kernel assembly process is very long, and on one core it will be even longer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) After that you need to download the source from Git how to do it is described </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It is necessary to stop at the make menuconfig command </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Go to the openwrt / target / linux / mediatek / makefile file and change the kernel number from 5.4 to 4.19. It is currently not possible to build an OpenWrt image on the 5.4 kernel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) make menuconfig select Target-&gt; Mediatck Arm, Subtarget-&gt; mt7622, ​​Profile-&gt; Banana Pi R64. You can also select the additional packages you need. Then we exit with conservation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5) make defconfig I don’t know why, but they always do this command. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6) make kernel_menuconfig -j5 the number after j is calculated as the number of cores of your processor plus one (I have a four-core processor). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7) After half an hour of waiting, the kernel configuration menu appears here, you need to set these options: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“Device Drivers” -&gt; “Memory Technology Device (MTD) support” -&gt; “Command line partition table parsing” </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“Device Drivers” - &gt; "Memory Technology Device (MTD) support" "Self-contained MTD device drivers" -&gt; "MTD using block device"</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“Device Drivers” -&gt; “MMC / SD / SDIO card suport” -&gt; “MMC block device driver” </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8) Take </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this patch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and copy it here: openwrt / target / linux / mediatek / patches-4.19. </font><font style="vertical-align: inherit;">(I want to note that this patch constantly caused compilation errors. Therefore, I just copied the lines from it to the mt7622-bananapi-bpi-r64.dts file which lies here: openwrt / linux / mediatek / files-4.19 / arch / arm64 / boot / dts / mediatek) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
9) make -j5 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10) After compilation, the openwrt-mediatek-mt7622-bpi_bananapi-r64-squashfs-sysupgrade.bin file that you can flash via the u-boot menu option will be in the bin folder: 2) System Load Linux Kernel then write to Flash via TFTP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Banana Pi is a very controversial device. High performance is combined with ugly support from developers. There is no official firmware, but support from third-party developers is so-so. But still it is a very powerful router with 5 gigabit ports, a gigabyte of RAM, and a fast dual-core processor. That is, there is no such thing as on an ordinary router, when you put Transsmison to download and the router puffs and creaks as if it were going to die. Here, the operation of Transmission does not affect the responsiveness of the device. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also worth noting that the device is sold without a case. Therefore, the body will have to do it yourself. But if you have a 3D printer then this is not a problem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here is my version</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
PS Updated firmware added Quality of Service</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
05/07/2020 Once again updated the firmware, added ntfs-3g-low a faster implementation of ntfs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PPS My small observations: OpenWrt on reboot generates a new MAC address for the device. </font><font style="vertical-align: inherit;">And for example, my modem that is connected to the router, I also need to reboot if the router was rebooted, and Windows finds a new network (which is not critical but annoying). </font><font style="vertical-align: inherit;">All this is solved by setting a constant MAC address for both wan and lan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Files</font></font></h3><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My firmware build</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Settings for menu config from my build</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Case for Banana Pi R64 on thingiverse </font></font></a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497832/index.html">What is hidden behind VestaCP</a></li>
<li><a href="../en497834/index.html">Advanced resource authorization system in Laravel. Part 2. Gateways, Policies</a></li>
<li><a href="../en497836/index.html">Comparison of the speed of programming languages ​​using the example of solving the problem of training a neural network</a></li>
<li><a href="../en497838/index.html">News from the world of OpenStreetMap No. 507 (03/31/2020-06.04.2020)</a></li>
<li><a href="../en497840/index.html">SOC on a remote site. What is worth thinking about?</a></li>
<li><a href="../en497850/index.html">How did I repair an arcade machine</a></li>
<li><a href="../en497856/index.html">Boost Converter: DCM vs CCM. Or why not be afraid to take it yourself</a></li>
<li><a href="../en497858/index.html">Big memory requirements in Android - what to do?</a></li>
<li><a href="../en497860/index.html">Generating design patterns in ES6 + on the example of the Game of Thrones</a></li>
<li><a href="../en497862/index.html">Why not delete all elements of the array by reassigning it to []?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>