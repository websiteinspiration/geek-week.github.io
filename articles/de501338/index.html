<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖüèª üç™ üêé In der virtuellen Python-Maschine. Teil 1 üëï ü§† üìè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo alle zusammen. Ich beschloss schlie√ülich herauszufinden, wie der Python-Interpreter funktioniert. Zu diesem Zweck begann er, ein Artikelbuch zu ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>In der virtuellen Python-Maschine. Teil 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501338/"><img src="https://habrastorage.org/webt/jm/9r/uc/jm9rucormi1lrcussoajjremszi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hallo alle zusammen. </font><font style="vertical-align: inherit;">Ich beschloss schlie√ülich herauszufinden, wie der Python-Interpreter funktioniert. </font><font style="vertical-align: inherit;">Zu diesem Zweck begann er, ein Artikelbuch zu studieren und konzipierte es gleichzeitig, um es ins Russische zu √ºbersetzen. </font><font style="vertical-align: inherit;">Tatsache ist, dass √úbersetzungen es Ihnen nicht erlauben, einen unverst√§ndlichen Satz zu √ºbersehen, und die Qualit√§t der Assimilation des Materials steigt.</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich entschuldige mich im Voraus f√ºr m√∂gliche Ungenauigkeiten. </font><font style="vertical-align: inherit;">Ich versuche immer, so richtig wie m√∂glich zu √ºbersetzen, aber eines der Hauptprobleme: Einige Begriffe werden im russischen √Ñquivalent einfach nicht erw√§hnt.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úbersetzungshinweis</font></font></b>
                        <div class="spoiler_text"> Python   ,  ¬´code object¬ª,  (  )     .    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow">  </a>   .<br>
<br>
<b> </b> ‚Äî   Python,    -   ,     :   ,    ,  ( !    )  ,    ,     - (     )  .. ‚Äî    ()  -   str (,  Python3, bytes).<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einf√ºhrung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Programmiersprache Python gibt es schon seit geraumer Zeit. </font><font style="vertical-align: inherit;">Die Entwicklung der ersten Version wurde 1989 von Guido Van Rossum begonnen. Seitdem ist die Sprache gewachsen und zu einer der beliebtesten geworden. </font><font style="vertical-align: inherit;">Python wird in verschiedenen Anwendungen verwendet: von grafischen Oberfl√§chen bis hin zu Datenanalyseanwendungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Zweck dieses Artikels besteht darin, einen Blick hinter die Kulissen des Interpreters zu werfen und einen konzeptionellen √úberblick √ºber die Ausf√ºhrung eines in Python geschriebenen Programms zu geben. </font><font style="vertical-align: inherit;">CPython wird in diesem Artikel ber√ºcksichtigt, da es zum Zeitpunkt des Schreibens die beliebteste und grundlegendste Python-Implementierung ist.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python und CPython werden in diesem Text als Synonyme verwendet, aber jede Erw√§hnung von Python bedeutet CPython (die in C implementierte Python-Version). </font><font style="vertical-align: inherit;">Andere Implementierungen umfassen PyPy (Python, das in einer begrenzten Teilmenge von Python implementiert ist), Jython (Implementierung auf der Java Virtual Machine) usw.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich mag es, die Ausf√ºhrung eines Python-Programms in zwei oder drei Hauptschritte (unten aufgef√ºhrt) zu unterteilen, je nachdem, wie der Interpreter aufgerufen wird. </font><font style="vertical-align: inherit;">Diese Schritte werden in diesem Artikel in unterschiedlichem Ma√üe behandelt:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialisierung</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - In diesem Schritt werden die verschiedenen Datenstrukturen eingerichtet, die f√ºr den Python-Prozess erforderlich sind. </font><font style="vertical-align: inherit;">Dies geschieht h√∂chstwahrscheinlich, wenn das Programm im nicht interaktiven Modus √ºber die Shell des Interpreters ausgef√ºhrt wird.</font></font></li>
<li><b></b> ‚Äî     , :       ,    ,       .</li>
<li><b></b> ‚Äî         .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Mechanismus zum Generieren von "Parsing" -B√§umen sowie von abstrakten Syntaxb√§umen (ASD) ist sprachunabh√§ngig. Daher werden wir dieses Thema nicht sehr ausf√ºhrlich behandeln, da die in Python verwendeten Methoden den Methoden anderer Programmiersprachen √§hnlich sind. Andererseits ist der Prozess der Erstellung von Symboltabellen und Codeobjekten aus ADS in Python spezifischer und verdient daher besondere Aufmerksamkeit. Au√üerdem wird die Interpretation kompilierter Codeobjekte und aller anderen Datenstrukturen er√∂rtert. Zu den von uns behandelten Themen geh√∂ren unter anderem: das Erstellen von Symboltabellen und das Erstellen von Codeobjekten, Python-Objekten, Frame-Objekten, Code-Objekten, Funktionsobjekten, Opcodes, Interpreter-Schleifen, Generatoren und Benutzerklassen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Material richtet sich an alle, die lernen m√∂chten, wie die virtuelle CPython-Maschine funktioniert. Es wird davon ausgegangen, dass der Benutzer bereits mit Python vertraut ist und die Grundlagen der Sprache versteht. Wenn wir die Struktur einer virtuellen Maschine untersuchen, werden wir auf eine erhebliche Menge an C-Code sto√üen, so dass es f√ºr einen Benutzer, der ein elementares Verst√§ndnis der C-Sprache hat, einfacher ist, das Material zu verstehen. Und im Grunde genommen das, was Sie brauchen, um sich mit diesem Material vertraut zu machen: der Wunsch, mehr √ºber die virtuelle CPython-Maschine zu erfahren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Artikel ist eine erweiterte Version pers√∂nlicher Notizen, die im Studium der internen Arbeit des Dolmetschers gemacht wurden. In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyCon-Videos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Schulvortr√§gen und </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">diesem Blog </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">steckt</font></a><font style="vertical-align: inherit;"> viel Qualit√§tsmaterial </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ohne diese fantastischen Wissensquellen w√§re meine Arbeit nicht abgeschlossen worden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende dieses Buches wird der Leser in der Lage sein, die Feinheiten der Ausf√ºhrung Ihres Programms durch den Python-Interpreter zu verstehen. </font><font style="vertical-align: inherit;">Dies umfasst die verschiedenen Phasen der Programmausf√ºhrung und Datenstrukturen, die im Programm kritisch sind. </font><font style="vertical-align: inherit;">Zun√§chst sehen wir aus der Vogelperspektive, was passiert, wenn ein triviales Programm ausgef√ºhrt wird und der Name des Moduls in der Befehlszeile an den Interpreter √ºbergeben wird. </font><font style="vertical-align: inherit;">Ausf√ºhrbarer CPython-Code kann gem√§√ü dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python-Entwicklerhandbuch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus dem Quellcode installiert werden </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dieses Buch verwendet die Python 3-Version.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30.000 Fu√ü Ansicht</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Kapitel wird erl√§utert, wie der Interpreter ein Python-Programm ausf√ºhrt. In den folgenden Kapiteln werden wir die verschiedenen Teile dieses ‚ÄûPuzzles‚Äú untersuchen und eine detailliertere Beschreibung jedes Teils liefern. Unabh√§ngig von der Komplexit√§t eines in Python geschriebenen Programms ist dieser Prozess immer der gleiche. Die ausgezeichnete Erkl√§rung, die Yaniv Aknin in seiner </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikelserie √ºber Python Internal gegeben hat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , bildet das Thema f√ºr unsere Diskussion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Quellmodul test.py kann √ºber die Befehlszeile ausgef√ºhrt werden (wenn es als Argument in Form von $ python test.py an das Python-Interpreter-Programm √ºbergeben wird). Dies ist nur eine M√∂glichkeit, die ausf√ºhrbare Python-Datei aufzurufen. Wir k√∂nnen auch einen interaktiven Interpreter starten, Zeilen einer Datei als Code ausf√ºhren usw. Aber diese und andere Methoden interessieren uns nicht. Die √úbertragung des Moduls als Argument (innerhalb der Befehlszeile) in die ausf√ºhrbare Datei (Abbildung 2.1) spiegelt am besten den Ablauf verschiedener Aktionen wider, die an der tats√§chlichen Ausf√ºhrung des Codes beteiligt sind. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/bw/i5/tlbwi5onywd5j1xmkmyv7ni_lgm.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abbildung 2.1: Stream zur Laufzeit</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die ausf√ºhrbare Python-Datei ist ein regul√§res C-Programm. Wenn sie aufgerufen wird, treten also Prozesse auf, die denen √§hneln, die beispielsweise im Linux-Kernel oder im einfachen Hallo-Welt-Programm vorhanden sind. </font><font style="vertical-align: inherit;">Nehmen Sie sich eine Minute Zeit, um zu verstehen: Die ausf√ºhrbare Python-Datei ist nur ein weiteres Programm, das Ihr eigenes startet. </font><font style="vertical-align: inherit;">Solche "Beziehungen" bestehen zwischen der C-Sprache und dem Assembler (oder llvm). </font><font style="vertical-align: inherit;">Der Standardinitialisierungsprozess (der von der Plattform abh√§ngt, auf der die Ausf√ºhrung stattfindet) beginnt, wenn die ausf√ºhrbare Python-Datei mit dem Modulnamen als Argument aufgerufen wird.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In diesem Artikel wird davon ausgegangen, dass Sie ein Unix-basiertes Betriebssystem verwenden. Daher k√∂nnen einige Funktionen unter Windows variieren.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sprache </font><font style="vertical-align: inherit;">beim Start f√ºhrt all ihre "Magie" der Initialisierung aus - l√§dt Bibliotheken, √ºberpr√ºft / setzt Umgebungsvariablen, und danach wird die Hauptmethode der ausf√ºhrbaren Python-Datei wie jedes andere C-Programm gestartet. Die ausf√ºhrbare </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hauptdatei von</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Python befindet sich in </font><b><font style="vertical-align: inherit;">./Programs/python.c</font></b><font style="vertical-align: inherit;"> und f√ºhrt eine Initialisierung durch (z. B. das </font><b><font style="vertical-align: inherit;">Erstellen von</font></b><font style="vertical-align: inherit;"> Kopien von Programmbefehlszeilenargumenten, die an das Modul √ºbergeben wurden). Die Hauptfunktion ruft dann die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Main-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><font style="vertical-align: inherit;">in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Modules/main.c auf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es verarbeitet den Initialisierungsprozess des Interpreters: analysiert die Befehlszeilenargumente, setzt Flags, liest Umgebungsvariablen, f√ºhrt Hooks aus, randomisiert Hash-Funktionen usw. Auch genannt</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylifecycle.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das die Initialisierung von Interpreter- und Stream- </font><b><font style="vertical-align: inherit;">Statusdatenstrukturen</font></b><font style="vertical-align: inherit;"> √ºbernimmt, sind zwei sehr wichtige Datenstrukturen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Pr√ºfung von Deklarationen von Interpreterdatenstrukturen und Stream-Zust√§nden macht deutlich, warum sie ben√∂tigt werden. Der Status des Interpreters und des Streams sind nur Strukturen mit Zeigern auf Felder, die die zur Ausf√ºhrung des Programms erforderlichen Informationen enthalten. Interpreter- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statusdaten werden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √ºber </font><b><font style="vertical-align: inherit;">typedef erstellt</font></b><font style="vertical-align: inherit;"> (stellen Sie sich dieses Schl√ºsselwort in C als Typdefinition vor, obwohl dies nicht ganz richtig ist). Der Code f√ºr diese Struktur ist in Listing 2.1 dargestellt.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> {</span>
 <span class="hljs-number">2</span> 
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">tstate_head</span>;</span>
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         PyObject *modules;
 <span class="hljs-number">7</span>         PyObject *modules_by_index;
 <span class="hljs-number">8</span>         PyObject *sysdict;
 <span class="hljs-number">9</span>         PyObject *builtins;
<span class="hljs-number">10</span>         PyObject *importlib;
<span class="hljs-number">11</span> 
<span class="hljs-number">12</span>         PyObject *codec_search_path;
<span class="hljs-number">13</span>         PyObject *codec_search_cache;
<span class="hljs-number">14</span>         PyObject *codec_error_registry;
<span class="hljs-number">15</span>         <span class="hljs-keyword">int</span> codecs_initialized;
<span class="hljs-number">16</span>         <span class="hljs-keyword">int</span> fscodec_initialized;
<span class="hljs-number">17</span> 
<span class="hljs-number">18</span>         PyObject *builtins_copy;
<span class="hljs-number">19</span>     } PyInterpreterState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codeauflistung 2.1: Datenstruktur des Interpreter-Status</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Jeder, der die Programmiersprache Python lange Zeit verwendet hat, kann mehrere in dieser Struktur erw√§hnte Felder erkennen (sysdict, builtins, codec).</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Feld </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* next</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verweist auf eine andere Instanz des Interpreters, da innerhalb desselben Prozesses mehrere Python-Interpreter vorhanden sein k√∂nnen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Feld * tstate_head</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gibt den Hauptausf√ºhrungsthread an (wenn das Programm √ºber mehrere Threads verf√ºgt, ist der Interpreter f√ºr alle vom Programm erstellten Threads gleich). </font><font style="vertical-align: inherit;">Wir werden dies in K√ºrze genauer besprechen.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modules, modules_by_index, sysdict, builtins</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importlib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sprechen f√ºr sich. </font><font style="vertical-align: inherit;">Alle von ihnen sind als Instanzen von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyObject definiert</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dem </font><b><font style="vertical-align: inherit;">Stammtyp</font></b><font style="vertical-align: inherit;"> f√ºr alle Objekte in der virtuellen Python-Maschine. </font><font style="vertical-align: inherit;">Python-Objekte werden in den folgenden Kapiteln ausf√ºhrlicher erl√§utert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Felder f√ºr </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec *</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enthalten Informationen, die beim Herunterladen von Codierungen hilfreich sind. </font><font style="vertical-align: inherit;">Dies ist sehr wichtig f√ºr die Dekodierung von Bytes.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Programmausf√ºhrung muss in einem Thread erfolgen. </font><font style="vertical-align: inherit;">Die Statusstruktur des Streams enth√§lt alle Informationen, die der Stream ben√∂tigt, um ein Codeobjekt auszuf√ºhren. </font><font style="vertical-align: inherit;">Ein Teil der Stream-Datenstruktur ist in Listing 2.2 dargestellt.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> {</span>
 <span class="hljs-number">2</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">prev</span>;</span>
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         PyInterpreterState *interp;
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">frame</span> *<span class="hljs-title">frame</span>;</span>
 <span class="hljs-number">7</span>         <span class="hljs-keyword">int</span> recursion_depth;
 <span class="hljs-number">8</span>         <span class="hljs-keyword">char</span> overflowed; 
 <span class="hljs-number">9</span>                         
<span class="hljs-number">10</span>         <span class="hljs-keyword">char</span> recursion_critical; 
<span class="hljs-number">11</span>         <span class="hljs-keyword">int</span> tracing;
<span class="hljs-number">12</span>         <span class="hljs-keyword">int</span> use_tracing;
<span class="hljs-number">13</span> 
<span class="hljs-number">14</span>         Py_tracefunc c_profilefunc;
<span class="hljs-number">15</span>         Py_tracefunc c_tracefunc;
<span class="hljs-number">16</span>         PyObject *c_profileobj;
<span class="hljs-number">17</span>         PyObject *c_traceobj;
<span class="hljs-number">18</span> 
<span class="hljs-number">19</span>         PyObject *curexc_type;
<span class="hljs-number">20</span>         PyObject *curexc_value;
<span class="hljs-number">21</span>         PyObject *curexc_traceback;
<span class="hljs-number">22</span> 
<span class="hljs-number">23</span>         PyObject *exc_type;
<span class="hljs-number">24</span>         PyObject *exc_value;
<span class="hljs-number">25</span>         PyObject *exc_traceback;
<span class="hljs-number">26</span> 
<span class="hljs-number">27</span>         PyObject *dict;  <span class="hljs-comment">/* Stores per-thread state */</span>
<span class="hljs-number">28</span>         <span class="hljs-keyword">int</span> gilstate_counter;
<span class="hljs-number">29</span> 
<span class="hljs-number">30</span>         ... 
<span class="hljs-number">31</span>     } PyThreadState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listing 2.2: Teil der Datenstruktur des Stream-Status</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Die Interpreter-Datenstrukturen und </font><i><font style="vertical-align: inherit;">Stream-Status</font></i><font style="vertical-align: inherit;"> werden in den folgenden Kapiteln ausf√ºhrlicher erl√§utert. Der Initialisierungsprozess richtet auch Importmechanismen sowie elementares Standard ein. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach Abschluss aller Initialisierungen ruft </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Main die</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><b><font style="vertical-align: inherit;">run_file auf</font></b><font style="vertical-align: inherit;"> (ebenfalls im Modul main.c). Das Folgende ist eine Reihe von Funktionsaufrufen: PyRun_AnyFileExFlags -&gt; PyRun_SimpleFileExFlags -&gt; PyRun_FileExFlags -&gt; PyParser_ASTFromFileObject. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyRun_SimpleFileExFlags</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellt den __main__-Namespace, in dem der Inhalt der Datei ausgef√ºhrt wird. Es wird auch gepr√ºft, ob die pyc-Version der Datei vorhanden ist (die pyc-Datei ist eine einfache Datei, die eine bereits kompilierte Version des Quellcodes enth√§lt). Wenn eine pyc-Version vorhanden ist, wird versucht, sie als Bin√§rdatei zu lesen und anschlie√üend auszuf√ºhren. Wenn die pyc-Datei fehlt, wird PyRun_FileExFlags usw. aufgerufen. Die Funktion PyParser_ASTFromFileObject ruft </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ParseFileObject auf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das den Inhalt des Moduls liest und daraus </font><b><font style="vertical-align: inherit;">Analyseb√§ume erstellt</font></b><font style="vertical-align: inherit;"> . Anschlie√üend wird der erstellte Baum an </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ASTFromNodeObject √ºbergeben</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das daraus einen abstrakten Syntaxbaum erstellt.</font></font><br>
<br>
<blockquote>     ,     Py_INCREF  Py_DECREF.    ,     . CPython        :  ,      ,    Py_INCREF. ,      ,       Py_DECREF.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AST wird generiert, wenn </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run_mod</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aufgerufen wird </font><font style="vertical-align: inherit;">. Diese Funktion ruft </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyAST_CompileObject auf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das </font><b><font style="vertical-align: inherit;">Codeobjekte</font></b><font style="vertical-align: inherit;"> aus AST erstellt. Beachten Sie, dass der w√§hrend des PyAST_CompileObject-Aufrufs </font><font style="vertical-align: inherit;">generierte Bytecode </font><font style="vertical-align: inherit;">durch den einfachen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gucklochoptimierer geleitet wird</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , der vor dem Erstellen von </font><font style="vertical-align: inherit;">Codeobjekten </font><font style="vertical-align: inherit;">eine geringe Optimierung des generierten Bytecodes durchf√ºhrt. Die Funktion run_mod wendet dann die Funktion </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyEval_EvalCode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus der Datei </font><b><font style="vertical-align: inherit;">ceval.c</font></b><font style="vertical-align: inherit;"> auf das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codeobjekt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> an. Dies f√ºhrt zu einer weiteren Reihe von Funktionsaufrufen: PyEval_EvalCode -&gt; PyEval_EvalCode -&gt; _PyEval_EvalCodeWithName -&gt; _PyEval_EvalFrameEx. Das Codeobjekt wird in der einen oder anderen Form als Argument an die meisten dieser Funktionen √ºbergeben. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_PyEval_EvalFrameEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Dies ist eine normale Interpreter-Schleife, die die Ausf√ºhrung von Codeobjekten √ºbernimmt. Es wird jedoch nicht nur mit dem Codeobjekt als Argument aufgerufen, sondern auch mit dem Rahmenobjekt, das als Attribut ein Feld hat, das auf das Codeobjekt verweist. Dieser Frame stellt den Kontext f√ºr die Ausf√ºhrung des Codeobjekts bereit. In einfachen Worten: Die Interpreterschleife liest kontinuierlich den n√§chsten Befehl, der durch den Befehlsz√§hler angezeigt wird, aus dem Befehlsarray. Dann f√ºhrt es diese Anweisung aus: Es f√ºgt dem Prozess Objekte hinzu oder entfernt sie aus dem Wertestapel, bis es in das Array der auszuf√ºhrenden Anweisungen entleert wird (nun, oder es passiert etwas Au√üergew√∂hnliches, das die Schleife st√∂rt).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python bietet eine Reihe von Funktionen, mit denen Sie echte Codeobjekte untersuchen k√∂nnen. Beispielsweise kann ein einfaches Programm in ein Codeobjekt kompiliert und zerlegt werden, um Opcodes zu erhalten, die von der virtuellen Python-Maschine ausgef√ºhrt werden. Dies ist in Listing 2.3 dargestellt.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">1</span>         &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">square</span>(<span class="hljs-params">x</span>):</span>
<span class="hljs-number">2</span>         ...     <span class="hljs-keyword">return</span> x*x
<span class="hljs-number">3</span>         ... 
<span class="hljs-number">4</span> 
<span class="hljs-number">5</span>         &gt;&gt;&gt; dis(square)
<span class="hljs-number">6</span>         <span class="hljs-number">2</span>           <span class="hljs-number">0</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">7</span>                     <span class="hljs-number">2</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">8</span>                     <span class="hljs-number">4</span> BINARY_MULTIPLY     
<span class="hljs-number">9</span>                     <span class="hljs-number">6</span> RETURN_VALUE        </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Codeauflistung 2.3: Zerlegen einer Funktion in Python Die </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Header-Datei </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Include/opcodes.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enth√§lt eine vollst√§ndige Liste aller Anweisungen / Opcodes f√ºr die virtuelle Python-Maschine. Opcodes sind ziemlich einfach. Nehmen Sie unser Beispiel in Listing 2.3, das vier Anweisungen enth√§lt. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOAD_FAST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> l√§dt den Wert seines Arguments (in diesem Fall x) </font><b><font style="vertical-align: inherit;">auf den</font></b><font style="vertical-align: inherit;"> Wertestapel. Die virtuelle Python-Maschine ist stapelbasiert, sodass die Werte f√ºr Opcode-Operationen aus dem Stapel "gepoppt" werden und die Berechnungsergebnisse zur weiteren Verwendung durch andere Opcodes auf den Stapel zur√ºckgeschoben werden. Dann nimmt </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BINARY_MULTIPLY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zwei Elemente vom Stapel, f√ºhrt eine bin√§re Multiplikation beider Werte durch und schiebt das Ergebnis zur√ºck </font><b><font style="vertical-align: inherit;">auf den</font></b><font style="vertical-align: inherit;"> Stapel. </font><b><font style="vertical-align: inherit;">RETURN VALUE-</font></b><font style="vertical-align: inherit;"> Anweisung</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ruft einen Wert vom Stapel ab, setzt den R√ºckgabewert f√ºr das Objekt auf diesen Wert und verl√§sst die Interpreterschleife. </font><font style="vertical-align: inherit;">Wenn Sie sich Listing 2.3 ansehen, ist klar, dass dies eine ziemlich starke Vereinfachung ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die aktuelle Erl√§uterung der Interpreterschleife ber√ºcksichtigt nicht eine Reihe von Details, die in den folgenden Kapiteln erl√§utert werden. </font><font style="vertical-align: inherit;">Hier sind zum Beispiel die Fragen, auf die wir keine Antwort erhalten haben:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Woher stammen die von der LOAD_FAST-Anweisung geladenen Werte?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Woher kommen die Argumente, die als Teil der Anleitung verwendet werden?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie werden verschachtelte Funktions- und Methodenaufrufe behandelt?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie behandelt die Interpreterschleife Ausnahmen?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem Sie alle Anweisungen ausgef√ºhrt haben, setzt die Py_Main-Funktion die Ausf√ºhrung fort, diesmal wird jedoch der Reinigungsprozess gestartet. </font><font style="vertical-align: inherit;">Wenn </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aufgerufen wird, um die Initialisierung w√§hrend des Starts des Interpreters </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">durchzuf√ºhren,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wird </font><b><font style="vertical-align: inherit;">Py_FinalizeEx</font></b><font style="vertical-align: inherit;"> aufgerufen, um die Bereinigung durchzuf√ºhren. </font><font style="vertical-align: inherit;">Dieser Prozess umfasst das Warten auf das Beenden der Threads, das Aufrufen von Exit-Handlern sowie das Freigeben des vom Interpreter zugewiesenen noch verwendeten Speichers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher haben wir uns die "allgemeine" Beschreibung der Prozesse angesehen, die in der ausf√ºhrbaren Python-Datei auftreten, wenn ein Skript ausgef√ºhrt wird. </font><font style="vertical-align: inherit;">Wie bereits erw√§hnt, m√ºssen noch viele Fragen beantwortet werden. </font><font style="vertical-align: inherit;">In Zukunft werden wir uns mit dem Studium des Dolmetschers befassen und jede der Stufen im Detail betrachten. </font><font style="vertical-align: inherit;">Zun√§chst werden wir den Kompilierungsprozess im n√§chsten Kapitel beschreiben.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de501326/index.html">So werden Sie in sechs Monaten oder noch schneller DevOps-Ingenieur. Teil 3. Versionen</a></li>
<li><a href="../de501328/index.html">Einf√ºhrung in Visual Studio-Codespaces: Cloud-Entwicklung, wo immer Sie sind</a></li>
<li><a href="../de501330/index.html">Microservices in C ++. Fiktion oder Realit√§t?</a></li>
<li><a href="../de501332/index.html">Meetings sind einfach. Drei t√§gliche √úbungstipps</a></li>
<li><a href="../de501336/index.html">FOSS News Nr. 15 - eine √úberpr√ºfung der kostenlosen und Open Source-Nachrichten f√ºr den 4. bis 10. Mai 2020</a></li>
<li><a href="../de501340/index.html">Warum gewinnt Flutter?</a></li>
<li><a href="../de501342/index.html">Microsoft Online-Zertifizierung - Feldnotizen</a></li>
<li><a href="../de501346/index.html">√úbersicht √ºber die mechanische Tastatur Vortex Core RGB</a></li>
<li><a href="../de501352/index.html">Kafka schl√§gt zur√ºck</a></li>
<li><a href="../de501354/index.html">Ein neuer Blick auf den Codestil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>