<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® üëäüèø üë¢ La evoluci√≥n del procesamiento de webhook de Facebook: de cero a 25,000 por segundo üêÇ üë®üèΩ‚Äçüç≥ üë®üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lo m√°s probable es que nadie necesite decir qu√© son los webhooks. Pero por si acaso: los webhooks son un mecanismo para informar eventos en un sistema...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>La evoluci√≥n del procesamiento de webhook de Facebook: de cero a 25,000 por segundo</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo m√°s probable es que nadie necesite decir qu√© son los webhooks. Pero por si acaso: los webhooks son un mecanismo para informar eventos en un sistema externo. Por ejemplo, sobre comprar en una tienda en l√≠nea a trav√©s de un cajero en l√≠nea, enviar un c√≥digo a un repositorio de GitHub o acciones del usuario en chats. En una API t√≠pica, debe consultar constantemente el servidor si el usuario escribi√≥ algo en el chat. Usando el mecanismo de webhook, puede "suscribirse" a las notificaciones, y el servidor mismo enviar√° una solicitud HTTP cuando ocurra un evento. Esto es m√°s conveniente y m√°s r√°pido que solicitar constantemente nuevos datos en el servidor.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChat es una plataforma que ayuda a las empresas a comunicarse con sus clientes a trav√©s del chat en mensajer√≠a instant√°nea. Los webhooks son una de las partes importantes de ManyChat, porque es a trav√©s de ellos que la empresa se comunica con los clientes. Y se comunican mucho, por ejemplo, a trav√©s de un sistema, las empresas env√≠an miles de millones de mensajes al mes a sus clientes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mayor√≠a de los mensajes se env√≠an a trav√©s de Facebook Messenger. Tiene una caracter√≠stica: una API lenta. Cuando un cliente escribe un mensaje para pedir pizza, Facebook env√≠a un webhook a ManyChat. La plataforma lo procesa, devuelve la solicitud y el usuario recibe un mensaje. Debido a la lenta API, algunas solicitudes tardan unos segundos. Pero cuando la plataforma no responde durante mucho tiempo, la empresa pierde al cliente y Facebook puede desconectar la aplicaci√≥n de los webhooks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, el procesamiento de webhooks es una de las principales tareas de ingenier√≠a de la plataforma. </font><font style="vertical-align: inherit;">Para resolver el problema, ManyChat cambi√≥ su arquitectura de procesamiento varias veces en el transcurso de tres a√±os de un controlador simple en Yii a un sistema distribuido con Galaxias. </font><font style="vertical-align: inherit;">Lea m√°s sobre esto bajo el corte Dmitry Kushnikov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cancellarius</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kushnikov lidera el desarrollo en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y ha estado programando profesionalmente en PHP desde 2001. </font><font style="vertical-align: inherit;">Dmitry le dir√° c√≥mo la arquitectura ha cambiado junto con el crecimiento del servicio y la carga, qu√© soluciones y tecnolog√≠as se aplicaron en diferentes etapas, c√≥mo ha evolucionado el procesamiento de webhook y c√≥mo la plataforma logra hacer frente a una carga enorme utilizando recursos modestos en PHP. </font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota. </font><font style="vertical-align: inherit;">El art√≠culo se basa en el informe de Dmitry "La evoluci√≥n del procesamiento de webhook de Facebook: de cero a 12.500 por segundo" en </font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Rusia 2019</font></font></em></a><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pero mientras se preparaba, los indicadores aumentaron a 25,000.</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© es ManyChat?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, te presentar√© en el contexto de nuestras tareas. ManyChat es un servicio que ayuda a las empresas a utilizar mensajer√≠a instant√°nea para marketing, ventas y soporte. El producto principal es la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plataforma de Messenger Marketing en Facebook Messenger</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Durante tres a√±os, m√°s de 1 mill√≥n de empresas de 100 pa√≠ses del mundo utilizaron el servicio para comunicarse con 700 millones de sus clientes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el lado del cliente,</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se ve as√≠. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Botones, im√°genes y galer√≠as en los cuadros de di√°logo en Facebook Messenger.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Esta es la interfaz de Facebook Messenger. Adem√°s de los mensajes de texto, puede enviar elementos interactivos para interactuar con los clientes, dialogar, aumentar el inter√©s en sus productos y vender. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desde el lado comercial</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo se ve diferente. </font><font style="vertical-align: inherit;">Esta es la interfaz de nuestra aplicaci√≥n web donde, utilizando una interfaz visual, los representantes comerciales crean y programan guiones de di√°logo. </font><font style="vertical-align: inherit;">La imagen es un ejemplo de un escenario. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El coraz√≥n de nuestro sistema es el componente Flow Builder. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El conjunto de scripts y reglas de automatizaci√≥n que llamamos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por lo tanto, para simplificar, podemos decir que ManyChat es un dise√±ador de bot. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un ejemplo de un bot. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El cliente de la empresa que participa en el di√°logo se llama </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suscriptor</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque para la interacci√≥n, el cliente se </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suscribe al bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que facebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPor qu√© Facebook Messenger, somos el pa√≠s del Telegrama sobreviviente? </font><font style="vertical-align: inherit;">Hay razones para esto.</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     ‚Ññ1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La interacci√≥n con Facebook se organiza de la siguiente manera: las </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
empresas utilizan una aplicaci√≥n web para configurar la l√≥gica del bot. </font><font style="vertical-align: inherit;">Cuando un cliente interact√∫a con el bot por tel√©fono, Facebook recibe informaci√≥n al respecto y nos env√≠a un webhook. </font><font style="vertical-align: inherit;">ManyChat lo procesa, dependiendo de la l√≥gica programada por la empresa, y env√≠a la solicitud de regreso. </font><font style="vertical-align: inherit;">Luego Facebook entrega el mensaje al tel√©fono del usuario.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pila tecnol√≥gica</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hacemos todo esto en una pila modesta. </font><font style="vertical-align: inherit;">En el n√∫cleo, por supuesto, est√° PHP. </font><font style="vertical-align: inherit;">El servidor web ejecuta Nginx, la base de datos principal es PostgreSQL, y tambi√©n hay Redis y Elasticsearch. </font><font style="vertical-align: inherit;">Todo gira en las nubes de Amazon Web Services.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manejo de Webhook de Facebook</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve la c√°mara web de Facebook: esta es una solicitud con carga √∫til en formato JSON.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los webhooks son solo el 10% de nuestra carga, pero son la parte m√°s importante del sistema. </font><font style="vertical-align: inherit;">A trav√©s de ellos, la empresa se comunica con los usuarios. </font><font style="vertical-align: inherit;">Si los mensajes se ralentizan o no se env√≠an, el usuario se niega a interactuar con el bot y la empresa pierde al cliente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo a la evoluci√≥n de nuestra arquitectura desde el lanzamiento del producto. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mayo de 2016</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Acabamos de lanzar nuestro servicio: 20 bots, 10 de los cuales son de prueba y 20 suscriptores. </font><font style="vertical-align: inherit;">La carga fue de 0 RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El esquema de interacci√≥n se ve√≠a as√≠:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La solicitud va a nginx.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx accede a PHP-FPM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM lleva la aplicaci√≥n hasta Yii.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El controlador de webhook procesa la l√≥gica y env√≠a solicitudes a Facebook de acuerdo con ella.</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un mont√≥n de Nginx y PHP-FPM</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Junio ‚Äã‚Äãde 2016.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un mes despu√©s, anunciamos ManyChat en ProductHunt y el n√∫mero de bots aument√≥ a 2 mil. </font><font style="vertical-align: inherit;">El n√∫mero de suscriptores ha aumentado a 7 mil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este momento, el primer problema apareci√≥ en el sistema. </font><font style="vertical-align: inherit;">La API de Facebook no es muy r√°pida: algunas solicitudes pueden demorar varios segundos y varias solicitudes pueden demorar decenas de segundos. </font><font style="vertical-align: inherit;">Pero el servidor webhook quiere que respondamos r√°pidamente. </font><font style="vertical-align: inherit;">Debido a la lenta API, no respondemos durante mucho tiempo: el servidor primero jura y luego puede desconectar completamente la aplicaci√≥n de los webhooks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay pocos usuarios, todav√≠a estamos desarrollando la aplicaci√≥n, estamos buscando nuestro mercado, audiencia y el problema de carga ya ha aparecido. </font><font style="vertical-align: inherit;">Pero nos salv√≥ una soluci√≥n simple: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el momento en que se inicia el controlador, interrumpimos el acceso a Facebook</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le decimos a Facebook que todo est√° bien, pero en el fondo procesamos solicitudes y webhook.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Colas en PostgreSQL</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diciembre de 2016. El</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servicio creci√≥ 5-10 veces: 10 mil bots y 700 mil suscriptores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, trabajamos en nuevas tareas: mostrar estad√≠sticas, entrega de mensajes, conversi√≥n de impresiones y transiciones. </font><font style="vertical-align: inherit;">Tambi√©n se implement√≥ Live Chat. </font><font style="vertical-align: inherit;">Adem√°s de automatizar las interacciones, ofrece a las empresas la capacidad de escribir mensajes directamente a sus suscriptores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soluci√≥n a estos problemas aument√≥ el n√∫mero de ganchos seguidos en 4 veces. </font><font style="vertical-align: inherit;">Por cada mensaje que enviamos, recibimos 3 webhooks adicionales. </font><font style="vertical-align: inherit;">El sistema de procesamiento necesitaba ser mejorado nuevamente. </font><font style="vertical-align: inherit;">Somos una plataforma peque√±a, solo dos personas trabajaron en el back-end, por lo que elegimos la soluci√≥n m√°s simple: colas en PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todav√≠a no queremos implementar sistemas complejos, por lo que simplemente compartimos los flujos de procesamiento. </font><font style="vertical-align: inherit;">Los webhooks que deben procesarse r√°pidamente para que el usuario reciba una respuesta se procesan sincr√≥nicamente. </font><font style="vertical-align: inherit;">Todo lo dem√°s se env√≠a en colas para solicitudes asincr√≥nicas.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Colas en Redis</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Junio ‚Äã‚Äãde 2017. El</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servicio est√° creciendo: 75 mil bots, 7 millones de suscriptores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estamos implementando otra nueva caracter√≠stica. Todos los webhooks que procesamos se refer√≠an solo a las comunicaciones en el messenger. Pero ahora decidimos dar a las empresas la oportunidad de comunicarse </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con los suscriptores de las p√°ginas de negocios</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y comenzamos a procesar nuevos tipos de webhooks, aquellos que se relacionan con el feed de la p√°gina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los feeds de p√°ginas comerciales no se actualizan con poca frecuencia. Los especialistas en marketing a menudo publican algo, luego siguen cada me gusta y los cuentan. No hay mucho tr√°fico en las p√°ginas de negocios. Pero hay situaciones inversas, por ejemplo, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Katy Perry Day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Katy Perry es una famosa cantante estadounidense con una gran cantidad de fan√°ticos en todo el mundo. </font><font style="vertical-align: inherit;">Hay 64 millones de suscriptores solo en su grupo de Facebook. </font><font style="vertical-align: inherit;">En alg√∫n momento, los vendedores del cantante decidieron hacer un bot en Facebook Messenger y eligieron nuestra plataforma. </font><font style="vertical-align: inherit;">En ese momento, cuando publicaron un mensaje llamando a suscribirse al bot, nuestra carga aument√≥ 3-4 veces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta situaci√≥n nos ayud√≥ a comprender que sin la implementaci√≥n normal de las colas, no podemos hacer nada. </font><font style="vertical-align: inherit;">Como soluci√≥n, eligieron Redis.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elegir Redis para las colas es una decisi√≥n fant√°sticamente buena.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ayud√≥ a resolver una gran cantidad de problemas. Ahora, cada segundo a trav√©s de nuestro cl√∫ster Redis pasa 1 mill√≥n de solicitudes diferentes. Lo usamos no solo para todas las colas en cascada, sino tambi√©n para otras tareas, por ejemplo, monitoreo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las colas en Redis no se implementaron en el primer intento. Cuando comenzamos a doblar webhooks en Redis y a procesarlos en un solo proceso, expandimos el embudo en la parte superior: tambi√©n se procesaron m√°s webhooks entrantes, pero el proceso en s√≠ todav√≠a tom√≥ algo de tiempo. Esta primera decisi√≥n no tuvo √©xito.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando intentaron escalar el n√∫mero de estas solicitudes, hubo un ligero colapso. La cola puede acumular solicitudes de diferentes p√°ginas, pero las solicitudes de una p√°gina pueden ir en una fila. Si un controlador es lento, las solicitudes de un suscriptor y de un bot se procesar√°n en el orden incorrecto. El usuario env√≠a mensajes, realiza algunas acciones con el bot, pero recibe una respuesta al azar. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este parece ser un caso raro, pero las pruebas en nuestras cargas de trabajo han demostrado que esto suceder√° con frecuencia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzamos a buscar otra soluci√≥n. Aqu√≠ la simplicidad y el poder de Redis vinieron al rescate: decidimos hacer una </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cola para cada bot</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo funciona? Los mensajes relacionados con cada bot se agregan a la cola. Para no subir el controlador a cada cola, hicimos una </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cola de control</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ella trabaja asi. Cada vez que una solicitud proviene de un bot, se publican dos mensajes en Redis: uno en la cola del bot y el segundo en el control. El controlador supervisa el control y cada vez que inicia el demonio cuando hay una tarea para procesar el bot. El demonio rastrilla la cola del bot correspondiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de la tarea principal, resolvimos el problema de los "vecinos ruidosos". Esto es cuando un bot gener√≥ una gran cantidad de webhooks y ralentiza el sistema, porque otras p√°ginas est√°n esperando el procesamiento. Para resolver el problema, es suficiente </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escalar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : cuando la cola de control est√° llena, agregamos nuevos controladores.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, las </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">colas son virtuales</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Estas son solo c√©lulas en la memoria de Redis. </font><font style="vertical-align: inherit;">Cuando no hay nada en la cola, no existe, no ocupa nada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enero 2018</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Hemos alcanzado mil millones de publicaciones por mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La carga fue de 5 mil RPS por sistema. Esto no es carga m√°xima, sino est√°ndar. Cuando aparecen bots de cantantes famosos, todo crece varias veces a partir de esta figura. Pero no es un problema. El problema est√° en PHP-FPM: ya no puede soportar la carga de 5 mil RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos en ese momento hablaban sobre el procesamiento asincr√≥nico de moda. Lo miramos m√°s de cerca, vimos ReactPHP, realizamos pruebas r√°pidas, lo reemplazamos con PHP-FPM e instant√°neamente obtuvimos un aumento de 4 veces. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No reescribimos el procesamiento de nuestro procesamiento: ReactPHP plante√≥ el marco Yii. Primero, planteamos 4 servicios ReactPHP, y luego llegamos a 30. Durante mucho tiempo vivimos de ellos, y el marco hizo frente a la carga.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tan pronto como expandimos el embudo, ocurri√≥ otro colapso: despu√©s de comenzar el embudo en la recepci√≥n, el procesamiento comenz√≥ a sufrir nuevamente. </font><font style="vertical-align: inherit;">Para resolver este problema ya, decidimos separar el procesamiento en grupos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Racimos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tomaron bots, los distribuyeron en grupos y construyeron cadenas l√≥gicas de Redis, Postgres y un controlador. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, hemos formado el concepto de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Galaxy", una abstracci√≥n f√≠sica l√≥gica sobre el procesamiento</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Consiste en instancias: Redis, PostgreSQL y un conjunto de servicios PHP. </font><font style="vertical-align: inherit;">Cada bot pertenece a un grupo particular, y ReactPHP sabe en qu√© grupo debe colocarse el mensaje para este bot. </font><font style="vertical-align: inherit;">El esquema anterior funciona m√°s all√°. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El Universo se est√° expandiendo, el Universo de nuestros sistemas tambi√©n, y agregamos una nueva "Galaxia" cuando esto sucede.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las galaxias son nuestra forma de escalar.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reemplazando ReactPHP con un mont√≥n de Nginx y Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante los siguientes seis meses, seguimos creciendo: 200 millones de suscriptores y 3 mil millones de mensajes por mes. </font><font style="vertical-align: inherit;">Imagine un sitio para 200 millones de usuarios registrados, la misma carga. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ha surgido un nuevo problema. </font><font style="vertical-align: inherit;">Los webhooks son peque√±as tareas del mismo tipo, y PHP no es adecuado para resolverlos. </font><font style="vertical-align: inherit;">Incluso ReactPHP ya no ayud√≥.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No pudo hacer frente a la carga de 10 mil RPS: desde la introducci√≥n de ReactPHP, la carga ha aumentado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fue necesario reiniciarlo incluso con implementaciones, adem√°s, secuencialmente, porque no puede interrumpir el procesamiento de los webhooks entrantes. </font><font style="vertical-align: inherit;">Facebook desactiva la aplicaci√≥n cuando se da cuenta de que tiene problemas. </font><font style="vertical-align: inherit;">Para ManyChat, esto es un desastre: 650 mil empresas que operan activamente no nos perdonar√°n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, gradualmente mordimos l√≥gica diferente de ReactPHP, la pasamos a los procesadores y aislamos nuevas colas. En el proceso, notaron que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP realiza una tarea simple: toma un webhook y lo pone en una cola</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Todo lo dem√°s se realiza mediante procesamientos. ¬øHay an√°logos para una tarea tan simple? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recordamos que Nginx tiene m√≥dulos y notamos la biblioteca </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Adem√°s de soportar el lenguaje de programaci√≥n Lua, ten√≠a un m√≥dulo para trabajar con Redis. Una prueba escrita en 3 horas mostr√≥ que todo el trabajo de 30 servicios en ReactPHP se puede hacer directamente en el lado nginx. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como result√≥: procesamos alg√∫n tipo de punto final, recogemos el cuerpo de la solicitud y lo agregamos directamente a Redis.</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty y Lua han ayudado a aumentar el rendimiento. </font><font style="vertical-align: inherit;">Continuamos haciendo frente a nuestra carga de trabajo, el servicio sigue vivo, todos est√°n felices.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mejorando la soluci√≥n en Lua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La √∫ltima etapa ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nota: en el momento del informe</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) es </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">febrero de 2019</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">500 millones de suscriptores env√≠an y reciben 7 millones de mensajes de un mill√≥n de bots cada mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es un paso para mejorar nuestra soluci√≥n en Lua. </font><font style="vertical-align: inherit;">Gradualmente, elimine parte de la l√≥gica de las colas y transfiera el procesamiento primario de distribuci√≥n de webhooks entre sistemas a Lua. </font><font style="vertical-align: inherit;">Ahora nuestros sistemas son m√°s productivos y menos dependientes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mantenemos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">procesamiento separado y procesamiento asincr√≥nico</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El procesamiento se refiere a estad√≠sticas y otras cosas: ahora es un sistema completamente diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sistema parece simple, pero no lo es. </font><font style="vertical-align: inherit;">Debajo del cap√≥, hay 500 servicios que procesan sus solicitudes. </font><font style="vertical-align: inherit;">Todo el sistema se ejecuta en 50 instancias de Amazon: Redis, PostgreSQL y los mismos controladores PHP.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Evoluci√≥n de procesamiento</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Highload puede ser genial para hacer en PHP.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recuerde brevemente c√≥mo lo hicimos en el proceso de desarrollo del sistema.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comenz√≥ con Nginx y PHP-FPM normales.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se agregaron colas a PostgreSQL y luego a Redis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clustering agregado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementado ReactPHP.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reemplazamos ReactPHP con un mont√≥n de Nginx y Lua, y luego trasladamos la l√≥gica al grupo.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n nuestra experiencia, descubrimos que es posible crecer y construir arquitectura cambiando sucesivamente las partes vulnerables, utilizando enfoques simples y conocidos y, al mismo tiempo, no expandiendo la pila.</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es486844/">https://habr.com/ru/post/es486844/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es486824/index.html">Mal consejo al trabajar con ANTLR</a></li>
<li><a href="../es486826/index.html">Creaci√≥n de un Viberbot completo en Django 2 y la API REST de Viber. Primera parte - Webhook</a></li>
<li><a href="../es486828/index.html">Food Design Digest, enero de 2020</a></li>
<li><a href="../es486832/index.html">¬øCu√°ntos a√±os pasa Taiga? No, no.</a></li>
<li><a href="../es486842/index.html">C√≥nsul + iptables =: 3</a></li>
<li><a href="../es486850/index.html">Nuevo asiento reservado, como un hotel c√°psula</a></li>
<li><a href="../es486858/index.html">Creando un Viberbot completo. Segunda parte: primer contacto o "conversion_started"</a></li>
<li><a href="../es486860/index.html">ATX12VO - Comer una nueva forma</a></li>
<li><a href="../es486862/index.html">5 razones por las que el dise√±o de movimiento te ayuda a conectarte con las personas</a></li>
<li><a href="../es486864/index.html">Migraci√≥n de OpenVPN a WireGuard para unir redes en una red L2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>