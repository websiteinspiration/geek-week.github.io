<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôíÔ∏è üëáüèæ üêπ How to create a multi-agent transport model ‚úàÔ∏è üê¨ üëãüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 
 
 Imagine that we have a task to build a new road. You can build a highway with two lanes in each direction, but what if this is not en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to create a multi-agent transport model</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494596/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine that we have a task to build a new road. You can build a highway with two lanes in each direction, but what if this is not enough? Or, on the contrary, it turns out that one strip would be enough, but for the implementation of the project it was necessary to buy many land plots? In both cases, the decision will be ineffective. To minimize such risks, transport planners turn to computer modeling for help. This article is a brief digression into the world of multi-agent modeling.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bq/k0/kj/bqk0kjbb814y7q7twu1uvqk3yf4.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the model, which is a copy of the real transport system, you can estimate the necessary throughput on each section of the projected road, try different tracing options, or, for example, estimate the payback period of a project if it comes to a toll road in the framework of a public-private partnership. But other important tasks can be solved: how to organize optimal public transport routes and calculate the potential revenue of operators, how to assess the presence of a shortage of parking spaces in a particular area, and many others. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is most interesting is that anyone can build a similar model in the era of free software! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the most common multi-agent modeling tools is open source.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATSim (Multi-Agent Transport Simulation)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MATSim simulates the behavior of individual agents. An agent is a computer representation of an individual in the real world. Each such agent has a daily plan, based on which he moves from one activity to another (for example, home-work-home, home-institute-work-home, home-shop-work1-work2-home, etc.), creating thus the demand for road infrastructure. A schematic representation of the daily plan looks something like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n6/xt/m_/n6xtm_ps8u0stk6f8doybvsxzq8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to create realistic plans of agents that will reflect the real behavior of people during the day, the total number of agent residents, their resettlement, places of work, study, location of shops, shopping centers, train stations and other places of activity are taken into account. To validate demand, the model is also calibrated based on field surveys: recognition and calculation of the flows of surveillance cameras and drones using a neural network or, for example, manual measurements of intensity on roads.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0x/t-/ke/0xt-kelsnwf39k3mmu2saye2zky.gif" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the simulation, the agents are distributed over the network, imitating the realistic behavior of people: implementing their plan, cars occupy a place on the road and parking places, public transport users take places on the bus, and also interact with each other and, if many agents select one road at a time, traffic jams and congestion are created. Everything is like in the real world! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the simulation is completed, an assessment is made of the fulfillment of the daily plans of agents, called scoring. The agent acquires utility units in the process of activity and loses them during the movement. Accordingly, agents caught in a traffic jam lose more utility units than agents moving along free roads.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After each iteration, some agents rebuild their plan on the basis of information about the load of the road network in such a way as to improve their performance: agents can change the departure time, change the mode of transport, or change the route. </font><font style="vertical-align: inherit;">The remaining agents adhere to their previous plans, which are stored in the program memory. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ideally, after the simulation, a Nash equilibrium should be achieved - that is, a situation where no agent can improve his position without worsening the position of other agents. </font><font style="vertical-align: inherit;">Usually this is the situation that develops over time on the roads of the city, given the daily rethinking of the experience of the previous day by its residents. </font><font style="vertical-align: inherit;">For this, at least 200 iterations are carried out in the framework of one scenario. </font><font style="vertical-align: inherit;">The entire MATSim work cycle looks something like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mr/zv/ds/mrzvds3njmsli5hbkiqvzhnuoju.png" alt="image"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From theory to practice! </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To run the first scenario, we need Intellij IDEA (or Eclipse) with Java 1.8 on board. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We open the IDE, clone </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the MATSim repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the github and our first scenario is ready to run! </font><font style="vertical-align: inherit;">So simple. </font><font style="vertical-align: inherit;">But let's first see what input files we use. </font><font style="vertical-align: inherit;">For the simplest simulation, there are three of them: network, plans, config.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The network file is the network on which agents move. </font><font style="vertical-align: inherit;">It consists of nodes and nodes / links. </font><font style="vertical-align: inherit;">Each link has different attributes: type, length of segment, bandwidth, maximum speed, number of lanes, one-way traffic, allowed modes of transport, etc. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_n/5p/rx/_n5prxnenyiuei82fndy2uekigy.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creating a city grid manually is difficult, impractical and inefficient. </font><font style="vertical-align: inherit;">For example, our St. Petersburg grid consists of 26 thousand nodes and 46 thousand links. </font><font style="vertical-align: inherit;">But there is good news. </font><font style="vertical-align: inherit;">The grid can be converted from OpenStreetMap and then edited using JOSM, which is also open-source.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plans</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The plans file is a structured representation of the daily plans of agents. </font><font style="vertical-align: inherit;">In the initial scenario, we have 100 agents who leave by car (mode = ‚Äùcar‚Äù) in the morning (end_time = ‚Äù05:59‚Äù) from home (type = ‚Äùh‚Äù, link = ‚Äù1‚Äù) to work (type = ‚ÄùW‚Äù, link = ‚Äù20‚Äù), after which after some time (dur = ‚Äù02:30‚Äù) they return home.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/vh/sp/8gvhsph0hfmjwzpfspy0liqv7xo.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Config</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, in the config file, all the necessary settings are set to run the script. </font><font style="vertical-align: inherit;">MATSim consists of modules that you can customize, add, or remove as needed. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many of the settings in the config file are intuitive, but you can also always look into the so-called. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATSim Book</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Now we will consider only two modules.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Scoring parameters are set in the planCalcScore module: for example, an agent receives a penalty of 18 units for late arrivals. </font><font style="vertical-align: inherit;">utility per hour (respectively, being late for 10 minutes is equivalent to losing 3 utility units); </font><font style="vertical-align: inherit;">performing some activity (for example, performing) brings 6 utility units per hour, and driving a car costs the same 6 utility units per hour. To search for realistic scoring parameters, opinion polls are most often used to analyze the ‚Äúcost time. ‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the strategy module, re-planning parameters are configured, for example, what percentage of the agents (ModuleProbability) will try the new route (ReRoute) during the next iteration. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dc/jf/yo/dcjfyoldbtrsg_zgrydyrrkc6ce.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the goal of the simulation is to help the agent get from point A to point B at the lowest cost.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script run</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Time to open RunMatsim runner and run our first script! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The simulation results will be in the output folder in the root of the project. The main files for visualization are network and events. The events file contains per-second information about all the actions of each agent, therefore, based on this file, you can restore the full picture of the movement of all agents. You can visualize the results using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Via</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For more representative results, I will increase the number of agents to 500. This is how the distribution of 500 agents looks like after the first iteration ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/by/o3/zk/byo3zk14bt0yj1y7od2sth35nok.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the beginning of the iteration, the agents calculated the shortest way using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dijkstra</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result of which the traffic intensity in one section of the network exceeded its throughput, a congestion formed. </font><font style="vertical-align: inherit;">But what if you give them the opportunity to try different routes? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7l/_j/5_/7l_j5_q_n2g3roivtbnht8iwqfq.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After 200 iterations (~ 5 minutes), the agents were redistributed over the network, the link load level now does not exceed 0.5, and the average travel time for all agents decreased by 14% (5 minutes). </font><font style="vertical-align: inherit;">Hooray, we have overcome the cork! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh, if only it were that simple! </font><font style="vertical-align: inherit;">In reality, transport systems are much more complicated. </font><font style="vertical-align: inherit;">In the following articles I will tell you how I participated in the development of models of St. Petersburg and other cities and how we solved practical problems on real cases. </font><font style="vertical-align: inherit;">Scientia potentia est! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/v-/t0/cjv-t0plurhha0_szf4vhthcubo.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Posted by Andrey Kolomatsky, Transport Analyst at OTSLab.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494580/index.html">Fractals in the sand, or More than three do not gather</a></li>
<li><a href="../en494582/index.html">Microsoft will no longer issue MCSE / MCSD / MCSA certificates</a></li>
<li><a href="../en494586/index.html">Functional programming as an example of working with matrices from the theory of linear algebra</a></li>
<li><a href="../en494590/index.html">Coronavirus - the apotheosis of panic</a></li>
<li><a href="../en494592/index.html">Homemade Manganese Vapor Laser</a></li>
<li><a href="../en494598/index.html">Researchers at Stanford have developed an exoskeleton for running</a></li>
<li><a href="../en494600/index.html">Creating a simple Discord bot using the discord.py library</a></li>
<li><a href="../en494604/index.html">UV sterilization box for reuse of disposable masks</a></li>
<li><a href="../en494606/index.html">How to observe the moon and planets</a></li>
<li><a href="../en494608/index.html">Preparing for Ludum Dare</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>