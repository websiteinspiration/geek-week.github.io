<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧣 👨🏽‍🔬 🤜🏾 Accélérer les graphiques en utilisant OffscreenCanvas 🤙🏽 🍳 👾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le rendu des graphiques peut sérieusement affecter le navigateur. Surtout quand il s'agit de sortir une multitude d'éléments représentant des diagramm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Accélérer les graphiques en utilisant OffscreenCanvas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/496960/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rendu des graphiques peut sérieusement affecter le navigateur. </font><font style="vertical-align: inherit;">Surtout quand il s'agit de sortir une multitude d'éléments représentant des diagrammes dans l'interface d'une application complexe. </font><font style="vertical-align: inherit;">Vous pouvez essayer d'améliorer la situation en utilisant l'interface </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le niveau de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dont les navigateurs augmentent progressivement. </font><font style="vertical-align: inherit;">Il permet, en utilisant un web-travailleur, de lui confier les tâches de formation d'une image affichée dans un élément visible </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
L'article, dont nous publions aujourd'hui la traduction, est consacré à l'utilisation de l'interface </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ici, nous expliquerons pourquoi cette interface peut être nécessaire, ce que l'on peut vraiment attendre de son application et quelles difficultés peuvent survenir lors de son utilisation.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/mi/x3/fs/mix3fsxq_7zuda10gqvxuhwmw1u.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi faire attention à OffscreenCanvas?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code impliqué dans le rendu du diagramme peut lui-même avoir une complexité de calcul suffisamment élevée. Dans de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombreux endroits,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous pouvez trouver des histoires détaillées sur la façon de produire une animation fluide et pour assurer une interaction pratique de l'utilisateur avec la page, il est nécessaire que le rendu d'une image tienne dans environ 10 ms, ce qui vous permet d'atteindre 60 images par seconde. Si les calculs requis pour produire une trame prennent plus de 10 ms, cela entraînera des "ralentissements" notables de la page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, lors de l'affichage des diagrammes, la situation est aggravée par les éléments suivants:</font></font><br>
<br>
<ul>
<li>        —   - (SVG, canvas, WebGL)      ,     ,       .</li>
<li>     , ,        ,  ,  10 .          ( —   )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces problèmes sont des candidats idéaux pour une approche d'optimisation classique appelée diviser pour mieux régner. Dans ce cas, nous parlons de la distribution de la charge de calcul sur plusieurs threads. Cependant, avant l'apparition de l'interface, </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout le code de rendu devait être exécuté dans le thread principal. La seule façon dont ce code pouvait utiliser les API dont il avait besoin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'un point de vue technique, des calculs «lourds» pourraient être envoyés à un thread de travail Web plus tôt. Mais, comme les appels responsables du rendu devaient être effectués à partir du flux principal, cela nécessitait l'utilisation de schémas d'échange de messages complexes entre le flux de travail et le flux principal dans le code de sortie du graphique. De plus, cette approche n'apportait souvent qu'un léger gain de performances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
spécification</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous donne un mécanisme pour transférer le contrôle de surface pour afficher les graphiques des éléments </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans un travailleur Web. </font><font style="vertical-align: inherit;">Cette spécification est actuellement prise en charge par les navigateurs Chrome et Edge (après la migration d'Edge vers Chromium). </font><font style="vertical-align: inherit;">Il est prévu que le support de Firefox </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apparaisse dans les six mois. </font><font style="vertical-align: inherit;">Si nous parlons de Safari, on ne sait toujours pas si la prise en charge de cette technologie est prévue dans ce navigateur.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sortie de graphique en utilisant OffscreenCanvas</font></font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e83/fe3/cf3/e83fe3cf3d366175052d1b6e66a65f93.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de graphique qui affiche 100 000 points multicolores</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Afin de mieux évaluer les avantages et les inconvénients potentiels</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, regardons un exemple de sortie du diagramme "lourd" montré dans la figure précédente.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> offscreenCanvas = canvasContainer<font></font>
&nbsp;&nbsp;.querySelector(<span class="hljs-string">'canvas'</span>)<font></font>
&nbsp;&nbsp;.transferControlToOffscreen();<font></font>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">'worker.js'</span>);<font></font>
worker.postMessage({ offscreenCanvas }, [offscreenCanvas]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous interrogeons </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'élément </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à l'aide de la nouvelle méthode </font></font><code>transferControlToOffscreen()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, nous appelons la méthode </font></font><code>worker.postMessage({ canvas: offscreenCanvas }, [offscreenCanvas])</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en faisant cela pour envoyer un message au travailleur contenant un lien vers </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il est très important qu'ici, comme deuxième argument, vous deviez utiliser </font></font><code>[offscreenCanvas]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cela vous permet de rendre le propriétaire de cet objet travailleur, ce qui lui permettra de gérer seul </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">canvasContainer.addEventListener(<span class="hljs-string">'measure'</span>, ({ detail }) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> { width, height } = detail;<font></font>
&nbsp;&nbsp;worker.postMessage({ width, height });<font></font>
});<font></font>
canvasContainer.requestRedraw();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que les tailles ont </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">été héritées à l'origine des attributs </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et de l' </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">élément </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il est de notre responsabilité de maintenir ces valeurs à jour lorsque l'élément est redimensionné </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nous utilisons ici l'événement </font></font><code>measure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de </font></font><code>d3fc-canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui nous donnera l'occasion, en accord avec </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de transmettre au travailleur des informations sur les nouvelles dimensions de l'élément </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de simplifier l'exemple, nous utiliserons des composants de la bibliothèque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d3fc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il s'agit d'un ensemble de composants auxiliaires qui agrègent les composants d3 ou complètent leurs fonctionnalités. Vous </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pouvez </font><font style="vertical-align: inherit;">travailler avec </font><font style="vertical-align: inherit;">sans composants d3fc. Tout ce qui sera discuté peut être fait en utilisant exclusivement des fonctionnalités JavaScript standard.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, allez dans le code du fichier </font></font><code>worker.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dans cet exemple, pour une réelle augmentation des performances de rendu, nous allons utiliser WebGL.</font></font><br>
<br>
<pre><code class="javascript hljs">addEventListener(<span class="hljs-string">'message'</span>, ({ <span class="hljs-attr">data</span>: { offscreenCanvas, width, height } }) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (offscreenCanvas != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = offscreenCanvas.getContext(<span class="hljs-string">'webgl'</span>);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series.context(gl);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (width != <span class="hljs-literal">null</span> &amp;&amp; height != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = series.context();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.width = width;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.height = height;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.viewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, gl.canvas.width, gl.canvas.height);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous recevons un message contenant une propriété </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous supposons que le message provient du thread principal. Ensuite, nous obtenons le </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contexte </font><font style="vertical-align: inherit;">de l'élément </font></font><code>webgl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le transmettons au composant </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, nous appelons le composant </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en lui passant les données ( </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que nous voulons rendre en l'utilisant (ci-dessous, nous parlerons de l'origine des variables correspondantes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, nous vérifions les propriétés </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, fournies dans le message, et les utilisons pour définir les dimensions </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la zone d'affichage de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> WebGL. Le lien </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'est pas utilisé directement. Le fait est que le message contient une propriété </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou des propriétés </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de travail restant est responsable de la configuration du rendu de ce que nous voulons afficher. </font><font style="vertical-align: inherit;">Il n'y a rien de spécial ici, donc si tout cela vous est familier, vous pouvez immédiatement passer à la section suivante dans laquelle nous discutons des performances.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> randomNormal = d3.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> randomLogNormal = d3.randomLogNormal();<font></font>
<font></font>
<span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Array</span>.from({ <span class="hljs-attr">length</span>: <span class="hljs-number">1e5</span> }, () =&gt; ({
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">x</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">y</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">size</span>: randomLogNormal() * <span class="hljs-number">10</span><font></font>
}));<font></font>
<font></font>
<span class="hljs-keyword">const</span> xScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);<font></font>
<font></font>
<span class="hljs-keyword">const</span> yScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous créons un ensemble de données contenant les coordonnées des points répartis aléatoirement autour de l'origine x / y, et ajustons l'échelle. </font><font style="vertical-align: inherit;">Nous ne définissons pas la plage de valeurs x et y à l'aide de la méthode </font></font><code>range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, car les séries WebGL sont affichées en taille réelle de l'élément </font></font><code>canvas</code> <code>(-1 -&gt; +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans les coordonnées normalisées de l'appareil).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> series = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.seriesWebglPoint()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.xScale(xScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.yScale(yScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.crossValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.x)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.mainValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.y)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.size(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.size)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.equals(<span class="hljs-function">(<span class="hljs-params">previousData, data</span>) =&gt;</span> previousData.length &gt; <span class="hljs-number">0</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous avons configuré une série de points en utilisant </font></font><code>xScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>yScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ensuite, nous configurons les moyens d'accès appropriés qui vous permettent de lire les données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, nous définissons notre propre fonction de vérification d'égalité, qui est conçue pour garantir que le composant ne transmet pas de </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU à chaque rendu. </font><font style="vertical-align: inherit;">Nous devons l'exprimer explicitement, car même si nous savons que nous ne modifierons pas ces données, le composant ne peut pas le savoir sans effectuer une vérification «sale» gourmande en ressources.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> colorScale = d3.scaleOrdinal(d3.schemeAccent);<font></font>
<font></font>
<span class="hljs-keyword">const</span> webglColor = <span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> { r, g, b, opacity } = d3.color(color).rgb();
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> [r / <span class="hljs-number">255</span>, g / <span class="hljs-number">255</span>, b / <span class="hljs-number">255</span>, opacity];<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> fillColor = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.webglFillColor()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.value(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> webglColor(colorScale(i)))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.data(data);<font></font>
<font></font>
series.decorate(<span class="hljs-function"><span class="hljs-params">program</span> =&gt;</span> {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;fillColor(program);<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code vous permet de coloriser le graphique. </font><font style="vertical-align: inherit;">Nous utilisons l'index du point dans l'ensemble de données pour sélectionner la couleur appropriée </font></font><code>colorScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis la convertissons au format requis et l'utilisons pour décorer le point de sortie.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> ease = <span class="hljs-number">5</span> * (<span class="hljs-number">0.51</span> + <span class="hljs-number">0.49</span> * <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1e3</span>));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;xScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;yScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;requestAnimationFrame(render);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que les points sont colorés, il ne reste plus qu'à animer le graphique. Pour cette raison, nous aurons besoin d'un appel de méthode constant </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. De plus, cela créera une certaine charge sur le système. Nous simulons l'augmentation et la diminution de l'échelle du graphique en utilisant </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour modifier les propriétés </font></font><code>xScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>yScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chaque cadre. Ici, les valeurs dépendantes du temps sont appliquées et calculées de sorte que l'échelle du graphique change en douceur. De plus, nous modifions l'en-tête du message pour qu'une méthode soit appelée pour démarrer le cycle de rendu </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et pour que nous n'ayons pas à appeler directement </font></font><code>series(data)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">importScripts(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-array/dist/d3-array.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-collection/dist/d3-collection.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-color/dist/d3-color.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-interpolate/dist/d3-interpolate.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-random/dist/d3-random.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale/dist/d3-scale.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-shape/dist/d3-shape.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-extent/build/d3fc-extent.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-random-data/build/d3fc-random-data.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-rebind/build/d3fc-rebind.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-series/build/d3fc-series.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-webgl/build/d3fc-webgl.js'</span><font></font>
);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que cet exemple fonctionne, il ne reste plus qu'à importer les bibliothèques nécessaires dans l'ouvrier. </font><font style="vertical-align: inherit;">Nous utilisons pour cela </font></font><code>importScripts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et aussi, pour ne pas utiliser les outils de construction de projets, nous utilisons une liste de dépendances compilée manuellement. </font><font style="vertical-align: inherit;">Malheureusement, nous ne pouvons pas simplement télécharger les versions complètes de d3 / d3fc, car elles dépendent du DOM et ce dont elles ont besoin dans le programme de travail n'est pas disponible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
→ Le code complet de cet exemple se trouve sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toiles et performances</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'animation dans notre projet fonctionne grâce à l'utilisation </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'un travailleur. Cela permet au travailleur de rendre les pages même lorsque le thread principal est occupé par d'autres choses. Si vous regardez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la page du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> projet décrite dans la section précédente et cliquez sur le bouton </font></font><code>Stop main thread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous pouvez faire attention au fait que lorsque la boîte de message s'affiche, la mise à jour des informations d'horodatage s'arrête. Le thread principal est bloqué, mais l'animation du graphique ne s'arrête pas.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/3ce/c20/f1a3cec2086024dcbe24cedddf1a90e7.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fenêtre du projet</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nous pourrions organiser un rendu initié en recevant des messages du flux principal. Par exemple, de tels événements peuvent être envoyés lorsqu'un utilisateur interagit avec un graphique ou lorsqu'il reçoit de nouvelles données sur le réseau. Mais avec cette approche, si le thread principal est occupé par quelque chose et qu'aucun message n'est reçu dans l'ouvrier, le rendu s'arrêtera.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le rendu continu du graphique dans des conditions où rien ne se passe est un excellent moyen d'agacer l'utilisateur avec un ventilateur qui bourdonne et une batterie faible. En conséquence, il s'avère que dans le monde réel, la décision sur la façon de répartir les responsabilités entre le thread principal et le thread de travail dépend de si le travailleur peut rendre quelque chose d'utile lorsqu'il ne reçoit pas de messages sur un changement de situation du fil principal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous parlons du transfert de messages entre les threads, il convient de noter qu'ici nous avons appliqué une approche très simple. Honnêtement, nous devons transmettre très peu de messages entre les fils, donc je préfère appeler notre approche une conséquence du pragmatisme, pas de la paresse. Mais si nous parlons d'applications réelles, on peut noter que le schéma de transfert des messages entre les flux deviendra plus compliqué si l'interaction de l'utilisateur avec le diagramme et la mise à jour des données visualisées en dépendra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez utiliser l'interface </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">MessageChannel</font></a><font style="vertical-align: inherit;"> standard pour créer des canaux de messages séparés entre le thread principal et le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">thread de</font></a><font style="vertical-align: inherit;"> travail </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Chacun de ces canaux peut être utilisé pour une catégorie spécifique de messages, ce qui facilite le traitement des messages. Comme alternative aux mécanismes standard, les bibliothèques tierces comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comlink</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peuvent agir </font><font style="vertical-align: inherit;">. Cette bibliothèque cache des détails de bas niveau derrière une interface de haut niveau utilisant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des objets proxy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre caractéristique intéressante de notre exemple, qui devient clairement visible rétrospectivement, est le fait qu'il prend en compte le fait que les ressources GPU, comme les autres ressources système, sont loin d'être infinies. La traduction du rendu en travailleur permet au thread principal de résoudre d'autres problèmes. Mais le navigateur, de toute façon, doit utiliser le GPU pour rendre le DOM et ce qui a été généré par les moyens </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le travailleur consomme toutes les ressources GPU, la fenêtre principale de l'application rencontrera des problèmes de performances, quel que soit l'endroit où le rendu est effectué. Faites attention à la façon dont la vitesse de mise à jour de l'horodatage dans l'exemple diminue à mesure que le nombre de points affichés augmente. Si vous avez une carte graphique puissante, vous devrez peut-être augmenter le nombre de points transmis à la page dans la chaîne de requête. Pour ce faire, vous pouvez utiliser une valeur qui dépasse la valeur maximale de 100 000, spécifiée à l'aide de l'un des liens de la page d'exemple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de noter qu'ici nous n'avons pas exploré le monde secret </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des attributs de contexte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Une telle étude pourrait nous aider à augmenter la productivité de la solution. </font><font style="vertical-align: inherit;">Cependant, je ne l'ai pas fait en le faisant en raison du faible niveau de prise en charge de ces attributs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous parlons de rendu utilisant </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, l'attribut semble le plus intéressant ici </font></font><code>desynchronized</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il, où il est pris en charge, et en tenant compte de certaines restrictions, vous permet de vous débarrasser de la synchronisation entre la boucle d'événements et la boucle de rendu qui est exécutée dans le travailleur. </font><font style="vertical-align: inherit;">Cela minimise le délai de mise à jour de l'image. </font><font style="vertical-align: inherit;">Des détails à ce sujet peuvent être trouvés </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'interface </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donne aux développeurs la possibilité d'améliorer les performances de rendu des graphiques, mais son utilisation nécessite une approche réfléchie. </font><font style="vertical-align: inherit;">En l'utilisant, vous devez tenir compte des éléments suivants:</font></font><br>
<br>
<ul>
<li>     (,  ,     )  -        .<br>
<br>
<ul>
<li>  ,         .  ,   ,         ,    postMessage.</li>
</ul></li>
<li>,       (,  SVG/HTML-   <code>&lt;canvas&gt;</code>), ,   ,  .<br>
<br>
<ul>
<li>,  ,   ,      ,       ,   ,  ,  ,     .</li>
</ul></li>
<li>,     GPU,    <code>OffscreenCanvas</code>       .<br>
<br>
<ul>
<li>      OffscreenCanvas,        GPU-,     ,     .    ,    ,      .</li>
</ul></li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici un</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exemple de code, et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sa version de travail. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chers lecteurs! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avez-vous utilisé OffscreenCanvas pour accélérer l'affichage des graphiques sur les pages Web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496950/index.html">Le design est le design, pas la beauté des images.</a></li>
<li><a href="../fr496952/index.html">Qualcomm QCC3020 - l'essor des écouteurs TWS chinois</a></li>
<li><a href="../fr496954/index.html">Développement chez Wargaming - réunion avec Maxim Baryshnikov, chef de plate-forme (partie I)</a></li>
<li><a href="../fr496956/index.html">Pourquoi les serveurs Web asynchrones sont-ils apparus?</a></li>
<li><a href="../fr496958/index.html">CSS intéressant trouve dans la nouvelle conception de Facebook</a></li>
<li><a href="../fr496962/index.html">Comment ranger un serveur surchargé?</a></li>
<li><a href="../fr496964/index.html">Séminaires hebdomadaires IBM - avril 2020</a></li>
<li><a href="../fr496966/index.html">Couleurs CSS LCH</a></li>
<li><a href="../fr496968/index.html">4 actions impardonnables pour le leader lors de COVID-19</a></li>
<li><a href="../fr496972/index.html">Tendances en matière de sécurité sanitaire des aliments 2020. Mitap en ligne gratuit 21 avril</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>