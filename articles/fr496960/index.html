<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üß£ üë®üèΩ‚Äçüî¨ ü§úüèæ Acc√©l√©rer les graphiques en utilisant OffscreenCanvas ü§ôüèΩ üç≥ üëæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le rendu des graphiques peut s√©rieusement affecter le navigateur. Surtout quand il s'agit de sortir une multitude d'√©l√©ments repr√©sentant des diagramm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acc√©l√©rer les graphiques en utilisant OffscreenCanvas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/496960/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rendu des graphiques peut s√©rieusement affecter le navigateur. </font><font style="vertical-align: inherit;">Surtout quand il s'agit de sortir une multitude d'√©l√©ments repr√©sentant des diagrammes dans l'interface d'une application complexe. </font><font style="vertical-align: inherit;">Vous pouvez essayer d'am√©liorer la situation en utilisant l'interface </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le niveau de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dont les navigateurs augmentent progressivement. </font><font style="vertical-align: inherit;">Il permet, en utilisant un web-travailleur, de lui confier les t√¢ches de formation d'une image affich√©e dans un √©l√©ment visible </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
L'article, dont nous publions aujourd'hui la traduction, est consacr√© √† l'utilisation de l'interface </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ici, nous expliquerons pourquoi cette interface peut √™tre n√©cessaire, ce que l'on peut vraiment attendre de son application et quelles difficult√©s peuvent survenir lors de son utilisation.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/mi/x3/fs/mix3fsxq_7zuda10gqvxuhwmw1u.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi faire attention √† OffscreenCanvas?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code impliqu√© dans le rendu du diagramme peut lui-m√™me avoir une complexit√© de calcul suffisamment √©lev√©e. Dans de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombreux endroits,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous pouvez trouver des histoires d√©taill√©es sur la fa√ßon de produire une animation fluide et pour assurer une interaction pratique de l'utilisateur avec la page, il est n√©cessaire que le rendu d'une image tienne dans environ 10 ms, ce qui vous permet d'atteindre 60 images par seconde. Si les calculs requis pour produire une trame prennent plus de 10 ms, cela entra√Ænera des "ralentissements" notables de la page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, lors de l'affichage des diagrammes, la situation est aggrav√©e par les √©l√©ments suivants:</font></font><br>
<br>
<ul>
<li>        ‚Äî   - (SVG, canvas, WebGL)      ,     ,       .</li>
<li>     , ,        ,  ,  10 .          ( ‚Äî   )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces probl√®mes sont des candidats id√©aux pour une approche d'optimisation classique appel√©e diviser pour mieux r√©gner. Dans ce cas, nous parlons de la distribution de la charge de calcul sur plusieurs threads. Cependant, avant l'apparition de l'interface, </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout le code de rendu devait √™tre ex√©cut√© dans le thread principal. La seule fa√ßon dont ce code pouvait utiliser les API dont il avait besoin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'un point de vue technique, des calculs ¬´lourds¬ª pourraient √™tre envoy√©s √† un thread de travail Web plus t√¥t. Mais, comme les appels responsables du rendu devaient √™tre effectu√©s √† partir du flux principal, cela n√©cessitait l'utilisation de sch√©mas d'√©change de messages complexes entre le flux de travail et le flux principal dans le code de sortie du graphique. De plus, cette approche n'apportait souvent qu'un l√©ger gain de performances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sp√©cification</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous donne un m√©canisme pour transf√©rer le contr√¥le de surface pour afficher les graphiques des √©l√©ments </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans un travailleur Web. </font><font style="vertical-align: inherit;">Cette sp√©cification est actuellement prise en charge par les navigateurs Chrome et Edge (apr√®s la migration d'Edge vers Chromium). </font><font style="vertical-align: inherit;">Il est pr√©vu que le support de Firefox </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apparaisse dans les six mois. </font><font style="vertical-align: inherit;">Si nous parlons de Safari, on ne sait toujours pas si la prise en charge de cette technologie est pr√©vue dans ce navigateur.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sortie de graphique en utilisant OffscreenCanvas</font></font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e83/fe3/cf3/e83fe3cf3d366175052d1b6e66a65f93.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple de graphique qui affiche 100 000 points multicolores</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Afin de mieux √©valuer les avantages et les inconv√©nients potentiels</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, regardons un exemple de sortie du diagramme "lourd" montr√© dans la figure pr√©c√©dente.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> offscreenCanvas = canvasContainer<font></font>
&nbsp;&nbsp;.querySelector(<span class="hljs-string">'canvas'</span>)<font></font>
&nbsp;&nbsp;.transferControlToOffscreen();<font></font>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">'worker.js'</span>);<font></font>
worker.postMessage({ offscreenCanvas }, [offscreenCanvas]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous interrogeons </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'√©l√©ment </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† l'aide de la nouvelle m√©thode </font></font><code>transferControlToOffscreen()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, nous appelons la m√©thode </font></font><code>worker.postMessage({ canvas: offscreenCanvas }, [offscreenCanvas])</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en faisant cela pour envoyer un message au travailleur contenant un lien vers </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il est tr√®s important qu'ici, comme deuxi√®me argument, vous deviez utiliser </font></font><code>[offscreenCanvas]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cela vous permet de rendre le propri√©taire de cet objet travailleur, ce qui lui permettra de g√©rer seul </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">canvasContainer.addEventListener(<span class="hljs-string">'measure'</span>, ({ detail }) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> { width, height } = detail;<font></font>
&nbsp;&nbsp;worker.postMessage({ width, height });<font></font>
});<font></font>
canvasContainer.requestRedraw();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que les tailles ont </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©t√© h√©rit√©es √† l'origine des attributs </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et de l' </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©l√©ment </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il est de notre responsabilit√© de maintenir ces valeurs √† jour lorsque l'√©l√©ment est redimensionn√© </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nous utilisons ici l'√©v√©nement </font></font><code>measure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de </font></font><code>d3fc-canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui nous donnera l'occasion, en accord avec </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de transmettre au travailleur des informations sur les nouvelles dimensions de l'√©l√©ment </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de simplifier l'exemple, nous utiliserons des composants de la biblioth√®que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d3fc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il s'agit d'un ensemble de composants auxiliaires qui agr√®gent les composants d3 ou compl√®tent leurs fonctionnalit√©s. Vous </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pouvez </font><font style="vertical-align: inherit;">travailler avec </font><font style="vertical-align: inherit;">sans composants d3fc. Tout ce qui sera discut√© peut √™tre fait en utilisant exclusivement des fonctionnalit√©s JavaScript standard.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, allez dans le code du fichier </font></font><code>worker.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dans cet exemple, pour une r√©elle augmentation des performances de rendu, nous allons utiliser WebGL.</font></font><br>
<br>
<pre><code class="javascript hljs">addEventListener(<span class="hljs-string">'message'</span>, ({ <span class="hljs-attr">data</span>: { offscreenCanvas, width, height } }) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (offscreenCanvas != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = offscreenCanvas.getContext(<span class="hljs-string">'webgl'</span>);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series.context(gl);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (width != <span class="hljs-literal">null</span> &amp;&amp; height != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = series.context();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.width = width;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.height = height;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.viewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, gl.canvas.width, gl.canvas.height);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous recevons un message contenant une propri√©t√© </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous supposons que le message provient du thread principal. Ensuite, nous obtenons le </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contexte </font><font style="vertical-align: inherit;">de l'√©l√©ment </font></font><code>webgl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le transmettons au composant </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ensuite, nous appelons le composant </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en lui passant les donn√©es ( </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que nous voulons rendre en l'utilisant (ci-dessous, nous parlerons de l'origine des variables correspondantes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, nous v√©rifions les propri√©t√©s </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, fournies dans le message, et les utilisons pour d√©finir les dimensions </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la zone d'affichage de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> WebGL. Le lien </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'est pas utilis√© directement. Le fait est que le message contient une propri√©t√© </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou des propri√©t√©s </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de travail restant est responsable de la configuration du rendu de ce que nous voulons afficher. </font><font style="vertical-align: inherit;">Il n'y a rien de sp√©cial ici, donc si tout cela vous est familier, vous pouvez imm√©diatement passer √† la section suivante dans laquelle nous discutons des performances.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> randomNormal = d3.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> randomLogNormal = d3.randomLogNormal();<font></font>
<font></font>
<span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Array</span>.from({ <span class="hljs-attr">length</span>: <span class="hljs-number">1e5</span> }, () =&gt; ({
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">x</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">y</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">size</span>: randomLogNormal() * <span class="hljs-number">10</span><font></font>
}));<font></font>
<font></font>
<span class="hljs-keyword">const</span> xScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);<font></font>
<font></font>
<span class="hljs-keyword">const</span> yScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous cr√©ons un ensemble de donn√©es contenant les coordonn√©es des points r√©partis al√©atoirement autour de l'origine x / y, et ajustons l'√©chelle. </font><font style="vertical-align: inherit;">Nous ne d√©finissons pas la plage de valeurs x et y √† l'aide de la m√©thode </font></font><code>range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, car les s√©ries WebGL sont affich√©es en taille r√©elle de l'√©l√©ment </font></font><code>canvas</code> <code>(-1 -&gt; +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans les coordonn√©es normalis√©es de l'appareil).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> series = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.seriesWebglPoint()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.xScale(xScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.yScale(yScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.crossValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.x)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.mainValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.y)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.size(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.size)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.equals(<span class="hljs-function">(<span class="hljs-params">previousData, data</span>) =&gt;</span> previousData.length &gt; <span class="hljs-number">0</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous avons configur√© une s√©rie de points en utilisant </font></font><code>xScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>yScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ensuite, nous configurons les moyens d'acc√®s appropri√©s qui vous permettent de lire les donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, nous d√©finissons notre propre fonction de v√©rification d'√©galit√©, qui est con√ßue pour garantir que le composant ne transmet pas de </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU √† chaque rendu. </font><font style="vertical-align: inherit;">Nous devons l'exprimer explicitement, car m√™me si nous savons que nous ne modifierons pas ces donn√©es, le composant ne peut pas le savoir sans effectuer une v√©rification ¬´sale¬ª gourmande en ressources.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> colorScale = d3.scaleOrdinal(d3.schemeAccent);<font></font>
<font></font>
<span class="hljs-keyword">const</span> webglColor = <span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> { r, g, b, opacity } = d3.color(color).rgb();
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> [r / <span class="hljs-number">255</span>, g / <span class="hljs-number">255</span>, b / <span class="hljs-number">255</span>, opacity];<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> fillColor = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.webglFillColor()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.value(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> webglColor(colorScale(i)))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.data(data);<font></font>
<font></font>
series.decorate(<span class="hljs-function"><span class="hljs-params">program</span> =&gt;</span> {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;fillColor(program);<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code vous permet de coloriser le graphique. </font><font style="vertical-align: inherit;">Nous utilisons l'index du point dans l'ensemble de donn√©es pour s√©lectionner la couleur appropri√©e </font></font><code>colorScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis la convertissons au format requis et l'utilisons pour d√©corer le point de sortie.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> ease = <span class="hljs-number">5</span> * (<span class="hljs-number">0.51</span> + <span class="hljs-number">0.49</span> * <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1e3</span>));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;xScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;yScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;requestAnimationFrame(render);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que les points sont color√©s, il ne reste plus qu'√† animer le graphique. Pour cette raison, nous aurons besoin d'un appel de m√©thode constant </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. De plus, cela cr√©era une certaine charge sur le syst√®me. Nous simulons l'augmentation et la diminution de l'√©chelle du graphique en utilisant </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour modifier les propri√©t√©s </font></font><code>xScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>yScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chaque cadre. Ici, les valeurs d√©pendantes du temps sont appliqu√©es et calcul√©es de sorte que l'√©chelle du graphique change en douceur. De plus, nous modifions l'en-t√™te du message pour qu'une m√©thode soit appel√©e pour d√©marrer le cycle de rendu </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et pour que nous n'ayons pas √† appeler directement </font></font><code>series(data)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">importScripts(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-array/dist/d3-array.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-collection/dist/d3-collection.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-color/dist/d3-color.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-interpolate/dist/d3-interpolate.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-random/dist/d3-random.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale/dist/d3-scale.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-shape/dist/d3-shape.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-extent/build/d3fc-extent.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-random-data/build/d3fc-random-data.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-rebind/build/d3fc-rebind.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-series/build/d3fc-series.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-webgl/build/d3fc-webgl.js'</span><font></font>
);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que cet exemple fonctionne, il ne reste plus qu'√† importer les biblioth√®ques n√©cessaires dans l'ouvrier. </font><font style="vertical-align: inherit;">Nous utilisons pour cela </font></font><code>importScripts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et aussi, pour ne pas utiliser les outils de construction de projets, nous utilisons une liste de d√©pendances compil√©e manuellement. </font><font style="vertical-align: inherit;">Malheureusement, nous ne pouvons pas simplement t√©l√©charger les versions compl√®tes de d3 / d3fc, car elles d√©pendent du DOM et ce dont elles ont besoin dans le programme de travail n'est pas disponible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Üí Le code complet de cet exemple se trouve sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toiles et performances</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'animation dans notre projet fonctionne gr√¢ce √† l'utilisation </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'un travailleur. Cela permet au travailleur de rendre les pages m√™me lorsque le thread principal est occup√© par d'autres choses. Si vous regardez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la page du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> projet d√©crite dans la section pr√©c√©dente et cliquez sur le bouton </font></font><code>Stop main thread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous pouvez faire attention au fait que lorsque la bo√Æte de message s'affiche, la mise √† jour des informations d'horodatage s'arr√™te. Le thread principal est bloqu√©, mais l'animation du graphique ne s'arr√™te pas.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/3ce/c20/f1a3cec2086024dcbe24cedddf1a90e7.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fen√™tre du projet</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nous pourrions organiser un rendu initi√© en recevant des messages du flux principal. Par exemple, de tels √©v√©nements peuvent √™tre envoy√©s lorsqu'un utilisateur interagit avec un graphique ou lorsqu'il re√ßoit de nouvelles donn√©es sur le r√©seau. Mais avec cette approche, si le thread principal est occup√© par quelque chose et qu'aucun message n'est re√ßu dans l'ouvrier, le rendu s'arr√™tera.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le rendu continu du graphique dans des conditions o√π rien ne se passe est un excellent moyen d'agacer l'utilisateur avec un ventilateur qui bourdonne et une batterie faible. En cons√©quence, il s'av√®re que dans le monde r√©el, la d√©cision sur la fa√ßon de r√©partir les responsabilit√©s entre le thread principal et le thread de travail d√©pend de si le travailleur peut rendre quelque chose d'utile lorsqu'il ne re√ßoit pas de messages sur un changement de situation du fil principal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous parlons du transfert de messages entre les threads, il convient de noter qu'ici nous avons appliqu√© une approche tr√®s simple. Honn√™tement, nous devons transmettre tr√®s peu de messages entre les fils, donc je pr√©f√®re appeler notre approche une cons√©quence du pragmatisme, pas de la paresse. Mais si nous parlons d'applications r√©elles, on peut noter que le sch√©ma de transfert des messages entre les flux deviendra plus compliqu√© si l'interaction de l'utilisateur avec le diagramme et la mise √† jour des donn√©es visualis√©es en d√©pendra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez utiliser l'interface </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">MessageChannel</font></a><font style="vertical-align: inherit;"> standard pour cr√©er des canaux de messages s√©par√©s entre le thread principal et le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">thread de</font></a><font style="vertical-align: inherit;"> travail </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Chacun de ces canaux peut √™tre utilis√© pour une cat√©gorie sp√©cifique de messages, ce qui facilite le traitement des messages. Comme alternative aux m√©canismes standard, les biblioth√®ques tierces comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comlink</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peuvent agir </font><font style="vertical-align: inherit;">. Cette biblioth√®que cache des d√©tails de bas niveau derri√®re une interface de haut niveau utilisant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des objets proxy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre caract√©ristique int√©ressante de notre exemple, qui devient clairement visible r√©trospectivement, est le fait qu'il prend en compte le fait que les ressources GPU, comme les autres ressources syst√®me, sont loin d'√™tre infinies. La traduction du rendu en travailleur permet au thread principal de r√©soudre d'autres probl√®mes. Mais le navigateur, de toute fa√ßon, doit utiliser le GPU pour rendre le DOM et ce qui a √©t√© g√©n√©r√© par les moyens </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le travailleur consomme toutes les ressources GPU, la fen√™tre principale de l'application rencontrera des probl√®mes de performances, quel que soit l'endroit o√π le rendu est effectu√©. Faites attention √† la fa√ßon dont la vitesse de mise √† jour de l'horodatage dans l'exemple diminue √† mesure que le nombre de points affich√©s augmente. Si vous avez une carte graphique puissante, vous devrez peut-√™tre augmenter le nombre de points transmis √† la page dans la cha√Æne de requ√™te. Pour ce faire, vous pouvez utiliser une valeur qui d√©passe la valeur maximale de 100 000, sp√©cifi√©e √† l'aide de l'un des liens de la page d'exemple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il convient de noter qu'ici nous n'avons pas explor√© le monde secret </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des attributs de contexte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Une telle √©tude pourrait nous aider √† augmenter la productivit√© de la solution. </font><font style="vertical-align: inherit;">Cependant, je ne l'ai pas fait en le faisant en raison du faible niveau de prise en charge de ces attributs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous parlons de rendu utilisant </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, l'attribut semble le plus int√©ressant ici </font></font><code>desynchronized</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il, o√π il est pris en charge, et en tenant compte de certaines restrictions, vous permet de vous d√©barrasser de la synchronisation entre la boucle d'√©v√©nements et la boucle de rendu qui est ex√©cut√©e dans le travailleur. </font><font style="vertical-align: inherit;">Cela minimise le d√©lai de mise √† jour de l'image. </font><font style="vertical-align: inherit;">Des d√©tails √† ce sujet peuvent √™tre trouv√©s </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'interface </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">donne aux d√©veloppeurs la possibilit√© d'am√©liorer les performances de rendu des graphiques, mais son utilisation n√©cessite une approche r√©fl√©chie. </font><font style="vertical-align: inherit;">En l'utilisant, vous devez tenir compte des √©l√©ments suivants:</font></font><br>
<br>
<ul>
<li>     (,  ,     )  -        .<br>
<br>
<ul>
<li>  ,         .  ,   ,         ,    postMessage.</li>
</ul></li>
<li>,       (,  SVG/HTML-   <code>&lt;canvas&gt;</code>), ,   ,  .<br>
<br>
<ul>
<li>,  ,   ,      ,       ,   ,  ,  ,     .</li>
</ul></li>
<li>,     GPU,    <code>OffscreenCanvas</code>       .<br>
<br>
<ul>
<li>      OffscreenCanvas,        GPU-,     ,     .    ,    ,      .</li>
</ul></li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici un</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exemple de code, et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sa version de travail. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chers lecteurs! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avez-vous utilis√© OffscreenCanvas pour acc√©l√©rer l'affichage des graphiques sur les pages Web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496950/index.html">Le design est le design, pas la beaut√© des images.</a></li>
<li><a href="../fr496952/index.html">Qualcomm QCC3020 - l'essor des √©couteurs TWS chinois</a></li>
<li><a href="../fr496954/index.html">D√©veloppement chez Wargaming - r√©union avec Maxim Baryshnikov, chef de plate-forme (partie I)</a></li>
<li><a href="../fr496956/index.html">Pourquoi les serveurs Web asynchrones sont-ils apparus?</a></li>
<li><a href="../fr496958/index.html">CSS int√©ressant trouve dans la nouvelle conception de Facebook</a></li>
<li><a href="../fr496962/index.html">Comment ranger un serveur surcharg√©?</a></li>
<li><a href="../fr496964/index.html">S√©minaires hebdomadaires IBM - avril 2020</a></li>
<li><a href="../fr496966/index.html">Couleurs CSS LCH</a></li>
<li><a href="../fr496968/index.html">4 actions impardonnables pour le leader lors de COVID-19</a></li>
<li><a href="../fr496972/index.html">Tendances en mati√®re de s√©curit√© sanitaire des aliments 2020. Mitap en ligne gratuit 21 avril</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>