<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“­ ğŸ‘ˆğŸ¿ ğŸ‘¨ğŸ¿â€ğŸ³ å¦‚ä½•åœ¨ç”µæŠ¥å¼€æ”¾ç½‘ç»œï¼ˆTONï¼‰ä¸­ç¼–å†™å’Œå‘å¸ƒæ™ºèƒ½åˆçº¦ â™¥ï¸ ğŸ‘©ğŸ¼â€ğŸš€ ğŸ‘©ğŸ¿â€âœˆï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¿™ç¯‡æ–‡ç« æ˜¯å…³äºä»€ä¹ˆçš„ï¼Ÿ
 

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è°ˆè®ºæˆ‘å¦‚ä½•å‚åŠ ç¬¬ä¸€åœºï¼ˆä¸¤åœºï¼‰åŒºå—é“¾ç”µæŠ¥æ¯”èµ›ï¼Œä½†æ²¡æœ‰è·å¾—å¥–é‡‘å¹¶å†³å®šåœ¨æ–‡ç« ä¸­è®°å½•ç»éªŒï¼Œä»¥å…é—å¿˜å¹¶å¯èƒ½å¸®åŠ©ä»–äººã€‚ 
 

ç”±äºæˆ‘ä¸æƒ³ç¼–å†™æŠ½è±¡ä»£ç ï¼Œè€Œæ˜¯æƒ³åšç‚¹å·¥ä½œï¼Œå› æ­¤ï¼Œå¯¹äºæœ¬æ–‡ï¼Œæˆ‘å†™äº†ä¸€ä¸ªæ™ºèƒ½åˆçº¦ï¼Œå³å¼€å‹å½©ç¥¨å’Œä¸€ä¸ªç«™ç‚¹ï¼Œè¯¥ç«™ç‚¹ç›´æ¥ä»TONæ˜¾ç¤ºæ™ºèƒ½åˆçº¦æ•°æ®ï¼Œè€Œæ— éœ€...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>å¦‚ä½•åœ¨ç”µæŠ¥å¼€æ”¾ç½‘ç»œï¼ˆTONï¼‰ä¸­ç¼–å†™å’Œå‘å¸ƒæ™ºèƒ½åˆçº¦</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490772/"><h2 id="o-chem-eta-statya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™ç¯‡æ–‡ç« æ˜¯å…³äºä»€ä¹ˆçš„ï¼Ÿ</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è°ˆè®ºæˆ‘å¦‚ä½•å‚åŠ ç¬¬ä¸€åœºï¼ˆä¸¤åœºï¼‰åŒºå—é“¾ç”µæŠ¥æ¯”èµ›ï¼Œä½†æ²¡æœ‰è·å¾—å¥–é‡‘å¹¶å†³å®šåœ¨æ–‡ç« ä¸­è®°å½•ç»éªŒï¼Œä»¥å…é—å¿˜å¹¶å¯èƒ½å¸®åŠ©ä»–äººã€‚ </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”±äºæˆ‘ä¸æƒ³ç¼–å†™æŠ½è±¡ä»£ç ï¼Œè€Œæ˜¯æƒ³åšç‚¹å·¥ä½œï¼Œå› æ­¤ï¼Œå¯¹äºæœ¬æ–‡ï¼Œæˆ‘å†™äº†ä¸€ä¸ªæ™ºèƒ½åˆçº¦ï¼Œå³å¼€å‹å½©ç¥¨å’Œä¸€ä¸ªç«™ç‚¹ï¼Œè¯¥ç«™ç‚¹ç›´æ¥ä»TONæ˜¾ç¤ºæ™ºèƒ½åˆçº¦æ•°æ®ï¼Œè€Œæ— éœ€ä½¿ç”¨ä¸­é—´å­˜å‚¨ã€‚ </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹äºé‚£äº›æƒ³åœ¨TONç­¾ç¬¬ä¸€ä¸ªæ™ºèƒ½åˆçº¦ä½†ä¸çŸ¥é“ä»å“ªé‡Œå¼€å§‹çš„äººæ¥è¯´ï¼Œæœ¬æ–‡å°†æ˜¯æœ‰ç”¨çš„ã€‚ </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘å°†ä»¥å½©ç¥¨ä¸ºä¾‹ï¼Œä»å»ºç«‹ç¯å¢ƒåˆ°å‘å¸ƒæ™ºèƒ½åˆçº¦ï¼Œä¸ä¹‹äº’åŠ¨ä»¥åŠç¼–å†™ç½‘ç«™æ¥æ¥æ”¶å’Œå‘å¸ƒæ•°æ®çš„è¿‡ç¨‹ã€‚ </font></font></p><a name="habracut"></a><br>
<h2 id="ob-uchastii-v-konkurse"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…³äºå‚åŠ æ¯”èµ›</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å»å¹´10æœˆï¼ŒTelegramå®£å¸ƒäº†ä½¿ç”¨æ–°è¯­è¨€</font></font><code>Fift</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font><font style="vertical-align: inherit;">çš„åŒºå—é“¾ç«èµ›</font></font><code>FunC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æœ‰å¿…è¦é€‰æ‹©ç¼–å†™äº”ä¸ªæ‹Ÿè®®çš„æ™ºèƒ½åˆçº¦ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚</font><font style="vertical-align: inherit;">æˆ‘è®¤ä¸ºåšä¸€äº›ä¸åŒå¯»å¸¸çš„äº‹æƒ…ï¼Œå­¦ä¹ ä¸€ç§è¯­è¨€å¹¶åšä¸€äº›äº‹æƒ…ä¼šå¾ˆå¥½ï¼Œå³ä½¿å°†æ¥æ‚¨ä¸å¿…å†™å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚</font><font style="vertical-align: inherit;">å¦å¤–ï¼Œè¿™ä¸ªè¯é¢˜ç»å¸¸è¢«å¬åˆ°ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å€¼å¾—ä¸€è¯´çš„æ˜¯ï¼Œæˆ‘æ²¡æœ‰å¼€å‘æ™ºèƒ½åˆçº¦çš„ç»éªŒã€‚ </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘è®¡åˆ’å‚åŠ ç›´åˆ°æœ€åï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œäº‹å®è¯æ˜æ˜¯è¿™æ ·ï¼Œåœ¨å†™äº†ä¸€ç¯‡è¯„è®ºæ–‡ç« ä¹‹åï¼Œä½†æ˜¯æˆ‘åœ¨ç¬¬ä¸€é˜¶æ®µå°±ç«‹å³å‚ä¸å…¶ä¸­ã€‚</font><font style="vertical-align: inherit;">æˆ‘</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å†™äº†ä¸€ä¸ª</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤šç­¾åçš„</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">é’±åŒ…</font></a></font><code>FunC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå®ƒé€šå¸¸å¯ä»¥ç”¨ã€‚</font><font style="vertical-align: inherit;">åŸºäº</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solidity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">æ™ºèƒ½åˆçº¦</font></a><font style="vertical-align: inherit;">ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‚£æ—¶ï¼Œæˆ‘ç®—äº†ä¸€ä¸‹ï¼Œè‡³å°‘è¦è·å¾—ä¸€äº›å¥–é‡‘ï¼Œè¿™ç»å¯¹å¤Ÿäº†ã€‚</font><font style="vertical-align: inherit;">ç»“æœï¼Œåœ¨60ä½å‚ä¸è€…ä¸­ï¼Œå¤§çº¦æœ‰40ä½æˆä¸ºäº†èµ¢å®¶ï¼Œè€Œæˆ‘å´ä¸åœ¨å…¶ä¸­ã€‚</font><font style="vertical-align: inherit;">ä¸€èˆ¬æ¥è¯´ï¼Œè¿™æ²¡å…³ç³»ï¼Œä½†æ˜¯æœ‰ä¸€ä»¶äº‹å›°æ‰°ç€æˆ‘ã€‚</font><font style="vertical-align: inherit;">åœ¨å®£å¸ƒç»“æœæ—¶ï¼Œè¿˜æ²¡æœ‰å¯¹æˆ‘çš„åˆåŒçš„æµ‹è¯•è¿›è¡Œå®¡æŸ¥ï¼Œæˆ‘é—®äº†èŠå¤©ä¸­çš„å‚ä¸è€…æ˜¯å¦è¿˜æœ‰å…¶ä»–äººï¼Œæ²¡æœ‰ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æˆ‘çœ‹æ¥ï¼Œä¸¤å¤©åï¼Œæ³•å®˜ä»¬æ³¨æ„åˆ°æˆ‘çš„ä¿¡æ¯ï¼Œä½†å‘è¡¨äº†è¯„è®ºï¼Œä½†æˆ‘ä»ç„¶ä¸æ˜ç™½ï¼Œä»–ä»¬åœ¨è¯„å®¡è¿‡ç¨‹ä¸­æ— æ„ä¸­é”™è¿‡äº†æˆ‘çš„èªæ˜åˆåŒï¼Œæˆ–è€…åªæ˜¯è§‰å¾—è¿™å¾ˆç³Ÿç³•ä»¥è‡³äºä¸éœ€è¦è¯„è®ºã€‚</font><font style="vertical-align: inherit;">æˆ‘åœ¨æ¯”èµ›é¡µé¢ä¸Šé—®äº†ä¸€ä¸ªé—®é¢˜ï¼Œä½†æ²¡æœ‰æ”¶åˆ°ç­”å¤ã€‚</font><font style="vertical-align: inherit;">å°½ç®¡è°åˆ¤æ–­ä¸æ˜¯ç§˜å¯†ï¼Œä½†ä»–è®¤ä¸ºæ²¡æœ‰å¿…è¦å†™ä¸ªäººä¿¡æ¯ã€‚</font></font></p><br>
<p>      ,     .      ,      . </p><br>
<h2 id="koncept-raboty-smart-kontraktov-v-ton">  -  TON</h2><br>
<p>  -           .         ,          -  -. </p><br>
<p>    -  <code>FunC</code>  <code>Fift</code>,     <code>Fift-</code>    <code>TON Virtual Machine (TVM)</code>.         .          . </p><br>
<p> ,   <code>TVM</code>   <code>Fift</code>     .                 . </p><br>
<p>     - â€” <code>FunC</code>.       ,   -     -   ,           -    .    .</p><br>
<p>    -  <code>FunC</code>,       <code>Fift-</code>. </p><br>
<p> -  .       <code>Fift</code>,       -    ,        <code>.boc</code> (  "bag of cells"), ,      ,    ,      -. </p><br>
<p>  -,        . </p><br>
<p>      TON  ,     -      ,     . </p><br>
<p>  -  TON  <code>.boc</code>        - (  ).    -   ,     (,   -)   (,  -     TON). </p><br>
<p>,      ,   .   ,         .           -,      <code>Fift</code>  <code>FunC</code>   ,     . </p><br>
<p>        Telegram-,          Telegram   ,    <code>Fift</code>  <code>FunC</code>.    . </p><br>
<p>   . </p><br>
<h2 id="podgotovka-okruzheniya-dlya-raboty-s-ton">     TON</h2><br>
<p>         MacOS     Ubuntu 18.04 LTS  Docker. </p><br>
<p>       <code>lite-client</code>  ,      TON. </p><br>
<p>        .        .               Ubuntu ( MacOS   <code>brew</code>). </p><br>
<pre><code class="plaintext hljs">apt -y install git <font></font>
apt -y install wget <font></font>
apt -y install cmake <font></font>
apt -y install g++ <font></font>
apt -y install zlib1g-dev <font></font>
apt -y install libssl-dev </code></pre><br>
<p>        <code>lite-client</code>, <code>Fift</code>  <code>FunC</code>.</p><br>
<p>   TON   .        <code>~/TON</code>.</p><br>
<pre><code class="plaintext hljs">cd ~/TON<font></font>
git clone https://github.com/ton-blockchain/ton.git<font></font>
cd ./ton<font></font>
git submodule update --init --recursive</code></pre><br>
<p>     <code>Fift</code>  <code>FunC</code>. </p><br>
<p>    .      <code>~/TON/ton</code>.  <code>~/TON</code>   <code>build</code>     . </p><br>
<pre><code class="plaintext hljs">mkdir ~/TON/build <font></font>
cd ~/TON/build<font></font>
cmake ../ton</code></pre><br>
<p>     -     <code>lite-client</code>,   <code>Fift</code>  <code>FunC</code>,   .     . </p><br>
<pre><code class="plaintext hljs">cmake --build . --target lite-client<font></font>
cmake --build . --target fift<font></font>
cmake --build . --target func</code></pre><br>
<p>            <code>lite-client</code>  . </p><br>
<pre><code class="plaintext hljs">wget https://test.ton.org/ton-lite-client-test1.config.json</code></pre><br>
<h2 id="delaem-pervye-zaprosy-v-ton">    TON</h2><br>
<p>  <code>lite-client</code>. </p><br>
<pre><code class="plaintext hljs">cd ~/TON/build<font></font>
./lite-client/lite-client -C ton-lite-client-test1.config.json</code></pre><br>
<p>   ,           . </p><br>
<pre><code class="plaintext hljs">[ 1][t 2][1582054822.963129282][lite-client.h:201][!testnode]   conn ready<font></font>
[ 2][t 2][1582054823.085654020][lite-client.cpp:277][!testnode] server version is 1.1, capabilities 7<font></font>
[ 3][t 2][1582054823.085725069][lite-client.cpp:286][!testnode] server time is 1582054823 (delta 0)<font></font>
...</code></pre><br>
<p>   <code>help</code>     . </p><br>
<pre><code class="plaintext hljs">help</code></pre><br>
<p> ,       . </p><br>
<pre><code class="plaintext hljs">list of available commands:<font></font>
last    Get last block and state info from server<font></font>
sendfile &lt;filename&gt; Load a serialized message from &lt;filename&gt; and send it to server<font></font>
getaccount &lt;addr&gt; [&lt;block-id-ext&gt;]  Loads the most recent state of specified account; &lt;addr&gt; is in [&lt;workchain&gt;:]&lt;hex-or-base64-addr&gt; format<font></font>
runmethod &lt;addr&gt; [&lt;block-id-ext&gt;] &lt;method-id&gt; &lt;params&gt;...   Runs GET method &lt;method-id&gt; of account &lt;addr&gt; with specified parameters</code></pre><br>
<pre><code class="plaintext hljs">last      . <font></font>
<font></font>
sendfile &lt;filename&gt;   TON   ,       -    . <font></font>
<font></font>
getaccount &lt;addr&gt;    -   . <font></font>
<font></font>
runmethod &lt;addr&gt; [&lt;block-id-ext&gt;] &lt;method-id&gt; &lt;params&gt;   get- . </code></pre><br>
<p>      -. </p><br>
<h2 id="realizaciya"></h2><br>
<h3 id="ideya"></h3><br>
<p>   , -     . </p><br>
<p>           ,   ,         - <code>N</code> ,     <code>2 * N</code>   .     40%.      ,     . </p><br>
<p>             ,         .    -,        TON. </p><br>
<h3 id="napisanie-smart-kontrakta"> -</h3><br>
<p>       <code>FunC</code>,        Visual Studio Code,     -,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  </a>.   -       <code>Fift</code>,       VSC. </p><br>
<p>       . </p><br>
<p>       -   ,        .       TON.</p><br>
<p> -        . , <code>recv_external()</code>           ,     TON,           lite-client. , <code>recv_internal()</code>     TON -    .        . </p><br>
<p>    ,      ,       . </p><br>
<pre><code class="plaintext hljs">() recv_internal(slice in_msg) impure {<font></font>
    ;; TODO: implementation <font></font>
}<font></font>
<font></font>
() recv_external(slice in_msg) impure {<font></font>
    ;; TODO: implementation  <font></font>
}</code></pre><br>
<p>     <code>slice</code>.     TON Blockchain   <code>TVM cell</code>   <code>cell</code>,       1023     4    . </p><br>
<p><code>TVM cell slice</code>  <code>slice</code>    <code>cell</code>    ,   .   ,   -    <code>slice</code>          <code>recv_external()</code>  <code>recv_internal()</code>. </p><br>
<p><code>impure</code> â€”  ,    ,     -. </p><br>
<p>    <code>lottery-code.fc</code>  . </p><br>
<pre><code class="plaintext hljs">~/TON/build/crypto/func -APSR -o lottery-compiled.fif ~/TON/ton/crypto/smartcont/stdlib.fc ./lottery-code.fc </code></pre><br>
<p>       </p><br>
<pre><code class="plaintext hljs">~/TON/build/crypto/func -help</code></pre><br>
<p>    Fift-   <code>lottery-compiled.fif</code>. </p><br>
<pre><code class="plaintext hljs">// lottery-compiled.fif<font></font>
<font></font>
"Asm.fif" include<font></font>
// automatically generated from `/Users/rajymbekkapisev/TON/ton/crypto/smartcont/stdlib.fc` `./lottery-code.fc` <font></font>
PROGRAM{<font></font>
  DECLPROC recv_internal<font></font>
  DECLPROC recv_external<font></font>
  recv_internal PROC:&lt;{<font></font>
    //  in_msg<font></font>
    DROP    // <font></font>
  }&gt;<font></font>
  recv_external PROC:&lt;{<font></font>
    //  in_msg<font></font>
    DROP    // <font></font>
  }&gt;<font></font>
}END&gt;c</code></pre><br>
<p>   ,    . </p><br>
<p>,    <code>Asm.fif</code>,     Fift  Fift-. </p><br>
<p>       -    <code>lottery-test-suite.fif</code>          ,    -   <code>code</code>,       : </p><br>
<pre><code class="plaintext hljs">"TonUtil.fif" include<font></font>
"Asm.fif" include<font></font>
<font></font>
PROGRAM{<font></font>
  DECLPROC recv_internal<font></font>
  DECLPROC recv_external<font></font>
  recv_internal PROC:&lt;{<font></font>
    //  in_msg<font></font>
    DROP    // <font></font>
  }&gt;<font></font>
  recv_external PROC:&lt;{<font></font>
    //  in_msg<font></font>
    DROP    // <font></font>
  }&gt;<font></font>
}END&gt;s constant code</code></pre><br>
<p>  ,       ,       TVM. </p><br>
<pre><code class="plaintext hljs">0 tuple 0x076ef1ea , // magic<font></font>
0 , 0 , // actions msg_sents<font></font>
1570998536 , // unix_time<font></font>
1 , 1 , 3 , // block_lt, trans_lt, rand_seed<font></font>
0 tuple 100000000000000 , dictnew , , // remaining balance<font></font>
0 , dictnew , // contract_address, global_config<font></font>
1 tuple // wrap to another tuple<font></font>
constant c7<font></font>
<font></font>
0 constant recv_internal // to run recv_internal() <font></font>
-1 constant recv_external // to invoke recv_external()</code></pre><br>
<p> <code>c7</code>   ,        TVM (  ).           <code>c7</code>   .         <code>rand_seed</code>           ,        . </p><br>
<p><code>recv_internal</code>  <code>recv_external</code>    0  -1        -. </p><br>
<p>         -.             <code>lottery-test-suite.fif</code>. </p><br>
<p>  <code>storage</code>      <code>cell</code>,    -. </p><br>
<p><code>message</code>  ,    - .     . </p><br>
<pre><code class="plaintext hljs">variable storage <font></font>
&lt;b b&gt; storage ! <font></font>
<font></font>
variable message <font></font>
&lt;b b&gt; message ! </code></pre><br>
<p>          TVM    <code>runvmctx</code>      . </p><br>
<pre><code class="plaintext hljs">message @ <font></font>
recv_external <font></font>
code <font></font>
storage @ <font></font>
c7 <font></font>
runvmctx </code></pre><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>    <code>Fift</code>. </p><br>
<p>     . </p><br>
<pre><code class="plaintext hljs">export FIFTPATH=~/TON/ton/crypto/fift/lib //      <font></font>
~/TON/build/crypto/fift -s lottery-test-suite.fif </code></pre><br>
<p>          . </p><br>
<pre><code class="plaintext hljs">execute SETCP 0<font></font>
execute DICTPUSHCONST 19 (xC_,1)<font></font>
execute DICTIGETJMPZ<font></font>
execute DROP<font></font>
execute implicit RET<font></font>
[ 3][t 0][1582281699.325381279][vm.cpp:479]     steps: 5 gas: used=304, max=9223372036854775807, limit=9223372036854775807, credit=0</code></pre><br>
<p>,      -   . </p><br>
<h3 id="obrabotka-vneshnih-soobscheniy-k-smart-kontraktu">    -</h3><br>
<p>   .   ,       <code>recv_external()</code>. </p><br>
<p>        .  , </p><br>
<ul>
<li>-,               -. </li>
<li>-     ,    -              . </li>
</ul><br>
<p>        ,        ,      .     ,  ,   . </p><br>
<p>       .    .  -        0.    -         .           -,     .  ,       -  1. </p><br>
<p>  <code>lottery-test-suite.fif</code>      .   ,    . ,      166,    165. </p><br>
<pre><code class="plaintext hljs">&lt;b 166 32 u, b&gt; storage !<font></font>
&lt;b 165 32 u, b&gt; message !<font></font>
<font></font>
message @ <font></font>
recv_external <font></font>
code <font></font>
storage @ <font></font>
c7 <font></font>
runvmctx<font></font>
<font></font>
drop <font></font>
exit_code ! <font></font>
."Exit code " exit_code @ . cr <font></font>
exit_code @ 33 - abort"Test #2 Not passed"</code></pre><br>
<p>. </p><br>
<pre><code class="plaintext hljs"> ~/TON/build/crypto/fift -s lottery-test-suite.fif </code></pre><br>
<p>      . </p><br>
<pre><code class="plaintext hljs">[ 1][t 0][1582283084.210902214][words.cpp:3046] lottery-test-suite.fif:67: abort": Test #2 Not passed<font></font>
[ 1][t 0][1582283084.210941076][fift-main.cpp:196]      Error interpreting file `lottery-test-suite.fif`: error interpreting included file `lottery-test-suite.fif` : lottery-test-suite.fif:67: abort": Test #2 Not passed</code></pre><br>
<p>   <code>lottery-test-suite.fif</code>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>. </p><br>
<p>      -  <code>lottery-code.fc</code>. </p><br>
<pre><code class="plaintext hljs">() recv_internal(slice in_msg) impure {<font></font>
    ;; TODO: implementation <font></font>
}<font></font>
<font></font>
() recv_external(slice in_msg) impure {<font></font>
    if (slice_empty?(in_msg)) {<font></font>
        return (); <font></font>
    }<font></font>
    int msg_seqno = in_msg~load_uint(32);<font></font>
    var ds = begin_parse(get_data());<font></font>
    int stored_seqno = ds~load_uint(32);<font></font>
    throw_unless(33, msg_seqno == stored_seqno);<font></font>
}</code></pre><br>
<p> <code>slice in_msg</code>  ,   . </p><br>
<p>      ,  ,   . </p><br>
<p>   . <code>in_msg~load_uint(32)</code>  32-  <code>unsigned int</code>  165   . </p><br>
<p>   32    -. ,      ,    .   ,     ,   . </p><br>
<p> . </p><br>
<pre><code class="plaintext hljs">~/TON/build/crypto/func -APSR -o lottery-compiled.fif ~/TON/ton/crypto/smartcont/stdlib.fc ./lottery-code.fc </code></pre><br>
<p>    <code>lottery-test-suite.fif</code>,     . ,   . </p><br>
<pre><code class="plaintext hljs">~/TON/build/crypto/fift -s lottery-test-suite.fif</code></pre><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>       . </p><br>
<p>,      -     .   ,        ,            <code>"include"</code>. </p><br>
<p>      <code>build.sh</code>   . </p><br>
<pre><code class="plaintext hljs">#!/bin/bash<font></font>
<font></font>
~/TON/build/crypto/func -SPA -R -o lottery-compiled.fif ~/TON/ton/crypto/smartcont/stdlib.fc ./lottery-code.fc</code></pre><br>
<p>  . </p><br>
<pre><code class="plaintext hljs">chmod +x ./build.sh</code></pre><br>
<p>,    ,     lottery-compiled.fif.          <code>code</code>. </p><br>
<p>  sh  ,        <code>lottery-compiled-for-test.fif</code>      .      <code>lottery-test-suite.fif</code>. </p><br>
<pre><code class="plaintext hljs"># copy and change for test <font></font>
cp lottery-compiled.fif lottery-compiled-for-test.fif<font></font>
sed '$d' lottery-compiled-for-test.fif &gt; test.fif<font></font>
rm lottery-compiled-for-test.fif<font></font>
mv test.fif lottery-compiled-for-test.fif<font></font>
echo -n "}END&gt;s constant code" &gt;&gt; lottery-compiled-for-test.fif</code></pre><br>
<p>  ,         <code>lottery-compiled-for-test.fif</code>,      <code>lottery-test-suite.fif</code>. </p><br>
<p> <code>lottery-test-suite.fif</code>       <code>"lottery-compiled-for-test.fif" include</code>. </p><br>
<p> ,  ,   . </p><br>
<pre><code class="plaintext hljs">~/TON/build/crypto/fift -s lottery-test-suite.fif</code></pre><br>
<p>, ,       <code>test.sh</code>,     <code>build.sh</code>,    . </p><br>
<pre><code class="plaintext hljs">touch test.sh<font></font>
chmod +x test.sh</code></pre><br>
<p>  <code>test.sh</code>.</p><br>
<pre><code class="plaintext hljs">./build.sh <font></font>
<font></font>
echo "\nCompilation completed\n"<font></font>
<font></font>
export FIFTPATH=~/TON/ton/crypto/fift/lib<font></font>
~/TON/build/crypto/fift -s lottery-test-suite.fif</code></pre><br>
<p>,      . </p><br>
<pre><code class="plaintext hljs">./test.sh</code></pre><br>
<p>,    <code>test.sh</code>       .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a>. </p><br>
<p>,           . </p><br>
<p>  <code>build</code>            <code>lottery-compiled.fif</code>, <code>lottery-compiled-for-test.fif</code>.    <code>test</code>       <code>lottery-test-suite.fif</code>     . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">   </a>.</p><br>
<p>  -. </p><br>
<p>   ,  ,        ,     .     . </p><br>
<p>             -.     . </p><br>
<pre><code class="plaintext hljs">`seqno` 32-     . <font></font>
<font></font>
`pubkey` 256-      ,   ,       ,   . <font></font>
<font></font>
`order_seqno` 32-        . <font></font>
<font></font>
`number_of_wins` 32-        . <font></font>
<font></font>
`incoming_amount`   Gram ( 4    ),    ,     . <font></font>
<font></font>
`outgoing_amount`   ,    . <font></font>
<font></font>
`owner_wc`  , 32-  (   ,  8- )  .      -1  0. <font></font>
<font></font>
`owner_account_id` 256-    ,     . <font></font>
<font></font>
`orders`   ,    . </code></pre><br>
<p>    .   <code>pack_state()</code>,           -. ,  <code>unpack_state()</code>       . </p><br>
<pre><code class="plaintext hljs">_ pack_state(int seqno, int pubkey, int order_seqno, int number_of_wins, int incoming_amount, int outgoing_amount, int owner_wc, int owner_account_id, cell orders) inline_ref {<font></font>
    return begin_cell()<font></font>
            .store_uint(seqno, 32)<font></font>
            .store_uint(pubkey, 256)<font></font>
            .store_uint(order_seqno, 32)<font></font>
            .store_uint(number_of_wins, 32)<font></font>
            .store_grams(incoming_amount)<font></font>
            .store_grams(outgoing_amount)<font></font>
            .store_int(owner_wc, 32)<font></font>
            .store_uint(owner_account_id, 256)<font></font>
            .store_dict(orders)<font></font>
            .end_cell();<font></font>
}<font></font>
<font></font>
_ unpack_state() inline_ref {<font></font>
    var ds = begin_parse(get_data());<font></font>
    var unpacked = (ds~load_uint(32), ds~load_uint(256), ds~load_uint(32), ds~load_uint(32), ds~load_grams(), ds~load_grams(), ds~load_int(32), ds~load_uint(256), ds~load_dict());<font></font>
    ds.end_parse();<font></font>
    return unpacked;<font></font>
}</code></pre><br>
<p>     -.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>  .</p><br>
<p>        <code>set_data()</code>      <code>pack_state()</code>   -. </p><br>
<pre><code class="plaintext hljs">cell packed_state = pack_state(arg_1, .., arg_n); <font></font>
set_data(packed_state);</code></pre><br>
<p>              . </p><br>
<p>  ,        (   ,      ). </p><br>
<p>   -          .     ,    ,         . </p><br>
<p>      /      <code>test/keys/owner.pk</code>.    Fift       .</p><br>
<pre><code class="plaintext hljs">`newkeypair`          . <font></font>
<font></font>
`drop`      (    )  <font></font>
<font></font>
`.s`          <font></font>
<font></font>
`"owner.pk" B&gt;file`        `owner.pk`. <font></font>
<font></font>
`bye`    Fift. </code></pre><br>
<p>  <code>keys</code>   <code>test</code>     . </p><br>
<pre><code class="plaintext hljs">mkdir test/keys<font></font>
cd test/keys<font></font>
~/TON/build/crypto/fift -i <font></font>
newkeypair<font></font>
 ok<font></font>
.s <font></font>
BYTES:128DB222CEB6CF5722021C3F21D4DF391CE6D5F70C874097E28D06FCE9FD6917 BYTES:DD0A81AAF5C07AAAA0C7772BB274E494E93BB0123AA1B29ECE7D42AE45184128 <font></font>
drop <font></font>
 ok<font></font>
"owner.pk" B&gt;file<font></font>
 ok<font></font>
bye</code></pre><br>
<p>     <code>owner.pk</code>. ,       ,       . </p><br>
<p>     .   .           <code>file&gt;B</code>      <code>owner_private_key</code>.     <code>priv&gt;pub</code>          <code>owner_public_key</code>. </p><br>
<pre><code class="plaintext hljs">variable owner_private_key<font></font>
variable owner_public_key <font></font>
<font></font>
"./keys/owner.pk" file&gt;B owner_private_key !<font></font>
owner_private_key @ priv&gt;pub owner_public_key !</code></pre><br>
<p>   . </p><br>
<p>  -.         ,    <code>pack_state()</code>    <code>storage</code>. </p><br>
<pre><code class="plaintext hljs">variable owner_private_key<font></font>
variable owner_public_key <font></font>
variable orders<font></font>
variable owner_wc<font></font>
variable owner_account_id<font></font>
<font></font>
"./keys/owner.pk" file&gt;B owner_private_key !<font></font>
owner_private_key @ priv&gt;pub owner_public_key !<font></font>
dictnew orders !<font></font>
0 owner_wc !<font></font>
0 owner_account_id !<font></font>
<font></font>
&lt;b 0 32 u, owner_public_key @ B, 0 32 u, 0 32 u, 0 Gram, 0 Gram, owner_wc @ 32 i, owner_account_id @ 256 u,  orders @ dict, b&gt; storage !</code></pre><br>
<p>   ,        . </p><br>
<p>  ,   ,          . </p><br>
<pre><code class="plaintext hljs">variable message_to_sign<font></font>
variable message_to_send<font></font>
variable signature<font></font>
&lt;b 0 32 u, b&gt; message_to_sign !<font></font>
message_to_sign @ hashu owner_private_key @ ed25519_sign_uint signature !<font></font>
&lt;b signature @ B, 0 32 u, b&gt; &lt;s  message_to_send !  </code></pre><br>
<p> , ,     -    <code>message_to_send</code>,   <code>hashu</code>, <code>ed25519_sign_uint</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">   Fift</a>. </p><br>
<p>     . </p><br>
<pre><code class="plaintext hljs">message_to_send @ <font></font>
recv_external <font></font>
code <font></font>
storage @<font></font>
c7<font></font>
runvmctx</code></pre><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>        . </p><br>
<p>    ,   -,          .</p><br>
<p>    512      ,   32   . </p><br>
<p>          -   . </p><br>
<p>        .  -  ,      . </p><br>
<pre><code class="plaintext hljs">var signature = in_msg~load_bits(512);<font></font>
var message = in_msg;<font></font>
int msg_seqno = message~load_uint(32);<font></font>
(int stored_seqno, int pubkey, int order_seqno, int number_of_wins, int incoming_amount, int outgoing_amount, int owner_wc, int owner_account_id, cell orders) = unpack_state();<font></font>
throw_unless(33, msg_seqno == stored_seqno);<font></font>
throw_unless(34, check_signature(slice_hash(in_msg), signature, pubkey));</code></pre><br>
<p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>. </p><br>
<p>   ,    .   ,         ,     .    ,         . </p><br>
<p>         -. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>       . </p><br>
<p>  ,         .          <code>not-owner.pk</code>.     .    ,    . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a>   . </p><br>
<p>        -.  <code>recv_external()</code>      . </p><br>
<p>       ,      .          .             . </p><br>
<p>  .   ,   ,     -     .  ,            <code>action</code> 7-    ,    ,      . </p><br>
<pre><code class="plaintext hljs">&lt;b 0 32 u, 1 @ 7 u, new_owner_wc @  32 i, new_owner_account_id @ 256 u, b&gt; message_to_sign !</code></pre><br>
<p>         <code>storage</code>  Fift.       Fift. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  </a>   .    ,   . </p><br>
<p>       .  -    <code>message</code>,   <code>action</code>. ,      <code>action</code>:     .          .</p><br>
<p>   ,    .  - ,      7   ,     .     <code>action</code>.    ,   . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a>   . . </p><br>
<p>          .   .         ,      .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  </a>. </p><br>
<p>  .     .          -. </p><br>
<pre><code class="plaintext hljs">int balance() inline_ref method_id {<font></font>
    return get_balance().pair_first();<font></font>
}</code></pre><br>
<p>       -.        -. </p><br>
<pre><code class="plaintext hljs">() send_grams(int wc, int addr, int grams) impure {<font></font>
    ;; int_msg_info$0 ihr_disabled:Bool bounce:Bool bounced:Bool src:MsgAddress -&gt; 011000<font></font>
    cell msg = begin_cell()<font></font>
    ;;  .store_uint(0, 1) ;; 0 &lt;= format indicator int_msg_info$0 <font></font>
    ;;  .store_uint(1, 1) ;; 1 &lt;= ihr disabled<font></font>
    ;;  .store_uint(1, 1) ;; 1 &lt;= bounce = true<font></font>
    ;;  .store_uint(0, 1) ;; 0 &lt;= bounced = false<font></font>
    ;;  .store_uint(4, 5)  ;; 00100 &lt;= address flags, anycast = false, 8-bit workchain<font></font>
        .store_uint (196, 9)<font></font>
        .store_int(wc, 8)<font></font>
        .store_uint(addr, 256)<font></font>
        .store_grams(grams)<font></font>
        .store_uint(0, 107) ;; 106 zeroes +  0 as an indicator that there is no cell with the data.<font></font>
        .end_cell(); <font></font>
    send_raw_message(msg, 3); ;; mode, 2 for ignoring errors, 1 for sender pays fees, 64 for returning inbound message value<font></font>
}</code></pre><br>
<p>     -   .      .   ,     .   ,         . </p><br>
<pre><code class="plaintext hljs">int amount_to_send = message~load_grams();<font></font>
throw_if(36, amount_to_send + 500000000 &gt; balance());<font></font>
accept_message();<font></font>
send_grams(owner_wc, owner_account_id, amount_to_send);<font></font>
set_data(pack_state(stored_seqno + 1, pubkey, order_seqno, number_of_wins, incoming_amount, outgoing_amount, owner_wc, owner_account_id, orders));</code></pre><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>  -   .    ,   . </p><br>
<p>,     -    .  -  ,      <code>accept_message()</code>. </p><br>
<h3 id="obrabotka-vnutrennih-soobscheniy-s-smart-kontraktu">    -</h3><br>
<p>   .                    . </p><br>
<p>   .       -        -. </p><br>
<p>     , 32-      workchain  256-        workchain. , -1  12345,      . </p><br>
<p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><code>TonUtil.fif</code></a>. </p><br>
<pre><code class="plaintext hljs">// ( wc addr fname -- )  Save address to file in 36-byte format<font></font>
{ -rot 256 u&gt;B swap 32 i&gt;B B+ swap B&gt;file } : save-address</code></pre><br>
<p> ,   ,      Fift.  Fift   . </p><br>
<pre><code class="plaintext hljs">~/TON/build/crypto/fift -i </code></pre><br>
<p>     -1, 12345     "sender.addr":</p><br>
<pre><code class="plaintext hljs">-1 12345 "sender.addr" </code></pre><br>
<p>    <code>-rot</code>,   ,  ,       -: </p><br>
<pre><code class="plaintext hljs">"sender.addr" -1 12345</code></pre><br>
<p><code>256 u&gt;B</code>  256-     . </p><br>
<pre><code class="plaintext hljs">"sender.addr" -1 BYTES:0000000000000000000000000000000000000000000000000000000000003039</code></pre><br>
<p><code>swap</code>      . </p><br>
<pre><code class="plaintext hljs">"sender.addr" BYTES:0000000000000000000000000000000000000000000000000000000000003039 -1</code></pre><br>
<p><code>32 i&gt;B</code>  32-    . </p><br>
<pre><code class="plaintext hljs">"sender.addr" BYTES:0000000000000000000000000000000000000000000000000000000000003039 BYTES:FFFFFFFF</code></pre><br>
<p><code>B+</code>       .</p><br>
<pre><code class="plaintext hljs"> "sender.addr" BYTES:0000000000000000000000000000000000000000000000000000000000003039FFFFFFFF</code></pre><br>
<p> <code>swap</code>. </p><br>
<pre><code class="plaintext hljs">BYTES:0000000000000000000000000000000000000000000000000000000000003039FFFFFFFF "sender.addr" </code></pre><br>
<p>   <code>B&gt;file</code>     ,    ,      .     .  <code>Fift</code>.      <code>sender.addr</code>.      <code>test/addresses/</code>. </p><br>
<p>  ,      -. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>. </p><br>
<p>     . </p><br>
<p>,   ,   <code>bounced</code>  ,  <code>bounced</code>,  . <code>bounced</code> ,       - .     ,    . </p><br>
<p>,   ,    ,         . </p><br>
<p>,   -    . </p><br>
<p>              .        <code>pack_order()</code>, <code>unpack_order()</code>, <code>remove_old_orders()</code>. </p><br>
<p>        ,  ,    ,       <code>orders</code>. </p><br>
<p>   -. </p><br>
<p>             3   1/3  -. </p><br>
<p>   ,                . </p><br>
<pre><code class="plaintext hljs">() recv_internal(int order_amount, cell in_msg_cell, slice in_msg) impure {<font></font>
    var cs = in_msg_cell.begin_parse();<font></font>
    int flags = cs~load_uint(4);  ;; int_msg_info$0 ihr_disabled:Bool bounce:Bool bounced:Bool<font></font>
    if (flags &amp; 1) { ;; ignore bounced<font></font>
        return ();<font></font>
    }<font></font>
    if (order_amount &lt; 500000000) { ;; just receive grams without changing state <font></font>
        return ();<font></font>
    }<font></font>
    slice src_addr_slice = cs~load_msg_addr();<font></font>
    (int src_wc, int src_addr) = parse_std_addr(src_addr_slice);<font></font>
    (int stored_seqno, int pubkey, int order_seqno, int number_of_wins, int incoming_amount, int outgoing_amount, int owner_wc, int owner_account_id, cell orders) = unpack_state();<font></font>
    orders = remove_old_orders(orders, order_seqno);<font></font>
    if (balance() &lt; 2 * order_amount + 500000000) { ;; not enough grams to pay the bet back, so this is re-fill<font></font>
        builder order = pack_order(order_seqno, 1, now(), order_amount, src_wc, src_addr);<font></font>
        orders~udict_set_builder(32, order_seqno, order);<font></font>
        set_data(pack_state(stored_seqno, pubkey, order_seqno + 1, number_of_wins, incoming_amount + order_amount, outgoing_amount, owner_wc, owner_account_id, orders));<font></font>
        return ();<font></font>
    }<font></font>
    if (rand(10) &gt;= 4) {<font></font>
        builder order = pack_order(order_seqno, 3, now(), order_amount, src_wc, src_addr);<font></font>
        orders~udict_set_builder(32, order_seqno, order);<font></font>
        set_data(pack_state(stored_seqno, pubkey, order_seqno + 1, number_of_wins, incoming_amount + order_amount, outgoing_amount, owner_wc, owner_account_id, orders));<font></font>
        if (order_amount &gt; 3000000000) {<font></font>
            send_grams(owner_wc, owner_account_id, order_amount / 3);<font></font>
        }<font></font>
        return ();<font></font>
    }<font></font>
    send_grams(src_wc, src_addr, 2 * order_amount);<font></font>
    builder order = pack_order(order_seqno, 2, now(), order_amount, src_wc, src_addr);<font></font>
    orders~udict_set_builder(32, order_seqno, order);<font></font>
    set_data(pack_state(stored_seqno, pubkey, order_seqno + 1, number_of_wins + 1, incoming_amount, outgoing_amount + 2 * order_amount, owner_wc, owner_account_id, orders));<font></font>
}</code></pre><br>
<p>  . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>. </p><br>
<h3 id="napisanie-get-metodov"> -</h3><br>
<p> -,            (      ). </p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> -</a>.       -  . </p><br>
<p>    ,      ,     -. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a>    1/3    .</p><br>
<h3 id="publikaciya-smart-kontratka-v-ton"> -  TON</h3><br>
<p>  -.   <code>requests</code>. </p><br>
<p>       , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>       . </p><br>
<p>      .    -    .     -,         TON.        .       -      -,            .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a>. </p><br>
<p>       <code>lottery-query.boc</code>    . </p><br>
<pre><code class="plaintext hljs">~/TON/build/crypto/fift -s requests/new-lottery.fif 0</code></pre><br>
<p>    : <code>lottery.addr</code>, <code>lottery.pk</code>. </p><br>
<p>       -. </p><br>
<pre><code class="plaintext hljs">new wallet address = 0:044910149dbeaf8eadbb2b28722e7d6a2dc6e264ec2f1d9bebd6fb209079bc2a <font></font>
(Saving address to file lottery.addr)<font></font>
Non-bounceable address (for init): 0QAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8Ksyd<font></font>
Bounceable address (for later access): kQAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8KpFY</code></pre><br>
<p>     TON. </p><br>
<pre><code class="plaintext hljs">$ ./lite-client/lite-client -C ton-lite-client-test1.config.json <font></font>
getaccount 0QAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8Ksyd</code></pre><br>
<p> ,      . </p><br>
<pre><code class="plaintext hljs">account state is empty</code></pre><br>
<p>   <code>0QAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8Ksyd</code> 2        .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>,       -  ,       . </p><br>
<pre><code class="plaintext hljs">&gt; last<font></font>
&gt; getaccount 0QAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8Ksyd</code></pre><br>
<p>,  -       (<code>state:account_uninit</code>)   2 000 000 000 . </p><br>
<pre><code class="plaintext hljs">account state is (account<font></font>
  addr:(addr_std<font></font>
    anycast:nothing workchain_id:0 address:x044910149DBEAF8EADBB2B28722E7D6A2DC6E264EC2F1D9BEBD6FB209079BC2A)<font></font>
  storage_stat:(storage_info<font></font>
    used:(storage_used<font></font>
      cells:(var_uint len:1 value:1)<font></font>
      bits:(var_uint len:1 value:103)<font></font>
      public_cells:(var_uint len:0 value:0)) last_paid:1583257959<font></font>
    due_payment:nothing)<font></font>
  storage:(account_storage last_trans_lt:3825478000002<font></font>
    balance:(currencies<font></font>
      grams:(nanograms<font></font>
        amount:(var_uint len:4 value:2000000000))<font></font>
      other:(extra_currencies<font></font>
        dict:hme_empty))<font></font>
    state:account_uninit))<font></font>
x{C00044910149DBEAF8EADBB2B28722E7D6A2DC6E264EC2F1D9BEBD6FB209079BC2A20259C2F2F4CB3800000DEAC10776091DCD650004_}<font></font>
last transaction lt = 3825478000001 hash = B043616AE016682699477FFF01E6E903878CDFD6846042BA1BFC64775E7AC6C4<font></font>
account balance is 2000000000ng</code></pre><br>
<p>  -.  lite-client  . </p><br>
<pre><code class="plaintext hljs">&gt; sendfile lottery-query.boc<font></font>
[ 1][t 2][1583008371.631410122][lite-client.cpp:966][!testnode] sending query from file lottery-query.boc<font></font>
[ 3][t 1][1583008371.828550100][lite-client.cpp:976][!query]    external message status is 1 </code></pre><br>
<p>,   . </p><br>
<pre><code class="plaintext hljs">&gt; last<font></font>
&gt; getaccount 0QAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8Ksyd</code></pre><br>
<p>  . </p><br>
<pre><code class="plaintext hljs">  storage:(account_storage last_trans_lt:3825499000002<font></font>
    balance:(currencies<font></font>
      grams:(nanograms<font></font>
        amount:(var_uint len:4 value:1987150999))<font></font>
      other:(extra_currencies<font></font>
        dict:hme_empty))<font></font>
    state:(account_active</code></pre><br>
<p>,  <code>account_active</code>. </p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>. </p><br>
<h3 id="otpravka-vneshnih-soobscheniy">  </h3><br>
<p>      -. </p><br>
<p>          ,         .        ,      6. </p><br>
<p>       ,  <code>msg_seqno</code> 165, <code>action</code> 2  9.5   . </p><br>
<pre><code class="plaintext hljs">&lt;b 165 32 u, 2 7 u, 9500000000 Gram, b&gt;</code></pre><br>
<p>      <code>lottery.pk</code>,      -. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  </a>. </p><br>
<h3 id="poluchaem-informaciyu-iz-smart-kontrakta-s-pomoschyu-get-metodov">   -   -</h3><br>
<p>    - -. </p><br>
<p> <code>lite-client</code>   <code>runmethod</code>   -   -. </p><br>
<pre><code class="plaintext hljs">$ ./lite-client/lite-client -C ton-lite-client-test1.config.json<font></font>
&gt; runmethod 0QAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8Ksyd balance<font></font>
arguments:  [ 104128 ] <font></font>
result:  [ 64633878952 ] <font></font>
...</code></pre><br>
<p> <code>result</code>  ,    <code>balance()</code>   -.<br>
      . </p><br>
<pre><code class="plaintext hljs">&gt; runmethod 0QAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8Ksyd get_seqno<font></font>
...<font></font>
arguments:  [ 77871 ] <font></font>
result:  [ 1 ] </code></pre><br>
<p>  . </p><br>
<pre><code class="plaintext hljs">&gt; runmethod 0QAESRAUnb6vjq27KyhyLn1qLcbiZOwvHZvr1vsgkHm8Ksyd get_orders<font></font>
...<font></font>
arguments:  [ 67442 ] <font></font>
result:  [ ([0 1 1583258284 10000000000 0 74649920601963823558742197308127565167945016780694342660493511643532213172308] [1 3 1583258347 4000000000 0 74649920601963823558742197308127565167945016780694342660493511643532213172308] [2 1 1583259901 50000000000 0 74649920601963823558742197308127565167945016780694342660493511643532213172308]) ] </code></pre><br>
<p>   <code>lite-client</code>  -     -  . </p><br>
<h3 id="pokazyvaem-dannye-smart-kontrakta-na-sayte">  -  </h3><br>
<p>   -  Python       -   .            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>. </p><br>
<p>  TON   <code>Python</code>   <code>lite-client</code>.      Docker    Google Cloud. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  </a>.</p><br>
<h3 id="delaem-stavki"> </h3><br>
<p>    64 a    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"></a>.      . ,     ,       . </p><br>
<h2 id="posleslovie"></h2><br>
<p>      .     ,      ,      TON         -     . </p><br>
<p> -     .        , ,      -,     ,         . </p><br>
<p>    -   -   ,           TON   . </p><br>
<p> ,     TON        ,   -      (     ,  ). </p><br>
<p>  TON   .    -             .    . </p><br>
<p>  Libra  Facebook,          TON.  Libra     ,           TON.     TON     ,   . </p><br>
<h2 id="ssylki"></h2><br>
<ol>
<li> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://test.ton.org</a></li>
<li>  TON: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://github.com/ton-blockchain/ton</a> </li>
<li>    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://wallet.ton.org</a> </li>
<li> -   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://github.com/raiym/astonished</a> </li>
<li>   -: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://ton-lottery.appspot.com</a> </li>
<li>    Visual Studio Code  FunC: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://github.com/raiym/func-visual-studio-plugin</a> </li>
<li>  ON  Telegram,       .   ,  ,       -  TON.      . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">https://t.me/tondev_ru</a> </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…³äºTONçš„å¦ä¸€ä¸ªèŠå¤©ï¼Œåœ¨å…¶ä¸­æˆ‘æ‰¾åˆ°äº†æœ‰ç”¨çš„ä¿¡æ¯ï¼š</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">https</font></a><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//t.me/TONgramDev</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¯”èµ›çš„ç¬¬ä¸€é˜¶æ®µï¼š</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">https</font></a><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//contest.com/blockchain</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¯”èµ›ç¬¬äºŒé˜¶æ®µï¼š</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">https</font></a><font style="vertical-align: inherit;">ï¼š</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//contest.com/blockchain-2</font></font></a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN490762/index.html">å¦‚ä½•é¢„æµ‹æœºç¥¨ä»·æ ¼ï¼Ÿ</a></li>
<li><a href="../zh-CN490764/index.html">Grafanaï¼ŒInfluxDBï¼Œä¸¤ä¸ªæ ‡ç­¾å’Œä¸€ä¸ªé‡ã€‚æˆ–å¦‚ä½•è®¡ç®—å­ç»„çš„æ€»å’Œï¼Ÿ</a></li>
<li><a href="../zh-CN490766/index.html">å¦‚ä½•ç†è§£åˆå­¦è€…ï¼Œä¸ºæœŸæœ›çš„èŒä¸šé€‰æ‹©å“ªç§è¯­è¨€ï¼Ÿ</a></li>
<li><a href="../zh-CN490768/index.html">å½“æ‚¨ä»äº‹è®¡ç®—æœºæ¸¸æˆæ—¶ï¼šäº‘æ¸¸æˆçš„å†…éƒ¨è®¾å¤‡</a></li>
<li><a href="../zh-CN490770/index.html">è´Ÿæœ‰æŠ€æœ¯å€ºåŠ¡ï¼åœ¨2020å¹´TechLeadå¤§ä¼šä¸Šï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤º</a></li>
<li><a href="../zh-CN490774/index.html">ååº”çµæ•</a></li>
<li><a href="../zh-CN490778/index.html">å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ‰¾åˆ°äº†è§£ç¨‹åºå‘˜å·¥ä½œçš„äºº</a></li>
<li><a href="../zh-CN490780/index.html">è‹±ç‰¹å°”Â®è‡³å¼ºÂ®å¯æ‰©å±•ç¬¬äºŒä»£ï¼šå†…æ ¸é”€å”®é‡å¤§</a></li>
<li><a href="../zh-CN490782/index.html">AnalogBytesä¼šè®®ï¼šRoskomnadzorï¼Œåª’ä½“ï¼Œé«˜è´Ÿè½½å’Œæ‰€æœ‰æ‰€æœ‰</a></li>
<li><a href="../zh-CN490784/index.html">æˆ‘æ˜¯ä¸€åAndroidå¼€å‘äººå‘˜ï¼Œæˆ‘ä¸å–œæ¬¢åšæ‰‹å·¥å·¥ä½œã€‚</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>