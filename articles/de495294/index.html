<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧗🏼 👩🏻‍🤝‍👨🏼 🤷🏾 Makros für einen Pythonisten. Yandex-Bericht 🔶 🛌🏻 🔡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wie kann ich die Python-Syntax erweitern und die erforderlichen Funktionen hinzufügen? Letzten Sommer habe ich bei PyCon versucht, dieses Thema zu ver...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Makros für einen Pythonisten. Yandex-Bericht</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/495294/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie kann ich die Python-Syntax erweitern und die erforderlichen Funktionen hinzufügen? </font><font style="vertical-align: inherit;">Letzten Sommer habe ich bei PyCon versucht, dieses Thema zu verstehen. </font><font style="vertical-align: inherit;">Aus dem Bericht können Sie herausfinden, wie die Pytest-, Makropie- und Musterbibliotheken angeordnet sind und wie sie so interessante Ergebnisse erzielen. </font><font style="vertical-align: inherit;">Am Ende finden Sie ein Beispiel für die Codegenerierung mithilfe von Makros in HyLang, einer Lisp-ähnlichen Sprache, die auf Python ausgeführt wird.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/IMkvg45Vw70" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Hallo Leute. </font><font style="vertical-align: inherit;">Zunächst möchte ich mich bei den Organisatoren von PyCon bedanken. </font><font style="vertical-align: inherit;">Ich bin Entwickler bei Yandex. </font><font style="vertical-align: inherit;">In dem Bericht geht es überhaupt nicht um Arbeit, sondern um experimentelle Dinge. </font><font style="vertical-align: inherit;">Vielleicht führen sie einen von Ihnen auf die Idee, dass Sie in Python coole Dinge tun können, von denen Sie vorher noch nicht einmal wussten und die nicht in diese Richtung gedacht haben.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein wenig für diejenigen, die nicht wissen, was Makros sind: Dies ist eine solche Methode zur Codegenerierung, wenn ein Ausdruck in der Sprache zu komplexerem Code erweitert wird. </font><font style="vertical-align: inherit;">Was sind die Leckereien für Sie? </font><font style="vertical-align: inherit;">Für Sie ist der Makrodatensatz prägnant, er drückt eine gewisse Abstraktion aus, aber er erledigt viel Arbeit unter der Haube für Sie, und Sie müssen den gesamten Code nicht mit Ihren Händen schreiben.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pytest</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Höchstwahrscheinlich sind Sie auf ein Pytest-Test-Framework gestoßen, das von vielen hier mit ziemlicher Sicherheit verwendet wird. Ich weiß nicht, ob du es jemals bemerkt hast, aber unter der Haube zaubert er auch. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/al/o6/qv/alo6qvpzofmabtejvqqojenx31a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Beispiel haben Sie einen so einfachen Test. Wenn Sie es ohne Pytest ausführen, wird einfach ein AssertionError ausgelöst. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ih/an/ck/ihanckzzqzelb5o87nfx9olt2vw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider ist mein Beispiel etwas entartet, und hier ist sofort ersichtlich, dass len aus einer Liste von drei Elementen stammt. Wenn jedoch eine Funktion aufgerufen worden wäre, hätten Sie von einem solchen AssertionError niemals gewusst, dass die Funktion zurückgegeben wurde. Sie gab nur etwas zurück, das nicht gleich hundert ist. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/ko/sa/cukosarqifegg5uvzo14xneczkc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn dies jedoch unter pytest ausgeführt wird, werden zusätzliche Debugging-Informationen angezeigt. Wie macht er das drinnen?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6h/g9/vr/6hg9vr5nedvvkvzxlsupjqor71a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Magie funktioniert sehr einfach. Pytest erstellt einen eigenen speziellen Haken, der ausgelöst wird, wenn das Modul mit dem Test geladen wird. Danach analysiert pytest diese Python-Datei unabhängig und als Ergebnis des Parsens wird ihre Zwischendarstellung erhalten, die als AST-Baum bezeichnet wird. Der AST-Baum ist ein Grundkonzept, mit dem Sie Python-Code im laufenden Betrieb ändern können. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem Empfang eines solchen Baums legt pytest eine Transformation fest, die nach allen Ausdrücken sucht, die als assert bezeichnet werden. Er ändert sie auf eine bestimmte Weise, kompiliert den resultierenden neuen AST-Baum und erhält ein Modul mit Tests, das dann auf einer regulären Python Virtual Machine ausgeführt wird.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t3/fj/x-/t3fjx-trld3abinbaqxioiizptg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht der ursprüngliche AST-Baum aus, der nicht in Pytest konvertiert wurde. </font><font style="vertical-align: inherit;">Der hervorgehobene rote Bereich ist unser Assert. </font><font style="vertical-align: inherit;">Wenn Sie genau hinschauen, sehen Sie den linken und rechten Teil, die Liste selbst. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn pytest dies umwandelt und ein neues Jahr generiert, sieht der Baum so aus. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/xh/qb/yvxhqbjsokha_vdwfn9-ksm0isi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt ungefähr hundert Codezeilen, die pytest für Sie generiert hat. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/fc/zi/cufczioilng0zfzx05nbrtwgl8g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie diesen AST-Baum wieder in Python konvertieren, sieht er ungefähr so ​​aus. </font><font style="vertical-align: inherit;">In den hier rot hervorgehobenen Bereichen berechnet pytest den linken und rechten Teil des Ausdrucks, generiert eine Fehlermeldung und löst einen AssertionError aus, wenn bei dieser Fehlermeldung ein Fehler aufgetreten ist.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mustervergleich</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was kann man mit so etwas noch machen? Sie können jeden Python-Code konvertieren. Und es gibt eine wundervolle Bibliothek, die ich ganz zufällig auf PyPI gefunden habe. Es ist interessant, dort zu graben. Sie macht Mustervergleich. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3k/yb/eq/3kybeqrilpfpqnvj4bmeon62ibm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht ist dieser Code jemandem bekannt. Er betrachtet faktoriell rekursiv. Mal sehen, wie es mit Pattern Matching aufgezeichnet werden kann.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/cv/as/xycvassi6jwpp9getvm4sy4bbmm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hängen Sie dazu einfach den Dekorateur an die Funktion. Bitte beachten Sie: Im Körper funktioniert die Funktion bereits anders. Jedes dieser ifs ist eine Regel für den Mustervergleich, die den in die Funktion eingegebenen Ausdruck analysiert und ihn irgendwie transformiert. Darüber hinaus gibt es nicht einmal explizite Rückgaben des Ergebnisses. Da die Musterbibliothek beim Transformieren des Funktionskörpers erstens prüft, ob sie nur dann enthält, wenn sie zweitens implizite Rückgaben des Ergebnisses hinzufügt, wodurch die Semantik der Sprache geändert wird. Das heißt, sie macht ein neues DSL, das etwas anders funktioniert. Und dank dessen können Sie einige Dinge deklarativ aufschreiben. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3k/yb/eq/3kybeqrilpfpqnvj4bmeon62ibm.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die vorherige Funktion ist wie in drei Zeilen geschrieben.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/cv/as/xycvassi6jwpp9getvm4sy4bbmm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/pj/fm/ux/pjfmuxf4zsl_zpppzidv9oirkim.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Rest der Zeilen fügt zusätzliche Funktionen hinzu, mit denen beispielsweise Fakultäten aus einer Werteliste gelesen oder durch eine beliebige Funktion geleitet werden können. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie schreibe ich Conversions selbst? </font><font style="vertical-align: inherit;">Makropie!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt wundern Sie sich wahrscheinlich, aber wie können Sie es selbst anwenden? Suchen Sie nach dem Code, der konvertiert werden muss, da es mühsam ist, wie z. B. pytest: Dateien manuell zu analysieren. Im Pytest wird dies durch ein separates Modul für tausend oder mehr Zeilen durchgeführt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dies nicht alleine zu tun, haben einige clevere Leute bereits ein Modul für uns entwickelt, das sich Makropie nennt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Version des Moduls ist sowohl für den zweiten Python als auch für den dritten. Sie haben es in der Zeit des zweiten Python geschrieben. Dann hatten die Jungs einen Witz, um herauszufinden, was mit Python gemacht werden kann, und die Bibliothek enthält verschiedene Beispiele. Schauen wir sie uns an, sie geben Ihnen eine Vorstellung davon, was Sie mit dieser Technik tun können. Die erste coole Sache, die sie im Tutorial beschrieben haben, ist ein Makro, das Formatzeichenfolgen für das zweite Python implementiert, wie im dritten.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/3h/vv/er3hvvz7g-0edq1spxz5bukrk3q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der rot hervorgehobene Ausdruck ist nur die Syntax des Makroaufrufs. Der Buchstabe S ist der Name des Makros und in eckigen Klammern der Ausdruck, den es konvertiert. Infolgedessen werden hier Variablen ersetzt. Dies funktioniert im zweiten Python, aber der dritte wird in einem solchen Makro nicht mehr benötigt. So können Sie beispielsweise Ihr eigenes Makro erstellen, das eine komplexere Semantik implementiert und mehr Spaß macht als Zeichenfolgen im Standardformat.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jw/bf/hx/jwbfhxtuxzzrbjd-vvu3rhdsok8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn ein Makro erweitert wird und dies zum Zeitpunkt des Ladens des Moduls geschieht, wird es einfach in diesen Code konvertiert. Platzhalter werden in die Formatzeichenfolge eingefügt und das Ersetzungsverfahren wird darauf angewendet. Weiteres Python kompiliert dies alles bereits in Standardform. Zur Laufzeit treten keine Makroerweiterungen auf. Alle treten auf, wenn das Modul geladen wird. Daher können Sie auf diese Weise sogar Optimierungen oder Berechnungen vornehmen, die zum Zeitpunkt des Ladens des Moduls erfolgen, und einen optimaleren Bytecode generieren. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2i/gz/9t/2igz9tsitqjebyuxpln51mhknra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das zweite Beispiel ist ebenfalls interessant. Dies ist eine Kurzschreibweise zum Schreiben von Lambdas. Das Makro f verwendet eine Reihe von Argumenten und gibt stattdessen eine Funktion zurück. Jeder Ausdruck, der mit dem Makronamen „f“, Klammern und dann absolut jedem Ausdruck beginnt, wird in ein Lambda konvertiert.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/l5/vq/ym/l5vqym-i-69vtjohomf2nsxfsj0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meiner Meinung nach ist dies auch cool, insbesondere für diejenigen, die Code in einem funktionalen Stil entwickeln und schreiben und MapReduce verwenden möchten. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0j/fx/xc/0jfxxcdmblyze8e4bcxqrqrgaoy.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist ein weiteres bekanntes Beispiel. Diese Funktion wird als Fakultät betrachtet, der Code wird rot hervorgehoben. Was passiert, wenn sie angerufen wird? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ov/gj/v0/ovgjv0vqgcbzx0wxy5q-kuvozzg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Python wird ein Fehler ausgegeben, da das Stack-Limit überschritten wird und ein so hässlicher RecursionError auftritt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/zz/1h/wizz1haarmzw9is0q0k3n_r6mji.jpeg" width="600"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie kann das behoben werden? Mit Macropy ist die Behebung des Problems sehr einfach. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wc/ej/-n/wcej-na40treik2p0hkdp1jfbns.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie hängen den Dekorateur auf, er nimmt den Körper der Funktion und transformiert ihn auf magische Weise. Sie müssen nichts an der Funktion selbst ändern, Macropy erledigt alles für Sie. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/c8/ld/xcc8ldcmcykmbaxjceek4xsgrka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und die Funktion wird zu einem ganz normalen Ergebnis zurückkehren und weit in den Untergrund gehen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ek/uq/mi/ekuqmigu-x5hhmdyyy8q04wob5c.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie makropy macht das?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fz/1r/5f/fz1r5ff8_v-egywcvufzvw-zsec.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ersetzt alle Aufrufe der Funktion selbst durch ein spezielles TailCall-Objekt, das dann vom TCO-Dekorator in einer Schleife aufgerufen wird. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dg/25/5b/dg255bb2t_mzo9ku4ucwq-uz31o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Schaltung sieht ungefähr so ​​aus. Der Dekorator in der Schleife ruft die Funktion auf, bis anstelle von TailCall ein normales Ergebnis zurückgegeben wird. Und wenn sie zurückkommt, dann gibt sie es zurück. Und alle. Diese coolen Dinge können mit Makros gemacht werden! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Makropie enthält auch andere Beispiele. Ich hoffe, diejenigen, die neugierig auf dich sind, gehen und sehen sie alleine. Nehmen wir an, es gibt nützliche Dinge zum Debuggen.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wd/hg/rq/wdhgrqonz6lfdcicgdynvnfipfs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich erzähle dir von einer anderen coolen Sache. Ein Beispiel ist dieses Abfragemakro. Was macht er? Darin schreiben Sie regulären Python-Code, den Sie dann als reguläres Ergebnis der Ausführung dieses Ausdrucks verwenden können. Im Inneren transformiert Macropy diesen Code und macht ihn zu Alchemy SQL-Abfragesprachencode. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ag/qb/jk/agqbjkyzfbun_tbdnjxww5lutms.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Er schreibt es für dich um, macht diesen schrecklichen Ausdruck. Es kann von Hand umgeschrieben werden, dann wird es kürzer. Ich habe es gemacht. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4k/ts/5w/4kts5wogftqmpcceukufkib56be.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist der ursprüngliche Ausdruck. Nach dem Erweitern des Makros nimmt es ungefähr so ​​an. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/du/i0/uv/dui0uvfpouzuuioj2tmirtfyg5c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht ist jemand daran interessiert, Code zu schreiben, der Python ähnlicher ist, und seine Entwickler nicht zu zwingen, Abfragen in DSL SQL Alchemy zu schreiben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Auf die gleiche Weise können Sie alles aus Python generieren - reines SQL, JavaScript - und es irgendwo neben der Datei speichern und dann im Frontend verwenden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kk/s3/j3/kks3j3s2wwep0vejhof8-3fw-oq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun wollen wir sehen, wie Sie Ihr eigenes Makro erstellen. Mit Makropie ist es sehr einfach. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Makro ist eine Funktion, die einen AST-Baum an der Eingabe verwendet und auf irgendeine Weise einen neuen zurückgibt. Hier ist ein Makrobeispiel, das dem Assert-Aufruf, der den Quellausdruck enthält, eine Beschreibung hinzufügt, damit wir verstehen, warum der AssertionError-Fehler aufgetreten ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist die interne Funktion replace_assert hilfreich. Sie macht für Sie einen rekursiven Abstieg in einen Baum. Innerhalb des replace_assert wird das Teilbaumelement übergeben.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3u/qn/wa/3uqnwavrca79l0wumgmnfxfcm58.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus diesem Grund können Sie den Typ von innen überprüfen und? Wenn es sich um einen Assert-Aufruf handelt, machen Sie etwas damit. Hier werde ich ein einfaches synthetisches Beispiel geben, das den linken Teil, den rechten Teil nimmt, eine Fehlermeldung von ihnen macht und alles in das msg-Attribut schreibt. Dies ist die Nachricht, die zurückgegeben werden muss. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rf/re/hn/rfrehnypphthxdzqbjwehtj3fas.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/va/ak/jm/vaakjmq4tpgqjwttqmi8nepgtym.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/x7/hq/cs/x7hqcswjuj59uhp5thatiojofja.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie es verwenden, hängen Sie ein solches Makro mithilfe des with context-Managers an einen Codeblock an, und der gesamte Code, der in den Kontextmanager gelangt, durchläuft diese Umwandlung. Es ist unten zu sehen, dass unsere Fehlermeldung zum AssertionError hinzugefügt wurde, den wir aus dem len-Ausdruck ([1, 2, 3]) gebildet haben.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yo/zo/zc/yozozclanvtdlinutuvnl58puve.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Methode hat jedoch eine Einschränkung, die mich persönlich traurig macht. </font><font style="vertical-align: inherit;">Ich habe als Experiment versucht, neue Designs zu erstellen, die in der Sprache funktionieren. </font><font style="vertical-align: inherit;">Zum Beispiel mögen manche Leute Schalter oder bedingte Konstruktionen wie es sei denn. </font><font style="vertical-align: inherit;">Dies ist jedoch leider nicht möglich: Makropie und andere Tools, die mit dem AST-Baum arbeiten, werden verwendet, wenn der Quellcode bereits gelesen und in Token aufgeteilt wurde. </font><font style="vertical-align: inherit;">Der Code wird vom Python-Parser gelesen, dessen Grammatik im Interpreter festgelegt ist. </font><font style="vertical-align: inherit;">Um dies zu ändern, müssen Sie Python neu kompilieren. </font><font style="vertical-align: inherit;">Natürlich können Sie dies tun, aber es wird bereits eine Abzweigung von Python sein und keine Bibliothek, die auf PyPI angelegt werden kann. </font><font style="vertical-align: inherit;">Daher ist es unmöglich, solche Konstruktionen unter Verwendung von Makropie herzustellen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyLang</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Glücklicherweise schrieb ich für mein langes Leben nicht nur in Python und interessierte mich für verschiedene andere alternative Sprachen. Es gibt eine Syntax, die viele nicht mögen, die aber einfacher und flexibler ist. Dies sind S-Ausdrücke. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Glück gibt es ein Python-Add-In namens HyLang. Dieses Ding erinnert etwas an Clojure, nur Clojure läuft auf der JVM und HyLang läuft auf der Python Virtual Machine. Das heißt, es bietet Ihnen eine neue Syntax zum Schreiben von Code. Gleichzeitig ist der gesamte von Ihnen geschriebene Code vollständig mit vorhandenen Python-Bibliotheken kompatibel und kann aus Python-Bibliotheken verwendet werden. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/54/sc/rr/54scrrucaeden67utnbyx3jva0i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es sieht ungefähr so ​​aus.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/vr/w7/qovrw7a-mivofegxjhx61jtlky0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Teil links in Python, rechts in HyLang. Und von unten ist für beide ein Bytecode, der das Ergebnis ist. Sie haben wahrscheinlich bemerkt, dass es genau das gleiche ist, nur die Syntax ändert sich. HyLang S-Ausdrücke, die viele nicht mögen. Gegner der „Klammern“ verstehen nicht, dass eine solche Syntax der Sprache eine enorme Kraft verleiht, weil sie den Konstruktionen der Sprache Einheitlichkeit verleiht. Durch die Einheitlichkeit können Sie Makros verwenden, um jedes Design zu implementieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies wird dadurch erreicht, dass in jedem Ausdruck das erste Element immer eine Art Aktion ist. Und dann gehen seine Argumente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der gesamte Code besteht aus verschachtelten Ausdrücken, die einfach konvertiert und dort geöffnet werden können. Aus diesem Grund können in HyLang absolut alle Konstruktionen erstellt werden, die neu sind und im Code in keiner Weise von den Standardfunktionen der Sprache zu unterscheiden sind. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o5/-u/rw/o5-urwww9tzewkt4ufq7krycxj8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mal sehen, wie ein einfaches Makro in HyLang funktioniert. Um dasselbe zu tun, was wir mit Assert unter Verwendung von Makropy gemacht haben, benötigen Sie nur diesen Code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unser HyLang-Makro empfängt Eingaben, bei denen es sich um Code handelt. Darüber hinaus kann ein Makro problemlos einen beliebigen Teil dieses Codes verwenden, um neuen Code zu erstellen. Der Hauptunterschied zwischen Makros und Funktionen: Ausdrücke sind Eingaben, keine Werte. Wenn wir unser Makro als (is (= 1 2)) aufrufen, erhält es einen Ausdruck (= 1 2) anstelle von False.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uc/5b/az/uc5bazq37xtwjlsbaf54_kpe8zu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So können wir eine Fehlermeldung generieren, dass etwas schief gelaufen ist. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hn/a9/cm/hna9cmzwxvf87k5e4i0py87cs84.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dann einfach den neuen Code zurückgeben. Diese Backtick- und Tilde-Syntax bedeutet ungefähr Folgendes. Das hintere Zitat sagt: Nimm diesen Ausdruck wie er ist und gib ihn zurück wie er ist. Und die Tilde sagt: Ersetzen Sie hier den Wert der Variablen. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pi/qn/en/piqnenjm28v8jm0i-hfsdx3ib18.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir dies schreiben, gibt das Makro bei der Erweiterung einen neuen Ausdruck an uns zurück, der dadurch mit einer zusätzlichen Fehlermeldung bestätigt wird.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HyLang ist eine coole Sache. </font><font style="vertical-align: inherit;">Stimmt, während wir es nicht benutzen. </font><font style="vertical-align: inherit;">Vielleicht werden wir es nie tun. </font><font style="vertical-align: inherit;">Alle diese Punkte sind experimentell. </font><font style="vertical-align: inherit;">Ich möchte, dass Sie hier mit dem Gefühl abreisen, dass Sie in Python einige Dinge tun können, an die Sie vorher vielleicht noch nicht einmal gedacht haben. </font><font style="vertical-align: inherit;">Und vielleicht finden einige von ihnen praktische Anwendung in Ihrer laufenden Arbeit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist alles für mich. </font><font style="vertical-align: inherit;">Sie können die Links sehen:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacroPy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HyLang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Buch OnLisp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - für eine fortgeschrittene Untersuchung der Fähigkeiten von Makros. </font><font style="vertical-align: inherit;">Dies ist für diejenigen, die besonders interessiert sind. </font><font style="vertical-align: inherit;">Das Buch basiert zwar nicht ausschließlich auf Python, sondern auf Common Lisp. </font><font style="vertical-align: inherit;">Für eine eingehendere Untersuchung wird dies jedoch sogar interessant sein.</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de495278/index.html">Datenbanken, Karten, Checklisten oder Warum ein Business Knowledge Manager</a></li>
<li><a href="../de495280/index.html">Max Patrol SIEM. Übersicht über das Informationssicherheits-Ereignisverwaltungssystem</a></li>
<li><a href="../de495282/index.html">XML-Validierung mit XSD, JAXB und Spring Framework</a></li>
<li><a href="../de495290/index.html">Erkundung der Codequalität des Zephyr-Betriebssystems</a></li>
<li><a href="../de495292/index.html">InterSystems IRIS 2020.1 Release</a></li>
<li><a href="../de495296/index.html">Forensik, SQL-Injection und leidende Katze: Analyse der Aufgabe Nr. 3 der Online-Phase NeoQUEST-2020</a></li>
<li><a href="../de495298/index.html">Bewerten Sie die Optionen von Monte Carlo Clojure</a></li>
<li><a href="../de495302/index.html">So steigern Sie den Umsatz in einem Online-Shop in 4 Monaten um das 2,5-fache - ein Argument für SEO-Werbung</a></li>
<li><a href="../de495304/index.html">Verjüngung menschlicher Zellen aufgrund ihrer Neuprogrammierung</a></li>
<li><a href="../de495308/index.html">Harken Sie auf dem Weg, um am Leben zu bleiben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>