<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸº ğŸ˜ ğŸ›ï¸ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¿ã‚¹ã‚¯ã§ã®Rã®ä½¿ç”¨ ğŸ‘” #âƒ£ ğŸ’…ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å„ªã‚ŒãŸãƒ„ãƒ¼ãƒ«ã¨ãã‚Œã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ã‚¹ã‚­ãƒ«ã®å¯ç”¨æ€§ã¯ã€å®Ÿè·µã‚’é€šã˜ã¦é”æˆã•ã‚Œã€å¤šãã®ã•ã¾ã–ã¾ãªã€Œé¡ä¼¼ã€éå®šå‹ã‚¿ã‚¹ã‚¯ã‚’ç°¡å˜ã‹ã¤ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆã«è§£æ±ºã§ãã¾ã™ã€‚ä»¥ä¸‹ã¯ã€ã„ãã¤ã‹ã®é¡ä¼¼ã—ãŸä¾‹ã§ã™ã€‚å¤šãã®äººãŒã“ã®ãƒªã‚¹ãƒˆã‚’æ‹¡å¼µã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
 

ã“ã‚Œã¾ã§ã®åˆŠè¡Œç‰©ã®ç¶šãã§ã™ã€‚
 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°åˆ†æ
 

ã‚¢ãƒ—...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¿ã‚¹ã‚¯ã§ã®Rã®ä½¿ç”¨</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464849/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å„ªã‚ŒãŸãƒ„ãƒ¼ãƒ«ã¨ãã‚Œã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ã‚¹ã‚­ãƒ«ã®å¯ç”¨æ€§ã¯ã€å®Ÿè·µã‚’é€šã˜ã¦é”æˆã•ã‚Œã€å¤šãã®ã•ã¾ã–ã¾ãªã€Œé¡ä¼¼ã€éå®šå‹ã‚¿ã‚¹ã‚¯ã‚’ç°¡å˜ã‹ã¤ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆã«è§£æ±ºã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ä»¥ä¸‹ã¯ã€ã„ãã¤ã‹ã®é¡ä¼¼ã—ãŸä¾‹ã§ã™ã€‚</font><font style="vertical-align: inherit;">å¤šãã®äººãŒã“ã®ãƒªã‚¹ãƒˆã‚’æ‹¡å¼µã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚Œ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¾ã§ã®åˆŠè¡Œç‰©ã®</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¶šãã§ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><a name="habracut"></a></p><br>
<h1 id="analitika-po-logam-prilozheniy"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°åˆ†æ</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã«åŸºã¥ã„ã¦åˆ†æè¨ˆç®—ã‚’å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯éå¸¸ã«äººæ°—ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åˆ†æã‚’è¡Œã„ã€äºˆæ¸¬æŒ‡æ¨™ã‚’æ¨å®šã—ãŸã‚Šã€ä»®èª¬ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã‚Šã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¾“ã£ã¦ELKã‚¹ã‚¿ãƒƒã‚¯ãªã©ã‚’ä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆæœ€è¿‘ã€Splunkã¯ãƒ­ã‚·ã‚¢ã§åˆ©ç”¨å¯èƒ½ãªã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è„±è½ã—ã¦ã„ã¾ã™ï¼‰ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€å°‘ã—è€ƒãˆã¦ã€Rã§ã™ã¹ã¦ã‚’ã™ã°ã‚„ãè¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚å®Ÿè£…ã¨å‡¦ç†æ™‚é–“ã®ä¸¡æ–¹ã«ãŠã„ã¦ã€ã‚ã‚‰ã‚†ã‚‹æ„å‘³ã§ã™ã°ã‚„ãã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã—ã‹ã—ã€åŒæ§˜ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹å ´åˆã€ã„ãã¤ã‹ã®æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€šå¸¸ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€</font></font><code>log4j</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã€é‡è¦åº¦ã€ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¿ã‚¤ãƒ—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ãªã©ã®</font><font style="vertical-align: inherit;">å¤å…¸çš„ãª</font><font style="vertical-align: inherit;">å½¢å¼ã§</font><font style="vertical-align: inherit;">æ›¸ãè¾¼ã¾ã‚Œ</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã«ã¯ãƒŸãƒªç§’å˜ä½ã®è§£åƒåº¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå«ã¾ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã€ãã®å¾Œã®åˆ†æã®æ­£ç¢ºã•ã®ãŸã‚ã«ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒŸãƒªç§’ã¯ã€ISO 8601ã«æº–æ‹ ã›ãšã«æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã¯ã€å®Ÿè³ªçš„ã«æ§‹é€ åŒ–ã•ã‚Œã¦ã„ãªã„ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§ã™ã€‚</font><font style="vertical-align: inherit;">é–‹ç™ºè€…ã¯ã€ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å½¢å¼ã«åˆ¶é™ã•ã‚Œã‚‹ã“ã¨ãªãã€å¿…è¦ã¨è€ƒãˆã‚‹ã™ã¹ã¦ã®ã‚‚ã®ã‚’ãã“ã§è¨˜è¿°ã—ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å ´åˆã«ã‚ˆã£ã¦ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ãŒè¤‡æ•°è¡Œã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€Javaã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã®å‡ºåŠ›ã‚„xmlã‚·ã‚¹ãƒ†ãƒ é–“äº¤æ›ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã©ã§ã™ã€‚</font><font style="vertical-align: inherit;">è¤‡æ•°è¡Œã®è¨˜éŒ²ã‚’1ã¤ã«å†æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒãƒ¼ã‚«ãƒ¼ã¯è¨˜éŒ²ã®é–‹å§‹ã®å°ã§ã™ï¼‰ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤šãã®å±æ€§ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¤–éƒ¨ã«ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ãã‚Œã‚‰ã¯ç•°ãªã‚‹æ–¹æ³•ã§å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®IDã‚’ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®ãƒ­ã‚°ã¯ã€æ•°ãƒ¡ã‚¬ãƒã‚¤ãƒˆã¾ãŸã¯æ•°ç™¾ã‚®ã‚¬ãƒã‚¤ãƒˆã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¿ã‚¹ã‚¯ã¯éå¸¸ã«ã‚ˆãä¸¦è¡Œã—ã¦ã„ã¾ã™ã€‚</font></font></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Ÿéš›ã€ã‚¿ã‚¹ã‚¯ã¯2ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã«åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç”Ÿãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãã®å¾Œã®åˆ†æã€‚</font></font></li>
</ul><br>
<p>       -, R     .   ,             R.  ,      ,    ,    ,     ,    .    -.</p><br>
<div class="spoiler"><b class="spoiler_title">  :</b><div class="spoiler_text"><pre><code class="python hljs">library(readr)<font></font>
library(tidyverse)<font></font>
library(magrittr)<font></font>
library(stringi)<font></font>
library(fs)<font></font>
library(glue)<font></font>
library(RClickhouse)<font></font>
library(DBI)<font></font>
library(anytime)<font></font>
library(tictoc)<font></font>
library(iterators)<font></font>
library(foreach)<font></font>
library(doParallel)<font></font>
library(futile.logger)<font></font>
library(re2r)<font></font>
library(data.table)<font></font>
library(future)<font></font>
library(doFuture)<font></font>
<font></font>
common_logname &lt;- <span class="hljs-string">"DEV_log_parser.log"</span>
table_name &lt;- <span class="hljs-string">"DEV_LOGS"</span><font></font>
<font></font>
flog.appender(appender.file(common_logname))<font></font>
flog.threshold(INFO)<font></font>
flog.info(<span class="hljs-string">"Start batch processing"</span>)<font></font>
<font></font>
oneTimeProcessing &lt;- function(f_iter, log_type = c(<span class="hljs-string">"app"</span>, <span class="hljs-string">"system"</span>)) {<font></font>
  log_type &lt;- match.arg(log_type)<font></font>
  checkmate::assertNames(names(f_iter), <font></font>
                         permutation.of = c(<span class="hljs-string">"fname"</span>, <span class="hljs-string">"short_fname"</span>, <span class="hljs-string">"location"</span>, <span class="hljs-string">"wk"</span>, <span class="hljs-string">"size"</span>, <span class="hljs-string">"id"</span>))<font></font>
  cfg &lt;- list(app = list(db_table = <span class="hljs-string">"DEV_APP_LOGS"</span>),<font></font>
              system = list(db_table = <span class="hljs-string">"DEV_LOGS"</span>))<font></font>
<font></font>
  <span class="hljs-comment">#    </span><font></font>
  data &lt;- readr::read_lines(file = f_iter$fname, progress = FALSE)<font></font>
<font></font>
  log_df &lt;- setDT(tibble::enframe(data, name = NULL)) %&gt;%<font></font>
    .[, log_line_start := re2r::re2_detect(value, <font></font>
                                           pattern = <span class="hljs-string">"^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}"</span>,<font></font>
                                           parallel = F)] %&gt;%<font></font>
    .[, log_line_number := cumsum(log_line_start)] %&gt;%<font></font>
    .[, body := stri_c(value, collapse = <span class="hljs-string">"\n"</span>), by = log_line_number] %&gt;%<font></font>
    .[, `:=`(value = NULL, log_line_start = NULL, log_line_number = NULL)] %&gt;%<font></font>
    tibble::as_tibble() %&gt;%<font></font>
    <span class="hljs-comment">#  body = character(0)      0 </span>
    <span class="hljs-comment">#      POSIXct </span>
    tidyr::extract(col = <span class="hljs-string">"body"</span>,<font></font>
                   into = c(<span class="hljs-string">"timestamp"</span>, <span class="hljs-string">"tz"</span>, <span class="hljs-string">"level"</span>, <span class="hljs-string">"module"</span>, <span class="hljs-string">"class"</span>, <span class="hljs-string">"message"</span>),
                   <span class="hljs-comment"># tz   (  DEV),      ( DEV)</span>
                   regex = <span class="hljs-string">"^(\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}:\\d+([+-]\\d+)?) (.*?) &lt;(.*?)&gt; \\[(.*?)\\] (?s:(.*))$"</span>,<font></font>
                   case_insensitive = TRUE, ignore.case = TRUE) %&gt;%<font></font>
    <span class="hljs-comment">#     ISO         (   ?)</span>
    <span class="hljs-comment">#  ISO 8601 (https://en.wikipedia.org/wiki/ISO_8601)</span>
    mutate_at(<span class="hljs-string">"timestamp"</span>, re2r::re2_replace, 
              <span class="hljs-comment"># tz   (  DEV),      ( DEV)</span>
              pattern = <span class="hljs-string">"(.*) (\\d{2}:\\d{2}:\\d{2}):(\\d+([+-]\\d+)?)"</span>, <font></font>
              replacement = <span class="hljs-string">"\\1T\\2.\\3"</span>) %&gt;%<font></font>
    mutate_at(<span class="hljs-string">"timestamp"</span>, lubridate::as_datetime, tz = <span class="hljs-string">"Europe/Moscow"</span>) %&gt;%
    <span class="hljs-comment">#   </span><font></font>
    mutate(location = f_iter$location, wk = f_iter$wk)<font></font>
<font></font>
  <span class="hljs-comment"># TRUNCATE  CH    ,          </span>
  <span class="hljs-comment">#    CH, ms    (timestamp %% 1)</span>
  conn &lt;- DBI::dbConnect(RClickhouse::clickhouse(), host = <span class="hljs-string">"10.0.0.1"</span>, db = <span class="hljs-string">"DEV_LOGS"</span>)
  <span class="hljs-comment"># m &lt;- DBI::dbExecute(conn, glue("ALTER TABLE {table_name}"))</span><font></font>
  write_res &lt;- log_df %&gt;%<font></font>
    mutate(ms = (<span class="hljs-keyword">as</span>.numeric(timestamp) %% <span class="hljs-number">1</span>) * <span class="hljs-number">1000</span>) %&gt;%<font></font>
    select(location, wk, timestamp, ms, level, module, <span class="hljs-class"><span class="hljs-keyword">class</span>, <span class="hljs-title">message</span>) %&gt;%
    #           
    <span class="hljs-title">DBI</span>:</span>:dbWriteTable(conn, cfg[[log_type]][[<span class="hljs-string">"db_table"</span>]], ., append = TRUE)<font></font>
  DBI::dbDisconnect(conn)<font></font>
<font></font>
  <span class="hljs-comment">#      </span><font></font>
  res &lt;- tibble::tibble(id = f_iter$id,<font></font>
                        lines = nrow(log_df), <font></font>
                        min_t = min(log_df$timestamp), <font></font>
                        max_t = max(log_df$timestamp),<font></font>
                        write_res)<font></font>
  rm(data, log_df)<font></font>
  <span class="hljs-keyword">return</span>(res)<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">#   </span>
tic(<span class="hljs-string">"Batch processing"</span>)<font></font>
<font></font>
<span class="hljs-comment">#   </span><font></font>
gc(full = TRUE)<font></font>
nworkers &lt;- parallel::detectCores() - <span class="hljs-number">1</span><font></font>
<font></font>
registerDoFuture()<font></font>
<span class="hljs-comment"># future::plan(multiprocess)</span>
<span class="hljs-comment"># future::plan(multisession)</span><font></font>
future::plan(multisession, workers = nworkers)<font></font>
<span class="hljs-comment"># future::plan(sequential) #  ~ </span><font></font>
<font></font>
<span class="hljs-comment">#      CH</span>
<span class="hljs-comment">#   ------------------</span>
fnames_tbl &lt;- here::here(<span class="hljs-string">"raw_data"</span>) %&gt;%<font></font>
  fs::dir_ls(recurse = TRUE, glob = <span class="hljs-string">"*dev_app*.gz"</span>) %&gt;% <font></font>
  enframe(name = <span class="hljs-string">"fname"</span>) %&gt;% 
  <span class="hljs-comment">#        </span>
  mutate(short_fname = <span class="hljs-keyword">as</span>.character(fs::path_rel(fname, start = <span class="hljs-string">"./raw_data"</span>))) %&gt;% <font></font>
  select(-value) %&gt;%<font></font>
  mutate(size = fs::file_size(fname)) %&gt;%<font></font>
  tidyr::extract(col = <span class="hljs-string">"short_fname"</span>, into = c(<span class="hljs-string">"location"</span>, <span class="hljs-string">"wk"</span>),<font></font>
                 regex = <span class="hljs-string">"^([^/]+)/wk(\\d+)"</span>, remove = FALSE) %&gt;%<font></font>
  arrange(size) %&gt;%<font></font>
  mutate(id = paste(format(row_number(), justify = <span class="hljs-string">"r"</span>, width = <span class="hljs-number">4</span>), <span class="hljs-string">"/"</span>, n())) %&gt;%
  <span class="hljs-comment">#   ~ N </span>
  mutate(chunk = (row_number() %% nworkers + <span class="hljs-number">1</span>)) %&gt;%
  <span class="hljs-comment">#    ,  dopar   </span><font></font>
  arrange(chunk)<font></font>
<font></font>
start_time &lt;- Sys.time()<font></font>
stat_list &lt;- <font></font>
  foreach(it = iter(fnames_tbl, by = <span class="hljs-string">"row"</span>), .export = c(<span class="hljs-string">"start_time"</span>), <font></font>
          .verbose = TRUE, .inorder = FALSE, .errorhandling = <span class="hljs-string">"remove"</span>) %dopar% {
            <span class="hljs-comment">#  </span><font></font>
            flog.appender(appender.file(common_logname))<font></font>
            <span class="hljs-comment"># flog.info(capture.output(gc(verbose = TRUE)))</span>
            res &lt;- oneTimeProcessing(it, log_type = <span class="hljs-string">"app"</span>)<font></font>
            flog.info(glue(<span class="hljs-string">"Step {it$id} finished."</span>,
                           <span class="hljs-string">"Elapsed {round(difftime(Sys.time(), start_time, units = 'mins'), digits = 2)} min(s) -----------&gt;"</span>, .sep = <span class="hljs-string">" "</span>))
            <span class="hljs-keyword">return</span>(res)<font></font>
          }<font></font>
flog.info(<span class="hljs-string">"Load finished"</span>)<font></font>
<font></font>
<span class="hljs-comment">#    --------------</span>
<span class="hljs-comment">#    ,   </span><font></font>
future::plan(sequential)<font></font>
gc(reset = TRUE, full = TRUE)<font></font>
flog.info(capture.output(toc()))<font></font>
<font></font>
<span class="hljs-comment">#     -------------</span><font></font>
logstat_tbl &lt;- stat_list %&gt;%<font></font>
  dplyr::bind_rows() %&gt;%<font></font>
  <span class="hljs-comment">#   </span>
  left_join(fnames_tbl, by = <span class="hljs-string">"id"</span>) %&gt;%
  <span class="hljs-comment">#         </span>
  mutate(delta_t = <span class="hljs-keyword">as</span>.numeric(difftime(max_t, min_t, units = <span class="hljs-string">"mins"</span>))) %&gt;%<font></font>
  arrange(min_t)<font></font>
<font></font>
write_delim(logstat_tbl, here::here(<span class="hljs-string">"output"</span>, <span class="hljs-string">"DEV_parse_stat.csv.gz"</span>), delim = <span class="hljs-string">";"</span>)<font></font>
<font></font>
<span class="hljs-comment"># ,     ?</span>
<span class="hljs-keyword">if</span>(nrow(logstat_tbl) &lt; nrow(fnames_tbl)){<font></font>
  flog.error(<span class="hljs-string">"!!!!!!! Not all workers were executed successfully !!!!!!!!!"</span>)<font></font>
}</code></pre></div></div><br>
<p>       ,   ,     ,   ,   ,    ,   ,         (<code>re2r</code>, ;              ,     ClickHouse,    {<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">bencmark</a>,       }).       ,   -     .    ,   .        .  .</p><br>
<p>              ?  .    <code>python</code>, <code>perl</code>, <code>awk</code>    . ,    <code>python</code>   ,   ,   -   Â«Â» .</p><br>
<h1 id="navedenie-poryadka-v-fotografiyah">   </h1><br>
<p>             -     .           (<code>YYYY-MM-DD hh_mm_ss</code>),         . Exif        .</p><br>
<p>       R  Â« Â».  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>fs</code></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>exifr</code></a>  .</p><br>
<ul>
<li>  ;</li>
<li> ;</li>
<li>     .   .</li>
</ul><br>
<p> ,    ,       ,    exif ,         .        .</p><br>
<div class="spoiler"><b class="spoiler_title">    :</b><div class="spoiler_text"><pre><code class="julia hljs">library(tidyverse)<font></font>
library(magrittr)<font></font>
library(stringi)<font></font>
library(lubridate)<font></font>
library(stringi)<font></font>
library(fs)<font></font>
library(glue)<font></font>
library(futile.logger)<font></font>
library(anytime)<font></font>
library(tictoc)<font></font>
library(bench)<font></font>
library(exifr)<font></font>
library(tictoc)<font></font>
<font></font>
input_path &lt;- <span class="hljs-string">"S:/ "</span> %&gt;%<font></font>
  fs::path_real()<font></font>
<font></font>
<span class="hljs-comment">#      </span>
output_path &lt;- <span class="hljs-string">"S:/ "</span> %&gt;%<font></font>
  fs::path_real()<font></font>
<font></font>
i_fnames &lt;- input_path %&gt;%<font></font>
  fs::dir_ls(recurse = TRUE, regexp = <span class="hljs-string">"(JPG|jpg)$"</span>)<font></font>
<font></font>
raw_df &lt;- read_exif(i_fnames, tags = c(<span class="hljs-string">"SourceFile"</span>, <span class="hljs-string">"Model"</span>, <span class="hljs-string">"DateTimeOriginal"</span>)) %&gt;%
  <span class="hljs-comment">#      base64, ,   </span>
  mutate(tmp = sub(<span class="hljs-string">"^base64:(.*)"</span>, <span class="hljs-string">"\\1"</span>, SourceFile)) %&gt;%<font></font>
  mutate(i_fname = purrr::map_chr(tmp, ~rawToChar(jsonlite::base64_dec(.)))) %&gt;%<font></font>
  mutate(tm = anytime::anytime(DateTimeOriginal)) %&gt;%<font></font>
  select(i_fname, DateTimeOriginal, model = Model, tm)<font></font>
<font></font>
<span class="hljs-comment">#        </span><font></font>
clean_df &lt;- raw_df %&gt;%<font></font>
  mutate(timestamp = case_when(<font></font>
    model == 'iPhone ...' ~ tm,<font></font>
    model == 'Nikon ...' ~ tm - lubridate::minutes(<span class="hljs-number">56</span>),<font></font>
    model == 'Samsung ...' ~ tm - lubridate::minutes(<span class="hljs-number">62</span>),<font></font>
    TRUE ~ tm)<font></font>
  ) %&gt;%<font></font>
  mutate_at(<span class="hljs-string">"i_fname"</span>, fs::path_real) %&gt;%<font></font>
  mutate(fname = format(timestamp, format = '%Y-%m-%d %H_%M_%S')) %&gt;%<font></font>
  <span class="hljs-comment">#  ,     (""),     </span><font></font>
  mutate(fname = dplyr::coalesce(fname, fs::path_ext_remove(fs::path_file(i_fname)))) %&gt;%<font></font>
  <span class="hljs-comment">#  ,        </span><font></font>
  group_by(fname) %&gt;%<font></font>
    mutate(n = n(), idx = row_number()) %&gt;%<font></font>
  ungroup() %&gt;%<font></font>
  <span class="hljs-comment">#       </span><font></font>
  mutate(fname = case_when(<font></font>
    n &gt; <span class="hljs-number">1</span> ~ stri_c(fname, <span class="hljs-string">'_'</span>, idx),<font></font>
    TRUE ~ fname<font></font>
    )<font></font>
  ) %&gt;%<font></font>
  mutate(o_fname = fs::path(!!output_path, paste0(fname, <span class="hljs-string">".jpg"</span>)))<font></font>
<font></font>
<span class="hljs-comment">#    </span><font></font>
janitor::get_dupes(clean_df, o_fname)<font></font>
<font></font>
<span class="hljs-comment">#  </span>
tic(<span class="hljs-string">" "</span>)<font></font>
clean_df %$%<font></font>
  <span class="hljs-comment"># purrr::walk2(i_fname, o_fname, ~print(glue("{.x} -&gt; {.y}")))</span><font></font>
  purrr::walk2(i_fname, o_fname, ~fs::file_copy(.x, .y, overwrite = TRUE))<font></font>
toc()<font></font>
<font></font>
<span class="hljs-comment">#             </span></code></pre></div></div><br>
<p> <code>exifr</code>?          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>ExifTool</code></a>. </p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exifã‚’æ“ä½œã—ãŸã‚Šåå‰ã‚’å¤‰æ›´ã—ãŸã‚Šã™ã‚‹ãŸã‚ã®ã•ã¾ã–ã¾ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚„GUIãŒæ•°å¤šãã‚ã‚‹ãŸã‚ã€ã‚¿ã‚¹ã‚¯ã¯åˆæˆã®ã‚ˆã†ã«è¦‹ãˆã€è­°è«–ã™ã‚‹ã®ã¯é›£ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’å–å¾—ã—ã¦æ™‚é–“ã‚’èª¿æ•´ã§ãã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚«ãƒ¡ãƒ©ã€ãŸã¨ãˆã°ã€ã‚«ãƒ¡ãƒ©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­£ç¢ºãªæ™‚é–“ã‚’è¨­å®šã™ã‚‹é »åº¦ãªã©ï¼‰ã€‚ãã®ãŸã‚ã€åå‰ã‚’å¤‰æ›´ã™ã‚‹ã¨ãã«ã€ã‚½ãƒ¼ã‚¹ã«åŸºã¥ã„ã¦ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚·ãƒ•ãƒˆã™ã‚‹å¿…è¦ã‚‚ã‚ã‚Šã¾ã™ã€‚</font></font></p><br>
<h1 id="zavershenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®Œäº†</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤šãã®åŒæ§˜ã®å•é¡ŒãŒã‚ã‚Šã€ãã‚Œã‚‰ã®å¤šãã¯Rã®åŠ©ã‘ã§ã‚‚è§£æ±ºã§ãã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»¥å‰ã®å‡ºç‰ˆç‰©- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€Œå­ä¾›ã€æ•°å­¦ãŠã‚ˆã³Rã€</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja464837/index.html">ã‚¬ãƒ³ã‚¸ã‚¹å·ã‹ã‚‰ãƒ´ã‚©ãƒ«ã‚¬å·ã¸ï¼šæ²³å·ã‚’æ±šæŸ“ã‹ã‚‰å®ˆã‚‹ã«ã¯ï¼Ÿ</a></li>
<li><a href="../ja464839/index.html">ãƒ†ã‚¹ãƒ©ãƒ¢ãƒ¼ã‚¿ãƒ¼ã‚ºã®ç‰¹è¨±ã«ã¤ã„ã¦</a></li>
<li><a href="../ja464841/index.html">Habr Weeklyï¼ƒ15 /è‰¯ã„ç‰©èªã®åŠ›ã«ã¤ã„ã¦ï¼ˆãã—ã¦ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³ã«ã¤ã„ã¦å°‘ã—ï¼‰</a></li>
<li><a href="../ja464843/index.html">C ++ã§ã®ASIOã®æœ‰ç”¨ã¾ãŸã¯é–‹ç™ºã«æº€è¶³</a></li>
<li><a href="../ja464847/index.html">Godotã§ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ-Pongï¼ˆãƒ‘ãƒ¼ãƒˆ1ï¼‰ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã‚·ãƒ¼ãƒ³ã®ä½œæˆã¨ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</a></li>
<li><a href="../ja464853/index.html">ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªæ©Ÿå™¨ã‚’è´ãå ´æ‰€ï¼šæ—¥æœ¬ã‹ã‚‰ãƒ­ã‚·ã‚¢ã¾ã§ã€ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ãƒ³ã®ãŸã‚ã®ãƒ†ãƒ¼ãƒæ–½è¨­ã®æ–‡åŒ–</a></li>
<li><a href="../ja464857/index.html">ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯ãƒã‚¤ã‚¯ãƒ­ã‚«ãƒ¼ãƒãƒ«OSé–‹ç™º-ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©</a></li>
<li><a href="../ja464859/index.html">è¤‡æ•°ã®Nema 17ã‚¹ãƒ†ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ã‚¿ãƒ¼ã¾ãŸã¯NemaStepperã‚’åŒæ™‚ã«åˆ¶å¾¡ã™ã‚‹</a></li>
<li><a href="../ja464861/index.html">ã‚¹ã‚¯ãƒ©ãƒ ãƒŸãƒ‹ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã¨ã‚¬ã‚¤ãƒ‰</a></li>
<li><a href="../ja464863/index.html">Natas Webã€‚Webã®è„†å¼±æ€§ã®æ‚ªç”¨ã‚’ç›®çš„ã¨ã—ãŸCTFãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®é€šéã€‚ãƒ‘ãƒ¼ãƒˆ4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>