<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💅🏻 👆🏾 🕵🏼 スクリプトをサードパーティのサイトに接続する方法 😓 🛰️ 🗳️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！これは私たちのブログの最初の投稿です。多くの人々がサイトのチャットとして私たちを知っています。私たちが始めたのは彼と一緒でしたが、今ではビジネスメッセンジャーの分野で主導的な地位を占めています。コールバック、インスタントメッセンジャーを介した顧客とのコミュニケーション、ソーシャル...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>スクリプトをサードパーティのサイトに接続する方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jivosite/blog/452802/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font><font style="vertical-align: inherit;">これは私たちのブログの最初の投稿です。</font><font style="vertical-align: inherit;">多くの人々がサイトのチャットとして私たちを知っています。私たちが始めたのは彼と一緒でしたが、今ではビジネスメッセンジャーの分野で主導的な地位を占めています。</font><font style="vertical-align: inherit;">コールバック、インスタントメッセンジャーを介した顧客とのコミュニケーション、ソーシャルネットワーク、モバイルアプリケーション、仮想PBX、CRM機能など、顧客に多くの機会を提供する包括的なビジネスソリューションに徐々に進化しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数年間、私たちは多くの技術的な問題の解決に成功し、多くの興味深いことを蓄積しました、そしてもちろん、いくつかの場所とユニークな経験で、私たちの松葉杖と自転車を書きました。</font><font style="vertical-align: inherit;">この投稿では、完全にリモートのチームでプロセスを開発、構築した経験を共有する一連の記事を開始し、世界中の何十万もの顧客に効果的にサービスを提供できるようにするアーキテクチャ、技術ソリューションについて説明します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zp/bn/fv/zpbnfvc-9q274ie5wcyhvuo3pma.jpeg" alt="画像"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今日のJivositeは次のとおりです。</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">世界中で25万人の顧客。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1日あたり1億5,000万回のウィジェットインプレッション。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1日あたり350万のメッセージ。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1か月あたり1,000万チャット。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1M同時接続。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">稼働中の250台以上のサーバー。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどの人はサイトのチャットとして私たちを知っているので、おそらくそれから始めます。</font><font style="vertical-align: inherit;">この記事では、コードをサードパーティのサイトに接続する方法と、チャットでの長年の経験の例として注意すべき点を示します。</font><font style="vertical-align: inherit;">この記事は、プラグインサービスを計画中または開発中の方、そして単にこのトピックに関心のあるすべての人に役立ちます。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エントリーポイント</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
劇場はハンガーから始まり、接続されたサービスは挿入コードで始まります。</font><font style="vertical-align: inherit;">これは、サイト上の任意のサービスまたはモジュールのエントリポイントです。</font><font style="vertical-align: inherit;">原則として、これはインストール手順に記載されています。その後、サイトのHTMLコードに追加する必要があります。その後、スクリプトを特定の方法でロードして初期化する「マジック」があります。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://site.com/file.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトをサイトに接続する方が簡単なように思えますか？ </font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準では、ページのHTMLコードにスクリプトタグを追加するだけです。</font><font style="vertical-align: inherit;">しかし実際には、これは重要な段階であり、多くの落とし穴を隠しています。</font><font style="vertical-align: inherit;">たとえば、ユーザーの識別、バックアップスクリプトの読み込みチャネルの実装、外観やロジックのカスタマイズ、ページの読み込み速度などです。</font><font style="vertical-align: inherit;">しかし、順番にすべてについて話しましょう。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">識別</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトを接続することは誰にとってもそれほど興味深いことではないため、スクリプトが何らかのロジックを実行し、このロジックがユーザーに関連付けられていることを確認してください。</font><font style="vertical-align: inherit;">たとえば、ソーシャルネットワークのカウンターID、APP_ID、この場合、これは作成された通信チャネルのIDです。</font><font style="vertical-align: inherit;">つまり、スクリプトはサーバーへのリクエストでユーザーを識別する必要があります。</font><font style="vertical-align: inherit;">挿入コードを通じてクライアントを識別するために、3つの実装オプションがあります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプション1</font></font></b><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://site.com/file.js?id=123"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルへのリンクに直接IDを渡し、サーバー側で何らかの方法でIDをスクリプトにスローします。この場合、サーバーはオンザフライでファイルにIDを書き込むか、file.jsをロードするIDでJS文字列を形成する必要があります。このロジックは、JSONPリクエストの実装に似ています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e-/h5/ks/e-h5ks-gi2mnrck3jwkkogy9trk.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
長い間、この原則に取り組んできましたが、このアプローチの欠点は、サーバーの "アイドル"負荷とサーバーキャッシュを実装する必要性が追加されることです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプション＃2</font></font></b><br>
<br>
<pre><code class="xml hljs">
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://site.com/file.js"</span> [<span class="hljs-attr">async</span>]&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">”text/javascript”</span>&gt;</span><span class="javascript">
	<span class="hljs-built_in">window</span>.serviceNameId = “<span class="hljs-number">123</span>”;
	<span class="hljs-comment">//</span>
	ServiceNameModule.init({<span class="hljs-attr">id</span>: “<span class="hljs-number">123</span>”});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期属性-DOMを構築するためにスクリプトが読み込まれるのを待つ必要がないことをブラウザーに通知します。読み込み直後にスクリプトを実行する必要があります。これにより、ページの読み込み時間が短縮されますが、コインの裏返しもあります。DOMが機能する前にスクリプトを実行できます。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
大規模なサービスを含む最も人気のある実装の1つがそれを行います。構文のみが異なりますが、本質は誰にとっても同じです。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ga/9x/as/ga9xasvv7abeeu_f29q-y8zcqze.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチには2つの主な欠点があります。1つ目は-埋め込みコードが複雑であり、2つ目は-このコードの実行順序が非常に重要です。それ以外の場合は何も機能しません。さらに、速度（非同期）と安定性（非同期なし）のどちらかを選択する必要があります。ほとんどは2番目のオプションを選択します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプション＃3</font></font></b><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://site.com/file.js?id=123"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のオプションと同様に、リンクのIDをファイルに転送しますが、サーバーではなくブラウザーで取得します。見た目ほど単純ではありませんが、それは可能です。ブラウザーAPIにはdocument.currentScriptプロパティがあり、ロードされ、現在ブラウザーで実行されているスクリプトへのリンクを返します。これを知っていれば、IDを計算できます。これには、document.currentScript.srcプロパティを取得して、定期的にIDを抽出する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p7/mc/jf/p7mcjfln8bnay8g2myb3289vt8y.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つだけありますが、document.currentScriptはすべてのブラウザーでサポートされているわけではありません。このプロパティをサポートしていないブラウザのために、興味深いハックを思いつきました。 file.jsコードでは、try / catchにラップされた特別な「偽の」例外をスローできます。その後、エラースタックでエラーが発生したスクリプトのURLがスローされます。 URLには、同じ規則で取得したIDが含まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この種の魔法は得られますが、機能します。</font><font style="vertical-align: inherit;">実行順序に問題はなく、挿入コードは単純に見え、サーバーにオーバーヘッドはありません。</font><font style="vertical-align: inherit;">過去2年間、挿入コード自体は異なりますが、原則は同じですが、このようなアプローチのみを使用しています。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどの場合、プラグインスクリプトには、作業の外観やロジックに関与する設定があります。</font><font style="vertical-align: inherit;">これらの設定は、プラグインスクリプトに「スロー」する必要があります。これには、根本的に異なる2つのアプローチがあります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプローチ＃1</font></font></b><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://site.com/file.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">”text/javascript”</span>&gt;</span><span class="javascript">
	<span class="hljs-built_in">window</span>.serviceName = {<span class="hljs-attr">color</span>: “red”, <span class="hljs-attr">title</span>: “”, ...};
	<span class="hljs-comment">//</span>
	ServiceNameModule.init({<span class="hljs-attr">color</span>: “red”, <span class="hljs-attr">title</span>: “”, ...});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法には、「識別」セクションのオプション＃1と同様に、GETパラメーターの設定をスクリプトのURLに渡すことも含まれます。アプローチは、クライアントが設定を変更したい場合、埋め込みコードを編集してサイトで更新する必要があるというものです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lo/ua/-n/loua-nwuth3l7a0vbilxtu8ilmk.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての設定はクライアントに保存され、サーバーに保存する必要がないため、これに関連しています。これに関連するすべてのビジネスロジックを開発および保守する必要があります。このアプローチの主な欠点は、クライアントにとって不便なことです。手動ですべてを実行する必要があり、多くの設定がある場合、埋め込みコードは保守が困難なシートになり、間違いが起こりやすくなります。そして、更新を有効にするには、サイトを更新する必要があります。これは、開発者と管理者の追加のジェスチャーです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプローチ＃2</font></font></b><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://site.com/file.js?id=123"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の方法は、設定を変更する必要がある場合、クライアントが挿入コードを変更する必要がなく、すべての設定がサーバーに保存されることです。</font><font style="vertical-align: inherit;">設定を変更するには、グラフィックパネルに移動し、必要なパラメータを変更して、[保存]ボタンをクリックします。</font><font style="vertical-align: inherit;">その後、設定は彼のサイトに自動的に適用されます！</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yq/xb/no/yqxbnominbt8r7_sj3ng0mib9wc.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを理解してこれをデプロイする必要はありません。これは、マネージャーなど、JavaScriptから遠く離れた人が行うことができます。</font><font style="vertical-align: inherit;">もちろん、ユーザーにとっては、このオプションの方がはるかに便利でシンプルなので、このオプションを使用しています。</font><font style="vertical-align: inherit;">しかし、あなたは便宜のためにお金を払わなければなりません、このアプローチはサーバー上のロジックの開発とサポートを必要とし、それに追加の負荷を意味します。</font><font style="vertical-align: inherit;">以下の記事では、このようなリクエストを毎日1億5,000万件処理する方法を明確に説明します。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下位互換性</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
埋め込みコードの成熟したバージョンにできるだけ早く到達することが非常に重要です。</font><font style="vertical-align: inherit;">すでにインストールされている挿入コードを更新することは非常に難しいためです。</font><font style="vertical-align: inherit;">私たちの実践の例：最初のバージョンでは数値のIDを使用しましたが、セキュリティ上の理由から英数字のIDに置き換えました。</font><font style="vertical-align: inherit;">既にインストールされている埋め込みコードを変更することは非常に難しいことがわかりました。</font><font style="vertical-align: inherit;">多くの人は、HTMLとは何か、サイトがどのように配置されているかさえ知りません。</font><font style="vertical-align: inherit;">たとえば、ウェブサイトがフリーランサーによって作成された、スタジオまたはウェブサイトがCMS /コンストラクターなどを介して作成されたなど。ほとんどの場合、クライアントはウィジェット設定パネルでのみ機能します。</font><font style="vertical-align: inherit;">それ以来、nginxには、古いIDを新しいIDに書き換えるマップがまだあります。これには、約40Kのエントリがあります。</font></font><br>
<br>
<pre><code class="xml hljs"><font></font>
....<font></font>
/script/widget/config/15**90 /script/widget/config/bqZB**rjW5;<font></font>
/script/widget/config/15**94 /script/widget/config/qtfx**xnTi;<font></font>
/script/widget/config/15**95 /script/widget/config/fqmpa**4YX;<font></font>
/script/widget/config/15**97 /script/widget/config/Vr21g**nuT;<font></font>
/script/widget/config/15**98 /script/widget/config/8NXL5**F8E;<font></font>
/script/widget/config/15**00 /script/widget/config/Th2HN**6RJ;<font></font>
....<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能のため、すべてのリファクタリングの埋め込みコードの下位互換性を維持する必要があります。これらのリファクタリングは、メモリ内に約5個ありました。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードの分離</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトは、サイトおよび他のサービス用のJavaScriptおよびCSSコードがすでにあるサードパーティのサイトに接続されているため、主な目的は、サイトに害を与えず、コードによってロジックが変更されないようにすることです。これは、実行のフローを停止するJavaScriptエラー、またはサイトスタイルを上書きするスタイルである可能性があります。ただし、サイトコードは接続されたスクリプトにも影響を与える可能性があります。たとえば、ブラウザAPIを変更するライブラリが使用された後、コードが機能しなくなるか、期待どおりに機能しなくなります。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="javascript">
   <span class="hljs-comment">//  mootools.js</span>
   <span class="hljs-keyword">var</span> <span class="hljs-built_in">JSON</span> = <span class="hljs-keyword">new</span> Hash({
       <span class="hljs-attr">encode</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{},
       <span class="hljs-attr">decode</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{}
       <span class="hljs-comment">// ...</span>
   });
   <span class="hljs-comment">//   </span>
   <span class="hljs-built_in">JSON</span>.parse(json); <span class="hljs-comment">// Uncaught TypeError: JSON.parse is not a function</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span><font></font>
   //     <font></font>
   body * {<font></font>
       padding: 20px;<font></font>
   }<font></font>
   form input {<font></font>
       display: block;<font></font>
       border: 2px solid red;<font></font>
   }<font></font>
<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを分離するためのさまざまなオプションがあります。</font><font style="vertical-align: inherit;">たとえば、JS変数、クロージャーでプレフィックスを使用して、グローバルコンテキストを詰まらせないように、スタイルにはBEMのようなものを使用できます。</font><font style="vertical-align: inherit;">しかし、最も簡単な方法は、iframeでコードを実行することです。これにより、分離の問題のほとんどが解決されますが、特定の制限が課されます。</font><font style="vertical-align: inherit;">ハイブリッドバージョンを使用しています。コード分離については、次の記事で詳しく説明します。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み込みサイトをブロック</font></font></font></h3><br>
<img src="https://habrastorage.org/webt/1l/wr/du/1lwrdup_ictcih9u7ectyzgwsp4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Onloadイベント-画像、スタイル、外部スクリプトなど、Webページが完全に読み込まれた後に発生します。重要な機能は、ほとんどのサイトで、JSロジック、サードパーティのスクリプト、および広告がこのイベントの発生に対応し始めることです。接続されているすべてのスクリプトにとって非常に重要な点は、このイベントへの悪影響を防ぐことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、スクリプトのロード元のサーバーが長時間応答するか、まったく応答しない場合に発生します。onloadイベントが遅延し、ページのロードが実質的にブロックされます。サーバーが使用できない場合、onloadイベントは、リクエストがタイムアウトした後（60秒以上）にのみ発生します。したがって、スクリプトアップロードサーバーの問題は本質的にサイトを「破壊」しますが、これは受け入れられません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">個人的体験</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前は、オンラインで同時に10万人のオンラインデートが可能なウェブサイトを持つ会社で働いていました。当時、「ソーシャルネットワークで共有」ボタンが人気でした。それらがサイトに表示されるようにするには、目的のソーシャルネットワークからのスクリプト（sdk）を接続する必要がありました。ある日、同僚が私たちに駆け寄り、私たちのサイトが機能していないと言った！私たちはすべてが問題のない監視を見て、最初は問題が何であるか理解できませんでした。彼らがより深く掘り始めたとき、彼らはTwitterのcdn-serversが横になっていて、彼らのSDKがロードできなかったことに気づきました、これはサイトを約1.5分間ロードすることをブロックしました。つまり、サイトが開かれた後、小さなHTML（残りのSPA）が読み込まれ、1.5分後にすべてが読み込まれた後、リクエストのタイムアウトが機能しました。修正プログラムを緊急に整理し、そのスクリプトをサイトから削除する必要がありました。この状況を繰り返した後、Shareブロックをまったく削除することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
挿入コードの最初のバージョンでは、これを考慮していませんでした。また、技術的な問題が発生した場合、穏やかに言えば、お客様にご迷惑をおかけしましたが、時間の経過とともに修正しました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">決定</font></font></b><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span>&gt;</span><span class="javascript">
   (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
       <span class="hljs-keyword">var</span> initCode = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
         <span class="hljs-comment">// insert script tag</span>
       };
       <span class="hljs-built_in">document</span>.readyState === <span class="hljs-string">'complete'</span> ?
           initCode() :
           w.addEventListener(<span class="hljs-string">'load'</span>, initCode, <span class="hljs-literal">false</span>);
   })();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解決策は簡単です。サイトが完全に読み込まれた場合のイベントをサブスクライブして、スクリプトをダウンロードするだけです。これには、スクリプトタグではなく、埋め込みコードを使用する必要があります。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google pagespeed</font></font></font></h3><br>
<br>
<img src="https://habrastorage.org/webt/ur/b9/4t/urb94tbcz9obpytp_da8ed27c8s.png"><br>
<i><font style="vertical-align: inherit;"></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの研究によると</font><i><font style="vertical-align: inherit;">、habr.comのモバイルバージョンの分析結果は</font></i><font style="vertical-align: inherit;">サイトの読み込み速度に注意を払っています。これは利益に直接影響します。さらに、検索アルゴリズムは、ランキング時にページの読み込み時間を考慮し始めました。この点で、サイトの所有者は多くの場合、同様のツールを使用してサイトのパフォーマンスを評価します。したがって、ダウンロード時間に直接影響するため、コードをサイトに最適に接続することが非常に重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、ページの読み込みを最適化するには、最新の手法を使用する必要があります。</font><font style="vertical-align: inherit;">たとえば、Gzipを使用し、静的ファイルとリクエストをキャッシュし、非同期スクリプトロードを使用し、WebP / Brotli /などの最新のアルゴリズムで静的を圧縮し、他の最適化を使用します。</font><font style="vertical-align: inherit;">私たちは定期的に監査を実施し、現在の要件を満たすために警告や推奨事項に対応しています。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CDN</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のバージョンでは、アプリケーションサーバーから統計情報をダウンロードしました。しかし、このアプローチには欠点があります。高額なトラフィック、サイト訪問者からの遠隔性、サーバーチャネルへの過度の負荷です。静的なトラフィックは非常に「重い」ため、サイトの影響でアプリケーションサーバーチャネルを簡単に詰まらせる可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
予算、安定性を節約し、ネットワーク遅延を減らすために、これのために特別に設計されたサーバーから静的データをダウンロードすることが最適です。既製のCDNプロバイダーを使用できますが、大規模な場合は安くはなく、このプロバイダーまたはそのプロバイダーが提供する機能によって制限される必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vi/jy/f3/vijyf3bxfqmihwwfswlfqzxtqie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはそれを単純に実装し、無制限のトラフィックと幅広いチャネルを備えたロシア、ヨーロッパ、アメリカに安価なサーバーを注文しました。</font><font style="vertical-align: inherit;">安価であり、制限はありません。すべてを自分でカスタマイズでき、ブラウザで機能するメカニズムによってフォールトトレランスが確保されます。</font><font style="vertical-align: inherit;">現在、1 TBの統計情報がCDNサーバーから毎日読み込まれています。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">耐障害性</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、世界は完璧ではなく、火災が発生し、アップリンクが落ち、DCが完全に水没し、ILVがサブネットをブロックし、人々がミスを犯しています。それにもかかわらず、そのような状況を処理し、作業を継続できることが必要です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">監視</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
まず、何かがうまくいかなかったことを理解する必要があります。もちろん、ユーザーが不満を言うまで待つこともできますが、監視とアラートを設定し、リリース後にすべてが正常かどうかを確認することをお勧めします。サーバーとクライアントの両方でさまざまなパラメーターを監視し、問題が発生した場合はすぐに確認します。たとえば、ウィジェットのダウンロード数やCDNサーバー上のトラフィックの異常な急増が減少しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z7/kp/dq/z7kpdqcble85t395hv7z_bqt8fg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各バージョンのウィジェットダウンロードの総数</font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーコレクション</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JavaScriptは非常に特殊な言語であり、間違いを犯しやすいです。さらに、最新のWeb上のブラウザの動物園は非常に大きいです。最新のChromeで機能するものは、SafariまたはFirefoxで機能するという事実ではありません。したがって、ブラウザーからエラー収集を構成し、時間の急上昇に対応することが非常に重要です。コードがiframeで機能する場合は、グローバルwindow.onerrorハンドラーを追跡することでこれを実行でき、エラーの場合はサーバーにデータを送信できます。コードがiframeの外部で機能する場合、エラーコレクションを実装することは非常に困難です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g-/d6/jd/g-d6jddyvo9gpslniix1ndyvo1y.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのサイトおよびブラウザからのエラーの総数</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/3w/fp/ju/3wfpjuzxcyzpfervxtkq6o_zx10.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のエラーに関する情報</font></font></i><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CDNフェイルオーバー</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はすでにすべてが落下の性質を持っているので、これらの状況をよりよく処理することが重要です-自動的に。マニュアルから始めて、CDNサーバーのフォールバックのいくつかの段階を経て、最終的にこれをブラウザーに対して自動的かつ最適に行う方法を見つけました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手動モードでは、これは簡単に機能しました。SMSは、CDNがダウンしていると言う管理者を受け取り、特定の操作を実行した後、ウィジェットがアプリケーションサーバーからロードを開始しました。これには5分から2時間かかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動フォールバックを実装するには、スクリプトがロードを開始したことを何らかの方法で検出する必要がありますが、これは見かけほど簡単ではありません。ブラウザは、XMLHttpRequestのonprogressイベントなど、スクリプトタグの読み込みの中間状態を監視する機能を提供していませんが、スクリプトの読み込みと実行が完了したときにのみイベントを報告します。また、サーバーが現在利用できないことを許容時間で確認することもできません。唯一のonerrorイベントは、リクエストのタイムアウト後、1分以上トリガーされます。 1分後に、訪問者は既にページを離れている可能性がありますが、スクリプトは読み込まれません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シンプルなオプションと複雑なオプションを試してみましたが、最終的にはCDNサーバーに対するpingリクエストを思いつきました。</font><font style="vertical-align: inherit;">これは次のように機能します。最初にCDNサーバーにpingを送信し、応答があれば、ウィジェットをサーバーからロードします。</font><font style="vertical-align: inherit;">このスキームをブラウザーとサーバーに最適に実装するには、軽量のHEADリクエスト（ボディなし）を使用します。その後のダウンロードでは、ウィジェットがブラウザーキャッシュに既にあるため、ウィジェットのバージョンが更新されるまで実行しません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r-/zf/gh/r-zfghwbzyarwvybwbdkbaaz5py.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようにして、静的サーバーの可用性を非常に高速かつ自動的に検出し、障害が発生した場合、ほぼ遅延なくバックアップサーバーに切り替えました。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローダ</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトをサードパーティのサイトにアップロードするには、多くの点を考慮する必要がありますが、単に「肉」になるため、埋め込みコードにこのロジックを実装することは困難です。しかし、まだこれを行う必要があります。このために、「内部」でこのすべてのロジックを管理し、ウィジェットのメインコードをロードする小さなモジュールを作成しました。最初にロードし、CDNフェイルオーバー、キャッシング、古い埋め込みコードとの下位互換性、A / Bテスト、新しいバージョンのウィジェットの段階的なレイアウト、およびその他の多くの機能を実装します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-e/pj/-j/-epj-jpym6xcdxu9bk7axxtmtsa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、段階的に、ウィジェットのロードと初期化の主なケースをカバーするスキームに到達しました。</font><font style="vertical-align: inherit;">多数の異なるサイトで長年使用されており、その効果が証明されています。</font><font style="vertical-align: inherit;">同時に、挿入コードにはロジックがなく、いつでも変更できるため、ユーザーに挿入コードの変更を強制しないため、挿入コードは単純で普遍的なままです。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第三者サービス</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に、サイトに接続する、または何らかの方法でサイトと対話するサードパーティのサービス（検索ボット、分析、さまざまなパーサーなど）について言及する価値があります。</font><font style="vertical-align: inherit;">これらのサービスは仕事の痕跡を残します、これも忘れないでください。</font><font style="vertical-align: inherit;">私たちの実践からいくつかのケースをお話します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Googlebot</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オペレーターのアプリケーションには「ビジター」機能があり、現在サイトを閲覧しているビジターと、サイトに関する時間、ページ、閲覧したページ数などのさまざまな情報を確認できます。ある時点で、顧客は他のサイト、つまりiPhoneを販売しているサイトで「フェイスクリームを購入する」というページがあると思われるクライアントからの訪問者を「絞首刑」にしていると不満を感じ始めました。彼らがそれを理解し始めたとき、それはGoogleBotであることがわかりました。サイトからサイトに切り替えるとき、最初にLocalStorageをキャッシュし、その後不正なデータをサーバーに転送しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソリューションはシンプルで、サーバーはGoogleBotからのデータを無視し始めました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Metrica</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指標にはすばらしい機能があります。ユーザーがスクリーンキャストの形式で見たり行ったりしたことを確認できるWebビューアです。これを行うために、メトリックはすべてのユーザーアクションを記録し、特別なメトリックボットがサイトを歩き回った後、同じアクションを実行してこれを記録します。私たちのデータによると、問題はユーザーのモバイルブラウザーをエミュレートするために、Firefoxがモバイルエミュレーションモードでオンにされていましたが、ボットのuserAgentはデスクトップでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、Webブラウザーでモバイルユーザーセッションを表示すると、記録でウィジェットのデスクトップバージョンが開きましたが、実際にはユーザーがモバイルバージョンを開きました。</font><font style="vertical-align: inherit;">お客様はそうだと思って、苦情をぶつけました。</font><font style="vertical-align: inherit;">その結果、ウィジェットがWebブラウザーに読み込まれたことを検出し、モバイルバージョンがウィジェットで開かれていることを理解する必要がありました。この場合、モバイルウィジェットをそこから離しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例はもっとたくさんありますが、ポイントを理解するにはこれで十分だと思います。</font></font><br>
<br>
<h3><font color="#00bf54"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイトに挿入するために顧客に提供するコードには、非常に注意が必要です。</font><font style="vertical-align: inherit;">発生した問題とその解決方法について簡単に説明しました。</font><font style="vertical-align: inherit;">次の記事では、言及されているトピックの一部とシステムの他の部分について詳しく説明します。たとえば、NodeJSをバックエンドとして使用する方法、思慮深いキャッシングによりすべての270Kサイトの負荷を維持する方法、および接続されているサイトの悪影響を恐れない方法、作業方法完全に分散したチームなどで。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご清聴ありがとうございました。質問やコメントにお答えいたします！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja452792/index.html">企業ユーザー向けのソリッドステートSSDレビューKingston DC500R</a></li>
<li><a href="../ja452794/index.html">製品のローカライズについて。パート1：どこから始めますか？</a></li>
<li><a href="../ja452796/index.html">GeekUniversityゲーム開発部門の会議に招待します</a></li>
<li><a href="../ja452798/index.html">写真やその他のファイルの保存と自動分類。NAS Synologyベースのファイルストレージを操作する</a></li>
<li><a href="../ja452800/index.html">微生物相。腸内細菌がどのように病気に影響するか</a></li>
<li><a href="../ja452804/index.html">商品開発に我慢できず夢の仕事を辞めた</a></li>
<li><a href="../ja452806/index.html">インタビュー-Swiftに関する10の質問。パート2</a></li>
<li><a href="../ja452808/index.html">プログラマーのチームの管理：どのようにそしてどのようにして彼らを正しく動機づけるか？二部</a></li>
<li><a href="../ja452812/index.html">Knutから0x $ 3.00の小切手を受け取りました</a></li>
<li><a href="../ja452816/index.html">2020年2月1日に何が起こりますか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>