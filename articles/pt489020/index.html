<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüöí üíë üï∫üèª O estudo de um malicioso üò¨ üéπ ü§µ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Me deparei com um arquivo doc recentemente malicioso que foi enviado com e-mails de phishing. Decidi que esse √© um bom motivo para praticar engenharia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>O estudo de um malicioso</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489020/"><img src="https://habrastorage.org/webt/ee/hd/a7/eehda7mpejjegq4jc2me1nvupy4.jpeg" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me deparei com um arquivo doc recentemente malicioso que foi enviado com e-mails de phishing. </font><font style="vertical-align: inherit;">Decidi que esse √© um bom motivo para praticar engenharia reversa e escrever algo novo sobre Habr. </font><font style="vertical-align: inherit;">Sob o gato - um exemplo de an√°lise de um conta-gotas de macro malicioso e dlls n√£o menos maliciosos.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Macro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sha256 do arquivo - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abb052d9b0660f90bcf5fc394db0e16d6edd29f41224f8053ed90a4b8ef1b519</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No pr√≥prio arquivo doc, na primeira p√°gina, h√° uma figura informando que esse arquivo est√° protegido e explicando como ativar macros; h√° duas tabelas grandes com n√∫meros no arquivo. Os n√∫meros s√£o escritos em forma decimal, os mais longos s√£o de dez d√≠gitos, s√£o positivos e negativos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando a v√≠tima permite a execu√ß√£o de macros (existem aquelas que a habilitam por padr√£o?), Uma cadeia de a√ß√µes √© iniciada, que finalmente executa a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que altera o diret√≥rio atual para um tempor√°rio e cria o arquivo "icutils.dll", no qual anota os n√∫meros da primeira tabela em uma linha como um inteiro de 32 bits com um sinal. </font><font style="vertical-align: inherit;">O resultado √© a dll correta. </font><font style="vertical-align: inherit;">A fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© importada desta dll </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="vbscript hljs">Declare PtrSafe <span class="hljs-keyword">Function</span> clone Lib <span class="hljs-string">"icutils.dll"</span> _<font></font>
(<span class="hljs-keyword">ByVal</span> Saved As <span class="hljs-built_in">String</span>, <span class="hljs-keyword">ByVal</span> <span class="hljs-built_in">Time</span> As Integer) As Boolean</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E come√ßa com dois par√¢metros:</font></font><br>
<br>
<pre><code class="vbscript hljs">R1 = Module1.clone(<span class="hljs-string">"Cream"</span>, <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se a chamada de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar False, o arquivo icutils.dll ser√° substitu√≠do pelos dados da segunda tabela e o clone com os mesmos par√¢metros ser√° chamado novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Olhando para o futuro, direi que a primeira DLL √© de 64 bits e n√£o ser√° executada em sistemas de 32 bits. </font><font style="vertical-align: inherit;">Portanto, a macro seleciona a arquitetura correta do c√≥digo bin√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Curiosamente, a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> possui um peda√ßo de c√≥digo que n√£o possui finalidade funcional:</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">Sub</span> updatedb_network()<font></font>
...<font></font>
<span class="hljs-keyword">Dim</span> query_to_change As Variant
    <span class="hljs-keyword">Set</span> query_to_change = CurrentDb.QueryDefs(<span class="hljs-string">"query_name"</span>)<font></font>
    <font></font>
    query_to_change.SQL = <span class="hljs-string">"SELECT * FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE Fashion"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE '"</span> &amp; something &amp; <span class="hljs-string">"'"</span><font></font>
...<font></font>
<span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Talvez ele esteja aqui para dar a apar√™ncia de um trabalho √∫til para quem rapidamente l√™ o c√≥digo, v√™ algumas linhas no SQL e acha que est√° tudo bem? </font><font style="vertical-align: inherit;">Eu n√£o sei. </font><font style="vertical-align: inherit;">Al√©m disso, a maioria das fun√ß√µes e vari√°veis ‚Äã‚Äãpossui nomes aleat√≥rios ou com nomes n√£o reais (como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que n√£o interage com o banco de dados ou a rede). </font><font style="vertical-align: inherit;">Embora exista, por exemplo, a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dump_payload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que armazena 4 bytes no icutil.dll. </font><font style="vertical-align: inherit;">Mas, em qualquer caso, a presen√ßa da fun√ß√£o </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Document_Open</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve alertar imediatamente </font><font style="vertical-align: inherit;">, os autores do malware n√£o podem renome√°-lo arbitrariamente (embora possam usar outra fun√ß√£o iniciada automaticamente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a funcionalidade da macro √© mais ou menos clara, √© hora de descarregar a dll e prosseguir com a an√°lise.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeira dll</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira dll (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7427cc4b6b659b89552bf727aed332043f4551ca2ee2126cca75fbe1ab8bf114</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) de 64 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lista de fun√ß√µes importadas cont√©m as fun√ß√µes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (in√≠cio do programa), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (criando um encadeamento em </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outro</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processo), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (alocando um bloco de mem√≥ria em </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outro</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processo), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (gravando na mem√≥ria de </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outro</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processo), o que sugere imediatamente a inje√ß√£o de c√≥digo em outro processo. Agora vamos ver o que exatamente ela faz usando o IDA Free e o Ghidra.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ponto de entrada principal simplesmente retorna 1, n√£o faz mais nada. A segunda fun√ß√£o exportada √© o clone, que √© chamado pela macro e cont√©m c√≥digo malicioso. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os par√¢metros com os quais √© chamado n√£o parecem afetar nada. O aplicativo descriptografa dois blocos de dados. O primeiro bloco de dados tem 0x78 de comprimento com o seguinte conte√∫do (j√° descriptografado):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d&lt;\x04\xe0\x1d\xe6\x00\xde\x01\xa4\x17\xbc\x03x\x01\xe0\x1d\xe2\x16x\x07Qy\xbc\x03@Fx\x07Df\xbc\x03\x89a\xde\x01q\x11\xe0\x1d|Ix\x07D@\xbc\x03\x8a\x01\xde\x01^9\xde\x01\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d\xab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo bloco de dados tem 0x1D4C e cont√©m c√≥digo execut√°vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, um ponteiro para o m√≥dulo kernel32, o resultado da fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTickCount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () e o endere√ßo da fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwDelayExecution</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () do kernel32 s√£o </font><font style="vertical-align: inherit;">gravados na estrutura de 0x90 bytes </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, o processo ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) "cmd.exe" √© criado. Usando o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dois buffers s√£o alocados nele: com permiss√µes de RW com um comprimento de 0x108 e com permiss√µes de RWX com um comprimento de 0x1D4C. O buffer RW copia o bloco de dados acima e a estrutura mencionada com um comprimento de 0x90. A estrutura tamb√©m grava um ponteiro no bloco de dados descriptografado (no espa√ßo de endere√ßo do processo filho (cmd.exe)). No RWX, o buffer √© copiado ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) descriptografou o bloco de dados com o c√≥digo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, no processo cmd.exe, um fluxo ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) √© criado com um ponto de entrada no in√≠cio do buffer RWX, um ponteiro para o buffer RW √© passado como argumento. </font><font style="vertical-align: inherit;">Isso completa a fun√ß√£o clone, a a√ß√£o continua no processo cmd.exe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Curiosamente, a fun√ß√£o clone parece ser um peda√ßo de c√≥digo inating√≠vel que importa ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibraryW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) a biblioteca </font><font style="vertical-align: inherit;">" </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WorkPolyhistor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo injetado no cmd.exe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele executa as seguintes a√ß√µes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localiza os endere√ßos das fun√ß√µes necess√°rias no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel32.dll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (o endere√ßo √© obtido no processo pai)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carrega </font><i><font style="vertical-align: inherit;">bibliotecas </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntdll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ole32</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User32</font></font></i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Localiza endere√ßos de fun√ß√µes necess√°rias nessas bibliotecas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Curiosamente, para a maioria das fun√ß√µes no c√≥digo, n√£o h√° nome da fun√ß√£o, mas apenas o CRC32 em nome de (todos os nomes de fun√ß√µes da biblioteca carregada s√£o pesquisados ‚Äã‚Äãat√© que haja uma fun√ß√£o com o CRC32 desejado em nome de). </font><font style="vertical-align: inherit;">Talvez seja uma prote√ß√£o contra a obten√ß√£o da lista de fun√ß√µes importadas pelo utilit√°rio strings, embora seja estranho que o c√≥digo armazenado na forma criptografada tenha essa prote√ß√£o, enquanto a pr√≥pria DLL importa fun√ß√µes simplesmente pelo nome. </font><font style="vertical-align: inherit;">No total, as seguintes fun√ß√µes s√£o detectadas: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kernel32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetProcAddress</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Loadlibrary</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalalloc</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetTempPath </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetFileAttributesW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateProcessW </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalfree </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GlobalRealloc </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Writefile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateFileW (encontrado pelo nome)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Writefile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Closehandle</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gettickcount</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ReadFile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetfileSize</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntdll:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RtlCreateUnicodeStringFromAsciiz</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwDelayExecution</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwTerminateProcess</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> swprintf</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ole32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoInitialize (encontrado pelo nome)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoCreateInstance (encontrado pelo nome)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
msvcrt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> rand</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> srand</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, o processo usando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTempPath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> obt√©m o caminho para o diret√≥rio tempor√°rio, cria um arquivo nele com o nome 26342235.dat, em que o nome do arquivo √© o registro decimal de TickCount recebido do processo pai e itera a cada nova tentativa (ou seja, se o download falhar) na primeira tentativa, na segunda tentativa, um arquivo ser√° criado com o nome 26342236.dat). </font><font style="vertical-align: inherit;">Depois disso, a biblioteca wininet √© carregada e h√° ponteiros para as seguintes fun√ß√µes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetCloseHandle (crc32: 0xe5191d24)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState (crc32: 0xf2e5fc0c)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenA (crc32: 0xda16a83d)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenUrlA (crc32: 0x16505e0)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetReadFile (crc32: 0x6cc098f5)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verificado se existe uma rede - caso contr√°rio, o aplicativo chama o endere√ßo inexistente e cai (essa prote√ß√£o determina o endere√ßo em que ele gira o peyload usando isolado da rede da m√°quina √© o √∫nico caso em que o aplicativo termina de forma anormal, o resto -. , ap√≥s o que o cmd.exe termina usando o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Se houver uma rede, usando as fun√ß√µes encontradas, a carga √∫til ser√° baixada da URL passada no processo pai (https://pastebin.com/raw/Jyujxy7z) e salva no arquivo criado anteriormente com a extens√£o .dat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, a carga √∫til √© lida no arquivo .dat, decodificado (base64), descriptografado usando XOR com CRC32 a partir da URL, verifique se os 2 primeiros bytes dos dados descriptografados s√£o 'MZ'; nesse caso, o resultado √© salvo em um arquivo com o mesmo nome, mas com extens√£o. Exe</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de descriptografia Python</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> crc32
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_payload</span>(<span class="hljs-params">payload_b64: bytes, url: str</span>):</span><font></font>
    payload_bin = b64decode(payload_b64.decode())<font></font>
    key = str(crc32(url.encode())).encode()<font></font>
    decrypted = bytearray()<font></font>
    <span class="hljs-keyword">for</span> i, b <span class="hljs-keyword">in</span> enumerate(payload_bin):<font></font>
        decrypted.append(b ^ key[i % len(key)])<font></font>
    <span class="hljs-keyword">return</span> bytes(decrypted)
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando a fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o </font><font style="vertical-align: inherit;">arquivo salvo √© iniciado. </font><font style="vertical-align: inherit;">Se tudo der certo, o processo cmd.exe ser√° encerrado usando o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se algo der errado (exceto pela falta de rede), tudo ser√° repetido novamente, ser√£o feitas no m√°ximo 3 tentativas, os nomes dos arquivos dat e exe ser√£o aumentados em 1 a cada vez.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segunda DLL</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda dll (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">006200fcd7cd1e71be6c2ee029c767e3a28f480613e077bf15fadb60a88fdfca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 32 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nele, a principal funcionalidade maliciosa √© implementada na fun√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ele tamb√©m descriptografa 2 buffers. </font><font style="vertical-align: inherit;">O primeiro buffer tem 0x78 (120) bytes de tamanho, esses dados s√£o descriptografados e gravados nele (na forma descriptografada):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\x1e(\xf0\x0e\xc5r\xc0;\x12)\xc0;Jr\xc0;Y4\xbc\x03/Mx\x07\x038\xde\x01\x9e\x05\xe0\x1d#\x08\xbc\x03\xeeU\xf0\x0e\x18{x\x078\x1a\xf0\x0e\xccg\xf0\x0eze\xde\x01\x89&amp;\xe0\x1d\xf6\x1f\xe0\x1d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode-se observar que no in√≠cio existe a mesma URL da vers√£o x64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um segundo buffer de tamanho 0x4678 bytes √© alocado com permiss√µes RWX. </font><font style="vertical-align: inherit;">O c√≥digo √© descriptografado para ele, ap√≥s o qual uma fun√ß√£o √© chamada dele com um deslocamento de 0x4639 desde o in√≠cio do buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o analisei esse c√≥digo em detalhes. </font><font style="vertical-align: inherit;">Ele tamb√©m encontra fun√ß√µes no CRC32, lan√ßa o notepad.exe, injeta c√≥digo l√° que baixa carga √∫til da mesma URL no pastebin.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carga √∫til com pastebin</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A carga descriptografada com pastebin √© um arquivo exe de 32 bits (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9509111de52db3d9a6c06aa2068e14e0128b31e9e45ada7a8936a35ddfaf155f</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) Ainda n√£o o desmontei em detalhes devido √† falta de tempo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o malware me impressionou bastante mal escrito, com muitos erros (n√£o os chamo aqui intencionalmente). </font><font style="vertical-align: inherit;">Como se estivessem se preparando. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A DLL encontra na mem√≥ria fun√ß√µes que posteriormente n√£o s√£o usadas em nenhum lugar. </font><font style="vertical-align: inherit;">Talvez esse c√≥digo, como uma macro, seja reescrito regularmente por criminosos cibern√©ticos toda vez que ele come√ßa a ser detectado por antiv√≠rus, como resultado dos quais esses artefatos permanecem no c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m √© interessante que, na vers√£o ‚ÄúDLL‚Äù da DLL que √© ‚Äúsolta‚Äù no disco x64, os nomes das fun√ß√µes importadas ‚Äúperigosas‚Äù n√£o s√£o mascarados (voc√™ pode pelo menos v√™-las) e no c√≥digo que √© descriptografado na mem√≥ria e n√£o cabe no disco, eles est√£o localizados no CRC32 de nome, n√£o apenas pelo nome. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A carga √∫til da pasta foi removida alguns dias depois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KDPV retirado daqui</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt489008/index.html">Roteando em chatbots complexos com a estrutura Hobot</a></li>
<li><a href="../pt489010/index.html">Compartilhamos a maior camada de dados da R√∫ssia sobre aprendizado on-line com projetos em lingu√≠stica, personaliza√ß√£o, peddesign, ML</a></li>
<li><a href="../pt489012/index.html">Google Cloud Spanner: bom, ruim, mau</a></li>
<li><a href="../pt489014/index.html">O livro ‚ÄúAlgoritmo Perfeito. Algoritmos gananciosos e programa√ß√£o din√¢mica ¬ª</a></li>
<li><a href="../pt489016/index.html">Gref alem√£o: ‚ÄúTentamos organizar uma discuss√£o sobre a AGI, e nem um √∫nico cientista que se preze se interessou‚Äù</a></li>
<li><a href="../pt489022/index.html">Usando RabbitMQ com MonsterMQ Parte 2</a></li>
<li><a href="../pt489024/index.html">Biblioteca Webix JavaScript atrav√©s dos olhos de um iniciante. Parte 5. Trabalhe com dados no lado do usu√°rio</a></li>
<li><a href="../pt489026/index.html">Alterar os algoritmos do Google AdSense pode levar os propriet√°rios de sites e webmasters</a></li>
<li><a href="../pt489028/index.html">Sobre trabalho remoto</a></li>
<li><a href="../pt489034/index.html">O novo aplicativo m√≥vel UIS - tormento ou salva√ß√£o para quem procura contratos p√∫blicos?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>