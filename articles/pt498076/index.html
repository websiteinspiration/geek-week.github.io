<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüéì üóº ü§± Nossa experi√™ncia de migra√ß√£o do Cassandra entre clusters Kubernetes sem perda de dados üéè üòó üçá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nos √∫ltimos seis meses, usamos o operador Rook para trabalhar com Cassandra em Kubernetes . No entanto, quando precis√°vamos executar uma opera√ß√£o muit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nossa experi√™ncia de migra√ß√£o do Cassandra entre clusters Kubernetes sem perda de dados</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498076/"><img src="https://habrastorage.org/webt/bt/dz/eh/btdzeh5vf-wcqspevi_adr6exds.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos √∫ltimos seis meses, usamos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operador Rook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para trabalhar com Cassandra em Kubernetes </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">No entanto, quando precis√°vamos executar uma opera√ß√£o muito trivial, ao que parece: alterar os par√¢metros na configura√ß√£o do Cassandra, verificou-se que o operador n√£o fornecia flexibilidade suficiente. </font><font style="vertical-align: inherit;">Para fazer altera√ß√µes, era necess√°rio clonar o reposit√≥rio, fazer altera√ß√µes nas fontes e reconstruir o operador (a configura√ß√£o √© incorporada ao pr√≥prio operador, portanto, o conhecimento do Go ainda √© √∫til). </font><font style="vertical-align: inherit;">Tudo isso leva muito tempo. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">J√° fizemos uma</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
revis√£o dos operadores existentes </font><font style="vertical-align: inherit;">e, desta vez, paramos no </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">CassKop da Orange</font></a><font style="vertical-align: inherit;"> , que suporta os recursos necess√°rios, em particular configura√ß√µes personalizadas e monitoramento </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">imediato</font></a><font style="vertical-align: inherit;"> .</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarefa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na hist√≥ria real, que ser√° discutida mais adiante, foi decidido combinar a mudan√ßa de operador com a necessidade urgente de transferir toda a infraestrutura do cliente para o novo cluster. </font><font style="vertical-align: inherit;">Ap√≥s a migra√ß√£o das principais cargas de trabalho de aplicativos importantes, apenas Cassandra permaneceu, a perda de dados para a qual, √© claro, era inaceit√°vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Requisitos para sua migra√ß√£o:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O tempo ocioso m√°ximo √© de 2 a 3 minutos para efetivamente realizar essa transfer√™ncia ao mesmo tempo em que o pr√≥prio aplicativo √© transferido para um novo cluster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Transfira todos os dados sem perda e dor de cabe√ßa (ou seja, sem manipula√ß√µes adicionais).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como realizar essa opera√ß√£o? Por analogia com o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , decidimos lan√ßar uma nova instala√ß√£o do Cassandra em um novo cluster Kubernetes, depois mesclar os dois Cassandra em diferentes clusters e transferir os dados, encerrando todo o processo, simplesmente desativando a instala√ß√£o original.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, era complicado pelo fato de as redes dentro do Kubernetes se cruzarem, por isso n√£o era t√£o f√°cil configurar a conex√£o. </font><font style="vertical-align: inherit;">Era necess√°rio registrar rotas para cada pod em cada n√≥, o que consome muito tempo e n√£o √© confi√°vel. </font><font style="vertical-align: inherit;">O fato √© que a comunica√ß√£o por pods IP funciona apenas com mestres e o Cassandra est√° sendo executado em n√≥s dedicados. </font><font style="vertical-align: inherit;">Portanto, voc√™ deve primeiro configurar a rota para o mestre e j√° no mestre - para outro cluster. </font><font style="vertical-align: inherit;">Al√©m disso, reiniciar o pod implica uma altera√ß√£o no IP, e esse √© outro problema ... Por que? </font><font style="vertical-align: inherit;">Leia sobre isso mais adiante neste artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na parte pr√°tica subsequente do artigo, ser√£o utilizadas tr√™s nota√ß√µes para os clusters de Cassandra:</font></font><br>
<br>
<ul>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a nova instala√ß√£o que lan√ßaremos no novo cluster Kubernetes;</font></font></li>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - uma instala√ß√£o antiga com a qual os aplicativos est√£o trabalhando atualmente;</font></font></li>
<li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© uma instala√ß√£o tempor√°ria que executamos ao lado de Cassandra-current e a usamos apenas para o pr√≥prio processo de migra√ß√£o.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como ser?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa armazenamento local, uma simples migra√ß√£o de seus dados para um novo cluster - isso pode ser, por exemplo, no caso de discos vSphere ... - √© imposs√≠vel. </font><font style="vertical-align: inherit;">Para resolver esse problema, criaremos um cluster tempor√°rio, usando-o como um tipo de buffer para migra√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A sequ√™ncia geral de a√ß√µes √© reduzida para as seguintes etapas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new com um</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> novo operador em um novo cluster.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escale para 0 </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-novo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cluster </font><font style="vertical-align: inherit;">.</font></font></li>
<li>  ,  PVC,    .</li>
<li>  <i>Cassandra-temporary</i>       <i>Cassandra-current</i> ,      <i>Cassandra-new</i>.</li>
<li>   <i>Cassandra-temporary</i>  0 (     )    <i>Cassandra-temporary</i> ,  <i>Cassandra-temporary</i>   <i>Cassandra-current</i>.      <b></b> Cassandra  <b></b> <i>-</i> (       Cassandra     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>).</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfira dados entre os datacenters </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempor√°rios</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atuais do Cassandra</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escale os clusters </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para 0 e execute </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no novo cluster, sem esquecer de lan√ßar os discos. </font><font style="vertical-align: inherit;">Paralelamente, lan√ßamos aplicativos para um novo cluster.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de tais manipula√ß√µes, o tempo de inatividade ser√° m√≠nimo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em detalhe</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o deve haver problemas com as tr√™s primeiras etapas - tudo √© feito de maneira r√°pida e f√°cil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse ponto, o cluster </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atual</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font><i><font style="vertical-align: inherit;">Cassandra</font></i><font style="vertical-align: inherit;"> ter√° algo parecido com isto:</font></font><br>
<br>
<pre><code class="bash hljs">Datacenter: x1<font></font>
==============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address     Load       Tokens       Owns    Host ID                               Rack<font></font>
UN  10.244.6.5  790.7 GiB  256          ?       13cd0c7a-4f91-40d0-ac0e-e7c4a9ad584c  rack1<font></font>
UN  10.244.7.5  770.9 GiB  256          ?       8527813a-e8df-4260-b89d-ceb317ef56ef  rack1<font></font>
UN  10.244.5.5  825.07 GiB  256          ?       400172bf-6f7c-4709-81c6-980cb7c6db5c  rack1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar se tudo funciona como esperado, crie um espa√ßo de chave no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Isso √© feito antes do lan√ßamento do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">create keyspace example with replication ={'class' : 'NetworkTopologyStrategy', 'x1':2};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, crie uma tabela e preencha-a com dados:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">use</span> example;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> example(<span class="hljs-keyword">id</span> <span class="hljs-built_in">int</span> PRIMARY <span class="hljs-keyword">KEY</span>, <span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>, phone varint);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>,<span class="hljs-string">'Masha'</span>, <span class="hljs-number">983123123</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>,<span class="hljs-string">'Sergey'</span>, <span class="hljs-number">912121231</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> example(<span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span>, phone) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">3</span>,<span class="hljs-string">'Andrey'</span>, <span class="hljs-number">914151617</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lembrando que antes disso, no novo cluster, j√° lan√ßamos o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (etapa 1) e agora est√° desativado (etapa 2). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando iniciamos o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , devemos especificar o mesmo nome (com o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) do cluster. </font><font style="vertical-align: inherit;">Isso pode ser feito atrav√©s de uma vari√°vel </font></font><code>CASSANDRA_CLUSTER_NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para que o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> veja o cluster atual, √© necess√°rio definir as sementes. </font><font style="vertical-align: inherit;">Isso √© feito atrav√©s de uma vari√°vel </font></font><code>CASSANDRA_SEEDS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou de uma configura√ß√£o.</font></font></li>
</ol><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aten√ß√£o! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de come√ßar a mover dados, voc√™ deve garantir que os tipos de consist√™ncia de leitura e grava√ß√£o estejam definidos como </font></font><code>LOCAL_ONE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>LOCAL_QUORUM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in√≠cio </font><i><font style="vertical-align: inherit;">tempor√°rio do Cassandra</font></i><font style="vertical-align: inherit;"> , o cluster deve ficar assim (observe a apar√™ncia de um segundo data center com 3 n√≥s):</font></font><br>
<br>
<pre><code class="plaintext hljs">Datacenter: x1<font></font>
==============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address     Load       Tokens       Owns    Host ID                               Rack<font></font>
UN  10.244.6.5  790.7 GiB  256          ?       13cd0c7a-4f91-40d0-ac0e-e7c4a9ad584c  rack1<font></font>
UN  10.244.7.5  770.9 GiB  256          ?       8527813a-e8df-4260-b89d-ceb317ef56ef  rack1<font></font>
UN  10.244.5.5  825.07 GiB  256          ?       400172bf-6f7c-4709-81c6-980cb7c6db5c  rack1<font></font>
<font></font>
Datacenter: x2<font></font>
===============<font></font>
Status=Up/Down<font></font>
|/ State=Normal/Leaving/Joining/Moving<font></font>
--  Address       Load       Tokens       Owns (effective)  Host ID                               Rack<font></font>
UN  10.244.16.96  267.07 KiB  256          64.4%             3619841e-64a0-417d-a497-541ec602a996  rack1<font></font>
UN  10.244.18.67  248.29 KiB  256          65.8%             07a2f571-400c-4728-b6f7-c95c26fe5b11  rack1<font></font>
UN  10.244.16.95  265.85 KiB  256          69.8%             2f4738a2-68d6-4f9e-bf8f-2e1cfc07f791  rack1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ pode realizar a transfer√™ncia. </font><font style="vertical-align: inherit;">Para fazer isso, primeiro transfira o espa√ßo para chaves de teste - verifique se est√° tudo bem:</font></font><br>
<br>
<pre><code class="plaintext hljs">ALTER KEYSPACE example WITH replication = {'class': 'NetworkTopologyStrategy', x1: 2, x2: 2};</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, em cada pod </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempor√°rio do Cassandra</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">execute o comando:</font></font><br>
<br>
<pre><code class="bash hljs">nodetool rebuild -ks example x1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos a qualquer pod do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e verifique se os dados foram transferidos. </font><font style="vertical-align: inherit;">Voc√™ tamb√©m pode adicionar mais 1 entrada ao </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para verificar se novos dados come√ßaram a se replicar:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> example;<font></font>
<font></font>
 id | name   | phone<font></font>
<span class="hljs-comment">----+--------+-----------</span><font></font>
  1 |  Masha | 983123123<font></font>
  2 | Sergey | 912121231<font></font>
  3 | Andrey | 914151617<font></font>
<font></font>
(3 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, voc√™ pode </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">executar todos os espa√ßos de teclas no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e executar </font></font><code>nodetool rebuild</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de espa√ßo e mem√≥ria</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse est√°gio, √© √∫til lembrar que, quando a reconstru√ß√£o est√° em execu√ß√£o, s√£o criados arquivos tempor√°rios com tamanho equivalente ao tamanho do espa√ßo de chave! </font><font style="vertical-align: inherit;">Encontramos um problema em que o maior espa√ßo para chaves era de 350 GB e havia menos espa√ßo livre em disco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o foi poss√≠vel expandir o disco, porque o armazenamento local √© usado. </font><font style="vertical-align: inherit;">O seguinte comando veio para o resgate (executado em cada pod de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs">nodetool clearsnapshot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o local foi liberado: no nosso caso, 500 GB de espa√ßo livre em disco foram obtidos em vez dos 200 GB dispon√≠veis anteriormente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, apesar do espa√ßo suficiente, a opera√ß√£o de reconstru√ß√£o causava constantemente o rein√≠cio dos pods </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempor√°rios</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font><i><font style="vertical-align: inherit;">Cassandra</font></i><font style="vertical-align: inherit;"> com um erro:</font></font><br>
<br>
<pre><code class="plaintext hljs">failed; error='Cannot allocate memory' (errno=12)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidimos criar o DaemonSet, que √© implementado apenas nos n√≥s com </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e executa:</font></font><br>
<br>
<pre><code class="bash hljs">sysctl -w vm.max_map_count=262144</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, todos os dados foram migrados!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troca de cluster</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Restou apenas trocar o Cassandra, realizado em 5 etapas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dimensione </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-temporary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-current</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (n√£o esque√ßa que o operador ainda funciona aqui!) Para 0.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troque de disco (tudo se resume a definir PV para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Come√ßamos o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , rastreando se os discos necess√°rios est√£o conectados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazemos </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todas as tabelas para remover o cluster antigo:</font></font><br>
<br>
<pre><code class="plaintext hljs">ALTER KEYSPACE example WITH replication = {'class': 'NetworkTopologyStrategy', 'x2': 2};</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exclua todos os n√≥s do cluster antigo. </font><font style="vertical-align: inherit;">Para fazer isso, basta executar este comando em um de seus pods:</font></font><br>
<br>
<pre><code class="bash hljs">nodetool removenode 3619841e-64a0-417d-a497-541ec602a996</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O tempo total de inatividade do Cassandra foi de cerca de 3 minutos - √© o tempo em que os cont√™ineres pararam e come√ßaram, pois os discos foram preparados com anteced√™ncia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toque final com Prometeu</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, isso n√£o terminou a√≠. </font><font style="vertical-align: inherit;">Existe </font><font style="vertical-align: inherit;">um exportador embutido </font><font style="vertical-align: inherit;">com </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cassandra-new </font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(consulte a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o do novo operador</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - √© claro que n√≥s o usamos. </font><font style="vertical-align: inherit;">Cerca de 1 hora ap√≥s o lan√ßamento, come√ßaram a surgir alertas sobre a inacessibilidade de Prometheus. </font><font style="vertical-align: inherit;">Ap√≥s verificar a carga, vimos que o consumo de mem√≥ria nos n√≥s com o Prometheus aumentou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um estudo mais aprofundado da quest√£o mostrou que o n√∫mero de m√©tricas coletadas aumentou 2,5 vezes (!). </font><font style="vertical-align: inherit;">A culpa foi de Cassandra, com a qual foram coletadas pouco mais de 500 mil m√©tricas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realizamos uma auditoria das m√©tricas e desativamos aquelas que n√£o consideramos necess√°rias - por meio do ConfigMap (a prop√≥sito, o exportador est√° configurado). </font><font style="vertical-align: inherit;">O resultado s√£o 120 mil m√©tricas e uma carga significativamente reduzida no Prometheus (apesar de importantes m√©tricas permanecerem).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, conseguimos transferir o Cassandra para outro cluster, praticamente sem afetar o funcionamento da instala√ß√£o de produ√ß√£o do Cassandra e sem interferir no trabalho dos aplicativos clientes. </font><font style="vertical-align: inherit;">Ao longo do caminho, chegamos √† conclus√£o de que usar a mesma rede de pods n√£o √© uma boa ideia (agora estamos mais atentos ao planejamento inicial da instala√ß√£o do cluster). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por fim: por que n√£o usamos a ferramenta </font></font><code>nodetool snapshot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mencionada no artigo anterior? </font><font style="vertical-align: inherit;">O fato √© que esse comando cria uma captura instant√¢nea do espa√ßo de chave no estado em que estava antes da execu√ß√£o do comando. </font><font style="vertical-align: inherit;">Al√©m disso:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> leva muito mais tempo para tirar uma foto e transferi-la;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tudo o que est√° escrito neste momento em Cassandra ser√° perdido;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simples, no nosso caso, levaria cerca de uma hora - em vez de 3 minutos, o que acabou sendo combinado com sucesso com a implanta√ß√£o do aplicativo em um novo cluster.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leia tamb√©m no nosso blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migra√ß√£o de Cassandra para Kubernetes: Recursos e Solu√ß√µes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma hist√≥ria com o operador Redis nos K8s e uma mini vis√£o geral dos utilit√°rios para analisar dados desse banco de dados</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migra√ß√£o desobstru√≠da do MongoDB para o Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migra√ß√£o desobstru√≠da do RabbitMQ para Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bancos de dados e Kubernetes (revis√£o e relat√≥rio de v√≠deo)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ."</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt498064/index.html">Emulador de mercado cl√°ssico</a></li>
<li><a href="../pt498066/index.html">Como SFP, SFP + e XFP facilitam nossa vida</a></li>
<li><a href="../pt498070/index.html">Hive - base local r√°pida para Flutter, Dart</a></li>
<li><a href="../pt498072/index.html">Efeito Raster para Atari 65XE</a></li>
<li><a href="../pt498074/index.html">Marque este artigo como favorito se voc√™ √© novo no Python (especialmente se voc√™ mesmo estiver aprendendo Python)</a></li>
<li><a href="../pt498080/index.html">Experi√™ncia de migra√ß√£o para o SAP HANA 2.0 em um grande projeto de teste automatizado de varejo para Sberbank e outros casos</a></li>
<li><a href="../pt498084/index.html">As vendas est√£o mortas. o que fazer a seguir?</a></li>
<li><a href="../pt498086/index.html">Que cem m√≠sseis reutiliz√°veis ‚Äã‚Äãflores√ßam</a></li>
<li><a href="../pt498088/index.html">Como os pesquisadores da Avito trabalham</a></li>
<li><a href="../pt498090/index.html">Dunas de areia s√£o capazes de "se comunicar" umas com as outras</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>