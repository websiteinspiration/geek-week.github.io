<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£üèæ üßúüèª üéÉ Networking in Flexiant Cloud Orchestrator üëâüèª ü¶î üëÇüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the continuation of the series of articles on the cloud orchestra, Flexiant would like to talk about how the organization of the network for virtua...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Networking in Flexiant Cloud Orchestrator</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the continuation of the series of articles on the cloud orchestra, Flexiant would like to talk about how the organization of the network for virtual machines and containers is being managed under this orchestra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flexiant identifies four types of networks that can be accessed by the client in his virtual machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVIP is a network in which a single / 32 address is allocated to a client. Routing to this IP address is performed on the host machine on which the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Public IP </font><font style="vertical-align: inherit;">virtual machine is located </font><font style="vertical-align: inherit;">- the network in which the client receives a separate VLAN and / 29 subnet. This is the main network that we use. Routing for it is performed on special router nodes that are managed by Flexiant Cloud Orchestrator.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Private IP - network, organization similar to the previous one, except that it is not displayed externally on router nodes. A client can use it to create internal networks between their virtual machines. IP addresses can be assigned both from the interface and on the machine itself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interworking VLAN is, again, very similar to Private IP, except that it is not available to the client directly without the participation of the provider. We give this network to the client when he needs to connect the existing L2 infrastructure to the Flexiant Cloud Orchestrator infrastructure.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All networks except the first operate in a separate isolated VLAN; accordingly, all L2 protocols are available to the client: arp, dhcp, lldp, etc. The PVIP network runs on L3, and we use it for clients who want to get protection from DDoS. If they want to protect IP addresses, then they need to use it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each network is assigned to a virtual machine adapter. Thus, in one virtual machine there can be several types of networks at the same time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IP addresses for Private IP and Interworking VLAN can be chosen by clients arbitrarily. IP addresses for Public IP and PVIP are selected from the list in the control panel.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_l/zn/kr/_lznkrleqhvfpqv5okrisl7wcb4.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as the adapter receives the network, and optionally an IP address, information about this gets into the orchestra‚Äôs database, and the corresponding settings are entered on the routing nodes (for the Public IP network), computing nodes (for PVIP), as well as in the DHCP server located on the management node, in case an IP address has been set. The correspondence table between the virtual mac-address of the card and the selected IP-address is entered into the PgSQL database, from where it is further taken by the DHCP server.</font></font><br>
<cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On each node, whether it is a router node or a compute node, the Flexiant agent is installed, which receives commands from the orchestra. Inside the nodes themselves, a virtual router is raised in a separate network namespace. Thus, the Linux network stack on the nodes and the virtual router network stack are independent of each other. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Router-Nodes that ensure the functioning of Public IP duplicate each other using the VRRP protocol in the implementation of carp. If one of the nodes fails, the traffic will go through the other. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is an example of routing on the route node for one:</font></font><br>
<br>
<pre><code class="plaintext hljs">Router0# ip a l<font></font>
‚Ä¶<font></font>
766: VLAN367: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default<font></font>
    link/ether 00:1e:67:d3:67:5c brd ff:ff:ff:ff:ff:ff<font></font>
    inet6 fe80::e0fe:25ff:fef9:7304/64 scope link<font></font>
     valid_lft forever preferred_lft forever<font></font>
‚Ä¶<font></font>
Router0# brctl show VLAN367<font></font>
bridge name     bridge id               STP enabled     interfaces<font></font>
VLAN367         8000.001e67d3675c       no              bond0.367<font></font>
                                                                               evrl-000190<font></font>
<font></font>
#         ,     shell  screen,       <font></font>
<font></font>
Router0# evrs<font></font>
Router0# ip a l evrr-000190<font></font>
768: evrr-000190: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000<font></font>
    link/ether e6:52:0f:21:83:b0 brd ff:ff:ff:ff:ff:ff<font></font>
    inet 217.23.xxx.xxx/29 scope global evrr-000190<font></font>
       valid_lft forever preferred_lft forever<font></font>
    inet6 fe80::e452:fff:fe21:83b0/64 scope link<font></font>
       valid_lft forever preferred_lft forever<font></font>
<font></font>
Router0# ip r l 217.23.xxx.xxx<font></font>
217.23.xxx.xxx/29 dev evrr-000190  proto kernel  scope link  src 217.23.xxx.xxx<font></font>
Router#0 ip r l ip r l 0.0.0.0/0<font></font>
default via 10.158.192.3 dev evrr-000000  proto bird<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pair of evrr / evrl interfaces are regular veths on Linux that interconnect two network namespaces. Thus, it is seen how incoming traffic getting into the virtual router is routed there to a specific interface. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firewall management also takes place in a virtual router. Separate tables and chains are created that allow or do not allow traffic to a particular network interface.</font></font><br>
<br>
<pre><code class="plaintext hljs">Router0# iptables -nvL evrr-000190-4i<font></font>
Chain evrr-000190-4i (1 references)<font></font>
 pkts bytes target     prot opt in     out     source               destination<font></font>
 435M  124G RETURN     all  --  *      *       217.23.xxx.xxx        0.0.0.0/0<font></font>
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0<font></font>
Router0# iptables -nvL evrr-000190-4o<font></font>
Chain evrr-000190-4o (1 references)<font></font>
pkts bytes target     prot opt in     out     source               destination<font></font>
587M  782G ACCEPT     all  --  *      *       0.0.0.0/0            217.23.xxx.xxx<font></font>
6038K  350M DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We use OSPF as the routing protocol, the configuration with compute and the router node gets to the core of the network, and from there to the core routers. </font><font style="vertical-align: inherit;">As software on the nodes, bird is used, which is controlled by Flexiant. </font><font style="vertical-align: inherit;">We also make changes to configuration templates, since Flexiant allows us to do this. </font><font style="vertical-align: inherit;">Flexiant also allows you to use statics and bgp as routing protocols. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In terms of payment, all networks are free. </font><font style="vertical-align: inherit;">Payment is only for IP addresses for PVIP and Public IP networks. </font><font style="vertical-align: inherit;">However, IP addresses for PVIP are more expensive because they are protected from DDoS attacks.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499220/index.html">Transferring developers to a remote site due to coronavirus increased productivity in Google and Microsoft</a></li>
<li><a href="../en499224/index.html">It's time to start learning right</a></li>
<li><a href="../en499226/index.html">No pandemic: how to make a movie about cryptocurrency for $ 1000 and get into the top US movie distribution</a></li>
<li><a href="../en499230/index.html">How to raise a healthy contented worm: parsing the 1910 manual</a></li>
<li><a href="../en499232/index.html">Configuring gitlab.com CI and VPS server</a></li>
<li><a href="../en499236/index.html">Phone number through State Services</a></li>
<li><a href="../en499238/index.html">Soldering at home: stream recording</a></li>
<li><a href="../en499240/index.html">Through thorns to the stars, or data analysis in the affairs of heaven</a></li>
<li><a href="../en499242/index.html">Researchers transmitted data from a desktop PC through vibrations across a table</a></li>
<li><a href="../en499244/index.html">Synergetic organizations. Part II</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>