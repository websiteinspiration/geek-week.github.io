<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👊🏾 🎪 ⛹️ Geocodificação Como vincular 250 mil endereços a coordenadas em 10 minutos? 🧚🏾 👨🏻‍🏭 💮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Olá Habr! 
 
 Neste artigo, gostaria de compartilhar minha experiência na solução de um pequeno problema com um grande número de endereços. Se você já...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Geocodificação Como vincular 250 mil endereços a coordenadas em 10 minutos?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499990/"><img src="https://habrastorage.org/webt/6b/g3/oo/6bg3ooc_jcrhty63bg_33x8inta.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Olá Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, gostaria de compartilhar minha experiência na solução de um pequeno problema com um grande número de endereços. </font><font style="vertical-align: inherit;">Se você já trabalhou com a API de geocodificação ou usou ferramentas on-line, acho que compartilha da minha dor de esperar o resultado por várias horas ou mais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não se trata de algoritmos de otimização complexos, mas de usar um serviço de geocodificação de pacotes que recebe uma lista de endereços como entrada e retorna um arquivo com os resultados. </font><font style="vertical-align: inherit;">Isso pode reduzir o tempo de processamento de algumas horas para minutos.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiras coisas primeiro:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geocodificação em lote</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escolhendo um provedor de geocodificador de pacotes</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guia de Serviço Python</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descrição da classe de lote completo</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Análise de Resultados</font></font></h3></a></li>
</ul><br>
<a name="history"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa chegou - "Ligue-se às coordenadas de 24 mil endereços". </font><font style="vertical-align: inherit;">Apenas duas soluções para o problema ocorreram:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicativo da Web para geocodificação, usado na universidade;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escreva um script com base na API REST do geocoder.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No primeiro caso, descobriu-se que o aplicativo da web falha após o processamento de milhares de endereços. Distribuir um conjunto de dados entre colegas é uma ideia que foi imediatamente abandonada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, você precisa usar a API REST do geocoder para escrever seu próprio script, com os resultados salvos (essa não é uma maneira completamente legal e você precisa ler os termos de uso do serviço). Um novo problema surge - uma coisa é quando usamos a pesquisa de endereços no aplicativo e obtemos o resultado imediatamente, mas quando a tarefa é processar mais de dez mil endereços com preservação, o trabalho do script é bastante atrasado. Você pode esperar uma ou duas horas, mas um milhão de endereços precisará geocodificar “imenso tempo”, portanto, você precisa procurar outra solução e ela é!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os grandes provedores de serviços de geolocalização, além do serviço de geocodificação usual, oferecem um geocoder de pacotes (Batch Geocoder), apenas para processar um grande número de endereços em uma solicitação.</font></font><br>
<br>
<a name="batch"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geocodificação em lote</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O nome do serviço fala por si - temos um pacote (por exemplo, um arquivo csv com uma lista de endereços na forma de uma tabela), que carregamos no servidor e faz todo o trabalho para nós. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O processo é assim:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparando o conjunto de dados para que o serviço o aceite sem erros;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Definir os parâmetros do resultado do trabalho (seleção de colunas, separador ...);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carregar um arquivo para a nuvem;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aguardando a conclusão do processamento;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faça o download do arquivo finalizado.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Graças ao poder da computação em nuvem, o que é feito com um script auto-escrito em 1 hora é concluído em 1 minuto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O próximo passo é escolher a empresa com os termos de uso mais fiéis do geocoder de pacotes. </font><font style="vertical-align: inherit;">Em primeiro lugar, nem todo mundo tem esse serviço, outros permitem que você teste o serviço com uma limitação séria. </font><font style="vertical-align: inherit;">Além disso, se você tiver volumes muito grandes, precisará prestar atenção ao custo de transações adicionais, caso o limite do pacote gratuito seja excedido.</font></font><br>
<br>
<a name="provider"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escolhendo um provedor de serviços de geocodificação em lote</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No mercado global de serviços de geolocalização, as posições de liderança são ocupadas por: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Maps</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HERE Technologies; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MapBox</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TomTom </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESRI.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, você não deve esquecer a Yandex Technologies, que tem uma posição bastante forte na Rússia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tomei os seguintes parâmetros como base para escolher um provedor:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O número de solicitações para o serviço de geocodificação por mês é gratuito;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite no número de transações por dia;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disponibilidade do serviço de geocodificação em lote;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capacidade de usar um geocoder de pacote em um plano gratuito. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada empresa possui seu próprio modelo de monetização. </font><font style="vertical-align: inherit;">Dependendo do projeto, um ou outro modelo pode jogar nas mãos ou vice-versa, sendo uma limitação significativa.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google maps</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para começar com os serviços geográficos do Google, a primeira coisa que você precisa fazer é adicionar informações de cartão de crédito à sua conta. Um limite mensal de 200 dólares virtuais, então vem o pagamento de transações adicionais do cartão vinculado. Dentro desse limite, você pode usar vários serviços, mas cada transação é considerada diferente. Por exemplo, mil solicitações de geocodificação custarão US $ 5, mas o serviço de criação de rotas é duas vezes mais caro. Mais detalhes podem ser encontrados no site, estamos interessados ​​apenas no serviço de geocodificação.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se US $ 200 por mês, é fácil calcular o número gratuito de transações - 40.000 (serviço de geocodificação). </font><font style="vertical-align: inherit;">Não há geocodificador de pacotes entre os serviços. </font><font style="vertical-align: inherit;">Isso significa que você deve escrever seu próprio script e o resultado será de aproximadamente 1 endereço por segundo, ou seja, seis horas para 24 mil endereços. </font><font style="vertical-align: inherit;">Para acelerar o processo, você pode tentar executar o script na plataforma de APIs do Google Cloud, mas decidi procurar soluções alternativas. </font><font style="vertical-align: inherit;">Não há restrições quanto ao número de transações por dia; portanto, todos os quarenta mil podem ser gastos ao mesmo tempo.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HERE Technologies</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No passado, o Nokia Maps e, no passado ainda mais profundo, a Navteq, forneciam 250.000 transações por mês gratuitamente. Da mesma forma que no Google Maps, esse número se aplica a todos os serviços e cada um é considerado de maneira diferente. Ao usar o pacote gratuito, você não precisa anexar um cartão bancário. Se você exceder o limite, para cada mil transações adicionais você precisará pagar US $ 1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
É importante ter um geocoder de pacote como um serviço separado, incluído no plano gratuito. As transações nele são levadas em consideração de acordo com o mesmo modelo que o habitual, ou seja, em cada endereço do arquivo, o geocoder de pacotes perceberá em uma transação.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pelo título do artigo, fica claro que eu usei o geocoder em lote HERE, pois você pode gastar todas as transações no geocoder e executar 250.000 operações de geocodificação por mês. </font><font style="vertical-align: inherit;">Mas essa não é a única opção, então analisamos o que as outras empresas têm.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapbox</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao usar o geocodificador MapBox, 100 mil transações por mês estão disponíveis. </font><font style="vertical-align: inherit;">A empresa segue o mesmo modelo de monetização com pagamento por transações adicionais. </font><font style="vertical-align: inherit;">Só existe uma opção interessante para os "atacadistas" - quanto mais transações você tiver, menos elas custam (é claro que há um limite de redução de preço). </font><font style="vertical-align: inherit;">Por exemplo, de 100 mil a 500 mil, mil solicitações adicionais custarão US $ 0,75, de 500 mil a 1 milhão - US $ 0,60 etc. para mais detalhes, consulte o site. </font><font style="vertical-align: inherit;">Infelizmente, o geocoder de lote está disponível apenas em uma conta paga.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tomtom</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A plataforma permite realizar 2500 transações por dia, aproximadamente 75.000 por mês. </font><font style="vertical-align: inherit;">Durante os testes e o desenvolvimento, o limite diário não parece muito atraente em comparação aos concorrentes, mas o pagamento por transações adicionais é o mais flexível. </font><font style="vertical-align: inherit;">Existem 8 opções de pagamento para mil solicitações extras e o preço é reduzido de US $ 0,5 para US $ 0,42. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre os serviços, existe um geocoder em lote com capacidade para processar até 10 mil endereços por solicitação (no entanto, o limite diário deve ser levado em consideração).</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex Technologies</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um modelo com um limite diário de transações para o Yandex, mas com mais de 25 mil pedidos leais. </font><font style="vertical-align: inherit;">Se você multiplicar esse número pelo número de dias em um mês, obtém um número impressionante de 750 mil. </font><font style="vertical-align: inherit;">O site apresenta preços para mais mil transações em rublos, variando de 120 rublos. </font><font style="vertical-align: inherit;">até 11 rublos </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O geocoder de pacote como um serviço não é apresentado, portanto, para obter algum tipo de otimização falhará.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESRI</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um plano gratuito muito tentador, com 1 milhão de transações por mês. </font><font style="vertical-align: inherit;">A empresa também cobra 50 créditos em cada conta (equivalente aproximado de US $ 5). </font><font style="vertical-align: inherit;">Vale ressaltar que este é o plano mais fiel para o uso dos serviços de geolocalização. </font><font style="vertical-align: inherit;">Também existe um serviço de geocodificação em lote, mas você pode usá-lo apenas se tiver uma conta corporativa na plataforma ArcGIS Online.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que escolher no final?</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maneira mais fácil é fazer uma escolha, compilando uma pequena tabela: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/xy/b1/kgxyb1kmzemqxqicwajfi7hggva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, minha escolha caiu AQUI, pois é a melhor opção para resolver meu problema. </font><font style="vertical-align: inherit;">Obviamente, eu fiz muito longe da análise completa; idealmente, você precisa executar seu conjunto de dados por todos os geocodificadores para avaliar a qualidade. </font><font style="vertical-align: inherit;">Além disso, se você tiver vários milhões de endereços, pense em um pacote pago e precisará levar em consideração o custo da adição. </font><font style="vertical-align: inherit;">transações. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O objetivo do artigo não é comparar empresas, mas resolver o problema de otimizar a geocodificação de um grande volume de endereços. </font><font style="vertical-align: inherit;">Eu apenas mostrei meus pensamentos ao escolher um provedor de serviços.</font></font><br>
<br>
<a name="guide"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guia de Serviço Python</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, você precisa criar uma conta no portal para desenvolvedores e gerar uma REST API KEY na seção do projeto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora você pode trabalhar com a plataforma. </font><font style="vertical-align: inherit;">Descreverei apenas parte da funcionalidade do geocoder do pacote HERE: carregamento de dados, verificação de status, salvamento de resultados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então, vamos começar importando as bibliotecas necessárias:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, se nenhum erro ocorreu, crie uma classe:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Batch</span>:</span><font></font>
<font></font>
    SERVICE_URL = <span class="hljs-string">"https://batch.geocoder.ls.hereapi.com/6.2/jobs"</span>
    jobId = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, apikey=<span class="hljs-string">"your_api_key"</span></span>):</span><font></font>
        self.apikey = apikey<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, durante a inicialização, a classe deve passar sua própria chave para a API REST. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A variável SERVICE_URL é a URL base para trabalhar com o serviço de geocodificação em lote. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E em jobId, o identificador do trabalho atual do geocoder será armazenado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um ponto importante é a estrutura de dados correta, mediante solicitação. </font><font style="vertical-align: inherit;">O arquivo deve conter duas colunas obrigatórias: recId e searchText. </font><font style="vertical-align: inherit;">Caso contrário, o serviço retornará uma resposta com informações sobre o erro de download. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui está um exemplo de conjunto de dados:</font></font><br>
<br>
<pre><code class="plaintext hljs">   recId; searchText<font></font>
   1; -, . , 6<font></font>
   2; ,  1,  -., 72<font></font>
   3; 425 W Randolph St Chicago IL 60606<font></font>
   4; , DJ106 20-30, Sibiu 557260<font></font>
   5; 200 S Mathilda Ave Sunnyvale CA 94086<font></font>
  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Função para carregar um arquivo na nuvem:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self, filename, indelim=<span class="hljs-string">";"</span>, outdelim=<span class="hljs-string">";"</span></span>):</span><font></font>
        <font></font>
        file = open(filename, <span class="hljs-string">'rb'</span>)<font></font>
<font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"run"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,
            <span class="hljs-string">"politicalview"</span>:<span class="hljs-string">"RUS"</span>,
            <span class="hljs-string">"gen"</span>: <span class="hljs-number">9</span>,
            <span class="hljs-string">"maxresults"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"header"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"indelim"</span>: indelim,
            <span class="hljs-string">"outdelim"</span>: outdelim,
            <span class="hljs-string">"outcols"</span>: <span class="hljs-string">"displayLatitude,displayLongitude,locationLabel,houseNumber,street,district,city,postalCode,county,state,country"</span>,
            <span class="hljs-string">"outputcombined"</span>: <span class="hljs-string">"true"</span>,<font></font>
        }<font></font>
<font></font>
        response = requests.post(self.SERVICE_URL, params=params, data=file)<font></font>
        self.__stats (response)<font></font>
        file.close()<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo é bem simples, abra um arquivo com uma lista de endereços para leitura, forme um dicionário de parâmetros de solicitação GET. </font><font style="vertical-align: inherit;">Vale a pena explicar alguns parâmetros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Ação": "executar" - início do processamento de endereços;</font></font></li>
<li>“politicalView”: “RUS” –    .         (    );</li>
<li>“gen”: 9 –   (   );</li>
<li>“maxresults”: 1 –          ;</li>
<li>“header”: true –        ;</li>
<li>“indelim”: “;” –   ,  ;</li>
<li>“outdelim”: “;” –    ;</li>
<li>“outcols”: “” –  ,      ;</li>
<li>“outcombined”: true –                .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, basta enviar uma solicitação usando a biblioteca de solicitações e exibir estatísticas. </font><font style="vertical-align: inherit;">Obviamente, você precisa fechar o arquivo no final da função. </font><font style="vertical-align: inherit;">A função __stats analisa a resposta do servidor, que contém o ID do trabalho em execução, e também exibe informações gerais sobre a operação. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O próximo passo é verificar o status do trabalho. </font><font style="vertical-align: inherit;">A solicitação é formada de maneira semelhante, apenas é necessário transferir o ID da operação. </font><font style="vertical-align: inherit;">O parâmetro de ação deve conter o valor "status". </font><font style="vertical-align: inherit;">A função __stats exibe estatísticas completas no console para estimar o tempo de desligamento do geocoder.</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        statusUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId<font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"status"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,<font></font>
        }<font></font>
        <font></font>
        response = requests.get(statusUrl, params=params)<font></font>
        self.__stats (response)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma das funções mais importantes é salvar o resultado. </font><font style="vertical-align: inherit;">Por conveniência, é melhor descompactar imediatamente o arquivo que vem do servidor. </font><font style="vertical-align: inherit;">A solicitação para salvar o arquivo é idêntica à verificação do status, basta adicionar / resultado no final.</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        print(<span class="hljs-string">"Requesting result data ..."</span>)<font></font>
        <font></font>
        resultUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId + <span class="hljs-string">"/result"</span><font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"apiKey"</span>: self.apikey<font></font>
        }<font></font>
        <font></font>
        response = requests.get(resultUrl, params=params, stream=<span class="hljs-literal">True</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (response.ok):    <font></font>
            zipResult = zipfile.ZipFile(io.BytesIO(response.content))<font></font>
            zipResult.extractall()<font></font>
            print(<span class="hljs-string">"File saved successfully"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"Error"</span>)<font></font>
            print(response.text)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A função final para analisar a resposta do serviço. </font><font style="vertical-align: inherit;">Sua tarefa também é salvar o identificador da tarefa de geocodificação atual:</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__stats</span> (<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> (response.ok):<font></font>
            parsedXMLResponse = BeautifulSoup(response.text, <span class="hljs-string">"lxml"</span>)<font></font>
<font></font>
            self.jobId = parsedXMLResponse.find(<span class="hljs-string">'requestid'</span>).get_text()<font></font>
            <font></font>
            <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> parsedXMLResponse.find(<span class="hljs-string">'response'</span>).findChildren():
                <span class="hljs-keyword">if</span>(len(stat.findChildren()) == <span class="hljs-number">0</span>):<font></font>
                    print(<span class="hljs-string">"{name}: {data}"</span>.format(name=stat.name, data=stat.get_text()))<font></font>
<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(response.text)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testá-lo, basta executar o interpretador Python na pasta de scripts. </font><font style="vertical-align: inherit;">A classe Batch está no arquivo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geocoder.py</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; from geocoder import Batch<font></font>
&gt;&gt;&gt; service = Batch(apikey="   REST API")<font></font>
&gt;&gt;&gt; service.start("big_data_addresses.csv", indelim=";", outdelim=";")<font></font>
<font></font>
requestid: "  Id "<font></font>
status: accepted<font></font>
totalcount: 0<font></font>
validcount: 0<font></font>
invalidcount: 0<font></font>
processedcount: 0<font></font>
pendingcount: 0<font></font>
successcount: 0<font></font>
errorcount: 0<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ótimo trabalho iniciado. </font><font style="vertical-align: inherit;">Verifique o status:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; service.status()<font></font>
<font></font>
requestid: "  Id "<font></font>
status: completed<font></font>
jobstarted: 2020-04-27T10:09:58.000Z<font></font>
jobfinished: 2020-04-27T10:17:18.000Z<font></font>
totalcount: 249999<font></font>
validcount: 249999<font></font>
invalidcount: 0<font></font>
processedcount: 249999<font></font>
pendingcount: 0<font></font>
successcount: 249978<font></font>
errorcount: 21<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que o processamento do conjunto de dados está completo. </font><font style="vertical-align: inherit;">Em apenas sete minutos, foi possível procodificar os 250 mil endereços (excluindo erros - contagem de erros). </font><font style="vertical-align: inherit;">Resta salvar os resultados:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; service.result()<font></font>
Requesting result data ...<font></font>
File saved successfully<font></font>
</code></pre><br>
<a name="code"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descrição da classe de lote completo</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu acho que não dói adicionar o script completamente:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Batch</span>:</span><font></font>
<font></font>
    SERVICE_URL = <span class="hljs-string">"https://batch.geocoder.ls.hereapi.com/6.2/jobs"</span>
    jobId = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, apikey=<span class="hljs-string">"   REST API "</span></span>):</span><font></font>
        self.apikey = apikey<font></font>
        <font></font>
            <font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self, filename, indelim=<span class="hljs-string">";"</span>, outdelim=<span class="hljs-string">";"</span></span>):</span><font></font>
        <font></font>
        file = open(filename, <span class="hljs-string">'rb'</span>)<font></font>
<font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"run"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,
            <span class="hljs-string">"politicalview"</span>:<span class="hljs-string">"RUS"</span>,
            <span class="hljs-string">"gen"</span>: <span class="hljs-number">9</span>,
            <span class="hljs-string">"maxresults"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"header"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"indelim"</span>: indelim,
            <span class="hljs-string">"outdelim"</span>: outdelim,
            <span class="hljs-string">"outcols"</span>: <span class="hljs-string">"displayLatitude,displayLongitude,locationLabel,houseNumber,street,district,city,postalCode,county,state,country"</span>,
            <span class="hljs-string">"outputcombined"</span>: <span class="hljs-string">"true"</span>,<font></font>
        }<font></font>
<font></font>
        response = requests.post(self.SERVICE_URL, params=params, data=file)<font></font>
        self.__stats (response)<font></font>
        file.close()<font></font>
    <font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        statusUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId<font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"status"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,<font></font>
        }<font></font>
        <font></font>
        response = requests.get(statusUrl, params=params)<font></font>
        self.__stats (response)<font></font>
        <font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        print(<span class="hljs-string">"Requesting result data ..."</span>)<font></font>
        <font></font>
        resultUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId + <span class="hljs-string">"/result"</span><font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"apiKey"</span>: self.apikey<font></font>
        }<font></font>
        <font></font>
        response = requests.get(resultUrl, params=params, stream=<span class="hljs-literal">True</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (response.ok):    <font></font>
            zipResult = zipfile.ZipFile(io.BytesIO(response.content))<font></font>
            zipResult.extractall()<font></font>
            print(<span class="hljs-string">"File saved successfully"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"Error"</span>)<font></font>
            print(response.text)<font></font>
    <font></font>
<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__stats</span> (<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> (response.ok):<font></font>
            parsedXMLResponse = BeautifulSoup(response.text, <span class="hljs-string">"lxml"</span>)<font></font>
<font></font>
            self.jobId = parsedXMLResponse.find(<span class="hljs-string">'requestid'</span>).get_text()<font></font>
            <font></font>
            <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> parsedXMLResponse.find(<span class="hljs-string">'response'</span>).findChildren():
                <span class="hljs-keyword">if</span>(len(stat.findChildren()) == <span class="hljs-number">0</span>):<font></font>
                    print(<span class="hljs-string">"{name}: {data}"</span>.format(name=stat.name, data=stat.get_text()))<font></font>
<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(response.text)<font></font>
</code></pre><br>
<a name="result"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Análise de Resultados</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, passei de aplicativos on-line trabalhando lentamente para serviços de geocodificação em lote. </font><font style="vertical-align: inherit;">A escolha de um provedor de serviços geográficos depende inteiramente das tarefas que o confrontam. </font><font style="vertical-align: inherit;">Recebo regularmente solicitações para processar um grande número de endereços, e a abordagem descrita no artigo ajudou a reduzir significativamente o tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que este artigo seja útil e, claro, estou aberto a comentários e acréscimos!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499974/index.html">Jogos em 3D no Instagram Javascript ou rota de salsicha</a></li>
<li><a href="../pt499978/index.html">Tradução do livro de Andrew Un, Passion for Machine Learning, Capítulos 36 e 37</a></li>
<li><a href="../pt499982/index.html">Plano do testador iniciante: de "Insira TI" a "Eu sou um engenheiro!"</a></li>
<li><a href="../pt499986/index.html">E, novamente, sobre incorporado: procurando bugs no projeto Embox</a></li>
<li><a href="../pt499988/index.html">Açúcar e COVID-19</a></li>
<li><a href="../pt499992/index.html">Projetar tecnologias para a implementação de sistemas de cobrança para clientes corporativos (parte 2)</a></li>
<li><a href="../pt499994/index.html">Quando o coronavírus terminará</a></li>
<li><a href="../pt500000/index.html">Para o dia do rádio. Comunicação - os nervos da guerra</a></li>
<li><a href="../pt500002/index.html">Especialistas em TI versus vendedores: e o mundo rachou ao meio</a></li>
<li><a href="../pt500008/index.html">Conheça upscalers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>