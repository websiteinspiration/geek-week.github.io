<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëäüèæ üé™ ‚õπÔ∏è Geocodifica√ß√£o Como vincular 250 mil endere√ßos a coordenadas em 10 minutos? üßöüèæ üë®üèª‚Äçüè≠ üíÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! 
 
 Neste artigo, gostaria de compartilhar minha experi√™ncia na solu√ß√£o de um pequeno problema com um grande n√∫mero de endere√ßos. Se voc√™ j√°...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Geocodifica√ß√£o Como vincular 250 mil endere√ßos a coordenadas em 10 minutos?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499990/"><img src="https://habrastorage.org/webt/6b/g3/oo/6bg3ooc_jcrhty63bg_33x8inta.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ol√° Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, gostaria de compartilhar minha experi√™ncia na solu√ß√£o de um pequeno problema com um grande n√∫mero de endere√ßos. </font><font style="vertical-align: inherit;">Se voc√™ j√° trabalhou com a API de geocodifica√ß√£o ou usou ferramentas on-line, acho que compartilha da minha dor de esperar o resultado por v√°rias horas ou mais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o se trata de algoritmos de otimiza√ß√£o complexos, mas de usar um servi√ßo de geocodifica√ß√£o de pacotes que recebe uma lista de endere√ßos como entrada e retorna um arquivo com os resultados. </font><font style="vertical-align: inherit;">Isso pode reduzir o tempo de processamento de algumas horas para minutos.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiras coisas primeiro:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geocodifica√ß√£o em lote</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escolhendo um provedor de geocodificador de pacotes</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guia de Servi√ßo Python</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descri√ß√£o da classe de lote completo</font></font></h3></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lise de Resultados</font></font></h3></a></li>
</ul><br>
<a name="history"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa chegou - "Ligue-se √†s coordenadas de 24 mil endere√ßos". </font><font style="vertical-align: inherit;">Apenas duas solu√ß√µes para o problema ocorreram:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicativo da Web para geocodifica√ß√£o, usado na universidade;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escreva um script com base na API REST do geocoder.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No primeiro caso, descobriu-se que o aplicativo da web falha ap√≥s o processamento de milhares de endere√ßos. Distribuir um conjunto de dados entre colegas √© uma ideia que foi imediatamente abandonada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, voc√™ precisa usar a API REST do geocoder para escrever seu pr√≥prio script, com os resultados salvos (essa n√£o √© uma maneira completamente legal e voc√™ precisa ler os termos de uso do servi√ßo). Um novo problema surge - uma coisa √© quando usamos a pesquisa de endere√ßos no aplicativo e obtemos o resultado imediatamente, mas quando a tarefa √© processar mais de dez mil endere√ßos com preserva√ß√£o, o trabalho do script √© bastante atrasado. Voc√™ pode esperar uma ou duas horas, mas um milh√£o de endere√ßos precisar√° geocodificar ‚Äúimenso tempo‚Äù, portanto, voc√™ precisa procurar outra solu√ß√£o e ela √©!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os grandes provedores de servi√ßos de geolocaliza√ß√£o, al√©m do servi√ßo de geocodifica√ß√£o usual, oferecem um geocoder de pacotes (Batch Geocoder), apenas para processar um grande n√∫mero de endere√ßos em uma solicita√ß√£o.</font></font><br>
<br>
<a name="batch"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geocodifica√ß√£o em lote</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O nome do servi√ßo fala por si - temos um pacote (por exemplo, um arquivo csv com uma lista de endere√ßos na forma de uma tabela), que carregamos no servidor e faz todo o trabalho para n√≥s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O processo √© assim:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparando o conjunto de dados para que o servi√ßo o aceite sem erros;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Definir os par√¢metros do resultado do trabalho (sele√ß√£o de colunas, separador ...);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carregar um arquivo para a nuvem;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aguardando a conclus√£o do processamento;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fa√ßa o download do arquivo finalizado.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gra√ßas ao poder da computa√ß√£o em nuvem, o que √© feito com um script auto-escrito em 1 hora √© conclu√≠do em 1 minuto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥ximo passo √© escolher a empresa com os termos de uso mais fi√©is do geocoder de pacotes. </font><font style="vertical-align: inherit;">Em primeiro lugar, nem todo mundo tem esse servi√ßo, outros permitem que voc√™ teste o servi√ßo com uma limita√ß√£o s√©ria. </font><font style="vertical-align: inherit;">Al√©m disso, se voc√™ tiver volumes muito grandes, precisar√° prestar aten√ß√£o ao custo de transa√ß√µes adicionais, caso o limite do pacote gratuito seja excedido.</font></font><br>
<br>
<a name="provider"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escolhendo um provedor de servi√ßos de geocodifica√ß√£o em lote</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No mercado global de servi√ßos de geolocaliza√ß√£o, as posi√ß√µes de lideran√ßa s√£o ocupadas por: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Maps</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HERE Technologies; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MapBox</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TomTom </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESRI.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, voc√™ n√£o deve esquecer a Yandex Technologies, que tem uma posi√ß√£o bastante forte na R√∫ssia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tomei os seguintes par√¢metros como base para escolher um provedor:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O n√∫mero de solicita√ß√µes para o servi√ßo de geocodifica√ß√£o por m√™s √© gratuito;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limite no n√∫mero de transa√ß√µes por dia;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disponibilidade do servi√ßo de geocodifica√ß√£o em lote;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capacidade de usar um geocoder de pacote em um plano gratuito. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada empresa possui seu pr√≥prio modelo de monetiza√ß√£o. </font><font style="vertical-align: inherit;">Dependendo do projeto, um ou outro modelo pode jogar nas m√£os ou vice-versa, sendo uma limita√ß√£o significativa.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google maps</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar com os servi√ßos geogr√°ficos do Google, a primeira coisa que voc√™ precisa fazer √© adicionar informa√ß√µes de cart√£o de cr√©dito √† sua conta. Um limite mensal de 200 d√≥lares virtuais, ent√£o vem o pagamento de transa√ß√µes adicionais do cart√£o vinculado. Dentro desse limite, voc√™ pode usar v√°rios servi√ßos, mas cada transa√ß√£o √© considerada diferente. Por exemplo, mil solicita√ß√µes de geocodifica√ß√£o custar√£o US $ 5, mas o servi√ßo de cria√ß√£o de rotas √© duas vezes mais caro. Mais detalhes podem ser encontrados no site, estamos interessados ‚Äã‚Äãapenas no servi√ßo de geocodifica√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se US $ 200 por m√™s, √© f√°cil calcular o n√∫mero gratuito de transa√ß√µes - 40.000 (servi√ßo de geocodifica√ß√£o). </font><font style="vertical-align: inherit;">N√£o h√° geocodificador de pacotes entre os servi√ßos. </font><font style="vertical-align: inherit;">Isso significa que voc√™ deve escrever seu pr√≥prio script e o resultado ser√° de aproximadamente 1 endere√ßo por segundo, ou seja, seis horas para 24 mil endere√ßos. </font><font style="vertical-align: inherit;">Para acelerar o processo, voc√™ pode tentar executar o script na plataforma de APIs do Google Cloud, mas decidi procurar solu√ß√µes alternativas. </font><font style="vertical-align: inherit;">N√£o h√° restri√ß√µes quanto ao n√∫mero de transa√ß√µes por dia; portanto, todos os quarenta mil podem ser gastos ao mesmo tempo.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HERE Technologies</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No passado, o Nokia Maps e, no passado ainda mais profundo, a Navteq, forneciam 250.000 transa√ß√µes por m√™s gratuitamente. Da mesma forma que no Google Maps, esse n√∫mero se aplica a todos os servi√ßos e cada um √© considerado de maneira diferente. Ao usar o pacote gratuito, voc√™ n√£o precisa anexar um cart√£o banc√°rio. Se voc√™ exceder o limite, para cada mil transa√ß√µes adicionais voc√™ precisar√° pagar US $ 1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante ter um geocoder de pacote como um servi√ßo separado, inclu√≠do no plano gratuito. As transa√ß√µes nele s√£o levadas em considera√ß√£o de acordo com o mesmo modelo que o habitual, ou seja, em cada endere√ßo do arquivo, o geocoder de pacotes perceber√° em uma transa√ß√£o.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pelo t√≠tulo do artigo, fica claro que eu usei o geocoder em lote HERE, pois voc√™ pode gastar todas as transa√ß√µes no geocoder e executar 250.000 opera√ß√µes de geocodifica√ß√£o por m√™s. </font><font style="vertical-align: inherit;">Mas essa n√£o √© a √∫nica op√ß√£o, ent√£o analisamos o que as outras empresas t√™m.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapbox</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao usar o geocodificador MapBox, 100 mil transa√ß√µes por m√™s est√£o dispon√≠veis. </font><font style="vertical-align: inherit;">A empresa segue o mesmo modelo de monetiza√ß√£o com pagamento por transa√ß√µes adicionais. </font><font style="vertical-align: inherit;">S√≥ existe uma op√ß√£o interessante para os "atacadistas" - quanto mais transa√ß√µes voc√™ tiver, menos elas custam (√© claro que h√° um limite de redu√ß√£o de pre√ßo). </font><font style="vertical-align: inherit;">Por exemplo, de 100 mil a 500 mil, mil solicita√ß√µes adicionais custar√£o US $ 0,75, de 500 mil a 1 milh√£o - US $ 0,60 etc. para mais detalhes, consulte o site. </font><font style="vertical-align: inherit;">Infelizmente, o geocoder de lote est√° dispon√≠vel apenas em uma conta paga.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tomtom</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A plataforma permite realizar 2500 transa√ß√µes por dia, aproximadamente 75.000 por m√™s. </font><font style="vertical-align: inherit;">Durante os testes e o desenvolvimento, o limite di√°rio n√£o parece muito atraente em compara√ß√£o aos concorrentes, mas o pagamento por transa√ß√µes adicionais √© o mais flex√≠vel. </font><font style="vertical-align: inherit;">Existem 8 op√ß√µes de pagamento para mil solicita√ß√µes extras e o pre√ßo √© reduzido de US $ 0,5 para US $ 0,42. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre os servi√ßos, existe um geocoder em lote com capacidade para processar at√© 10 mil endere√ßos por solicita√ß√£o (no entanto, o limite di√°rio deve ser levado em considera√ß√£o).</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex Technologies</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um modelo com um limite di√°rio de transa√ß√µes para o Yandex, mas com mais de 25 mil pedidos leais. </font><font style="vertical-align: inherit;">Se voc√™ multiplicar esse n√∫mero pelo n√∫mero de dias em um m√™s, obt√©m um n√∫mero impressionante de 750 mil. </font><font style="vertical-align: inherit;">O site apresenta pre√ßos para mais mil transa√ß√µes em rublos, variando de 120 rublos. </font><font style="vertical-align: inherit;">at√© 11 rublos </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O geocoder de pacote como um servi√ßo n√£o √© apresentado, portanto, para obter algum tipo de otimiza√ß√£o falhar√°.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESRI</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um plano gratuito muito tentador, com 1 milh√£o de transa√ß√µes por m√™s. </font><font style="vertical-align: inherit;">A empresa tamb√©m cobra 50 cr√©ditos em cada conta (equivalente aproximado de US $ 5). </font><font style="vertical-align: inherit;">Vale ressaltar que este √© o plano mais fiel para o uso dos servi√ßos de geolocaliza√ß√£o. </font><font style="vertical-align: inherit;">Tamb√©m existe um servi√ßo de geocodifica√ß√£o em lote, mas voc√™ pode us√°-lo apenas se tiver uma conta corporativa na plataforma ArcGIS Online.</font></font><br>
<br>
<h4><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que escolher no final?</font></font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maneira mais f√°cil √© fazer uma escolha, compilando uma pequena tabela: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/xy/b1/kgxyb1kmzemqxqicwajfi7hggva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, minha escolha caiu AQUI, pois √© a melhor op√ß√£o para resolver meu problema. </font><font style="vertical-align: inherit;">Obviamente, eu fiz muito longe da an√°lise completa; idealmente, voc√™ precisa executar seu conjunto de dados por todos os geocodificadores para avaliar a qualidade. </font><font style="vertical-align: inherit;">Al√©m disso, se voc√™ tiver v√°rios milh√µes de endere√ßos, pense em um pacote pago e precisar√° levar em considera√ß√£o o custo da adi√ß√£o. </font><font style="vertical-align: inherit;">transa√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O objetivo do artigo n√£o √© comparar empresas, mas resolver o problema de otimizar a geocodifica√ß√£o de um grande volume de endere√ßos. </font><font style="vertical-align: inherit;">Eu apenas mostrei meus pensamentos ao escolher um provedor de servi√ßos.</font></font><br>
<br>
<a name="guide"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guia de Servi√ßo Python</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, voc√™ precisa criar uma conta no portal para desenvolvedores e gerar uma REST API KEY na se√ß√£o do projeto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ pode trabalhar com a plataforma. </font><font style="vertical-align: inherit;">Descreverei apenas parte da funcionalidade do geocoder do pacote HERE: carregamento de dados, verifica√ß√£o de status, salvamento de resultados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, vamos come√ßar importando as bibliotecas necess√°rias:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, se nenhum erro ocorreu, crie uma classe:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Batch</span>:</span><font></font>
<font></font>
    SERVICE_URL = <span class="hljs-string">"https://batch.geocoder.ls.hereapi.com/6.2/jobs"</span>
    jobId = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, apikey=<span class="hljs-string">"your_api_key"</span></span>):</span><font></font>
        self.apikey = apikey<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, durante a inicializa√ß√£o, a classe deve passar sua pr√≥pria chave para a API REST. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A vari√°vel SERVICE_URL √© a URL base para trabalhar com o servi√ßo de geocodifica√ß√£o em lote. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E em jobId, o identificador do trabalho atual do geocoder ser√° armazenado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um ponto importante √© a estrutura de dados correta, mediante solicita√ß√£o. </font><font style="vertical-align: inherit;">O arquivo deve conter duas colunas obrigat√≥rias: recId e searchText. </font><font style="vertical-align: inherit;">Caso contr√°rio, o servi√ßo retornar√° uma resposta com informa√ß√µes sobre o erro de download. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° um exemplo de conjunto de dados:</font></font><br>
<br>
<pre><code class="plaintext hljs">   recId; searchText<font></font>
   1; -, . , 6<font></font>
   2; ,  1,  -., 72<font></font>
   3; 425 W Randolph St Chicago IL 60606<font></font>
   4; , DJ106 20-30, Sibiu 557260<font></font>
   5; 200 S Mathilda Ave Sunnyvale CA 94086<font></font>
  </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fun√ß√£o para carregar um arquivo na nuvem:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self, filename, indelim=<span class="hljs-string">";"</span>, outdelim=<span class="hljs-string">";"</span></span>):</span><font></font>
        <font></font>
        file = open(filename, <span class="hljs-string">'rb'</span>)<font></font>
<font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"run"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,
            <span class="hljs-string">"politicalview"</span>:<span class="hljs-string">"RUS"</span>,
            <span class="hljs-string">"gen"</span>: <span class="hljs-number">9</span>,
            <span class="hljs-string">"maxresults"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"header"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"indelim"</span>: indelim,
            <span class="hljs-string">"outdelim"</span>: outdelim,
            <span class="hljs-string">"outcols"</span>: <span class="hljs-string">"displayLatitude,displayLongitude,locationLabel,houseNumber,street,district,city,postalCode,county,state,country"</span>,
            <span class="hljs-string">"outputcombined"</span>: <span class="hljs-string">"true"</span>,<font></font>
        }<font></font>
<font></font>
        response = requests.post(self.SERVICE_URL, params=params, data=file)<font></font>
        self.__stats (response)<font></font>
        file.close()<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo √© bem simples, abra um arquivo com uma lista de endere√ßos para leitura, forme um dicion√°rio de par√¢metros de solicita√ß√£o GET. </font><font style="vertical-align: inherit;">Vale a pena explicar alguns par√¢metros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"A√ß√£o": "executar" - in√≠cio do processamento de endere√ßos;</font></font></li>
<li>‚ÄúpoliticalView‚Äù: ‚ÄúRUS‚Äù ‚Äì    .         (    );</li>
<li>‚Äúgen‚Äù: 9 ‚Äì   (   );</li>
<li>‚Äúmaxresults‚Äù: 1 ‚Äì          ;</li>
<li>‚Äúheader‚Äù: true ‚Äì        ;</li>
<li>‚Äúindelim‚Äù: ‚Äú;‚Äù ‚Äì   ,  ;</li>
<li>‚Äúoutdelim‚Äù: ‚Äú;‚Äù ‚Äì    ;</li>
<li>‚Äúoutcols‚Äù: ‚Äú‚Äù ‚Äì  ,      ;</li>
<li>‚Äúoutcombined‚Äù: true ‚Äì                .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, basta enviar uma solicita√ß√£o usando a biblioteca de solicita√ß√µes e exibir estat√≠sticas. </font><font style="vertical-align: inherit;">Obviamente, voc√™ precisa fechar o arquivo no final da fun√ß√£o. </font><font style="vertical-align: inherit;">A fun√ß√£o __stats analisa a resposta do servidor, que cont√©m o ID do trabalho em execu√ß√£o, e tamb√©m exibe informa√ß√µes gerais sobre a opera√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥ximo passo √© verificar o status do trabalho. </font><font style="vertical-align: inherit;">A solicita√ß√£o √© formada de maneira semelhante, apenas √© necess√°rio transferir o ID da opera√ß√£o. </font><font style="vertical-align: inherit;">O par√¢metro de a√ß√£o deve conter o valor "status". </font><font style="vertical-align: inherit;">A fun√ß√£o __stats exibe estat√≠sticas completas no console para estimar o tempo de desligamento do geocoder.</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        statusUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId<font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"status"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,<font></font>
        }<font></font>
        <font></font>
        response = requests.get(statusUrl, params=params)<font></font>
        self.__stats (response)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma das fun√ß√µes mais importantes √© salvar o resultado. </font><font style="vertical-align: inherit;">Por conveni√™ncia, √© melhor descompactar imediatamente o arquivo que vem do servidor. </font><font style="vertical-align: inherit;">A solicita√ß√£o para salvar o arquivo √© id√™ntica √† verifica√ß√£o do status, basta adicionar / resultado no final.</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        print(<span class="hljs-string">"Requesting result data ..."</span>)<font></font>
        <font></font>
        resultUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId + <span class="hljs-string">"/result"</span><font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"apiKey"</span>: self.apikey<font></font>
        }<font></font>
        <font></font>
        response = requests.get(resultUrl, params=params, stream=<span class="hljs-literal">True</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (response.ok):    <font></font>
            zipResult = zipfile.ZipFile(io.BytesIO(response.content))<font></font>
            zipResult.extractall()<font></font>
            print(<span class="hljs-string">"File saved successfully"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"Error"</span>)<font></font>
            print(response.text)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o final para analisar a resposta do servi√ßo. </font><font style="vertical-align: inherit;">Sua tarefa tamb√©m √© salvar o identificador da tarefa de geocodifica√ß√£o atual:</font></font><br>
<br>
<pre><code class="python hljs">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__stats</span> (<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> (response.ok):<font></font>
            parsedXMLResponse = BeautifulSoup(response.text, <span class="hljs-string">"lxml"</span>)<font></font>
<font></font>
            self.jobId = parsedXMLResponse.find(<span class="hljs-string">'requestid'</span>).get_text()<font></font>
            <font></font>
            <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> parsedXMLResponse.find(<span class="hljs-string">'response'</span>).findChildren():
                <span class="hljs-keyword">if</span>(len(stat.findChildren()) == <span class="hljs-number">0</span>):<font></font>
                    print(<span class="hljs-string">"{name}: {data}"</span>.format(name=stat.name, data=stat.get_text()))<font></font>
<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(response.text)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para test√°-lo, basta executar o interpretador Python na pasta de scripts. </font><font style="vertical-align: inherit;">A classe Batch est√° no arquivo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geocoder.py</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; from geocoder import Batch<font></font>
&gt;&gt;&gt; service = Batch(apikey="   REST API")<font></font>
&gt;&gt;&gt; service.start("big_data_addresses.csv", indelim=";", outdelim=";")<font></font>
<font></font>
requestid: "  Id "<font></font>
status: accepted<font></font>
totalcount: 0<font></font>
validcount: 0<font></font>
invalidcount: 0<font></font>
processedcount: 0<font></font>
pendingcount: 0<font></font>
successcount: 0<font></font>
errorcount: 0<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√ìtimo trabalho iniciado. </font><font style="vertical-align: inherit;">Verifique o status:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; service.status()<font></font>
<font></font>
requestid: "  Id "<font></font>
status: completed<font></font>
jobstarted: 2020-04-27T10:09:58.000Z<font></font>
jobfinished: 2020-04-27T10:17:18.000Z<font></font>
totalcount: 249999<font></font>
validcount: 249999<font></font>
invalidcount: 0<font></font>
processedcount: 249999<font></font>
pendingcount: 0<font></font>
successcount: 249978<font></font>
errorcount: 21<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que o processamento do conjunto de dados est√° completo. </font><font style="vertical-align: inherit;">Em apenas sete minutos, foi poss√≠vel procodificar os 250 mil endere√ßos (excluindo erros - contagem de erros). </font><font style="vertical-align: inherit;">Resta salvar os resultados:</font></font><br>
<br>
<pre><code class="plaintext hljs">&gt;&gt;&gt; service.result()<font></font>
Requesting result data ...<font></font>
File saved successfully<font></font>
</code></pre><br>
<a name="code"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descri√ß√£o da classe de lote completo</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu acho que n√£o d√≥i adicionar o script completamente:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Batch</span>:</span><font></font>
<font></font>
    SERVICE_URL = <span class="hljs-string">"https://batch.geocoder.ls.hereapi.com/6.2/jobs"</span>
    jobId = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, apikey=<span class="hljs-string">"   REST API "</span></span>):</span><font></font>
        self.apikey = apikey<font></font>
        <font></font>
            <font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self, filename, indelim=<span class="hljs-string">";"</span>, outdelim=<span class="hljs-string">";"</span></span>):</span><font></font>
        <font></font>
        file = open(filename, <span class="hljs-string">'rb'</span>)<font></font>
<font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"run"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,
            <span class="hljs-string">"politicalview"</span>:<span class="hljs-string">"RUS"</span>,
            <span class="hljs-string">"gen"</span>: <span class="hljs-number">9</span>,
            <span class="hljs-string">"maxresults"</span>: <span class="hljs-string">"1"</span>,
            <span class="hljs-string">"header"</span>: <span class="hljs-string">"true"</span>,
            <span class="hljs-string">"indelim"</span>: indelim,
            <span class="hljs-string">"outdelim"</span>: outdelim,
            <span class="hljs-string">"outcols"</span>: <span class="hljs-string">"displayLatitude,displayLongitude,locationLabel,houseNumber,street,district,city,postalCode,county,state,country"</span>,
            <span class="hljs-string">"outputcombined"</span>: <span class="hljs-string">"true"</span>,<font></font>
        }<font></font>
<font></font>
        response = requests.post(self.SERVICE_URL, params=params, data=file)<font></font>
        self.__stats (response)<font></font>
        file.close()<font></font>
    <font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">status</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        statusUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId<font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"status"</span>,
            <span class="hljs-string">"apiKey"</span>: self.apikey,<font></font>
        }<font></font>
        <font></font>
        response = requests.get(statusUrl, params=params)<font></font>
        self.__stats (response)<font></font>
        <font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span> (<span class="hljs-params">self, jobId = None</span>):</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> jobId <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.jobId = jobId<font></font>
        <font></font>
        print(<span class="hljs-string">"Requesting result data ..."</span>)<font></font>
        <font></font>
        resultUrl = self.SERVICE_URL + <span class="hljs-string">"/"</span> + self.jobId + <span class="hljs-string">"/result"</span><font></font>
        <font></font>
        params = {<font></font>
            <span class="hljs-string">"apiKey"</span>: self.apikey<font></font>
        }<font></font>
        <font></font>
        response = requests.get(resultUrl, params=params, stream=<span class="hljs-literal">True</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> (response.ok):    <font></font>
            zipResult = zipfile.ZipFile(io.BytesIO(response.content))<font></font>
            zipResult.extractall()<font></font>
            print(<span class="hljs-string">"File saved successfully"</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(<span class="hljs-string">"Error"</span>)<font></font>
            print(response.text)<font></font>
    <font></font>
<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__stats</span> (<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> (response.ok):<font></font>
            parsedXMLResponse = BeautifulSoup(response.text, <span class="hljs-string">"lxml"</span>)<font></font>
<font></font>
            self.jobId = parsedXMLResponse.find(<span class="hljs-string">'requestid'</span>).get_text()<font></font>
            <font></font>
            <span class="hljs-keyword">for</span> stat <span class="hljs-keyword">in</span> parsedXMLResponse.find(<span class="hljs-string">'response'</span>).findChildren():
                <span class="hljs-keyword">if</span>(len(stat.findChildren()) == <span class="hljs-number">0</span>):<font></font>
                    print(<span class="hljs-string">"{name}: {data}"</span>.format(name=stat.name, data=stat.get_text()))<font></font>
<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            print(response.text)<font></font>
</code></pre><br>
<a name="result"></a><h3><font color="#9cc2ce"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lise de Resultados</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, passei de aplicativos on-line trabalhando lentamente para servi√ßos de geocodifica√ß√£o em lote. </font><font style="vertical-align: inherit;">A escolha de um provedor de servi√ßos geogr√°ficos depende inteiramente das tarefas que o confrontam. </font><font style="vertical-align: inherit;">Recebo regularmente solicita√ß√µes para processar um grande n√∫mero de endere√ßos, e a abordagem descrita no artigo ajudou a reduzir significativamente o tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que este artigo seja √∫til e, claro, estou aberto a coment√°rios e acr√©scimos!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499974/index.html">Jogos em 3D no Instagram Javascript ou rota de salsicha</a></li>
<li><a href="../pt499978/index.html">Tradu√ß√£o do livro de Andrew Un, Passion for Machine Learning, Cap√≠tulos 36 e 37</a></li>
<li><a href="../pt499982/index.html">Plano do testador iniciante: de "Insira TI" a "Eu sou um engenheiro!"</a></li>
<li><a href="../pt499986/index.html">E, novamente, sobre incorporado: procurando bugs no projeto Embox</a></li>
<li><a href="../pt499988/index.html">A√ß√∫car e COVID-19</a></li>
<li><a href="../pt499992/index.html">Projetar tecnologias para a implementa√ß√£o de sistemas de cobran√ßa para clientes corporativos (parte 2)</a></li>
<li><a href="../pt499994/index.html">Quando o coronav√≠rus terminar√°</a></li>
<li><a href="../pt500000/index.html">Para o dia do r√°dio. Comunica√ß√£o - os nervos da guerra</a></li>
<li><a href="../pt500002/index.html">Especialistas em TI versus vendedores: e o mundo rachou ao meio</a></li>
<li><a href="../pt500008/index.html">Conhe√ßa upscalers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>