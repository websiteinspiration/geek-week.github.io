<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüè´ üåç ü§• GO Scheduler: ¬øAhora no es cooperativo? ‚úäüèΩ üò† üîó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si ley√≥ las notas de la versi√≥n GO 1.14, probablemente not√≥ algunos cambios bastante interesantes en el tiempo de ejecuci√≥n del lenguaje. As√≠ que esta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GO Scheduler: ¬øAhora no es cooperativo?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502506/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si ley√≥ las notas de la versi√≥n GO 1.14, probablemente not√≥ algunos cambios bastante interesantes en el tiempo de ejecuci√≥n del lenguaje. </font><font style="vertical-align: inherit;">As√≠ que estaba muy interesado en el √≠tem: "Las goroutinas ahora son asincr√≥nicamente preventivas". </font><font style="vertical-align: inherit;">Resulta que el planificador GO (planificador) ahora no es cooperativo? </font><font style="vertical-align: inherit;">Bueno, despu√©s de leer la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propuesta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> correspondiente en diagonal, la </font><font style="vertical-align: inherit;">curiosidad qued√≥ satisfecha. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, despu√©s de un tiempo decid√≠ investigar las innovaciones con m√°s detalle. </font><font style="vertical-align: inherit;">Me gustar√≠a compartir los resultados de estos estudios.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/s0/ur/hn/s0urhnlqgwhwtkwumpnyd2hfmyy.png" alt="imagen"><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Requisitos del sistema</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las cosas que se describen a continuaci√≥n requieren del lector, adem√°s del conocimiento del lenguaje GO, conocimiento adicional, a saber:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comprensi√≥n de los principios del planificador (aunque tratar√© de explicar a continuaci√≥n, "en los dedos")</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> entender c√≥mo funciona el recolector de basura</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> entendiendo qu√© es el ensamblador GO </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final, dejar√© un par de enlaces que, en mi opini√≥n, cubren bien estos temas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brevemente sobre el planificador</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, perm√≠teme recordarte qu√© es la multitarea cooperativa y no cooperativa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con la multitarea no cooperativa (desplazamiento), todos estamos familiarizados con el ejemplo del planificador del sistema operativo. Este programador funciona en segundo plano, descarga subprocesos basados ‚Äã‚Äãen varias heur√≠sticas y, en lugar del tiempo de CPU descargado, comienzan a recibir otros subprocesos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El planificador cooperativo se caracteriza por un comportamiento diferente: duerme hasta que una de las gorutinas lo despierta claramente con un toque de disposici√≥n para darle su lugar a otro. El planificador decidir√° por s√≠ mismo si es necesario eliminar la gorutina actual del contexto y, de ser as√≠, a qui√©n colocar en su lugar. As√≠ funcionaba el planificador GO. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, consideramos las piedras angulares con las que opera el planificador:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P - procesadores l√≥gicos (podemos cambiar su n√∫mero con el tiempo de ejecuci√≥n. Funci√≥n GOMAXPROCS), en cada procesador l√≥gico se puede ejecutar una rutina de forma independiente a la vez. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M: subprocesos del sistema operativo. </font><font style="vertical-align: inherit;">Cada P se ejecuta en un subproceso de M. Tenga en cuenta que P no siempre es igual a M, por ejemplo, un subproceso puede ser bloqueado por syscall y luego se asignar√° otro subproceso para su P. </font><font style="vertical-align: inherit;">Y hay CGO y otros y otros matices.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G - gorutinas. </font><font style="vertical-align: inherit;">Bueno, aqu√≠ est√° claro, G debe ejecutarse en cada P y el planificador lo monitorea.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y lo √∫ltimo que necesita saber, ¬øy cu√°ndo llama realmente el planificador goroutine? </font><font style="vertical-align: inherit;">Es simple, por lo general, el compilador inserta instrucciones para llamar al principio del cuerpo (pr√≥logo) de la funci√≥n (un poco m√°s adelante hablaremos de esto con m√°s detalle).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øY cu√°l es el problema en realidad?</font></font></h3><br>
<img src="https://habrastorage.org/webt/8o/fa/qt/8ofaqt_aquvkvzoskizadsuzfyw.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde el comienzo del art√≠culo, ya entendi√≥ que el principio del trabajo del planificador ha cambiado en GO, veamos las razones por las que se hicieron estos cambios. </font><font style="vertical-align: inherit;">Echa un vistazo al c√≥digo:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debajo del spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	runtime.GOMAXPROCS(<span class="hljs-number">1</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">var</span> u <span class="hljs-keyword">int</span>
		<span class="hljs-keyword">for</span> {<font></font>
			u -= <span class="hljs-number">2</span>
			<span class="hljs-keyword">if</span> u == <span class="hljs-number">1</span> {
				<span class="hljs-keyword">break</span><font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
	&lt;-time.After(time.Millisecond * <span class="hljs-number">5</span>) <span class="hljs-comment">//    main   ,         </span><font></font>
<font></font>
	fmt.Println(<span class="hljs-string">"go 1.13 has never been here"</span>)<font></font>
}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si lo compila con la versi√≥n GO &lt;1.14, entonces la l√≠nea "go 1.13 nunca ha estado aqu√≠" no ver√° en la pantalla. </font><font style="vertical-align: inherit;">Esto sucede porque, tan pronto como el planificador le da tiempo al procesador a la rutina con un bucle infinito, captura completamente P, no se producen llamadas de funci√≥n dentro de esta rutina, lo que significa que ya no activaremos al planificador. </font><font style="vertical-align: inherit;">Y solo una llamada expl√≠cita a runtime.Gosched () permitir√° que nuestro programa finalice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es solo un ejemplo en el que goroutine captura P y durante mucho tiempo evita que otras goroutines se ejecuten en este P. Se pueden encontrar m√°s opciones cuando este comportamiento causa problemas leyendo la propuesta.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propuesta Parse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soluci√≥n a este problema es bastante simple. ¬°Hagamos lo mismo que en el planificador del sistema operativo! Solo deje que GO agote la rutina de P y ponga otra all√≠, y para esto usaremos las herramientas del sistema operativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OK, ¬øc√≥mo implementar esto? Permitiremos que el tiempo de ejecuci√≥n env√≠e una se√±al al flujo en el que trabaja la rutina. Registraremos el procesador de esta se√±al en cada flujo desde M, la tarea del procesador es determinar si la actual rutina puede ser suplantada. Si es as√≠, guardaremos su estado actual (registros y el estado de la pila) y le daremos recursos a otro, de lo contrario, continuaremos ejecutando la rutina actual. Vale la pena se√±alar que el concepto con una se√±al es una soluci√≥n para sistemas basados ‚Äã‚Äãen UNIX, mientras que, por ejemplo, la implementaci√≥n para Windows es ligeramente diferente. Por cierto, SIGURG fue seleccionado como una se√±al para enviar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La parte m√°s dif√≠cil de esta implementaci√≥n es determinar si la gorutina puede ser expulsada. </font><font style="vertical-align: inherit;">El hecho es que algunos lugares en nuestro c√≥digo deben ser at√≥micos, desde el punto de vista del recolector de basura. </font><font style="vertical-align: inherit;">Llamamos a estos lugares puntos inseguros. </font><font style="vertical-align: inherit;">Si exprimimos goroutine en el momento de la ejecuci√≥n del c√≥digo desde un punto inseguro, y luego GC se inicia, reemplazar√° el estado de nuestra goroutine, tomado en un punto inseguro, y puede hacer cosas. </font><font style="vertical-align: inherit;">Echemos un vistazo m√°s de cerca al concepto seguro / inseguro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øFuiste all√≠, GC?</font></font></h3><br>
<img src="https://habrastorage.org/webt/yw/ao/mw/ywaomwcstazbytzl9gwewm9agy8.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En versiones anteriores a 1.12, el tiempo de ejecuci√≥n Gosched utilizaba puntos seguros en lugares donde definitivamente se pod√≠a llamar al programador sin temor a que terminara en la secci√≥n at√≥mica del c√≥digo para GC. </font><font style="vertical-align: inherit;">Como ya dijimos, los datos de puntos seguros se encuentran en el pr√≥logo de una funci√≥n (pero no de cada funci√≥n, eso s√≠). </font><font style="vertical-align: inherit;">Si desarm√≥ el ensamblador go-shn, podr√≠a objetar: no hay llamadas obvias del planificador visibles all√≠. </font><font style="vertical-align: inherit;">S√≠, lo es, pero puede encontrar la instrucci√≥n de llamada runtime.morestack all√≠, y si mira dentro de esta funci√≥n, se encontrar√° una llamada del planificador. </font><font style="vertical-align: inherit;">Debajo del spoiler, ocultar√© el comentario de las fuentes de GO, o puedes encontrar el ensamblador para morestack t√∫ mismo.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encontrado en la fuente</font></font></b>
                        <div class="spoiler_text">Synchronous safe-points are implemented by overloading the stack bound check in function prologues. To preempt a goroutine at the next synchronous safe-point, the runtime poisons the goroutine's stack bound to a value that will cause the next stack bound check to fail and enter the stack growth implementation, which will detect that it was actually a preemption and redirect to preemption handling.<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, al cambiar a un concepto de desplazamiento, una se√±al de desplazamiento puede atrapar a nuestro gorutin en cualquier lugar. ¬°Pero los autores de GO decidieron no dejar puntos seguros, sino declarar puntos seguros en todas partes! Bueno, por supuesto, hay una trampa, de hecho, casi en todas partes. Como se mencion√≥ anteriormente, hay algunos puntos inseguros en los que no forzaremos a nadie. Escribamos un punto inseguro simple.</font></font><br>
<br>
<pre><code class="go hljs"><font></font>
j := &amp;someStruct{}<font></font>
p := unsafe.Pointer(j)<font></font>
<span class="hljs-comment">// unsafe-point start</span>
u := <span class="hljs-keyword">uintptr</span>(p)
<span class="hljs-comment">//do some stuff here</span><font></font>
p = unsafe.Pointer(u)<font></font>
<span class="hljs-comment">// unsafe-point end</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender cu√°l es el problema, prob√©mosle la piel a un recolector de basura. Cada vez que vamos a trabajar, necesitamos encontrar los nodos ra√≠z (punteros en la pila y en los registros), con los cuales comenzaremos a marcar. Como es imposible decir en tiempo de ejecuci√≥n si 64 bytes en la memoria son un puntero o simplemente un n√∫mero, recurrimos a la pila y registramos las tarjetas (algo de cach√© con metainformaci√≥n), amablemente proporcionadas por el compilador GO. La informaci√≥n en estos mapas nos permite encontrar punteros. Entonces, nos despertaron y nos enviaron a trabajar cuando GO realiz√≥ la l√≠nea n√∫mero 4. Al llegar al lugar y mirar las cartas, descubrimos que estaba vac√≠o (y esto es cierto, porque uintptr desde el punto de vista de GC es un n√∫mero y no un puntero). Bueno, ayer nos enteramos de la asignaci√≥n de memoria para j, ya que ahora no podemos acceder a esta memoria, tenemos que limpiarla, y despu√©s de eliminar la memoria nos vamos a dormir.¬øQue sigue? Bueno, las autoridades se despertaron, por la noche, gritando, bueno, t√∫ mismo entendiste.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo eso es teor√≠a, propongo considerar en la pr√°ctica c√≥mo funcionan todas estas se√±ales, puntos inseguros y tarjetas de registro y pilas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pasemos a practicar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecut√© dos veces (vaya a 1.14 y vaya a 1.13) un ejemplo del principio del art√≠culo del perfilador perf para ver qu√© llamadas al sistema est√°n sucediendo y compararlas. </font><font style="vertical-align: inherit;">La llamada al sistema requerida en la versi√≥n 14 se encontr√≥ con bastante rapidez:</font></font><br>
<br>
<pre><code class="plaintext hljs">15.652 ( 0.003 ms): main/29614 tgkill(tgid: 29613 (main), pid: 29613 (main), sig: URG                ) = 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, obviamente el tiempo de ejecuci√≥n envi√≥ a SIGURG al hilo en el que gira la rutina. </font><font style="vertical-align: inherit;">Tomando este conocimiento como punto de partida, fui a ver los commits en GO para encontrar d√≥nde y por qu√© se env√≠a esta se√±al, y tambi√©n para encontrar el lugar donde est√° instalado el controlador de se√±al. </font><font style="vertical-align: inherit;">Comencemos con el env√≠o, encontraremos la funci√≥n de env√≠o de se√±al en runtime / os_linux.go</font></font><br>
<br>
<pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">signalM</span><span class="hljs-params">(mp *m, sig <span class="hljs-keyword">int</span>)</span></span> {<font></font>
	tgkill(getpid(), <span class="hljs-keyword">int</span>(mp.procid), sig)<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora encontramos lugares en el c√≥digo de tiempo de ejecuci√≥n, desde donde enviamos la se√±al:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuando goroutine se suspende, si est√° en estado de ejecuci√≥n. </font><font style="vertical-align: inherit;">La solicitud de suspensi√≥n proviene del recolector de basura. </font><font style="vertical-align: inherit;">Aqu√≠, quiz√°s, no agregar√© c√≥digo, pero se puede encontrar en el archivo runtime / preempt.go (suspendG)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si el programador decide que goroutine funciona demasiado tiempo, runtime / proc.go (retomar)</font></font><br>
<pre><code class="go hljs">
<span class="hljs-keyword">if</span> pd.schedwhen+forcePreemptNS &lt;= now {<font></font>
	signalM(_p_)<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
forcePreemptNS: constante igual a 10 ms, pd.schedwhen: hora en que se llam√≥ por √∫ltima vez al programador de la secuencia pd</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Adem√°s de todas las transmisiones, esta se√±al se env√≠a durante un p√°nico, StopTheWorld (GC) y algunos casos m√°s (que tengo que omitir, porque el tama√±o del art√≠culo ya ir√° m√°s all√° de los l√≠mites)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descubrimos c√≥mo y cu√°ndo el tiempo de ejecuci√≥n env√≠a una se√±al a M. </font><font style="vertical-align: inherit;">Ahora busquemos el controlador para esta se√±al y veamos qu√© hace el flujo cuando se recibe.</font></font><br>
<br>
<pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doSigPreempt</span><span class="hljs-params">(gp *g, ctxt *sigctxt)</span></span> {
	<span class="hljs-keyword">if</span> wantAsyncPreempt(gp) &amp;&amp; isAsyncSafePoint(gp, ctxt.sigpc(), ctxt.sigsp(), ctxt.siglr()) {
		<span class="hljs-comment">// Inject a call to asyncPreempt.</span><font></font>
		ctxt.pushCall(funcPC(asyncPreempt))<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir de esta funci√≥n, est√° claro que para "bloquear" debe pasar por 2 verificaciones:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wantAsyncPreempt: verificamos si G quiere ser expulsado, aqu√≠, por ejemplo, se verificar√° la validez del estado actual de la rutina.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isAsyncSafePoint: compruebe si se puede desplazar en este momento. </font><font style="vertical-align: inherit;">Lo m√°s interesante de las comprobaciones aqu√≠ es si G est√° en un punto seguro o inseguro. </font><font style="vertical-align: inherit;">Adem√°s, debemos estar seguros de que el subproceso en el que se ejecuta G tambi√©n est√° listo para evitar G.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si se pasan ambas comprobaciones, se invocar√°n instrucciones desde el c√≥digo ejecutable que guarda el estado G y llama al planificador.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y m√°s sobre inseguro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Propongo analizar un nuevo ejemplo, ilustrar√° otro caso con punto inseguro:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otro programa sin fin</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-comment">//go:nosplit</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">infiniteLoop</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">var</span> u <span class="hljs-keyword">int</span>
	<span class="hljs-keyword">for</span> {<font></font>
		u -= <span class="hljs-number">2</span>
		<span class="hljs-keyword">if</span> u == <span class="hljs-number">1</span> {
			<span class="hljs-keyword">break</span><font></font>
		}<font></font>
	}<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	runtime.GOMAXPROCS(<span class="hljs-number">1</span>)
	<span class="hljs-keyword">go</span> infiniteLoop()<font></font>
	&lt;-time.After(time.Millisecond * <span class="hljs-number">5</span>)<font></font>
<font></font>
	fmt.Println(<span class="hljs-string">"go 1.13 and 1.14 has never been here"</span>)<font></font>
}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede suponer, la inscripci√≥n "vaya 1.13 y 1.14 nunca estuvo aqu√≠" no la veremos en GO 1.14. </font><font style="vertical-align: inherit;">Esto se debe a que hemos prohibido expl√≠citamente interrumpir la funci√≥n infiniteLoop (go: nosplit). </font><font style="vertical-align: inherit;">Dicha prohibici√≥n se implementa simplemente usando un punto inseguro, que es el cuerpo completo de la funci√≥n. </font><font style="vertical-align: inherit;">Veamos qu√© gener√≥ el compilador para la funci√≥n infiniteLoop.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensamblador de precauci√≥n</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   TEXT    <span class="hljs-string">""</span>.infiniteLoop(SB), NOSPLIT|ABIInternal, $<span class="hljs-number">0</span><span class="hljs-number">-0</span>
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   PCDATA  $<span class="hljs-number">0</span>, $<span class="hljs-number">-2</span>
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   PCDATA  $<span class="hljs-number">1</span>, $<span class="hljs-number">-2</span>
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   FUNCDATA        $<span class="hljs-number">0</span>, gclocals¬∑<span class="hljs-number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   FUNCDATA        $<span class="hljs-number">1</span>, gclocals¬∑<span class="hljs-number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   FUNCDATA        $<span class="hljs-number">2</span>, gclocals¬∑<span class="hljs-number">33</span>cdeccccebe80329f1fdbee7f5874cb(SB)
        <span class="hljs-number">0x0000</span> <span class="hljs-number">00000</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">10</span>)   XORL    AX, AX
        <span class="hljs-number">0x0002</span> <span class="hljs-number">00002</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">12</span>)   JMP     <span class="hljs-number">8</span>
        <span class="hljs-number">0x0004</span> <span class="hljs-number">00004</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">13</span>)   ADDQ    $<span class="hljs-number">-2</span>, AX
        <span class="hljs-number">0x0008</span> <span class="hljs-number">00008</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span>)   CMPQ    AX, $<span class="hljs-number">3</span>
        <span class="hljs-number">0x000c</span> <span class="hljs-number">00012</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">14</span>)   JNE     <span class="hljs-number">4</span>
        <span class="hljs-number">0x000e</span> <span class="hljs-number">00014</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">15</span>)   PCDATA  $<span class="hljs-number">0</span>, $<span class="hljs-number">-1</span>
        <span class="hljs-number">0x000e</span> <span class="hljs-number">00014</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">15</span>)   PCDATA  $<span class="hljs-number">1</span>, $<span class="hljs-number">-1</span>
        <span class="hljs-number">0x000e</span> <span class="hljs-number">00014</span> (main.<span class="hljs-keyword">go</span>:<span class="hljs-number">15</span>)   RET
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nuestro caso, la instrucci√≥n PCDATA es de inter√©s. </font><font style="vertical-align: inherit;">Cuando el vinculador ve esta instrucci√≥n, no la convierte en un ensamblador "real". </font><font style="vertical-align: inherit;">En cambio, el valor del segundo argumento con la clave igual al contador del programa correspondiente (el n√∫mero que se puede observar a la izquierda del nombre de la funci√≥n + l√≠nea) se colocar√° en el mapa de registro o pila (determinado por el primer argumento). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como vemos en las l√≠neas 10 y 15, colocamos los valores $ 2 y -1 en el mapa $ 0 y $ 1, respectivamente. </font><font style="vertical-align: inherit;">Recordemos este momento y echemos un vistazo dentro de la funci√≥n isAsyncSafePoint, a la que ya he llamado su atenci√≥n. </font><font style="vertical-align: inherit;">All√≠ veremos las siguientes l√≠neas:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isAsyncSafePoint</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
	smi := pcdatavalue(f, _PCDATA_RegMapIndex, pc, <span class="hljs-literal">nil</span>)
	<span class="hljs-keyword">if</span> smi == <span class="hljs-number">-2</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><font></font>
	}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es en este lugar donde verificamos si goroutine se encuentra actualmente en el punto seguro. </font><font style="vertical-align: inherit;">Pasamos al mapa de registros (_PCDATA_RegMapIndex = 0), y pas√°ndolo al PC actual verificamos el valor, si -2 entonces G no est√° en un punto seguro 'e, lo que significa que no puede ser desplazado.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Detuve mi "investigaci√≥n" sobre esto, espero que el art√≠culo sea √∫til para usted tambi√©n. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Publico los enlaces prometidos, pero tenga cuidado, porque parte de la informaci√≥n en estos art√≠culos podr√≠a estar desactualizada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Planificador GO: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dos veces</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensamblador GO.</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es502494/index.html">7 errores de un Black Friday y c√≥mo funciona Magento Cloud - video</a></li>
<li><a href="../es502496/index.html">F√°cil acceso web a aplicaciones PHP LabVIEW VI a trav√©s del servidor ActiveX</a></li>
<li><a href="../es502498/index.html">Mejores pr√°cticas para mejorar el rendimiento en C #</a></li>
<li><a href="../es502500/index.html">La evoluci√≥n de un esc√°ner de pasaportes: desde artesan√≠as de madera contrachapada hasta negocios reales</a></li>
<li><a href="../es502504/index.html">Rodea el d√≠gito del usuario</a></li>
<li><a href="../es502508/index.html">Trolley Robot 2.0. Parte 2. Gesti√≥n en rviz y sin ella Elementos de belleza en rviz</a></li>
<li><a href="../es502510/index.html">Que guardar en la nube</a></li>
<li><a href="../es502512/index.html">Resultados del concurso de expertos en sof√°s: las reglas del poking cient√≠fico</a></li>
<li><a href="../es502518/index.html">Como trepar a un √°rbol</a></li>
<li><a href="../es502520/index.html">Informes en video de informes mitap sobre an√°lisis de productos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>