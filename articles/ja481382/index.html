<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵🏼 🈂️ 🏪 WindowsネイティブアプリケーションとAcronis Active Restore 🤽🏾 🤽🏼 👩‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="今日、私たちは、イノポリス大学のメンバーと共に、障害発生後できるだけ早くユーザーが自分のマシンで作業を開始できるようにするActive Restoreテクノロジを開発している方法の物語を続けます。作成と起動の機能を含むネイティブWindowsアプリケーションについて説明します。カット-私たちのプロジ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WindowsネイティブアプリケーションとAcronis Active Restore</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acronis/blog/481382/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今日、私たちは、イノポリス大学のメンバーと共に、障害発生後できるだけ早くユーザーが自分のマシンで作業を開始できるようにするActive Restoreテクノロジを開発している方法の物語を続けます。</font><font style="vertical-align: inherit;">作成と起動の機能を含むネイティブWindowsアプリケーションについて説明します。</font><font style="vertical-align: inherit;">カット-私たちのプロジェクトについての少しだけでなく、ネイティブアプリケーションを作成する方法の実用的なガイド。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rc/bv/yl/rcbvylee_0ylshzywkrdlip0c9o.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前の投稿では、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Active Restore</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とは</font><font style="vertical-align: inherit;">何か</font><font style="vertical-align: inherit;">、Innopolisの学生が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発する方法</font><font style="vertical-align: inherit;">についてすでに</font><font style="vertical-align: inherit;">説明し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">今日は、アクティブな回復サービスを「埋め込んだ」レベルまでネイティブアプリケーションに集中したいと思います。</font><font style="vertical-align: inherit;">すべてがうまくいったら、次のことができます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス自体を開始するはるかに早い時期</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップが存在するクラウドに連絡するはるかに早い時期</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムがどのモードにあるか（通常のブートまたはリカバリ）を理解するのははるかに早いです</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事前にはるかに少ないファイルを復元するには</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーがさらに早く始められるようにします。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的にネイティブアプリケーションとは何ですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この質問に答えるために、たとえば、アプリケーションのプログラマーがファイルを作成しようとした場合に、システムが行う一連の呼び出しを見てみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gb/d_/a7/gbd_a7c7l1d-6dlo4zh-fygf5dm.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Yosifovich-Windows Kernel Programming（2019）</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
プログラマーは</font><font style="vertical-align: inherit;">、fileapi.hヘッダーファイルで宣言され、Kernel32.dllに実装され</font><font style="vertical-align: inherit;">ている</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を使用し</font><font style="vertical-align: inherit;">ます。ただし、この関数自体はファイルを作成せず、入力引数をチェックして</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">NtCreateFile</font></a><font style="vertical-align: inherit;">関数を呼び出す</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">だけ</font></a><font style="vertical-align: inherit;">です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（接頭辞Ntは、関数がネイティブであることを示すだけです）。この関数は、winternl.hヘッダーファイルで宣言され、ntdll.dllで実装されます。彼女は核空間に飛び込む準備をしてから、ファイルを作成するためのシステムコールを行います。この場合、Kernel32はNtdllの単なるラッパーであることがわかります。これが行われる理由の1つとして、Microsoftにはネイティブワールドの機能を変更する機能がありますが、標準のインターフェイスには触れません。マイクロソフトでは、ネイティブ関数を直接呼び出すことを推奨しておらず、それらのほとんどを文書化していません。ちなみに、ドキュメント化されていない機能は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネイティブアプリケーションの主な利点は、ntdllがkernel32よりはるかに早くシステムにロードされることです。</font><font style="vertical-align: inherit;">kernel32が動作するにはntdllが必要であるため、これは論理的です。</font><font style="vertical-align: inherit;">その結果、ネイティブ関数を使用するアプリケーションは、ずっと早く動作を開始できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、Windowsネイティブアプリケーションは、Windowsの起動の初期段階で実行できるプログラムです。</font><font style="vertical-align: inherit;">ntdllの関数のみを使用します。</font><font style="vertical-align: inherit;">このようなアプリケーションの例：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AUTOCHK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chkdiskユーティリティを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主なサービスを開始する前に、エラーのためにディスクをチェックします。</font><font style="vertical-align: inherit;">Active Restoreを見たいのはこのレベルです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは何が必要なのか？</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ドライバー開発キット）、現在はWDK 7（Windowsドライバーキット）とも呼ばれます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮想マシン（Windows 7 x64など）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必ずしもではありませんが、ヘッダーファイルは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここから</font></a><font style="vertical-align: inherit;">ダウンロードでき</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></a></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードには何がありますか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し練習してみましょう。例として、次のような小さなアプリケーションを作成します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画面にメッセージを表示します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少しのメモリを割り当てます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーボード入力を待っています</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジーメモリを解放します</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネイティブアプリケーションでは、エントリポイントはmainまたはwinmainではなく、NtProcessStartup関数です。これは、実際にシステムで新しいプロセスを直接開始するためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画面にメッセージを表示することから始めましょう。これを行うには、ネイティブ関数</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtDisplayStringを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用します。これは、UNICODE_STRING構造体のオブジェクトへのポインターを引数として受け取ります。 RtlInitUnicodeStringは初期化に役立ちます。その結果、画面にテキストを表示するために、次のような小さな関数を書くことができます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//usage: WriteLn(L"Here is my text\n");</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WriteLn</span><span class="hljs-params">(LPWSTR Message)</span>
</span>{<font></font>
    UNICODE_STRING <span class="hljs-built_in">string</span>;<font></font>
    RtlInitUnicodeString(&amp;<span class="hljs-built_in">string</span>, Message);<font></font>
    NtDisplayString(&amp;<span class="hljs-built_in">string</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntdllの関数しか使用できず、メモリには他のライブラリがまだないため、メモリの割り当て方法に問題があります。</font><font style="vertical-align: inherit;">新しい演算子はまだ存在しません（高レベルのC ++の世界からのものであるため）、malloc関数もありません（ランタイムCライブラリが必要です）。</font><font style="vertical-align: inherit;">もちろん、スタックのみを使用できます。</font><font style="vertical-align: inherit;">しかし、メモリを動的に割り当てる必要がある場合は、ヒープ（つまり、ヒープ）でこれを行う必要があります。</font><font style="vertical-align: inherit;">したがって、自分用に束を作成して、必要なときにそれからメモリを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RtlCreateHeapは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、このタスクに適しています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">さらに、RtlAllocateHeapおよびRtlFreeHeapを使用して、必要なときにメモリを占有して解放します。</font></font><br>
<br>
<pre><code class="cpp hljs">PVOID memory = <span class="hljs-literal">NULL</span>;<font></font>
PVOID buffer = <span class="hljs-literal">NULL</span>;<font></font>
ULONG bufferSize = <span class="hljs-number">42</span>;<font></font>
<font></font>
<span class="hljs-comment">// create heap in order to allocate memory later</span><font></font>
memory = RtlCreateHeap(<font></font>
  HEAP_GROWABLE, <font></font>
  <span class="hljs-literal">NULL</span>, 
  <span class="hljs-number">1000</span>, 
  <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span><font></font>
);<font></font>
<font></font>
<span class="hljs-comment">// allocate buffer of size bufferSize</span><font></font>
buffer = RtlAllocateHeap(<font></font>
  memory, <font></font>
  HEAP_ZERO_MEMORY, <font></font>
  bufferSize<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">// free buffer (actually not needed because we destroy heap in next step)</span>
RtlFreeHeap(memory, <span class="hljs-number">0</span>, buffer);<font></font>
<font></font>
RtlDestroyHeap(memory);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーボード入力を待つことに移りましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// https://docs.microsoft.com/en-us/windows/win32/api/ntddkbd/ns-ntddkbd-keyboard_input_data</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">KEYBOARD_INPUT_DATA</span> {</span><font></font>
  USHORT UnitId;<font></font>
  USHORT MakeCode;<font></font>
  USHORT Flags;<font></font>
  USHORT Reserved;<font></font>
  ULONG  ExtraInformation;<font></font>
} KEYBOARD_INPUT_DATA, *PKEYBOARD_INPUT_DATA;<font></font>
<font></font>
<span class="hljs-comment">//...</span><font></font>
<font></font>
HANDLE hKeyBoard, hEvent;<font></font>
UNICODE_STRING skull, keyboard;<font></font>
OBJECT_ATTRIBUTES ObjectAttributes;<font></font>
IO_STATUS_BLOCK Iosb;<font></font>
LARGE_INTEGER ByteOffset;<font></font>
KEYBOARD_INPUT_DATA kbData;<font></font>
<font></font>
<span class="hljs-comment">// inialize variables</span>
RtlInitUnicodeString(&amp;keyboard, <span class="hljs-string">L"\\Device\\KeyboardClass0"</span>);<font></font>
InitializeObjectAttributes(&amp;ObjectAttributes, &amp;keyboard, OBJ_CASE_INSENSITIVE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
<span class="hljs-comment">// open keyboard device</span><font></font>
NtCreateFile(&amp;hKeyBoard,<font></font>
			SYNCHRONIZE | GENERIC_READ | FILE_READ_ATTRIBUTES,<font></font>
			&amp;ObjectAttributes,<font></font>
			&amp;Iosb,<font></font>
			<span class="hljs-literal">NULL</span>,<font></font>
			FILE_ATTRIBUTE_NORMAL,<font></font>
			<span class="hljs-number">0</span>,<font></font>
			FILE_OPEN,FILE_DIRECTORY_FILE,<font></font>
			<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
<span class="hljs-comment">// create event to wait on</span>
InitializeObjectAttributes(&amp;ObjectAttributes, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<font></font>
NtCreateEvent(&amp;hEvent, EVENT_ALL_ACCESS, &amp;ObjectAttributes, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
<span class="hljs-keyword">while</span> (TRUE)<font></font>
{<font></font>
	NtReadFile(hKeyBoard, hEvent, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;Iosb, &amp;kbData, <span class="hljs-keyword">sizeof</span>(KEYBOARD_INPUT_DATA), &amp;ByteOffset, <span class="hljs-literal">NULL</span>);<font></font>
	NtWaitForSingleObject(hEvent, TRUE, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (kbData.MakeCode == <span class="hljs-number">0x01</span>)    <span class="hljs-comment">// if ESC pressed</span><font></font>
	{<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
	}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なのは</font><font style="vertical-align: inherit;">、開いているデバイスで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtReadFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">、キーボードがクリックを返すまで待ち​​ます。 ESCキーが押された場合は、作業を続けます。デバイスを開くには、NtCreateFile関数を呼び出す必要があります（\ Device \ KeyboardClass0を開く必要があります）。また、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtCreateEvent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">呼び出して</font><font style="vertical-align: inherit;">、待機するオブジェクトを初期化します。キーボードデータを表すKEYBOARD_INPUT_DATA構造を個別に宣言します。これは私たちの仕事を容易にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネイティブアプリケーションは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NtTerminateProcess</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の呼び出しで終了し</font><font style="vertical-align: inherit;">ます。これは、独自のプロセスを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">強制</font></a><font style="vertical-align: inherit;">終了する</font><font style="vertical-align: inherit;">ためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの小さなアプリケーションのすべてのコード：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"ntifs.h"</span> <span class="hljs-comment">// \WinDDK\7600.16385.1\inc\ddk</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"ntdef.h"</span></span><font></font>
<font></font>
<span class="hljs-comment">//------------------------------------</span>
<span class="hljs-comment">// Following function definitions can be found in native development kit</span>
<span class="hljs-comment">// but I am too lazy to include `em so I declare it here</span>
<span class="hljs-comment">//------------------------------------</span><font></font>
<font></font>
<span class="hljs-function">NTSYSAPI
NTSTATUS
NTAPI
<span class="hljs-title">NtTerminateProcess</span><span class="hljs-params">(
  IN HANDLE               ProcessHandle OPTIONAL,
  IN NTSTATUS             ExitStatus
)</span></span>;<font></font>
<font></font>
<span class="hljs-function">NTSYSAPI 
NTSTATUS
NTAPI
<span class="hljs-title">NtDisplayString</span><span class="hljs-params">(
	IN PUNICODE_STRING String
)</span></span>;<font></font>
<font></font>
<span class="hljs-function">NTSTATUS 
<span class="hljs-title">NtWaitForSingleObject</span><span class="hljs-params">(
  IN HANDLE         Handle,
  IN BOOLEAN        Alertable,
  IN PLARGE_INTEGER Timeout
)</span></span>;<font></font>
<font></font>
<span class="hljs-function">NTSYSAPI 
NTSTATUS
NTAPI
<span class="hljs-title">NtCreateEvent</span><span class="hljs-params">(
    OUT PHANDLE             EventHandle,
    IN ACCESS_MASK          DesiredAccess,
    IN POBJECT_ATTRIBUTES   ObjectAttributes OPTIONAL,
    IN EVENT_TYPE           EventType,
    IN BOOLEAN              InitialState
)</span></span>;<font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// https://docs.microsoft.com/en-us/windows/win32/api/ntddkbd/ns-ntddkbd-keyboard_input_data</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">KEYBOARD_INPUT_DATA</span> {</span><font></font>
  USHORT UnitId;<font></font>
  USHORT MakeCode;<font></font>
  USHORT Flags;<font></font>
  USHORT Reserved;<font></font>
  ULONG  ExtraInformation;<font></font>
} KEYBOARD_INPUT_DATA, *PKEYBOARD_INPUT_DATA;<font></font>
<font></font>
<span class="hljs-comment">//----------------------------------------------------------</span>
<span class="hljs-comment">// Our code goes here</span>
<span class="hljs-comment">//----------------------------------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">// usage: WriteLn(L"Hello Native World!\n");</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WriteLn</span><span class="hljs-params">(LPWSTR Message)</span>
</span>{<font></font>
    UNICODE_STRING <span class="hljs-built_in">string</span>;<font></font>
    RtlInitUnicodeString(&amp;<span class="hljs-built_in">string</span>, Message);<font></font>
    NtDisplayString(&amp;<span class="hljs-built_in">string</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">NtProcessStartup</span><span class="hljs-params">(<span class="hljs-keyword">void</span>* StartupArgument)</span>
</span>{
	<span class="hljs-comment">// it is important to declare all variables at the beginning</span><font></font>
	HANDLE hKeyBoard, hEvent;<font></font>
	UNICODE_STRING skull, keyboard;<font></font>
	OBJECT_ATTRIBUTES ObjectAttributes;<font></font>
	IO_STATUS_BLOCK Iosb;<font></font>
	LARGE_INTEGER ByteOffset;<font></font>
	KEYBOARD_INPUT_DATA kbData;<font></font>
	<font></font>
	PVOID memory = <span class="hljs-literal">NULL</span>;<font></font>
	PVOID buffer = <span class="hljs-literal">NULL</span>;<font></font>
	ULONG bufferSize = <span class="hljs-number">42</span>;<font></font>
<font></font>
	<span class="hljs-comment">//use it if debugger connected to break</span>
	<span class="hljs-comment">//DbgBreakPoint();</span><font></font>
<font></font>
	WriteLn(<span class="hljs-string">L"Hello Native World!\n"</span>);<font></font>
<font></font>
	<span class="hljs-comment">// inialize variables</span>
	RtlInitUnicodeString(&amp;keyboard, <span class="hljs-string">L"\\Device\\KeyboardClass0"</span>);<font></font>
	InitializeObjectAttributes(&amp;ObjectAttributes, &amp;keyboard, OBJ_CASE_INSENSITIVE, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
	<span class="hljs-comment">// open keyboard device</span><font></font>
	NtCreateFile(&amp;hKeyBoard,<font></font>
				SYNCHRONIZE | GENERIC_READ | FILE_READ_ATTRIBUTES,<font></font>
				&amp;ObjectAttributes,<font></font>
				&amp;Iosb,<font></font>
				<span class="hljs-literal">NULL</span>,<font></font>
				FILE_ATTRIBUTE_NORMAL,<font></font>
				<span class="hljs-number">0</span>,<font></font>
				FILE_OPEN,FILE_DIRECTORY_FILE,<font></font>
				<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	<span class="hljs-comment">// create event to wait on</span>
	InitializeObjectAttributes(&amp;ObjectAttributes, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<font></font>
	NtCreateEvent(&amp;hEvent, EVENT_ALL_ACCESS, &amp;ObjectAttributes, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<font></font>
	<font></font>
	WriteLn(<span class="hljs-string">L"Keyboard ready\n"</span>);<font></font>
	<font></font>
	<span class="hljs-comment">// create heap in order to allocate memory later</span><font></font>
	memory = RtlCreateHeap(<font></font>
	  HEAP_GROWABLE, <font></font>
	  <span class="hljs-literal">NULL</span>, 
	  <span class="hljs-number">1000</span>, 
	  <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span><font></font>
	);<font></font>
	<font></font>
	WriteLn(<span class="hljs-string">L"Heap ready\n"</span>);<font></font>
<font></font>
	<span class="hljs-comment">// allocate buffer of size bufferSize</span><font></font>
	buffer = RtlAllocateHeap(<font></font>
	  memory, <font></font>
	  HEAP_ZERO_MEMORY, <font></font>
	  bufferSize<font></font>
	);<font></font>
	<font></font>
	WriteLn(<span class="hljs-string">L"Buffer allocated\n"</span>);<font></font>
<font></font>
	<span class="hljs-comment">// free buffer (actually not needed because we destroy heap in next step)</span>
	RtlFreeHeap(memory, <span class="hljs-number">0</span>, buffer);<font></font>
<font></font>
	RtlDestroyHeap(memory);<font></font>
	<font></font>
	WriteLn(<span class="hljs-string">L"Heap destroyed\n"</span>);<font></font>
	<font></font>
	WriteLn(<span class="hljs-string">L"Press ESC to continue...\n"</span>);<font></font>
<font></font>
	<span class="hljs-keyword">while</span> (TRUE)<font></font>
	{<font></font>
		NtReadFile(hKeyBoard, hEvent, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;Iosb, &amp;kbData, <span class="hljs-keyword">sizeof</span>(KEYBOARD_INPUT_DATA), &amp;ByteOffset, <span class="hljs-literal">NULL</span>);<font></font>
		NtWaitForSingleObject(hEvent, TRUE, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (kbData.MakeCode == <span class="hljs-number">0x01</span>)    <span class="hljs-comment">// if ESC pressed</span><font></font>
		{<font></font>
				<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
	}<font></font>
<font></font>
	NtTerminateProcess(NtCurrentProcess(), <span class="hljs-number">0</span>);<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバッガーで停止するコードでDbgBreakPoint（）関数を簡単に使用できます。</font><font style="vertical-align: inherit;">確かに、カーネルデバッグのためにWinDbgを仮想マシンに接続する必要があります。</font><font style="vertical-align: inherit;">これを行う方法の説明は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにある</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">か、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualKDを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用する</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">だけ</font></a><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイルとアセンブリ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネイティブアプリケーションを構築する最も簡単な方法は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ドライバー開発キット）</font><font style="vertical-align: inherit;">を使用すること</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">後のバージョンではアプローチが少し異なり、Visual Studioと緊密に連携するため、まさに古代の7番目のバージョンが必要です。</font><font style="vertical-align: inherit;">DDKを使用する場合、プロジェクトに必要なのはMakefileとソースのみです。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makefile</font></font></i><br>
<pre><code class="bash hljs">!INCLUDE $(NTMAKEENV)\makefile.def</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース：</font></font></i><br>
<pre><code class="bash hljs">TARGETNAME			= MyNative<font></font>
TARGETTYPE			= PROGRAM<font></font>
UMTYPE				= nt<font></font>
BUFFER_OVERFLOW_CHECKS 		= 0<font></font>
MINWIN_SDK_LIB_PATH		= $(SDK_LIB_PATH)<font></font>
SOURCES 			= source.c<font></font>
<font></font>
INCLUDES 			= $(DDK_INC_PATH); \<font></font>
				  C:\WinDDK\7600.16385.1\ndk;<font></font>
<font></font>
TARGETLIBS 			= $(DDK_LIB_PATH)\ntdll.lib	\<font></font>
				  $(DDK_LIB_PATH)\nt.lib<font></font>
<font></font>
USE_NTDLL			= 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Makefileはまったく同じですが、ソースについて詳しく見ていきましょう。</font><font style="vertical-align: inherit;">このファイルには、プログラムのソース（.cファイル）、ビルドオプション、およびその他のパラメーターが含まれています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TARGETNAME-結果となる実行可能ファイルの名前。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TARGETTYPE-実行可能ファイルのタイプ。ドライバー（.sys）にすることができます。フィールド値はDRIVERにする必要があります。ライブラリ（.lib）の場合、値はLIBRARYです。</font><font style="vertical-align: inherit;">この場合、実行可能ファイル（.exe）が必要なので、値をPROGRAMに設定します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UMTYPE-このフィールドの可能な値：コンソールアプリケーションのコンソール、ウィンドウモードで動作するウィンドウ。</font><font style="vertical-align: inherit;">ただし、ネイティブアプリケーションを取得するには、ntを指定する必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BUFFER_OVERFLOW_CHECKS-スタックのバッファオーバーフローをチェックします。残念ながら私たちのケースではありません。オフにしてください。</font></font></li>
<li>MINWIN_SDK_LIB_PATH –      SDK_LIB_PATH,           ,      checked build  DDK,          .</li>
<li>SOURCES –    .</li>
<li>INCLUDES –  ,    .      ,      DDK,       .</li>
<li>TARGETLIBS –  ,   .</li>
<li>USE_NTDLL –  ,      1.    .</li>
<li>USER_C_FLAGS –  ,           .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビルドするには、x86（またはx64）チェックビルドを実行し、作業ディレクトリをプロジェクトフォルダに変更して、ビルドコマンドを実行する必要があります。</font><font style="vertical-align: inherit;">スクリーンショットの結果は、1つの実行可能ファイルを収集したことを示しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9a/aj/hp/9aajhpa858ohtthlkjnenl1nnic.jpeg" alt="ビルド"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このファイルはそれほど単純に実行することはできません。システムは誓約し、次のエラーでその動作について考えるように送信します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zw/ev/zu/zwevzuxrc6zc8fvgye_msqa0k6y.jpeg" alt="エラー"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネイティブアプリケーションを実行する方法</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
autochkの開始時に、プログラムの起動シーケンスはレジストリキーの値によって決定されます。 </font></font><br>
<br>
<pre><code class="bash hljs">HKLM\System\CurrentControlSet\Control\Session Manager\BootExecute</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セッションマネージャは、このリストからプログラムを1つずつ実行します。</font><font style="vertical-align: inherit;">セッションマネージャ自体は、system32ディレクトリで実行可能ファイルを探します。</font><font style="vertical-align: inherit;">レジストリキー値の形式は次のとおりです。</font></font><br>
<br>
<pre><code class="bash hljs">autocheck autochk *MyNative</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
値は16進数形式である必要があり、通常のASCIIではないため、上記のキーは次の形式になります。</font></font><br>
<br>
<pre><code class="bash hljs">61,75,74,6f,63,68,65,63,6b,20,61,75,74,6f,63,68,6b,20,2a,00,4d,79,4e,61,74,69,76,65,00,00</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前を変換するには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ようなオンラインサービスを使用できます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ii/ky/sn/iikysns0tim-qpz91mbazv4uepa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネイティブアプリケーションを実行するには、次のものが必要です。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行可能ファイルをsystem32フォルダーにコピーする</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジストリにキーを追加する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マシンを再起動</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
便宜上、ネイティブアプリケーションをインストールするための既成のスクリプトを以下に示します</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。install.bat</font></font></i><br>
<br>
<pre><code class="bash hljs">@<span class="hljs-built_in">echo</span> off<font></font>
copy MyNative.exe %systemroot%\system32\.<font></font>
regedit /s add.reg<font></font>
<span class="hljs-built_in">echo</span> Native Example Installed<font></font>
pause</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add.reg</font></font></i><br>
<br>
<pre><code class="bash hljs">REGEDIT4<font></font>
<font></font>
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager]<font></font>
<span class="hljs-string">"BootExecute"</span>=hex(7):61,75,74,6f,63,68,65,63,6b,20,61,75,74,6f,63,68,6b,20,2a,00,4d,79,4e,61,74,69,76,65,00,00</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インストールと再起動後、ユーザー選択画面が表示される前でも、次の画像が表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yi/5p/7_/yi5p7_4vygq1wttxg_edlw-keqi.jpeg" alt="結果"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合計</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような小さなアプリケーションの例を使用して、アプリケーションをWindowsネイティブレベルで実行することは非常に可能であると確信しました。</font><font style="vertical-align: inherit;">さらに、イノポリス大学のスタッフは、以前のバージョンのプロジェクトよりもはるかに早く、ドライバーとの対話プロセスを開始するサービスを引き続き構築します。</font><font style="vertical-align: inherit;">そして、win32シェルの登場により、既に開発された本格的なサービスに制御を移すことが論理的になるでしょう（これについてはこちらを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の記事では、Active Restoreサービスの別のコンポーネント、つまりUEFIドライバーに触れます。</font><font style="vertical-align: inherit;">次の投稿を見逃さないように私たちのブログを購読してください。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja481370/index.html">グレタ・トゥンベリは正しいですか？航空機VSトレイン</a></li>
<li><a href="../ja481372/index.html">インデックス可能なバイナリツリー</a></li>
<li><a href="../ja481374/index.html">Habr Weekly＃32 /ランブラーが恩返し、職場での操作、ペットプロジェクトを保護する方法、ガジェットが自撮り写真を静かに撮る</a></li>
<li><a href="../ja481376/index.html">NGINXでの状況によってコミュニティに教えられたレッスンの分析</a></li>
<li><a href="../ja481378/index.html">アプリケーション開発を最適化する方法</a></li>
<li><a href="../ja481386/index.html">ディザリング：それを改善するためのノイズの多い信号</a></li>
<li><a href="../ja481388/index.html">Cryptocurrency ExchangeがDeFiに対抗するブロックチェーンを構築する方法</a></li>
<li><a href="../ja481390/index.html">OpenStreetMap No. 490の世界からのお知らせ（12/03/2019-09/12/2019）</a></li>
<li><a href="../ja481392/index.html">PHPで集中暗号通貨を書いたとき。（パート1-基本的な概要+クイックスタート）</a></li>
<li><a href="../ja481394/index.html">私たちが昔から好きだったものを新しいゲームで再現</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>