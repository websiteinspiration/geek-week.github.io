<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∏ üêî ‚úçüèæ Como √© organizado o sistema de conte√∫do das p√°ginas Turbo: esquemas, fatos e um pouco de hist√≥ria üçú ü§µüèæ üë©üèΩ‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Segundo o TelecomDaily , quase 30% dos usu√°rios de Internet m√≥vel na R√∫ssia diariamente t√™m problemas para baixar sites. No entanto, o motivo pode est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como √© organizado o sistema de conte√∫do das p√°ginas Turbo: esquemas, fatos e um pouco de hist√≥ria</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/494824/"><img src="https://habrastorage.org/webt/hq/a5/mv/hqa5mvtylx0m3ns_yixifxt1qw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segundo o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TelecomDaily</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , quase 30% dos usu√°rios de Internet m√≥vel na R√∫ssia diariamente t√™m problemas para baixar sites. No entanto, o motivo pode estar n√£o apenas na cobertura desigual, mas tamb√©m no excesso de "peso" da p√°gina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o podemos influenciar a qualidade da conex√£o, mas para ajudar os webmasters a simplificar o conte√∫do do site, facilite - por que n√£o? Assim, a tecnologia das p√°ginas Turbo apareceu no Yandex: tudo o que √© necess√°rio para a coloca√ß√£o √© transferido para o nosso sistema de conte√∫do e converte esses dados em materiais f√°ceis e r√°pidos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como essa m√°gica funciona? Qual √© o caminho dos dados antes de se tornar uma p√°gina Turbo completa? Meu nome √© Stas Makeev, lidero o desenvolvimento de p√°ginas de tecnologia Turbo. Agora vou tentar explicar tudo.</font></font><br>
 <a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, primeiro, √© um resumo para que voc√™ n√£o se perca quando eu come√ßar a me aprofundar nos detalhes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma vantagem importante do sistema de p√°ginas Turbo √© a r√°pida convers√£o de dados da forma original para a final: os materiais dos sites de not√≠cias s√£o mais procurados nos primeiros minutos ap√≥s a publica√ß√£o, e os cart√µes de mercadorias das lojas online devem ser atualizados rapidamente e sempre corresponder ao status atual de disponibilidade. O segundo par√¢metro importante √© a confiabilidade: o sistema de conte√∫do deve ser o mais est√°vel poss√≠vel, capaz de sobreviver √† quebra de servidores individuais ou mesmo de datacenters inteiros. E, √© claro, era importante evitar carga excessiva nos hosts de nossos parceiros conectados √†s p√°ginas do Turbo. Ou seja, ao projetar o servi√ßo, era necess√°rio encontrar um equil√≠brio entre a velocidade do processamento de dados e o aumento no n√∫mero de solicita√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os propriet√°rios do site t√™m v√°rias maneiras de se conectar ao sistema:</font></font><br>
<br>
<ul>
<li>  . : YML ‚Äî  -, RSS ‚Äì   ;</li>
<li>   API:          (    );</li>
<li> : -       .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sistema de conte√∫do armazena os resultados de seu trabalho em um armazenamento especial do tipo "valor-chave" (armazenamento de valor-chave ou armazenamento KV), em que a chave √© a URL do site original e o valor armazena o conte√∫do da p√°gina Turbo. </font><font style="vertical-align: inherit;">Assim que os dados entram nesse armazenamento KV, a pr√≥xima p√°gina Turbo fica imediatamente dispon√≠vel para procurar usu√°rios, e nos servi√ßos Yandex o documento correspondente tem um √≠cone especial com um foguete. </font><font style="vertical-align: inherit;">Al√©m disso, para acelerar o trabalho, armazenamos em cache fotos e v√≠deos em nossas CDNs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um esquema geral de trabalho muito simplificado se parece com isso:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/mq/u5/aomqu5polx3u8fse71spyit1eam.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como tudo come√ßou</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira vers√£o do sistema de conte√∫do foi organizada de maneira simples: a cada poucos minutos, de acordo com o cronograma, o mesmo programa era lan√ßado no servidor em nuvem interno do Yandex. </font><font style="vertical-align: inherit;">Consistia em v√°rias etapas, cada execu√ß√£o seguinte ap√≥s os dados anteriores estarem prontos para todos os feeds que conhecemos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A lista de feeds RSS foi baixada, o analisador de documentos foi lan√ßado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uma lista de imagens foi extra√≠da dos resultados do analisador;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ainda n√£o foram carregadas imagens em cache na CDN;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentos processados ‚Äã‚Äãforam despejados no reposit√≥rio KV.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse esquema funcionou perfeitamente quando o sistema lidou com milhares de feeds RSS bastante leves de ag√™ncias de not√≠cias (no total - informa√ß√µes sobre pouco menos de 100.000 documentos). Por√©m, com o aumento do n√∫mero de feeds, um problema foi rapidamente descoberto: cada etapa demorava cada vez mais, havia um atraso entre a apar√™ncia de um novo documento na fonte original e a exibi√ß√£o no modo Turbo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conseguimos manter a situa√ß√£o sob controle com a ajuda de v√°rios truques: a primeira coisa que fizemos foi selecionar o primeiro passo (baixar feeds RSS + um analisador de documentos) em um processo separado. Ou seja, enquanto um processava imagens para a itera√ß√£o anterior, o outro processo j√° estava baixando feeds para a pr√≥xima. Depois de algum tempo, ficou claro: dessa forma, o sistema √© muito dif√≠cil de escalar. Precisamos de algo fundamentalmente novo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processando RSS, API e YML no novo sistema de conte√∫do</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O principal problema do antigo sistema de conte√∫do era que todos os dados foram processados ‚Äã‚Äãem uma √∫nica pe√ßa: n√£o houve transi√ß√£o para a pr√≥xima etapa at√© que cada documento passasse pela anterior. </font><font style="vertical-align: inherit;">Para se livrar disso, foi decidido construir um determinado pipeline: permita que os feeds e documentos individuais sejam processados ‚Äã‚Äãda maneira mais independente poss√≠vel. </font><font style="vertical-align: inherit;">Todas as etapas foram separadas em cubos de servi√ßo separados - no n√≠vel superior, o esquema ficou assim:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g6/lp/xd/g6lpxdauqtwxm9alh-mrgyf_wro.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o primeiro cubo baixa feeds RSS e passa adiante;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o segundo - pega feeds um por um, analisa o conte√∫do. </font><font style="vertical-align: inherit;">Na sa√≠da - documentos separados;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o terceiro - pega documentos um de cada vez, processa fotos e v√≠deos, grava tudo no armazenamento KV.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os mesmos feeds podem ser registrados n√£o apenas no Turbo, mas tamb√©m em nossos outros servi√ßos - no News ou no Market, por exemplo. Se cada um deles baixar dados por conta pr√≥pria, a carga no servidor de webmasters ser√° v√°rias vezes maior que a permitida. Qu√£o certo? Fa√ßa o download do feed uma vez e depois distribua o conte√∫do a todos os servi√ßos ao consumidor - o Yandex.Robot faz isso. Utilizamos seus servi√ßos para baixar conte√∫do: pegamos no Yandex.Webmaster uma lista de feeds RSS e YML registrados no Turbo, transferimos para o Robot e assinamos os resultados do download.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos dados recebidos, inicie o analisador. S√≥ para lembrar, um feed RSS √© apenas um arquivo no formato ".XML", acess√≠vel por um URL est√°tico no host do parceiro. Este arquivo cont√©m informa√ß√µes sobre todas as atualiza√ß√µes no site - quais documentos s√£o novos, quais s√£o alterados. Somente as informa√ß√µes mais atualizadas nas √∫ltimas horas estariam nos feeds ideais: n√£o mais que 100 documentos por centenas de kilobytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mordidas da realidade: √†s vezes os arquivos ficam dentro do feed por um per√≠odo muito longo e nunca mudam. Como evitar o reprocessamento nesses casos? Calculamos o hash de cada documento, armazenamos no banco de dados e n√£o fazemos nada at√© que o hash seja alterado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O processamento de feeds e APIs YML do ponto de vista do sistema de conte√∫do √© praticamente diferente de interagir com o RSS: para YML, iniciamos outro analisador, e os dados transmitidos pela API s√£o obtidos diretamente no Yandex.Webmaster.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/hh/gz/rehhgz4wtfo8nqylaexh74z5dga.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processamento de imagem e v√≠deo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O documento recebido na sa√≠da do analisador est√° quase pronto para grava√ß√£o no armazenamento KV. </font><font style="vertical-align: inherit;">A √∫nica coisa que resta a fazer antes do envio √© processar as imagens e v√≠deos: armazenar em cache na CDN e substituir os links no documento. </font><font style="vertical-align: inherit;">Aqui, novamente, procuramos o rob√¥ para obter ajuda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de tudo, verificamos cada foto e v√≠deo: eles est√£o na CDN? </font><font style="vertical-align: inherit;">Se tudo j√° estiver em cache, substitua os links e envie o documento atualizado para o reposit√≥rio KV. </font><font style="vertical-align: inherit;">De outra forma:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enviamos a lista de URLs ausentes ao rob√¥ para planejamento e download;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o documento em si est√° em armazenamento tempor√°rio; portanto, depois de um tempo, tente verificar novamente.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro cubo no momento recebe os resultados do download, carrega os dados na CDN e atualiza o banco de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse esquema, outro problema importante relacionado ao planejamento pode ser resolvido: o rob√¥ entende a rapidez com que √© poss√≠vel baixar dados de diferentes hosts e n√£o permite sobrecargas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2n/g4/oz/2ng4oz6c5ocn3jjbld4armtcewk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Caminho t√≠pico que um novo documento segue:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O documento aparece no feed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O rob√¥ faz o download do feed;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o analisador descobre um novo documento e o envia mais;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verificamos que as imagens do documento n√£o s√£o mencionadas no banco de dados, solicitamos o download, o documento √© enviado para armazenamento tempor√°rio (Atraso). </font><font style="vertical-align: inherit;">Enquanto o documento estiver l√°, o Robot far√° o download das imagens, elas ser√£o armazenadas em cache na CDN e os links aparecer√£o no banco de dados;</font></font></li>
<li>       ,    CDN,      KV-. </li>
<li> :    ,       Delay.</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° outra maneira de conectar-se √†s p√°ginas Turbo, para as quais o webmaster n√£o precisa fazer nada - o Autoparser. </font><font style="vertical-align: inherit;">Ele cria p√°ginas Turbo com base nos dados de origem do site de conte√∫do. </font><font style="vertical-align: inherit;">Voc√™ pode se conectar, ver exemplos de p√°ginas conclu√≠das, configurar an√∫ncios e an√°lises no Yandex.Webmaster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A principal dificuldade que o AutoParser enfrenta √© reconhecer pela marca√ß√£o HTML quais informa√ß√µes b√°sicas devem ser usadas ao criar uma p√°gina Turbo. </font><font style="vertical-align: inherit;">Para fazer isso, temos v√°rios processos offline que est√£o tentando entender exatamente como analisar um host espec√≠fico. </font><font style="vertical-align: inherit;">Vou me concentrar em dois principais:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O primeiro</font></font></b>     RSS-    HTML-  .  ‚Äî    ,       RSS- (    ),   .   ,    .        CatBoost  ,   ,      .     ,          , , .  ,          .  ,     ,  ,        HTML     . ?  :     .  ‚Äì    ,    .</li>
<li><b></b>   :            ..  ,    ,   ,          ,   ‚Äî  .       ‚Äî   .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, mais um obst√°culo frequente - muitos sites bloqueiam a capacidade de baixar imagens de rob√¥s no robots.txt. Infelizmente, √© imposs√≠vel contornar esse problema, e o Autoparser n√£o est√° dispon√≠vel para essas p√°ginas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, o esquema completo do sistema de conte√∫do fica assim: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ll/jx/-a/lljx-adtt8ykngcnfnutykobxr4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sistema acabou sendo escalon√°vel: agora uma quantidade significativa de recursos √© usada para atender o banco de dados, o autoparser e outros componentes do sistema (apenas o cubo respons√°vel pela an√°lise de RSS, YML e API usa mais de 300 processadores n√∫cleos) e, em caso de aumento de carga, n√£o ser√° muito dif√≠cil conectar capacidades adicionais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obrigado por ler at√© o fim! Espero que, ap√≥s este material, no trabalho das p√°ginas Turbo voc√™ tenha mais l√≥gica e menos magia (a prop√≥sito, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- ainda mais detalhes sobre as p√°ginas Turbo). </font><font style="vertical-align: inherit;">Se algo ainda for incompreens√≠vel, escreva nos coment√°rios - estamos em contato.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt494808/index.html">Analista de produto: o que faz, quanto ganha, quais benef√≠cios os neg√≥cios trazem</a></li>
<li><a href="../pt494810/index.html">Introdu√ß√£o ao 3D: conceitos b√°sicos do Three.js</a></li>
<li><a href="../pt494814/index.html">Slurm √© √∫til?</a></li>
<li><a href="../pt494818/index.html">Como escolher um terminal de negocia√ß√£o para trabalhar na bolsa</a></li>
<li><a href="../pt494820/index.html">Como a especifica√ß√£o da fonte de alimenta√ß√£o ATX12VO da Intel mudar√° o futuro</a></li>
<li><a href="../pt494826/index.html">Ser "novo" ou n√£o ser ...</a></li>
<li><a href="../pt494830/index.html">ViennaNET: um conjunto de bibliotecas para o back-end</a></li>
<li><a href="../pt494838/index.html">Modems GSM / 3G / 4G em sistemas embarcados usando o modem Quectel EC21 LTE e o Yocto Project como exemplo</a></li>
<li><a href="../pt494848/index.html">15 mulheres que deram uma grande contribui√ß√£o √† astronomia</a></li>
<li><a href="../pt494850/index.html">Configure o Microsoft Windows Server 2016/2019 para fornecer servi√ßos DHCP para VXLAN (DFA)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>