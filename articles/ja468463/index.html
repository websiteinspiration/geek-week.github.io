<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§”ğŸ¼ ğŸ‘²ğŸ¾ ğŸ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã«ã‚ˆã‚‹Zabbix + PostgreSQLã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Š â” ğŸ•‰ï¸ âš°ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ç´„1å¹´å‰ã€ç§ã¨åŒåƒšã¯ã€äººæ°—ã®ã‚ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ã‚ã‚‹Zabbixã‚’ä½¿ç”¨ã—ã¦å•é¡Œã‚’è§£æ±ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œè¨ã—ãŸå¾Œã€ã™ãã«è² è·ãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ãŸã€‚ZabbixãŒé¡•è‘—ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ä½ä¸‹ãªã—ã«æ©Ÿèƒ½ã§ãã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®æ•°ã‚’è©•ä¾¡ã—ãŸã‹ã£ãŸã®ã§ã™ã€‚ Postg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã«ã‚ˆã‚‹Zabbix + PostgreSQLã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Š</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468463/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç´„1å¹´å‰ã€ç§ã¨åŒåƒšã¯ã€äººæ°—ã®ã‚ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ã‚ã‚‹Zabbixã‚’ä½¿ç”¨ã—ã¦å•é¡Œã‚’è§£æ±ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œè¨ã—ãŸå¾Œã€ã™ãã«è² è·ãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ãŸã€‚ZabbixãŒé¡•è‘—ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ä½ä¸‹ãªã—ã«æ©Ÿèƒ½ã§ãã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®æ•°ã‚’è©•ä¾¡ã—ãŸã‹ã£ãŸã®ã§ã™ã€‚ PostgreSQLã®ã¿ãŒDBMSã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ†ã‚¹ãƒˆä¸­ã«ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¸€éƒ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ©Ÿèƒ½ã¨ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ã®å‹•ä½œãŒç‰¹å®šã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ãŒæœ€å¤§é›»åŠ›ã«åˆ°é”ã§ãã¾ã›ã‚“ã€‚ãã®çµæœã€ä¸»ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã«é–¢ã—ã¦ã€ã„ãã¤ã‹ã®æœ€é©åŒ–å¯¾ç­–ãŒé–‹ç™ºã€å®Ÿæ–½ã€ãŠã‚ˆã³ãƒ†ã‚¹ãƒˆã•ã‚Œã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®è¨˜äº‹ã§è¡Œã£ãŸä½œæ¥­ã®çµæœã‚’å…±æœ‰ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®è¨˜äº‹ã¯ã€Zabbixã¨PostgreSQLã®ä¸¡æ–¹ã®DBAç®¡ç†è€…ã€ãŠã‚ˆã³ä¸€èˆ¬çš„ãªPosgreSQL DBMSã‚’ã‚ˆã‚Šã‚ˆãç†è§£ã—ã¦ç†è§£ã—ãŸã„ã™ã¹ã¦ã®äººã«å½¹ç«‹ã¡ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°ã•ãªã‚¹ãƒã‚¤ãƒ©ãƒ¼ï¼šæ¯åˆ†20ä¸‡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®è² è·ãŒã‹ã‹ã‚‹å¼±ã„ãƒã‚·ãƒ³ã§ã€CPU iowaitã‚’20ï¼…ã‹ã‚‰2ï¼…ã«å‰Šæ¸›ã—ã€ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®éƒ¨åˆ†çš„ãªè¨˜éŒ²æ™‚é–“ã‚’250å€ã«ã€é›†ç´„ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’32å€ã«å‰Šæ¸›ã—ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã—ã¾ã—ãŸã€‚ 5ã€œ10å€ã€å ´åˆã«ã‚ˆã£ã¦ã¯18å€ã¾ã§ã®å±¥æ­´ã‚µãƒ³ãƒ—ãƒ«ã®å–å¾—ã‚’é«˜é€ŸåŒ–ã—ã¾ã™ã€‚</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è² è·ãƒ†ã‚¹ãƒˆã¯ã€1ã¤ã®Zabbixã‚µãƒ¼ãƒãƒ¼ã€1ã¤ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªZabbixãƒ—ãƒ­ã‚­ã‚·ã€2ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã„ã†ã‚¹ã‚­ãƒ¼ãƒ ã«å¾“ã£ã¦å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€æ¯åˆ†50ãƒˆãƒ³ã®æ•´æ•°ã¨50ãƒˆãƒ³ã®æ–‡å­—åˆ—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æä¾›ã™ã‚‹ã‚ˆã†ã«æ§‹æˆã•ã‚Œã¾ã—ãŸï¼ˆåˆè¨ˆ200ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€æ¯åˆ†200ãƒˆãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã€ã¾ãŸã¯æ¯ç§’3333ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰ã€‚</font><font style="vertical-align: inherit;">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ã«</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ã€Zabbixã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã—ã¾ã—ãŸ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ã€‚</font></a><font style="vertical-align: inherit;">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç”Ÿæˆã§ãã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ•°ã‚’ç¢ºèªã™ã‚‹ã«</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ã€åŒã˜ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä½œæˆè€…zabbix_module_stressã®ç‰¹åˆ¥ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">Zabbix web-adminã¯å¤§ããªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç™»éŒ²ã«å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’5ãƒˆãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆ2500ã®æ•°å€¤ã¨2500ã®æ–‡å­—åˆ—ï¼‰ã‚’å«ã‚€20ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åˆ†å‰²ã—ã¾ã—ãŸã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pythonã§ã®è² è·ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> argparse<font></font>
<font></font>
<span class="hljs-string">"""
    .
  20   5000    
( 2500  :  echo,  ;  ping,  )
"""</span><font></font>
<font></font>
TEMP_HEAD = <span class="hljs-string">"""
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;zabbix_export&gt;
    &lt;version&gt;2.0&lt;/version&gt;
    &lt;date&gt;2015-08-17T23:15:01Z&lt;/date&gt;
    &lt;groups&gt;
        &lt;group&gt;
            &lt;name&gt;Templates&lt;/name&gt;
        &lt;/group&gt;
    &lt;/groups&gt;
    &lt;templates&gt;
        &lt;template&gt;
            &lt;template&gt;Template Zabbix Srv Stress {count} passive {char}&lt;/template&gt;
            &lt;name&gt;Template Zabbix Srv Stress {count} passive {char}&lt;/name&gt;
            &lt;description/&gt;
            &lt;groups&gt;
                &lt;group&gt;
                    &lt;name&gt;Templates&lt;/name&gt;
                &lt;/group&gt;
            &lt;/groups&gt;
            &lt;applications/&gt;
            &lt;items&gt;
"""</span><font></font>
<font></font>
TEMP_END = <span class="hljs-string">"""&lt;/items&gt;
            &lt;discovery_rules/&gt;
            &lt;macros/&gt;
            &lt;templates/&gt;
            &lt;screens/&gt;
        &lt;/template&gt;
    &lt;/templates&gt;
&lt;/zabbix_export&gt;
"""</span><font></font>
<font></font>
TEMP_ITEM = <span class="hljs-string">"""&lt;item&gt;
                    &lt;name&gt;{k}&lt;/name&gt;
                    &lt;type&gt;0&lt;/type&gt;
                    &lt;snmp_community/&gt;
                    &lt;multiplier&gt;0&lt;/multiplier&gt;
                    &lt;snmp_oid/&gt;
                    &lt;key&gt;{k}&lt;/key&gt;
                    &lt;delay&gt;1m&lt;/delay&gt;
                    &lt;history&gt;3&lt;/history&gt;
                    &lt;trends&gt;365&lt;/trends&gt;
                    &lt;status&gt;0&lt;/status&gt;
                    &lt;value_type&gt;{t}&lt;/value_type&gt;
                    &lt;allowed_hosts/&gt;
                    &lt;units/&gt;
                    &lt;delta&gt;0&lt;/delta&gt;
                    &lt;snmpv3_contextname/&gt;
                    &lt;snmpv3_securityname/&gt;
                    &lt;snmpv3_securitylevel&gt;0&lt;/snmpv3_securitylevel&gt;
                    &lt;snmpv3_authprotocol&gt;0&lt;/snmpv3_authprotocol&gt;
                    &lt;snmpv3_authpassphrase/&gt;
                    &lt;snmpv3_privprotocol&gt;0&lt;/snmpv3_privprotocol&gt;
                    &lt;snmpv3_privpassphrase/&gt;
                    &lt;formula&gt;1&lt;/formula&gt;
                    &lt;delay_flex/&gt;
                    &lt;params/&gt;
                    &lt;ipmi_sensor/&gt;
                    &lt;data_type&gt;0&lt;/data_type&gt;
                    &lt;authtype&gt;0&lt;/authtype&gt;
                    &lt;username/&gt;
                    &lt;password/&gt;
                    &lt;publickey/&gt;
                    &lt;privatekey/&gt;
                    &lt;port/&gt;
                    &lt;description/&gt;
                    &lt;inventory_link&gt;0&lt;/inventory_link&gt;
                    &lt;applications/&gt;
                    &lt;valuemap/&gt;
                    &lt;logtimefmt/&gt;
                &lt;/item&gt;
"""</span><font></font>
<font></font>
TMP_FNAME_DEFAULT = <span class="hljs-string">"Template_App_Zabbix_Server_Stress_{count}_passive_{char}.xml"</span><font></font>
<font></font>
chars = <span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:<font></font>
    parser = argparse.ArgumentParser(<font></font>
        description=<span class="hljs-string">'     zabbix'</span>)<font></font>
    parser.add_argument(<span class="hljs-string">'--items'</span>, dest=<span class="hljs-string">'items'</span>, type=int, default=<span class="hljs-number">1000</span>,<font></font>
                        help=<span class="hljs-string">'-   (default: 1000)'</span>)<font></font>
    parser.add_argument(<span class="hljs-string">'--templates'</span>, dest=<span class="hljs-string">'templates'</span>, type=int, default=<span class="hljs-number">1</span>,<font></font>
                        help=<span class="hljs-string">f'-  [1-<span class="hljs-subst">{len(chars)}</span>] (default: 1)'</span>)<font></font>
    args = parser.parse_args()<font></font>
    items_count = args.items<font></font>
    tmps_count = args.templates<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (tmps_count &gt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> tmps_count &lt;= len(chars)):<font></font>
        sys.exit(<span class="hljs-string">f"Templates must be in range 1 - <span class="hljs-subst">{len(chars)}</span>"</span>)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(tmps_count):<font></font>
        fname = TMP_FNAME_DEFAULT.format(count=items_count, char=chars[i])<font></font>
        <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> output:<font></font>
            output.write(TEMP_HEAD.format(count=items_count, char=chars[i]))<font></font>
            <span class="hljs-keyword">for</span> k,t <span class="hljs-keyword">in</span> [(<span class="hljs-string">'stress.ping[{}-I-{:06d}]'</span>,<span class="hljs-number">3</span>),<font></font>
                        (<span class="hljs-string">'stress.echo[{}-S-{:06d}]'</span>,<span class="hljs-number">4</span>)]:
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(int(items_count/<span class="hljs-number">2</span>)):<font></font>
                    output.write(TEMP_ITEM.format(k=k.format(chars[i],j),t=t))<font></font>
            output.write(TEMP_END)<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cpu iostatãƒ¡ãƒˆãƒªãƒƒã‚¯ã¯ã€Zabbixãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è‰¯ã„æŒ‡æ¨™ã§ã™ã€‚ã“ã‚Œã¯ã€ãƒ—ãƒ­ã‚»ãƒƒã‚µãŒãƒ‡ã‚£ã‚¹ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’äºˆæœŸã—ã¦ã„ã‚‹æ™‚é–“å˜ä½ã®å‰²åˆã‚’åæ˜ ã—ã¦ã„ã¾ã™ã€‚å€¤ãŒé«˜ã„ã»ã©ã€èª­ã¿å–ã‚ŠãŠã‚ˆã³æ›¸ãè¾¼ã¿æ“ä½œã§ãƒ‡ã‚£ã‚¹ã‚¯ãŒå æœ‰ã•ã‚Œã€ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã«é–“æ¥çš„ã«å½±éŸ¿ã—ã¾ã™ã€‚ãã‚Œã‚‰ã€‚ã“ã‚Œã¯ã€ç›£è¦–ã«å•é¡ŒãŒã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ç¢ºã‹ãªå…†å€™ã§ã™ã€‚ã¡ãªã¿ã«ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚¹ãƒšãƒ¼ã‚¹ã§ã¯ã€ã€ŒZabbixã§iostatãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹æ–¹æ³•ã€ã¨ã„ã†è³ªå•ãŒã‚ˆãå¯„ã›ã‚‰ã‚Œã‚‹ãŸã‚ã€iowaitãƒ¡ãƒˆãƒªãƒƒã‚¯ã®å€¤ã‚’å¢—ã‚„ã™ç†ç”±ã¯ãŸãã•ã‚“ã‚ã‚‹ãŸã‚ã€ã“ã‚Œã¯ç—›ã„ç‚¹ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹ã¯ã€æœ€åˆã«3æ—¥å¾Œã«å–å¾—ã—ãŸcpu iowaitãƒ¡ãƒˆãƒªãƒƒã‚¯ã®å›³ã§ã™ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dc/md/yo/dcmdyote_ghzxca-o9sft88ptxq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ã‹ã—ã€ä»¥ä¸‹ã§èª¬æ˜ã™ã‚‹ã™ã¹ã¦ã®æœ€é©åŒ–å¯¾ç­–ãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã€æœ€çµ‚çš„ã«3æ—¥ä»¥å†…ã«åŒã˜ãƒ¡ãƒˆãƒªãƒƒã‚¯ã«ã¤ã„ã¦ã©ã®ã‚ˆã†ãª</font></font><br>
<br>
<img src="https://habrastorage.org/webt/do/cs/fc/docsfcjjczkhgxoubjayslrohuw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çŠ¶æ³ãŒå¾—ã‚‰ã‚ŒãŸã®ã‹ã‚’ç¤ºã—ã¾ã™ã€‚ã‚°ãƒ©ãƒ•ã‹ã‚‰ã‚ã‹ã‚‹ã‚ˆã†ã«ã€CPU iowaitã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒã»ã¼20ï¼…ã‹ã‚‰2ï¼…ã«ä½ä¸‹ã—ã€é–“æ¥çš„ã«æ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œã¾ã—ãŸãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ã¨èª­ã¿å–ã‚Šã®ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®Ÿè¡Œã€‚</font><font style="vertical-align: inherit;">æ¬¡ã«ã€æ¨™æº–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šã§ã€ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹ã™ã‚‹ç†ç”±ã¨ãã®ä¿®æ­£æ–¹æ³•ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbixãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ã®ç†ç”±</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ‡ãƒ¼ã‚¿ã®å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«1000ä¸‡ã‚’è¶…ãˆã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å€¤ãŒè“„ç©ã•ã‚Œã‚‹ã¨ã€æ¬¡ã®ç†ç”±ã«ã‚ˆã‚Šã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ€¥æ¿€ã«ä½ä¸‹ã™ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚</font></font><br>
<br>
<ul>
<li>  iowait     20%,     ,            </li>
<li>   ,     </li>
<li>    (utilization)  100%     ,          </li>
<li>            housekeeper</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚Œã«åŠ ãˆã¦ã€1æ™‚é–“ã”ã¨ã®çµ±è¨ˆãŒè¨ˆç®—ã•ã‚Œã‚‹ã¨åŒæ™‚ã«ã€çŠ¶æ³ãŒæ‚ªåŒ–ã—ã¾ã™-åŒæ™‚ã«ã€ãƒ‡ã‚£ã‚¹ã‚¯ã‹ã‚‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¸ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªèª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã€å±¥æ­´ã‹ã‚‰ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãŒå®Ÿè¡Œã•ã‚Œã€åŒã˜çµæœã«ã¤ãªãŒã‚Šã¾ã™-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ä½ä¸‹ã¨å®Ÿè¡Œæ™‚é–“ã®å¢—åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆåˆ¶é™ã§ã¯ã€æœ€å¤§5åˆ†é–“ç¶šããƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸï¼ï¼‰</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbixã§ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ã‚’æ•´ç†ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦å°‘ã—èª¬æ˜ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã•ã‚‰ã«ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚¿ã‚¤ãƒ—ã‚’åˆ†é›¢ã—ã¦ã€ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ‡ãƒ¼ã‚¿ã¨é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ç•°ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ã€itemidãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¤ãƒ†ãƒ ã¸ã®æš—é»™çš„ãªå‚ç…§ï¼‰ã€unixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å½¢å¼ã§ã‚¯ãƒ­ãƒƒã‚¯å€¤ã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆåˆ¥ã®åˆ—ã«ãƒŸãƒªç§’ï¼‰ã€ãŠã‚ˆã³åˆ¥ã®åˆ—ã«å€¤ãŒæ ¼ç´ã•ã‚Œã¾ã™ï¼ˆä¾‹å¤–ã¯ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã•ã‚‰ã«å¤šãã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ï¼‰ ï¼‰ï¼š</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ†ãƒ¼ãƒ–ãƒ«å</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»»å‘½</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ãƒ»ã‚¿ã‚¤ãƒ—</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­´å²</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€æ¬¡ç›£è¦–ãƒ‡ãƒ¼ã‚¿</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°å€¤ï¼ˆ16.4ï¼‰</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history_uint</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€æ¬¡ç›£è¦–ãƒ‡ãƒ¼ã‚¿</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°å€¤ï¼ˆ20.0ï¼‰</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history_str</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€æ¬¡ç›£è¦–ãƒ‡ãƒ¼ã‚¿</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">varcharï¼ˆ255ï¼‰</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history_text</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€æ¬¡ç›£è¦–ãƒ‡ãƒ¼ã‚¿</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ†ã‚­ã‚¹ãƒˆ</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history_logs</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€æ¬¡ç›£è¦–ãƒ‡ãƒ¼ã‚¿</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">textãŠã‚ˆã³intãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒˆãƒ¬ãƒ³ãƒ‰</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é›†ç´„ã•ã‚ŒãŸç›£è¦–ãƒ‡ãƒ¼ã‚¿</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°å€¤ï¼ˆ16.4ï¼‰</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trends_uint</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é›†ç´„ã•ã‚ŒãŸç›£è¦–ãƒ‡ãƒ¼ã‚¿</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•°å€¤ï¼ˆ20.0ï¼‰</font></font></td>
</tr>
</tbody></table></div><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€é©åŒ–æ´»å‹•</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€ã•ã¾ã–ã¾ãªæœ€é©åŒ–æ‰‹æ®µãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚ãã®ä¸»ãªã‚‚ã®ã¯ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åŒ–ã¨å¤‰æ›´ã§ã™ã€‚ãŸã ã—ã€PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ä¸‹ã®ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å‹•ä½œã‚’é«˜é€ŸåŒ–ã§ãã‚‹ã„ãã¤ã‹ã®é‡è¦ã§æœ‰ç”¨ãªå¯¾ç­–ã«ã¤ã„ã¦ã€ä¸€è¨€è¨€åŠã™ã‚‹ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‡è¦ãªãŠçŸ¥ã‚‰ã›ã€‚</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¨˜äº‹ã®è³‡æ–™ã®åé›†æ™‚ã«ã¯ã€Zabbixãƒãƒ¼ã‚¸ãƒ§ãƒ³4.0ã‚’ä½¿ç”¨ã—ã¾ã—ãŸãŒã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³4.2ã¯ã™ã§ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ãŠã‚Šã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³4.4ã®ãƒªãƒªãƒ¼ã‚¹ãŒæº–å‚™ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã¤ã„ã¦è¨€åŠã™ã‚‹ã“ã¨ãŒãªãœé‡è¦ãªã®ã§ã™ã‹ï¼Ÿãƒãƒ¼ã‚¸ãƒ§ãƒ³4.2ã‹ã‚‰ã€Zabbixã¯TimescaleDBæ™‚ç³»åˆ—ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ç‰¹åˆ¥ãªå¼·åŠ›ãªæ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚µãƒãƒ¼ãƒˆã—å§‹ã‚ã¾ã—ãŸãŒã€ã“ã‚Œã¾ã§ã®å®Ÿé¨“ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã®ã™ã¹ã¦ã®åˆ©ç‚¹ã«ã¤ã„ã¦ã€ä¸€éƒ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‹•ä½œãŒé…ããªã‚Šã€æœªè§£æ±ºã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡ŒãŒæ®‹ã£ã¦ã„ã‚‹ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³4.4ã§è§£æ±ºï¼‰- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®è¨˜äº‹ã‚’èª­ã‚“ã§ãã ã•ã„</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¬¡ã®è¨˜äº‹ã§ã¯ã€ã“ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚±ãƒ¼ã‚¹ã¨æ¯”è¼ƒã—ã¦ã€TimescaleDBæ‹¡å¼µæ©Ÿèƒ½ã‚’ã™ã§ã«ä½¿ç”¨ã—ã¦ã„ã‚‹è² è·ãƒ†ã‚¹ãƒˆã®çµæœã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹äºˆå®šã§ã™ã€‚</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³10ãŒä½¿ç”¨ã•ã‚Œã¾ã—ãŸãŒã€æŒ‡å®šã•ã‚ŒãŸã™ã¹ã¦ã®æƒ…å ±ã¯11ãŠã‚ˆã³12ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«é–¢é€£ã—ã¦ã„ã¾ã™ï¼ˆå¾…æ©Ÿä¸­ï¼â€‹â€‹ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ãŸãŒã£ã¦ã€ã¾ãšæœ€åˆã«ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgtuneãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ã—ãŸæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ¥ã®ç‰©ç†ãƒ‡ã‚£ã‚¹ã‚¯ã«ç½®ã</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_pathmanã‚’ä½¿ç”¨ã—ãŸå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ†å‰²</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ—ã‚’brinï¼ˆã‚¯ãƒ­ãƒƒã‚¯ï¼‰ãŠã‚ˆã³btree-ginï¼ˆitemidï¼‰ã«å¤‰æ›´</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ã‚¨ãƒªå®Ÿè¡Œçµ±è¨ˆã®åé›†ã¨åˆ†æpg_stat_statements</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç‰©ç†ãƒ‡ã‚£ã‚¹ã‚¯ç›£è¦–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­å®š</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ†æ•£ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ä½œæˆï¼ˆã“ã®è¨˜äº‹ã®ç¯„å›²å¤–ã®è³‡æ–™ï¼‰</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgtuneãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’ä½¿ç”¨ã—ãŸæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æˆ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®Ÿéš›ã€PostgreSQLã¯ã‹ãªã‚Šè»½é‡ã®DBMSã§ã™ã€‚</font><font style="vertical-align: inherit;">ãã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ç§ã®åŒåƒšãŒè¨€ã†ã‚ˆã†ã«ã€ã€Œã‚³ãƒ¼ãƒ’ãƒ¼ãƒã‚·ãƒ³ã§ä½œæ¥­ã™ã‚‹ã€ã‚ˆã†ã«æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">éå¸¸ã«æ§ãˆã‚ãªã‚¢ã‚¤ã‚¢ãƒ³ã§ã€‚</font><font style="vertical-align: inherit;">ã—ãŸãŒã£ã¦ã€ãƒ¡ãƒ¢ãƒªã®é‡ã€ãƒ—ãƒ­ã‚»ãƒƒã‚µã®æ•°ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½¿ç”¨ç›®çš„ã®ç¨®é¡ã€ãƒ‡ã‚£ã‚¹ã‚¯ã®ç¨®é¡ï¼ˆHDDã¾ãŸã¯SSDï¼‰ã€ãŠã‚ˆã³æ¥ç¶šæ•°ã‚’è€ƒæ…®ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼æ§‹æˆç”¨ã«PostgreSQLã‚’æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚²ã—ã„ã‹ãªã€ã™ã¹ã¦ã®DBMSã‚’ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ãŸã‚ã®å˜ä¸€ã®å…¬å¼ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã»ã¨ã‚“ã©ã®æ§‹æˆã«é©ã—ãŸç‰¹å®šã®ãƒ«ãƒ¼ãƒ«ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã™ï¼ˆã‚ˆã‚Šæ­£ç¢ºãªãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã¯ã™ã§ã«å°‚é–€å®¶ã®ä»•äº‹ã§ã™ï¼‰ã€‚</font><font style="vertical-align: inherit;">DBAã®ç”Ÿæ´»ã‚’ç°¡ç´ åŒ–ã™ã‚‹ãŸã‚ã«ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgtune</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒä½œæˆã•ã‚Œã¾ã—ãŸ</font><font style="vertical-align: inherit;">ã€‚ã“ã‚Œã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¦ãƒ¼ã‚¶ãƒ¼</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ã«ã‚ˆã£ã¦Webãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦</font></a><font style="vertical-align: inherit;">è£œè¶³ã•ã‚Œã¾ã—ãŸã€‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le0pard</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-PostgreSQLã®ç®¡ç†ã«é–¢ã™ã‚‹èˆˆå‘³æ·±ãæœ‰ç”¨ãªæœ¬ã®è‘—è€…ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã€Œãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã®100æ¥ç¶šï¼ˆZabbixã«ã¯å³ã—ã„Webç®¡ç†è€…ãŒã„ã‚‹ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’å®Ÿè¡Œã™ã‚‹ä¾‹ï¼š</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgtune -i postgresql.conf -o new_postgresql.conf -T DW -c 100</font></font></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgtuneãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒç›®çš„ã®èª¬æ˜ã§å¤‰æ›´ã™ã‚‹æ§‹æˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå€¤ã¯ä¾‹ã¨ã—ã¦ç¤ºã•ã‚Œã¦ã„ã¾ã™ï¼‰</font></font></b><div class="spoiler_text"><pre># DB Version: 11<font></font>
# OS Type: linux<font></font>
# DB Type: web<font></font>
# Total Memory (RAM): 8 GB<font></font>
# CPUs num: 1<font></font>
# Connections num: 100<font></font>
# Data Storage: hdd<font></font>
<font></font>
max_connections = 100               #      <font></font>
shared_buffers = 2GB                #      (      )   <font></font>
effective_cache_size = 6GB          #          <font></font>
maintenance_work_mem = 512MB        #      VACUUM, ANALYZE, CREATE INDEX<font></font>
checkpoint_completion_target = 0.7  #       <font></font>
wal_buffers = 16MB                  #  ,   Shared Memory    <font></font>
default_statistics_target = 100     #  ,   ANALYZE -      ,  <font></font>
random_page_cost = 4                #        -     <font></font>
effective_io_concurrency = 2        #    /,        <font></font>
work_mem = 10485kB                  #  ,       - ,      <font></font>
min_wal_size = 1GB                  #     WAL,       <font></font>
max_wal_size = 2GB                  #     WAL,      </pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã„ãã¤ã‹ã®ä¾¿åˆ©ãªpostgresqlè¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³</font></font></b><div class="spoiler_text"><pre>#    <font></font>
max_worker_processes = 8            #     -     <font></font>
max_parallel_workers_per_gather = 4 #        <font></font>
max_parallel_workers = 8            #    ,       <font></font>
<font></font>
#   (          pg_stat_statements)<font></font>
log_min_duration_statement = 3000   #       ,    &gt;=    <font></font>
log_duration = off                  #     <font></font>
log_statement = 'none'              #  SQL-   , : none (), ddl, mod  all ( )<font></font>
debug_print_plan = off              #       <font></font>
<font></font>
#              (  ,    ssd   )<font></font>
#fsync = off                        #     ,  fsync    ,      <font></font>
#synchronous_commit = off           #           WAL -     fsync<font></font>
#full_page_writes = off             #    ,            </pre></div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ¥ã®ç‰©ç†ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸€è¦§è¡¨ç¤º</font></font></h4><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®é …ç›®ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€æœ¬æ ¼çš„ãªåˆ†æ•£ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¸ã®ç§»è¡Œã«é–¢ã™ã‚‹æš«å®šçš„ãªæ±ºå®šã§ã™ãŒã€ã“ã®å¯èƒ½æ€§ã«ã¤ã„ã¦çŸ¥ã£ã¦ãŠãã¨å½¹ç«‹ã¡ã¾ã™ã€‚</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã«ã€åˆ¥ã®ãƒ‡ã‚£ã‚¹ã‚¯ã«ç½®ãã“ã¨ãŒã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã™ã¹ã¦ã®PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ‡ã‚£ã‚¹ã‚¯å…¨ä½“ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¾ã—ãŸãŒã€é€šå¸¸ã¯åˆ¥ã®æ–¹æ³•ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆã¾ãŸã¯ãã®ä¸€éƒ¨ã®ã¿-ãƒ—ãƒ©ã‚¤ãƒãƒªãŠã‚ˆã³é›†ç´„ã•ã‚ŒãŸãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã‚’åˆ¥ã®ãƒ‡ã‚£ã‚¹ã‚¯ã®ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ™ãƒ¼ã‚¹ã«è»¢é€ã—ã¾ã™ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒã‚¦ãƒ³ãƒˆä¾‹</font></font></b><div class="spoiler_text">       ext4     .        noatime: <br>
<br>
<pre>mount /dev/sdc1 /var/lib/pgsql/10/data/base -o noatime</pre><br>
       /etc/fstab :<br>
<br>
<pre>#  UUID -  ,      blkid<font></font>
UUID=121efe29-70bf-410b-bc71-90704568ce3b /var/lib/pgsql/10/data/base ext4 defaults,noatime 0 0 </pre><br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_pathmanã‚’ä½¿ç”¨ã—ãŸå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbixã®ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆä¸­ã«ç™ºç”Ÿã—ãŸå•é¡Œã®1ã¤-PostgreSQLã¯ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åŒ–ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãã®æ§‹æˆéƒ¨åˆ†ã«åˆ†å‰²ã—ã€ãã‚Œã«ã‚ˆã£ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å…¨ä½“ã®ã‚µã‚¤ã‚ºã¨ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹æˆéƒ¨åˆ†ã‚’æ¸›ã‚‰ã™ã“ã¨ãŒã§ãã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å…¨ä½“ã®é€Ÿåº¦ã«ãƒ—ãƒ©ã‚¹ã®å½±éŸ¿ã‚’ä¸ãˆã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è§£ãä¸€åº¦ã«2ã¤ã®å•é¡Œä»•åˆ‡ã‚‹ï¼š</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã‚’ä¿ƒé€²1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2åˆ†å‰²ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å„è¤‡åˆãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼šPostgreSQLã®ã«åŒºç”»ã™ã‚‹4ã¤ã®æ©Ÿæ§‹ãŒå­˜åœ¨ã™ã‚‹</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã€‚1.æ¨™æº–constraint_exclusionã®</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 pg_partmanæ‹¡å¼µå­ï¼ˆ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_pathmanã¨ã—ãªã„æ··åŒè¡Œã†</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">pg_pathmanã®</font></a><font style="vertical-align: inherit;">æ‹¡å¼µã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 4.è‡ªåˆ†ã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’æ‰‹å‹•ã§ä½œæˆã—ã¦ä¿å®ˆã™ã‚‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã®æœ€ã‚‚ä¾¿åˆ©ã§ä¿¡é ¼æ€§ãŒé«˜ãã€æœ€é©åŒ–ã•ã‚ŒãŸã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_pathman</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‹¡å¼µ</font><font style="vertical-align: inherit;">ã§ã™ã€‚ã“ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²æ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã¯ã€ã©ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã™ã‚‹ã‹ã‚’æŸ”è»Ÿã«æ±ºå®šã—ã¾ã™ã€‚</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å™‚ã«ã‚ˆã‚‹ã¨ã€PostgreSQLã®12ç•ªç›®ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€ã™ãã«ä½¿ãˆã‚‹å„ªã‚ŒãŸãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãŒã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ãŸãŒã£ã¦ã€ç§ãŸã¡ã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã¯åˆ¥ã®ç¶™æ‰¿ã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã«æ¯æ—¥ã®ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿å§‹ã‚ã€å¤ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å€¤ã®å‰Šé™¤ã¯ã€ã™ã¹ã¦ã®å¤ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä¸€åº¦ã«å‰Šé™¤ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦è¡Œã‚ã‚Œå§‹ã‚ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€DBMSã«ã¨ã£ã¦äººä»¶è²»ã§ã¯ã‚‹ã‹ã«ç°¡å˜ã§ã™ã€‚</font><font style="vertical-align: inherit;">å‰Šé™¤ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°ã‚’Zabbixã‚µãƒ¼ãƒãƒ¼ã®ç›£è¦–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦åˆå‰2æ™‚ã«å‘¼ã³å‡ºã—ã€çµ±è¨ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®è¨±å®¹ç¯„å›²ã‚’ç¤ºã—ã¦è¡Œã‚ã‚Œã¾ã—ãŸã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL 10ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³è¨­å®šã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦è¨­å®šã™ã‚‹</font></font></b><div class="spoiler_text">    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">pg_pathman</a>     (              github):<br>
<br>
<pre>yum install pg_pathman10<font></font>
nano /var/pgsqldb/postgresql.conf<font></font>
shared_preload_libraries = 'pg_pathman' #  -   pg_pathman   <font></font>
</pre><br>
 ,         (1       3      â€”      1 ):<br>
<br>
<pre>systemctl restart postgresql-10.service<font></font>
psql -d zabbix -U postgres<font></font>
CREATE EXTENSION pg_pathman;<font></font>
#         <font></font>
# 1552424400 -    unix timestamp, 86400 -   <font></font>
select create_range_partitions('history', 'clock', 1552424400, 86400);<font></font>
select create_range_partitions('history_uint', 'clock', 1552424400, 86400);<font></font>
select create_range_partitions('history_text', 'clock', 1552424400, 86400);<font></font>
select create_range_partitions('history_str', 'clock', 1552424400, 86400);<font></font>
select create_range_partitions('history_log', 'clock', 1552424400, 86400);<font></font>
#         <font></font>
# 1552424400 -    unix timestamp, 259200 -    <font></font>
select create_range_partitions('trends', 'clock', 1545771600, 259200);  <font></font>
select create_range_partitions('trends_uint', 'clock', 1545771600, 259200); <font></font>
</pre><br>
<i>  -     ,      create_range_partitions      p_count = 0_.</i><br>
<br>
      :<br>
<br>
<pre>#    ,   :<font></font>
select * from pathman_config;<font></font>
#     ,       :<font></font>
select * from pathman_partition_list;<font></font>
#  ,    pg_pathman:<font></font>
select * from pathman_config_params;<font></font>
#         :<font></font>
select drop_partitions('table_name'::regclass, false);<font></font>
</pre><br>
         :<br>
<pre><code class="sql hljs"><span class="hljs-comment">/*       */</span>
<span class="hljs-keyword">SELECT</span> 
nspname <span class="hljs-keyword">AS</span> schemaname, relname, relkind, <span class="hljs-keyword">cast</span> (reltuples <span class="hljs-keyword">as</span> <span class="hljs-built_in">int</span>),<font></font>
pg_size_pretty(pg_relation_size(C.oid)) <span class="hljs-keyword">AS</span> <span class="hljs-string">"size"</span>
<span class="hljs-keyword">FROM</span> 
pg_class C <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> pg_namespace N <span class="hljs-keyword">ON</span> (N.oid = C.relnamespace)
<span class="hljs-keyword">WHERE</span> 
nspname <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pg_catalog'</span>, <span class="hljs-string">'information_schema'</span>) 
<span class="hljs-keyword">and</span> (relname <span class="hljs-keyword">like</span> <span class="hljs-string">'history%'</span> <span class="hljs-keyword">or</span> relname <span class="hljs-keyword">like</span> <span class="hljs-string">'trends%'</span>) <span class="hljs-keyword">and</span> relkind = <span class="hljs-string">'r'</span> 
<span class="hljs-comment">-- and reltuples &gt; 0</span>
<span class="hljs-comment">-- and pg_relation_size(C.oid) &gt;= 0</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> schemaname, relname</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤ã„ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹è‡ªå‹•æ§‹æˆï¼ˆahtung-å¤§ããªSQLé–¢æ•°ï¼‰</font></font></b><div class="spoiler_text">   ,      <br>
( ,     ):<br>
<br>
<pre>CREATE OR REPLACE FUNCTION public.delete_old_partitions(history_days integer, trends_days integer, str_days integer)<font></font>
 RETURNS text<font></font>
 LANGUAGE plpgsql<font></font>
AS $function$<font></font>
/*<font></font>
   , ,    :<font></font>
history_days -   history_x, history_uint_x<font></font>
trends_days  -   trends_x, trends_uint_x<font></font>
str_days     -   history_str_x, history_text_x, history_log_x<font></font>
*/<font></font>
declare clock_today_start         int;<font></font>
declare clock_delete_less_history int  = 0;<font></font>
declare clock_delete_less_trends  int  = 0;<font></font>
declare clock_delete_less_strings int  = 0;<font></font>
clock_delete_less                 int  = 0;<font></font>
declare iterator                  int  = 0;<font></font>
declare result_str                text = '';<font></font>
declare buf_table_size            text;<font></font>
declare buf_table_len             text;<font></font>
declare partition_name            text;<font></font>
declare clock_max                 text;<font></font>
declare err_detail                text;<font></font>
declare t_start                   timestamp = clock_timestamp();<font></font>
declare t_end                     timestamp;<font></font>
begin<font></font>
    if $1 &lt;= 0 then return 'ups, something wrong: history_days argument must be positive integer value'; end if;<font></font>
    if $2 &lt;= 0 then return 'ups, something wrong: trends_days argument must be positive integer value'; end if;<font></font>
    if $3 &lt;= 0 then return 'ups, something wrong: str_days argument must be positive integer value'; end if;<font></font>
    clock_today_start = extract(epoch from date_trunc('day', now()))::int;<font></font>
    clock_delete_less_history = extract(epoch from date_trunc('day', now()) - ($1::text || ' days')::interval)::int;<font></font>
    clock_delete_less_trends  = extract(epoch from date_trunc('day', now()) - ($2::text || ' days')::interval)::int;<font></font>
    clock_delete_less_strings = extract(epoch from date_trunc('day', now()) - ($3::text || ' days')::interval)::int;<font></font>
    clock_delete_less = least(clock_delete_less_history, clock_delete_less_trends, clock_delete_less_strings);<font></font>
    --raise notice 'clock_today_start % (%)', to_timestamp(clock_today_start), clock_today_start;<font></font>
    --raise notice 'clock_delete_less_history % (%) % days', to_timestamp(clock_delete_less_history), clock_delete_less_history, $1;<font></font>
    --raise notice 'clock_delete_less_trends  % (%) % days', to_timestamp(clock_delete_less_trends),  clock_delete_less_trends,  $2;<font></font>
    --raise notice 'clock_delete_less_strings % (%) % days', to_timestamp(clock_delete_less_strings), clock_delete_less_strings, $3;<font></font>
    for partition_name, clock_max in select partition, range_max from pathman_partition_list where <font></font>
    range_max::int &lt;= greatest(clock_delete_less_history, clock_delete_less_trends, clock_delete_less_strings) and <font></font>
    (partition::text like 'history%' or partition::text like 'trends%') order by partition asc<font></font>
    loop<font></font>
        if (partition_name ~ 'history_uint_\d'  and clock_max::int &lt;= clock_delete_less_history)<font></font>
        or (partition_name ~ 'history_\d'       and clock_max::int &lt;= clock_delete_less_history)<font></font>
        or (partition_name ~ 'trends_\d'        and clock_max::int &lt;= clock_delete_less_trends)<font></font>
        or (partition_name ~ 'history_log_\d'   and clock_max::int &lt;= clock_delete_less_strings)<font></font>
        or (partition_name ~ 'history_str_\d'   and clock_max::int &lt;= clock_delete_less_strings)<font></font>
        or (partition_name ~ 'history_text_\d'  and clock_max::int &lt;= clock_delete_less_strings)<font></font>
        then <font></font>
            iterator = iterator + 1;<font></font>
            raise notice '%', format('!!! delete %s %s', partition_name, clock_max);<font></font>
            select max(reltuples::int), pg_size_pretty(sum(pg_relation_size(pg_class.oid))) as "size" from pg_class where relname like partition_name || '%' into strict buf_table_len, buf_table_size;<font></font>
            if result_str != '' then result_str = result_str || ', '; end if;<font></font>
            result_str = result_str || format('%s (dt &lt; %s, len %s, %s)', partition_name, to_char(to_timestamp(clock_max::int), 'YYYY-MM-DD'), buf_table_len, buf_table_size);<font></font>
            execute format('drop table if exists %s', partition_name);<font></font>
        end if;<font></font>
    end loop;<font></font>
    if iterator = 0 then  result_str = format('there is no partitions to delete older, then %s date', to_char(to_timestamp(clock_delete_less), 'YYYY-MM-DD')); <font></font>
    else                  result_str = format('deleted %s partitions in %s seconds: ', iterator, trunc(extract(seconds from (clock_timestamp() - t_start))::numeric, 3)) || result_str;<font></font>
    end if;<font></font>
    --raise notice '%', result_str;<font></font>
    return result_str;<font></font>
exception when others then<font></font>
   get stacked diagnostics err_detail = PG_EXCEPTION_CONTEXT;<font></font>
   return format('ups, something wrong: %s [err code %s], %s', sqlerrm, sqlstate, err_detail);<font></font>
end; <font></font>
$function$;<font></font>
</pre><br>
              zabbix  Â« Â»   :<br>
<br>
<pre>- : database monitor<font></font>
- : delete_old_history_partitions<font></font>
- : db.odbc.select[delete_old_history_partitions, zabbix]<font></font>
- sql : select delete_old_partitions(3, 30, 30);<font></font>
#       delete_old_partitions      <font></font>
#   ,      <font></font>
-  : <font></font>
-  : 0<font></font>
-  :    h2<font></font>
-   : 90 <font></font>
-   : Database<font></font>
</pre><br>
          :<br>
<br>
<pre>2019-09-16 02:00:00, deleted 3 partitions in 0.024 seconds: trends_78 (dt &lt; 2019-08-17, len 1, 48 kB), history_193 (dt &lt; 2019-09-13, len 85343, 9448 kB), history_uint_186 (dt &lt; 2019-09-13, len 27969, 3480 kB)
</pre><br>
<b>!</b>                    housekeeper Zabbix: <i>  zabbix   Â«Â» -&gt; Â«Â» -&gt;       Â« Â» -&gt;      Â«Â»  Â« Â».</i><br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ—ã‚’brinï¼ˆã‚¯ãƒ­ãƒƒã‚¯ï¼‰ãŠã‚ˆã³btree-ginï¼ˆitemidï¼‰ã«å¤‰æ›´</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ„Ÿè¬ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¨ãƒ­ã‚´ãƒ•</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»¥ä¸‹ã®ãŸã‚ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨˜äº‹ã®å‰å¤§ãªã‚·ãƒªãƒ¼ã‚º</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãã—ã¦å®Ÿéš›ã€PostgresPROãƒãƒ¼ãƒ å…¨ä½“ã€‚</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã®è¨˜äº‹ã«æ„ŸéŠ˜ã‚’å—ã‘ã¦ã€ç›£è¦–ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã•ã¾ã–ã¾ãªç¨®é¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã„ã˜ã‚Šã€ã©ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã©ã®ç¨®é¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæœ€å¤§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã‚’ã‚‚ãŸã‚‰ã™ã‹ã¨ã„ã†çµè«–ã«é”ã—ã¾ã—ãŸã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹btreeï¼ˆitemidã€ã‚¯ãƒ­ãƒƒã‚¯ï¼‰ã¯ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä½œæˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã¾ã™ã€‚ç‰¹ã«å˜èª¿ã«ä¸¦ã¹ã‚‰ã‚ŒãŸå€¤ã®æ¤œç´¢ã¯é«˜é€Ÿã§ã™ãŒã€å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆ1,000ä¸‡ã‚’è¶…ãˆã‚‹ï¼‰ãŒã‚ã‚‹å ´åˆã€ãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã§ã€Œè†¨ã‚‰ã¿ã€ã¾ã™ã€‚</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é€šå¸¸ã€ä¸€æ„ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯1æ™‚é–“ã”ã¨ã«é›†è¨ˆã•ã‚ŒãŸçµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã«ä½œæˆã•ã‚Œã¾ã™ãŒã€ã“ã‚Œã‚‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ä¸€æ„æ€§ã®ãŸã‚ã«ã“ã“ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ãƒ¬ãƒ™ãƒ«ã§æä¾›ã•ã‚Œã€ä¸€æ„ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ã‚’é…ãã™ã‚‹ã ã‘ã§ã™ã€‚</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ã•ã¾ã–ã¾ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ†ã‚¹ãƒˆä¸­ã«ã€æœ€ã‚‚æˆåŠŸã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®çµ„ã¿åˆã‚ã›ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã®ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ™‚è¨ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®brinã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨itemidãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®btree-ginã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã™ã€‚</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ–ãƒªãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã®äº‹å®Ÿã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã©ã€å˜èª¿ã«å¢—åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã«æœ€é©ã§ã™ã€‚æ™‚ç³»åˆ—ã€‚ã¾ãŸã€btree-ginã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯åŸºæœ¬çš„ã«æ¨™æº–ãƒ‡ãƒ¼ã‚¿å‹ã«å¯¾ã™ã‚‹ginã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚ã‚Šã€ä¸€èˆ¬çš„ã«ã¯å¾“æ¥ã®btreeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«é«˜é€Ÿã§ã™ã€‚ ginã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€æ–°ã—ã„å€¤ã®è¿½åŠ æ™‚ã«å†æ§‹ç¯‰ã•ã‚Œã¾ã›ã‚“ãŒã€ãã‚Œã‚‰ã«ã‚ˆã£ã¦è£œè¶³ã•ã‚Œã‚‹ã ã‘ã§ã™ã€‚</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">btree-ginã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€PostgreSQLã®æ‹¡å¼µã¨ã—ã¦é…ç½®ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆæˆ¦ç•¥ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Zabbixãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°é€Ÿåº¦ã®æ¯”è¼ƒã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆä¸­ã«ã€3ã¤ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’3æ—¥é–“è“„ç©ã—ã¾ã—ãŸã€‚</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MLNã®è¡Œæ•°</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MBå˜ä½ã®ã‚µã‚¤ã‚º</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history_uint_1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">81.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4119</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history_uint_2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">74.9</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4426</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history_uint_3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100.7</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5387</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çµæœã‚’è©•ä¾¡ã™ã‚‹ãŸã‚ã«ã€3ç¨®é¡ã®ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰æœˆã®1ã¤ã®ç‰¹å®šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼itemidãƒ‡ãƒ¼ã‚¿ã€å®Ÿéš›ã«ã¯éå»3æ—¥é–“ï¼ˆåˆè¨ˆ1660ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select * from history_uint where itemid = 313300ã®åˆ†æã‚’èª¬æ˜ã—ã¾ã™</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and clock&gt; =æŠ½å‡ºï¼ˆ '2019-03-09 00:00:00'ã‹ã‚‰ã®ã‚¨ãƒãƒƒã‚¯::ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰:: int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦æ™‚è¨ˆ&lt;=æŠ½å‡ºï¼ˆ '2019-04-09 12:00:00'ã‹ã‚‰ã®ã‚¨ãƒãƒƒã‚¯::ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰:: int;</font></font><font></font>
</pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1ã¤ã®ç‰¹å®šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®1æ—¥12æ™‚é–“ï¼ˆåˆè¨ˆ649ã‚¨ãƒ³ãƒˆãƒªï¼‰</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select * from history_text where itemid = 310650ã®åˆ†æã‚’èª¬æ˜ã—ã¾ã™</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and clock&gt; =æŠ½å‡ºï¼ˆ '2019-04-09 00:00:00'ã‹ã‚‰ã®ã‚¨ãƒãƒƒã‚¯::ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰:: int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦æ™‚è¨ˆ&lt;=æŠ½å‡ºï¼ˆ '2019-04-09 12:00:00'ã‹ã‚‰ã®ã‚¨ãƒãƒƒã‚¯::ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰:: int;</font></font><font></font>
</pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1ã¤ã®ç‰¹å®šã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®1æ™‚é–“ï¼ˆåˆè¨ˆ61ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼‰ï¼š</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">item_idãŒ336540ã§ã‚ã‚‹history_textã‹ã‚‰ã®é¸æŠã‚«ã‚¦ãƒ³ãƒˆï¼ˆ*ï¼‰ã®åˆ†æ</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and clock&gt; =æŠ½å‡ºï¼ˆ '2019-04-08 11:00:00'ã‹ã‚‰ã®ã‚¨ãƒãƒƒã‚¯::ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰:: int</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã—ã¦æ™‚è¨ˆ&lt;=æŠ½å‡ºï¼ˆ '2019-04-08 12:00:00'ã‹ã‚‰ã®ã‚¨ãƒãƒƒã‚¯::ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰:: int;</font></font><font></font>
</pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ†ã‚¹ãƒˆçµæœã‚’ä»¥ä¸‹ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ—</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MBå˜ä½ã®ã‚µã‚¤ã‚º*</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ãƒªã‚¯ã‚¨ã‚¹ãƒˆ1 **ï¼ˆãƒŸãƒªç§’ï¼‰</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ2 **ï¼ˆãƒŸãƒªç§’ï¼‰</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ãƒªã‚¯ã‚¨ã‚¹ãƒˆ3 **ï¼ˆãƒŸãƒªç§’ï¼‰</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">btreeï¼ˆæ™‚è¨ˆã€itemidï¼‰</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">14741</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7154.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2205.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1860.4</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">brinï¼ˆæ™‚è¨ˆï¼‰ã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
btree-ginï¼ˆitemidï¼‰</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.42ãŠã‚ˆã³1329</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2958.2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1820.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">102.1</font></font></td>
</tr>
</tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* 3ã¤ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®åˆè¨ˆã‚µã‚¤ã‚ºã¯MBã§ç¤ºã•ã‚Œã¾ã™</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
**ã‚¿ã‚¤ãƒ—1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ-3æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã€ã‚¿ã‚¤ãƒ—2ãƒªã‚¯ã‚¨ã‚¹ãƒˆ-12æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿ã€ã‚¿ã‚¤ãƒ—3ãƒªã‚¯ã‚¨ã‚¹ãƒˆ-1æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¯”è¼ƒè¡¨ã‹ã‚‰ã€ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã®ã‚ã‚‹å¤§ããªãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®å ´åˆãŒã‚ã‹ã‚Šã¾ã™1å„„ã‚’è¶…ãˆã‚‹ã¨ã€æ¨™æº–ã®è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹btreeã‚’2ã¤ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹brinã¨btree-ginã«å¤‰æ›´ã™ã‚‹ã¨ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚ºãŒå°ã•ããªã‚Šã€ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œæ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œã‚‹ã¨ã„ã†ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ–°ã—ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’history_uintãƒ†ãƒ¼ãƒ–ãƒ«ã¨trends_uintãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¾‹ã§ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²ã®åŠ¹æœã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ï¼ˆè¿½åŠ ã¯ã‚¯ã‚¨ãƒªã”ã¨ã«å¹³å‡2000ã®å€¤ã§ç™ºç”Ÿã—ã¾ã™ï¼‰ã€‚</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ†ãƒ¼ãƒ–ãƒ«</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ”¹å–„ã¾ã§ã®å¹³å‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚é–“ã€ãƒŸãƒªç§’</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ”¹å–„å¾Œã®å¹³å‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚é–“ã€ãƒŸãƒªç§’</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trends_uint</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2201.48</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.72</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trends_uint</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1997.27</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">62.16</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
zabbixã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã•ã¾ã–ã¾ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®šã®ãƒ†ã‚¹ãƒˆçµæœã‚’è¦ç´„ã™ã‚‹ã¨ã€zabbixã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ¨™æº–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åŒæ§˜ã®å¤‰æ›´ã¯ã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«ãƒ—ãƒ©ã‚¹ã®å½±éŸ¿ã‚’ä¸ãˆã‚‹ã¨è¨€ãˆã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€æ¨™æº–btreeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã€Œè†¨å¼µã€ã®é–“æ¥çš„ãªå½±éŸ¿ã‚’å¿˜ã‚Œã¦ãã ã•ã„ã€‚ãƒãƒ«ãƒã‚®ã‚¬ãƒã‚¤ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é »ç¹ã«å†æ§‹ç¯‰ã™ã‚‹ã¨ã€ãƒãƒ¼ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯ã®è² è·ãŒé«˜ããªã‚Šï¼ˆä½¿ç”¨ç‡ãƒ¡ãƒˆâ€‹â€‹ãƒªãƒƒã‚¯ï¼‰ã€æœ€çµ‚çš„ã«ãƒ‡ã‚£ã‚¹ã‚¯æ“ä½œã®æ™‚é–“ãŒå¢—åŠ ã—ã€CPUã‹ã‚‰ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¾…æ©Ÿã™ã‚‹æ™‚é–“ãŒå¢—åŠ ã—ã¾ã™ï¼ˆiowaitãƒ¡ãƒˆãƒªãƒƒã‚¯ï¼‰ã€‚ ï¼‰</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã ãŒã€</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> btree-ginã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒitemintåˆ—ã§ã‚ã‚‹bigintï¼ˆin8ï¼‰ãƒ‡ãƒ¼ã‚¿å‹ã§æ©Ÿèƒ½ã§ãã‚‹ã‚ˆã†ã«ã€btree-ginã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®bigintæ¼”ç®—å­ã®ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚’ç™»éŒ²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bint-ginã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®bigintæ¼”ç®—å­ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚’ç™»éŒ²ã—ã¾ã™</font></font></b><div class="spoiler_text"><pre>/*<font></font>
     gin    biginteger  integer    .<font></font>
 -   gin     int2, int4, int8,<font></font>
       bigint     ,     bigint (&lt;= 2147483647)<font></font>
        intger_ops,  :<font></font>
create index on tablename using gin(columnname int8_family_ops) with (fastupdate = false);<font></font>
*/<font></font>
<font></font>
--       btree_gin<font></font>
CREATE EXTENSION btree_gin;<font></font>
<font></font>
CREATE OPERATOR FAMILY integer_ops using gin;<font></font>
<font></font>
CREATE OPERATOR CLASS int4_family_ops<font></font>
FOR TYPE int4 USING gin FAMILY integer_ops<font></font>
AS<font></font>
    OPERATOR        1       &lt;,<font></font>
    OPERATOR        2       &lt;=,<font></font>
    OPERATOR        3       =,<font></font>
    OPERATOR        4       &gt;=,<font></font>
    OPERATOR        5       &gt;,<font></font>
    FUNCTION        1       btint4cmp(int4,int4),<font></font>
    FUNCTION        2       gin_extract_value_int4(int4, internal),<font></font>
    FUNCTION        3       gin_extract_query_int4(int4, internal, int2, internal, internal),<font></font>
    FUNCTION        4       gin_btree_consistent(internal, int2, anyelement, int4, internal, internal),<font></font>
    FUNCTION        5       gin_compare_prefix_int4(int4,int4,int2, internal),<font></font>
STORAGE         int4;<font></font>
<font></font>
CREATE OPERATOR CLASS int8_family_ops<font></font>
FOR TYPE int8 USING gin FAMILY integer_ops<font></font>
AS<font></font>
    OPERATOR        1       &lt;,<font></font>
    OPERATOR        2       &lt;=,<font></font>
    OPERATOR        3       =,<font></font>
    OPERATOR        4       &gt;=,<font></font>
    OPERATOR        5       &gt;,<font></font>
    FUNCTION        1       btint8cmp(int8,int8),<font></font>
    FUNCTION        2       gin_extract_value_int8(int8, internal),<font></font>
    FUNCTION        3       gin_extract_query_int8(int8, internal, int2, internal, internal),<font></font>
    FUNCTION        4       gin_btree_consistent(internal, int2, anyelement, int4, internal, internal),<font></font>
    FUNCTION        5       gin_compare_prefix_int8(int8,int8,int2, internal),<font></font>
STORAGE         int8;<font></font>
<font></font>
ALTER OPERATOR FAMILY integer_ops USING gin add<font></font>
  OPERATOR 1 &lt;(int4,int8),<font></font>
  OPERATOR 2 &lt;=(int4,int8),<font></font>
  OPERATOR 3 =(int4,int8),<font></font>
  OPERATOR 4 &gt;=(int4,int8),<font></font>
  OPERATOR 5 &gt;(int4,int8);<font></font>
<font></font>
ALTER OPERATOR FAMILY integer_ops USING gin add<font></font>
  OPERATOR 1 &lt;(int8,int4),<font></font>
  OPERATOR 2 &lt;=(int8,int4),<font></font>
  OPERATOR 3 =(int8,int4),<font></font>
  OPERATOR 4 &gt;=(int8,int4),<font></font>
  OPERATOR 5 &gt;(int8,int4);<font></font>
</pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€Zabbixã®PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã™ã¹ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ§‹æˆã‹ã‚‰ä¸Šè¨˜ã®æœ€é©ãªæ§‹æˆã«å†é…å¸ƒã—ã¾ã™ã€‚</font></font></b><div class="spoiler_text"><pre>/*<font></font>
        <font></font>
*/<font></font>
<font></font>
--   <font></font>
drop index history_1;<font></font>
drop index history_uint_1;<font></font>
drop index history_str_1;<font></font>
drop index history_text_1;<font></font>
drop index history_log_1;<font></font>
--          PK <font></font>
-- (   ,         )<font></font>
alter table trends drop constraint trends_pk;<font></font>
alter table trends_uint drop constraint trends_uint_pk;<font></font>
<font></font>
--     bree-gin   itemid    <font></font>
--   btree-gin  bigint       <font></font>
-- https://habr.com/ru/company/postgrespro/blog/340978/#comment_10545932<font></font>
--    create extension btree_gin;<font></font>
create index on history      using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on history_uint using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on history_str  using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on history_text using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on history_log  using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on trends       using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
create index on trends_uint  using gin(itemid int8_family_ops) with (fastupdate = false);<font></font>
<font></font>
--     bree-gin   itemid    <font></font>
--     brin    128 ,    <font></font>
--           ,<font></font>
--      https://habr.com/ru/company/postgrespro/blog/346460/<font></font>
create index on history      using brin(clock) with (pages_per_range = 128);<font></font>
create index on history_uint using brin(clock) with (pages_per_range = 128);<font></font>
create index on history_str  using brin(clock) with (pages_per_range = 128);<font></font>
create index on history_text using brin(clock) with (pages_per_range = 128);<font></font>
create index on history_log  using brin(clock) with (pages_per_range = 128);<font></font>
create index on trends       using brin(clock) with (pages_per_range = 128);<font></font>
create index on trends_uint  using brin(clock) with (pages_per_range = 128);<font></font>
</pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¯åˆ†100ãƒˆãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå±¥æ­´ã§100ãƒˆãƒ³ã€history_uintã§100ãƒˆãƒ³ï¼‰ã®å¼·åº¦ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒ–ãƒªãƒ³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å ´åˆã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãƒ—ãƒ©ã‚¤ãƒãƒªãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§å‹•ä½œã—ã€ã‚¾ãƒ¼ãƒ³ã‚µã‚¤ã‚ºãŒ512ãƒšãƒ¼ã‚¸ã®2å€ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚æ¨™æº–ã‚µã‚¤ã‚ºã®128ãƒšãƒ¼ã‚¸ã‚ˆã‚Šã‚‚ã§ã™ãŒã€ã“ã‚Œã¯å€‹åˆ¥ã§ã‚ã‚Šã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚µã‚¤ã‚ºã¨ã‚µãƒ¼ãƒãƒ¼æ§‹æˆã«ä¾å­˜ã—ã¾ã™ã€‚ã„ãšã‚Œã®å ´åˆã§ã‚‚ã€brinã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå ã‚ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã¯ã”ãã‚ãšã‹ã§ã™ãŒã€ã‚¾ãƒ¼ãƒ³ã®ã‚µã‚¤ã‚ºã‚’å¾®èª¿æ•´ã™ã‚‹ã“ã¨ã§é€Ÿåº¦ã‚’ã‚ãšã‹ã«ä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ¬ãƒ¼ãƒˆãŒå¤§ããå¤‰åŒ–ã—ãªã„å ´åˆã«é™ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®çµæœã€Zabbixè‡ªä½“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«é–¢é€£ã™ã‚‹åˆ¶é™ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[æœ€è¿‘ã®ãƒ‡ãƒ¼ã‚¿]ã‚¿ãƒ–ã§ã¯ã€å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®æœ€å¾Œã®2ã¤ã®å€¤ãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è€ƒæ…®ã—ã¦åé›†ã•ã‚Œã¾ã™ã€‚å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ã¤ã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§å€‹åˆ¥ã«å€¤ãŒè¦æ±‚ã•ã‚Œã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ãã®ã‚ˆã†ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒé¸æŠã•ã‚Œã‚‹ã»ã©ã€ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œæ™‚é–“ãŒé•·ããªã‚Šã¾ã™ã€‚æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€btreeã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆitemidã€clock descï¼‰ãŒå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨­å®šã•ã‚Œã€æ™‚é–“ã§é€†ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã«æ¤œç´¢ã•ã‚Œã¾ã™ãŒã€åŒæ™‚ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è‡ªä½“ãŒãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã§ã€Œã‚¹ã‚¦ã‚§ãƒ«ã€ã—ã€ä¸€èˆ¬ã«é–“æ¥çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é€Ÿåº¦ãŒä½ä¸‹ã™ã‚‹ãŸã‚ã€å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚ä¸Šè¿°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ãŸãŒã£ã¦ã€3ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<ol>
<li>            Â« Â»      100  (..   ,     Â« Â»    )</li>
<li>    Zabbix ,                  ,          Â« Â»</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã«ã—ã¦ã€ã•ã¾ã–ã¾ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«å¯¾ã—ã¦åŒæ™‚ã«ï¼ˆæœ€è¿‘ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚¿ãƒ–ã§éå¸¸ã«å¤§ããªé¸æŠã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã®ã¿ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²ã«åˆ¶é™ã—ã¾ã™ï¼ˆãŸã ã—ã€Zabbix Webã‚µãƒ¼ãƒãƒ¼ã«ã¯ã€åŒæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å€¤ã®æ•°ã«åˆ¶é™ãŒã‚ã‚‹ã“ã¨ã«æ°—ä»˜ãã¾ã—ãŸ[æœ€è¿‘ã®ãƒ‡ãƒ¼ã‚¿]ã‚¿ãƒ–-5000ã®å€¤ã‚’è¡¨ç¤ºã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯çµæœã‚’è¨ˆç®—ã—ã¾ã—ãŸãŒã€ã‚µãƒ¼ãƒãƒ¼ã¯Webãƒšãƒ¼ã‚¸ã‚’æº–å‚™ã§ããšã€ãã®ã‚ˆã†ãªå¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰ã€‚</font></font></li>
</ol><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ã‚¨ãƒªå®Ÿè¡Œçµ±è¨ˆã®åé›†ã¨åˆ†æpg_stat_statements</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pg_stat_statementsã¯ã€ã‚µãƒ¼ãƒãƒ¼å…¨ä½“ã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«é–¢ã™ã‚‹çµ±è¨ˆã‚’åé›†ã™ã‚‹ãŸã‚ã®æ‹¡å¼µæ©Ÿèƒ½ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã®åˆ©ç‚¹ã¯ã€PostgreSQLãƒ­ã‚°ã‚’åé›†ã—ã¦è§£æã™ã‚‹å¿…è¦ãŒãªã„ã“ã¨ã§ã™ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statementsæ‹¡å¼µæ©Ÿèƒ½ã®ä½¿ç”¨</font></font></b><div class="spoiler_text">   psql:<br>
<br>
<pre>CREATE EXTENSION pg_stat_statements;</pre><br>
      postgresql.conf:<br>
<br>
<pre>shared_preload_libraries = 'pg_stat_statements'<font></font>
pg_stat_statements.max = 10000 #   sql ,     (     );<font></font>
pg_stat_statements.track = all # all -   (    ), top -   /, none -  <font></font>
pg_stat_statements.save = true #     <font></font>
</pre><br>
 :<br>
<br>
<pre>SELECT pg_stat_statements_reset();</pre><br>
         :<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> <span class="hljs-keyword">substring</span>(<span class="hljs-keyword">query</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'[^(]*'</span>) <span class="hljs-keyword">as</span> query_sub, 
<span class="hljs-keyword">sum</span>(calls) <span class="hljs-keyword">as</span> calls, <span class="hljs-keyword">avg</span>(mean_time) <span class="hljs-keyword">as</span> mean_time
<span class="hljs-keyword">from</span> pg_stat_statements
<span class="hljs-keyword">where</span>
<span class="hljs-keyword">query</span> ~ <span class="hljs-string">'insert into'</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">query</span> ~ <span class="hljs-string">'update trends'</span>
<span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">substring</span>(<span class="hljs-keyword">query</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'[^(]*'</span>)
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> calls <span class="hljs-keyword">desc</span></code></pre></div></div><br>
<h4>    </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbixã§ãƒãƒ¼ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã«ã€vfs.dev.readãŠã‚ˆã³vfs.dev.writeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã¿ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ã«é–¢ã™ã‚‹æƒ…å ±ã‚’æä¾›ã—ã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">ãƒãƒ¼ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®æœ‰ç”¨ãªåŸºæº–ã¯ã€ä½¿ç”¨ç‡ã€ã‚¯ã‚¨ãƒªå¾…æ©Ÿæ™‚é–“ã€ãƒ‡ã‚£ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¼ã®è² è·ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŸå‰‡ã¨ã—ã¦ã€é«˜ã„ãƒ‡ã‚£ã‚¹ã‚¯è² è·ã¯ã€CPUè‡ªä½“ã®é«˜ã„iowaitã¨SQLã‚¯ã‚¨ãƒªã®å®Ÿè¡Œæ™‚é–“ã®å¢—åŠ ã¨ç›¸é–¢ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã¨ä»£æ›¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®šã›ãšã«æ¨™æº–æ§‹æˆã§zabbixã‚µãƒ¼ãƒãƒ¼ã®ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆã‚’è¡Œã£ãŸã¨ãã«è¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">å‹äººã‹ã‚‰ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¨˜äº‹ã§</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¦—ã‹ã‚ŒãŸæ¬¡ã®æ‰‹é †ã‚’ä½¿ç”¨ã—ã¦ã€ãƒãƒ¼ãƒ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã®ã“ã‚Œã‚‰ã®ç›£è¦–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¬ã‚½ãƒ•ã‚¹ã‚­ãƒ¼</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ”¹å–„ï¼šiostatãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯ä¸€æ™‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã§jsonã®ãƒ‡ã‚£ã‚¹ã‚¯ã”ã¨ã«å€‹åˆ¥ã«åé›†ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ãã“ã‹ã‚‰ã€å¾Œå‡¦ç†è¨­å®šã«å¾“ã£ã¦ã€ãã‚Œã‚‰ã¯æœ€çµ‚çš„ãªç›£è¦–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«æ—¢ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¿ç•™ä¸­ã®å ´åˆ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ç§ã®ãƒ•ã‚©ãƒ¼ã‚¯ã‚’ä»‹ã—</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŸ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">è©³ç´°ãªæŒ‡ç¤º</font></a><font style="vertical-align: inherit;">ã«å¾“ã£ã¦ã€ãƒ‡ã‚£ã‚¹ã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
èª¬æ˜ã—ãŸã™ã¹ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¾Œã€ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚£ã‚¹ã‚¯ã®iowait cpuãŠã‚ˆã³utiliztionãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã‚«ã‚¹ã‚¿ãƒ ã‚°ãƒ©ãƒ•ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ã‚£ã‚¹ã‚¯ï¼ˆç•°ãªã‚‹å ´åˆï¼‰ã‚’ãƒ¡ã‚¤ãƒ³ã®Zabbixã‚µãƒ¼ãƒãƒ¼ç›£è¦–ãƒ‘ãƒãƒ«ã«è¿½åŠ ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">çµæœã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼ˆsdaã¯ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ã‚¹ã‚¯ã€sdcã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚ã‚‹ãƒ‡ã‚£ã‚¹ã‚¯ã§ã™ï¼‰ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oa/nj/fa/oanjfa3hajssftbq22dk8njiwj0.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBMSã®è¨­å®šã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³åˆ†å‰²ã‚’è¡Œã£ãŸå¾Œã€å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«é€²ã¿ã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ç‰¹æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚RAMã®è¿½åŠ ã€ãƒ‰ãƒ©ã‚¤ãƒ–ã®ã‚½ãƒªãƒƒãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆã¸ã®å¤‰æ›´ã€ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚³ã‚¢ã®è¿½åŠ ãªã©ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã¯ä¿è¨¼ã•ã‚ŒãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Šã§ã™ãŒã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®æœ€é©åŒ–å¾Œã«ã®ã¿è¡Œã†ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ†æ•£ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ä½œæˆ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸­ç¨‹åº¦ã®å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®å¾Œã€æ°´å¹³ã‹ã‚‰é–‹å§‹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™-åˆ†æ•£ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚·ãƒ£ãƒ¼ãƒ‰ã¾ãŸã¯ãƒã‚¹ã‚¿ãƒ¼ã‚¹ãƒ¬ãƒ¼ãƒ–ã‚’è¤‡è£½ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã ã—ã€ã“ã‚Œã¯åˆ¥ã®è¨˜äº‹ã®åˆ¥ã®ãƒˆãƒ”ãƒƒã‚¯ã¨è³‡æ–™</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆãŸã‚ã”ã¨ã¨æ£’ã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’å½¢æˆã™ã‚‹æ–¹æ³•ï¼‰ã§ã‚ã‚Š</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€pg_pathmanã‚’ä½¿ç”¨ã—ãŸå‰è¿°ã®Zabbixãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–æ‰‹æ³•ã¨ã€TimescaleDBæ‹¡å¼µã‚’é©ç”¨ã™ã‚‹æ–¹æ³•ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä»˜ã‘ã®æ¯”è¼ƒã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã‚Œã¾ã§ã®é–“ã€ã“ã®è¨˜äº‹ã®å†…å®¹ãŒæœ‰ç›Šã§æœ‰ç›Šã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ãŸã“ã¨ã®ã¿ã‚’æœŸå¾…ã§ãã¾ã™ã€‚</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja468447/index.html">Laragon-è‡ªå‹•ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã®WAMP</a></li>
<li><a href="../ja468453/index.html">MBLT19 ::ãƒ¬ãƒãƒ¼ãƒˆã€è£½å“ã®æˆ¦ã„ã€ãŠã‚ˆã³ãƒ†ã‚¹ãƒˆ</a></li>
<li><a href="../ja468455/index.html">ç´ æ™´ã‚‰ã—ã„GPSã¨ãã®ãƒ€ãƒ¼ã‚¯ã‚µã‚¤ãƒ‰</a></li>
<li><a href="../ja468457/index.html">ãƒ€ãƒŸãƒ¼ã®ãŸã‚ã®ç°¡å˜ãªç®—è¡“ä¾‹ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã ã‘ã§ãªãã€</a></li>
<li><a href="../ja468459/index.html">ç‰¹å¾´çš„ãªãƒ¬ãƒ¼ãƒ€ãƒ¼æ¢çŸ¥æ©Ÿã®æ¦‚è¦ï¼šãƒ•ãƒ©ãƒƒã‚°ã‚·ãƒƒãƒ—ã®Playme Silent 2</a></li>
<li><a href="../ja468465/index.html">å¼è­·å£«ã®è¦‹è§£ï¼šITä¼æ¥­ã¯æœ‰æ¯’ãªæ”¿åºœé¡§å®¢ã¨ã®å¥‘ç´„ã‚’ã©ã®ã‚ˆã†ã«çµ‚äº†ã§ãã‚‹ã‹</a></li>
<li><a href="../ja468471/index.html">AngularConnect 2019ã®æ¦‚è¦ã€‚ãƒ‘ãƒ¼ãƒˆ1</a></li>
<li><a href="../ja468479/index.html">ã€Œäººã€…ã¯ç„¡æ–™ã¯ä¾¡å€¤ãŒãªã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚ç§ã¯å½¼ã‚‰ã‚’ç´å¾—ã•ã›ã‚‹ã“ã¨ãŒã§ããŸã‚ˆã†ã«æ€ãˆã¾ã—ãŸã€-ãƒ«ã‚½ãƒ«å­¦æ ¡ã«ã¤ã„ã¦ã®ãƒ¦ãƒ¼ãƒªãƒ»ãƒ¤ãƒ«ãƒ„ã‚§ãƒ•</a></li>
<li><a href="../ja468481/index.html">S7ãŒãƒ­ã‚·ã‚¢ã§èˆªç©ºåˆ¸ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§è²©å£²ã—ãŸæœ€åˆã®æ–¹æ³•</a></li>
<li><a href="../ja468485/index.html">ç¾ã—ã„GUIãŒå¿…è¦ã ãŒã€GPUãŒä¸è¦ãªå ´åˆ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>