<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>➰ ♈️ 👨‍👦‍👦 Kubernetes提示和技巧：NGINX和PHP-FPM中的正常关闭运行时功能 👨🏻‍🏫 🤾🏻 ♉️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在Kubernetes中实现CI / CD的典型条件是：应用程序必须能够在停止之前停止接受新的客户端请求，最重要的是，成功完成现有请求。
 
 
 
 符合此条件可使您在部署期间实现零停机时间。但是，即使使用非常流行的捆绑软件（例如NGINX和PHP-FPM），您也可能会遇到困难，这将导致每次部署中...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes提示和技巧：NGINX和PHP-FPM中的正常关闭运行时功能</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/489994/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Kubernetes中实现CI / CD的典型条件是：应用程序必须能够在停止之前停止接受新的客户端请求，最重要的是，成功完成现有请求。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/ry/ef/karyefzfd99wtpxne9r_o73wies.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
符合此条件可使您在部署期间实现零停机时间。</font><font style="vertical-align: inherit;">但是，即使使用非常流行的捆绑软件（例如NGINX和PHP-FPM），您也可能会遇到困难，这将导致每次部署中出现大量错误...</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理论。</font><font style="vertical-align: inherit;">豆荚如何生活</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们已经发表</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这篇文章中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于荚生命周期的细节</font><font style="vertical-align: inherit;">。在本主题的上下文中，我们对以下内容感兴趣：当pod进入</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Termination</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状态时</font><font style="vertical-align: inherit;">，不再向其发送新请求（将pod </font><font style="vertical-align: inherit;">从服务的端点列表中</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">删除</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。因此，对于我们而言，为了避免在部署过程中出现停机，足以解决应用程序正确停止的问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还应记住，默认情况下宽限期为</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30秒</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：此后，吊舱将终止，应用程序应设法在此期间之前处理所有请求。</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：尽管运行超过5-10秒的任何请求都已经有问题，并且正常关机将不再对他有帮助...</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
为了更好地了解pod完成其工作会发生什么，只需研究以下方案即可：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zx/pt/ou/zxptou-qe7zxqgab6pszsdo5vlk.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A1，B1-进行更改子</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A2的</font><font style="vertical-align: inherit;">状态</font><font style="vertical-align: inherit;">：发送SIGTERM </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B2-从端点删除Pod </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B3-获取更改（端点列表已更改）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B4-更新iptables规则</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
注意：删除端点Pod和发送SIGTERM不会顺序发生，而是并行发生。并且由于Ingress不会立即收到更新的端点列表，因此来自客户端的新请求将发送到Pod，这会在Pod终止期间导致500个错误</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（我们</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻译</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了关于这个问题的更详细的资料</font><font style="vertical-align: inherit;">）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">您需要通过以下方式解决此问题：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 发送Connection的标题：关闭响应（如果它涉及HTTP应用程序）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 如果无法对代码进行更改，那么本文将介绍一种解决方案，该解决方案将允许您处理请求，直到宽限期结束为止。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理论。</font><font style="vertical-align: inherit;">NGINX和PHP-FPM如何结束进程</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx的</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们从NGINX开始，因为一切都差不多。</font><font style="vertical-align: inherit;">沉浸在该理论中，我们了解到NGINX具有一个主流程和多个“工作者”-这些是处理客户请求的子流程。</font><font style="vertical-align: inherit;">提供了一个方便的功能：使用该命令以</font></font><code>nginx -s &lt;SIGNAL&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">快速关闭方式或正常关闭方式终止进程。</font><font style="vertical-align: inherit;">显然，我们对后一种选择很感兴趣。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后一切都变得很简单：您需要向</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preStop挂钩</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">命令</font></a><font style="vertical-align: inherit;">，该</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">命令</font></a><font style="vertical-align: inherit;">将发送有关正常关机的信号。</font><font style="vertical-align: inherit;">这可以在Deployment的容器块中完成：</font></font><br>
<br>
<pre><code class="plaintext hljs">       lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /usr/sbin/nginx<font></font>
              - -s<font></font>
              - quit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，在pod在NGINX容器日志中完成其工作的时刻，我们将看到以下内容：</font></font><br>
<br>
<pre><code class="plaintext hljs">2018/01/25 13:58:31 [notice] 1#1: signal 3 (SIGQUIT) received, shutting down<font></font>
2018/01/25 13:58:31 [notice] 11#11: gracefully shutting down</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这将意味着我们需要的：NGINX等待查询完成，然后终止该过程。</font><font style="vertical-align: inherit;">但是，下面将讨论一个常见问题，因此，即使有命令，该</font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过程</font><font style="vertical-align: inherit;">也</font><font style="vertical-align: inherit;">无法正确完成。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
至此，我们已经完成了NGINX的工作：至少您可以从日志中了解到一切正常。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP-FPM呢？</font><font style="vertical-align: inherit;">如何处理正常关机？</font><font style="vertical-align: inherit;">让我们做对。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于PHP-FPM，信息少一些。</font><font style="vertical-align: inherit;">如果您专注于</font><font style="vertical-align: inherit;">PHP-FPM </font><font style="vertical-align: inherit;">的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">官方手册</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，那么它将告诉您收到了以下POSIX信号：</font></font><br>
<br>
<ol>
<li> <code>SIGINT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-快速关机；</font></font></li>
<li> <code>SIGQUIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -正常关机（我们需要什么）。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不需要此问题中的其余信号，因此，将省略对其的分析。</font><font style="vertical-align: inherit;">为了正确完成该过程，您将需要编写以下preStop挂钩：</font></font><br>
<br>
<pre><code class="plaintext hljs">        lifecycle:<font></font>
          preStop:<font></font>
            exec:<font></font>
              command:<font></font>
              - /bin/kill<font></font>
              - -SIGQUIT<font></font>
              - "1"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
乍一看，这是在两个容器中正常关闭所需要的全部。</font><font style="vertical-align: inherit;">但是，任务比看起来要复杂。</font><font style="vertical-align: inherit;">接下来，我们检查了两种情况，其中正常关机不起作用，并且在部署期间导致项目短期无法访问。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实践。</font><font style="vertical-align: inherit;">正常关机的可能问题</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx的</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，记住以下内容很有用：除了执行命令外，</font></font><code>nginx -s quit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">还应注意另一步骤。无论如何，当NGINX而不是SIGQUIT信号发送SIGTERM时，我们遇到了一个问题，由于该请求未能正确完成。例如，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以找到类似的情况</font><font style="vertical-align: inherit;">。不幸的是，我们无法确定出现此行为的具体原因：有人怀疑NGINX版本，但没有得到证实。症状是，在NGINX容器的日志中，观察到消息</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“连接5中剩下的打开的套接字＃10”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，此后容器停止了。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们可以观察到这样的问题，例如，通过所需的Ingress答案：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/sz/ip/umszip1dlpudotn2dstg17qfnzs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部署时的状态码指示器</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这种情况下，我们只能从Ingress本身获得503错误代码：由于它不再可用，它无法访问NGINX容器。</font><font style="vertical-align: inherit;">如果您使用NGINX查看容器的日志，则它们包含以下内容：</font></font><br>
<br>
<pre><code class="plaintext hljs">[alert] 13939#0: *154 open socket #3 left in connection 16<font></font>
[alert] 13939#0: *168 open socket #6 left in connection 13</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更改停止信号后，容器将开始正确停止：这已通过不再观察到503错误这一事实得到确认。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果遇到类似的问题，弄清楚在容器中使用了哪个停止信号以及preStop挂钩的外观如何是有意义的。</font><font style="vertical-align: inherit;">原因可能恰恰在于此。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM等</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
简单描述了PHP-FPM的问题：它不等待子进程完成，而是终止子进程，因此在部署和其他操作过程中会出现502个错误。自2005年以来，在bugs.php.net上已经出现了几条</font><font style="vertical-align: inherit;">描述此问题的</font><font style="vertical-align: inherit;">错误消息（例如，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。但是您可能不会在日志中看到任何内容：PHP-FPM将宣布其过程完成，而不会出现任何错误或第三方通知。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值得澄清的是，问题本身或多或少地取决于应用程序本身，例如在监视中可能不会出现。如果仍然遇到它，那么想到一个简单的解决方法：添加带有以下内容的preStop挂钩：</font></font><code>sleep(30)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。它将允许您完成之前的所有请求（由于Pod </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">处于“ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">终止”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状态</font><font style="vertical-align: inherit;">，因此</font><font style="vertical-align: inherit;">我们不接受新请求</font><font style="vertical-align: inherit;">），并且30秒钟后，pod本身将以信号结束</font></font><code>SIGTERM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事实证明，</font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于容器，它将如下所示：</font></font><br>
<br>
<pre><code class="plaintext hljs">    lifecycle:<font></font>
      preStop:<font></font>
        exec:<font></font>
          command:<font></font>
          - /bin/sleep<font></font>
          - "30"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，由于30秒的指示，</font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大大</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">延长部署时间，因为每个吊舱将终止</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">至少</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 30秒，这很糟糕。该怎么办？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们转向负责直接执行应用程序的一方。在我们的例子中，这是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">默认情况下它不监视其子进程的执行</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：主进程立即终止。可以使用伪指令更改此行为，该伪指令</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定子进程等待主机发出的信号的时间限制。如果将该值设置为20秒，则它将覆盖容器中运行的大多数请求，完成请求后，主进程将停止。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有了这些知识，我们将回到我们的最后一个问题。如前所述，Kubernetes并不是一个整体的平台：它的各个组件之间的交互需要一些时间。当我们考虑Ingress和其他相关组件的工作时尤其如此，因为由于部署时的这种延迟，很容易爆发500个错误。例如，在向上游发送请求的阶段可能会发生错误，但是组件之间交互的“时滞”相当短-不到一秒钟。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结合</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已经提到的指令</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，以下构造可用于</font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">lifecycle:<font></font>
  preStop:<font></font>
    exec:<font></font>
      command: ["/bin/bash","-c","/bin/sleep 1; kill -QUIT 1"]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这种情况下，我们补偿了团队的延迟，</font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且没有显着增加部署时间：30秒与一个之间有明显的区别吗？..本质上</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">它承担着“主要工作” </font><font style="vertical-align: inherit;">，但</font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在出现滞后时仅用作“安全网”。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般而言，所</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">描述的行为和相应的解决方法不仅涉及PHP-FPM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">使用其他语言/框架时，可能会以一种或另一种方式出现类似情况。</font><font style="vertical-align: inherit;">如果您无法通过其他方式修复正常关机（例如，重写代码以使应用程序正确处理终止信号），则可以使用上述方法。</font><font style="vertical-align: inherit;">它可能不是最漂亮的，但是可以工作。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实践。</font><font style="vertical-align: inherit;">负载测试以验证Pod性能</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
负载测试是检查容器工作方式的一种方法，因为此过程使您在用户访问站点时更接近真实的战斗条件。您可以使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Tank</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来测试以上建议</font><font style="vertical-align: inherit;">：它完全可以满足我们的所有需求。以下是通过Grafana和Yandex.Tank本身的图表进行清晰测试的技巧和窍门-我们经验的示例。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这里最重要的是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查阶段的变化。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。添加新修复程序后，运行测试，并查看结果是否与以前的启动相比有所更改。否则，将很难确定无效的解决方案，并且将来您只能造成危害（例如，增加部署时间）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另一个警告-查看容器终止期间的日志。是否在此处记录了正常关机信息？访问其他资源（例如，相邻的PHP-FPM容器）时，日志中是否存在任何错误？应用程序本身的错误（例如上述NGINX的情况）？我希望本文的介绍性信息将有助于更好地了解容器在终止期间会发生什么情况。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，第一次测试运行是在没有</font></font><code>lifecycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应用程序服务器附加指令的情况下进行的（</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在PHP-FPM中）。该测试的目的是确定错误的大概数量（以及是否完全存在）。同样，从其他信息中，应该知道每个炉床的平均展开时间约为5-10秒（完全就绪）。结果如下：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ce/yw/ap/ceywapg8q2kpztr-zdslhjy8brm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Yandex.Tank信息面板上看到502错误的飞溅，该错误在部署时发生，平均持续长达5秒钟。大概这终止了对旧Pod的现有请求。之后，出现了503个错误，这是由于NGINX容器已停止而导致的，该容器也由于后端而断开连接（因此Ingress无法与其连接）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看看如何</font></font><code>process_control_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPM中的代码将帮助我们等待子进程的完成，即 </font><font style="vertical-align: inherit;">解决此类错误。</font><font style="vertical-align: inherit;">使用此指令重复部署：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t5/8g/0c/t58g0cs5b6umhjkmvlhjktbkio0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
500s部署期间没有更多错误！</font><font style="vertical-align: inherit;">部署成功，正常关机即可。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，值得记住使用Ingress容器的那一刻，因为时滞会导致一小部分错误。</font><font style="vertical-align: inherit;">为了避免它们，仍然需要添加构造</font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并重复部署。</font><font style="vertical-align: inherit;">但是，在我们的特定情况下，看不到任何更改（再次没有错误）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了正确完成该过程，我们期望应用程序具有以下行为：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 等待几秒钟，然后停止接受新连接。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 等待所有请求完成并关闭所有不执行请求的保持连接。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 完成您的过程。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，并非所有应用程序都可以这种方式工作。</font><font style="vertical-align: inherit;">解决Kubernetes现实中的问题的一种方法是：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 添加将等待几秒钟的停止前挂钩</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 研究后端的配置文件以获取相关参数。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NGINX的示例使我们能够理解，即使是最初必须正确处理信号才能完成的应用程序也可能无法做到这一点，因此在应用程序部署期间检查500个错误至关重要。它还使您可以更广泛地看待问题，而不必专注于单独的容器或容器，而可以看待整个基础架构。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Tank可以与任何监视系统一起用作测试工具（在我们的示例中，来自Grafana的数据以Prometheus形式的后端进行了测试）。在基准测试可能产生的重负载下，正常关机的问题显而易见，监视功能有助于在测试期间或测试后更详细地分析情况。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回应对文章的反馈：值得一提的是，这里针对NGINX Ingress阐述了问题和解决方案。</font><font style="vertical-align: inherit;">对于其他情况，也许有其他解决方案，我们可能会在以下周期材料中考虑。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聚苯乙烯</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K8s提示和技巧周期中的其他内容：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NGINX Ingress中的个性化错误页面</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于节点的分配和Web应用程序上的负载</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问开发站点</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加快大型数据库的启动速度。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN489984/index.html">关于udalenka的AMA：问-我们回答</a></li>
<li><a href="../zh-CN489986/index.html">Power Stage Designer实用程序-电力电子开发人员工具</a></li>
<li><a href="../zh-CN489988/index.html">“举起双手！”：Playme TIO S dashcam单反评测</a></li>
<li><a href="../zh-CN489990/index.html">Service Desk如何拯救一家服务公司，或者如果您的业务不断增长怎么办？</a></li>
<li><a href="../zh-CN489992/index.html">纠正Kubernetes集群中的Pod关闭</a></li>
<li><a href="../zh-CN489998/index.html">11. Fortinet入门v6.0。发牌</a></li>
<li><a href="../zh-CN490002/index.html">如何在Kotlin和Micronaut上使用GraphQL并创建对多个微服务的API的单个访问点</a></li>
<li><a href="../zh-CN490006/index.html">技术规格教育计划</a></li>
<li><a href="../zh-CN490010/index.html">检查类型系统以检查音乐的正确性</a></li>
<li><a href="../zh-CN490012/index.html">存储的警报和错误，如何处理？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>