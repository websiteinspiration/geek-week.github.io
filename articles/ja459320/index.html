<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🎨 🅱️ 🐤 フレームワークとSDKのないPythonのKubernetesオペレーター 🐖 🧑🏻 ⛅️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Goは現在、人々がKubernetesのステートメントを書くことを選択するプログラミング言語の中で独占者です。次のような客観的な理由があります。
 
 

1. Go- Operator SDKでオペレーターを開発するための強力なフレームワークがあります。
2. Goは、DockerやKuberne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>フレームワークとSDKのないPythonのKubernetesオペレーター</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/459320/"><img src="https://habrastorage.org/webt/yo/3r/fn/yo3rfndq6dajcymrpuowr3esuea.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Goは現在、人々がKubernetesのステートメントを書くことを選択するプログラミング言語の中で独占者です。</font><font style="vertical-align: inherit;">次のような客観的な理由があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operator SDKでオペレーター</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を開発するための強力なフレームワークがあり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Goは、DockerやKubernetesなどの逆さまのアプリを作成しています。</font><font style="vertical-align: inherit;">Goで独自のオペレーターを作成するには-エコシステムと同じ言語を話します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Goの高性能アプリケーションと、箱から出して同時実行を操作するためのシンプルなツール。</font></font></li>
</ol><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：ちなみに、</font><font style="vertical-align: inherit;">外国の著者による翻訳の1つで、</font><font style="vertical-align: inherit;">Go </font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">独自の演算子を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記述する</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">について</font></a><font style="vertical-align: inherit;">は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">既に説明</font></a><font style="vertical-align: inherit;">しました</font><font style="vertical-align: inherit;">。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、囲碁の学習が時間の不足や、根本的にはやる気によって妨げられたらどうでしょう？</font><font style="vertical-align: inherit;">この記事では、ほとんどすべてのDevOpsエンジニアが知っている最も一般的な言語の1つである</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して、確実な演算子を作成する方法の例を示します</font><font style="vertical-align: inherit;">。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出会い：コピーライター-コピーオペレーター！</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、新しい名前空間が表示されたとき、またはConfigMapとSecretの2つのエンティティのいずれかが変更されたときに、ConfigMapをコピーするように設計された単純なオペレーターの開発を考えてみましょう。</font><font style="vertical-align: inherit;">実用的なアプリケーションの観点から見ると、オペレーターは、（ConfigMapを更新することによって）アプリケーション構成を大量に更新する場合や、シークレットデータ（Dockerレジストリを操作するためのキー（名前空間にシークレットを追加する場合）など）を更新する場合に役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、優れたオペレーターが持つべきもの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オペレーターとの対話は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタムリソース定義</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（以降、CRD）</font><font style="vertical-align: inherit;">を使用して実行され</font><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オペレーターはカスタマイズできます。</font><font style="vertical-align: inherit;">これを行うには、コマンドラインフラグと環境変数を使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DockerコンテナーとHelmチャートのアセンブリが完成し、ユーザーは簡単に（文字通り1つのコマンドで）Kubernetesクラスターにオペレーターをインストールできます。</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRD</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オペレーターがどのリソースを探し、どこを探すべきかを知るためには、オペレーターにルールを設定する必要があります。</font><font style="vertical-align: inherit;">各ルールは、単一のCRDオブジェクトとして表されます。</font><font style="vertical-align: inherit;">このCRDにはどのようなフィールドがありますか？</font></font><br>
<br>
<ol>
<li> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">探している</font><b><font style="vertical-align: inherit;">リソースのタイプ</font></b><font style="vertical-align: inherit;">（ConfigMapまたはSecret）。</font></font></li>
<li> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースを配置する</font><b><font style="vertical-align: inherit;">ネームスペースのリスト</font></b><font style="vertical-align: inherit;">。</font></font></li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セレクター</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。名前空間でリソースを検索します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CRDについて説明します。</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: apiextensions.k8s.io/v1beta1<font></font>
kind: CustomResourceDefinition<font></font>
metadata:<font></font>
  name: copyrator.flant.com<font></font>
spec:<font></font>
  group: flant.com<font></font>
  versions:<font></font>
  - name: v1<font></font>
    served: true<font></font>
    storage: true<font></font>
  scope: Namespaced<font></font>
  names:<font></font>
    plural: copyrators<font></font>
    singular: copyrator<font></font>
    kind: CopyratorRule<font></font>
    shortNames:<font></font>
    - copyr<font></font>
  validation:<font></font>
    openAPIV3Schema:<font></font>
      type: object<font></font>
      properties:<font></font>
        ruleType:<font></font>
          type: string<font></font>
        namespaces:<font></font>
          type: array<font></font>
          items:<font></font>
            type: string<font></font>
        selector:<font></font>
          type: string</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、すぐに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単純なルールを</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成</font><font style="vertical-align: inherit;">します</font><font style="vertical-align: inherit;">。次</font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の形式のラベルを持つすべてのConfigMap </font><font style="vertical-align: inherit;">の名前で名前空間を検索します</font></font><code>copyrator: "true"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: flant.com/v1<font></font>
kind: CopyratorRule<font></font>
metadata:<font></font>
  name: main-rule<font></font>
  labels:<font></font>
    module: copyrator<font></font>
ruleType: configmap<font></font>
selector:<font></font>
  copyrator: "true"<font></font>
namespace: default</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
できた！</font><font style="vertical-align: inherit;">次に、どういうわけか私たちのルールに関する情報を取得する必要があります。</font><font style="vertical-align: inherit;">クラスターサーバーAPIにリクエストを書き込まないように、すぐに予約します。</font><font style="vertical-align: inherit;">これを行うには、既成のPythonライブラリー</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kubernetes-client</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> kubernetes
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> suppress<font></font>
<font></font>
<font></font>
CRD_GROUP = <span class="hljs-string">'flant.com'</span>
CRD_VERSION = <span class="hljs-string">'v1'</span>
CRD_PLURAL = <span class="hljs-string">'copyrators'</span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_crd</span>(<span class="hljs-params">namespace, name</span>):</span><font></font>
    client = kubernetes.client.ApiClient()<font></font>
    custom_api = kubernetes.client.CustomObjectsApi(client)<font></font>
<font></font>
    <span class="hljs-keyword">with</span> suppress(kubernetes.client.api_client.ApiException):<font></font>
        crd = custom_api.get_namespaced_custom_object(<font></font>
            CRD_GROUP,<font></font>
            CRD_VERSION,<font></font>
            namespace,<font></font>
            CRD_PLURAL,<font></font>
            name,<font></font>
        )<font></font>
    <span class="hljs-keyword">return</span> {x: crd[x] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> (<span class="hljs-string">'ruleType'</span>, <span class="hljs-string">'selector'</span>, <span class="hljs-string">'namespace'</span>)}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードの結果、次の結果が得られます。</font></font><br>
<br>
<pre><code class="json hljs">{'ruleType': 'configmap', 'selector': {'copyrator': '<span class="hljs-literal">true</span>'}, 'namespace': ['default']}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すばらしい：オペレーターのルールをなんとか得ることができました。</font><font style="vertical-align: inherit;">そして最も重要なことは、Kubernetesの方法と呼ばれる方法を実行したことです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">環境変数またはフラグ？</font><font style="vertical-align: inherit;">全部取ります！</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オペレーターのメイン構成に進みます。</font><font style="vertical-align: inherit;">アプリケーションを構成するには、2つの基本的なアプローチがあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> コマンドラインオプションを使用する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 環境変数を使用します。 </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドラインオプションを使用すると、データタイプのサポートと検証により、設定をより柔軟に読み取ることができます。</font><font style="vertical-align: inherit;">Python標準ライブラリには、</font></font><code>argparser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">するモジュール</font><font style="vertical-align: inherit;">があります。</font><font style="vertical-align: inherit;">その機能の詳細と例は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式ドキュメントに記載</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">されてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、コマンドラインフラグの読み取りを設定する例は次のようになります。</font></font><br>
<br>
<pre><code class="python hljs">   parser = ArgumentParser(<font></font>
        description=<span class="hljs-string">'Copyrator - copy operator.'</span>,<font></font>
        prog=<span class="hljs-string">'copyrator'</span><font></font>
    )<font></font>
    parser.add_argument(<font></font>
        <span class="hljs-string">'--namespace'</span>,<font></font>
        type=str,<font></font>
        default=getenv(<span class="hljs-string">'NAMESPACE'</span>, <span class="hljs-string">'default'</span>),<font></font>
        help=<span class="hljs-string">'Operator Namespace'</span><font></font>
    )<font></font>
    parser.add_argument(<font></font>
        <span class="hljs-string">'--rule-name'</span>,<font></font>
        type=str,<font></font>
        default=getenv(<span class="hljs-string">'RULE_NAME'</span>, <span class="hljs-string">'main-rule'</span>),<font></font>
        help=<span class="hljs-string">'CRD Name'</span><font></font>
    )<font></font>
    args = parser.parse_args()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一方、Kubernetesで環境変数を使用すると、ポッドに関するサービス情報をコンテナに簡単に転送できます。</font><font style="vertical-align: inherit;">たとえば、次の構成でポッドが実行されている名前空間に関する情報を取得できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">env:<font></font>
- name: NAMESPACE<font></font>
  valueFrom:<font></font>
     fieldRef:<font></font>
         fieldPath: metadata.namespace </code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">演算子ロジック</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConfigMapとSecretを操作するメソッドを分離する方法を理解するために、特別なカードを使用します。</font><font style="vertical-align: inherit;">次に、オブジェクトを追跡および作成するために必要なメソッドを理解できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">LIST_TYPES_MAP = {<font></font>
    'configmap': 'list_namespaced_config_map',<font></font>
    'secret': 'list_namespaced_secret',<font></font>
}<font></font>
<font></font>
CREATE_TYPES_MAP = {<font></font>
    'configmap': 'create_namespaced_config_map',<font></font>
    'secret': 'create_namespaced_secret',<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、APIサーバーからイベントを受信する必要があります。</font><font style="vertical-align: inherit;">次のように実装します。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle</span>(<span class="hljs-params">specs</span>):</span><font></font>
    kubernetes.config.load_incluster_config()<font></font>
    v1 = kubernetes.client.CoreV1Api()<font></font>
<font></font>
    <span class="hljs-comment">#      </span>
    method = getattr(v1, LIST_TYPES_MAP[specs[<span class="hljs-string">'ruleType'</span>]])<font></font>
    func = partial(method, specs[<span class="hljs-string">'namespace'</span>])<font></font>
<font></font>
    w = kubernetes.watch.Watch()<font></font>
    <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> w.stream(func, _request_timeout=<span class="hljs-number">60</span>):<font></font>
        handle_event(v1, specs, event)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントを受け取ったら、その処理のメインロジックに進みます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#  ,    </span>
ALLOWED_EVENT_TYPES = {<span class="hljs-string">'ADDED'</span>, <span class="hljs-string">'UPDATED'</span>}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handle_event</span>(<span class="hljs-params">v1, specs, event</span>):</span>
    <span class="hljs-keyword">if</span> event[<span class="hljs-string">'type'</span>] <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> ALLOWED_EVENT_TYPES:
        <span class="hljs-keyword">return</span><font></font>
<font></font>
    object_ = event[<span class="hljs-string">'object'</span>]<font></font>
    labels = object_[<span class="hljs-string">'metadata'</span>].get(<span class="hljs-string">'labels'</span>, {})<font></font>
<font></font>
    <span class="hljs-comment">#    selector'</span>
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> specs[<span class="hljs-string">'selector'</span>].items():
        <span class="hljs-keyword">if</span> labels.get(key) != value:
            <span class="hljs-keyword">return</span>
    <span class="hljs-comment">#   namespace'</span><font></font>
    namespaces = map(<font></font>
        <span class="hljs-keyword">lambda</span> x: x.metadata.name,<font></font>
        filter(<font></font>
            <span class="hljs-keyword">lambda</span> x: x.status.phase == <span class="hljs-string">'Active'</span>,<font></font>
            v1.list_namespace().items<font></font>
        )<font></font>
    )<font></font>
    <span class="hljs-keyword">for</span> namespace <span class="hljs-keyword">in</span> namespaces:
        <span class="hljs-comment">#  ,  namespace</span>
        object_[<span class="hljs-string">'metadata'</span>] = {
            <span class="hljs-string">'labels'</span>: object_[<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'labels'</span>],
            <span class="hljs-string">'namespace'</span>: namespace,
            <span class="hljs-string">'name'</span>: object_[<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'name'</span>],<font></font>
        }<font></font>
        <span class="hljs-comment">#   / </span><font></font>
        methodcaller(<font></font>
            CREATE_TYPES_MAP[specs[<span class="hljs-string">'ruleType'</span>]],<font></font>
            namespace,<font></font>
            object_<font></font>
        )(v1)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
基本的なロジックが準備できました！</font><font style="vertical-align: inherit;">これをすべて1つのPythonパッケージにパックする必要があります。</font><font style="vertical-align: inherit;">ファイルをフォーマットし</font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、プロジェクトに関するメタ情報をそこに書き込み</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> version_info<font></font>
<font></font>
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
<span class="hljs-keyword">if</span> version_info[:<span class="hljs-number">2</span>] &lt; (<span class="hljs-number">3</span>, <span class="hljs-number">5</span>):
    <span class="hljs-keyword">raise</span> RuntimeError(
        <span class="hljs-string">'Unsupported python version %s.'</span> % <span class="hljs-string">'.'</span>.join(version_info)<font></font>
    )<font></font>
<font></font>
<font></font>
_NAME = <span class="hljs-string">'copyrator'</span><font></font>
setup(<font></font>
    name=_NAME,<font></font>
    version=<span class="hljs-string">'0.0.1'</span>,<font></font>
    packages=find_packages(),<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Development Status :: 3 - Alpha'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.5'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.6'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.7'</span>,<font></font>
    ],<font></font>
    author=<span class="hljs-string">'Flant'</span>,<font></font>
    author_email=<span class="hljs-string">'maksim.nabokikh@flant.com'</span>,<font></font>
    include_package_data=<span class="hljs-literal">True</span>,<font></font>
    install_requires=[<font></font>
        <span class="hljs-string">'kubernetes==9.0.0'</span>,<font></font>
    ],<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-string">'{0} = {0}.cli:main'</span>.format(_NAME),<font></font>
        ]<font></font>
    }<font></font>
)</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：Python用のkubernetesクライアントには、独自のバージョン管理があります。</font><font style="vertical-align: inherit;">クライアントバージョンとKubernetesバージョン間の互換性の詳細については</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、互換性マトリックス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をご覧ください</font><font style="vertical-align: inherit;">。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、プロジェクトは次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">copyrator<font></font>
├── copyrator<font></font>
│   ├── cli.py #     <font></font>
│   ├── constant.py # ,    <font></font>
│   ├── load_crd.py #   CRD<font></font>
│   └── operator.py #    <font></font>
└── setup.py #  </code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DockerとHelm</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerfileは途方もなく単純になります。基本的なpython-alpineイメージを取得して、パッケージをインストールします。</font><font style="vertical-align: inherit;">最適化はより良い時期まで延期します。</font></font><br>
<br>
<pre><code class="plaintext hljs">FROM python:3.7.3-alpine3.9<font></font>
<font></font>
ADD . /app<font></font>
<font></font>
RUN pip3 install /app<font></font>
<font></font>
ENTRYPOINT ["copyrator"]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オペレーターの配置も非常に簡単です。</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: apps/v1<font></font>
kind: Deployment<font></font>
metadata:<font></font>
  name: {{ .Chart.Name }}<font></font>
spec:<font></font>
  selector:<font></font>
    matchLabels:<font></font>
      name: {{ .Chart.Name }}<font></font>
  template:<font></font>
    metadata:<font></font>
      labels:<font></font>
        name: {{ .Chart.Name }}<font></font>
    spec:<font></font>
      containers:<font></font>
      - name: {{ .Chart.Name }}<font></font>
        image: privaterepo.yourcompany.com/copyrator:latest<font></font>
        imagePullPolicy: Always<font></font>
        args: ["--rule-type", "main-rule"]<font></font>
        env:<font></font>
        - name: NAMESPACE<font></font>
          valueFrom:<font></font>
            fieldRef:<font></font>
              fieldPath: metadata.namespace<font></font>
      serviceAccountName: {{ .Chart.Name }}-acc</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、必要な権限を持つオペレーターに適切な役割を作成する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ServiceAccount<font></font>
metadata:<font></font>
  name: {{ .Chart.Name }}-acc<font></font>
<font></font>
---<font></font>
apiVersion: rbac.authorization.k8s.io/v1beta1<font></font>
kind: ClusterRole<font></font>
metadata:<font></font>
  name: {{ .Chart.Name }}<font></font>
rules:<font></font>
  - apiGroups: [""]<font></font>
    resources: ["namespaces"]<font></font>
    verbs: ["get", "watch", "list"]<font></font>
  - apiGroups: [""]<font></font>
    resources: ["secrets", "configmaps"]<font></font>
    verbs: ["*"]<font></font>
---<font></font>
apiVersion: rbac.authorization.k8s.io/v1beta1<font></font>
kind: ClusterRoleBinding<font></font>
metadata:<font></font>
  name: {{ .Chart.Name }}<font></font>
roleRef:<font></font>
  apiGroup: rbac.authorization.k8s.io<font></font>
  kind: ClusterRole<font></font>
  name: {{ .Chart.Name }}<font></font>
subjects:<font></font>
- kind: ServiceAccount<font></font>
  name: {{ .Chart.Name }}-acc</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合計</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、恐れることなく非難し、Goを学ぶことなく、PythonでKubernetes用の独自の演算子をまとめることができました。もちろん、彼にはまだ成長の余地があります。将来的には、いくつかのルールを処理し、複数のスレッドで作業し、CRDの変更を個別に監視できるようになります... </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを詳しく調べるために、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パブリックリポジトリに配置します</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 Pythonを使用して実装されたより深刻なオペレーターの例が必要な場合は、mongodbをデプロイするための2つのオペレーター（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2番目</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）に</font><font style="vertical-align: inherit;">注意を向けることができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PSそして、Kubernetesのイベントに対処するのが面倒な場合や、Bashの使用に慣れている場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェルオペレーターの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形で既製のソリューションを用意してい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4月に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">発表</font></a><font style="vertical-align: inherit;">した）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのブログも読んでください：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes-clusterの調理は簡単で便利ですか？</font><font style="vertical-align: inherit;">アドオンオペレーターを発表</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェルオペレーターの紹介：Kubernetesのオペレーターをさらに簡単にする</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesの拡張と補完（レビューとビデオレポート）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GolangでKubernetesの演算子を作成する</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetesのオペレーター：ステートフルアプリケーションを実行する方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459310/index.html">テスト自動化ツールまたはモバイルステロイドテスター</a></li>
<li><a href="../ja459312/index.html">親愛なるアジャイル、私はふりをするのにうんざりです</a></li>
<li><a href="../ja459314/index.html">Hash Match Joinを視覚化して処理します</a></li>
<li><a href="../ja459316/index.html">Hydra 2019：最初のホールの無料放送とカンファレンスでの予定について</a></li>
<li><a href="../ja459318/index.html">TypeScriptと短いスプリント。フロントエンドインタビューバリエーションツールの作成方法</a></li>
<li><a href="../ja459322/index.html">出版社ピーター。サマーセール</a></li>
<li><a href="../ja459326/index.html">Kubernetesでの自動スケーリングとリソース管理（レビューとビデオレポート）</a></li>
<li><a href="../ja459328/index.html">クラス最高のお金の価値-Mpow A5（059）</a></li>
<li><a href="../ja459330/index.html">プログラマーとマネージャーのためのBitrix：愛と憎しみ</a></li>
<li><a href="../ja459334/index.html">YouTrack 2019.2：システム全体のバナー、タスクリストページの改善、新しい検索オプションなど</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>