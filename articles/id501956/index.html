<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🤝‍👩🏼 🐯 👨🏼‍⚕️ Pengalaman kami bekerja dengan data di etcd Kubernetes-cluster secara langsung (tanpa API K8s) 👨🏻 🐦 ✴️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Semakin sering, pelanggan meminta kami untuk memberikan akses ke kluster Kubernet untuk kemungkinan mengakses layanan di dalam kluster: agar dapat ter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pengalaman kami bekerja dengan data di etcd Kubernetes-cluster secara langsung (tanpa API K8s)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/501956/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semakin sering, pelanggan meminta kami untuk memberikan akses ke kluster Kubernet untuk kemungkinan mengakses layanan di dalam kluster: agar dapat terhubung langsung ke beberapa basis data atau layanan, untuk menghubungkan aplikasi lokal dengan aplikasi di dalam kluster ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ri/mh/du/rimhduzpzbuwtylhnil4dorhzw4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, ada kebutuhan untuk menyambungkan dari mesin lokal Anda ke layanan </font></font><code>memcached.staging.svc.cluster.local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kami memberikan kesempatan seperti itu menggunakan VPN di dalam kluster tempat klien terhubung. Untuk melakukan ini, kami mengumumkan subnet pods, layanan, dan push DNS cluster ke klien. Dengan demikian, ketika klien mencoba untuk terhubung ke layanan </font></font><code>memcached.staging.svc.cluster.local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, permintaan pergi ke DNS cluster dan sebagai tanggapannya menerima alamat layanan ini dari jaringan layanan cluster atau alamat pod.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengkonfigurasi cluster K8 menggunakan kubeadm, di mana subnet layanan secara default </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan jaringan pod </font></font><code>10.244.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Biasanya semuanya bekerja dengan baik, tetapi ada beberapa poin:</font></font><a name="habracut"></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Subnet </font></font><code>192.168.*.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sering digunakan di jaringan kantor klien, dan bahkan lebih sering di jaringan rumah pengembang. </font><font style="vertical-align: inherit;">Dan kemudian kita mendapatkan konflik: router rumah bekerja pada subnet ini dan VPN mendorong subnet ini dari cluster ke klien.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memiliki beberapa cluster (produksi, panggung, dan / atau beberapa cluster dev). </font><font style="vertical-align: inherit;">Kemudian di semua dari mereka secara default akan ada subnet yang sama untuk pod dan layanan, yang menciptakan kesulitan besar untuk bekerja dengan layanan di beberapa cluster secara bersamaan.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk beberapa waktu sekarang kami telah mengadopsi praktik menggunakan subnet yang berbeda untuk layanan dan polong dalam proyek yang sama - secara umum, sehingga semua cluster dengan jaringan yang berbeda. </font><font style="vertical-align: inherit;">Namun, ada sejumlah besar cluster yang beroperasi yang saya tidak ingin gulung dari awal, karena mereka menjalankan banyak layanan, aplikasi stateful, dll. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan kemudian kami bertanya pada diri sendiri: bagaimana saya akan mengubah subnet di cluster yang ada?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mencari keputusan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Praktik paling umum adalah membuat kembali </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semua</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> layanan dengan tipe ClusterIP. </font><font style="vertical-align: inherit;">Atau, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mereka juga dapat menyarankan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ini:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proses berikut memiliki masalah: setelah semuanya dikonfigurasi, pod muncul dengan IP lama sebagai server nama DNS di /etc/resolv.conf. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena saya masih belum menemukan solusinya, saya harus mengatur ulang seluruh cluster dengan reset kubeadm dan init lagi.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi ini tidak cocok untuk semua orang ... Berikut adalah catatan pengantar yang lebih rinci untuk kasus kami: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Digunakan oleh Flannel;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ada kelompok di awan dan di atas besi;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Saya ingin menghindari penyebaran berulang semua layanan di cluster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ada kebutuhan untuk melakukan segalanya dengan masalah minimal;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Versi Kubernetes adalah 1.16.6 (namun, tindakan lebih lanjut akan serupa untuk versi lain);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tugas utama adalah untuk </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menggantinya </font><font style="vertical-align: inherit;">dengan cluster yang digunakan menggunakan kubeadm dengan subnet layanan </font></font><code>172.24.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan kebetulan bahwa untuk waktu yang lama itu menarik bagi kami untuk melihat apa dan bagaimana di Kubernet disimpan di etcd, apa yang dapat dilakukan dengan itu sama sekali ... Jadi kami berpikir: “ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa tidak memperbarui data di etcd dengan mengganti alamat IP lama (subnet) ke yang baru</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? " </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mencari alat yang sudah jadi untuk bekerja dengan data di etcd, kami tidak menemukan apa pun yang sepenuhnya menyelesaikan tugas. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Omong-omong, jika Anda tahu tentang utilitas untuk bekerja dengan data secara langsung di etcd, kami akan berterima kasih atas </font></font></i><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">tautannya </font></a><i><font style="vertical-align: inherit;">.)</font></i><font style="vertical-align: inherit;"> Namun, </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">OpenShift </font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etcdhelper</font></font></b><font style="vertical-align: inherit;"></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menjadi titik awal yang baik </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(terima kasih kepada penulisnya!)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilitas ini dapat terhubung ke etcd menggunakan sertifikat dan membaca data dengan menggunakan perintah </font></font><code>ls</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>dump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambahkan etcdhelper</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pikiran berikut ini logis: "Apa yang mencegah untuk menambah utilitas ini, menambahkan kemampuan untuk menulis data ke etcd?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini telah diterjemahkan ke dalam versi modifikasi etcdhelper dengan dua fitur baru </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>changePodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Anda </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dapat melihat kodenya di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang dilakukan fitur baru? </font><font style="vertical-align: inherit;">Algoritma </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> buat deserializer;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kompilasi ekspresi reguler untuk menggantikan CIDR;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kami melewati semua layanan dengan tipe ClusterIP di cluster:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mendekode nilai dari etcd ke objek Go;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menggunakan ekspresi reguler, ganti dua byte pertama dari alamat;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menetapkan layanan alamat IP dari subnet baru;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> membuat serializer, mengonversi objek Go ke protobuf, menulis data baru ke etcd.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fungsinya </font></font><code>changePodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pada dasarnya sama </font></font><code>changeServiceCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- hanya alih-alih mengedit spesifikasi layanan, kami melakukannya untuk node dan mengubahnya </font></font><code>.spec.PodCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ke subnet baru.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Praktek</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubah serviceCIDR</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rencana untuk implementasi tugas sangat sederhana, tetapi melibatkan downtime pada saat penciptaan kembali semua pod di cluster. </font><font style="vertical-align: inherit;">Setelah menjelaskan langkah-langkah utama, kami juga akan membagikan pemikiran kami tentang bagaimana, secara teori, yang sederhana ini dapat diminimalisir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tindakan persiapan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menginstal perangkat lunak yang diperlukan dan memasang etcdhelper yang ditambal;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dlld cadangan dan </font></font><code>/etc/kubernetes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rencana tindakan singkat untuk mengubah serviceCIDR:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Memodifikasi manifestasi apiserver dan pengontrol-manajer</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> penerbitan kembali sertifikat;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Layanan ClusterIP berubah di etcd;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mulai ulang semua pod dalam sebuah cluster.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berikut ini adalah urutan lengkap tindakan secara terperinci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Instal etcd-client untuk dump data:</font></font><br>
<br>
<pre><code class="bash hljs">apt install etcd-client</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Kami mengumpulkan bantuan dll:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Kami menempatkan golang:</font></font><br>
<br>
<pre><code class="bash hljs">GOPATH=/root/golang<font></font>
mkdir -p <span class="hljs-variable">$GOPATH</span>/<span class="hljs-built_in">local</span>
curl -sSL https://dl.google.com/go/go1.14.1.linux-amd64.tar.gz | tar -xzvC <span class="hljs-variable">$GOPATH</span>/<span class="hljs-built_in">local</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"export GOPATH=\"<span class="hljs-variable">$GOPATH</span>\""</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export GOROOT="$GOPATH/local/go"'</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH="$PATH:$GOPATH/local/go/bin"'</span> &gt;&gt; ~/.bashrc</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menyelamatkan diri </font></font><code>etcdhelper.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, memuat dependensi, mengumpulkan:</font></font><br>
<br>
<pre><code class="bash hljs">wget https://raw.githubusercontent.com/flant/examples/master/2020/04-etcdhelper/etcdhelper.go<font></font>
go get go.etcd.io/etcd/clientv3 k8s.io/kubectl/pkg/scheme k8s.io/apimachinery/pkg/runtime<font></font>
go build -o etcdhelper etcdhelper.go</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Buat cadangan dlld:</font></font><br>
<br>
<pre><code class="bash hljs">backup_dir=/root/backup<font></font>
mkdir <span class="hljs-variable">${backup_dir}</span>
cp -rL /etc/kubernetes <span class="hljs-variable">${backup_dir}</span>
ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt --key=/etc/kubernetes/pki/etcd/server.key --cert=/etc/kubernetes/pki/etcd/server.crt --endpoints https://192.168.199.100:2379 snapshot save <span class="hljs-variable">${backup_dir}</span>/etcd.snapshot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Ubah subnet layanan di manifes kontrol Kubernetes. </font><font style="vertical-align: inherit;">Dalam file </font></font><code>/etc/kubernetes/manifests/kube-apiserver.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>/etc/kubernetes/manifests/kube-controller-manager.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ubah parameter </font></font><code>--service-cluster-ip-range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ke subnet baru: </font></font><code>172.24.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sebagai gantinya </font></font><code>192.168.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Karena kami mengubah subnet layanan yang kubeadm mengeluarkan sertifikat untuk apiserver (termasuk), mereka harus diterbitkan kembali:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mari kita lihat domain dan alamat IP mana sertifikat saat ini dikeluarkan:</font></font><br>
<br>
<pre><code class="bash hljs">openssl x509 -noout -ext subjectAltName &lt;/etc/kubernetes/pki/apiserver.crt<font></font>
X509v3 Subject Alternative Name:<font></font>
    DNS:dev-1-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:apiserver, IP Address:192.168.0.1, IP Address:10.0.0.163, IP Address:192.168.199.100</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Siapkan konfigurasi minimum untuk kubeadm:</font></font><br>
<br>
<pre><code class="bash hljs">cat kubeadm-config.yaml<font></font>
apiVersion: kubeadm.k8s.io/v1beta1<font></font>
kind: ClusterConfiguration<font></font>
networking:<font></font>
  podSubnet: <span class="hljs-string">"10.244.0.0/16"</span>
  serviceSubnet: <span class="hljs-string">"172.24.0.0/16"</span><font></font>
apiServer:<font></font>
  certSANs:<font></font>
  - <span class="hljs-string">"192.168.199.100"</span> <span class="hljs-comment"># IP-  </span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mari kita hapus crt dan kunci lama, karena tanpa ini sertifikat baru tidak akan dikeluarkan:</font></font><br>
<br>
<pre><code class="bash hljs">rm /etc/kubernetes/pki/apiserver.{key,crt}</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pasang kembali sertifikat untuk server API:</font></font><br>
<br>
<pre><code class="bash hljs">kubeadm init phase certs apiserver --config=kubeadm-config.yaml</code></pre></li>
<li> ,      :<br>
<br>
<pre><code class="bash hljs">openssl x509 -noout -ext subjectAltName &lt;/etc/kubernetes/pki/apiserver.crt<font></font>
X509v3 Subject Alternative Name:<font></font>
    DNS:kube-2-master, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:172.24.0.1, IP Address:10.0.0.163, IP Address:192.168.199.100</code></pre></li>
<li>    API-   :<br>
<br>
<pre><code class="bash hljs">docker ps | grep k8s_kube-apiserver | awk <span class="hljs-string">'{print $1}'</span> | xargs docker restart</code></pre></li>
<li>    <code>admin.conf</code>:<br>
<br>
<pre><code class="bash hljs">kubeadm alpha certs renew admin.conf</code></pre></li>
<li>    etcd:<br>
<br>
<pre><code class="bash hljs">./etcdhelper -cacert /etc/kubernetes/pki/etcd/ca.crt -cert /etc/kubernetes/pki/etcd/server.crt -key /etc/kubernetes/pki/etcd/server.key -endpoint https://127.0.0.1:2379 change-service-cidr 172.24.0.0/16 </code></pre><br>
<b>!</b>         ,      pod'  <code>/etc/resolv.conf</code>    CoreDNS (kube-dns),  kube-proxy   iptables     .         .</li>
<li>  ConfigMap'    <code>kube-system</code>:<br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubelet-config-1.16</code></pre><br>
—   <code>clusterDNS</code>   IP-  kube-dns: <code>kubectl -n kube-system get svc kube-dns</code>.<br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubeadm-config</code></pre><br>
—  <code>data.ClusterConfiguration.networking.serviceSubnet</code>   .</li>
<li>     kube-dns,    kubelet   :<br>
<br>
<pre><code class="bash hljs">kubeadm upgrade node phase kubelet-config &amp;&amp; systemctl restart kubelet</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetap memulai ulang semua pod di kluster:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get pods --no-headers=<span class="hljs-literal">true</span> --all-namespaces |sed -r <span class="hljs-string">'s/(\S+)\s+(\S+).*/kubectl --namespace \1 delete pod \2/e'</span></code></pre></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meminimalkan Downtime</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pikiran tentang cara meminimalkan downtime:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setelah mengubah manifestasi bidang kontrol, buat layanan kube-dns baru, misalnya, dengan nama </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan alamat baru </font></font><code>172.24.0.10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buat </font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di etcdhelper, yang tidak akan mengubah layanan kube-dns.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ganti alamat di semua kubelet </font></font><code>ClusterDNS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan yang baru, sementara layanan lama akan terus bekerja secara bersamaan dengan yang baru.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tunggu polong dengan aplikasi bergulir sendiri karena alasan alami, atau pada waktu yang disepakati.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hapus layanan </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan ubah </font></font><code>serviceSubnetCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk layanan kube-dns.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket ini akan meminimalkan waktu henti hingga ~ satu menit - untuk saat layanan dihapus </font></font><code>kube-dns-tmp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan subnet untuk layanan diganti </font></font><code>kube-dns</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modifikasi podNetwork</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat yang sama, kami memutuskan untuk melihat cara memodifikasi podNetwork menggunakan etcdhelper yang dihasilkan. </font><font style="vertical-align: inherit;">Urutan tindakan adalah sebagai berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kami memperbaiki konfigurasi di </font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kami memperbaiki manifes dari kube-controller-manager;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kami mengubah podCIDR langsung di etcd;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reboot semua node cluster.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang lebih lanjut tentang tindakan ini: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Ubah ConfigMap di namespace </font></font><code>kube-system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kubeadm-config</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Memperbaiki </font></font><code>data.ClusterConfiguration.networking.podSubnet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subnet baru </font></font><code>10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="bash hljs">kubectl -n kube-system edit cm kube-proxy</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- kami benar </font></font><code>data.config.conf.clusterCIDR: 10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Ubah manifes controller-manager:</font></font><br>
<br>
<pre><code class="bash hljs">vim /etc/kubernetes/manifests/kube-controller-manager.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- kami benar </font></font><code>--cluster-cidr=10.55.0.0/16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Lihatlah nilai-nilai saat ini </font></font><code>.spec.podCIDR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.spec.podCIDRs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.InternalIP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.status.addresses</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk semua node di cluster:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get no -o json | jq <span class="hljs-string">'[.items[] | {"name": .metadata.name, "podCIDR": .spec.podCIDR, "podCIDRs": .spec.podCIDRs, "InternalIP": (.status.addresses[] | select(.type == "InternalIP") | .address)}]'</span></code></pre><br>
<pre><code class="json hljs">[<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.2"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.1.239"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.222"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.244.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.244.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.4.73"</span><font></font>
  }<font></font>
]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. Ganti podCIDR dengan membuat perubahan langsung ke etcd:</font></font><br>
<br>
<pre><code class="bash hljs">./etcdhelper -cacert /etc/kubernetes/pki/etcd/ca.crt -cert /etc/kubernetes/pki/etcd/server.crt -key /etc/kubernetes/pki/etcd/server.key -endpoint https://127.0.0.1:2379 change-pod-cidr 10.55.0.0/16</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. Periksa apakah podCIDR benar-benar berubah:</font></font><br>
<br>
<pre><code class="bash hljs">kubectl get no -o json | jq <span class="hljs-string">'[.items[] | {"name": .metadata.name, "podCIDR": .spec.podCIDR, "podCIDRs": .spec.podCIDRs, "InternalIP": (.status.addresses[] | select(.type == "InternalIP") | .address)}]'</span></code></pre><br>
<pre><code class="json hljs">[<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.2"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-master"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.0.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.0.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.1.239"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"192.168.199.222"</span><font></font>
  },<font></font>
  {<font></font>
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"kube-2-worker-01f438cf-579f9fd987-5l657"</span>,
    <span class="hljs-attr">"podCIDR"</span>: <span class="hljs-string">"10.55.1.0/24"</span>,
    <span class="hljs-attr">"podCIDRs"</span>: [
      <span class="hljs-string">"10.55.1.0/24"</span><font></font>
    ],<font></font>
    <span class="hljs-attr">"InternalIP"</span>: <span class="hljs-string">"10.0.4.73"</span><font></font>
  }<font></font>
]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. Pada gilirannya, kami akan reboot semua node cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. Jika setidaknya satu node </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">meninggalkan podCIDR lama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , maka kube-controller-manager tidak akan dapat memulai, dan pod di cluster tidak akan direncanakan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bahkan, mengubah podCIDR dapat dibuat lebih mudah (misalnya, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seperti ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Tapi kami ingin belajar bagaimana bekerja dengan etcd secara langsung, karena ada kasus ketika mengedit objek Kubernetes di etcd adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">satu</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><i><font style="vertical-align: inherit;">satunya</font></i><font style="vertical-align: inherit;"> pilihan yang mungkin. </font><font style="vertical-align: inherit;">(Misalnya, Anda tidak bisa hanya mengubah bidang Layanan tanpa downtime </font></font><code>spec.clusterIP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artikel ini mempertimbangkan kemungkinan bekerja dengan data di etcd secara langsung, mis. </font><font style="vertical-align: inherit;">melewati API Kubernetes. </font><font style="vertical-align: inherit;">Terkadang pendekatan ini memungkinkan Anda untuk melakukan "hal-hal yang rumit." </font><font style="vertical-align: inherit;">Operasi yang dijelaskan dalam teks diuji pada kelompok K8 nyata. </font><font style="vertical-align: inherit;">Namun, status kesiapan mereka untuk digunakan secara luas adalah </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PoC (proof of concept)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Karena itu, jika Anda ingin menggunakan versi modifikasi dari utilitas etcdhelper pada cluster Anda, lakukan dengan risiko dan risiko Anda sendiri.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baca juga di blog kami:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etcd 3.4.3: riset penyimpanan dan keamanan keamanan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calico untuk web di Kubernetes: mengenal dan sedikit pengalaman</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 bug sistem yang menghibur dalam pengoperasian Kubernetes [dan solusi mereka]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">      Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id501938/index.html">Prometheus, jangan pergi: 6 alat pemantauan alternatif untuk Kubernetes</a></li>
<li><a href="../id501940/index.html">Sedikit tentang Neutralino.js</a></li>
<li><a href="../id501942/index.html">Metode Kanban: Memahami Proses Anda sebagai Proses Pembelajaran Kolektif</a></li>
<li><a href="../id501948/index.html">Cara kereta berjalan dari stasiun ke stasiun: fitur routing</a></li>
<li><a href="../id501954/index.html">Apakah VR menunggu Microsoft Kinect atau masa depan gaming - mari kita bicara bersama</a></li>
<li><a href="../id501960/index.html">Pencarian skala. Pencarian Elastics Kelebihan dan persyaratan dasar untuk instalasi</a></li>
<li><a href="../id501964/index.html">Untuk apa komputer industri?</a></li>
<li><a href="../id501968/index.html">Template Arsitektur MVI di Kotlin Multiplatform, Bagian 1</a></li>
<li><a href="../id501970/index.html">Apa yang Anda butuhkan untuk membuat penjara bawah tanah yang baik di RPG?</a></li>
<li><a href="../id501976/index.html">Cara belajar menguji perangkat lunak</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>