<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕘 ➖ 👨🏼‍⚕️ Transmita seus vídeos no YouTube 24 horas por dia 🧑🏿‍🤝‍🧑🏽 👴🏾 🖕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, como hobby, estou filmando palestras de um psicólogo familiar em vídeo. Montei e publico as imagens no meu site. Há um mês, tive a ideia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Transmita seus vídeos no YouTube 24 horas por dia</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493352/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recentemente, como hobby, estou filmando palestras de um psicólogo familiar em vídeo. Montei e publico as imagens no meu site. Há um mês, tive a ideia de organizar uma transmissão ininterrupta dessas palestras no YouTube 24/7. Uma espécie de "canal" temático dedicado ao crescimento pessoal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como fazer uma transmissão normal, eu sei. Mas como fazer uma transmissão de arquivos de vídeo? Que ela andava 24/7, era flexível, o mais autônoma possível e, ao mesmo tempo, não dependia do meu computador doméstico. Era isso que eu tinha que descobrir. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/vn/5u/tivn5utlpr-vmldtf9dh5hh7fku.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Demorou vários dias para encontrar uma solução. Estudei muitos fóruns e vários manuais sem os quais minha transmissão simplesmente não teria terminado. E agora, quando a brincadeira é um sucesso, sinto a necessidade de compartilhar minha decisão. Então este artigo apareceu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em resumo, a solução final foi a seguinte: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS + ffmeg + bash script</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Abaixo, descrevo os passos dados e falo sobre as "armadilhas" que foram descobertas durante a transmissão.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 1 - de onde será a transmissão?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No início, era necessário determinar onde a transmissão será conduzida, onde será sua fonte. A primeira coisa que veio à mente foi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de um computador doméstico</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Colete vídeos em uma lista de reprodução e reproduza-os em qualquer player de vídeo. Em seguida, capture a imagem da tela e transmita-a para o YouTube. Mas quase imediatamente rejeitei esta opção. Para implementá-lo, é necessário manter o computador doméstico constantemente, e esse é o ruído dos refrigeradores, mesmo à noite, e o aumento do consumo de energia (+ 100-150 kWh por mês). E acontece que você não poderá usar o computador doméstico durante a transmissão. qualquer movimento do mouse será visível na transmissão. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então comecei a olhar para os </font><b><font style="vertical-align: inherit;">serviços</font></b><font style="vertical-align: inherit;"> em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuvem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Eu estava procurando por um serviço pronto para fazer o upload de seus vídeos ou, por exemplo, inserir links para vídeos do YouTube e tudo seria compactado em uma transmissão contínua. Mas não encontrei nada adequado. Talvez eu estivesse parecendo mal. A única coisa ± adequada para a funcionalidade é restream.io, um serviço que ajuda a transmitir simultaneamente em várias plataformas. Eles parecem capazes de enviar seus vídeos. Mas esse serviço foi criado para propósitos completamente diferentes e eles esperam que a transmissão dure apenas algumas horas. Penso que se através desse serviço fosse possível organizar uma transmissão 24 horas por dia, isso teria disparado em dezenas, ou até centenas de dólares por mês. Mas eu ainda queria organizar a transmissão gratuitamente ou com um investimento financeiro mínimo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ficou claro que você precisa transmitir</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um dispositivo separado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou mesmo um computador separado. Pensando em algo como o Raspberri Pi. E o que? Ele não tem mais frio. Gravei o vídeo em uma unidade flash USB, prendi um cabo Ethernet e o deixei em algum lugar isolado, transmitindo. Opção. Mas como eu não tinha o conselho nem a experiência com ele, também recusei essa opção. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final, me deparei com uma discussão em que eles discutiram a criação de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seu próprio servidor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transmissões. Não era exatamente isso que eu estava procurando, mas peguei a idéia principal - você pode usar o servidor! Nessa discussão, eles sugeriram o uso de vários VPS + nginx + OBS. Tornou-se claro que esse bando poderia me atender. A única coisa que me confundiu foi que eu nunca administrei o servidor e me pareceu que meu servidor dedicado estava confuso e caro. Decidi descobrir quanto custaria alugar um servidor na configuração mínima e fiquei agradavelmente surpreendido.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mu/v8/ms/muv8msmvpgnhzj9z04nuhv_y0-s.jpeg" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os preços estão em rublos bielorrussos e são apenas migalhas. Para entender, 8 rublos bielorrussos estão em torno de 3,5 dólares ou 240 rublos russos. Por um mês, usando um computador completo, ligado 24 horas por dia, 7 dias por semana e com acesso rápido à Internet. Por alguma razão, essa descoberta foi muito feliz para mim e, por vários dias, andei muito satisfeito como uma criança que descobriu foguetes espaciais :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A propósito, aproveitei a oferta do primeiro site que o Google me deu a pedido de "aluguel VPS". Talvez haja ainda mais soluções orçamentárias, mas esse preço me convinha e eu não procurei mais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao criar um servidor, você pode selecionar o sistema operacional no qual ele irá operar. </font><font style="vertical-align: inherit;">Em qualquer um dos sistemas listados, você pode organizar a transmissão e fazer uma escolha com base em suas preferências e recursos financeiros (eles solicitam uma taxa adicional por um servidor com Windows). </font><font style="vertical-align: inherit;">Eu escolhi o CentOS. </font><font style="vertical-align: inherit;">Só porque eu costumava ter um pouco de experiência com ela.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cv/0a/wh/cv0awhhxim1w2fgglkrlupl5hgc.jpeg" alt="imagem"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 2 - configuração do servidor</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira coisa que você precisa depois de criar o servidor é conectar-se a ele via SSH. </font><font style="vertical-align: inherit;">Inicialmente, usei o PuTTy, mas comecei a usar o Secure Shell App, que é executado no Google Chrome. </font><font style="vertical-align: inherit;">Então acabou sendo mais conveniente para mim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então mudei o nome do host, configurei a sincronização de horário no servidor, atualizei o sistema, mexi com iptables ... e fiz várias coisas, mas não porque era necessário. </font><font style="vertical-align: inherit;">Foi interessante configurar o servidor e funcionou para mim. </font><font style="vertical-align: inherit;">Adoro quando acontece :) </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas essas etapas precisam ser feitas:</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conecte o repositório EPEL.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Levante servidor FTP (eu escolhi vsftp).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instale o ffmpeg.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não vou dar detalhes da equipe, esta instrução é bastante conceitual para transmitir um plano de ação geral. Se você tiver alguma dificuldade com alguma das etapas, elas são resolvidas rapidamente por uma consulta em um mecanismo de pesquisa como “CentOS connect EPEL” ou “CentOS FTP server installation”. E nos primeiros links, você encontra instruções detalhadas e passo a passo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então, como escrevi anteriormente, eu precisava de um monte de VPS + nginx + OBS. Pronto para VPS. Mas aqui nos pontos restantes as questões começaram a surgir. OBS é um programa de transmissão, Open Broadcaster Software. E só funciona com threads, ou seja, por exemplo, pega uma imagem de uma webcam e a transmite. Ou gravação de tela. Ou uma transmissão já em andamento é redirecionada para outro site. E eu não tenho um fluxo, só tenho um conjunto de arquivos de vídeo que preciso para fazer um fluxo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele começou a cavar nessa direção e se deparou com ffmpeg. </font><font style="vertical-align: inherit;">O FFmpeg é um conjunto de bibliotecas de código aberto gratuitas que permitem gravar, converter e transferir gravações digitais de áudio e vídeo em vários formatos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E fiquei muito surpreso com o quanto o ffmpeg pode fazer. </font><font style="vertical-align: inherit;">Se você quiser, ele retirará o som do vídeo. </font><font style="vertical-align: inherit;">Se você quiser, ele cortará um fragmento do vídeo sem transcodificação. </font><font style="vertical-align: inherit;">Se desejar, ele será convertido de um formato para outro. </font><font style="vertical-align: inherit;">E muito, muito mais. </font><font style="vertical-align: inherit;">Até o ponto em que você pode especificar um arquivo para ele, ele o converterá em um fluxo e o transferirá para o próprio YouTube. </font><font style="vertical-align: inherit;">Tudo, a corrente está montada. </font><font style="vertical-align: inherit;">Resta apenas refinar as nuances.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 3 - configuração da transmissão</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Criamos uma transmissão no YouTube. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesta fase, precisamos apenas de um link e uma chave de tradução. </font><font style="vertical-align: inherit;">Na captura de tela abaixo, eles são destacados em vermelho. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gr/a3/oo/gra3oogooafzdfjzhlqdqjjxr8o.jpeg" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carregue os arquivos de vídeo no servidor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que planejamos transmitir. </font><font style="vertical-align: inherit;">Na verdade, o FTP é necessário apenas para este estágio. </font><font style="vertical-align: inherit;">Se você tiver outra maneira conveniente de enviar arquivos para o servidor, o servidor FTP poderá ficar de fora. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nós transmitimos para o YouTube. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para começar a transmitir, você deve executar o ffmpeg com vários atributos. </font><font style="vertical-align: inherit;">Aqui está o comando mais curto que recebi:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -re -i lecture1.mp4 -f flv rtmp://a.rtmp.youtube.com/live2/%_%</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descriptografia de Atributos</font></font></b><div class="spoiler_text"><code>-re</code> – ,      .<br>
<br>
<code>-i</code> – ,    . ,       ,    -.       ,  <code>/usr/media/lecture1.mp4</code>.<br>
<br>
<code>-f</code> –    .    ,  ffmpeg « »     mp4  flv.<br>
<br>
    ,     YouTube     .. ,     ,   ,       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você fez tudo corretamente, depois de executar este comando, o YouTube verá o fluxo transmitido. </font><font style="vertical-align: inherit;">Para iniciar a transmissão, basta clicar no botão "Iniciar transmissão" no próprio YouTube.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 4 - adicione autonomia</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parabéns! Agora você sabe como começar a transmitir a partir de um arquivo de vídeo. Mas isso não é suficiente para transmissão contínua. É importante que, após a reprodução do primeiro vídeo, o próximo comece imediatamente e, quando todos os vídeos forem mostrados, a reprodução começará novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu vim com a seguinte opção: crie um arquivo .sh no qual registrei um comando para cada arquivo de vídeo e, no final, indiquei um comando para reiniciar o mesmo script. Aconteceu uma espécie de recursão:</font></font><br>
<br>
<pre><code class="bash hljs"> 1... (   lecture1.mp4)<font></font>
 2... (   lecture2.mp4)<font></font>
 3... (   lecture3.mp4)<font></font>
bash start.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E sim, funcionou. Eu, satisfeito comigo, comecei uma transmissão de teste e fui dormir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma surpresa desagradável me esperava de manhã. Aconteceu que a transmissão durou apenas alguns minutos e terminou quase imediatamente quando eu desliguei o computador. A investigação mostrou que os comandos lançados dessa maneira são executados enquanto o usuário está autorizado no servidor. Assim que eu desconectei, a execução dos comandos iniciados foi interrompida. Para impedir que isso aconteça, basta </font></font><code>bash</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adicionar a equipe </font><font style="vertical-align: inherit;">antes da </font><font style="vertical-align: inherit;">equipe </font></font><code>nohup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Isso permitirá que o processo em execução seja executado independentemente da sua presença. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A versão mínima final do script é assim:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -re -i lecture1.mp4 -f flv rtmp://a.rtmp.youtube.com/live2/%_%<font></font>
ffmpeg -re -i lecture2.mp4 -f flv rtmp://a.rtmp.youtube.com/live2/%_%<font></font>
ffmpeg -re -i lecture3.mp4 -f flv rtmp://a.rtmp.youtube.com/live2/%_%<font></font>
nohup bash start.sh $</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Onde start.sh é o arquivo no qual esse script é gravado. </font><font style="vertical-align: inherit;">E esse arquivo deve estar localizado no mesmo diretório que os arquivos de vídeo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicionar um cifrão no final permite iniciar o processo em segundo plano, para que você possa continuar usando o console sem interromper a transmissão. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dos bônus, os seguintes pães resultaram:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Você pode alternar manualmente a reprodução de arquivos. </font><font style="vertical-align: inherit;">Para fazer isso, você precisa "matar" o processo ffmpeg atualmente em execução. </font><font style="vertical-align: inherit;">Depois disso, a reprodução do próximo arquivo da lista será iniciada automaticamente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Novos vídeos podem ser adicionados à transmissão sem interromper a transmissão. </font><font style="vertical-align: inherit;">Apenas envie o vídeo para o servidor, adicione o comando para executar este arquivo no script, salve-o. </font><font style="vertical-align: inherit;">E é isso. </font><font style="vertical-align: inherit;">Na próxima rodada de reprodução, o novo arquivo já será transmitido junto com os arquivos antigos.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 5 - configurar o ffmpeg</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre isso, em princípio, alguém poderia parar. Mas eu queria tornar a transmissão um pouco mais amigável para o público. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que uma pessoa foi à transmissão, começou a assistir, gostou e quis assistir a essa palestra desde o início, e a transmissão não inclui rebobinar. Para visualizar uma palestra desde o início, uma pessoa precisará ir ao meu site e obter um registro da palestra de seu interesse. E como entender o que a palestra lhe interessa? O site tem 16 palestras e toda semana há apenas mais. Penso que nem eu, que gravei e editei todas essas palestras, poderei determinar qual é a palestra de um fragmento aleatório. Portanto, é necessário que cada palestra seja de alguma forma designada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A opção de adicionar legendas aos arquivos de vídeo de origem no programa de edição não me agradou. </font><font style="vertical-align: inherit;">Era necessário ter certeza de que os arquivos originais foram usados. </font><font style="vertical-align: inherit;">Para apoiar a transmissão exigida de mim o mínimo de movimentos corporais possível. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descobriu-se que o ffmpeg também pode me ajudar com isso. </font><font style="vertical-align: inherit;">Ele possui um atributo especial </font></font><code>-vf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que permite colocar texto em cima do vídeo. </font><font style="vertical-align: inherit;">Para adicionar texto ao vídeo, você precisa adicionar o seguinte fragmento ao comando:</font></font><br>
<br>
<pre><code class="bash hljs">-vf drawtext=<span class="hljs-string">"fontfile=OpenSans.ttf:text=' 13\:  .   ?':fontsize=26:fontcolor=white:borderw=1:bordercolor=black:x=40:y=670"</span></code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decodificação de parâmetros</font></font></b><div class="spoiler_text"><code>fontfile=</code> –    .       .          .        .<br>
<br>
<code>text=</code> – ,  ,     .<br>
<br>
<code>fontsize=</code> –    .<br>
<br>
<code>fontcolor=</code> –  .<br>
<br>
<code>borderw=</code> –       (         1 ).<br>
<br>
<code>bordercolor=</code> –  .<br>
<br>
<code>x=</code>  <code>y=</code> –  .  <code>0;0</code>     .      ,           1280720 .<br>
</div></div><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se parece com isso:</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/jf/1n/sh/jf1nshia1hbk30-pjd5y6mztga0.jpeg" alt="imagem"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapa 6 - determinar a qualidade da transmissão</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo, a transmissão está pronta. Transmissões FFmpeg, arquivos reproduzidos, minha presença não é necessária para transmissão. Até todas as palestras são assinadas. Parece que é isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas outra nuance veio à tona - eu escolhi a configuração mínima do servidor e ela não gerou a transmissão. Configuração do servidor: 1 núcleo (como 2,2 GHz), 1 gigabyte de RAM, SSD de 25 GB. Havia RAM suficiente, mas o processador quase completamente carregou 100% (e às vezes até 102-103% :) Isso levou ao fato de que a transmissão congela uma vez a cada poucos segundos. Feio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Você pode ter uma configuração mais cara com dois núcleos, o benefício é que, com as tecnologias em nuvem, a configuração do servidor é alterada pressionando alguns botões. </font><font style="vertical-align: inherit;">Mas eu queria me encaixar no poder da configuração mínima. </font><font style="vertical-align: inherit;">Comecei a estudar a documentação do ffmpeg e, sim, também existem configurações que permitem ajustar a carga no sistema.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A alta qualidade da imagem pode ser alcançada de duas maneiras: uma alta carga do processador ou um grande tráfego de saída. </font><font style="vertical-align: inherit;">Acontece que quanto mais o processador suportar a carga, menor será a largura de banda que o canal precisará. </font><font style="vertical-align: inherit;">Ou você não pode carregar muito o processador, mas precisará de um canal amplo com uma grande margem de tráfego. </font><font style="vertical-align: inherit;">Se houver restrições no processador e no tamanho do canal / tráfego de saída, será necessário reduzir a qualidade da imagem para que a transmissão ocorra sem problemas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meu servidor possui um canal de 10 Mbps. Esta largura é reta com uma margem. Mas há um limite de tráfego - 1 TB por mês. Portanto, para atender às restrições de tráfego, meu fluxo de saída não deve exceder ~ 300 Kb por segundo, ou seja, a taxa de bits do fluxo de saída não deve exceder 2,5 Mbps. A propósito, o YouTube recomenda apenas transmitir em uma taxa de bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Ffmpeg usa abordagens diferentes para regular a carga no sistema. Bem escrito sobre isso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Acabei usando dois atributos: </font></font><code>-crf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>-preset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fator de taxa constante (CRF)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- este é um coeficiente devido ao qual você pode ajustar a qualidade da imagem. </font><font style="vertical-align: inherit;">O CRF pode variar de 0 a 51, onde 0 é a qualidade do arquivo de origem, 51 é a pior qualidade possível. </font><font style="vertical-align: inherit;">É recomendável usar valores de 17 a 28, o padrão é 23. Com uma proporção de 17, o vídeo será visualmente idêntico ao original, mas tecnicamente não será. </font><font style="vertical-align: inherit;">A documentação também afirma que o tamanho do vídeo final, dependendo do CRF especificado, muda exponencialmente, ou seja, </font><font style="vertical-align: inherit;">aumentar o coeficiente em 6 pontos dobrará a taxa de bits do vídeo enviado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você estiver usando o CRF, poderá escolher o "peso" da imagem enviada e, em seguida, usar as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">predefinições (-preset)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para determinar quanto será carregado o processador. </font><font style="vertical-align: inherit;">Os parâmetros para este atributo têm o seguinte:</font></font><br>
<br>
<ul>
<li><code>ultrafast</code></li>
<li><code>superfast</code></li>
<li><code>veryfast</code></li>
<li><code>faster</code></li>
<li><code>fast</code></li>
<li><code>medium</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - valor padrão</font></font></li>
<li><code>slow</code></li>
<li><code>slower</code></li>
<li><code>veryslow</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quanto mais rápido o parâmetro for especificado, maior será a carga no processador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peguei primeiro a predefinição, que era basicamente "difícil" para o meu processador, e depois ajustei a carga com mais precisão usando CRF. </font><font style="vertical-align: inherit;">No meu caso, a predefinição surgiu </font></font><code>fast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e, para o crf, decidi pelo valor de 24.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusão</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso é tudo. </font><font style="vertical-align: inherit;">O comando final para iniciar a transmissão, recebi o seguinte:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -re -i lecture1.mp4 -vf drawtext=<span class="hljs-string">"fontfile=OpenSans.ttf:text=' 1\:   ':fontsize=26:fontcolor=white:borderw=1:bordercolor=black:x=40:y=670"</span> -c:v libx264 -preset fast -crf 24 -g 3 -f flv rtmp://a.rtmp.youtube.com/live2/%_%</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui existem apenas dois momentos não descritos: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><code>-c:v libx264</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- uma indicação de um codec específico para trabalhar com o arquivo de origem. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) </font></font><code>-g 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- uma indicação explícita do número de quadros-chave. Nesse caso, é indicado que cada terceiro quadro deve ser a chave. O valor padrão é 5 ou 8, mas o YouTube jura, pergunta pelo menos 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que qualidade da transmissão acabou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A carga do servidor foi a seguinte:</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/b5/3s/za/b53szauaywx3bdwoic-yebil1es.jpeg" alt="imagem"><br>
<br>
<img src="https://habrastorage.org/webt/cq/jc/t4/cqjct4xhbz3zabriimgydbxvjaq.jpeg" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Com base nos dados de monitoramento, é claro que a carga do processador varia de 70% a 95% e a transmissão nunca parou em 100% em uma semana. Portanto, com essas configurações, o processador é suficiente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao carregar um disco, posso dizer que ele quase não está carregado e um HDD comum deve ser suficiente para transmitir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas a quantidade de tráfego de saída me incomoda. Acontece que meu fluxo de saída varia de 450 a 650 KB por segundo. Durante um mês, serão cerca de 1,8 terabytes. Pode ser necessário comprar tráfego ou ainda mudar para uma configuração de núcleo duplo porque Eu não gostaria de reduzir a qualidade da imagem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*** </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, direi que a configuração dessa transmissão do zero leva cerca de uma a duas horas. Além disso, na maioria das vezes é necessário o upload do vídeo para o servidor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ferramenta de marketing, o lançamento de uma transmissão desse tipo não deu resultado. Talvez se você encerrar as visualizações para que os algoritmos do YouTube capturem essa transmissão e a mostrem ativamente nas recomendações, algo funcione. No meu caso, durante 16 dias de transmissão contínua, foi assistida 58 vezes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Está bem. A transmissão se encaixa harmoniosamente na página principal do meu site. Foi um tipo de oportunidade para se decidir rapidamente sobre o palestrante e as próprias palestras. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E um momento. É importante que a transmissão não viole os direitos autorais de outras pessoas, caso contrário, será bloqueada. Estou calmo para a minha transmissão. Selecionei especialmente inserções musicais com uso gratuito, e o autor do conteúdo fica em um computador vizinho e não é contra mim usar seu conteúdo :)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas se você tem um rádio tocando em segundo plano em algum lugar no fundo, ou você usou sua faixa favorita durante a edição ou gravou um vídeo de um videoclipe, série ou filme popular, sua transmissão está em risco. </font><font style="vertical-align: inherit;">Também é importante que a transmissão carregue pelo menos uma carga semântica mínima, caso contrário, poderá ser bloqueada como spam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*** </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso é tudo para mim. </font><font style="vertical-align: inherit;">Espero que este manual sirva bem a alguém. </font><font style="vertical-align: inherit;">Bem, se você tem algo a acrescentar - escreva, terei prazer em ler adições e esclarecimentos ao artigo.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt493336/index.html">Como o Centro de Ciência da Computação traduziu o aprendizado on-line</a></li>
<li><a href="../pt493340/index.html">Tornando as funções SIL portáteis entre versões no Jira</a></li>
<li><a href="../pt493342/index.html">Como o NSPK preparou a infraestrutura para a transição para udalenka</a></li>
<li><a href="../pt493346/index.html">Conseguimos transferir escritórios para udalenka, e você?</a></li>
<li><a href="../pt493348/index.html">Torne o "udalenka" ótimo novamente: como transferir toda a empresa para o trabalho remoto em 4 etapas</a></li>
<li><a href="../pt493356/index.html">Vídeo @ Meetups de Bancos de dados: DBMS Security, Tarantool na IoT, Greenplum para Big Data Analytics</a></li>
<li><a href="../pt493360/index.html">Dois dedos de Algol</a></li>
<li><a href="../pt493362/index.html">Suporte técnico "nas malas". Como trabalhamos remotamente, sem nervos desnecessários, e obtemos os serviços de que precisamos remotamente</a></li>
<li><a href="../pt493366/index.html">O que é o Windows PowerShell e o que ele come? Parte 3: passando parâmetros para scripts e funções, criando cmdlets</a></li>
<li><a href="../pt493374/index.html">Coronavírus - dicas práticas e um pouco de teoria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>