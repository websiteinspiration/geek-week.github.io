<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöë üçÅ üï¥üèæ How to scan the entire Internet üî¢ ü¶ï üàØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The entire range of IPv4 addresses is 4 billion IP addresses. This seems like a huge number, but the entire IPv4 Internet can be completely scanned fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to scan the entire Internet</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/499750/"><img src="https://habrastorage.org/webt/el/co/px/elcopxpoohabrp6fvgfwqu5rdgu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The entire range of IPv4 addresses is 4 billion IP addresses. This seems like a huge number, but the entire IPv4 Internet can be completely scanned for one TCP port </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in 40 minutes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , for example, to find all the web servers in the world or all open SSH ports. In this case, one server and a gigabit channel are enough. This is useful for research, for example, if you collect statistics on the technologies used in the world, or estimate the percentage of vulnerable services that are open to the outside. </font><b><font style="vertical-align: inherit;">Zmap</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
program</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(not to be confused with nmap) allows you to scan huge ranges of networks much faster than any scanner because of the special architecture. </font><font style="vertical-align: inherit;">In this article, we will look at an example of how to compile a list of all the web servers in the world using zmap. </font><font style="vertical-align: inherit;">Having a list of hosts with an open HTTP port, you can already use a more intelligent scanner, passing it an accurate list of targets.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is bad nmap</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For scanning small subnets, Nmap is traditionally used - a popular open source multitool with a lot of Pentester buns inside. It is well suited for scanning small ranges and selective hosts. Nmap has its own engine for writing custom scripts in lua (Nmap Script Engine) and many cool ready-made scripts. But nmap is not well suited for scanning large networks, such as millions or even billions of addresses. Such tasks will take several days or even weeks. The fact is that nmap uses the network subsystem of the operating system and a full socket is opened for each request. You can‚Äôt do without it for a full TCP connection when you need to chat with the service, for example, make a GET request to a web server. But this greatly reduces performance when fast SYN scanning is required,where the task is only to find out if the port is open.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zmap and Masscan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zmap and Masscan asynchronous scanners are more suitable for us: both work much faster, use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PF_RING</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> driver </font><font style="vertical-align: inherit;">(a socket that significantly speeds up packet capture) and randomize addresses to avoid a deadly DoS. </font><font style="vertical-align: inherit;">Unlike Nmap, they do not use system TCP / IP: the first generates bare Ethernet frames, the second uses a self-written TCP stack.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masscan is considered the fastest Internet scanner that can go through the entire IPv4 range in six minutes, but only with a few physical adapters connected in parallel, outgoing traffic with SYN packets is generated from one, and answers come to the other. In conditions of a single connection, the modified Zmap was almost one and a half times faster. These records, of course, were set on the top iron on 10 Gbit / s channels, and it will be difficult and expensive to repeat them yourself. On a much more affordable gigabit connection, Zmap also works faster than Masscan due to more efficient use of channel and CPU resources and can be completed in about 45-50 minutes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ge/fz/jb/gefzjbxxkce6p47gclddui5o-1e.png"><br>
<font color="999999"><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplified workflow of Zmap and Masscan. The outgoing traffic generator and the incoming response processor work separately</font></font></sup></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Without going into technical details, Zmap and Masscan use two entities: an outgoing traffic generator containing SYN requests and a separate incoming response processor. </font><font style="vertical-align: inherit;">The performance here is limited only by the channel width and network interface performance, namely the PPS limit (packets per second). </font><font style="vertical-align: inherit;">Therefore, the scanning process can be divided into several interfaces or even several physical hosts, if it is possible to replace Source IP with the address of the incoming packet handler.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scan Prep</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It must be borne in mind that the scanner loads the system and especially the network interfaces, utilizing the entire available channel. If you start scanning without warning the host, it will look like DDoS and you will most likely be disconnected from the network very quickly. You also need to be prepared that scanning the entire Internet will provoke a response - they will start complaining about you. That is, the host will receive a bunch of automatic letters complaining "you are scanning us." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So before starting your project it is better to prepare:</font></font><br>
<br>
<ul>
<li><b>    </b> ‚Äî             ( -     ). ,          .        .</li>
<li><b> PTR-</b> ‚Äî        ,      .   ,   ,  . ,   PTR   IP-,     , - :<br>
 <code>scanner-for-educational-project.ivan-ivanov.com</code></li>
<li><b>   User-Agent</b> ‚Äî       - HTTP-,     User-Agent,      .       ,   .</li>
<li><b>  </b> ‚Äî      ,       .     . </li>
</ul><br>
<h2>NAT,   </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important to understand that zmap generates millions of TCP requests at the same time. </font><font style="vertical-align: inherit;">If a router with NAT, a firewall with connection tracking, DDoS protection, or any other system with a stateful firewall trying to track connections is installed between the Internet and the scanning server, it will break down because it cannot digest so many connections. </font><font style="vertical-align: inherit;">Therefore, you cannot run zmap while in the NAT, for example, behind a home WiFi router.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trying Zmap</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install Zmap ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instruction</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test on something simple, see neighboring web servers from habr.com:</font></font><br>
<br>
<pre><code class="bash hljs">$ zmap -p 80 178.248.237.0/24 -B 100M -o habr.txt</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Options:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-p 80</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - TCP port 80, that is, we are only looking for HTTP servers</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">178.248.237.0/24</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the target range of addresses. </font><font style="vertical-align: inherit;">If you do not specify it, the entire Internet will be scanned.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-B 100M</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the maximum channel width used by zmap. </font><font style="vertical-align: inherit;">If this option is not specified, the entire available channel will be disposed of.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-o habr.txt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - write the results to a text file. </font><font style="vertical-align: inherit;">It will get the addresses that answered the request, that is, on which there is an HTTP server</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/at/ip/r7/atipr7puts2n4o9n0ravsjti4s0.png"><br>
<font color="999999"><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scanning 254 addresses with zmap took a few seconds</font></font></sup></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zmap output formats</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, zmap simply adds the found addresses to a text file, separating them with line breaks. </font><font style="vertical-align: inherit;">But it can also write results in json and xml format. </font><font style="vertical-align: inherit;">The option </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--output-fields</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows you to specify additional fields that will be added to the output. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try for example a more advanced output format in json, indicating the port on which the response request and the TTL of the packet came:</font></font><br>
<br>
<pre><code class="bash hljs">$ zmap -p80  --output-module=json --output-fields=ttl,sport,dport,saddr 178.248.237.68 -o habr.com.json<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
$ cat habr.com.json<font></font>
{ <span class="hljs-string">"ttl"</span>: 58, <span class="hljs-string">"sport"</span>: 80, <span class="hljs-string">"dport"</span>: 51309, <span class="hljs-string">"saddr"</span>: <span class="hljs-string">"178.248.237.68"</span> }
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scan the entire Internet!</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I tried to run a scan on VPS, and after a few minutes I was banned with the requirement to check the server for viruses. </font><font style="vertical-align: inherit;">This is quite logical, because such a scan looks like DDoS from the host. </font><font style="vertical-align: inherit;">But after discussing my task with support, I was offered to take a dedicated server and scan on it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is how scanning on the 200Mbit / s interface looks like, the predicted time is about six hours: </font></font><br>
<img src="https://habrastorage.org/webt/-d/no/k2/-dnok2gjfb79j9svvcocytliin8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even with a channel of 100 Mbit / s, the entire Internet can be scanned overnight.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What to do next</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can tell how many world addresses are listening on port 80 and collect a list of them. </font><font style="vertical-align: inherit;">It can be sent to the L7 scanner to analyze the application layer for vulnerabilities. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, get the HTML Title of all web servers in the world using nmap. </font><font style="vertical-align: inherit;">To the nmap input, we transfer the file received from zmap in the usual format:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ nmap -sV -p 80 -v -n  --script http-title  -iL habr.txt<font></font>
</code></pre><br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499732/index.html">Blockchain development for industry on Go. Part 1</a></li>
<li><a href="../en499736/index.html">What is taught at the Master of Software Engineering in St. Petersburg HSE</a></li>
<li><a href="../en499740/index.html">"Leak" of a base of specialists Habr Careers</a></li>
<li><a href="../en499742/index.html">Denial of Service Type: How DDoS is Progressing</a></li>
<li><a href="../en499744/index.html">Cloud Security Alarm Security Hub</a></li>
<li><a href="../en499752/index.html">When will everyone ride electric cars?</a></li>
<li><a href="../en499754/index.html">Frozen city streets in emergency mode: it's time to revive the city from the designer</a></li>
<li><a href="../en499756/index.html">In how many seconds should a website load in 2020, what is ‚Äúfast‚Äù, and where does the mirrors in elevators have to do with it?</a></li>
<li><a href="../en499758/index.html">Convenient architectural patterns</a></li>
<li><a href="../en499762/index.html">Upgrade your skills in DevSecOps: 5 webinars with theory and practice</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>