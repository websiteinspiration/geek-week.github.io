<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏳️ ❌ 🎁 DBA: auf der Suche nach fliegenden Schleusen 👎🏻 🌷 👊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In einem früheren Artikel, in dem ich über die Überwachung einer PostgreSQL-Datenbank sprach , gab es einen solchen Satz:
 Wachsen wait- Die Anwendung...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: auf der Suche nach fliegenden Schleusen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/503680/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In einem früheren Artikel, in dem ich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">über die Überwachung einer PostgreSQL-Datenbank sprach</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , gab es einen solchen Satz:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wachsen </font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Die Anwendung hat sich </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf den Sperren einer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Person </font><b><font style="vertical-align: inherit;">"ausgeruht"</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wenn dies eine vergangene einmalige Anomalie ist - eine Gelegenheit, den ursprünglichen Grund zu verstehen.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diese Situation ist eine der unangenehmsten für den DBA:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auf den ersten Blick funktioniert die Basis</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es sind keine Serverressourcen erschöpft</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... aber einige der Anfragen "verlangsamen"</font></font></li>
</ul><img src="https://habrastorage.org/webt/jy/wa/sk/jywaskrftah-9f7d9xwp3jvkn_q.png" align="right"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Chancen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, die Sperren "im Moment" zu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erwischen, </font><b><font style="vertical-align: inherit;">sind</font></b><font style="vertical-align: inherit;"> äußerst gering und können nur wenige Sekunden dauern, verschlechtern jedoch die geplante Ausführungszeit der Anforderung um das Zehnfache. </font><font style="vertical-align: inherit;">Sie möchten jedoch nicht sitzen und verfolgen, was online passiert, sondern in einer ruhigen Umgebung herausfinden, </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">welcher der Entwickler</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> genau das Problem </font><s><font style="vertical-align: inherit;">bestraft</font></s><font style="vertical-align: inherit;"> hat - wer, mit wem und aufgrund welcher Ressource der Datenbank in Konflikt geraten ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber wie? </font><font style="vertical-align: inherit;">Im Gegensatz zu der Anfrage mit ihrem Plan, mit der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie im Detail verstehen können,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wie die Ressourcen waren und wie lange es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gedauert hat, hinterlässt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> das </font><b><font style="vertical-align: inherit;">Schloss keine</font></b><font style="vertical-align: inherit;"> so </font><b><font style="vertical-align: inherit;">offensichtlichen Spuren</font></b><font style="vertical-align: inherit;"> ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es </font><font style="vertical-align: inherit;">sei </font><font style="vertical-align: inherit;">denn, es handelt sich um einen kurzen Protokolleintrag: </font><font style="vertical-align: inherit;">Aber versuchen wir, ihn zu fangen!</font></font><code><blockquote>process ... <b>still waiting for</b> ...</blockquote></code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir fangen das Schloss im Protokoll</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber damit mindestens diese Zeile im Protokoll angezeigt wird, muss der Server korrekt konfiguriert sein:</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">log_lock_waits</a> = <b>'on'</b></code></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... und legen Sie eine Mindestgrenze für unsere Analyse fest:</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">deadlock_timeout</a> = <b>'100ms'</b></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der Parameter aktiviert ist </font></font><code>log_lock_waits</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, bestimmt dieser Parameter auch, nach welcher Zeit Nachrichten über das Warten auf das Blockieren in das Serverprotokoll geschrieben werden. </font><font style="vertical-align: inherit;">Wenn Sie versuchen, die durch Sperren verursachten Verzögerungen zu untersuchen, ist es sinnvoll, sie im Vergleich zum üblichen Wert zu reduzieren </font></font><code>deadlock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alle Deadlocks, die während dieser Zeit keine Zeit zum "Lösen" haben, werden zerrissen. </font><font style="vertical-align: inherit;">Und hier sind die „üblichen“ Sperren, die von mehreren Einträgen in das Protokoll eingegeben werden:</font></font><br>
<blockquote><i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> still waiting for ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 100.047 ms</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest DETAIL: <b>Process holding the lock: 38154. Wait queue: <font color="red">38162</font>.</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest CONTEXT: SQL statement <code>"SELECT pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer )"<br>
 PL/pgSQL function inline_code_block line 2 at PERFORM</code><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest STATEMENT: <code> DO $$ BEGIN<br>
 PERFORM pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer );<br>
 EXCEPTION<br>
 WHEN query_canceled THEN RETURN;<br>
 END; $$;</code><br>
…<br>
<br>
<i>2019-03-27 00:06:46.077</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> <font color="green">acquired</font> ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 150.741 ms</b></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dieses Beispiel zeigt, dass wir </font><font style="vertical-align: inherit;">vom Erscheinen der Sperre im Protokoll bis zum Zeitpunkt ihrer Auflösung </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nur 50 ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Zeit hatten. </font><font style="vertical-align: inherit;">Nur in diesem Intervall können wir zumindest einige Informationen darüber erhalten, und je schneller wir dies tun können, desto mehr Sperren können wir analysieren. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier ist die wichtigste Information für uns die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PID des Prozesses</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , der auf die Sperre wartet. </font><font style="vertical-align: inherit;">Darauf können wir Informationen zwischen dem Protokoll und dem Status der Datenbank vergleichen. </font><font style="vertical-align: inherit;">Und gleichzeitig herauszufinden, wie problematisch ein bestimmtes Schloss war - das heißt, wie lange es "hing". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dazu benötigen wir nur ein paar RegExp im Inhaltsdatensatz </font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> RE_lock_detect = <span class="hljs-regexp">/^process (\d+) still waiting for (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> RE_lock_acquire = <span class="hljs-regexp">/^process (\d+) acquired (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//   </span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir kommen zum Protokoll</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eigentlich bleibt es ein wenig - das Protokoll zu nehmen, zu lernen, wie man es überwacht und entsprechend reagiert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben bereits alles dafür - einen Online-Protokollparser und eine voraktivierte Datenbankverbindung, über die ich in einem Artikel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">über unser PostgreSQL-Überwachungssystem gesprochen habe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<img src="https://habrastorage.org/webt/tc/pv/oq/tcpvoqmeliadskfh2rpnffg7uwo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie jedoch kein ähnliches System bereitgestellt haben, ist es in Ordnung, wir werden alles tun "Direkt von der Konsole"! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die installierte Version von PostgreSQL 10 und höher Glück hat, weil dort die Funktion </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_current_logfile () angezeigt wurde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die explizit den Namen der aktuellen Protokolldatei </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">angibt</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es wird einfach genug sein, es von der Konsole zu bekommen:</font></font><br>
<br>
<pre><code class="bash hljs">psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) &lt;&gt; '/' THEN current_setting('data_directory') ELSE '' END || '/' || pg_current_logfile()"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Version plötzlich jünger ist, wird sich alles herausstellen, aber etwas komplizierter:</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir </font></font><code>tail -f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erhalten den </font><font style="vertical-align: inherit;">vollständigen Dateinamen, den wir eingeben </font><font style="vertical-align: inherit;">und der dort angezeigt wird </font></font><code>'still waiting for'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, sobald etwas in diesem Thread aufgetaucht ist, rufen wir ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyseanforderung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider ist das Objekt des Blockierens im Protokoll keineswegs immer die Ressource, die den Konflikt verursacht hat. </font><font style="vertical-align: inherit;">Wenn Sie beispielsweise versuchen, parallel einen gleichnamigen Index zu erstellen, enthält das Protokoll nur so etwas </font></font><code>still waiting for ExclusiveLock on transaction 12345</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher müssen wir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den Status aller Sperren</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für den für uns interessanten Prozess </font><b><font style="vertical-align: inherit;">aus der Datenbank entfernen</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Und Informationen nur über zwei Prozesse (wer die Sperre aktiviert hat / wer sie erwartet) reichen nicht aus, da häufig eine „Kette“ von Erwartungen an unterschiedliche Ressourcen zwischen Transaktionen besteht:</font></font><br>
<br>
<pre><code class="plaintext hljs">tx1 [resA] -&gt; tx2 [resA]<font></font>
tx2 [resB] -&gt; tx3 [resB]<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klassiker: „Großvater für Rübe, Großmutter für Großvater, Enkelin für Großmutter, ...“ </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher werden wir eine Anfrage schreiben, die uns genau sagt, wer die Hauptursache für Probleme entlang der gesamten Schleusenkette für eine bestimmte PID wurde:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> lm <span class="hljs-keyword">AS</span> (
<span class="hljs-comment">-- lock modes</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    rn<font></font>
  , <span class="hljs-keyword">CASE</span>
      <span class="hljs-keyword">WHEN</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">THEN</span> row_number() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rn)
    <span class="hljs-keyword">END</span> rx<font></font>
  , lm || <span class="hljs-string">'Lock'</span> lm
  <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
      row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
    , lm<font></font>
    <span class="hljs-keyword">FROM</span>
      <span class="hljs-keyword">unnest</span>(
        <span class="hljs-built_in">ARRAY</span>[
          <span class="hljs-string">'AccessShare'</span>
        , <span class="hljs-string">'RowShare'</span>
        , <span class="hljs-string">'RowExclusive'</span>
        , <span class="hljs-string">'ShareUpdateExclusive'</span>
        , <span class="hljs-string">'Share'</span>
        , <span class="hljs-string">'ShareRowExclusive'</span>
        , <span class="hljs-string">'Exclusive'</span>
        , <span class="hljs-string">'AccessExclusive'</span><font></font>
        ]<font></font>
      ) T(lm)<font></font>
  ) T<font></font>
)<font></font>
<span class="hljs-comment">-- lock types</span>
, lt <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
  , lt<font></font>
  <span class="hljs-keyword">FROM</span>
    <span class="hljs-keyword">unnest</span>(
      <span class="hljs-built_in">ARRAY</span>[
        <span class="hljs-string">'relation'</span>
      , <span class="hljs-string">'extend'</span>
      , <span class="hljs-string">'page'</span>
      , <span class="hljs-string">'tuple'</span>
      , <span class="hljs-string">'transactionid'</span>
      , <span class="hljs-string">'virtualxid'</span>
      , <span class="hljs-string">'object'</span>
      , <span class="hljs-string">'userlock'</span>
      , <span class="hljs-string">'advisory'</span>
      , <span class="hljs-string">''</span><font></font>
      ]<font></font>
    ) T(lt)<font></font>
)<font></font>
<span class="hljs-comment">-- lock modes conflicts</span>
, lmx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    lr.rn lrn<font></font>
  , lr.rx lrx<font></font>
  , lr.lm lr<font></font>
  , ld.rn ldn<font></font>
  , ld.rx ldx<font></font>
  , ld.lm ld<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    lm lr<font></font>
  <span class="hljs-keyword">JOIN</span>
    lm ld <span class="hljs-keyword">ON</span>
      ld.rx &gt; (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rx) <span class="hljs-keyword">FROM</span> lm) - lr.rx <span class="hljs-keyword">OR</span><font></font>
      (<font></font>
        (lr.rx = ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
        (lr.rx, ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span>
        ld.rn &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rn) <span class="hljs-keyword">FROM</span> lm) - lr.rn<font></font>
      )<font></font>
)<font></font>
<span class="hljs-comment">-- locked targets/pids</span>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
    (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) target<font></font>
  , ld.pid  ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid  lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks ld<font></font>
  <span class="hljs-keyword">JOIN</span>
    pg_locks lr <span class="hljs-keyword">ON</span>
      lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
      (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (ld.locktype, ld.database, ld.relation, ld.page, ld.tuple, ld.virtualxid, ld.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, ld.classid, ld.objid, ld.objsubid) <span class="hljs-keyword">AND</span>
      (lr.granted, ld.granted) = (<span class="hljs-literal">TRUE</span>, <span class="hljs-literal">FALSE</span>)
  <span class="hljs-keyword">JOIN</span>
    lmx <span class="hljs-keyword">ON</span><font></font>
      (lmx.lr, lmx.ld) = (lr.mode, ld.mode)<font></font>
  <span class="hljs-keyword">WHERE</span>
    (ld.pid, ld.granted) = ($<span class="hljs-number">1</span>::<span class="hljs-built_in">integer</span>, <span class="hljs-literal">FALSE</span>) <span class="hljs-comment">-- PID</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span>          <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span>         <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span>    <span class="hljs-keyword">THEN</span> regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-string">"locked"</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, (lc.locktype, lc.database, lc.relation, lc.page, lc.tuple, lc.virtualxid, lc.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lc.classid, lc.objid, lc.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-string">"conflict"</span>
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span>
  pg_locks lc <span class="hljs-keyword">ON</span>
    lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem Nr. 1 - Langsamer Start</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie im Beispiel aus dem Protokoll sehen können, befinden sich neben der Zeile, die das Auftreten einer Sperre ( </font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">signalisiert </font><font style="vertical-align: inherit;">, drei weitere Zeilen ( </font></font><code>DETAIL, CONTEXT, STATEMENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), die erweiterte Informationen melden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst haben wir auf die Bildung eines vollständigen „Pakets“ aller 4 Einträge gewartet und uns danach der Datenbank zugewandt. </font><font style="vertical-align: inherit;">Wir können die Bildung des Pakets jedoch erst abschließen, wenn der nächste (bereits fünfte!) Datensatz mit den Details eines anderen Prozesses oder nach Zeitüberschreitung eintrifft. </font><font style="vertical-align: inherit;">Es ist klar, dass beide Optionen unnötiges Warten hervorrufen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um diese Verzögerungen zu beseitigen, haben wir auf die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stream-Verarbeitung</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> von Sperrdatensätzen </font><font style="vertical-align: inherit;">umgestellt </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Das heißt, wir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uns jetzt </font><b><font style="vertical-align: inherit;">der Zieldatenbank</font></b><font style="vertical-align: inherit;"> zu, sobald wir den ersten Datensatz sortiert haben, und stellen fest, dass es sich um die dort beschriebene Sperre handelt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem Nr. 2 - langsame Anfrage</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Einige der Schlösser hatten jedoch keine Zeit, analysiert zu werden. </font><font style="vertical-align: inherit;">Sie begannen tiefer zu graben - und fanden heraus, dass auf einigen Servern unsere </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyseanforderung für 15-20 ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausgeführt </font><b><font style="vertical-align: inherit;">wird</font></b><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Grund stellte sich als alltäglich heraus - die Gesamtzahl der aktiven Sperren auf der Basis erreichte mehrere Tausend:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/sp/ex/lkspexwtgdfrqhmh3siwsnx_s30.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hierbei ist zu beachten, dass Sperren in PostgreSQL nirgendwo „gespeichert“ werden, sondern nur in der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Systemansicht pg_locks dargestellt werden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die die Funktion direkt widerspiegelt </font></font><code>pg_lock_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Und in unserer Anfrage </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lesen wir dreimal daraus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">In der Zwischenzeit lesen wir diese Tausenden von Sperrinstanzen und verwerfen diejenigen, die nicht mit unserer PID zusammenhängen. Die Sperre selbst konnte "aufgelöst" werden. Die </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lösung bestand darin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, den Status von pg_locks im CTE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu </font><b><font style="vertical-align: inherit;">"materialisieren". Danach</font></b><font style="vertical-align: inherit;"> können Sie ihn so oft durchlaufen, wie Sie </font><b><font style="vertical-align: inherit;">möchten</font></b><font style="vertical-align: inherit;"> ändert sich nicht. </font><font style="vertical-align: inherit;">Darüber hinaus war es nach dem Sitzen auf dem Algorithmus möglich, alles auf nur zwei seiner Scans zu reduzieren.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Übermäßige Dynamik</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und wenn auch ein wenig genauerer Blick auf der Abfrage oben, können wir sehen , </font><font style="vertical-align: inherit;">dass der CTE </font></font><code>lm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>lmx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht in irgendeiner Weise auf die Daten gebunden, sondern einfach berechnet immer die gleiche „statische“ Matrix Definition des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konflikts zwischen dem </font><font style="vertical-align: inherit;">Modi blockiert</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Stellen wir es also einfach als Qualität ein </font></font><code>VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem Nr. 3 - Nachbarn</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber ein Teil der Schlösser wurde immer noch übersprungen. Normalerweise geschah dies nach dem folgenden Schema: Jemand blockierte eine beliebte Ressource, und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mehrere Prozesse</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> liefen schnell und schnell darauf oder entlang einer Kette weiter </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen haben wir die erste PID abgefangen, sind zur Zielbasis gegangen (und um sie nicht zu überlasten, behalten wir nur eine Verbindung bei), haben die Analyse durchgeführt, mit dem Ergebnis zurückgegeben, die nächste PID genommen ... Aber das Leben an der Basis ist es nicht wert, und die PID-Sperre # 2 ist schon weg! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum müssen wir eigentlich für jede PID separat in die Datenbank gehen, wenn wir die Sperren immer noch aus der allgemeinen Liste in der Anforderung filtern? Nehmen wir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sofort die gesamte Liste der in Konflikt stehenden Prozesse direkt aus der Datenbank</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und verteilen ihre Sperren auf alle PIDs, die während der Ausführung der Anforderung in das Protokoll aufgenommen wurden:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> lm(ld, lr) <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'AccessShareLock'</span>, <span class="hljs-string">'{AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowShareLock'</span>, <span class="hljs-string">'{ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowExclusiveLock'</span>, <span class="hljs-string">'{ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareUpdateExclusiveLock'</span>, <span class="hljs-string">'{ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareRowExclusiveLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ExclusiveLock'</span>, <span class="hljs-string">'{RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'AccessExclusiveLock'</span>, <span class="hljs-string">'{AccessShareLock,RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
)<font></font>
, locks <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    (<font></font>
      locktype<font></font>
    , <span class="hljs-keyword">database</span><font></font>
    , relation<font></font>
    , page<font></font>
    , tuple<font></font>
    , virtualxid<font></font>
    , transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span><font></font>
    , classid<font></font>
    , objid<font></font>
    , objsubid<font></font>
    ) target<font></font>
  , *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks<font></font>
)<font></font>
, ld <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> granted<font></font>
)<font></font>
, lr <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    target::<span class="hljs-built_in">text</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
        target::<span class="hljs-built_in">text</span>
      <span class="hljs-keyword">FROM</span><font></font>
        ld<font></font>
    )) <span class="hljs-keyword">AND</span><font></font>
    granted<font></font>
)<font></font>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span><font></font>
    lr.target<font></font>
  , ld.pid ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    ld<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    lr<font></font>
      <span class="hljs-keyword">ON</span> lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
        lr.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> ld.target<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span> <span class="hljs-keyword">THEN</span>
      regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-keyword">as</span> <span class="hljs-keyword">locked</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, lc.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-keyword">as</span> conflict
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span><font></font>
  locks lc<font></font>
    <span class="hljs-keyword">ON</span> lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt haben wir Zeit, auch die Sperren zu analysieren, die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nur 1-2 ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nach dem Eintritt in das Protokoll existieren.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analysiere das</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum haben wir es eigentlich so lange versucht? </font><font style="vertical-align: inherit;">Was bringt uns das?</font></font><br>
<br>
<pre><code class="plaintext hljs">type     | target                  | locked | pid    | mode        | granted | conflict<font></font>
---------------------------------------------------------------------------------------<font></font>
relation | {225388639}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {423576026}             | f      | 216547 | AccessShare | t       | f<font></font>
advisory | {225386226,194303167,2} | t      |  24964 | Exclusive   | f       | t<font></font>
relation | {341894815}             | t      |  24964 | AccessShare | t       | f<font></font>
relation | {416441672}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {225964322}             | f      | 216547 | AccessShare | t       | f<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser </font><b><font style="vertical-align: inherit;">Tabelle</font></b><font style="vertical-align: inherit;"> sind Werte </font></font><code>target</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit einem Typ </font><font style="vertical-align: inherit;">für uns nützlich </font></font><code>relation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, da jeder dieser Werte eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OID einer Tabelle oder eines Index ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jetzt bleibt nur noch sehr wenig zu lernen, wie man die Datenbank nach uns noch unbekannten OIDs abfragt, um sie in eine für Menschen lesbare Form zu übersetzen:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> $<span class="hljs-number">1</span>::<span class="hljs-keyword">oid</span>::regclass;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn wir </font><font style="vertical-align: inherit;">
nun die vollständige „Matrix“ der Sperren und alle Objekte kennen, denen sie von jeder Transaktion überlagert wurden, können wir </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schließen, „was überhaupt passiert ist“</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und welche Ressource den Konflikt verursacht hat, selbst wenn die Anforderung blockiert wurde, waren wir unbekannt. </font><font style="vertical-align: inherit;">Dies kann beispielsweise leicht passieren, wenn die Ausführungszeit einer Blockierungsanforderung nicht lang genug ist, um zum Protokoll zu gelangen, die Transaktion jedoch nach Abschluss aktiv war und lange Zeit Probleme verursachte. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4m/4m/j7/4m4mj7nqgpeoxe13qoldzrmhhr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber darüber - in einem anderen Artikel.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Ganz von alleine"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Zwischenzeit werden wir die Vollversion von "Überwachung" sammeln, die automatisch den Status der Sperren für unser Archiv entfernt, sobald etwas Verdächtiges im Protokoll erscheint:</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span> \<font></font>
  | xargs -l -I{} tail -f {} \<font></font>
  | stdbuf -o0 grep <span class="hljs-string">'still waiting for'</span> \<font></font>
  | xargs -l -I{} date <span class="hljs-string">'+%Y%m%d-%H%M%S.%N'</span> \<font></font>
  | xargs -l -I{} psql -U postgres postgres -f detect-lock.sql -o {}-lock.log<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und als nächstes </font></font><code>detect-lock.sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die letzte Anfrage stellen. </font><font style="vertical-align: inherit;">Ausführen - und eine Reihe von Dateien mit dem gewünschten Inhalt abrufen:</font></font><br>
<br>
<pre><code class="plaintext hljs"># cat 20200526-181433.331839375-lock.log<font></font>
     type      |     target     | locked |  pid   |     mode     | granted | conflict<font></font>
---------------+----------------+--------+--------+--------------+---------+----------<font></font>
 relation      | {279588430}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | t      | 136325 | RowExclusive | t       | f<font></font>
 virtualxid    | {110,12171420} | t      | 136325 | Exclusive    | t       | f<font></font>
 relation      | {279588430}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | f      |  39339 | RowExclusive | t       | f<font></font>
 virtualxid    | {360,11744113} | f      |  39339 | Exclusive    | t       | f<font></font>
 virtualxid    | {638,4806358}  | t      |  80553 | Exclusive    | t       | f<font></font>
 advisory      | {1,1,2}        | t      |  80553 | Exclusive    | f       | t<font></font>
 advisory      | {1,1,2}        | f      |  80258 | Exclusive    | t       | t<font></font>
 transactionid | {3852607686}   | t      | 136325 | Exclusive    | t       | f<font></font>
 extend        | {279588422}    | t      | 136325 | Exclusive    | f       | t<font></font>
 extend        | {279588422}    | f      |  39339 | Exclusive    | t       | t<font></font>
 transactionid | {3852607712}   | f      |  39339 | Exclusive    | t       | f<font></font>
(15 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na dann - setzen Sie sich und analysieren Sie ...</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de503668/index.html">Kreis im Quadrat: Visuelle Beweise</a></li>
<li><a href="../de503670/index.html">Verlangsamt sich Mac OS? - Catalina überprüft beim Start nicht signierten Code über das Internet</a></li>
<li><a href="../de503672/index.html">Auf welcher Seite befinden Sie sich: Push and Pull in der gewünschten Statuskonfiguration</a></li>
<li><a href="../de503676/index.html">Drei Geek-Projekte für den Geek Pride Day</a></li>
<li><a href="../de503678/index.html">Vuex unterbricht die Kapselung</a></li>
<li><a href="../de503682/index.html">Snom Exchange von A bis Z.</a></li>
<li><a href="../de503688/index.html">Joel Spolsky: Was bedeutet es, ein Softwareentwickler zu sein (Vorwort zu Coder to Developer)</a></li>
<li><a href="../de503690/index.html">Best Practices von Kubernetes. Kubernetes Zero Downtime Cluster Upgrade</a></li>
<li><a href="../de503696/index.html">Kriegsausrüstung: Als mechanische analoge Computer das Meer beherrschten</a></li>
<li><a href="../de503698/index.html">Remote Accounting - als Geschäftsvorteil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>