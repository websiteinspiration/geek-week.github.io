<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèª üëêüèΩ üí± Distributed transactions for heterogeneous databases in MS .NET üîò üôáüèΩ ü§öüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, in an interview I was asked if I worked with distributed transactions, in the sense that I had to do the insertion / update of such records,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Distributed transactions for heterogeneous databases in MS .NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491294/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recently, in an interview I was asked if I worked with distributed transactions, in the sense that I had to do the insertion / update of such records, provided:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Single transaction.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It can be several various databases such as Oracle, MS SQL Server and PostgreSQL.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The response to a CRUD operation can be significant.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The insertion sequence is not important.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What did colleagues achieve by asking this question? Check my experience or get a ready-made solution? Actually it‚Äôs not important for me, but what‚Äôs important - the problem in the theory of the question seemed interesting to me, and I decided to write an article on how this problem could be solved.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before I describe my solution, let's recall how a typical distributed transaction is implemented using the Microsoft platform as an example. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option number 1. C ++ application and ODBC driver (owned by Microsoft Distributed Transaction Coordinator (MSDTC) for SQL Server)</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Microsoft Distributed Transaction Coordinator (MSDTC) allows applications to expand or distribute transactions across two or more instances of SQL Server. A distributed transaction works even if two instances are located on different computers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MSDTC only works locally for Microsoft SQL Server and is not available for the Microsoft Azure SQL cloud database service.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MSDTC is called by the SQL Server Native Client Driver for Open Database Connectivity (ODBC) when your C ++ program manages a distributed transaction. The native client ODBC driver has an XA Open Distributed Transaction Processing (DTP) compliant transaction manager. This compliance is required by MSDTC. Typically, all transaction management commands are sent through this ODBC driver for the native client. The sequence is as follows: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An ODBC application for a native C ++ client starts a transaction by invoking SQLSetConnectAttr with auto-commit disabled. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The application updates some data on SQL Server X on computer A. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font><font style="vertical-align: inherit;">application updates some data on SQL Server X </font><font style="vertical-align: inherit;">on computer B.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the update fails on SQL Server Y, all uncommitted updates in both instances of SQL Server are rolled back. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, the application completes the transaction by calling SQLEndTran (1) with the SQL_COMMIT or SQL_ROLLBACK option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(1) MSDTC can be called without ODBC. In this case, MSDTC becomes a transaction manager, and the application no longer uses SQLEndTran. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only one distributed transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose your ODBC application for a native C ++ client is enrolled in a distributed transaction. Then the application is credited to the second distributed transaction. In this case, the SQL Server Native Client ODBC driver leaves the original distributed transaction and is included in the new distributed transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read more about MSDTC </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option number 2. The C # application, as an alternative to the SQL database in the Azur cloud,</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
MSDTC is not supported for either the Azure SQL Database or the Azure SQL Data Warehouse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, you can create a distributed transaction for an SQL database if your C # program uses the .NET System.Transactions.TransactionScope class. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following example shows how to use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TransactionScope</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">to define a block of code to participate in a transaction.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">CreateTransactionScope</span>(<span class="hljs-params">
    <span class="hljs-keyword">string</span> connectString1, <span class="hljs-keyword">string</span> connectString2,
    <span class="hljs-keyword">string</span> commandText1, <span class="hljs-keyword">string</span> commandText2</span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">//        StringWriter   </span>
   <span class="hljs-comment">// .</span>
    <span class="hljs-keyword">int</span> returnValue = <span class="hljs-number">0</span>;<font></font>
    System.IO.StringWriter writer = <span class="hljs-keyword">new</span> System.IO.StringWriter();<font></font>
<font></font>
    <span class="hljs-keyword">try</span><font></font>
    {<font></font>
        <span class="hljs-comment">//  TransactionScope   , </span>
        <span class="hljs-comment">//            </span>
        <span class="hljs-comment">//  .</span>
        <span class="hljs-keyword">using</span> (TransactionScope scope = <span class="hljs-keyword">new</span> TransactionScope())<font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> (SqlConnection connection1 = <span class="hljs-keyword">new</span> SqlConnection(connectString1))<font></font>
            {<font></font>
                <span class="hljs-comment">//      </span>
                <span class="hljs-comment">// TransactionScope   .</span><font></font>
                connection1.Open();<font></font>
<font></font>
                <span class="hljs-comment">//   SqlCommand    .</span>
                SqlCommand command1 = <span class="hljs-keyword">new</span> SqlCommand(commandText1, connection1);<font></font>
                returnValue = command1.ExecuteNonQuery();<font></font>
                writer.WriteLine(<span class="hljs-string">"   command1: {0}"</span>, returnValue);<font></font>
<font></font>
                <span class="hljs-comment">//      ,  ,  </span>
                <span class="hljs-comment">//  command1  .  </span>
                <span class="hljs-comment">//    using  connection2   connection1, </span>
                <span class="hljs-comment">//         connection2 </span>
                <span class="hljs-comment">//      .   </span>
                <span class="hljs-keyword">using</span> (SqlConnection connection2 = <span class="hljs-keyword">new</span> SqlConnection(connectString2))<font></font>
                {<font></font>
                    <span class="hljs-comment">//       </span>
                    <span class="hljs-comment">//   connection2 .</span><font></font>
                    connection2.Open();<font></font>
<font></font>
                    <span class="hljs-comment">//      .</span>
                    returnValue = <span class="hljs-number">0</span>;<font></font>
                    SqlCommand command2 = <span class="hljs-keyword">new</span> SqlCommand(commandText2, connection2);<font></font>
                    returnValue = command2.ExecuteNonQuery();<font></font>
                    writer.WriteLine(<span class="hljs-string">"    command2: {0}"</span>, returnValue);<font></font>
                }<font></font>
            } <font></font>
            scope.Complete();<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">catch</span> (TransactionAbortedException ex)<font></font>
    {<font></font>
        writer.WriteLine(<span class="hljs-string">"   : {0}"</span>, ex.Message);<font></font>
    }<font></font>
<font></font>
    Console.WriteLine(writer.ToString());<font></font>
<font></font>
    <span class="hljs-keyword">return</span> returnValue;<font></font>
}<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option number 3. C # and Entity Framework Core applications for distributed transactions.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
By default, if the database provider supports transactions, all changes in one call to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SaveChanges ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are applied to the transaction. If any of the changes is not performed, the transaction is rolled back, and none of the changes are applied to the database. This means that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SaveChanges () is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> guaranteed to either complete successfully or leave the database unchanged in case of an error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For most applications, this default behavior is sufficient. You must manually control transactions only if the requirements of your application deem it necessary. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the DbContext.Database API</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to start, commit, and roll back transactions. The following example shows two </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SaveChanges ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operations </font><font style="vertical-align: inherit;">and a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LINQ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> query </font><font style="vertical-align: inherit;">executed in a single transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Not all database providers support transactions. Some providers may or may not issue transactions when invoking a transaction API.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> context = <span class="hljs-keyword">new</span> BloggingContext())<font></font>
{<font></font>
    <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> transaction = context.Database.BeginTransaction())<font></font>
    {<font></font>
        <span class="hljs-keyword">try</span><font></font>
        {<font></font>
            context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Url = <span class="hljs-string">"http://blogs.msdn.com/dotnet"</span> });<font></font>
            context.SaveChanges();<font></font>
<font></font>
            context.Blogs.Add(<span class="hljs-keyword">new</span> Blog { Url = <span class="hljs-string">"http://blogs.msdn.com/visualstudio"</span> });<font></font>
            context.SaveChanges();<font></font>
<font></font>
            <span class="hljs-keyword">var</span> blogs = context.Blogs<font></font>
                .OrderBy(b =&gt; b.Url)<font></font>
                .ToList();<font></font>
<font></font>
           transaction.Commit();<font></font>
        }<font></font>
        <span class="hljs-keyword">catch</span> (Exception)<font></font>
        {<font></font>
             <font></font>
        }<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EF Core in the .NET Framework</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the implementation of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Transactions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there supports distributed transactions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see from the documentation within the framework of the platform and the Microsoft product line, distributed transactions are not a problem: MSDTC, the cloud itself is fault-tolerant, a bunch of ADO .NET + EF Core for exotic combinations (read </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How can the transaction review on the Microsoft platform help us solve the problem? Very simple, there is a clear understanding that there is simply no standard toolkit for implementing a distributed transaction across heterogeneous databases in a .NET application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if so, then we make our own home-made coordinated distributed transaction coordinator (CRT).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the implementation options is distributed transactions based on microservices (see </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">This option is not bad, but it requires serious refinement of the Web API for all systems involved in the transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we need a slightly different mechanism. </font><font style="vertical-align: inherit;">The following is a general approach to developing MCT. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/n0/i-/f2n0i-wuvuyv1o6bfu_7-g-yfxm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see from the diagram, the main idea is to create and store with the updated status the transaction record stored in the master database (or table). </font><font style="vertical-align: inherit;">This model of CRT allows you to implement distributed transactions that meet the requirements:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atomicity</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coherence</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isolation</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">longevity</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - may be part of the application in which the user has created a record, or may be a completely separate application in the form of a system service.  may contain a special subprocess that generates transactions in a pool for execution when a power outage occurs (not shown in the diagram). Business rules for converting (mapping) the source data generated by the user for related databases can be dynamically added and configured via XML / JSON format and stored in the local application folder or in a transaction record (as an option). Accordingly, for this case, it is advisable to unify the conversion to related databases at the code level by implementing the modularity of the converters in the form of DLLs. (And yes, SRT implies direct access to the database without the participation of the Web API.)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, SRT in a simple form can be successfully implemented as part of the application, or as a separate, customizable and independent solution (which is better). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once again, I will clarify that a distributed transaction is, by definition, a one-time storage of information without changing it, but with the ability to map various databases into data schemes. </font><font style="vertical-align: inherit;">So if you need to record data at other bases, for example, at the Ministry of Internal Affairs, the FSB and insurance companies, when recording incidents in the hospital‚Äôs emergency room (bullet wound), then this approach will certainly help you. </font><font style="vertical-align: inherit;">The same mechanism can work perfectly in financial institutions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope this approach seemed interesting to you, write what you think about it, colleagues and friends!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491280/index.html">The story of how I developed a programming language</a></li>
<li><a href="../en491282/index.html">How to increase team productivity (and reduce errors) using rallies</a></li>
<li><a href="../en491284/index.html">Analysis: what is fundamental analysis</a></li>
<li><a href="../en491286/index.html">IPv6 only networks in US government</a></li>
<li><a href="../en491288/index.html">Polygraphists go crazy one by one</a></li>
<li><a href="../en491296/index.html">Dagaz: A Persistence Story</a></li>
<li><a href="../en491298/index.html">How to find malware (no) with WinDbg</a></li>
<li><a href="../en491300/index.html">STM32 Part 2: Initialization</a></li>
<li><a href="../en491302/index.html">OVPN client on Grandstream phones</a></li>
<li><a href="../en491304/index.html">Helsinki: a city of happiness and comfort</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>