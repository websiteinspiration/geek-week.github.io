<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèª üéÖ üòì Security Cheat Sheets: Nodejs üôç üè¥ üôáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quite a lot has already been said about the popularity of NodeJS. The increase in the number of applications is obvious - NodeJS is quite easy to lear...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Security Cheat Sheets: Nodejs</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/acribia/blog/493714/"><img src="https://habrastorage.org/webt/bs/ml/lo/bsmllozt2li3jmn_6ec8vy4krdq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quite a lot has already been said about the popularity of NodeJS. </font><font style="vertical-align: inherit;">The increase in the number of applications is obvious - NodeJS is quite easy to learn, has a huge number of libraries, as well as a dynamically developing ecosystem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We made </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recommendations for NodeJS developers</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> based on OWASP Cheat Sheets to help you anticipate security issues when developing applications. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Security recommendations for NodeJS applications can be divided into the following categories:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Security during application development;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server security;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Platform security;</font></font></li>
</ul><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application Development Security</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avoid callback hell</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Using callback functions (callbacks) is one of NodeJS's greatest strengths, however when nesting callbacks, you can easily forget to handle the error in one of the functions. </font><font style="vertical-align: inherit;">One way to avoid callback hell is to use promises. </font><font style="vertical-align: inherit;">Even if the module you are using does not support working with promises, you can always use Promise.promisifyAll (). </font><font style="vertical-align: inherit;">But even using promises, it is worth paying attention to nesting. </font><font style="vertical-align: inherit;">To completely avoid the callback hell error, stick to a ‚Äúflat‚Äù chain of promises. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Callback hell example:</font></font></i><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">function <span class="hljs-title">func1</span><span class="hljs-params">(name, callback)</span> </span>{<font></font>
   setTimeout(function() {<font></font>
      <span class="hljs-comment">// operations</span>
   }, <span class="hljs-number">500</span>);<font></font>
}<font></font>
<span class="hljs-function">function <span class="hljs-title">func2</span><span class="hljs-params">(name, callback)</span> </span>{<font></font>
   setTimeout(function() {<font></font>
      <span class="hljs-comment">// operations</span>
   }, <span class="hljs-number">100</span>);<font></font>
}<font></font>
<span class="hljs-function">function <span class="hljs-title">func3</span><span class="hljs-params">(name, callback)</span> </span>{<font></font>
   setTimeout(function() {<font></font>
      <span class="hljs-comment">// operations</span>
   }, <span class="hljs-number">900</span>);<font></font>
}<font></font>
<span class="hljs-function">function <span class="hljs-title">func4</span><span class="hljs-params">(name, callback)</span> </span>{<font></font>
   setTimeout(function() {<font></font>
      <span class="hljs-comment">// operations</span>
   }, <span class="hljs-number">3000</span>);<font></font>
}<font></font>
<font></font>
func1(<span class="hljs-string">"input1"</span>, function(err, result1){
   <span class="hljs-keyword">if</span>(err){
      <span class="hljs-comment">// error operations</span><font></font>
   }<font></font>
   <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//some operations</span>
      func2(<span class="hljs-string">"input2"</span>, function(err, result2){
         <span class="hljs-keyword">if</span>(err){
            <span class="hljs-comment">//error operations</span><font></font>
         }<font></font>
         <span class="hljs-keyword">else</span>{
            <span class="hljs-comment">//some operations</span>
            func3(<span class="hljs-string">"input3"</span>, function(err, result3){
               <span class="hljs-keyword">if</span>(err){
                  <span class="hljs-comment">//error operations</span><font></font>
               }<font></font>
               <span class="hljs-keyword">else</span>{
                  <span class="hljs-comment">// some operations</span>
                  func4(<span class="hljs-string">"input 4"</span>, function(err, result4){
                     <span class="hljs-keyword">if</span>(err){
                        <span class="hljs-comment">// error operations</span><font></font>
                     }<font></font>
                     <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// some operations</span><font></font>
                     }<font></font>
                  });<font></font>
               }<font></font>
            });<font></font>
         }<font></font>
      });<font></font>
   }<font></font>
});<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Same code using flat chain promises:</font></font></i><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">function <span class="hljs-title">func1</span><span class="hljs-params">(name, callback)</span> </span>{<font></font>
   setTimeout(function() {<font></font>
      <span class="hljs-comment">// operations</span>
   }, <span class="hljs-number">500</span>);<font></font>
}<font></font>
<span class="hljs-function">function <span class="hljs-title">func2</span><span class="hljs-params">(name, callback)</span> </span>{<font></font>
   setTimeout(function() {<font></font>
      <span class="hljs-comment">// operations</span>
   }, <span class="hljs-number">100</span>);<font></font>
}<font></font>
<span class="hljs-function">function <span class="hljs-title">func3</span><span class="hljs-params">(name, callback)</span> </span>{<font></font>
   setTimeout(function() {<font></font>
      <span class="hljs-comment">// operations</span>
   }, <span class="hljs-number">900</span>);<font></font>
}<font></font>
<span class="hljs-function">function <span class="hljs-title">func4</span><span class="hljs-params">(name, callback)</span> </span>{<font></font>
   setTimeout(function() {<font></font>
      <span class="hljs-comment">// operations</span>
   }, <span class="hljs-number">3000</span>);<font></font>
}<font></font>
<font></font>
func1(<span class="hljs-string">"input1"</span>)<font></font>
   .then(function (result){<font></font>
      <span class="hljs-keyword">return</span> func2(<span class="hljs-string">"input2"</span>);<font></font>
   })<font></font>
   .then(function (result){<font></font>
      <span class="hljs-keyword">return</span> func3(<span class="hljs-string">"input3"</span>);<font></font>
   })<font></font>
   .then(function (result){<font></font>
      <span class="hljs-keyword">return</span> func4(<span class="hljs-string">"input4"</span>);<font></font>
   })<font></font>
   .<span class="hljs-keyword">catch</span>(function (error) {
      <span class="hljs-comment">// error operations</span><font></font>
   });<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limit the size of the request.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Parsing the </font><b><font style="vertical-align: inherit;">request</font></b><font style="vertical-align: inherit;"> body can be quite a resource-intensive operation. If you do not limit the size of the request, attackers will be able to send large enough requests that can fill up all disk space or exhaust all server resources, but at the same time, limiting the request size for all cases may be incorrect, because there are requests, such as downloading a file. Therefore, it is recommended to set limits for different types of content. For example, using the express framework, this can be implemented as follows:</font></font><br>
<br>
<pre><code class="java hljs">app.use(express.urlencoded({ limit: <span class="hljs-string">"1kb"</span> }));<font></font>
app.use(express.json({ limit: <span class="hljs-string">"1kb"</span> }));<font></font>
app.use(express.multipart({ limit:<span class="hljs-string">"10mb"</span> }));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 It should be noted that an attacker can change the type of request content and circumvent restrictions, therefore, it is necessary to check whether the content of the request matches the type of content specified in the request header. </font><font style="vertical-align: inherit;">If checking the type of content affects performance, you can only check certain types or queries that are larger than a certain size. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not block the event loop</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
An important component of the language is the event loop, which just allows you to switch the execution context without waiting for the operation to complete. </font><font style="vertical-align: inherit;">However, there are blocking operations whose completion NodeJS has to wait before continuing with the code. </font><font style="vertical-align: inherit;">For example, most synchronous methods are blocking:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">const</span> fs = require(<span class="hljs-string">'fs'</span>);<font></font>
fs.unlinkSync(<span class="hljs-string">'/file.txt'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is recommended to perform such operations asynchronously:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">const</span> fs = require(<span class="hljs-string">'fs'</span>);<font></font>
fs.unlink(<span class="hljs-string">'/file.txt'</span>, (err) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 At the same time, do not forget that the code standing after the asynchronous call will be executed without waiting for the completion of the previous operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, in the code below, the file will be deleted before it is read, which can lead to a race condition.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">const</span> fs = require(<span class="hljs-string">'fs'</span>);<font></font>
fs.readFile(<span class="hljs-string">'/file.txt'</span>, (err, data) =&gt; {
  <span class="hljs-comment">// perform actions on file content</span><font></font>
});<font></font>
fs.unlinkSync(<span class="hljs-string">'/file.txt'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 To avoid this, you can write all operations in a non-blocking function:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">const</span> fs = require(<span class="hljs-string">'fs'</span>);<font></font>
fs.readFile(<span class="hljs-string">'/file.txt'</span>, (err, data) =&gt; {
  <span class="hljs-comment">// perform actions on file content</span>
  fs.unlink(<span class="hljs-string">'/file.txt'</span>, (err) =&gt; {
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<font></font>
  });<font></font>
});<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check input fields.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Checking </font><b><font style="vertical-align: inherit;">input</font></b><font style="vertical-align: inherit;"> fields is an important part of the security of any application. Validation errors can cause your application to become vulnerable immediately to many types of attacks: sql injection, xss, command injection, and others. To simplify form validation, you can use validator packages, mongo-express-sanitize. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escape user data</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
One of the rules that will help you protect yourself from xss attacks is to shield user data. You can use the escape-html or node-esapi library for this. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keep logs</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In addition, it will help in debugging errors, logging can be used to respond to incidents. You can read more about the need for logging </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here.</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">One of the most popular NodeJS logging packages is Winston and Bunyan. </font><font style="vertical-align: inherit;">The example below shows how to use Winston to output logs to both the console and the file:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> logger = <span class="hljs-keyword">new</span> (Winston.Logger) ({<font></font>
    transports: [<font></font>
        <span class="hljs-keyword">new</span> (winston.transports.Console)(),
        <span class="hljs-keyword">new</span> (winston.transports.File)({ filename: <span class="hljs-string">'application.log'</span> })<font></font>
    ],<font></font>
    level: <span class="hljs-string">'verbose'</span><font></font>
});<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control the cycle of events</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If your server is in conditions of intensive network traffic, users may experience difficulties with the availability of your service. </font><font style="vertical-align: inherit;">This is essentially a DoS attack. </font><font style="vertical-align: inherit;">In this case, you can track the response time and, if it exceeds the specified time, send a message to 503 Server Too Busy. </font><font style="vertical-align: inherit;">The toobusy-js module can help. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An example of using the module:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> toobusy = require(<span class="hljs-string">'toobusy-js'</span>);
<span class="hljs-keyword">var</span> express = require(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> app = express();<font></font>
app.use(function(req, res, next) {<font></font>
    <span class="hljs-keyword">if</span> (toobusy()) {
        <span class="hljs-comment">// log if you see necessary</span>
        res.send(<span class="hljs-number">503</span>, <span class="hljs-string">"Server Too Busy"</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
    next();<font></font>
    }<font></font>
});<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take precautions against brute force.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Again, modules come to the rescue. </font><font style="vertical-align: inherit;">For example, express-brute or express-bouncer. </font><font style="vertical-align: inherit;">Usage example:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> bouncer = require(<span class="hljs-string">'express-bouncer'</span>);<font></font>
bouncer.whitelist.push(<span class="hljs-string">'127.0.0.1'</span>); <span class="hljs-comment">// whitelist an IP address</span>
<span class="hljs-comment">// give a custom error message</span><font></font>
bouncer.blocked = function (req, res, next, remaining) {<font></font>
    res.send(<span class="hljs-number">429</span>, <span class="hljs-string">"Too many requests have been made. Please wait "</span> + remaining/<span class="hljs-number">1000</span> + <span class="hljs-string">" seconds."</span>);<font></font>
};<font></font>
<span class="hljs-comment">// route to protect</span>
app.post(<span class="hljs-string">"/login"</span>, bouncer.block, function(req, res) {
    <span class="hljs-keyword">if</span> (LoginFailed){  }
    <span class="hljs-keyword">else</span> {<font></font>
        bouncer.reset( req );<font></font>
    }<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using CAPTCHA is another common brute force countermeasure. </font><font style="vertical-align: inherit;">A frequently used module to help implement CAPTCHA is svg-captcha. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use CSRF Tokens</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
One of the most reliable ways to protect against CSRF attacks is to use a CSRF token. </font><font style="vertical-align: inherit;">The token must be generated with high entropy, strictly checked and be tied to the user's session. </font><font style="vertical-align: inherit;">To ensure the operation of the CSRF token, you can use the csurf module. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usage example:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> csrf = require(<span class="hljs-string">'csurf'</span>);<font></font>
csrfProtection = csrf({ cookie: <span class="hljs-keyword">true</span> });<font></font>
app.get(<span class="hljs-string">'/form'</span>, csrfProtection, function(req, res) {<font></font>
    res.render(<span class="hljs-string">'send'</span>, { csrfToken: req.csrfToken() })<font></font>
})<font></font>
app.post(<span class="hljs-string">'/process'</span>, parseForm, csrfProtection, function(req, res) {<font></font>
    res.send(<span class="hljs-string">'data is being processed'</span>);<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not forget to add the token to the hidden field on the page:</font></font><br>
<br>
<pre><code class="plaintext hljs">&lt;input type="hidden" name="_csrf" value="{{ csrfToken }}"&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can read more about CSRF tokens in our </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delete unnecessary routes. The</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
web application should not contain pages that are not used by users, as this can increase the attack surface. Therefore, all unused API routes must be disabled. You should especially pay attention to this question if you use Sails or Feathers frameworks, since they automatically generate API endpoints. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protect yourself from HPP (HTTP Parameter Pollution)</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
By default, express adds all the parameters from the request to an array. OWASP recommends using the hpp module, which ignores all parameter values ‚Äã‚Äãfrom req.query and / or req.body and simply selects the last value among the duplicate ones.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> hpp = require(<span class="hljs-string">'hpp'</span>);<font></font>
app.use(hpp());<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitor the returned values.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For example, the user table can store important data: password, email address, date of birth, etc. </font><font style="vertical-align: inherit;">Therefore, it is important to return only the necessary data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For instance:</font></font><br>
<br>
<pre><code class="java hljs"> <span class="hljs-keyword">exports</span>.sanitizeUser = function(user) {
  <span class="hljs-keyword">return</span> {<font></font>
    id: user.id,<font></font>
    username: user.username,<font></font>
    fullName: user.fullName<font></font>
  };<font></font>
};<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use descriptors</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Use descriptors to describe the behavior of a property for various operations: writable - whether it is possible to change the value of a property, enumerable - whether it is possible to use a property in a for..in loop, configurable - whether it is possible to overwrite a property. </font><font style="vertical-align: inherit;">It is recommended to pay attention to the listed properties, since when defining the property of an object, all these attributes are set to true by default. </font><font style="vertical-align: inherit;">You can change the value of properties as follows:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> o = {};<font></font>
Object.defineProperty(o, <span class="hljs-string">"a"</span>, {<font></font>
    writable: <span class="hljs-keyword">true</span>,<font></font>
    enumerable: <span class="hljs-keyword">true</span>,<font></font>
    configurable: <span class="hljs-keyword">true</span>,<font></font>
    value: <span class="hljs-string">"A"</span><font></font>
});<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use ACLs</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Acl can help to differentiate data access based on roles. </font><font style="vertical-align: inherit;">For example, adding permission looks like this:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// guest is allowed to view blogs</span>
acl.allow(<span class="hljs-string">'guest'</span>, <span class="hljs-string">'blogs'</span>, <span class="hljs-string">'view'</span>)
<span class="hljs-comment">// allow function accepts arrays as any parameter</span>
acl.allow(<span class="hljs-string">'member'</span>, <span class="hljs-string">'blogs'</span>, [<span class="hljs-string">'edit'</span>, <span class="hljs-string">'view'</span>, <span class="hljs-string">'delete'</span>])
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Catch uncaughtException</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
By default, in the event of an uncaught exception, NodeJS will throw the current stack trace and terminate the execution thread. </font><font style="vertical-align: inherit;">However, NodeJS allows you to customize this behavior. </font><font style="vertical-align: inherit;">In the event of an uncaught exception, an uncaughtException event is raised, which can be caught using the process object:</font></font><br>
<br>
<pre><code class="java hljs">process.on(<span class="hljs-string">"uncaughtException"</span>, function(err) {
    <span class="hljs-comment">// clean up allocated resources</span>
    <span class="hljs-comment">// log necessary error details to log files</span>
    process.exit(); <span class="hljs-comment">// exit the process to avoid unknown state</span><font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth remembering that when an uncaughtException occurs, it is necessary to clear all allocated resources (for example, file descriptors and handlers) before completing the Z process in order to avoid unforeseen errors. </font><font style="vertical-align: inherit;">It is strongly discouraged that the program continues to run if an uncaughtException occurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, when displaying error messages, the user should not disclose detailed error information, such as stack trace.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server security</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set flags for headers when working with cookies.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
There are several flags that can help protect against attacks such as xss and csrf: httpOnly, which prevents access to cookies through javascript; </font><font style="vertical-align: inherit;">Secure - allows sending cookies only via HTTPS and SameSite, which determines the ability to transfer cookies to a third-party resource. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usage example:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> session = require(<span class="hljs-string">'express-session'</span>);<font></font>
app.use(session({<font></font>
    secret: <span class="hljs-string">'your-secret-key'</span>,<font></font>
    key: <span class="hljs-string">'cookieName'</span>,<font></font>
    cookie: { secure: <span class="hljs-keyword">true</span>, httpOnly: <span class="hljs-keyword">true</span>, path: <span class="hljs-string">'/user'</span>, sameSite: <span class="hljs-keyword">true</span>}<font></font>
}));<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set HTTP headers for security</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The following are headers and examples of how to connect them to help you protect yourself from a number of common attacks. </font><font style="vertical-align: inherit;">Headers are set using the helmet module </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ Strict-Transport-Security: HTTP Strict Transport Security (HSTS) tells the browser that the application can only be accessed via HTTPS</font></font><br>
<br>
<pre><code class="java hljs">app.use(helmet.hsts()); <span class="hljs-comment">// default configuration</span>
app.use(helmet.hsts(<span class="hljs-string">"&lt;max-age&gt;"</span>, <span class="hljs-string">"&lt;includeSubdomains&gt;"</span>)); <span class="hljs-comment">// custom configuration</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ X-Frame-Options: determines whether the page can be used in frame, iframe, embed or object</font></font><br>
<br>
<pre><code class="java hljs">app.use(hemlet.xframe()); <span class="hljs-comment">// default behavior (DENY)</span>
helmet.xframe(<span class="hljs-string">'sameorigin'</span>); <span class="hljs-comment">// SAMEORIGIN</span>
helmet.xframe(<span class="hljs-string">'allow-from'</span>, <span class="hljs-string">'http://alloweduri.com'</span>); <span class="hljs-comment">//ALLOW-FROM uri</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ X-XSS-Protection: allows the browser to stop loading the page if it detects a reflected XSS attack.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> xssFilter = require(<span class="hljs-string">'x-xss-protection'</span>);<font></font>
app.use(xssFilter());<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ X-Content-Type-Options: used to prevent attacks using MIME types</font></font><br>
<br>
<pre><code class="java hljs">app.use(helmet.noSniff());
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ Content-Security-Policy: Prevents attacks such as XSS and data injection attacks</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">const</span> csp = require(<span class="hljs-string">'helmet-csp'</span>)<font></font>
app.use(csp({<font></font>
   directives: {<font></font>
       defaultSrc: [<span class="hljs-string">"'self'"</span>],  <span class="hljs-comment">// default value for all directives that are absent</span>
       scriptSrc: [<span class="hljs-string">"'self'"</span>],   <span class="hljs-comment">// helps prevent XSS attacks</span>
       frameAncestors: [<span class="hljs-string">"'none'"</span>],  <span class="hljs-comment">// helps prevent Clickjacking attacks</span>
       imgSrc: [<span class="hljs-string">"'self'"</span>, <span class="hljs-string">"'http://imgexample.com'"</span>],<font></font>
       styleSrc: [<span class="hljs-string">"'none'"</span>]<font></font>
    }<font></font>
}))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ Cache-Control and Pragma: for managing caching, especially this header can be useful for pages that contain sensitive data. </font><font style="vertical-align: inherit;">However, remember that disabling caching on all pages can affect performance.</font></font><br>
<br>
<pre><code class="java hljs">app.use(helmet.noCache());
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ X-Download-Options: header prevents Inter Explorer from executing downloaded files</font></font><br>
<br>
<pre><code class="java hljs">app.use(helmet.ieNoOpen());
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ Expect-CT: Certificate Transparency - a mechanism created to solve some problems with the infrastructure of SSL certificates, this header tells the browser about the need for additional certificate verification in CT logs</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> expectCt = require(<span class="hljs-string">'expect-ct'</span>);<font></font>
app.use(expectCt({ maxAge: <span class="hljs-number">123</span> }));<font></font>
app.use(expectCt({ enforce: <span class="hljs-keyword">true</span>, maxAge: <span class="hljs-number">123</span> }));<font></font>
app.use(expectCt({ enforce: <span class="hljs-keyword">true</span>, maxAge: <span class="hljs-number">123</span>, reportUri: <span class="hljs-string">'http://example.com'</span>}));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚Ä¢ X-Powered-By: An optional header that is used to indicate the technology used on the server. </font><font style="vertical-align: inherit;">You can hide this header as follows:</font></font><br>
<br>
<pre><code class="java hljs">app.use(helmet.hidePoweredBy());
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 In addition, you can change the value to hide real information about the technologies you use:</font></font><br>
<br>
<pre><code class="java hljs">app.use(helmet.hidePoweredBy({ setTo: <span class="hljs-string">'PHP 4.2.0'</span> }));
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Platform security</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update your packages The</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
security of your application depends on the security of the packages you use, so it is important to use the latest version of the package. To make sure that the package you are using does not contain known vulnerabilities, you can use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special OWASP list</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . You can also use the library that checks packages for known vulnerabilities Retire.js. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not use unsafe functions.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are functions that are recommended to be discarded whenever possible. Among these functions is eval (), which executes a string taken as an argument. In combination with user input, using this function can lead to vulnerabilities in remote code execution, since for similar reasons, using child_process.exec is also unsafe, because the function passes the received arguments to bin / sh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, there are a number of modules that you should use with caution. For example, the fs module for working with files. If in a certain way the generated user input is passed into a function, then your application may become vulnerable to including a local file and directory traversal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The vm module, which provides an API for compiling and running code on a V8 virtual machine, should be used only in the sandbox. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can familiarize yourself with other functions that may make your application unsafe. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Be careful using regular expressions.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A regular expression can be written so that you can achieve a situation where the expression will grow exponentially, which can lead to a denial of service. Such attacks are called ReDoS. There are several tools to check if regular expressions are safe, one of which is vuln-regex-detector. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run linter periodically</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During development, it‚Äôs difficult to keep in mind all the recommendations for ensuring security, and if it comes to team development, it is not easy to achieve compliance with the rules by all team members. For such purposes, there are tools for static security analysis. Such tools, without executing your code, look for vulnerabilities in it. In addition, linters allow you to add custom rules for finding places in the code that may be vulnerable. The most commonly used linters are ESLint and JSHint. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use strict mode.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Javascript has a number of insecure and obsolete functions that should not be used. To exclude the possibility of using these functions, strict mode is also provided. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adhere to general safety principles</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The recommendations described focus on NodeJS, but do not forget about the general security principles that must be followed regardless of the platform used.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493702/index.html">Massive transition to remote work: technical problems and threats to security</a></li>
<li><a href="../en493704/index.html">Using TypeScript in JavaScript without writing TypeScript</a></li>
<li><a href="../en493706/index.html">Know your enemy: create a Node.js backdoor</a></li>
<li><a href="../en493708/index.html">Anatomy of my home Kubernetes cluster</a></li>
<li><a href="../en493712/index.html">New TypeScript features for enhanced usability</a></li>
<li><a href="../en493716/index.html">Type inference with TypeScript using the as const construct and the infer keyword</a></li>
<li><a href="../en493718/index.html">Discussion: standard UNIX utilities that few have used and are currently using</a></li>
<li><a href="../en493720/index.html">The perfect storm: how technology is changing the food service industry</a></li>
<li><a href="../en493724/index.html">RPA | Process robotization through the eyes of an analyst</a></li>
<li><a href="../en493726/index.html">Smoking Detection Complex by photo or video based on Intel NUC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>