<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¢ ğŸ‘¨â€ğŸ³ ğŸ™…ğŸ¼ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¾ãŸã¯ã€Œé¡§å®¢ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ†ã‚£ã®å‘ä¸Šã€ ğŸˆ ğŸ‘¨ğŸ¼â€ğŸ”§ ğŸŒ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è² è·ãŒå¤§ãã„ï¼ˆå¹³å‡å¾…æ©Ÿæ™‚é–“> 2åˆ†ï¼‰ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ3ã€œ5äººï¼‰ã§ã‚ã‚‹ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
 
 ã“ã®ã‚¿ã‚¹ã‚¯ã¯ã€ç‰¹å®šã®åœ°åŸŸã«ã„ã‚‹åŠ å…¥è€…ãŒã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒç©ºãã¾ã§å¾…ãŸãªã„ã‚ˆã†ã«ã—ã€0ã‚’æŠ¼ã—ã¦ã€Œã‚³ãƒ¼ãƒ«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚æˆ‘ã€…ã¯é–“é•ã„ãªãã€ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã®ãŸã‚ã®åˆ‡æ–­ã¨å†·é™ã«å¾…ã¡ã€ã‚¦ã‚§...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¾ãŸã¯ã€Œé¡§å®¢ãƒ­ã‚¤ãƒ¤ãƒ«ãƒ†ã‚£ã®å‘ä¸Šã€</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471500/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è² è·ãŒå¤§ãã„ï¼ˆå¹³å‡å¾…æ©Ÿæ™‚é–“&gt; 2åˆ†ï¼‰ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ3ã€œ5äººï¼‰ã§ã‚ã‚‹ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®ã‚¿ã‚¹ã‚¯ã¯ã€ç‰¹å®šã®åœ°åŸŸã«ã„ã‚‹åŠ å…¥è€…ãŒã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒç©ºãã¾ã§å¾…ãŸãªã„ã‚ˆã†ã«ã—ã€0ã‚’æŠ¼ã—ã¦ã€Œã‚³ãƒ¼ãƒ«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">æˆ‘ã€…ã¯é–“é•ã„ãªãã€ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã®ãŸã‚ã®åˆ‡æ–­ã¨å†·é™ã«å¾…ã¡ã€ã‚¦ã‚§ãƒ«ã¾ãŸã¯ã€Œãƒãƒƒã‚¯ã‚ãªãŸã‚’å‘¼ã³å‡ºã—ã¾ã™</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åº¶æ°‘ã§</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE TABLE asterisk.callbackï¼ˆ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 id intï¼ˆ11ï¼‰NOT NULL AUTO_INCREMENTã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 dt timestamp DEFAULT CURRENT_TIMESTAMPã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 cid varcharï¼ˆ32ï¼‰DEFAULT NULLã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 dst varcharï¼ˆ32ï¼‰DEFAULT NULLã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 status smallintï¼ˆ6ï¼‰NOT NULL DEFAULT 0ã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 tot ï¼ˆ11ï¼‰NOT NULL DEFAULT 0ã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 last_callã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—DEFAULT '0000-00-00 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 00ï¼š00ï¼š00 </font><font style="vertical-align: inherit;">'ã€</font><font style="vertical-align: inherit;">compl_dtã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—DEFAULT '0000-00-00 00ï¼š00ï¼š00'ã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 uniqueid varcharï¼ˆ32ï¼‰DEFAULT NULLã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ã‚­ãƒ¥ãƒ¼varchar ï¼ˆ255ï¼‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆNULLã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ä¸»ã‚­ãƒ¼ï¼ˆIDï¼‰</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼‰</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¨ãƒ³ã‚¸ãƒ³= INNODBä½œæˆ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯</font><font style="vertical-align: inherit;">.callback_log </font><font style="vertical-align: inherit;">ï¼ˆ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 id intï¼ˆ11ï¼‰NOT NULL AUTO_INCREMENTã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 callback_id intï¼ˆ11ï¼‰NOT NULLã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 DTã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMPã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹VARCHARï¼ˆ32ï¼‰ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®NULLã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 VARCHARï¼ˆ2048ï¼‰ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®NULLã€paramsã¯</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 PRIMARY KEYï¼ˆIDï¼‰ã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 CONSTRAINT callback_log_fk1 FOREIGN KEYï¼ˆcallback_idCALLDATEDERADEDEREDEREDEREDEREDEREKEDEREKEDEREDEREKEDEREKEDEREQUEDEREQUEï¼‰</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REFERENCALDER </font><font style="vertical-align: inherit;">ONE DECE CARD DECE CARD DECE CARD ONE </font><font style="vertical-align: inherit;">å‚ç…§ã‚’</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼‰</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¨ãƒ³ã‚¸ãƒ³= INNODB </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç·¨é›†extensions.conf</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exten =&gt; 88142590067ã€sã€1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    same =&gt; nã€GotoIfï¼ˆ$ ["$ {CALLERIDï¼ˆnumï¼‰ï¼š0ï¼š4}" = "8814"]ï¼Ÿextraï¼‰; </font><font style="vertical-align: inherit;">ç•ªå·ãŒãƒ­ãƒ¼ã‚«ãƒ«ã®å ´åˆã€CALLBACKã‚’è¨±å¯ã™ã‚‹</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
....ã“ã“ã«ã•ã‚‰ã«ãƒã‚§ãƒƒã‚¯ã‚’æŒ¿å…¥ã§ãã¾ã™...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nã€Gotoï¼ˆå‘¼ã³å‡ºã—ï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nï¼ˆè¿½åŠ ï¼‰ã€NoOpï¼ˆ$ {CALLERIDï¼ˆnumï¼‰}ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨±å¯ï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nã€è¨­å®šï¼ˆALLOW_CALLBACK = 1ï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nã€ã‚»ãƒƒãƒˆï¼ˆCALLBACK_QUEUE =æ¼”ç®—å­ï¼‰</font></font><font></font>
    same =&gt; n, Background(vse/press0-to-callback)<font></font>
<font></font>
    same =&gt; n(call), NoOp(Ask for operators. GROUP_COUNT=${GROUP_COUNT(operators)})<font></font>
    same =&gt; n, queue(operators,tThH)<font></font>
    same =&gt; n, Hangup<font></font>
<font></font>
include =&gt; main_menu_press<font></font>
<font></font>
[main_menu_press]<font></font>
exten =&gt; 0,1, NoOp('-------------------- ${CALLERID(num)} PRESS BUTTON ${EXTEN}. ALLOW_CALLBACK=${ALLOW_CALLBACK}')<font></font>
    same =&gt; n, GotoIf($[${ALLOW_CALLBACK}=1]?callback,s,1:i,1)<font></font>
<font></font>
[callback]<font></font>
exten =&gt; s,1, NoOp( CALLBACK )<font></font>
    same =&gt; n, Playback(thank-you-for-calling&amp;vse/my-vam-perezvonim)<font></font>
    same =&gt; n, Hangup<font></font>
<font></font>
exten =&gt; h,1, agi(callback.php,gen,0,${CALLBACK_QUEUE})<font></font>
<font></font>
[do-callback]<font></font>
exten =&gt; _X.,1, NoOp( Try to dial to queue (${CALLBACK_QUEUE}) and callback to ${CALLBACK_NUM} )<font></font>
    same =&gt; n, Set(__DST="?")<font></font>
    same =&gt; n, Set(CALLERID(num)=${CALLBACK_NUM})<font></font>
    same =&gt; n(call), queue(${CALLBACK_QUEUE},tT)<font></font>
    same =&gt; n, NoOp( CALLBACK QUEUESTATUS=${QUEUESTATUS} )<font></font>
<font></font>
[macro-queue-answ] ;     . <font></font>
exten =&gt; s,1, NoOp( Queue member answered uniq=${UNIQUEID} cid=${CALLERID(num)} chan=${CHANNEL} callback_id=${CALLBACK_ID} callback_num=${CALLBACK_NU<font></font>
    same =&gt; n, GotoIf($[ "${CALLBACK_ID}x" = "x" ]?skip)<font></font>
    same =&gt; n, Set(DST=${CHANNEL})<font></font>
    same =&gt; n, Set(CALLERID(num)=067)<font></font>
    same =&gt; n, Playback(priv-trying) ;   " "<font></font>
    same =&gt; n, agi(callback.php,queue-answ,${CALLBACK_ID},${CHANNEL},${UNIQUEID})<font></font>
    same =&gt; n, Dial(Local/${CALLBACK_NUM}@from_office_new)<font></font>
    same =&gt; n, NoOp( [macro-queue-answ] dial timeout )<font></font>
    same =&gt; n(skip), NoOp( )<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
exten =&gt; hã€1ã€NoOpï¼ˆ[macro-queue-answing] dial hangupï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    same =&gt; nã€GotoIfï¼ˆ$ ["$ {CALLBACK_ID} x" = "x"]ï¼Ÿendï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nã€NoOpï¼ˆdialstatus = $ {DIALSTATUS} hangupcause = $ {HANGUPCAUSE} queuestatus = $ {QUEUESTATUS}ï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nã€NoOpï¼ˆmy_dialstatus = $ {MY_DIALSTATUS} my_hangupcause = $ {MY_HANGUPCAUSE}ï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nã€agiï¼ˆcallback.phpã€hangup-queue-answingã€$ {CALLBACK_ID}ã€$ {CHANNEL}ã€$ {UNIQUEID}ï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nï¼ˆçµ‚äº†ï¼‰ã€NoOp</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
exten =&gt; sã€1ã€NoOpï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†ã€‚CALLBACK_ID= $ {CALLBACK_ID}ã€uniq = $ {UNIQUEID}ã€dst = $ {DST} chan = $ {CHANNEL}ï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nã€NoOpï¼ˆdialstatus = $ {DIALSTATUS} hangupcause = $ {HANGUPCAUSE} queuestatus = $ {QUEUESTATUS}ï¼‰</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    åŒã˜=&gt; nã€NoOpï¼ˆmy_dialstatus = $ {MY_DIALSTATUS} my_hangupcause = $ {MY_HANGUPCAUSE}ï¼‰</font></font><font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queues.confãƒ•ã‚¡ã‚¤ãƒ«</font></font><br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã€‘</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ringinuse =ã„ã„ãˆ</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    æˆ¦ç•¥= rrmemory</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    éŸ³æ¥½=ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt; SIP / 321</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt; SIP / 322</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt; SIP / 323</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt; SIP / 324</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt; SIP / 325</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt;ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ 1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt;ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ 2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt;ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ 3</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt;ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ 4</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ãƒ¡ãƒ³ãƒãƒ¼=&gt;ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ/ 5</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    context = main_menu_press</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ= 0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    announce-position = yes</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã®é »åº¦= 60</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    å®šæœŸçš„ãªã‚¢ãƒŠã‚¦ãƒ³ã‚¹ã®é »åº¦= 30</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    queue-youarenext = queue-youarenext</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    membermacro = queue-answ</font></font><font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ã‚ã€å®Ÿéš›ã«ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆPHPã§æ¤œå‡ºï¼‰</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
config.php</font></font><br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
ob_implicit_flush(<span class="hljs-literal">true</span>);<font></font>
set_time_limit(<span class="hljs-number">6</span>);<font></font>
<font></font>
date_default_timezone_set(<span class="hljs-string">'Europe/Moscow'</span>);<font></font>
<font></font>
mysql_connect(<span class="hljs-string">"localhost"</span>,<span class="hljs-string">"asterisk"</span>,<span class="hljs-string">"***"</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">'Mysql connect error'</span>);<font></font>
mysql_select_db(<span class="hljs-string">"asterisk"</span>);<font></font>
<font></font>
<span class="hljs-comment">// *******************************</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">genCallbackFile</span>(<span class="hljs-params">$id,$cid,$queue</span>) </span>{<font></font>
<font></font>
 $fname=<span class="hljs-string">'/var/spool/asterisk/outgoing/callback-'</span>.$id;
 <span class="hljs-keyword">if</span> (file_exists($fname)) <span class="hljs-keyword">return</span>;<font></font>
<font></font>
 $callfile=<span class="hljs-string">"Channel: Local/"</span>.$cid.<span class="hljs-string">"@do-callback\n"</span>.
            <span class="hljs-string">"WaitTime: 60\n"</span>.
            <span class="hljs-string">"MaxRetries: 1\n"</span>.<span class="hljs-string">"RetryTime: 120\n"</span>.
            <span class="hljs-string">"Context: callback-complete\n"</span>.
            <span class="hljs-string">"Extension: s\n"</span>.
            <span class="hljs-string">"Set: __CALLBACK_ID=$id\n"</span>.
            <span class="hljs-string">"Set: __CALLBACK_QUEUE=$queue\n"</span>.
            <span class="hljs-string">"Set: __CALLBACK_NUM=$cid\n"</span>;<font></font>
<font></font>
 $fp=fopen($fname,<span class="hljs-string">'w+'</span>);fputs($fp,$callfile);fclose($fp);<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">?&gt;</span><font></font>
<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
callback.php</font></font><br>
<pre><code class="php hljs"><span class="hljs-comment">#!/usr/bin/php</span>
<span class="hljs-meta">&lt;?</span><font></font>
<font></font>
 $arg=$_SERVER[<span class="hljs-string">"argv"</span>];<font></font>
 $a=$arg[<span class="hljs-number">1</span>];<font></font>
 $id=abs($arg[<span class="hljs-number">2</span>]);<font></font>
<font></font>
 <span class="hljs-keyword">include</span>(<span class="hljs-string">'/var/lib/asterisk/agi-bin/config.php'</span>);<font></font>
<font></font>
 $in = fopen(<span class="hljs-string">"php://stdin"</span>,<span class="hljs-string">"r"</span>);<font></font>
 $stdlog = fopen(<span class="hljs-string">"/var/log/asterisk/callback.log"</span>, <span class="hljs-string">"a+"</span>);<font></font>
<font></font>
 <span class="hljs-comment">// toggle debugging output (more verbose)</span>
 $debug = <span class="hljs-literal">false</span>;<font></font>
<font></font>
 <span class="hljs-comment">// parse agi headers into array</span>
 <span class="hljs-keyword">while</span> ($env=read()) {<font></font>
   $s = split(<span class="hljs-string">": "</span>,$env);<font></font>
   $agi[str_replace(<span class="hljs-string">"agi_"</span>,<span class="hljs-string">""</span>,$s[<span class="hljs-number">0</span>])] = trim($s[<span class="hljs-number">1</span>]);
   <span class="hljs-keyword">if</span> (($env == <span class="hljs-string">""</span>) || ($env == <span class="hljs-string">"\n"</span>)) {
     <span class="hljs-keyword">break</span>;<font></font>
   }<font></font>
 }<font></font>
<font></font>
<span class="hljs-comment">// main program ************************</span>
 $dt=date(<span class="hljs-string">'d.m.Y H:i:s'</span>);<font></font>
<font></font>
 $cid=$agi[callerid];<font></font>
<font></font>
 <span class="hljs-keyword">switch</span> ($a) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'cid-answ'</span> : { <span class="hljs-comment">// -   </span>
        $stmt=<span class="hljs-string">'select * from callback where id='</span>.$id;<font></font>
        $result=mysql_query($stmt);<font></font>
        $row=mysql_fetch_object($result);<font></font>
        $cid=$row-&gt;cid;<font></font>
<font></font>
        $stmt=<span class="hljs-string">"select * from callback where id=$id or (dt&gt;(now()-interval 24 hour) and cid='$cid' and STATUS&lt;&gt;2)"</span>;<font></font>
        $result=mysql_query($stmt);<font></font>
        <span class="hljs-keyword">while</span> ($row=mysql_fetch_object($result)) {<font></font>
            $id=$row-&gt;id;<font></font>
            $stmt=<span class="hljs-string">"update callback set status=2,compl_dt=now() where id=$id"</span>;<font></font>
            $result=mysql_query($stmt);<font></font>
            rename(<span class="hljs-string">'/var/spool/asterisk/outgoing/callback-'</span>.$id,<span class="hljs-string">'/tmp/callback-'</span>.$id);<font></font>
        }<font></font>
        <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'queue-answ'</span> : { <span class="hljs-comment">//     .      </span>
        $dst=$arg[<span class="hljs-number">3</span>];<font></font>
        $stmt=sprintf(<span class="hljs-string">'update callback set status=1,last_call=now(),tot_calls=tot_calls+1,dst="%s",uniqueid="%s" where id=%d",$dst,$agi[uniqueid],$id);
        $result=mysql_query($stmt);
        break;
    }
    case '</span>complete<span class="hljs-string">' : { //  ,        ,   callfile 
        $id=abs($arg[2]);
        $stmt='</span>select * <span class="hljs-keyword">from</span> callback where id=<span class="hljs-string">'.$id;
        $result=mysql_query($stmt);
        $row=mysql_fetch_object($result);

        if ($row-&gt;status!=2) genCallBackFile($id,$row-&gt;cid,$row-&gt;queue);

        break;
    }
    case '</span>gen<span class="hljs-string">': { //       
        $qname=trim($arg[3]);
        if (!$qname) $qname='</span>operators<span class="hljs-string">';

        //        0, ,    .     
        $stmt=sprintf('</span>select * <span class="hljs-keyword">from</span> callback where cid=<span class="hljs-string">"%s"</span> <span class="hljs-keyword">and</span> queue=<span class="hljs-string">"%s"</span> status&lt;&gt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> dt&gt;now()-interval <span class="hljs-number">24</span> hour<span class="hljs-string">',$cid,$qname);
        $result=mysql_query($stmt);
        if (!$row=mysql_fetch_object($result)) {
            $stmt="insert into callback (cid,queue) values ('</span>$cid<span class="hljs-string">','</span>$qname<span class="hljs-string">')";
            $result=mysql_query($stmt);
            $id=mysql_insert_id();
            fputs($stdlog,"$dt|$stmt\n");
        } else {
            $log_status='</span>cid <span class="hljs-string">'.$cid.'</span> already in spool <span class="hljs-string">'.$qname;
        }

        genCallBackFile($id,$cid,$qname);
        break;
    }
 }

 $stmt=sprintf('</span>insert into callback_log (callback_id,status) values (%d,<span class="hljs-string">"%s -&gt; %s"</span>)<span class="hljs-string">',$id,$a,$log_status);
 $result=mysql_query($stmt);
 $log_id=mysql_insert_id();

 // clean up file handlers etc.
 fclose($in);
 fclose($stdlog);

 exit;

// ****************************************

?&gt;

</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã•ã‚‰ã«ã€åˆå‰8æ™‚ã‹ã‚‰åˆå¾Œ8æ™‚ã¾ã§5åˆ†ã”ã¨ã«ã‚¯ãƒ©ã‚¦ãƒ³ã«ã‚³ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿæˆã™ã‚‹ãŸã‚ã®åˆ¥ã®callback-regen.phpãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¾ã™ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è©¦è¡Œã™ã‚‹ãŸã³ã«ã€ç¹°ã‚Šè¿”ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ã®æ™‚é–“ãŒ5åˆ†ãšã¤å¢—åŠ ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ãƒ¢ãƒƒã‚¯ã‚’10å›è©¦è¡Œã—ãŸå¾Œã€åœæ­¢ã—ã¾ã™</font></font><br>
<pre><code class="php hljs"><span class="hljs-comment">#!/usr/bin/php</span>
<span class="hljs-meta">&lt;?</span><font></font>
<font></font>
 <span class="hljs-keyword">include</span>(<span class="hljs-string">'/var/lib/asterisk/agi-bin/config.php'</span>);<font></font>
<font></font>
 $stmt=<span class="hljs-string">'select * from callback where status&lt;&gt;2  and dt&gt;now()-interval 24 hour and tot_calls&lt;=10 '</span>.
        <span class="hljs-string">' and last_call&lt;now()-interval tot_calls*5 minute '</span>.
        <span class="hljs-string">' group by cid,queue'</span>;<font></font>
 $result=mysql_query($stmt);<font></font>
 <span class="hljs-keyword">while</span> ($row=mysql_fetch_object($result)) {<font></font>
    genCallBackFile($row-&gt;id,$row-&gt;cid,$row-&gt;queue);<font></font>
 }<font></font>
<font></font>
<span class="hljs-comment">// ****************************************</span>
<span class="hljs-meta">?&gt;</span>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471482/index.html">CLRiumï¼ƒ6ï¼šä¸¦è¡Œæ€§ã¨ä¸¦åˆ—æ€§ã€‚2æ—¥é–“ï¼šãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‹ã‚‰éåŒæœŸ/å¾…æ©Ÿã¾ã§</a></li>
<li><a href="../ja471484/index.html">ãƒ•ãƒƒãƒˆãƒœãƒ¼ãƒ«è»¢é€ã®ãƒ¢ãƒ‡ãƒ«ï¼šã‚ˆã‚Šæ·±ãæ˜ã‚Šä¸‹ã’ã‚‹</a></li>
<li><a href="../ja471492/index.html">iOSã§ã®ç´¹ä»‹ã‚ªãƒ•ã‚¡ãƒ¼ã®å¯ç”¨æ€§ã‚’ç¢ºèªã™ã‚‹æ–¹æ³•</a></li>
<li><a href="../ja471496/index.html">App Storeã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«ã«ã¤ã„ã¦å°‘ã—</a></li>
<li><a href="../ja471498/index.html">é“è·¯å›ºå®šã‚«ãƒ¡ãƒ©ã®åœ°å›³ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸï¼šå–œã¶ã‹æ³£ãï¼Ÿ</a></li>
<li><a href="../ja471502/index.html">ã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ãƒ¼ãƒ </a></li>
<li><a href="../ja471504/index.html">2æ¬¡å…ƒãƒ‡ãƒ¥ã‚¨ãƒƒãƒˆï¼šãƒœãƒ­ãƒ•ã‚§ãƒ³ã‚°ãƒ©ãƒ•ã‚§ãƒ³ãƒ˜ãƒ†ãƒ­æ§‹é€ ã®ä½œæˆ</a></li>
<li><a href="../ja471506/index.html">ãƒã‚¤ãƒŠãƒªã‚³ãƒ¼ãƒ‰ã®10é€²æ•°ã®æ­£ã—ã„ä¸¸ã‚</a></li>
<li><a href="../ja471508/index.html">Armless admin = hyper convergenceï¼Ÿ</a></li>
<li><a href="../ja471512/index.html">10æœˆ28æ—¥ã€ã‚¨ã‚«ãƒ†ãƒªãƒ³ãƒ–ãƒ«ã‚¯-è³ªã®é«˜ã„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>