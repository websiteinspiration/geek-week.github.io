<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐢 👨‍🍳 🙅🏼 コールバックまたは「顧客ロイヤルティの向上」 🍈 👨🏼‍🔧 🌽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="負荷が大きい（平均待機時間> 2分）オペレーターのグループ（3〜5人）であるアスタリスクがあります。
 
 このタスクは、特定の地域にいる加入者がオペレーターが空くまで待たないようにし、0を押して「コールありがとうございました。我々は間違いなく、オペレータからの呼び出しのための切断と冷静に待ち、ウェ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>コールバックまたは「顧客ロイヤルティの向上」</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471500/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">負荷が大きい（平均待機時間&gt; 2分）オペレーターのグループ（3〜5人）であるアスタリスクがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このタスクは、特定の地域にいる加入者がオペレーターが空くまで待たないようにし、0を押して「コールありがとうございました。</font><font style="vertical-align: inherit;">我々は間違いなく、オペレータからの呼び出しのための切断と冷静に待ち、ウェルまたは「バックあなたを呼び出します</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">庶民で</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートコールバックで</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルの作成</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CREATE TABLE asterisk.callback（</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 id int（11）NOT NULL AUTO_INCREMENT、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 dt timestamp DEFAULT CURRENT_TIMESTAMP、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 cid varchar（32）DEFAULT NULL、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 dst varchar（32）DEFAULT NULL、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 status smallint（6）NOT NULL DEFAULT 0、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 tot （11）NOT NULL DEFAULT 0、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 last_callタイムスタンプDEFAULT '0000-00-00 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 00：00：00 </font><font style="vertical-align: inherit;">'、</font><font style="vertical-align: inherit;">compl_dtタイムスタンプDEFAULT '0000-00-00 00：00：00'、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 uniqueid varchar（32）DEFAULT NULL、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 キューvarchar （255）デフォルトNULL、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 主キー（ID）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エンジン= INNODB作成</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルアスタリスク</font><font style="vertical-align: inherit;">.callback_log </font><font style="vertical-align: inherit;">（</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 id int（11）NOT NULL AUTO_INCREMENT、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 callback_id int（11）NOT NULL、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 DTタイムスタンプDEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ステータスVARCHAR（32）は、デフォルトのNULL、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 VARCHAR（2048）は、デフォルトのNULL、paramsは</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 PRIMARY KEY（ID）、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 CONSTRAINT callback_log_fk1 FOREIGN KEY（callback_idCALLDATEDERADEDEREDEREDEREDEREDEREKEDEREKEDEREDEREKEDEREKEDEREQUEDEREQUE）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REFERENCALDER </font><font style="vertical-align: inherit;">ONE DECE CARD DECE CARD DECE CARD ONE </font><font style="vertical-align: inherit;">参照を</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エンジン= INNODB </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
編集extensions.conf</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exten =&gt; 88142590067、s、1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    same =&gt; n、GotoIf（$ ["$ {CALLERID（num）：0：4}" = "8814"]？extra）; </font><font style="vertical-align: inherit;">番号がローカルの場合、CALLBACKを許可する</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
....ここにさらにチェックを挿入できます...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n、Goto（呼び出し）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n（追加）、NoOp（$ {CALLERID（num）}のコールバックを許可）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n、設定（ALLOW_CALLBACK = 1）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n、セット（CALLBACK_QUEUE =演算子）</font></font><font></font>
    same =&gt; n, Background(vse/press0-to-callback)<font></font>
<font></font>
    same =&gt; n(call), NoOp(Ask for operators. GROUP_COUNT=${GROUP_COUNT(operators)})<font></font>
    same =&gt; n, queue(operators,tThH)<font></font>
    same =&gt; n, Hangup<font></font>
<font></font>
include =&gt; main_menu_press<font></font>
<font></font>
[main_menu_press]<font></font>
exten =&gt; 0,1, NoOp('-------------------- ${CALLERID(num)} PRESS BUTTON ${EXTEN}. ALLOW_CALLBACK=${ALLOW_CALLBACK}')<font></font>
    same =&gt; n, GotoIf($[${ALLOW_CALLBACK}=1]?callback,s,1:i,1)<font></font>
<font></font>
[callback]<font></font>
exten =&gt; s,1, NoOp( CALLBACK )<font></font>
    same =&gt; n, Playback(thank-you-for-calling&amp;vse/my-vam-perezvonim)<font></font>
    same =&gt; n, Hangup<font></font>
<font></font>
exten =&gt; h,1, agi(callback.php,gen,0,${CALLBACK_QUEUE})<font></font>
<font></font>
[do-callback]<font></font>
exten =&gt; _X.,1, NoOp( Try to dial to queue (${CALLBACK_QUEUE}) and callback to ${CALLBACK_NUM} )<font></font>
    same =&gt; n, Set(__DST="?")<font></font>
    same =&gt; n, Set(CALLERID(num)=${CALLBACK_NUM})<font></font>
    same =&gt; n(call), queue(${CALLBACK_QUEUE},tT)<font></font>
    same =&gt; n, NoOp( CALLBACK QUEUESTATUS=${QUEUESTATUS} )<font></font>
<font></font>
[macro-queue-answ] ;     . <font></font>
exten =&gt; s,1, NoOp( Queue member answered uniq=${UNIQUEID} cid=${CALLERID(num)} chan=${CHANNEL} callback_id=${CALLBACK_ID} callback_num=${CALLBACK_NU<font></font>
    same =&gt; n, GotoIf($[ "${CALLBACK_ID}x" = "x" ]?skip)<font></font>
    same =&gt; n, Set(DST=${CHANNEL})<font></font>
    same =&gt; n, Set(CALLERID(num)=067)<font></font>
    same =&gt; n, Playback(priv-trying) ;   " "<font></font>
    same =&gt; n, agi(callback.php,queue-answ,${CALLBACK_ID},${CHANNEL},${UNIQUEID})<font></font>
    same =&gt; n, Dial(Local/${CALLBACK_NUM}@from_office_new)<font></font>
    same =&gt; n, NoOp( [macro-queue-answ] dial timeout )<font></font>
    same =&gt; n(skip), NoOp( )<font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
exten =&gt; h、1、NoOp（[macro-queue-answing] dial hangup）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    same =&gt; n、GotoIf（$ ["$ {CALLBACK_ID} x" = "x"]？end）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n、NoOp（dialstatus = $ {DIALSTATUS} hangupcause = $ {HANGUPCAUSE} queuestatus = $ {QUEUESTATUS}）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n、NoOp（my_dialstatus = $ {MY_DIALSTATUS} my_hangupcause = $ {MY_HANGUPCAUSE}）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n、agi（callback.php、hangup-queue-answing、$ {CALLBACK_ID}、$ {CHANNEL}、$ {UNIQUEID}）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n（終了）、NoOp</font></font><font></font>
<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[コールバック完了]</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
exten =&gt; s、1、NoOp（コールバック完了。CALLBACK_ID= $ {CALLBACK_ID}、uniq = $ {UNIQUEID}、dst = $ {DST} chan = $ {CHANNEL}）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n、NoOp（dialstatus = $ {DIALSTATUS} hangupcause = $ {HANGUPCAUSE} queuestatus = $ {QUEUESTATUS}）</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    同じ=&gt; n、NoOp（my_dialstatus = $ {MY_DIALSTATUS} my_hangupcause = $ {MY_HANGUPCAUSE}）</font></font><font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queues.confファイル</font></font><br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">【オペレーター】</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    ringinuse =いいえ</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    戦略= rrmemory</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    音楽=デフォルト</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt; SIP / 321</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt; SIP / 322</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt; SIP / 323</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt; SIP / 324</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt; SIP / 325</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt;エージェント/ 1</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt;エージェント/ 2</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt;エージェント/ 3</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt;エージェント/ 4</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    メンバー=&gt;エージェント/ 5</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    context = main_menu_press</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    タイムアウト= 0</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    announce-position = yes</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    アナウンスの頻度= 60</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    定期的なアナウンスの頻度= 30</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    queue-youarenext = queue-youarenext</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    membermacro = queue-answ</font></font><font></font>
</pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、実際にはスクリプト（PHPで検出）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
config.php</font></font><br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
ob_implicit_flush(<span class="hljs-literal">true</span>);<font></font>
set_time_limit(<span class="hljs-number">6</span>);<font></font>
<font></font>
date_default_timezone_set(<span class="hljs-string">'Europe/Moscow'</span>);<font></font>
<font></font>
mysql_connect(<span class="hljs-string">"localhost"</span>,<span class="hljs-string">"asterisk"</span>,<span class="hljs-string">"***"</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">'Mysql connect error'</span>);<font></font>
mysql_select_db(<span class="hljs-string">"asterisk"</span>);<font></font>
<font></font>
<span class="hljs-comment">// *******************************</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">genCallbackFile</span>(<span class="hljs-params">$id,$cid,$queue</span>) </span>{<font></font>
<font></font>
 $fname=<span class="hljs-string">'/var/spool/asterisk/outgoing/callback-'</span>.$id;
 <span class="hljs-keyword">if</span> (file_exists($fname)) <span class="hljs-keyword">return</span>;<font></font>
<font></font>
 $callfile=<span class="hljs-string">"Channel: Local/"</span>.$cid.<span class="hljs-string">"@do-callback\n"</span>.
            <span class="hljs-string">"WaitTime: 60\n"</span>.
            <span class="hljs-string">"MaxRetries: 1\n"</span>.<span class="hljs-string">"RetryTime: 120\n"</span>.
            <span class="hljs-string">"Context: callback-complete\n"</span>.
            <span class="hljs-string">"Extension: s\n"</span>.
            <span class="hljs-string">"Set: __CALLBACK_ID=$id\n"</span>.
            <span class="hljs-string">"Set: __CALLBACK_QUEUE=$queue\n"</span>.
            <span class="hljs-string">"Set: __CALLBACK_NUM=$cid\n"</span>;<font></font>
<font></font>
 $fp=fopen($fname,<span class="hljs-string">'w+'</span>);fputs($fp,$callfile);fclose($fp);<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">?&gt;</span><font></font>
<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
callback.php</font></font><br>
<pre><code class="php hljs"><span class="hljs-comment">#!/usr/bin/php</span>
<span class="hljs-meta">&lt;?</span><font></font>
<font></font>
 $arg=$_SERVER[<span class="hljs-string">"argv"</span>];<font></font>
 $a=$arg[<span class="hljs-number">1</span>];<font></font>
 $id=abs($arg[<span class="hljs-number">2</span>]);<font></font>
<font></font>
 <span class="hljs-keyword">include</span>(<span class="hljs-string">'/var/lib/asterisk/agi-bin/config.php'</span>);<font></font>
<font></font>
 $in = fopen(<span class="hljs-string">"php://stdin"</span>,<span class="hljs-string">"r"</span>);<font></font>
 $stdlog = fopen(<span class="hljs-string">"/var/log/asterisk/callback.log"</span>, <span class="hljs-string">"a+"</span>);<font></font>
<font></font>
 <span class="hljs-comment">// toggle debugging output (more verbose)</span>
 $debug = <span class="hljs-literal">false</span>;<font></font>
<font></font>
 <span class="hljs-comment">// parse agi headers into array</span>
 <span class="hljs-keyword">while</span> ($env=read()) {<font></font>
   $s = split(<span class="hljs-string">": "</span>,$env);<font></font>
   $agi[str_replace(<span class="hljs-string">"agi_"</span>,<span class="hljs-string">""</span>,$s[<span class="hljs-number">0</span>])] = trim($s[<span class="hljs-number">1</span>]);
   <span class="hljs-keyword">if</span> (($env == <span class="hljs-string">""</span>) || ($env == <span class="hljs-string">"\n"</span>)) {
     <span class="hljs-keyword">break</span>;<font></font>
   }<font></font>
 }<font></font>
<font></font>
<span class="hljs-comment">// main program ************************</span>
 $dt=date(<span class="hljs-string">'d.m.Y H:i:s'</span>);<font></font>
<font></font>
 $cid=$agi[callerid];<font></font>
<font></font>
 <span class="hljs-keyword">switch</span> ($a) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'cid-answ'</span> : { <span class="hljs-comment">// -   </span>
        $stmt=<span class="hljs-string">'select * from callback where id='</span>.$id;<font></font>
        $result=mysql_query($stmt);<font></font>
        $row=mysql_fetch_object($result);<font></font>
        $cid=$row-&gt;cid;<font></font>
<font></font>
        $stmt=<span class="hljs-string">"select * from callback where id=$id or (dt&gt;(now()-interval 24 hour) and cid='$cid' and STATUS&lt;&gt;2)"</span>;<font></font>
        $result=mysql_query($stmt);<font></font>
        <span class="hljs-keyword">while</span> ($row=mysql_fetch_object($result)) {<font></font>
            $id=$row-&gt;id;<font></font>
            $stmt=<span class="hljs-string">"update callback set status=2,compl_dt=now() where id=$id"</span>;<font></font>
            $result=mysql_query($stmt);<font></font>
            rename(<span class="hljs-string">'/var/spool/asterisk/outgoing/callback-'</span>.$id,<span class="hljs-string">'/tmp/callback-'</span>.$id);<font></font>
        }<font></font>
        <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'queue-answ'</span> : { <span class="hljs-comment">//     .      </span>
        $dst=$arg[<span class="hljs-number">3</span>];<font></font>
        $stmt=sprintf(<span class="hljs-string">'update callback set status=1,last_call=now(),tot_calls=tot_calls+1,dst="%s",uniqueid="%s" where id=%d",$dst,$agi[uniqueid],$id);
        $result=mysql_query($stmt);
        break;
    }
    case '</span>complete<span class="hljs-string">' : { //  ,        ,   callfile 
        $id=abs($arg[2]);
        $stmt='</span>select * <span class="hljs-keyword">from</span> callback where id=<span class="hljs-string">'.$id;
        $result=mysql_query($stmt);
        $row=mysql_fetch_object($result);

        if ($row-&gt;status!=2) genCallBackFile($id,$row-&gt;cid,$row-&gt;queue);

        break;
    }
    case '</span>gen<span class="hljs-string">': { //       
        $qname=trim($arg[3]);
        if (!$qname) $qname='</span>operators<span class="hljs-string">';

        //        0, ,    .     
        $stmt=sprintf('</span>select * <span class="hljs-keyword">from</span> callback where cid=<span class="hljs-string">"%s"</span> <span class="hljs-keyword">and</span> queue=<span class="hljs-string">"%s"</span> status&lt;&gt;<span class="hljs-number">2</span> <span class="hljs-keyword">and</span> dt&gt;now()-interval <span class="hljs-number">24</span> hour<span class="hljs-string">',$cid,$qname);
        $result=mysql_query($stmt);
        if (!$row=mysql_fetch_object($result)) {
            $stmt="insert into callback (cid,queue) values ('</span>$cid<span class="hljs-string">','</span>$qname<span class="hljs-string">')";
            $result=mysql_query($stmt);
            $id=mysql_insert_id();
            fputs($stdlog,"$dt|$stmt\n");
        } else {
            $log_status='</span>cid <span class="hljs-string">'.$cid.'</span> already in spool <span class="hljs-string">'.$qname;
        }

        genCallBackFile($id,$cid,$qname);
        break;
    }
 }

 $stmt=sprintf('</span>insert into callback_log (callback_id,status) values (%d,<span class="hljs-string">"%s -&gt; %s"</span>)<span class="hljs-string">',$id,$a,$log_status);
 $result=mysql_query($stmt);
 $log_id=mysql_insert_id();

 // clean up file handlers etc.
 fclose($in);
 fclose($stdlog);

 exit;

// ****************************************

?&gt;

</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、午前8時から午後8時まで5分ごとにクラウンにコールファイルを再生成するための別のcallback-regen.phpファイルを配置します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
試行するたびに、繰り返されるコールの時間が5分ずつ増加します。</font><font style="vertical-align: inherit;">オペレーターのモックを10回試行した後、停止します</font></font><br>
<pre><code class="php hljs"><span class="hljs-comment">#!/usr/bin/php</span>
<span class="hljs-meta">&lt;?</span><font></font>
<font></font>
 <span class="hljs-keyword">include</span>(<span class="hljs-string">'/var/lib/asterisk/agi-bin/config.php'</span>);<font></font>
<font></font>
 $stmt=<span class="hljs-string">'select * from callback where status&lt;&gt;2  and dt&gt;now()-interval 24 hour and tot_calls&lt;=10 '</span>.
        <span class="hljs-string">' and last_call&lt;now()-interval tot_calls*5 minute '</span>.
        <span class="hljs-string">' group by cid,queue'</span>;<font></font>
 $result=mysql_query($stmt);<font></font>
 <span class="hljs-keyword">while</span> ($row=mysql_fetch_object($result)) {<font></font>
    genCallBackFile($row-&gt;id,$row-&gt;cid,$row-&gt;queue);<font></font>
 }<font></font>
<font></font>
<span class="hljs-comment">// ****************************************</span>
<span class="hljs-meta">?&gt;</span>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471482/index.html">CLRium＃6：並行性と並列性。2日間：プロセッサーから非同期/待機まで</a></li>
<li><a href="../ja471484/index.html">フットボール転送のモデル：より深く掘り下げる</a></li>
<li><a href="../ja471492/index.html">iOSでの紹介オファーの可用性を確認する方法</a></li>
<li><a href="../ja471496/index.html">App Storeのサブスクリプションモデルについて少し</a></li>
<li><a href="../ja471498/index.html">道路固定カメラの地図が公開されました：喜ぶか泣く？</a></li>
<li><a href="../ja471502/index.html">アイディアファーム</a></li>
<li><a href="../ja471504/index.html">2次元デュエット：ボロフェングラフェンヘテロ構造の作成</a></li>
<li><a href="../ja471506/index.html">バイナリコードの10進数の正しい丸め</a></li>
<li><a href="../ja471508/index.html">Armless admin = hyper convergence？</a></li>
<li><a href="../ja471512/index.html">10月28日、エカテリンブルク-質の高いコミュニケーション</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>