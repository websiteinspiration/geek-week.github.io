<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öõÔ∏è ü§æüèæ ‚ûó PHP asinkron ‚õèÔ∏è üë®‚Äçüîß üëèüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sepuluh tahun yang lalu, kami memiliki tumpukan LAMP klasik: Linux, Apache, MySQL, dan PHP, yang bekerja dalam mode lambat mod_php. Dunia telah beruba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PHP asinkron</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/487258/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sepuluh tahun yang lalu, kami memiliki tumpukan LAMP klasik: Linux, Apache, MySQL, dan PHP, yang bekerja dalam mode lambat mod_php. Dunia telah berubah, dan dengan itu pentingnya kecepatan. PHP-FPM muncul, yang memungkinkan untuk secara signifikan meningkatkan kinerja solusi dalam PHP, dan tidak untuk segera menulis ulang ke sesuatu yang lebih cepat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara paralel, perpustakaan ReactPHP dikembangkan menggunakan konsep Event Loop untuk memproses sinyal dari OS dan menyajikan hasil untuk operasi asinkron. Pengembangan ide ReactPHP - AMPHP. Pustaka ini menggunakan Event Loop yang sama, tetapi mendukung coroutine, tidak seperti ReactPHP. Mereka memungkinkan Anda untuk menulis kode asinkron yang terlihat seperti sinkron. Mungkin ini adalah kerangka kerja terkini untuk mengembangkan aplikasi asinkron dalam PHP.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/03/e6/tf03e6u08mt8gake9o4lbbfbdca.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi kecepatan diperlukan lebih dan lebih, alat sudah tidak cukup, sehingga gagasan pemrograman asinkron dalam PHP adalah salah satu cara untuk mempercepat pemrosesan permintaan dan memanfaatkan sumber daya dengan lebih baik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inilah yang </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dibicarakan oleh </font><strong><font style="vertical-align: inherit;">Anton Shabovta</font></strong><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zloyusr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Adalah pengembang di Onliner. </font><font style="vertical-align: inherit;">Pengalaman lebih dari 10 tahun: Saya mulai dengan aplikasi desktop di C / C ++, dan kemudian beralih ke pengembangan web di PHP. </font><font style="vertical-align: inherit;">Dia menulis proyek "Rumah" dalam C # dan Python 3, dan dalam PHP dia bereksperimen dengan DDD, CQRS, Event Sourcing, Async Multitasking.</font></font><br>
<a name="habracut"></a><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikel ini didasarkan pada transkrip laporan Anton di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russia 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Di dalamnya kita akan memahami operasi pemblokiran dan non-pemblokiran dalam PHP, kita akan mempelajari struktur Event Loop dan primitif asinkron, seperti Promise dan coroutine, dari dalam. </font><font style="vertical-align: inherit;">Akhirnya, kita akan menemukan apa yang menanti kita di ext-async, AMPHP 3, dan PHP 8.</font></font></i><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/w75P9RrVgKg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memperkenalkan beberapa definisi. </font><font style="vertical-align: inherit;">Untuk waktu yang lama saya mencoba menemukan definisi yang tepat dari operasi asinkron dan asinkron, tetapi saya tidak menemukan dan menulis milik saya.</font></font><br>
<blockquote><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchrony</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah kemampuan sistem perangkat lunak untuk tidak memblokir utas eksekusi. </font></font><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operasi asinkron</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah operasi yang tidak memblokir aliran eksekusi program sampai selesai.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tampaknya sederhana, tetapi pertama-tama Anda harus memahami operasi apa yang menghalangi aliran eksekusi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operasi pemblokiran</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP adalah bahasa juru bahasa. </font><font style="vertical-align: inherit;">Dia membaca kode baris demi baris, menerjemahkan ke dalam instruksinya dan mengeksekusi. </font><font style="vertical-align: inherit;">Pada baris mana dari contoh di bawah ini akankah kode diblokir?</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params">User $user</span>)
</span>{
    <span class="hljs-keyword">try</span> {<font></font>
        $sql = <span class="hljs-string">'UPDATE users SET ...'</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;connection-&gt;execute($sql, $user-&gt;data());<font></font>
    } <span class="hljs-keyword">catch</span> (\PDOException $error) {<font></font>
        log($error-&gt;getMessage());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita menghubungkan ke database melalui PDO, benang eksekusi akan diblokir pada string query untuk SQL-server: </font></font><code>return $this-&gt;connection-&gt;execute($sql, $user-&gt;data());</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini karena PHP tidak tahu berapa lama server SQL akan memproses kueri ini dan apakah itu akan dijalankan sama sekali. </font><font style="vertical-align: inherit;">Ia menunggu respons dari server dan program belum berjalan selama ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PHP juga memblokir aliran eksekusi pada semua operasi I / O.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistem File</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>fwrite</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>file_get_contents</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basis data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RedisClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Hampir semua ekstensi untuk menyambungkan kerja basis data dalam mode pemblokiran secara default.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proses</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>exec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>proc_open</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ini memblokir operasi, karena semua pekerjaan dengan proses dibangun melalui panggilan sistem.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bekerja dengan stdin / stdout</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>readline</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>echo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>print</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, eksekusi diblokir pada </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">penghitung waktu</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>usleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ini adalah operasi di mana kami secara eksplisit memberitahu utas untuk tertidur sebentar. </font><font style="vertical-align: inherit;">PHP akan diam selama ini.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchronous SQL Client</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi PHP modern adalah bahasa tujuan umum, dan tidak hanya untuk web seperti PHP / FI pada tahun 1997. </font><font style="vertical-align: inherit;">Oleh karena itu, kita dapat menulis klien SQL asinkron dari awal. </font><font style="vertical-align: inherit;">Tugasnya bukan yang paling sepele, tetapi bisa dipecahkan.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $socket = stream_socket_client(<span class="hljs-string">'127.0.0.1:3306'</span>, ...);<font></font>
<font></font>
    stream_set_blocking($socket, <span class="hljs-literal">false</span>);<font></font>
<font></font>
    $data = <span class="hljs-keyword">$this</span>-&gt;packBinarySQL($query, $params);<font></font>
    <font></font>
    socket_write($socket, $data, strlen($data));<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang klien lakukan? </font><font style="vertical-align: inherit;">Terhubung ke server SQL kami, menempatkan soket dalam mode non-blocking, mengemas permintaan dalam format biner yang dipahami oleh server SQL, menulis data ke soket. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena soket dalam mode non-blocking, operasi penulisan dari PHP cepat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi apa yang akan kembali sebagai hasil dari operasi semacam itu? </font><font style="vertical-align: inherit;">Kami tidak tahu apa yang akan ditanggapi oleh server SQL. </font><font style="vertical-align: inherit;">Mungkin perlu waktu lama untuk menyelesaikan permintaan atau tidak sama sekali. </font><font style="vertical-align: inherit;">Tetapi sesuatu harus dikembalikan? </font><font style="vertical-align: inherit;">Jika kami menggunakan PDO dan memanggil </font></font><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kueri di SQL server, kami dikembalikan </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- jumlah baris diubah oleh kueri ini. </font><font style="vertical-align: inherit;">Kami belum dapat mengembalikannya, oleh karena itu kami hanya </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menjanjikan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pengembalian.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janji</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah konsep dari dunia pemrograman asinkron.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promise adalah objek pembungkus dari hasil operasi asinkron. </font><font style="vertical-align: inherit;">Selain itu, hasil operasi masih belum diketahui oleh kami.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sayangnya, tidak ada standar Janji tunggal, dan tidak mungkin untuk mentransfer standar langsung dari dunia JavaScript ke PHP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana Janji Bekerja</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena belum ada hasil, kami hanya dapat membuat beberapa </font></font><code>callbacks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/n1/qq/ian1qqvr_xs0faonifptkfrd2jc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika data tersedia, perlu untuk melakukan panggilan balik </font></font><code>onResolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8v/bk/sf/8vbksfxvsfxskeozp3jckft5rmg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kesalahan terjadi, panggilan balik akan dilakukan </font></font><code>onReject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk menangani kesalahan. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8x/hw/0v/8xhw0vsdhfryxyxalvsydiydfsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antarmuka Promise terlihat seperti ini.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Promise</span>
</span>{
    <span class="hljs-keyword">const</span>
        STATUS_PENDING = <span class="hljs-number">0</span>,<font></font>
        STATUS_RESOLVED = <span class="hljs-number">1</span>,<font></font>
        STATUS_REJECTED = <span class="hljs-number">2</span><font></font>
    ;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResolve</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> $callback</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onReject</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> $callback</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reject</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Janji memiliki status dan metode untuk mengatur panggilan balik dan mengisi ( </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Janji dengan data atau kesalahan ( </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Tetapi ada perbedaan dan variasi. </font><font style="vertical-align: inherit;">Metode dapat dipanggil secara berbeda, atau alih-alih metode terpisah untuk membuat panggilan balik, </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mungkin ada beberapa, seperti dalam AMPHP, misalnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seringkali teknik untuk mengisi Janji </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengeluarkan dalam objek terpisah </font><font style="vertical-align: inherit;">fungsi penyimpanan tidak sinkron yang </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ditangguhkan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini dapat dianggap sebagai semacam pabrik untuk Janji. </font><font style="vertical-align: inherit;">Ini satu kali: satu Ditangguhkan membuat satu Janji. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bq/on/aq/bqonaqi04ql4kdhakfezn9nu25g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana cara menerapkan ini dalam klien SQL jika kita memutuskan untuk menulisnya sendiri?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchronous SQL Client</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami menciptakan Ditangguhkan, melakukan semua pekerjaan dengan soket, menuliskan data dan mengembalikan Janji - semuanya sederhana.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $deferred = <span class="hljs-keyword">new</span> Deferred;<font></font>
<font></font>
    $socket = stream_socket_client(<span class="hljs-string">'127.0.0.1:3306'</span>, ...);<font></font>
    stream_set_blocking($socket, <span class="hljs-literal">false</span>);<font></font>
<font></font>
    $data = <span class="hljs-keyword">$this</span>-&gt;packBinarySQL($query, $params);<font></font>
    socket_write($socket, $data, strlen($data));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $deferred-&gt;promise();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika kita memiliki Janji, kita dapat, misalnya:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atur callback dan dapatkan </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang kembali kepada kami </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menangani kesalahan, tambahkan ke log;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coba lagi permintaan jika server SQL merespons dengan kesalahan.</font></font></li>
</ul><br>
<pre><code class="php hljs">$promise = <span class="hljs-keyword">$this</span>-&gt;execAsync($sql, $user-&gt;data());<font></font>
<font></font>
$promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">int</span> $rows</span>) </span>{
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Affected rows: {$rows}"</span>;<font></font>
});<font></font>
<font></font>
$promise-&gt;onReject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>) </span>{<font></font>
    log($error-&gt;getMessage());<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertanyaannya tetap: kita mengatur panggilan balik, dan siapa yang akan menelepon </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perulangan acara</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada konsep </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Loop - sebuah event loop</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ia dapat memproses pesan dalam lingkungan asinkron. </font><font style="vertical-align: inherit;">Untuk I / O yang tidak sinkron, ini akan menjadi pesan dari OS yang siap dibaca atau ditulis oleh soket. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana itu bekerja.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klien memberi tahu Event Loop bahwa ia tertarik pada beberapa jenis soket.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perulangan Kejadian polling OS melalui system call </font></font><code>stream_select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: apakah soket siap, semua data tertulis, adalah data yang berasal dari sisi lain.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika OS melaporkan bahwa soket tidak siap, diblokir, maka Event Loop mengulangi loop.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ketika OS memberitahukan bahwa soket sudah siap, Event Loop mengembalikan kontrol ke klien dan mengaktifkan ( </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atau </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Janji.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/ln/ey/bb/lneybbz-tylmfanfoizqm2hscik.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengungkapkan konsep ini dalam kode: ambil kasus paling sederhana, hapus penanganan kesalahan dan nuansa lainnya, sehingga satu loop tak terbatas tetap ada. </font><font style="vertical-align: inherit;">Di setiap iterasi, ini akan polling OS tentang soket yang siap untuk membaca atau menulis, dan memanggil panggilan balik untuk soket tertentu.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {<font></font>
        stream_select($readSockets, $writeSockets, <span class="hljs-literal">null</span>, <span class="hljs-number">0</span>);<font></font>
        <font></font>
        <span class="hljs-keyword">foreach</span> ($readSockets <span class="hljs-keyword">as</span> $i =&gt; $socket) {<font></font>
            call_user_func(<span class="hljs-built_in">self</span>::readCallbacks[$i], $socket);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment">// Do same for write sockets</span><font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami melengkapi klien SQL kami. </font><font style="vertical-align: inherit;">Kami memberi tahu Event Loop bahwa segera setelah data dari server SQL sampai pada soket yang kami tangani, kami perlu membawa Deferred ke status ‚Äúselesai‚Äù dan mentransfer data dari soket ke Janji.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> $query, <span class="hljs-keyword">array</span> $params = []</span>)
</span>{<font></font>
    $deferred = <span class="hljs-keyword">new</span> Deferred;<font></font>
    ...<font></font>
    Loop::onReadable($socket, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$socket</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$deferred</span>) </span>{<font></font>
        $deferred-&gt;resolve(socket_read($socket));<font></font>
    });<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $deferred-&gt;promise();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event Loop </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dapat menangani I / O kami</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bekerja dengan soket</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Apa lagi yang bisa dia lakukan?</font></font><br>
<br>
<ul>
<li> JavaScript   <code>setTimeout</code>  <code>setInterval</code> ‚Äî .             N . <strong>Event Loop      </strong>.</li>
<li>Event Loop  <strong>   </strong>.    <code>process control</code>,       .</li>
</ul><br>
<h3> Event Loop</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menulis Perulangan Acara Anda tidak hanya mungkin, tetapi juga perlu. Jika Anda ingin bekerja dengan asynchronous PHP, penting untuk menulis implementasi sederhana Anda sendiri untuk memahami cara kerjanya. Tetapi dalam produksi, kami, tentu saja, tidak akan menggunakannya, tetapi kami akan mengambil implementasi yang siap pakai: stabil, bebas kesalahan dan terbukti dalam pekerjaan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada tiga implementasi utama. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Proyek tertua, dimulai kembali di PHP 5.3. Sekarang versi minimum yang diwajibkan dari PHP adalah 5.3.8. Proyek ini mengimplementasikan standar </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janji / A</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dari dunia JavaScript. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AMPHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Implementasi inilah yang saya lebih suka gunakan. Persyaratan minimum adalah PHP 7.0, dan karena versi berikutnya sudah 7.3. Ini menggunakan coroutine di atas Janji. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swoole</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ini adalah kerangka kerja Cina yang menarik di mana pengembang mencoba mem-port beberapa konsep dari dunia Go ke PHP. </font><font style="vertical-align: inherit;">Dokumentasi dalam bahasa Inggris tidak lengkap, sebagian besar di GitHub dalam bahasa Cina. </font><font style="vertical-align: inherit;">Jika Anda tahu bahasanya, silakan, tapi sejauh ini saya takut bekerja.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zo/n3/cq/zon3cqtbmsf-vnd0uliqqupphoo.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat seperti apa klien akan menggunakan ReactPHP untuk MySQL.</font></font><br>
<br>
<pre><code class="php hljs">$connection = (<span class="hljs-keyword">new</span> ConnectionFactory)-&gt;createLazyConnection();<font></font>
<font></font>
$promise = $connection-&gt;query(<span class="hljs-string">'UPDATE users SET ...'</span>);<font></font>
$promise-&gt;then(<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">QueryResult $command</span>) </span>{
        <span class="hljs-keyword">echo</span> count($command-&gt;resultRows) . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
    },<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">Exception</span> $error</span>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
    });</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya hampir sama dengan yang kami tulis: kami membuat </font></font><code>onnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan menjalankan permintaan. </font><font style="vertical-align: inherit;">Kami dapat mengatur panggilan balik untuk memproses hasil (kembali </font></font><code>affected rows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="php hljs">    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">QueryResult $command</span>) </span>{
        <span class="hljs-keyword">echo</span> count($command-&gt;resultRows) . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
    },</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dan panggilan balik untuk penanganan kesalahan:</font></font><br>
<br>
<pre><code class="php hljs">    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">Exception</span> $error</span>) </span>{
        <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
    });</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari panggilan balik ini, Anda dapat membangun rantai yang sangat panjang, karena setiap hasil </font></font><code>then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di ReactPHP juga mengembalikan Janji.</font></font><br>
<br>
<pre><code class="php hljs">$promise<font></font>
    -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$data</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise(...);<font></font>
    })<font></font>
    -&gt;then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$data</span>) </span>{<font></font>
        ...<font></font>
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$error</span>) </span>{<font></font>
        log($error);<font></font>
    })<font></font>
    ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah solusi untuk masalah yang disebut panggilan balik neraka. </font><font style="vertical-align: inherit;">Sayangnya, dalam implementasi ReactPHP, ini mengarah ke masalah "Janji neraka", ketika </font><strong><font style="vertical-align: inherit;">10-11 panggilan balik </font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diperlukan untuk menghubungkan RabbitMQ dengan benar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Bekerja dengan kode seperti itu dan memperbaikinya sulit. </font><font style="vertical-align: inherit;">Saya segera menyadari bahwa ini bukan milik saya dan beralih ke AMPHP.</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amphp</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proyek ini lebih muda dari ReactPHP dan mempromosikan konsep yang berbeda - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coroutine</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jika Anda melihat bekerja dengan MySQL di AMPHP, Anda dapat melihat bahwa ini hampir sama dengan bekerja </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di PHP.</font></font><br>
<br>
<pre><code class="php hljs">$pool = Mysql\pool(<span class="hljs-string">"host=127.0.0.1 port=3306 db=test"</span>);<font></font>
<font></font>
<span class="hljs-keyword">try</span> {<font></font>
    $result = <span class="hljs-keyword">yield</span> $pool-&gt;query(<span class="hljs-string">"UPDATE users SET ..."</span>);<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> $result-&gt;affectedRows . <span class="hljs-string">' row(s) in set.'</span>;<font></font>
} <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> $error) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">'Error: '</span> . $error-&gt;getMessage();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini kita membuat kumpulan, menghubungkan dan menjalankan permintaan. </font><font style="vertical-align: inherit;">Kami dapat menangani kesalahan melalui yang biasa </font></font><code>try...catch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, kami tidak perlu panggilan balik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi sebelum panggilan tidak sinkron, kata kunci - muncul di sini </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generator</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kata kunci </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengubah fungsi kami menjadi generator.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generator</span>(<span class="hljs-params">$counter = <span class="hljs-number">1</span></span>)
</span>{
    <span class="hljs-keyword">yield</span> $counter++;<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"A"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> $counter;<font></font>
<font></font>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"B"</span>;<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> ++$counter;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segera setelah penerjemah PHP menemukan </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fungsi dalam tubuh, ia menyadari bahwa itu adalah fungsi generator. </font><font style="vertical-align: inherit;">Alih-alih mengeksekusi, objek kelas dibuat saat dipanggil </font></font><code>Generator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Generator mewarisi antarmuka iterator.</font></font><br>
<br>
<pre><code class="php hljs">$generator = <span class="hljs-built_in">generator</span>(<span class="hljs-number">1</span>);<font></font>
<font></font>
<span class="hljs-keyword">foreach</span> ($generator <span class="hljs-keyword">as</span> $value) {
    <span class="hljs-keyword">echo</span> $value;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">while</span> ($generator-&gt;valid()) {
    <span class="hljs-keyword">echo</span> $generator-&gt;current();<font></font>
<font></font>
    $generator-&gt;next();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan demikian, adalah mungkin untuk menjalankan siklus </font></font><code>foreach</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>while</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan lain-lain. </font><font style="vertical-align: inherit;">Tetapi, yang lebih menarik, iterator memiliki metode </font></font><code>current</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>next</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mari kita lalui mereka langkah demi langkah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jalankan fungsi kami </font></font><code>generator($counter = 1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Kami menyebutnya metode generator </font></font><code>current()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nilai variabel akan dikembalikan </font></font><code>$counter++</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segera setelah kami menjalankan generator </font></font><code>next()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, kode akan menuju ke panggilan berikutnya di dalam generator </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Seluruh bagian kode di antara keduanya </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan dieksekusi, dan itu keren. </font><font style="vertical-align: inherit;">Terus memutar generator, kami mendapatkan hasilnya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coroutine</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi generator memiliki fungsi yang lebih menarik - kita dapat mengirim data ke generator dari luar. </font><font style="vertical-align: inherit;">Dalam hal ini, ini bukan generator, tetapi </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coroutine</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atau coroutine.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printer</span>(<span class="hljs-params"></span>) </span>{  
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {     
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">yield</span>;       <font></font>
    }                             <font></font>
}                                <font></font>
<font></font>
$print = printer();<font></font>
$print-&gt;send(<span class="hljs-string">'Hello'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">' PHPRussia'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">' 2019'</span>);<font></font>
$print-&gt;send(<span class="hljs-string">'!'</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di bagian kode ini, sangat menarik bahwa kode </font></font><code>while (true)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ini tidak akan memblokir aliran eksekusi, tetapi akan dieksekusi sekali. </font><font style="vertical-align: inherit;">Kami mengirim data ke Corutin dan menerima </font></font><code>'Hello'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Terkirim lebih banyak - diterima </font></font><code>'PHPRussia'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Prinsipnya jelas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain mengirim data ke generator, Anda dapat mengirim kesalahan dan memprosesnya dari dalam, yang nyaman.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printer</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">yield</span>;<font></font>
    } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> $e) {
        <span class="hljs-keyword">echo</span> $e-&gt;getMessage();<font></font>
    }<font></font>
}<font></font>
<font></font>
printer()-&gt;throw(<span class="hljs-keyword">new</span> \<span class="hljs-built_in">Exception</span>(<span class="hljs-string">'Ooops...'</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk meringkas. </font><font style="vertical-align: inherit;">Corutin adalah komponen dari program yang </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mendukung penghentian dan melanjutkan eksekusi sambil mempertahankan kondisi saat ini</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Corutin ingat tumpukan panggilannya, data di dalamnya, dan dapat menggunakannya di masa depan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generator dan Janji</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat antarmuka generator dan Promise.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Generator</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">throw</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Promise</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve</span>(<span class="hljs-params">$data</span>)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reject</span>(<span class="hljs-params">\<span class="hljs-built_in">Throwable</span> $error</span>)</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mereka terlihat sama, kecuali untuk nama metode yang berbeda. </font><font style="vertical-align: inherit;">Kami dapat mengirim data dan melemparkan kesalahan ke generator dan Janji. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana ini bisa digunakan? </font><font style="vertical-align: inherit;">Mari kita menulis sebuah fungsi.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recoil</span>(<span class="hljs-params">\<span class="hljs-built_in">Generator</span> $generator</span>)
</span>{<font></font>
    $promise = $generator-&gt;current();<font></font>
<font></font>
    $promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$data</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;send($data);<font></font>
        recoil($generator);<font></font>
    };<font></font>
<font></font>
    $promise-&gt;onReject(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$error</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;throw($error);<font></font>
        recoil($generator);<font></font>
    });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fungsi mengambil nilai saat ini dari generator: </font></font><code> $promise = $generator-&gt;current();</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sedikit melebih-lebihkan. </font><font style="vertical-align: inherit;">Ya, kami harus memeriksa bahwa nilai saat ini yang dikembalikan kepada kami adalah semacam </font></font><code>instanceof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janji. </font><font style="vertical-align: inherit;">Jika demikian, maka kita bisa memintanya menelepon kembali. </font><font style="vertical-align: inherit;">Secara internal mengirimkan data kembali ke generator ketika Promise berhasil dan secara rekursif memulai fungsinya </font></font><code>recoil</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="php hljs">    $promise-&gt;onResolve(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$data</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$generator</span>) </span>{<font></font>
        $generator-&gt;send($data);<font></font>
        recoil($generator);<font></font>
    };</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hal yang sama dapat dilakukan dengan kesalahan. </font><font style="vertical-align: inherit;">Jika Promise gagal, misalnya, server SQL berkata: "Terlalu banyak koneksi", maka kita dapat membuang kesalahan di dalam generator dan pergi ke langkah berikutnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua ini membawa kita pada konsep penting multitasking kooperatif.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multitasking kooperatif</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah jenis multitasking, di mana tugas berikutnya dilakukan hanya setelah tugas saat ini secara eksplisit menyatakan dirinya siap memberikan waktu prosesor untuk tugas-tugas lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya jarang menemukan sesuatu yang sederhana, seperti bekerja dengan hanya satu database. Paling sering, dalam proses memperbarui pengguna, Anda perlu memperbarui data dalam database, dalam indeks pencarian, kemudian membersihkan atau memperbarui cache, dan kemudian mengirim 15 pesan lagi ke RabbitMQ. Di PHP, semuanya terlihat seperti ini. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m6/w7/5n/m6w75nkbjrduxzynamn9qiinfwm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami melakukan operasi satu per satu: kami memperbarui database, indeks, dan kemudian cache. Tetapi secara default, PHP memblokir operasi semacam itu (I / O), jadi jika Anda perhatikan lebih dekat, sebenarnya, semuanya demikian. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wk/3d/wc/wk3dwckb_gjjfnoprw63gxnoxlm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada bagian yang gelap kami memblokir. Mereka mengambil waktu paling banyak. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita bekerja dalam mode asinkron, maka bagian-bagian ini tidak ada, garis waktu eksekusi terputus-putus.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qj/mx/xv/qjmxxv9oiwkix-_oebyl48qbio4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda bisa merekatkan semuanya dan membuat potongan satu per satu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t0/o0/x5/t0o0x5ddiw6pij4rlmvzst2oyaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk apa semua ini? </font><font style="vertical-align: inherit;">Jika Anda melihat ukuran garis waktu, pada awalnya dibutuhkan banyak waktu, tetapi segera setelah kami merekatkannya, aplikasi akan dipercepat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Konsep Event Loop dan multitasking kooperatif telah lama digunakan dalam berbagai aplikasi: Nginx, Node.js, Memcached, Redis. </font><font style="vertical-align: inherit;">Semuanya digunakan di dalam Event Loop dan dibangun dengan prinsip yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena kami mulai berbicara tentang server web Nginx dan Node.js, mari kita ingat bagaimana proses permintaan dalam PHP terjadi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meminta pemrosesan dalam PHP</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Browser mengirim permintaan, sampai ke server HTTP di belakangnya terdapat kumpulan aliran FPM. </font><font style="vertical-align: inherit;">Salah satu utas menjalankan permintaan ini, menghubungkan kode kami dan mulai menjalankannya. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bg/s1/p_/bgs1p_g8r9ytthxrst0mszi7_bw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika permintaan berikutnya tiba, utas FPM lain akan mengambilnya, sambungkan kode dan itu akan dieksekusi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada beberapa </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keuntungan dari</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> skema kerja ini </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penanganan kesalahan sederhana</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jika ada yang tidak beres dan salah satu permintaan jatuh, kita tidak perlu melakukan apa pun - yang berikutnya akan datang, dan ini tidak akan memengaruhi pekerjaannya.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami tidak memikirkan ingatan</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Kami tidak perlu membersihkan atau memantau memori. </font><font style="vertical-align: inherit;">Atas permintaan berikutnya, semua memori akan dihapus.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah skema keren yang bekerja di PHP sejak awal dan masih berfungsi dengan baik. </font><font style="vertical-align: inherit;">Namun ada juga </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kekurangannya</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Batasi jumlah proses</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jika kami memiliki 50 utas FPM di server, maka segera setelah permintaan ke-51 tiba, itu akan menunggu sampai salah satu utas menjadi bebas.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biaya untuk Beralih Konteks</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">OS mengalihkan permintaan di antara aliran FPM. </font><font style="vertical-align: inherit;">Operasi tingkat prosesor ini disebut Context Switch. </font><font style="vertical-align: inherit;">Itu mahal dan menjalankan sejumlah besar tindakan. </font><font style="vertical-align: inherit;">Penting untuk menyimpan semua register, tumpukan panggilan, semua yang ada di prosesor, kemudian beralih ke proses lain, muat register dan tumpukan panggilannya, lakukan sesuatu di sana lagi, beralih lagi, simpan lagi ... Untuk waktu yang lama.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita mendekati pertanyaan secara berbeda - kita akan menulis server HTTP dalam PHP itu sendiri.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server HTTP Asinkron</font></font></h2><br>
<img src="https://habrastorage.org/webt/nd/dy/yt/nddyyt6dhjy0dxnkmpokppvvcr4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu bisa dilakukan. </font><font style="vertical-align: inherit;">Kami telah belajar cara bekerja dengan soket dalam mode non-pemblokiran, dan koneksi HTTP adalah soket yang sama. </font><font style="vertical-align: inherit;">Bagaimana tampilannya dan bekerja? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah contoh memulai server HTTP dalam kerangka kerja AMPHP.</font></font><br>
<br>
<pre><code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<font></font>
    $app = <span class="hljs-keyword">new</span> Application();<font></font>
    $app-&gt;bootstrap();<font></font>
<font></font>
    $sockets = [Socket\listen(<span class="hljs-string">'0.0.0.0:80'</span>)];<font></font>
<font></font>
    $server = <span class="hljs-keyword">new</span> Server($sockets, <span class="hljs-keyword">new</span> CallableRequestHandler(
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Request $request</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$app</span>) </span>{<font></font>
            $response = <span class="hljs-keyword">yield</span> $app-&gt;dispatch($request);<font></font>
<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Response(Status::OK, [], $response);<font></font>
        })<font></font>
    );<font></font>
<font></font>
    <span class="hljs-keyword">yield</span> $server-&gt;start();<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya cukup sederhana: memuat </font></font><code>Application</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan membuat kumpulan soket (satu atau lebih). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, kami memulai server kami, mengaturnya </font></font><code>Handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang akan dieksekusi pada setiap permintaan dan mengirimkan permintaan ke kami </font></font><code>Application</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk mendapatkan tanggapan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hal terakhir yang harus dilakukan adalah memulai server </font></font><code>yield $server-&gt;start();</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam ReactPHP akan terlihat hampir sama, tetapi hanya akan ada 150 panggilan balik untuk opsi yang berbeda, yang sangat tidak nyaman.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada beberapa masalah dengan asynchrony di PHP. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurangnya standar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Setiap kerangka kerja: Swoole, ReactPHP, atau AMPHP, mengimplementasikan antarmuka Promise sendiri, dan mereka tidak kompatibel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AMPHP secara teori dapat berinteraksi dengan Promise dari ReactPHP, tetapi ada peringatan. Jika kode untuk ReactPHP tidak ditulis dengan sangat baik, dan di suatu tempat secara implisit memanggil atau membuat Perulangan Acara, maka ternyata dua Peristiwa Putaran akan berputar di dalamnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JavaScript memiliki standar Janji / A + yang relatif baik yang mengimplementasikan Guzzle. Akan lebih baik jika kerangka kerjanya mengikutinya. Tapi sejauh ini tidak. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memori bocor</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ketika kita bekerja di PHP dalam mode FPM biasa, kita mungkin tidak memikirkan memori. Bahkan jika pengembang dari beberapa ekstensi lupa untuk menulis kode yang baik, lupa untuk menjalankan melalui Valgrind, dan di suatu tempat di dalam memori mengalir, maka tidak apa-apa - permintaan berikutnya akan dihapus dan akan mulai lagi. Tetapi dalam mode asinkron, Anda tidak mampu membelinya, karena cepat atau lambat kita akan jatuh </font></font><code>OutOfMemoryException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dimungkinkan untuk diperbaiki, tetapi sulit dan menyakitkan. Dalam beberapa kasus, Xdebug membantu, dalam kasus lain, strace untuk mengurai kesalahan yang disebabkannya </font></font><code>OutOfMemoryException</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operasi pemblokiran</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Sangat penting untuk tidak memblokir Event Loop ketika kita menulis kode asinkron. Aplikasi melambat begitu kita memblokir aliran eksekusi, masing-masing coroutine kita mulai berjalan lebih lambat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kelunik / loop-block</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> akan membantu menemukan operasi seperti itu untuk AMPHP </font><font style="vertical-align: inherit;">. Dia mengatur timer ke interval yang sangat kecil. Jika timer tidak berfungsi, maka kita diblokir di suatu tempat. Paket ini membantu dalam menemukan tempat pemblokiran, tetapi tidak selalu: memblokir di beberapa ekstensi mungkin tidak diperhatikan. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dukungan Perpustakaan: Cassandra, Influx, ClickHouse</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Masalah utama dari semua PHP asinkron adalah dukungan perpustakaan. Kita tidak bisa menggunakan biasa </font></font><code>PDOConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RedisClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">driver lainnya untuk </font><font style="vertical-align: inherit;">semua orang </font><font style="vertical-align: inherit;">- kita perlu implementasi non-blocking. Mereka juga harus ditulis dalam PHP dalam mode non-blocking, karena driver C jarang menyediakan antarmuka yang dapat diintegrasikan ke dalam kode asinkron. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengalaman aneh yang saya dapatkan dengan driver untuk database Cassandra. Mereka menyediakan operasi</font></font><code>ExecuteAsync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>GetAsync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan lainnya, tetapi pada saat yang sama mereka mengembalikan objek </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan metode tunggal </font></font><code>get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yang menghalangi. </font><font style="vertical-align: inherit;">Ada peluang untuk mendapatkan sesuatu secara tidak sinkron, tetapi untuk menunggu hasilnya, kami masih akan memblokir seluruh Loop kami. </font><font style="vertical-align: inherit;">Untuk melakukannya dengan cara yang berbeda, misalnya, melalui panggilan balik, itu tidak berfungsi. </font><font style="vertical-align: inherit;">Saya bahkan menulis klien saya untuk Cassandra, karena kami menggunakannya dalam pekerjaan kami. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ketikkan indikasi</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ini adalah masalah AMPHP dan corutin.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): \<span class="hljs-title">Generator</span>
    </span>{<font></font>
        $data = <span class="hljs-keyword">yield</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika itu terjadi dalam suatu fungsi </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, maka itu menjadi generator. </font><font style="vertical-align: inherit;">Pada titik ini, kami tidak lagi dapat menentukan tipe data pengembalian yang benar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP 8</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang menanti kita di PHP 8? </font><font style="vertical-align: inherit;">Saya akan memberi tahu Anda tentang asumsi saya atau, lebih tepatnya, keinginan saya ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">catatan editor: Dmitry Stogov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tahu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> apa yang sebenarnya akan muncul di PHP 8</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Loop Acara </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ada kemungkinan itu akan muncul, karena pekerjaan sedang berlangsung untuk membawa Perulangan Acara dalam beberapa bentuk ke kernel. </font><font style="vertical-align: inherit;">Jika ini terjadi, kami akan memiliki fungsi </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, seperti dalam JavaScript atau C #, yang memungkinkan kami menunggu hasil operasi asinkron di tempat tertentu. </font><font style="vertical-align: inherit;">Dalam hal ini, kita tidak memerlukan ekstensi apa pun, semuanya akan bekerja secara tidak sinkron pada level kernel.</font></font><br>
<br>
<pre><code class="php hljs">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">User</span>&gt;
    </span>{<font></font>
        $data = await <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generik </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go menunggu Generik, kami menunggu Generik, semua orang menunggu Generik.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> $id</span>): <span class="hljs-title">Promise</span>&lt;<span class="hljs-title">User</span>&gt;
    </span>{<font></font>
        $data = <span class="hljs-keyword">yield</span> <span class="hljs-keyword">$this</span>-&gt;db-&gt;query(<span class="hljs-string">'SELECT ...'</span>, $id);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> User::fill($data);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi kami tidak menunggu Generics untuk koleksi, tetapi untuk menunjukkan bahwa hasil dari Janji akan persis menjadi objek Pengguna.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa semua ini?</font></font></h2><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk kecepatan dan kinerja.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP adalah bahasa di mana sebagian besar operasi terikat I / O. </font><font style="vertical-align: inherit;">Kami jarang menulis kode yang secara signifikan terkait dengan perhitungan di prosesor. </font><font style="vertical-align: inherit;">Kemungkinan besar, kami bekerja dengan soket: kita perlu membuat permintaan ke database, membaca sesuatu, mengembalikan respons, mengirim file. </font><font style="vertical-align: inherit;">Asynchrony memungkinkan Anda untuk mempercepat kode tersebut. </font><font style="vertical-align: inherit;">Jika kita melihat waktu respons rata-rata untuk 1000 permintaan, kita dapat mempercepat sekitar 8 kali, dan dengan 10.000 permintaan hampir 6!</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">13 Mei 2020, kami akan berkumpul untuk kedua kalinya di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Rusia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk membahas bahasa, perpustakaan, dan kerangka kerja, cara untuk meningkatkan produktivitas dan perangkap solusi hype. </font><font style="vertical-align: inherit;">Kami telah menerima 4 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laporan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pertama </font><font style="vertical-align: inherit;">, tetapi Call for Papers masih akan datang. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terapkan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> jika Anda ingin berbagi pengalaman dengan komunitas.</font></font></blockquote></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id487246/index.html">Otoritas Sertifikasi Tensor dapat membahayakan kunci pribadi pelanggan</a></li>
<li><a href="../id487248/index.html">Sedikit lagi tentang pengujian yang tidak tepat</a></li>
<li><a href="../id487250/index.html">Alfa tertunda berbaur</a></li>
<li><a href="../id487254/index.html">Cara menggunakan kamera CCTV tidak hanya untuk memantau penyusup</a></li>
<li><a href="../id487256/index.html">Membakar dan kembali dari abu atau orang Phoenix</a></li>
<li><a href="../id487260/index.html">NoVerify: linter PHP yang bekerja cepat</a></li>
<li><a href="../id487262/index.html">Konferensi terbuka PHP Russia Online</a></li>
<li><a href="../id487266/index.html">GitLab 12.7 dirilis dengan jalur pipa Parent-Child dan versi beta dari penangan pekerjaan umum untuk Windows</a></li>
<li><a href="../id487270/index.html">Perovskit dapat memperpanjang umur layar gadget</a></li>
<li><a href="../id487272/index.html">Bookmark - penghitungan selesai</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>