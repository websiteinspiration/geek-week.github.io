<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æüèø üë®üèΩ‚Äç‚úàÔ∏è üç´ Easter Egg in ionCube - an attempt by developers to sweep garbage under the carpet? üßê üë®üèæ‚Äçüíª üóÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A web developer knows that scripts created for commercial purposes can go for a walk on the network with overwritten copyrights; it is possible that t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Easter Egg in ionCube - an attempt by developers to sweep garbage under the carpet?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/506890/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/kc/lp/mo/kclpmoxrvrfvypeaomwmvyezwhu.jpeg"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A web developer knows that scripts created for commercial purposes can go for a walk on the network with overwritten copyrights; </font><font style="vertical-align: inherit;">it is possible that the script will start to resell on behalf of someone else. </font><font style="vertical-align: inherit;">To hide the source code of the script and prevent its change, obfuscators, minifiers, etc. are used. </font><font style="vertical-align: inherit;">One of the oldest and most famous tools for encrypting scripts in PHP is ionCube. </font><font style="vertical-align: inherit;">Introduced in 2002, it continues to monitor the development of PHP and declares support for the latest versions of the platform. </font><font style="vertical-align: inherit;">As I will show in this article, ionCube is far from ok with PHP 7 support ...</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The model for using PHP encryptors is such that the programmer sells an encrypted script, and the buyer of the script must install an extension module on his server that will allow encrypted scripts to be executed. </font><font style="vertical-align: inherit;">The script encrypted by ionCube looks something like this:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">//0059b</span>
<span class="hljs-comment">// 10.2 72</span>
<span class="hljs-comment">// </span>
<span class="hljs-comment">// IONCUBE ONLINE ENCODER EVALUATION</span>
<span class="hljs-comment">// THIS FILE IS LICENSED TO BE USED FOR ENCODER TESTING</span>
<span class="hljs-comment">// PURPOSES ONLY AND SHOULD NOT BE DISTRIBUTED</span>
<span class="hljs-comment">// </span>
<span class="hljs-keyword">if</span>(!extension_loaded(<span class="hljs-string">'ionCube Loader'</span>)){$__oc=strtolower(substr(php_uname(),<span class="hljs-comment">//skipped</span><font></font>
<font></font>
<span class="hljs-meta">?&gt;</span><font></font>
HR+cPn5yR+EksbFLjyZwm7EQh7Q0Y6YO6pLddgsuLRlBWUC5JWhAm3KcPBcRdP9D0zkMmdPNk5VG<font></font>
rMP1GxIwsA5NinHkQjWqG2pHL5nIZUvatUW+XMas3Knjf4wz9+DJoq47N1qZLDXwVzpOOupqa+Y4<font></font>
k8PPXt8WNYXL4gbJnVu6NrqBqqwOrtlHUE9Sc30fMfAAEDTAVfa7ADHT2egTb5xxy9RGlDCjGlma<font></font>
RxoL1LvxvYcfe48f44x/H+GVTM7dPaYyy9DozcJjt3l8EDxcD73d67cWOtDgQGixQEmBlYJO7Cvh<font></font>
IAfeCBywIrDMgWfCC80uEIX+WtSmt/PuI7OXMgsNG3yVZu2HXJvXFRmXvc6748uxr+Zh0uZnAqeL<font></font>
pkJB5K9H5qbMr4YM/Aig+<span class="hljs-number">7</span>MhwVG3KJ0kQCEhKxJe7+<span class="hljs-number">7</span>Un/jSGcwQ8HKa/<span class="hljs-number">90</span>ePzH2EXazm3T87pf2<font></font>
hXL/exl4L7hutt/MfDGjculaEOCaoDLlUJjJqeXJL3kFDUsiPFfEL/BwAYUqe2pJAMjWXn7YIUt7<font></font>
Y1DdTUD4ob/<span class="hljs-number">5</span>fwE9wQwfG6PfDLPFkrGVKFpkBa95sRuA7qgtXATacXAVzsfYMxZgbwF3RcI5IxQo<font></font>
HTgnCg57vWmM/u6swJrgkz+<span class="hljs-number">747</span>DWZRS1TfJZnKbdbmWIHAW11HG2FloKdWWSIronfqnuXTI/j2/R
<span class="hljs-number">9</span>hX1Uim6mQowBwjS5zHZY8WFU9xE1KgETkCTsaDZODg9NYTICKs5aAdujzAtzxLWSicHZCfmpgzd<font></font>
FRhqYTYE1B9wktZsItkssDaq+xlyTZ+<span class="hljs-number">0</span>LGnXAC6eaH7npS7w3NRBRj9ySVTRYPXBraVuJViMIX+U
<span class="hljs-number">4</span>IzHJDFSNiT818GtS7erlLKcbGn4OZ40Ee3XEiicFzVrOfOvH0rJT3LZgVqY+KMtjqaQike2P4Dd<font></font>
A0SOuqOlFgQitYoo</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Users </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have long noticed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that when the ionCube Loader module is loaded, two global functions with very strange names appear in PHP: </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;and </font></font><code>_dyuweyrj4r</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If you call one of these functions, then PHP will print one of the two Chinese aphorisms, and complete the execution: </font><font style="vertical-align: inherit;">
It can be seen that the output line does not depend on the called function, and is selected randomly. </font><font style="vertical-align: inherit;">
The question arises: why are these functions needed, and what do they do?</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(); echo 'Hmm..';"</b><br>
A rat who gnaws at a cat's tail invites destruction.<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(); echo 'Hmm..';"</b><br>
Do good, reap good; do evil, reap evil.<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4r(); echo 'Hmm..';"</b><br>
Do good, reap good; do evil, reap evil.</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple experiments</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, let's see what parameters it </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">takes: </font><font style="vertical-align: inherit;">
It looks like it takes two numbers, but no matter what numbers it prints the same aphorisms.</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(1,2,3);"</b><br>
PHP Warning: _dyuweyrj4() expects at most 2 parameters, 3 given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4('foo', 'bar');"</b><br>
PHP Warning: _dyuweyrj4() expects parameter 1 to be int, string given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(1, 'bar');"</b><br>
PHP Warning: _dyuweyrj4() expects parameter 2 to be int, string given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(1, 2);"</b><br>
A rat who gnaws at a cat's tail invites destruction.</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usage Search</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On some muddy Indonesian forum, I manage to find </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an example</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that was crammed in 2013 </font><font style="vertical-align: inherit;">&nbsp;- most likely, obtained by some PHP bytecode disassembler:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tconnect</span>(<span class="hljs-params"> </span>)
</span>{<font></font>
    $__tmp = _dyuweyrj4( <span class="hljs-number">21711392</span>, <span class="hljs-number">920173696</span> );
    <span class="hljs-keyword">return</span> $__tmp[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tvariable</span>(<span class="hljs-params"> </span>)
</span>{<font></font>
    $__tmp = _dyuweyrj4( <span class="hljs-number">21720496</span>, <span class="hljs-number">920165136</span> );
    <span class="hljs-keyword">return</span> $__tmp[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is interesting in pairs of numbers (21711392, 920173696) and (21720496, 920165136)? </font><font style="vertical-align: inherit;">An attentive researcher will notice that the XOR of numbers in each pair gives 932443808. Let's try to call </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a couple of numbers that give the result of XOR 932443808: </font><font style="vertical-align: inherit;">
Nothing was printed!</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(0, 932443808);"</b></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(932443808, 0);"</b></code><br>
<br>
<img src="https://habrastorage.org/webt/ap/ed/c8/apedc8vzemybnk6fcmzhfj3tiwu.png"><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diving into the debugger</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/kz/cy/_i/kzcy_i1kqfmexamdktae0lwhuuu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that an attempt is being made to read at the address </font></font><code>[ecx+40h]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, moreover, it </font></font><code>ecx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;is equal </font></font><code>0x3793f6a0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;to the number we passed to the function. This means that the function expects to receive the address value in the PHP process memory as a parameter, and it will </font></font><code>[ecx+40h]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;add one </font><font style="vertical-align: inherit;">to the dword at the address </font><font style="vertical-align: inherit;">(the command </font></font><code>inc dword ptr [eax]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;is visible just below the cache point). Let's try to pass such an address: for this, we pay attention that the address at which the main php.exe module is loaded does not change until Windows reboots. In my case it is </font></font><code>0x00980000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Opening php.exe in the IDA, we look at what data is available for rewriting: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/04/v4/fo/04v4foanwlcng6m_k0xopymi4ja.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an experiment, let's try to rewrite the first pointer in the structure </font></font><code>cli_sapi_module</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. There is a link to it from </font></font><code>main+22</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; when downloading php.exe at the address, </font></font><code>0x00980000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;this link will be located at</font></font><code>0x00982d63</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. So, </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;we need to pass a value </font><font style="vertical-align: inherit;">to the function </font><font style="vertical-align: inherit;">that is less by </font></font><code>0x40</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, i.e. </font></font><code>0x00982d23</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
Crash again; but in another function inside ioncube_loader_win_7.3.dll. More interestingly, the address at which the null pointer was read - </font><font style="vertical-align: inherit;">&nbsp;- has nothing to do with the value passed to the function. (It is ironic that checking for the null pointer - - </font><font style="vertical-align: inherit;">&nbsp;is carried out immediately </font><b><font style="vertical-align: inherit;">after</font></b><font style="vertical-align: inherit;"> &nbsp;accessing this pointer.) Having looked at the memory at the address </font><font style="vertical-align: inherit;">, we find the structure there </font><font style="vertical-align: inherit;">, i.e. function definition. It is most convenient to look inside it through the Immediate Window: </font><font style="vertical-align: inherit;">
As you can see, the null pointer that caused the crash is the field </font><font style="vertical-align: inherit;">&nbsp;in the function definition</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(0x00982d23, 0x00982d23 ^ 0x3793f6a0);"</b></code><br>
<br>
<img src="https://habrastorage.org/webt/kq/vd/n7/kqvdn7plaxnkhddfyucx_ktd_jk.png"><br>
<br><font style="vertical-align: inherit;"></font><code>0x14c32820+0x78</code><font style="vertical-align: inherit;"></font><code>test ebx, ebx</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>0x14c32820</code><font style="vertical-align: inherit;"></font><code>_zend_op_array</code><font style="vertical-align: inherit;"></font><br>
<br>
<code><b>(_zend_op_array*)0x14c32820</b><br>
0x14c32820 {type=0x01 '\x1' arg_flags=0x14c32821 "" fn_flags=0x00000100 ...}<br>
&nbsp; &nbsp; type: 0x01 '\x1'<br>
&nbsp; &nbsp; arg_flags: 0x14c32821 ""<br>
&nbsp; &nbsp; fn_flags: 0x00000100<br>
&nbsp; &nbsp; function_name: 0x06f66850 {gc={refcount=0x00000001 u={type_info=0x000001c6 } } h=0xacaf1bdb len=0x0000000a ...}<br>
&nbsp; &nbsp; scope: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; prototype: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; num_args: 0x00000000<br>
&nbsp; &nbsp; required_num_args: 0x00000000<br>
&nbsp; &nbsp; arg_info: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; cache_size: 0x131183d0<br>
&nbsp; &nbsp; last_var: 0x06ee0e98<br>
&nbsp; &nbsp; T: 0x00000000<br>
&nbsp; &nbsp; last: 0x00000000<br>
&nbsp; &nbsp; opcodes: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; run_time_cache: 0x00000000 {???}<br>
&nbsp; &nbsp; static_variables: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; vars: 0x00000000 {???}<br>
&nbsp; &nbsp; refcount: 0x600df45e {???}<br>
&nbsp; &nbsp; last_live_range: 0x88008c00<br>
&nbsp; &nbsp; last_try_catch: 0x00000001<br>
&nbsp; &nbsp; live_range: 0x00000100 {var=??? start=??? end=??? }<br>
&nbsp; &nbsp; try_catch_array: 0x14c2d958 {try_op=0x00000001 catch_op=0x000001c6 finally_op=0xddab5409 ...}<br>
&nbsp; &nbsp; filename: 0x14c1a538 {gc={refcount=0x00000001 u={type_info=0x14c00668 } } h=0x00000000 len=0x00000001 ...}<br>
&nbsp; &nbsp; line_start: 0x00000000<br>
&nbsp; &nbsp; line_end: 0x00000002<br>
&nbsp; &nbsp; doc_comment: 0x00000002 {gc={refcount=??? u={type_info=??? } } h=??? len=??? ...}<br>
&nbsp; &nbsp; last_literal: 0x714beccc<br>
&nbsp; &nbsp; literals: 0x71180110 {php7.dll!zif_xmlwriter_write_pi(_zend_execute_data *, _zval_struct *)} {value={lval=0x3314ec83 ...} ...}<br>
&nbsp; &nbsp; reserved: 0x14c3288c {0x06ee0bc0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}<br>
<br>
<b>((_zend_op_array*)0x14c32820)-&gt;function_name</b><br>
0x06f66850 {gc={refcount=0x00000001 u={type_info=0x000001c6 } } h=0xacaf1bdb len=0x0000000a ...}<br>
&nbsp; &nbsp; gc: {refcount=0x00000001 u={type_info=0x000001c6 } }<br>
&nbsp; &nbsp; h: 0xacaf1bdb<br>
&nbsp; &nbsp; len: 0x0000000a<br>
&nbsp; &nbsp; val: 0x06f66860 "_dyuweyrj4"<br>
<br>
<b>&amp;((_zend_op_array*)0)-&gt;reserved[3]</b><br>
0x00000078 {???}</code><br>
<br><font style="vertical-align: inherit;"></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Apparently, this field is used by ionCube Loader for some of its internal purposes. </font><font style="vertical-align: inherit;">To check, let's run the file from one line</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span> _dyuweyrj4(<span class="hljs-number">0x00982d23</span>, <span class="hljs-number">0x00982d23</span> ^ <span class="hljs-number">0x3793f6a0</span>);</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- through their </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Online PHP Encoder</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">(The result of encryption is given at the very beginning of the post.) Unfortunately, this does not help: it </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;remains zero. </font><font style="vertical-align: inherit;">But we make sure that the executing (nameless) function is </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">now populated:</font></font><br>
<br>
<code><b>executor_globals.current_execute_data-&gt;func-&gt;op_array</b><br>
{type=0x02 '\x2' arg_flags=0x14a72141 "" fn_flags=0x08000000 ...}<br>
&nbsp; &nbsp; type: 0x02 '\x2'<br>
&nbsp; &nbsp; arg_flags: 0x14a72141 ""<br>
&nbsp; &nbsp; fn_flags: 0x08000000<br>
&nbsp; &nbsp; function_name: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; scope: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; prototype: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; num_args: 0x00000000<br>
&nbsp; &nbsp; required_num_args: 0x00000000<br>
&nbsp; &nbsp; arg_info: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; cache_size: 0x00000004<br>
&nbsp; &nbsp; last_var: 0x00000000<br>
&nbsp; &nbsp; T: 0x00000001<br>
&nbsp; &nbsp; last: 0x00000005<br>
&nbsp; &nbsp; opcodes: 0x14a72280 {handler=0x999fc7ce op1={constant=0x00000000 var=0x00000000 num=0x00000000 ...} op2={constant=...} ...}<br>
&nbsp; &nbsp; run_time_cache: 0x14a74018 {0x14c27ba0}<br>
&nbsp; &nbsp; static_variables: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; vars: 0x00000000 {???}<br>
&nbsp; &nbsp; refcount: 0x14a74030 {0x00000002}<br>
&nbsp; &nbsp; last_live_range: 0x00000000<br>
&nbsp; &nbsp; last_try_catch: 0x00000000<br>
&nbsp; &nbsp; live_range: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; try_catch_array: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; filename: 0x14a66230 {gc={refcount=0x00000001 u={type_info=0x00000006 } } h=0x00000000 len=0x00000032 ...}<br>
&nbsp; &nbsp; line_start: 0x00200001<br>
&nbsp; &nbsp; line_end: 0x00000001<br>
&nbsp; &nbsp; doc_comment: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; last_literal: 0x00000005<br>
&nbsp; &nbsp; literals: 0x14a66280 {value={lval=0x0716a738 dval=5.875681226702e-316#DEN counted=0x0716a738 {gc={refcount=0x00000001 ...} } ...} ...}<br>
&nbsp; &nbsp; reserved: 0x14a721ac {0x00000000, 0x00000000, 0x00000000, 0x14a6b200, 0x00000000, 0x00000000}</code><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bug kicked out with a bug</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we can see, it is </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;filled only with encrypted functions. (This is not their only distinguishing feature: on the printout above, you can also notice </font></font><code>line_start=0x00200001</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;instead of a plausible line number.) On the other hand, the pointer to </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which comes into the crashed function is taken from the </font></font><code>execute_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one passed in the </font></font><code>_dyuweyrj4</code>&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implicit first parameter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;- so this </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;always corresponds to the called function , namely, itself </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This function is not encrypted, and therefore it </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;will always be zero. We conclude from this: a call </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;with the ‚Äúcorrect‚Äù parameters </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inevitably leads to a crash</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;(and with the wrong ones, as we saw - to the press of Chinese aphorisms). The great thing about this is that the resulting crash is not intentional, but rather called using a null pointer before checking it. Such a bug in the code would catch any static analysis tool; but apparently, they do not use anything like this in ionCube. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What happens if I fix a bug in ioncube_loader_win_7.3.dll by setting a pointer check before using it? For this, it is most convenient to use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x64dbg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j1/mh/zd/j1mhzdzqh5k-lgme_k8awtppxw0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We start </font></font><code>php -r "_dyuweyrj4(0x00982d23, 0x00982d23 ^ 0x3793f6a0);"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;with the patched ionCube Loader, and ... we get the crash in a new place - again when using the null pointer from </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/al/nx/jialnxbvufmj0dvqgc2s19thaxs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that there was no sense from a (incorrect) check for a null pointer: in the next function called, the same pointer is used without checking. </font><font style="vertical-align: inherit;">We conclude that a potential vulnerability that would allow us to modify the memory of the PHP process at an arbitrary address and thereby escape from the sandbox ‚Äî for example, call functions that are not allowed by the server administrator ‚Äî is closed in ionCube Loader by a sequence of bugs that lead to the unintended php.exe cache .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What did the author mean?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I believe that initially it </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;appeared in order to bind some formally correct array of </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cover-ups </font><font style="vertical-align: inherit;">to encrypted functions </font><font style="vertical-align: inherit;">- because ionCube Loader is far from the only extension module that will crawl into these arrays. (One of the common cases when extensions get into </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">function s is to cache these </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s between runs of the same script; the other is PHP disassemblers, like the output from the Indonesian forum.) As an argument, I </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;got a pointer to an </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;encrypted one functions, and passed control to the decryptor, with which ionCube Loader replaces the standard function </font></font><code>zend_execute_ex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The only scenario where it </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;could be called is if the extraneous extension module caches "</font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cover-ups separately from the encrypted function, and then tries </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to execute </font><font style="vertical-align: inherit;">these- </font><font style="vertical-align: inherit;">s. In this case, a call </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;with a pointer to the </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;encrypted function will turn into a decryption and launch of this function itself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When switching to PHP 7 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;ABI of the extension functions </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">changed</font></a><font style="vertical-align: inherit;"> : instead of four implicit parameters </font></font><code>ht, return_value_ptr, this_ptr, return_value_used</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;, The structure is used </font></font><code>_zend_execute_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Here, ionCube programmers are confused because they </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;now receive two pointers to </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: one through the field </font></font><code>_zend_execute_data.func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the second by the parameter passed explicitly. The first corresponds to the </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">second, the encrypted function that needs to be called. And here we see another bug: incrementing the field </font></font><code>refcount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;encrypted function, </font></font><code>_dyuweyrj4</code>&nbsp;<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completely forgets about it</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and further works only with its own </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Naturally, an attempt to call an extension function, as if it were an encrypted PHP function, leads to a crash - and it‚Äôs good that it doesn‚Äôt </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;cause </font><font style="vertical-align: inherit;">infinite recursion, because it </font><font style="vertical-align: inherit;">tries to call itself! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The question arises: how did the QA in ionCube miss the function that was never able to work as intended? </font><font style="vertical-align: inherit;">The fact that it did not fall into the test plan is also evident because in the 64-bit version of ionCube Loader the parameters  </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;remain 32-bit - this means that the pointer to the </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;encrypted function is truncated to 32 bits even before the increment </font></font><code>refcount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and that crash, which we caught the very first, guaranteed to happen at all with any call </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/gu/ab/cg/guabcgmwuqoopx1ar80sjpz6keq.png"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/de/0y/l-/de0yl-6ppopvisr_a80b4yuhjj8.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en506872/index.html">Book Spring Boot 2: Best Practices for Professionals</a></li>
<li><a href="../en506874/index.html">From the life of a programmer: Business people</a></li>
<li><a href="../en506880/index.html">Joel Spolsky: how the Stack Overflow era began</a></li>
<li><a href="../en506886/index.html">Life hack for bits</a></li>
<li><a href="../en506888/index.html">Sorting cheat sheet for Data Science</a></li>
<li><a href="../en506896/index.html">The most realistic interpretation of quantum mechanics</a></li>
<li><a href="../en506902/index.html">Smart home in a smart city</a></li>
<li><a href="../en506906/index.html">Black hole paradoxes reveal the fundamental connection between energy and order</a></li>
<li><a href="../en506908/index.html">Top science. May media ten: desperation of aquarium fish, voices of mental disorders and many times COVID</a></li>
<li><a href="../en506916/index.html">What is a Service Mesh?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>