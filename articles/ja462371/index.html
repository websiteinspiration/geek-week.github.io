<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏽 👩🏼‍🎨 📃 Spring StateMachineを起動する 🌓 🎅🏿 🦈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 私が出会ったプロジェクトでは、有限オートマトンの理論に関連する何らかの方法で3つの例に出会いました
 
 

- 例1. 面白いgovnokod コード。何が起こっているのかを理解するには、かなりの時間がかかります。コードに示された理論の実施形態の特徴は、かなり激しいダンプであり、場合によ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Spring StateMachineを起動する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462371/"><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が出会ったプロジェクトでは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、有限オートマトンの理論に関連する何らかの</font></a><font style="vertical-align: inherit;">方法で3つの例に出会いました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">面白い</font></font></b><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">govnokod </font></font></s> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">何が起こっているのかを理解するには、かなりの時間がかかります。</font><font style="vertical-align: inherit;">コードに示された理論の実施形態の特徴は、かなり激しいダンプであり、場合によっては、手続き型コードに非常に似ています。</font><font style="vertical-align: inherit;">このバージョンのコードがプロジェクトに触れない方がよいという事実は、すべての技術者、方法論者、および製品スペシャリストを知っています。</font><font style="vertical-align: inherit;">彼らは、緊急時に（完全に壊れたとき）何かを修正するためにこのコードを使用します。機能を完成させることは間違いありません。</font><font style="vertical-align: inherit;">壊れるのが怖いからです。</font><font style="vertical-align: inherit;">このタイプを分離する2番目の印象的な機能は、そのような強力なスイッチ、フルスクリーンの存在です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このスコアには冗談さえあります：</font></font><a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適サイズ</font></font></b><div class="spoiler_text">    JPoint,   ,      ,    switch ,   - «   ».       switch     ,       IDE<br>
</div></div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例2. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パターンの状態</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">（リンクをたどらないのが好きな人のための）主なアイデアは、特定のビジネスタスクを一連の最終状態に分割し、それらをコードで説明することです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パターンステートの主な欠点は、州がお互いについて知っていること、兄弟がいることを知っていること、お互いを呼び出すことです。</font><font style="vertical-align: inherit;">このようなコードを一般化することは非常に困難です。</font><font style="vertical-align: inherit;">たとえば、いくつかのタイプの支払いを伴う支払いシステムを実装する場合、Generic-sを掘り下げるリスクが高まるため、メソッドの宣言は次のようになります。</font></font><cut></cut><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">private</span> &lt;<font></font>
      T extends BaseContextPayment,<font></font>
      Q extends BaseDomainPaymentRequest,<font></font>
      S,<font></font>
      B extends AbstractPaymentDetailBuilder&lt;T, Q, S, B&gt;,<font></font>
      F extends AbstractPaymentBuilder&lt;T, Q, S, B&gt;<font></font>
      &gt; <span class="hljs-function">PaymentContext&lt;T, S&gt; <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Q request, <span class="hljs-keyword">final</span> Class&lt;F&gt; factoryClass)</span></span>{
<span class="hljs-comment">//"" </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
状態の要約：実装により、コードがかなり複雑になる可能性があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例3 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StateMachine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パターンの主な考え方は、状態がお互いについて何も知らないということです。遷移制御はコンテキストによって実行されます。それは、接続性が良く、接続が少ないということです。コードは単純です。</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のタイプのすべての「パワー」と2番目のタイプのすべての複雑さを経験したので、新しいビジネスケースにパターンステートマシンを使用することにしました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼の自転車を再発明しないために、ステートマシンスプリングをベースにすることが決定されました（これはスプリングです）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ドックを読んだ後、私はYouTubeとHabrに行きました（人々がそれをどのように扱うか、それが製品でどのように感じられるか、どんな種類の熊手かなどを理解するために）。情報がほとんどないことがわかりました。</font><font style="vertical-align: inherit;">この主題に関するハブレで、私はビデオだけでなく、1つの記事だけを非常に表面的に見つけました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ある記事では、Springステートマシンの細かい作業をすべて説明することはできません。ドックを回ってすべてのケースを説明することはできませんが、フレームワークに精通したときに、最も重要で要求されていること、特にレーキについて、フレームワークに慣れたときに説明します。以下の情報はとても役に立ちます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要部分</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spring Bootアプリケーションを作成し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Webスターター</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">を</font></a><font style="vertical-align: inherit;">追加します（Webアプリケーションをできるだけ速く実行します）アプリケーションは、購入プロセスの抽象化です。購入時の製品は、新規、予約済み、予約済みの拒否および購入完了の段階を経ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し即興ですが、実際のプロジェクトにはより多くのステータスがありますが、まあ、非常に現実的なプロジェクトもあります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しくベイクされたWebアプリケーションのpom.xmlで、依存関係をマシンとそのテストに追加します（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start.spring.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を介して収集された場合、Web Starterはすでに存在しているはず</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です</font></a><font style="vertical-align: inherit;">）。</font></font><br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.statemachine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-statemachine-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.statemachine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-statemachine-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">cut</span> /&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構造を作成しましょう</font></font><br>
<img src="https://habrastorage.org/webt/u8/nw/oq/u8nwoqaezenqp1pouozil4qjwno.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。今のところ、この構造についてあまり詳しく説明する必要はありません。すべてを順番に説明し、記事の最後にソースへのリンクがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
じゃ、行こう。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要な依存関係を備えたクリーンなプロジェクトがあります。まず、状態とイベントを含む列挙型を作成します。かなり単純な抽象化であり、これらのコンポーネント自体にはロジックがありません。</font></font><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> PurchaseEvent {<font></font>
   RESERVE, BUY, RESERVE_DECLINE<font></font>
}</code></pre><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> PurchaseState {<font></font>
    NEW, RESERVED, CANCEL_RESERVED, PURCHASE_COMPLETE<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正式にではありますが、これらの列挙型にフィールドを追加して、たとえば、特定の状態に典型的な何かをハードコードすることができます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Java構成を介してマシンを構成し、構成ファイルを作成し、拡張クラスEnumStateMachineConfigurerAdapter &lt;PurchaseState、PurchaseEvent&gt;を使用します。私たちの状態とイベントは列挙型であるため、インターフェースは適切ですが、必須ではありません。任意のタイプのオブジェクトを汎用として使用できます（この記事では、EnumStateMachineConfigurerAdapterで十分すぎるため、他の例は考慮しません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の重要なポイントは、1つのマシンがアプリケーションコンテキストに存在するかどうかです。つまり、@ EnableStateMachineの単一のインスタンスに存在するか、新しい@EnableStateMachineFactoryが作成されるたびにです。</font><font style="vertical-align: inherit;">これが多数のユーザーを持つマルチユーザーWebアプリケーションである場合、最初のオプションはあまり適していません。そのため、2番目のオプションをより人気のあるものとして使用します。</font><font style="vertical-align: inherit;">StateMachineは、通常のBeanとしてビルダーを介して作成することもできます（ドキュメントを参照）。これは、場合によっては便利です（たとえば、マシンを明示的にBeanとして宣言する必要がある場合）。それが別のBeanの場合は、スコープを指定できます。例：セッションまたはリクエスト。</font><font style="vertical-align: inherit;">このプロジェクトでは、ラッパーはステートマシンBean（ビジネスロジックの機能）上に実装され、ラッパーはシングルトンであり、プロトタイプマシン自体が</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レーキ</font></font></b><div class="spoiler_text">  prototype  singlton-?<br>
               bean  applicationContext. Inject- applicationContext  - ,  bean statemachine         ,   (method injection),    java —      ,        applicationContext  bean.   config    applicationContext  ,          .getBean();<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EnumStateMachineConfigurerAdapterクラスにはいくつかのメソッドがあり、マシンの構成をオーバーライドします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ステータスを登録します。</font></font><br>
<pre><code class="java hljs">    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(<span class="hljs-keyword">final</span> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        states<font></font>
                .withStates()<font></font>
                .initial(NEW)<font></font>
                .end(PURCHASE_COMPLETE)<font></font>
                .states(EnumSet.allOf(PurchaseState.class));<font></font>
<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初期（NEW）は、Beanが作成された後のマシンのステータスです。終了（PURCHASE_COMPLETE）は、マシンがstatemachine.stop（）を実行することによるステータスです。 。</font><font style="vertical-align: inherit;">すべてのステータスの.states（EnumSet.allOf（PurchaseState.class）リスト）、一括で押し出すことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マシンのグローバル設定を構成します</font></font><br>
<pre><code class="java hljs">    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(<span class="hljs-keyword">final</span> StateMachineConfigurationConfigurer&lt;PurchaseState, PurchaseEvent&gt; config)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        config<font></font>
                .withConfiguration()<font></font>
                .autoStartup(<span class="hljs-keyword">true</span>)<font></font>
                .listener(<span class="hljs-keyword">new</span> PurchaseStateMachineApplicationListener());<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでautoStartupは、デフォルトで作成直後にマシンを起動するかどうか、つまり、マシンが自動的にNEWステータス（デフォルトではfalse）に切り替わるかどうかを決定します。すぐに、マシンコンテキストのリスナーを登録し（少し後で）、同じ構成で別のTaskExecutorを設定できます。これは、遷移の一部で長いアクションが実行され、アプリケーションがさらに進む必要がある場合に便利です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、トランジション自体：</font></font><br>
<pre><code class="java hljs">    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(<span class="hljs-keyword">final</span> StateMachineTransitionConfigurer&lt;PurchaseState, PurchaseEvent&gt; transitions)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        transitions<font></font>
                .withExternal()<font></font>
                .source(NEW)<font></font>
                .target(RESERVED)<font></font>
                .event(RESERVE)<font></font>
                .action(reservedAction(), errorAction())<font></font>
<font></font>
                .and()<font></font>
                .withExternal()<font></font>
                .source(RESERVED)<font></font>
                .target(CANCEL_RESERVED)<font></font>
                .event(RESERVE_DECLINE)<font></font>
                .action(cancelAction(), errorAction())<font></font>
<font></font>
                .and()<font></font>
                .withExternal()<font></font>
                .source(RESERVED)<font></font>
                .target(PURCHASE_COMPLETE)<font></font>
                .event(BUY)<font></font>
                .guard(hideGuard())<font></font>
                .action(buyAction(), errorAction());<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
遷移または遷移のすべてのロジックがここで設定されます。Guardは、常にブール値を返すコンポーネントである遷移に掛けることができます。状況に応じて、あるステータスから別のステータスへの遷移を正確にチェックします。すべてのロジックはGuardで完璧です。これは完全に通常のコンポーネントです。しかし、彼はブール値を返さなければなりません。たとえば、プロジェクトのフレームワーク内で、HideGuardはユーザーが設定できる特定の設定をチェックし（この製品を表示しない）、それに従って、マシンをGuardで保護された状態にすることができません。 Guardでは、構成内の1つの遷移に追加できるのは1つだけです。そのような設計は機能しません。</font></font><br>
<pre><code class="java hljs">   .withExternal()<font></font>
                .source(RESERVED)<font></font>
                .target(PURCHASE_COMPLETE)<font></font>
                .event(BUY)<font></font>
                .guard(hideGuard())<font></font>
                .guard(veryHideGuard())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より正確には、それは機能しますが、最初のガード（hideGuard（））のみ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ですが、いくつかの</font><font style="vertical-align: inherit;">アクション</font><font style="vertical-align: inherit;">を追加できます</font><font style="vertical-align: inherit;">（</font><font style="vertical-align: inherit;">ここでは、遷移構成で規定するアクションについて話しています）、私は個人的に1つの遷移に3つのアクションを追加しようとしました。</font></font><br>
<pre><code class="java hljs">                .withExternal()<font></font>
                .source(NEW)<font></font>
                .target(RESERVED)<font></font>
                .event(RESERVE)<font></font>
                .action(reservedAction(), errorAction())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の引数はErrorActionであり、ReservedActionが例外をスローした場合（をスロー）、コントロールがそれに到達します。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レーキ</font></font></b><div class="spoiler_text">  ,     Action,  -  ,  try/catch,   ErrorAction    ,      -  ErrorAction     catch RuntimeException(), (      ).<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
遷移の「ハング」アクションに加えて、次のような状態の構成メソッドでアクションを「ハング」することもできます。</font></font><br>
<pre><code class="java hljs">    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(<span class="hljs-keyword">final</span> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        states<font></font>
                .withStates()<font></font>
                .initial(NEW)<font></font>
                .end(PURCHASE_COMPLETE)<font></font>
                .stateEntry()<font></font>
                .stateExit()<font></font>
                .state()<font></font>
                .states(EnumSet.allOf(PurchaseState.class));<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それはすべて、アクションの実行方法に依存します。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レーキ</font></font></b><div class="spoiler_text">,     action   state(),  <br>
<pre><code class="java hljs">        states<font></font>
                .withStates()<font></font>
                .initial(NEW)<font></font>
                .end(PURCHASE_COMPLETE)<font></font>
                .state(randomAction())</code></pre><br>
   ,       .stateEntry(),  Action      ,     .state()  Action      state,      .<br>
      Action  transition ,         .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
configの最終バージョンは次のようになります。</font></font><br>
<pre><code class="java hljs"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableStateMachineFactory</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StateMachineConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EnumStateMachineConfigurerAdapter</span>&lt;<span class="hljs-title">PurchaseState</span>, <span class="hljs-title">PurchaseEvent</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(<span class="hljs-keyword">final</span> StateMachineConfigurationConfigurer&lt;PurchaseState, PurchaseEvent&gt; config)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        config<font></font>
                .withConfiguration()<font></font>
                .autoStartup(<span class="hljs-keyword">true</span>)<font></font>
                .listener(<span class="hljs-keyword">new</span> PurchaseStateMachineApplicationListener());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(<span class="hljs-keyword">final</span> StateMachineStateConfigurer&lt;PurchaseState, PurchaseEvent&gt; states)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        states<font></font>
                .withStates()<font></font>
                .initial(NEW)<font></font>
                .end(PURCHASE_COMPLETE)<font></font>
                .stateEntry()<font></font>
                .stateExit()<font></font>
                .state()<font></font>
                .states(EnumSet.allOf(PurchaseState.class));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(<span class="hljs-keyword">final</span> StateMachineTransitionConfigurer&lt;PurchaseState, PurchaseEvent&gt; transitions)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        transitions<font></font>
                .withExternal()<font></font>
                .source(NEW)<font></font>
                .target(RESERVED)<font></font>
                .event(RESERVE)<font></font>
                .action(reservedAction(), errorAction())<font></font>
<font></font>
                .and()<font></font>
                .withExternal()<font></font>
                .source(RESERVED)<font></font>
                .target(CANCEL_RESERVED)<font></font>
                .event(RESERVE_DECLINE)<font></font>
                .action(cancelAction(), errorAction())<font></font>
<font></font>
                .and()<font></font>
                .withExternal()<font></font>
                .source(RESERVED)<font></font>
                .target(PURCHASE_COMPLETE)<font></font>
                .event(BUY)<font></font>
                .guard(hideGuard())<font></font>
                .action(buyAction(), errorAction());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Action&lt;PurchaseState, PurchaseEvent&gt; <span class="hljs-title">reservedAction</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ReservedAction();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Action&lt;PurchaseState, PurchaseEvent&gt; <span class="hljs-title">cancelAction</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CancelAction();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Action&lt;PurchaseState, PurchaseEvent&gt; <span class="hljs-title">buyAction</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BuyAction();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Action&lt;PurchaseState, PurchaseEvent&gt; <span class="hljs-title">errorAction</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ErrorAction();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Guard&lt;PurchaseState, PurchaseEvent&gt; <span class="hljs-title">hideGuard</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HideGuard();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> StateMachinePersister&lt;PurchaseState, PurchaseEvent, String&gt; <span class="hljs-title">persister</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultStateMachinePersister&lt;&gt;(<span class="hljs-keyword">new</span> PurchaseStateMachinePersister());<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マシンのスキームに注意してください。正確にエンコードしたもの（どのイベントが有効であるか、どのGuardがステータスを保護するか、ステータスが切り替えられたときに何が実行されるか、どのアクションか）が非常に明確にわかります。</font></font><br>
<img src="https://habrastorage.org/webt/l8/2z/2v/l82z2v6pwdaudcrvdpqi99xw48s.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラーを作ってみましょう：</font></font><br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@SuppressWarnings("unused")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PurchaseController</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PurchaseService purchaseService;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PurchaseController</span><span class="hljs-params">(PurchaseService purchaseService)</span> </span>{
        <span class="hljs-keyword">this</span>.purchaseService = purchaseService;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@RequestMapping(path = "/reserve")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">reserve</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String userId, <span class="hljs-keyword">final</span> String productId)</span> </span>{
        <span class="hljs-keyword">return</span> purchaseService.reserved(userId, productId);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@RequestMapping(path = "/cancel")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">cancelReserve</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String userId)</span> </span>{
        <span class="hljs-keyword">return</span> purchaseService.cancelReserve(userId);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@RequestMapping(path = "/buy")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">buyReserve</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String userId)</span> </span>{
        <span class="hljs-keyword">return</span> purchaseService.buy(userId);<font></font>
    }<font></font>
<font></font>
}</code></pre><br>
<cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスインターフェース</font></font><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PurchaseService</span> </span>{
    <span class="hljs-comment">/**
     *    ,         
     *
     * <span class="hljs-doctag">@param</span> userId    id ,    ,      id 
     *                     http-
     * <span class="hljs-doctag">@param</span> productId id ,    
     * <span class="hljs-doctag">@return</span> /  ,            
     *      .
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">reserved</span><span class="hljs-params">(String userId, String productId)</span></span>;<font></font>
<font></font>
    <span class="hljs-comment">/**
     *   /   
     *
     * <span class="hljs-doctag">@param</span> userId id ,    ,      id 
     *                  http-
     * <span class="hljs-doctag">@return</span> /  ,            
     *      .
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">cancelReserve</span><span class="hljs-params">(String userId)</span></span>;<font></font>
<font></font>
    <span class="hljs-comment">/**
     *    
     *
     * <span class="hljs-doctag">@param</span> userId id ,    ,      id 
     *                  http-
     * <span class="hljs-doctag">@return</span> /  ,            
     *      .
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">buy</span><span class="hljs-params">(String userId)</span></span>;<font></font>
}</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レーキ</font></font></b><div class="spoiler_text">  ,    Spring   bean  ?    ( -      ),      -implement-    . Spring    ,        ,      CGLIB,      -  — Spring     dynamic-,         NoSuchBeanDefinitionException.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の重要なポイントは、マシンの状態をどのように復元するかです。これは、呼び出しごとに、マシンとそのコンテキストの以前のステータスをまったく知らない新しいBeanが作成されるためです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの目的のために、スプリングステートマシンにはPersistensメカニズムがあります。</font></font><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PurchaseStateMachinePersister</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">StateMachinePersist</span>&lt;<span class="hljs-title">PurchaseState</span>, <span class="hljs-title">PurchaseEvent</span>, <span class="hljs-title">String</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;String, StateMachineContext&lt;PurchaseState, PurchaseEvent&gt;&gt; contexts = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-keyword">final</span> StateMachineContext&lt;PurchaseState, PurchaseEvent&gt; context, String contextObj)</span> </span>{<font></font>
        contexts.put(contextObj, context);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> StateMachineContext&lt;PurchaseState, PurchaseEvent&gt; <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String contextObj)</span> </span>{
        <span class="hljs-keyword">return</span> contexts.get(contextObj);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの素朴な実装では、通常のMapを状態ストアとして使用します。非素朴な実装では、それはある種のデータベースになります。3番目のジェネリック型Stringに注意してください。これは、マシンの状態を保存するためのキーであり、すべてのステータス、コンテキスト内の変数、idを含みます。等 </font><font style="vertical-align: inherit;">私の例では、保存キーにユーザーIDを使用しましたが、これは完全に任意のキー（ユーザーsession_id、一意のログインなど）にすることができます。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レーキ</font></font></b><div class="spoiler_text">            ,             job,      . <br>
      ,   InitAction        ,    ,     event,     :<br>
<pre><code class="java hljs">stateMachine<font></font>
                .getStateMachineAccessor()<font></font>
                .doWithAllRegions(access -&gt; {<font></font>
                    access.resetStateMachine(<span class="hljs-keyword">new</span> DefaultStateMachineContext&lt;&gt;({ResetState}, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));<font></font>
                });<font></font>
stateMachine.start();<font></font>
stateMachine.sendEvent({NewEventFromResetState});</code></pre> <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各メソッドでのサービスの実装を検討します。</font></font><br>
<pre><code class="java hljs">    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">reserved</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String userId, <span class="hljs-keyword">final</span> String productId)</span> </span>{
        <span class="hljs-keyword">final</span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine();<font></font>
        stateMachine.getExtendedState().getVariables().put(<span class="hljs-string">"PRODUCT_ID"</span>, productId);<font></font>
        stateMachine.sendEvent(RESERVE);<font></font>
        <span class="hljs-keyword">try</span> {<font></font>
            persister.persist(stateMachine, userId);<font></font>
        } <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> Exception e) {<font></font>
            e.printStackTrace();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは工場から車を取得し、パラメーターをマシンコンテキストに入れます。この場合、それはproductIdです。コンテキストは、ステートマシンBeanまたはそのコンテキストにアクセスできる場所ならどこにでも入れることができる一種のボックスです。 、その後、スタート後、当店の車はNEW状態となり、商品の予約時にイベントを投げます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残りの2つの方法は似ています。</font></font><br>
<pre><code class="java hljs">    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">cancelReserve</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String userId)</span> </span>{
        <span class="hljs-keyword">final</span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine();
        <span class="hljs-keyword">try</span> {<font></font>
            persister.restore(stateMachine, userId);<font></font>
            stateMachine.sendEvent(RESERVE_DECLINE);<font></font>
        } <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
            e.printStackTrace();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">buy</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String userId)</span> </span>{
        <span class="hljs-keyword">final</span> StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine = stateMachineFactory.getStateMachine();
        <span class="hljs-keyword">try</span> {<font></font>
            persister.restore(stateMachine, userId);<font></font>
            stateMachine.sendEvent(BUY);<font></font>
        } <span class="hljs-keyword">catch</span> (Exception e) {<font></font>
            e.printStackTrace();<font></font>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、最初に特定のユーザーのuserIdのマシンの状態を復元し、次にapiメソッドに対応するイベントをスローします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
productIdはメソッドに表示されなくなりました。これをマシンのコンテキストに追加し、バックアップからマシンを復元した後に取得します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アクションの実装では、マシンコンテキストから製品IDを取得し、遷移に対応するメッセージをログに表示します。たとえば、コードReservedActionを指定します。</font></font><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReservedAction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Action</span>&lt;<span class="hljs-title">PurchaseState</span>, <span class="hljs-title">PurchaseEvent</span>&gt; </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(StateContext&lt;PurchaseState, PurchaseEvent&gt; context)</span> </span>{
        <span class="hljs-keyword">final</span> String productId = context.getExtendedState().get(<span class="hljs-string">"PRODUCT_ID"</span>, String.class);<font></font>
        System.out.println("   " + productId + " .");<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはリスナーに言及せざるを得ません。リスナーには、すぐに使えるかなりの数のスクリプトが用意されています。自分で確認してください。</font></font><br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PurchaseStateMachineApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">StateMachineListener</span>&lt;<span class="hljs-title">PurchaseState</span>, <span class="hljs-title">PurchaseEvent</span>&gt; </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stateChanged</span><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; from, State&lt;PurchaseState, PurchaseEvent&gt; to)</span> </span>{
        <span class="hljs-keyword">if</span> (from.getId() != <span class="hljs-keyword">null</span>) {<font></font>
            System.out.println(<span class="hljs-string">"   "</span> + from.getId() + <span class="hljs-string">"   "</span> + to.getId());<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stateEntered</span><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; state)</span> </span>{<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stateExited</span><span class="hljs-params">(State&lt;PurchaseState, PurchaseEvent&gt; state)</span> </span>{<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eventNotAccepted</span><span class="hljs-params">(Message&lt;PurchaseEvent&gt; event)</span> </span>{<font></font>
        System.out.println(<span class="hljs-string">"   "</span> + event);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transition</span><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span> </span>{<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transitionStarted</span><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span> </span>{<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transitionEnded</span><span class="hljs-params">(Transition&lt;PurchaseState, PurchaseEvent&gt; transition)</span> </span>{<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stateMachineStarted</span><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine)</span> </span>{<font></font>
        System.out.println(<span class="hljs-string">"Machine started"</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stateMachineStopped</span><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine)</span> </span>{<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stateMachineError</span><span class="hljs-params">(StateMachine&lt;PurchaseState, PurchaseEvent&gt; stateMachine, Exception exception)</span> </span>{<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">extendedStateChanged</span><span class="hljs-params">(Object key, Object value)</span> </span>{<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stateContext</span><span class="hljs-params">(StateContext&lt;PurchaseState, PurchaseEvent&gt; stateContext)</span> </span>{<font></font>
<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
唯一の問題は、これがインターフェースであることです。つまり、これらすべてのメソッドを実装する必要がありますが、すべてを必要とすることはほとんどないため、一部のメソッドは空にハングし、カバレッジはメソッドがテストでカバーされていないことを示します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、lisenerで、マシンの完全に異なるイベントに関する絶対的なメトリックをぶら下げることができます（たとえば、支払いが実行されない、マシンが何らかのPAYMENT_FAILステータスに入る、遷移をリッスンする、マシンが誤ったステータスになった場合-奇数のログに書き込む、またはベース、または警察に電話します。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レーキ</font></font></b><div class="spoiler_text"> lisener-e  event stateMachineError,    ,           catch,      ,  catch    <br>
stateMachine.setStateMachineError(exception)   .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何をしたかを確認するために、2つのケースを実行します。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.予約およびその後の購入の拒否。</font><font style="vertical-align: inherit;">パラメータuserId = 007、productId = 10001を使用して、アプリケーションにURI "/ reserve"のリクエストを送信します。その後、パラメータuserId = 007を使用したリクエスト "/ cancel"のコンソール出力は次のようになります。</font></font><br>
<code>Machine started<br>
   10001 .<br>
   NEW   RESERVED<br>
Machine started<br>
  10001 <br>
   RESERVED   CANCEL_RESERVED</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.予約と購入の成功：</font></font><br>
<code>Machine started<br>
   10001 .<br>
   NEW   RESERVED<br>
Machine started<br>
   10001  <br>
   RESERVED   PURCHASE_COMPLETE</code></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結論として、フレームワークのテストの例を示します。コードからすべてが明らかになると思います。テストマシンへの依存関係が必要なだけで、構成を宣言的に確認できます。</font></font><br>
<pre><code class="java hljs">   <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWhenReservedCancel</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        StateMachine&lt;PurchaseState, PurchaseEvent&gt; machine = factory.getStateMachine();<font></font>
        StateMachineTestPlan&lt;PurchaseState, PurchaseEvent&gt; plan =<font></font>
                StateMachineTestPlanBuilder.&lt;PurchaseState, PurchaseEvent&gt;builder()<font></font>
                        .defaultAwaitTime(<span class="hljs-number">2</span>)<font></font>
                        .stateMachine(machine)<font></font>
                        .step()<font></font>
                        .expectStates(NEW)<font></font>
                        .expectStateChanged(<span class="hljs-number">0</span>)<font></font>
                        .and()<font></font>
                        .step()<font></font>
                        .sendEvent(RESERVE)<font></font>
                        .expectState(RESERVED)<font></font>
                        .expectStateChanged(<span class="hljs-number">1</span>)<font></font>
                        .and()<font></font>
                        .step()<font></font>
                        .sendEvent(RESERVE_DECLINE)<font></font>
                        .expectState(CANCEL_RESERVED)<font></font>
                        .expectStateChanged(<span class="hljs-number">1</span>)<font></font>
                        .and()<font></font>
                        .build();<font></font>
        plan.test();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWhenPurchaseComplete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        StateMachine&lt;PurchaseState, PurchaseEvent&gt; machine = factory.getStateMachine();<font></font>
        StateMachineTestPlan&lt;PurchaseState, PurchaseEvent&gt; plan =<font></font>
                StateMachineTestPlanBuilder.&lt;PurchaseState, PurchaseEvent&gt;builder()<font></font>
                        .defaultAwaitTime(<span class="hljs-number">2</span>)<font></font>
                        .stateMachine(machine)<font></font>
                        .step()<font></font>
                        .expectStates(NEW)<font></font>
                        .expectStateChanged(<span class="hljs-number">0</span>)<font></font>
                        .and()<font></font>
                        .step()<font></font>
                        .sendEvent(RESERVE)<font></font>
                        .expectState(RESERVED)<font></font>
                        .expectStateChanged(<span class="hljs-number">1</span>)<font></font>
                        .and()<font></font>
                        .step()<font></font>
                        .sendEvent(BUY)<font></font>
                        .expectState(PURCHASE_COMPLETE)<font></font>
                        .expectStateChanged(<span class="hljs-number">1</span>)<font></font>
                        .and()<font></font>
                        .build();<font></font>
        plan.test();<font></font>
    }</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レーキ</font></font></b><div class="spoiler_text">         ,  unit-,      builder( c ),         action  guard,     ,       mock-,        Action ,  ,    ,   .<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのマシンは生産ベースで動作し、これまで運用上の問題は発生していません。新しいマシンを実装するときに現在のマシンのコンポーネントの大部分を使用できる機能が登場します（Guardといくつかのアクションは完璧です）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事では考慮しませんでしたが、そのような機会については触れておきたいと思います。これは、Guardがケースにハングアップし、マシンが交互にその状態に移行しようとする切り替えの原則に従って機能する一種のトリガーです。一部のイベントがなければ、マシンを初期化するときに、ある種の疑似ホストに自動的に切り替える必要がある場合に便利です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doca </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462355/index.html">非同期JavaScriptプログラミング（コールバック、プロミス、RxJ）</a></li>
<li><a href="../ja462357/index.html">最初のプロトタイプ：Linuxの進化の段階としてのユニカーネル</a></li>
<li><a href="../ja462359/index.html">DAT-どのようなプロトコルであり、誰が使用するか</a></li>
<li><a href="../ja462365/index.html">機械学習の制限</a></li>
<li><a href="../ja462367/index.html">創設者のためのベンチャーキャピタリズムに関する13の事実</a></li>
<li><a href="../ja462377/index.html">Enter The Gungeonでダンジョンが生成される方法</a></li>
<li><a href="../ja462379/index.html">構成ファイルの暗号化</a></li>
<li><a href="../ja462381/index.html">ニューラルネットワークとディープラーニング、第5章：なぜディープニューラルネットワークのトレーニングがそれほど難しいのですか？</a></li>
<li><a href="../ja462383/index.html">ダゲスタンの倉庫から-プログラマーへ：私がゼロからiOS開発者になった経緯</a></li>
<li><a href="../ja462385/index.html">新しいアプローチは、浮動小数点計算を取り除くのに役立ちます</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>