<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‼️ 🎓 👋🏽 CCDルーラー：一緒に食べるもの ☃️ 🚵🏾 🙀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、リニアCCD光検出器を使用した経験を紹介します。そのようなCCDラインは、その場しのぎの分光計、バーコードリーダー、レーザービーム位置または偏差センサー、写真またはフィルム用スキャナーなどの設計に使用できます。私の場合、それはレーザースキャナーでしたが、ネットワークでは説明できません。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CCDルーラー：一緒に食べるもの</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457762/"><img src="https://habrastorage.org/webt/6f/ss/-0/6fss-0mg8davzerthbljhhg9ora.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、リニアCCD光検出器を使用した経験を紹介します。</font><font style="vertical-align: inherit;">そのようなCCDラインは、その場しのぎの分光計、バーコードリーダー、レーザービーム位置または偏差センサー、写真またはフィルム用スキャナーなどの設計に使用できます。</font><font style="vertical-align: inherit;">私の場合、それはレーザースキャナーでしたが、ネットワークでは説明できません。</font></font><br>
<a name="habracut"></a><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電荷結合素子とは何ですか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ほとんどの場合、CCDといえば、さまざまな光検出器を意味します。あまり一般的ではありませんが、これらはメモリデバイスです：シフトレジスタ、遅延線。コアでは、このデバイスは、シリコン上でのみ、円筒状磁区のメモリを多少連想させます-電極のシステムによって作成された電界の進行波の助けを借りて、何らかの形で内部に形成された電荷キャリアの塊が、半導体を介して移動します。したがって、非常に単純な構造を持ち、デジタルユニットとゼロのシーケンスだけでなく、アナログ信号も記憶できるシフトレジスタが得られます。</font></font><br>
<div style="text-align:center;"><img width="50%" src="https://habrastorage.org/webt/at/dl/gv/atdlgvfbnsok-t_geekshblchyo.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CCDイメージレシーバーでは、構造の各ピクセルの下に蓄積された電荷を順次出力するために使用されるのは、まさにこの構造のこの能力です。さらに、露光中に電荷を移動するために使用される同じゲートシステムは、これらの電荷が蓄積するポテンシャルウェルを作成します（またはこれらのホールは、MOSトランジスタの組み込みチャネルおよび誘導チャネルと同様に、構造の形成中に作成されます）。より複雑な構造には、滑らかな電位勾配が形成される抵抗ゲート（これは、浜松S11155 CCDラインが配置される方法です）と、電荷の蓄積および転送ゾーンの分離が含まれます-ライン全体の蓄積された電荷は、最初にバッファラインに転送され、その後に進みます最後に沿って終了します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
内部構造の単純さは、その管理の複雑さにつながります。 CCDラインの最も単純なバージョンでも、急なエッジ（1000 pF以上の高い入力容量）を持ち、互いにシフトした異なる電圧レベルを持つ、複雑な形状の2相または3相信号の生成が必要です。浜松S11155ルーラーには、ゼロの両側に高電圧と低電圧のレベルが異なる8つの異なる信号が必要です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸いにも、一部の企業（たとえば、Sony）は、この複雑さのすべてがチップ上に直接形成されたラインをリリースしました。そして彼らの仕事のために、あなたはたった二つの信号を生成する必要があります：露光の間の電子シャッターを開くこと、そして時計。私たちのデザインでは、これはまさにILX554ラインです：それは（通常使用されますが、かなり機能します）Aliexpressの中国人から簡単に購入できます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データシートを見てみましょう</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
。22ピンのうち6つしか含まれていないことがわかります。これは、+ 5 V電源、ROGおよびCLK入力信号、Vout出力信号、SHSWモード選択入力およびグランドです。そして、それはすべてです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ROGは電子シャッターコントロール（および感光ラインからダイレクトシフトレジスタへの電荷転送の開始）です。彼はアクティブなレベルを持っています-ゼロ。マトリックスを露出させるには、ゼロに押して、必要なだけ（5μsから数秒）保持する必要があります。そして、手放すために、少なくとも3μs待機します（この間、電荷転送回路が機能します）。この間ずっとCLKの入り口では、高レベルを維持します。次に、ラインを読み取り、CLK入力に数十キロヘルツから2 MHzの周波数の蛇行を適用します。この場合、1から0への各差で、次のピクセルが出力にプッシュされます。ラインナップには2088個のそのようなピクセルがあり、そのうち2048個は機能していて感光性です（実際にはさらにいくつかありますが、最も外側のピクセルは部分的に隠れています）。Datashitでは、正しく動作させるために、マトリックスに少なくとも2090のCLKパルスを適用することを推奨しています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、それがどのようにプッシュされるかは、SHSWの入力にあるものに依存します。論理ユニットの場合、出力はかなり複雑な信号を生成します。</font></font><br>
<div style="text-align:center;"><img width="50%" src="https://habrastorage.org/webt/dz/xq/qb/dzxqqbdg8vq_r_jgxg4gwek-6lg.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、CLKが0から1に変化するとリセットが発生し、1から0に戻ります-有用な信号の発行。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、SHSW入力がゼロになると、組み込みのサンプリングストレージ回路がオンになり、この信号が単純な段階的なビデオ信号に単純化されます。CLKがゼロに変わるたびに、次のピクセルの信号レベルが表示され、CLK信号の全期間にわたって保持されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力信号の有効範囲は、データシートによると2.85 Vである特定の暗いレベルに由来しますが、実際には異なる可能性があり（私のラインでは約3 V）、飽和すると、出力信号レベルは1.5-2に低下しますB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、この行について知っておく必要があるのはこれだけです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">封入回路</font></font></b><br>
<br>
<div style="text-align:center;"><img width="60%" src="https://habrastorage.org/webt/th/vo/xs/thvoxsmrevwageaehbzgex4j054.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それはシンプルで明白です。 MKを使用してプログラム的にCLK信号とROG信号を生成します。入力でのシュミットトリガーは、3.3 Vから5 Vに切り替える最も簡単な方法です。これらの入力と、マトリックスの内部回路が正しく機能するために、ラインにバッファーがありません。ゼロから5ボルトのフルスケールとフロントの急勾配を備えた蛇行を提出する必要があります。図に示されているNC7SZ14M5Xは、急勾配のフロントと増加した負荷容量を備えた非常に便利なシングルシュミット反転トリガーであり、プロジェクトでよく使用します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DA1を使用すると、ラインナップからADCが動作する範囲までのビデオ信号レベルが「加速」し、飽和レベルに対応する約1.5 Vの「スタンド」が除去されます。信号振幅と「スタンド」値の差は、CCDラインアレイによって大きく異なるため、出力信号を必要な範囲に「配置」することによって、抵抗R1とR3を選択する必要があります。変位だけでなくゲインも抵抗R1に依存するため、最初にそれを選択する必要があることに注意してください。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L1とL2は、フェライトサイズまたはフレームサイズが0805または0603の1-2μGの小さなチョークです。同じサイズの抵抗とコンデンサが使用されています。回路は両面実装で表面実装されています。ボードレイアウトはまだ持っていません。まだたくさんの物があるからです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MKでのソフトウェア実装</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MKタスクは、高レベルのROG信号を生成することです（インバーターを忘れないでください！）必要な期間、短い（3〜10μs）休止、その後、2090の高レベルパルスのシーケンスが継続時間の等しい休止によって分離されます。これらのパルス（または一時停止）の間、フロントからしばらく後、オンボードまたは外部ADCを使用してピクセル照度値が取得されます。フレームを読み取った後、新しいROGパルス（同じ3〜10μs）まで一時停止する必要もあります。電源を入れた後、定規を長時間（100ミリ秒以上）使用しなかった後、CLKに無料の標準的な一連のパルスを数回適用することにより、「クリーンアップ」する必要があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STM32では、タイマー割り込みでこれをすべて行うのが賢明です。 2倍のピクセル周波数に対応する周波数で割り込みを生成するようにタイマーを設定することにより、各タイマー操作を割り込みに入れ、ポートに0または1を交互に出力し、0を出力すると、ADCから読み取り値を読み取ります。そして、2090サイクルをカウントした後、タイマーを停止します。次のフレームを読み取るには、サイクルカウンターをゼロにリセットし、タイマーを開始して、すべてがカウントされるまで待つ必要があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このように、これらのコードスニペットに示すように。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> clkState = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">bool</span> frameOk = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">uint16_t</span> pixCount = <span class="hljs-number">0</span>;
<span class="hljs-keyword">uint16_t</span> ccdFrame[<span class="hljs-number">2090</span>];<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">uint16_t</span> <span class="hljs-title">readADC1</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
<span class="hljs-comment">//           </span>
</span>{<font></font>
     .<font></font>
     .<font></font>
     .<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Delay</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> Val)</span> 
<span class="hljs-comment">//    </span>

</span>{
    <span class="hljs-keyword">for</span>( ; Val != <span class="hljs-number">0</span>; Val--)<font></font>
        __NOP();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">readCCD</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
<span class="hljs-comment">//   -</span>

</span>{<font></font>
    pixCount = <span class="hljs-number">0</span>;                      <span class="hljs-comment">//   </span>
    frameOk = <span class="hljs-literal">false</span>;                 <span class="hljs-comment">//  </span>
    TIM_Cmd(TIM6, ENABLE);    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">while</span>(frameOk == <span class="hljs-literal">false</span>);     <span class="hljs-comment">// ,    </span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// ...    ... //</span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM6_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
<span class="hljs-comment">/* 
     -  
  CLK      
*/</span>

</span>{
	<span class="hljs-keyword">if</span> (TIM_GetITStatus(TIM4, TIM_IT_Update) != RESET)<font></font>
        {<font></font>
<font></font>
		<span class="hljs-keyword">if</span>(clkState == <span class="hljs-literal">true</span>)
                <span class="hljs-comment">//   (.0)     </span><font></font>
		{<font></font>
		    clkState = <span class="hljs-literal">false</span>;<font></font>
		    GPIOB-&gt;ODR &amp;= ~GPIO_ODR_ODR_1; <span class="hljs-comment">//     </span>
		    Delay(<span class="hljs-number">3</span>); <span class="hljs-comment">//  ,       </span><font></font>
		    ccdFrame[pixCount] = readADC1();<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span>
                <span class="hljs-comment">//   (.1)</span><font></font>
		{<font></font>
		    pixCount++;<font></font>
		    clkState = <span class="hljs-literal">true</span>;<font></font>
		    GPIOB-&gt;ODR |= GPIO_ODR_ODR_1; <span class="hljs-comment">//     </span><font></font>
		}<font></font>
			<font></font>
		<span class="hljs-keyword">if</span>(pixCount &gt;= <span class="hljs-number">2090</span>)
                <span class="hljs-comment">//    ,     </span><font></font>
		{<font></font>
		    pixCount = <span class="hljs-number">0</span>;<font></font>
                    frameOk = <span class="hljs-literal">true</span>;<font></font>
		    TIM_Cmd(TIM6, DISABLE);<font></font>
		}<font></font>
                TIM_ClearITPendingBit(TIM4, TIM_IT_Update);<font></font>
        }<font></font>
}<font></font>
</code></pre><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、これが結果です。</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
結果は悪くありません。内蔵ADCはその特性で光らないという事実にもかかわらず、そのノイズ特性は完全にCCDラインのノイズに対応しています。約1 msの蓄積時間を持つ暗い信号のノイズパスの振幅は、約3〜4の量子化レベルであることがわかり、優れた特性を持つ外部14ビットADCを使用すると、結果はわずかに良くなります。照明の増加に伴い、単純な理由でノイズが増加します。各ピクセルの光電子の数はそれほど大きくありません（私の計算によれば、飽和状態で約3万）。最適なデバイスの場合、この値は20万に達します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下の表は、定規に登録された「写真」の例です。照明付きの壁の背景に、内部に直径1 cmのガラス製中空ボールが固定された黒いスタンドが黒い溶液で満たされています。ピークは、このボールの外面からの反射です。明るい領域のノイズは壁自体の構造であり、フレームごとにレーザーからのスペックルによって補強され、静止したままです。ラインの実際のノイズははるかに少ないです。</font></font><br>
<div style="text-align:center;"><img width="65%" src="https://habrastorage.org/webt/ce/bt/jw/cebtjw-j6wmi1icilzg_oprfxnc.png" alt="画像"></div><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他の同様の</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
アレイ他の2048ピクセルの白黒SONY CCDアレイ-ILX511、ILX551（後者はピン配置が異なり、2つの電源電圧（5および9 Vが必要））、横ピクセルサイズが異なる（14から200μm）と分光感度（ILX554Aは赤とIRに敏感で、インデックスBと同様に、IR領域の感度が低く、目に感度が近く、ILX511Bは青に敏感です）。それらのダイナミック特性は異なります。小さなピクセルサイズによるILX551Bのダイナミックレンジは6000に達します（ラインは、約10μsの短いシャッタースピードでそのようなDDに達します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* * *</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、おそらく最も使いやすいCCDラインの接続について説明します。この単純さは、すべての複雑さが内部で彼女に隠されているという事実によるものです。組み込みのドライバーがなければ、大量のマルチレベル信号を生成する必要があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、現代の標準では、組み込みドライバーを備えたこのようなCCDラインは、最良の特性を備えていません。</font><font style="vertical-align: inherit;">したがって、この行では、ダイナミックレンジは飽和信号と暗い信号の比率として定義され、333：1であり、ノイズの背景に対して検出された最小信号と飽和信号の比率として定義されます-約1000：1。</font><font style="vertical-align: inherit;">しかし、このようなデバイスは使いづらいだけでなく、アクセスが難しいことがよくあります（同じ浜松は、CCDアレイやその他の光検出器を購入するときに、これらの製品の二重の目的のために複雑な官僚的な手続きを必要とします）。</font><font style="vertical-align: inherit;">同時に、そのような高い特性は必ずしも必要ではなく、多くの目的でこれらのデバイスのパラメータは非常に受け入れられます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja457752/index.html">月面探査機やジョーカーではありません。福島のロボットについて知っていること</a></li>
<li><a href="../ja457754/index.html">Государство и Т-киллеры</a></li>
<li><a href="../ja457756/index.html">アクションの本カフカストリーム。リアルタイムアプリケーションとマイクロサービス»</a></li>
<li><a href="../ja457758/index.html">エンジニアは森で失われた人々を救うが、森はまだ降伏していない</a></li>
<li><a href="../ja457760/index.html">コンテナーをさらに分離する方法：コンテナーサンドボックステクノロジーのレビュー</a></li>
<li><a href="../ja457764/index.html">若いPOの10の間違い（パートII）</a></li>
<li><a href="../ja457766/index.html">タイルレベルを生成し、プレーヤーから正方形を非表示にします</a></li>
<li><a href="../ja457768/index.html">脆弱になった経緯：QualysでITインフラストラクチャをスキャンする</a></li>
<li><a href="../ja457770/index.html">TypeScriptにカスタムトランスフォーマASTを記述します</a></li>
<li><a href="../ja457774/index.html">中つ国でプライベートパイロットとして勉強する：ニュージーランドの村に引っ越して生活する</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>