<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔣 🍒 👨🏻‍🔧 単一のアルゴリズムの進化 🌙 🚱 🛍️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="少し前に、私の同僚が私に1つの問題で彼を助けるように頼みました。私は彼のために問題を解決しましたが、さらに、この問題を解決する上で、いくつかのプログラミングアルゴリズムとテクニックを説明できるように思えました。また、アルゴリズムの実行時間の加速を25秒から40ミリ秒で表示します。
 問題の定式化
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>単一のアルゴリズムの進化</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454850/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少し前に、私の同僚が私に1つの問題で彼を助けるように頼みました。</font><font style="vertical-align: inherit;">私は彼のために問題を解決しましたが、さらに、この問題を解決する上で、いくつかのプログラミングアルゴリズムとテクニックを説明できるように思えました。</font><font style="vertical-align: inherit;">また、アルゴリズムの実行時間の加速を25秒から40ミリ秒で表示します。</font></font></p><a name="habracut"></a><br>
<h1 id="postanovka-zadachi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題の定式化</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">個人的なプロジェクトの場合、私の同僚は、特定のビデオについて最も類似した50本のビデオを見つけるアルゴリズムを必要としていました。</font><font style="vertical-align: inherit;">類似性は、一致する露出したタグの数によって推定されるはずでした。</font><font style="vertical-align: inherit;">ビデオが一致するタグが多いほど、類似性が高くなります。</font><font style="vertical-align: inherit;">これから、すぐにいくつかの結論を引き出すことができます。</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動画の下のすべてのタグを1つのグループにまとめることができます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのようなグループは動画自体よりも間違いなく多くなるでしょう。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動画が特定のタググループの別の動画と類似している場合は、このグループの他の動画と同様に類似しています。</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タググループでのみ作業すれば十分であることがわかります。</font><font style="vertical-align: inherit;">最初のバージョンでは、同僚がタグをタグテーブルに保存することにしました。各動画にはタググループIDへのリンクがあり、グループ自体は、対応するタグが設定されているかどうかを示すブール値のシーケンスです。</font><font style="vertical-align: inherit;">C＃では、タググループは次のようになります。</font></font></p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TagsGroup</span> {
    <span class="hljs-keyword">bool</span>[] InnerTags { <span class="hljs-keyword">get</span>; }<font></font>
}</code></pre><br>
<p> ,           ,      4000,      4096 = 2^12.<br>
  <code>TagsGroup</code>      :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TagsGroup</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> TagsGroupLength = <span class="hljs-number">4096</span>;
    <span class="hljs-keyword">bool</span>[] InnerTags { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TagsGroup</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span>[] innerTags</span>)</span> {
        <span class="hljs-keyword">if</span> (innerTags == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-keyword">nameof</span>(innerTags));
        <span class="hljs-keyword">if</span> (innerTags.Length != TagsGroupLength) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-keyword">nameof</span>(innerTags));<font></font>
        }<font></font>
        InnerTags = innerTags;<font></font>
    }<font></font>
}</code></pre><br>
<p>       .           true     <code>InnerTags</code>    :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">MeasureSimilarity</span>(<span class="hljs-params">TagsGroup a, TagsGroup b</span>)</span> {
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength; i++) {
        <span class="hljs-keyword">if</span> (a.InnerTags[i] &amp;&amp; a.InnerTags[i] == b.InnerTags[i])<font></font>
            result++;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<p>                .         , ..       ,   <code>MeasureSimilarity</code>            <code>MeasureSimilarity</code>     ,         .   , , : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://ru.wikipedia.org/wiki/_</a>.<br>
        <code>SimilarTagsCalculator</code>,   :</p><br>
<div class="spoiler"><b class="spoiler_title">SimilarTagsCalculator</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">SimilarTagsCalculator</span> {<font></font>
    TagsGroup[] Groups { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SimilarTagsCalculator</span>(<span class="hljs-params">TagsGroup[] groups</span>)</span> {
        <span class="hljs-keyword">if</span> (groups == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-keyword">nameof</span>(groups));<font></font>
        Groups = groups;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TagsGroup[] <span class="hljs-title">GetFiftyMostSimilarGroups</span>(<span class="hljs-params">TagsGroup <span class="hljs-keyword">value</span></span>)</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> resultLength = <span class="hljs-number">50</span>;
<span class="hljs-comment">//,         </span>
        <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> List&lt;TagsSimilarityInfo&gt;(resultLength);
<span class="hljs-comment">//     </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> groupIndex = <span class="hljs-number">0</span>; groupIndex &lt; Groups.Length; groupIndex++) {<font></font>
            TagsGroup tagsGroup = Groups[groupIndex];<font></font>
<span class="hljs-comment">//     </span>
            <span class="hljs-keyword">int</span> similarityValue = TagsGroup.MeasureSimilarity(<span class="hljs-keyword">value</span>, tagsGroup);
<span class="hljs-comment">// - </span>
            TagsSimilarityInfo newInfo = <span class="hljs-keyword">new</span> TagsSimilarityInfo(groupIndex, similarityValue);
<span class="hljs-comment">//    ,     ,</span>
            <span class="hljs-keyword">if</span> (list.Count == resultLength &amp;&amp; list[resultLength - <span class="hljs-number">1</span>].CompareTo(newInfo) == <span class="hljs-number">-1</span>) { 
                <span class="hljs-keyword">continue</span>; <span class="hljs-comment">//    </span><font></font>
            }<font></font>
<span class="hljs-comment">//   ,    - </span>
            <span class="hljs-keyword">int</span> index = ~list.BinarySearch(newInfo);<font></font>
            list.Insert(index, newInfo); <span class="hljs-comment">//</span>
            <span class="hljs-keyword">if</span> (list.Count &gt; resultLength) { 
<span class="hljs-comment">//    ,</span>
<span class="hljs-comment">//   , ..   </span><font></font>
                list.RemoveAt(resultLength);<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-comment">// -  </span>
        TagsGroup[] result = <span class="hljs-keyword">new</span> TagsGroup[resultLength];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; resultLength; i++) {<font></font>
            result[i] = Groups[list[i].Index];<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> result;<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>  <code>TagsSimilarityInfo</code>:</p><br>
<div class="spoiler"><b class="spoiler_title">TagsSimilarityInfo</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">struct</span> TagsSimilarityInfo : IComparable&lt;TagsSimilarityInfo&gt;, IComparable {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Index { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Similarity { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TagsSimilarityInfo</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> index, <span class="hljs-keyword">int</span> similarity</span>)</span> {<font></font>
        Index = index;<font></font>
        Similarity = similarity;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">Equals</span>(<span class="hljs-params">TagsSimilarityInfo other</span>)</span> {
        <span class="hljs-keyword">return</span> Index == other.Index &amp;&amp; Similarity == other.Similarity;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">Equals</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> obj</span>)</span> {
        <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">is</span> TagsSimilarityInfo other &amp;&amp; Equals(other);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">int</span> <span class="hljs-title">GetHashCode</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">unchecked</span> {
            <span class="hljs-keyword">return</span> (Index * <span class="hljs-number">397</span>) ^ Similarity;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">CompareTo</span>(<span class="hljs-params">TagsSimilarityInfo other</span>)</span> {
        <span class="hljs-keyword">int</span> similarityComparison = other.Similarity.CompareTo(Similarity);
        <span class="hljs-keyword">return</span> similarityComparison != <span class="hljs-number">0</span> ? similarityComparison : Index.CompareTo(other.Index);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">CompareTo</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> obj</span>)</span> {
        <span class="hljs-keyword">if</span> (ReferenceEquals(<span class="hljs-literal">null</span>, obj))
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">is</span> TagsSimilarityInfo other ? CompareTo(other) : <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">$"Object must be of type <span class="hljs-subst">{<span class="hljs-keyword">nameof</span>(TagsSimilarityInfo)}</span>"</span>);<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>      :</p><br>
<ul>
<li>  , ..         ,    ,  ;</li>
<li>       ,    ,     .      -    ;</li>
<li>,   ,       .     50  ;</li>
</ul><br>
<p>     :</p><br>
<p>BenchmarkDotNet=v0.11.5, OS=Windows 10.0.17134.765 (1803/April2018Update/Redstone4)<br>
Intel Core i7-6700 CPU 3.40GHz (Skylake), 1 CPU, 8 logical and 4 physical cores<br>
Frequency=3328126 Hz, Resolution=300.4694 ns, Timer=TSC<br>
.NET Core SDK=3.0.100-preview5-011568<br>
[Host]: .NET Core 3.0.0-preview5-27626-15 (CoreCLR 4.6.27622.75, CoreFX 4.700.19.22408), 64bit RyuJIT</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>25.054 s</td>
<td>0.1786 s</td>
<td>0.1670 s</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>4.180 s</td>
<td>0.0174 s</td>
<td>0.0162 s</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>4.147 s</td>
<td>0.0118 s</td>
<td>0.0104 s</td>
<td>1.53 KB</td>
</tr>
</tbody>
</table></div><br>
<p>    ,    25  —   ,      .   .         :</p><br>
<ul>
<li> <code>MeasureSimilarity</code>;</li>
<li>     <code>GetFiftyMostSimilarGroups</code>;</li>
<li>   <code>GetFiftyMostSimilarGroups</code>;</li>
</ul><br>
<p>      .</p><br>
<h1 id="predskazanie-vetvleniy"> </h1><br>
<p>   <code>MeasureSimilarity</code>. </p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">MeasureSimilarity</span>(<span class="hljs-params">TagsGroup a, TagsGroup b</span>)</span> {
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength; i++) {
        <span class="hljs-keyword">if</span> (a.InnerTags[i] &amp;&amp; a.InnerTags[i] == b.InnerTags[i])<font></font>
            result++;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<p>              .         :</p><br>
<ul>
<li>     .   —     ;</li>
<li>    i-   i  ;</li>
</ul><br>
<p>,                  .  <code>MeasureSimilarity</code>     ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>    .      ,      MeasureSimilarity      :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">GetSimilaritySum</span>(<span class="hljs-params">TagsGroup[] tagsGroups</span>)</span> {
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (TagsGroup tagsGroup <span class="hljs-keyword">in</span> tagsGroups) {<font></font>
        result += TagsGroup.MeasureSimilarity(tagsGroup, etalon);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}<font></font>
<font></font>
[<span class="hljs-meta">Benchmark</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Sorted</span>(<span class="hljs-params"></span>)</span> =&gt; GetSimilaritySum(sortedGroups);<font></font>
<font></font>
[<span class="hljs-meta">Benchmark</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">Unsorted</span>(<span class="hljs-params"></span>)</span> =&gt; GetSimilaritySum(unsortedGroups);</code></pre><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sorted</td>
<td>3.704 s</td>
<td>0.0411 s</td>
<td>0.0364 s</td>
</tr>
<tr>
<td>Unsorted</td>
<td>8.211 s</td>
<td>0.0381 s</td>
<td>0.0338 s</td>
</tr>
</tbody>
</table></div><br>
<p>   ,   <code>Sorted</code>        ,   ,   <code>Unsorted</code>           .<br>
  5  ,     - .           ,     .  <code>MeasureSimilarity</code>    —   ,       .  ,      ,      :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>a.InnerTags[i]</th>
<th>b.InnerTags[i]</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>False</td>
<td>False</td>
<td>False</td>
</tr>
<tr>
<td>False</td>
<td>True</td>
<td>False</td>
</tr>
<tr>
<td>True</td>
<td>False</td>
<td>False</td>
</tr>
<tr>
<td>True</td>
<td>True</td>
<td>True</td>
</tr>
</tbody>
</table></div><br>
<p>      "", ..      ,    ,     : <code>if (a.InnerTags[i] &amp;&amp; b.InnerTags[i])</code>.       .     ,    result  ,       :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">int</span> t = a.InnerTags[i] &amp;&amp; b.InnerTags[i] ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<font></font>
result += t;</code></pre><br>
<p>              .     ,     <code>InnerTags</code>   bool  byte (1  true,  0  false),        .   <code>TagsGroup</code>    :</p><br>
<div class="spoiler"><b class="spoiler_title">TagsGroup</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TagsGroup</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> TagsGroupLength = <span class="hljs-number">4096</span>;
    <span class="hljs-keyword">byte</span>[] InnerTags { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">MeasureSimilarity</span>(<span class="hljs-params">TagsGroup a, TagsGroup b</span>)</span> {
        <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength; i++) {
            <span class="hljs-keyword">int</span> t = a.InnerTags[i] &amp; b.InnerTags[i];<font></font>
            result += t;<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> result;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TagsGroup</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span>[] innerTags</span>)</span> {
        <span class="hljs-keyword">if</span> (innerTags == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-keyword">nameof</span>(innerTags));
        <span class="hljs-keyword">if</span> (innerTags.Length != TagsGroupLength) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-keyword">nameof</span>(innerTags));<font></font>
        }<font></font>
        InnerTags = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[TagsGroupLength];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength; i++) {<font></font>
            InnerTags[i] = (<span class="hljs-keyword">byte</span>) (innerTags[i] ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<font></font>
        }<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>     <code>MeasureSimilarity</code>:</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sorted</td>
<td>3.180 s</td>
<td>0.0118 s</td>
<td>0.0111 s</td>
</tr>
<tr>
<td>Unsorted</td>
<td>3.236 s</td>
<td>0.0622 s</td>
<td>0.0764 s</td>
</tr>
</tbody>
</table></div><br>
<div class="spoiler"><b class="spoiler_title">:</b><div class="spoiler_text"><div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sorted</td>
<td>3.704 s</td>
<td>0.0411 s</td>
<td>0.0364 s</td>
</tr>
<tr>
<td>Unsorted</td>
<td>8.211 s</td>
<td>0.0381 s</td>
<td>0.0338 s</td>
</tr>
</tbody>
</table></div></div></div><br>
<p>     :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>3.219 s</td>
<td>0.0492 s</td>
<td>0.0436 s</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>3.223 s</td>
<td>0.0117 s</td>
<td>0.0110 s</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>3.422 s</td>
<td>0.0697 s</td>
<td>0.0999 s</td>
<td>1.53 KB</td>
</tr>
</tbody>
</table></div><br>
<div class="spoiler"><b class="spoiler_title">:</b><div class="spoiler_text"><div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>25.054 s</td>
<td>0.1786 s</td>
<td>0.1670 s</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>4.180 s</td>
<td>0.0174 s</td>
<td>0.0162 s</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>4.147 s</td>
<td>0.0118 s</td>
<td>0.0104 s</td>
<td>1.53 KB</td>
</tr>
</tbody>
</table></div></div></div><br>
<p>-,   .    ,      - ,       ,       :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">int</span> t = a.InnerTags[i] &amp; b.InnerTags[i];
<span class="hljs-keyword">if</span> (t == <span class="hljs-number">1</span>)<font></font>
    result += t;</code></pre><br>
<p>    :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sorted</td>
<td>3.760 s</td>
<td>0.0746 s</td>
<td>0.1541 s</td>
</tr>
<tr>
<td>Unsorted</td>
<td>8.628 s</td>
<td>0.1699 s</td>
<td>0.2382 s</td>
</tr>
</tbody>
</table></div><br>
<h1 id="upakovyvanie-dannyh"> </h1><br>
<p>    ,      .  ,      ,     ,    . ,          .     -   ,          .      ,      ,   .      1  0.  <code>result</code>     "".             . C#         64   (    <code>BitArray</code>,     ).        64      ,      ""     64  .  ,     .      :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">int</span> t = a.InnerTags[i] &amp; b.InnerTags[i];<font></font>
result += t;</code></pre><br>
<p>result   1  ,  t == 1     t == 0.   result   ,    <code>a.InnerTags[i] &amp; b.InnerTags[i]</code>  .        <code>a.InnerTags[i] &amp; b.InnerTags[i]</code>  - ,   result       .    ""    n-   n-           n.      ,      .   64   , ..      .  32        ,   -  .   16   ,     .      8  :</p><br>
<div class="spoiler"><b class="spoiler_title">GenerateCountOfSettedBits</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">byte</span>[] CountOfSettedBits = GenerateCountOfSettedBits();<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] <span class="hljs-title">GenerateCountOfSettedBits</span>(<span class="hljs-params"></span>)</span> {
<span class="hljs-comment">//  result   i      i- .</span>
    <span class="hljs-keyword">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">256</span>]; 
<span class="hljs-comment">//  ,      i   , </span>
<span class="hljs-comment">//       </span>
    <span class="hljs-keyword">int</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">8</span>];
<span class="hljs-comment">//    </span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">256</span>; i++) {
<span class="hljs-comment">//      </span>
        <span class="hljs-keyword">int</span> settedBitsCount = <span class="hljs-number">0</span>;
<span class="hljs-comment">//,      </span>
        <span class="hljs-keyword">int</span> m = <span class="hljs-number">1</span>;
<span class="hljs-comment">//  </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++) {   
<span class="hljs-comment">//    </span><font></font>
            b[j] += m;<font></font>
<span class="hljs-comment">//  ,       2.</span>
            m = b[j] &gt;&gt; <span class="hljs-number">1</span>;
<span class="hljs-comment">//       </span>
            b[j] = b[j] &amp; <span class="hljs-number">1</span>;        
<span class="hljs-comment">//,       </span><font></font>
            settedBitsCount += b[j];<font></font>
        }<font></font>
        result[i] = (<span class="hljs-keyword">byte</span>) settedBitsCount; <span class="hljs-comment">//  </span><font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre></div></div><br>
<p>  TagsGroup   :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> BucketSize = <span class="hljs-number">8</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TagsGroup</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span>[] innerTags</span>)</span> {
    <span class="hljs-keyword">if</span> (innerTags == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-keyword">nameof</span>(innerTags));
    <span class="hljs-keyword">if</span> (innerTags.Length != TagsGroupLength) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-keyword">nameof</span>(innerTags));<font></font>
    }<font></font>
    <span class="hljs-keyword">int</span> index = <span class="hljs-number">0</span>; <span class="hljs-comment">//   </span>
    InnerTags = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[TagsGroupLength / BucketSize];
<span class="hljs-comment">//  </span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength / BucketSize; i++) {
<span class="hljs-comment">//    </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; BucketSize; j++, index++) {
<span class="hljs-comment">//    2,     </span>
            InnerTags[i] &lt;&lt;= <span class="hljs-number">1</span>;
<span class="hljs-comment">//   </span>
            InnerTags[i] += (<span class="hljs-keyword">byte</span>) (innerTags[index] ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<p> <code>MeasureSimilarity</code>    :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">MeasureSimilarity</span>(<span class="hljs-params">TagsGroup a, TagsGroup b</span>)</span> {
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength / BucketSize; i++) {
        <span class="hljs-keyword">int</span> t = a.InnerTags[i] &amp; b.InnerTags[i];<font></font>
        result += CountOfSettedBits[t];<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<p>     ,    :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>560.5 ms</td>
<td>8.285 ms</td>
<td>7.344 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>570.1 ms</td>
<td>4.108 ms</td>
<td>3.431 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>608.1 ms</td>
<td>5.691 ms</td>
<td>5.324 ms</td>
<td>1.53 KB</td>
</tr>
</tbody>
</table></div><br>
<p>    <code>MeasureSimilarity</code>  ? !      ,        64 ,       .    ,     ,   64     :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> BucketSize = <span class="hljs-number">64</span>;<font></font>
<font></font>
<span class="hljs-keyword">ulong</span>[] InnerTags { <span class="hljs-keyword">get</span>; }<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">MeasureSimilarity</span>(<span class="hljs-params">TagsGroup a, TagsGroup b</span>)</span> {
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength / BucketSize; i++) {
        <span class="hljs-keyword">ulong</span> t = a.InnerTags[i] &amp; b.InnerTags[i];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; BucketSize / <span class="hljs-number">8</span>; j++) {<font></font>
            result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
            t &gt;&gt;= <span class="hljs-number">8</span>;<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<p> :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>533.3 ms</td>
<td>4.802 ms</td>
<td>4.492 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>550.9 ms</td>
<td>5.435 ms</td>
<td>5.084 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>567.6 ms</td>
<td>3.879 ms</td>
<td>3.439 ms</td>
<td>1.53 KB</td>
</tr>
</tbody>
</table></div><br>
<p>    :</p><br>
<div class="spoiler"><b class="spoiler_title">MeasureSimilarity</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">MeasureSimilarity</span>(<span class="hljs-params">TagsGroup a, TagsGroup b</span>)</span> {
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength / BucketSize; i++) {
        <span class="hljs-keyword">ulong</span> t = a.InnerTags[i] &amp; b.InnerTags[i];<font></font>
        result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
        t &gt;&gt;= <span class="hljs-number">8</span>;<font></font>
        result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
        t &gt;&gt;= <span class="hljs-number">8</span>;<font></font>
        result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
        t &gt;&gt;= <span class="hljs-number">8</span>;<font></font>
        result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
        t &gt;&gt;= <span class="hljs-number">8</span>;<font></font>
        result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
        t &gt;&gt;= <span class="hljs-number">8</span>;<font></font>
        result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
        t &gt;&gt;= <span class="hljs-number">8</span>;<font></font>
        result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
        t &gt;&gt;= <span class="hljs-number">8</span>;<font></font>
        result += CountOfSettedBits[t &amp; <span class="hljs-number">255</span>];<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre></div></div><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>370.5 ms</td>
<td>2.802 ms</td>
<td>2.484 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>395.8 ms</td>
<td>2.682 ms</td>
<td>2.509 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>419.5 ms</td>
<td>3.352 ms</td>
<td>2.971 ms</td>
<td>1.53 KB</td>
</tr>
</tbody>
</table></div><br>
<p>   ? !     .NET Core 3.0.       ,          .  Intel Intrinsic Guide   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>_mm_popcnt_u64</code></a>.   : "<em>Count the number of bits set to 1 in unsigned 64-bit integer a, and return that count in dst.</em>".     ,    !  .NET Core 3.0 Preview 5     <code>System.Runtime.Intrinsics.X86.Popcnt.X64.PopCount</code>(     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link">a-tk</a>     ,    .      <code>System.Runtime.Intrinsics.X86.Popcnt.X64.IsSupported</code>).      <code>MeasureSimilarity</code>  :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">MeasureSimilarity</span>(<span class="hljs-params">TagsGroup a, TagsGroup b</span>)</span> {
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; TagsGroupLength / BucketSize; i++) {
        <span class="hljs-keyword">ulong</span> t = a.InnerTags[i] &amp; b.InnerTags[i];<font></font>
        result += (<span class="hljs-keyword">int</span>) System.Runtime.Intrinsics.X86.Popcnt.X64.PopCount(t);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<p>  :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>59.33 ms</td>
<td>1.148 ms</td>
<td>0.9585 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>74.87 ms</td>
<td>1.479 ms</td>
<td>1.9748 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>119.46 ms</td>
<td>2.321 ms</td>
<td>2.8509 ms</td>
<td>1.53 KB</td>
</tr>
</tbody>
</table></div><br>
<p>.<br>
  ,     <code>MeasureSimilarity</code>       . ,     .</p><br>
<h1 id="struktury-dannyh"> </h1><br>
<p>       <code>GetFiftyMostSimilarGroups</code>:</p><br>
<div class="spoiler"><b class="spoiler_title">GetFiftyMostSimilarGroups</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> TagsGroup[] <span class="hljs-title">GetFiftyMostSimilarGroups</span>(<span class="hljs-params">TagsGroup <span class="hljs-keyword">value</span></span>)</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> resultLength = <span class="hljs-number">50</span>;<font></font>
    List&lt;TagsSimilarityInfo&gt; list = <span class="hljs-keyword">new</span> List&lt;TagsSimilarityInfo&gt;(<span class="hljs-number">50</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> groupIndex = <span class="hljs-number">0</span>; groupIndex &lt; Groups.Length; groupIndex++) {<font></font>
        TagsGroup tagsGroup = Groups[groupIndex];<font></font>
        <span class="hljs-keyword">int</span> similarityValue = TagsGroup.MeasureSimilarity(<span class="hljs-keyword">value</span>, tagsGroup);<font></font>
        TagsSimilarityInfo newInfo = <span class="hljs-keyword">new</span> TagsSimilarityInfo(groupIndex, similarityValue);
        <span class="hljs-keyword">if</span> (list.Count == resultLength &amp;&amp; list[resultLength - <span class="hljs-number">1</span>].CompareTo(newInfo) == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">int</span> index = ~list.BinarySearch(newInfo);<font></font>
        list.Insert(index, newInfo);<font></font>
        <span class="hljs-keyword">if</span> (list.Count &gt; resultLength) {<font></font>
            list.RemoveAt(resultLength);<font></font>
        }<font></font>
    }<font></font>
    TagsGroup[] result = <span class="hljs-keyword">new</span> TagsGroup[resultLength];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; resultLength; i++) {<font></font>
        result[i] = Groups[list[i].Index];<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre></div></div><br>
<p> ,   :</p><br>
<ul>
<li> list        ,     ,   <code>TagsSimilarityInfo</code>;</li>
<li>     list   ;</li>
<li>   list  ,      ( -          <code>list</code>);</li>
</ul><br>
<p>.. ,          ,     .        .      — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.      O(log N),    O(1),    O(log N).    ,           .  BCL   ,     :</p><br>
<div class="spoiler"><b class="spoiler_title">BinaryHeap</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BinaryHeap</span>&lt;T&gt;:<span class="hljs-title">IEnumerable</span>&lt;T&gt; <span class="hljs-keyword">where</span> <span class="hljs-title">T</span> : <span class="hljs-title">IComparable</span>&lt;T&gt; {
    <span class="hljs-keyword">readonly</span> List&lt;T&gt; innerList;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BinaryHeap</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> capacity</span>)</span> {<font></font>
        innerList = <span class="hljs-keyword">new</span> List&lt;T&gt;(capacity);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Count =&gt; innerList.Count;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> T Max =&gt; innerList[<span class="hljs-number">0</span>];<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params">T <span class="hljs-keyword">value</span></span>)</span> {<font></font>
        innerList.Add(<span class="hljs-keyword">value</span>);
        <span class="hljs-keyword">int</span> i = Count - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">int</span> parent = (i - <span class="hljs-number">1</span>) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
<font></font>
        <span class="hljs-keyword">while</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; innerList[parent].CompareTo(innerList[i]) == <span class="hljs-number">-1</span>) {<font></font>
            Swap(i, parent);<font></font>
<font></font>
            i = parent;<font></font>
            parent = (i - <span class="hljs-number">1</span>) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Swap</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b</span>)</span> {<font></font>
        T temp = innerList[a];<font></font>
        innerList[a] = innerList[b];<font></font>
        innerList[b] = temp;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Heapify</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> i</span>)</span> {
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-keyword">int</span> leftChild = (i &lt;&lt; <span class="hljs-number">1</span>) | <span class="hljs-number">1</span>;
            <span class="hljs-keyword">int</span> rightChild = (i + <span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">1</span>;
            <span class="hljs-keyword">int</span> largestChild = i;<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (leftChild &lt; Count &amp;&amp; innerList[leftChild].CompareTo(innerList[largestChild]) == <span class="hljs-number">1</span>) {<font></font>
                largestChild = leftChild;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (rightChild &lt; Count &amp;&amp; innerList[rightChild].CompareTo(innerList[largestChild]) == <span class="hljs-number">1</span>) {<font></font>
                largestChild = rightChild;<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (largestChild == i) {
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            Swap(i, largestChild);<font></font>
            i = largestChild;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RemoveMax</span>(<span class="hljs-params"></span>)</span> {<font></font>
        innerList[<span class="hljs-number">0</span>] = innerList[Count - <span class="hljs-number">1</span>];<font></font>
        innerList.RemoveAt(Count - <span class="hljs-number">1</span>);<font></font>
        Heapify(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator&lt;T&gt; <span class="hljs-title">GetEnumerator</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">return</span> innerList.GetEnumerator();<font></font>
    }<font></font>
<font></font>
    IEnumerator IEnumerable.GetEnumerator() {<font></font>
        <span class="hljs-keyword">return</span> ((IEnumerable) innerList).GetEnumerator();<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>   <code>GetFiftyMostSimilarGroups</code>       ( ).<br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.         O(log N),    O(log N),    O(log N).     ,         ,  , -    BCL   SortedSet (      ,   .netcore 3.0,   ).  <code>GetFiftyMostSimilarGroups</code>  SortedSet       .<br>
     <code>GetFiftyMostSimilarGroups</code>:</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th> </th>
<th>Mean</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>List</td>
<td>60.06 ms</td>
<td>1704 B</td>
</tr>
<tr>
<td>RandomTest</td>
<td>SortedSet</td>
<td>65.46 ms</td>
<td>24384 B</td>
</tr>
<tr>
<td>RandomTest</td>
<td>Heap</td>
<td>60.55 ms</td>
<td>2912 B</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>List</td>
<td>75.42 ms</td>
<td>1704 B</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>SortedSet</td>
<td>161.12 ms</td>
<td>9833424 B</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>Heap</td>
<td>86.87 ms</td>
<td>2912 B</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>List</td>
<td>119.23 ms</td>
<td>880 B</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>SortedSet</td>
<td>125.03 ms</td>
<td>3024 B</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>Heap</td>
<td>118.62 ms</td>
<td>2088 B</td>
</tr>
</tbody>
</table></div><br>
<p>        ,     .   - ,         O(log N)  ,   O(1)  , ..        ,    O(1),     O(1), ..  .net              ( .net core      ).      50,   1000   , ,  ,      .        , ..      .</p><br>
<h1 id="mnogopotochnost"></h1><br>
<p>       <code>GetFiftyMostSimilarGroups</code>.     .   ,        .     50    ,       50  .<br>
  <code>GetFiftyMostSimilarGroups</code>   :</p><br>
<div class="spoiler"><b class="spoiler_title">GetFiftyMostSimilarGroupsMultiThread</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> TagsGroup[] <span class="hljs-title">GetFiftyMostSimilarGroupsMultiThread</span>(<span class="hljs-params">TagsGroup <span class="hljs-keyword">value</span></span>)</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> resultLength = <span class="hljs-number">50</span>;
<span class="hljs-comment">// ,    </span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> threadsCount = <span class="hljs-number">4</span>;
<span class="hljs-comment">//  </span>
    <span class="hljs-keyword">int</span> bucketSize = Groups.Length / threadsCount;
    <span class="hljs-keyword">var</span> tasks = <span class="hljs-keyword">new</span> Task&lt;List&lt;TagsSimilarityInfo&gt;&gt;[threadsCount];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; threadsCount; i++) {
        <span class="hljs-keyword">int</span> leftIndex = i * bucketSize;             <span class="hljs-comment">//   </span>
        <span class="hljs-keyword">int</span> rightIndex = (i + <span class="hljs-number">1</span>) * bucketSize;      <span class="hljs-comment">//   </span>
<span class="hljs-comment">//   </span>
        tasks[i] = Task&lt;List&lt;TagsSimilarityInfo&gt;&gt;.Factory.StartNew(() =&gt; GetFiftyMostSimilarGroupsMultiThreadCore(<span class="hljs-keyword">value</span>, leftIndex, rightIndex));<font></font>
    }<font></font>
    Task.WaitAll(tasks);<font></font>
<span class="hljs-comment">//   </span>
    <span class="hljs-keyword">var</span> taskResults = <span class="hljs-keyword">new</span> List&lt;TagsSimilarityInfo&gt;[threadsCount];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; threadsCount; i++) {<font></font>
        taskResults[i] = tasks[i].Result;<font></font>
    }<font></font>
<span class="hljs-comment">//     </span>
    <span class="hljs-keyword">return</span> MergeTaskResults(resultLength, threadsCount, taskResults);<font></font>
}</code></pre></div></div><br>
<p> <code>GetFiftyMostSimilarGroupsMultiThreadCore</code>       <code>GetFiftyMostSimilarGroups</code>:</p><br>
<div class="spoiler"><b class="spoiler_title">GetFiftyMostSimilarGroupsMultiThreadCore</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function">List&lt;TagsSimilarityInfo&gt; <span class="hljs-title">GetFiftyMostSimilarGroupsMultiThreadCore</span>(<span class="hljs-params">TagsGroup <span class="hljs-keyword">value</span>, <span class="hljs-keyword">int</span> leftIndex, <span class="hljs-keyword">int</span> rightIndex</span>)</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> resultLength = <span class="hljs-number">50</span>;<font></font>
    List&lt;TagsSimilarityInfo&gt; list = <span class="hljs-keyword">new</span> List&lt;TagsSimilarityInfo&gt;(resultLength);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> groupIndex = leftIndex; groupIndex &lt; rightIndex; groupIndex++) {<font></font>
        TagsGroup tagsGroup = Groups[groupIndex];<font></font>
        <span class="hljs-keyword">int</span> similarityValue = TagsGroup.MeasureSimilarity(<span class="hljs-keyword">value</span>, tagsGroup);<font></font>
        TagsSimilarityInfo newInfo = <span class="hljs-keyword">new</span> TagsSimilarityInfo(groupIndex, similarityValue);
        <span class="hljs-keyword">if</span> (list.Count == resultLength &amp;&amp; list[resultLength - <span class="hljs-number">1</span>].CompareTo(newInfo) == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">int</span> index = ~list.BinarySearch(newInfo);<font></font>
        list.Insert(index, newInfo);<font></font>
        <span class="hljs-keyword">if</span> (list.Count &gt; resultLength) {<font></font>
            list.RemoveAt(resultLength);<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> list;<font></font>
}</code></pre></div></div><br>
<p>    <code>MergeTaskResults</code>.   -    taskResults    . ,  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.     ,  <code>threadsCount</code> ,     :         ,     ,    ,    :</p><br>
<div class="spoiler"><b class="spoiler_title">MergeTaskResults</b><div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function">TagsGroup[] <span class="hljs-title">MergeTaskResults</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> resultLength, <span class="hljs-keyword">int</span> threadsCount, List&lt;TagsSimilarityInfo&gt;[] taskResults</span>)</span> {<font></font>
    TagsGroup[] result = <span class="hljs-keyword">new</span> TagsGroup[resultLength];
    <span class="hljs-keyword">int</span>[] indices = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[threadsCount]; 
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; resultLength; i++) {
        <span class="hljs-keyword">int</span> minIndex = <span class="hljs-number">0</span>; <font></font>
        TagsSimilarityInfo currentBest = taskResults[minIndex][indices[minIndex]];<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; threadsCount; j++) {
            <span class="hljs-keyword">var</span> current = taskResults[j][indices[j]];
            <span class="hljs-keyword">if</span> (current.CompareTo(currentBest) == <span class="hljs-number">-1</span>) {<font></font>
                minIndex = j;<font></font>
                currentBest = taskResults[minIndex][indices[minIndex]];<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-keyword">int</span> groupIndex = currentBest.Index;<font></font>
        result[i] = Groups[groupIndex];<font></font>
        indices[minIndex]++;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre></div></div><br>
<ul>
<li> <code>indices</code>      <code>taskResults</code>;</li>
<li><code>minIndex</code> —   <code>taskResults</code>,         ;</li>
<li><code>currentBest</code> — -      ;</li>
<li><code>current</code> — -    ;</li>
</ul><br>
<p>   :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28.76ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.5677ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.414ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 KB</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アセンダントテスト</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">32.36ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.8930ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.591ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 KB</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DescendantTest</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41.36ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.8908ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.626ミリ秒</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 KB</font></font></td>
</tr>
</tbody>
</table></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、これが最初に起こったことです：</font></font></b><div class="spoiler_text"><div class="scrollable-table"><table>
<thead>
<tr>
<th>Method</th>
<th>Mean</th>
<th>Error</th>
<th>StdDev</th>
<th>Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td>RandomTest</td>
<td>25054 ms</td>
<td>1786 ms</td>
<td>1670 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>AscendantTest</td>
<td>4180 ms</td>
<td>174 ms</td>
<td>162 ms</td>
<td>1.53 KB</td>
</tr>
<tr>
<td>DescendantTest</td>
<td>4147 ms</td>
<td>118 ms</td>
<td>104 ms</td>
<td>1.53 KB</td>
</tr>
</tbody>
</table></div></div></div><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、これは既存のコードの推論と段階的な進化によってのみ達成されました。</font><font style="vertical-align: inherit;">当然、コードは不完全です。</font><font style="vertical-align: inherit;">エラー処理はまったくなく、ソースデータが4または50の倍数でない場合、メソッドの半分は失敗します。しかし、基本的な考え方が明確であることを願っています。</font></font></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのコードはここにあります。</font></font></a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454830/index.html">プロダクトマネージャーとして成功するための3つの重要な要素：Alexander Belyaev</a></li>
<li><a href="../ja454832/index.html">週4日の稼働が悪い話である理由</a></li>
<li><a href="../ja454834/index.html">モチベーションの低いタッチタイピングの研究の本当の条件</a></li>
<li><a href="../ja454840/index.html">彼の妻と住宅ローンとオランダへの慎重な移転。パート2：ドキュメントの準備と移動</a></li>
<li><a href="../ja454844/index.html">Odigest：今週のデザイナーにとって興味深い</a></li>
<li><a href="../ja454856/index.html">ブラウザー以外のソフトウェアにおけるSSL / TLS証明書検証の脆弱性を分析します</a></li>
<li><a href="../ja454864/index.html">さまざまな企業の開発プロセスはどうですか</a></li>
<li><a href="../ja454868/index.html">EmscriptenなしでWebAssemblyでCをコンパイルする</a></li>
<li><a href="../ja454872/index.html">Space Invaders：512バイト（Assembler x86）にもなりました</a></li>
<li><a href="../ja454874/index.html">マイクロコントローラーのマルチタスクについて少し</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>