<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎀 🎭 🍮 Ahorre mucho dinero en grandes volúmenes en PostgreSQL ⤵️ 📉 🙋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuando con el tema de la grabación de grandes flujos de datos, planteados por el artículo anterior sobre particionamiento , en esto consideramos ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ahorre mucho dinero en grandes volúmenes en PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498292/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuando con el tema de la grabación de grandes flujos de datos, planteados por el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artículo anterior sobre particionamiento</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , en esto consideramos las formas en que puede </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reducir el tamaño "físico" almacenado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en PostgreSQL y su impacto en el rendimiento del servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se trata de la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configuración de TOAST y la alineación de datos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">"En promedio", estos métodos ahorrarán no demasiados recursos, pero sin ninguna modificación en el código de la aplicación.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cj/c-/lx/cjc-lxht8brbyy9xif_sicdwk70.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, nuestra experiencia resultó ser muy productiva a este respecto, ya que el repositorio de casi cualquier monitoreo es, por su naturaleza, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mayormente solo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en términos de datos registrados. </font><font style="vertical-align: inherit;">Y si está interesado en cómo puede enseñarle a una base de datos a escribir en un disco en lugar de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">200 MB / s la</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mitad, le pido un corte.</font></font><br>
<a name="habracut"></a><br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pequeños secretos de Big Data</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Según el perfil de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuestro servicio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , recibe regularmente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paquetes de texto</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de los registros </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y dado que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el complejo VLSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cuyas bases de datos estamos monitoreando, es un producto multicomponente con estructuras de datos complejas, las consultas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para lograr el máximo rendimiento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se obtienen mediante tales </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"volúmenes múltiples" con lógica algorítmica compleja</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por lo tanto, el volumen de cada instancia individual de la solicitud o el plan de ejecución resultante en el registro que llega a nosotros resulta ser "promedio" bastante grande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos la estructura de una de las tablas en la que escribimos los datos "en bruto", es decir, aquí está el texto original de la entrada del registro:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> rawdata_orig(<font></font>
  pack <span class="hljs-comment">-- PK</span>
    <span class="hljs-keyword">uuid</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
, recno <span class="hljs-comment">-- PK</span>
    <span class="hljs-built_in">smallint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
, dt <span class="hljs-comment">--  </span>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">data</span> <span class="hljs-comment">--  </span>
    <span class="hljs-built_in">text</span>
, PRIMARY <span class="hljs-keyword">KEY</span>(pack, recno)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una placa típica (ya dividida, por supuesto, es una plantilla de sección), donde lo más importante es el texto. A veces bastante voluminoso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recuerde que el tamaño "físico" de un registro en PG no puede ocupar más de una página de datos, pero el tamaño "lógico" es un asunto completamente diferente. Para escribir un valor de volumen (varchar / text / bytea) en el campo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utiliza la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">tecnología TOAST</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL utiliza un tamaño de página fijo (generalmente 8 KB) y no permite que las tuplas abarquen varias páginas. </font><font style="vertical-align: inherit;">Por lo tanto, es imposible almacenar directamente valores de campo muy grandes. </font><font style="vertical-align: inherit;">Para superar esta limitación, los valores de campo grandes se comprimen y / o dividen en varias líneas físicas. </font><font style="vertical-align: inherit;">Esto pasa desapercibido para el usuario y afecta ligeramente a la mayoría del código del servidor. </font><font style="vertical-align: inherit;">Este método se conoce como TOAST ...</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, para cada tabla con campos "potencialmente grandes" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se crea</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> automáticamente </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">una tabla emparejada con "corte" de</font></a><font style="vertical-align: inherit;"> cada registro "grande" en segmentos de 2 KB:</font></font><br>
<br>
<pre><code class="sql hljs">TOAST(<font></font>
  chunk_id<font></font>
    integer<font></font>
, chunk_seq<font></font>
    integer<font></font>
, chunk_data<font></font>
    bytea<font></font>
, PRIMARY KEY(chunk_id, chunk_seq)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, si tenemos que escribir una fila con un valor "grande" </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el registro real se producirá </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no solo en la tabla principal y su PK, sino también en TOAST y su PK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reduce el efecto TOSTADA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero la mayoría de los registros aquí todavía no son tan grandes, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deberían caber en 8 KB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ¿cómo ahorraría en esto? ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí el atributo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>STORAGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la columna de la tabla </font><font style="vertical-align: inherit;">nos ayuda </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXTENDIDO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite tanto la compresión como el almacenamiento por separado. </font><font style="vertical-align: inherit;">Esta es la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opción estándar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para la mayoría de los tipos de datos compatibles con TOAST. </font><font style="vertical-align: inherit;">Primero, se intenta realizar la compresión, luego se guarda fuera de la tabla si la fila sigue siendo demasiado grande.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PRINCIPAL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite la compresión, pero no el almacenamiento por separado. </font><font style="vertical-align: inherit;">(De hecho, se realizará un almacenamiento por separado para tales columnas, pero solo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como último recurso</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cuando no haya otra forma de reducir la fila para que se ajuste a la página).</font></font></li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De hecho, esto es exactamente lo que necesitamos para el texto: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exprimirlo tanto como sea posible, e incluso si no cabe en absoluto, ponerlo en TOAST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Puede hacer esto directamente "sobre la marcha", con un comando:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> rawdata_orig <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">SET</span> <span class="hljs-keyword">STORAGE</span> <span class="hljs-keyword">MAIN</span>;</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo evaluar el efecto?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que el flujo de datos cambia todos los días, no podemos comparar números absolutos, pero en términos relativos, cuanto </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menor sea la proporción</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que registramos en TOAST, mejor. </font><font style="vertical-align: inherit;">Pero existe un peligro: cuanto mayor es el volumen "físico" de cada registro individual, más "ancho" se vuelve el índice, porque se deben cubrir más páginas de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sección </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">antes de los cambios</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<pre><code class="plaintext hljs">heap  = 37GB (39%)<font></font>
TOAST = 54GB (57%)<font></font>
PK    =  4GB ( 4%)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sección </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">después de los cambios</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<pre><code class="plaintext hljs">heap  = 37GB (67%)<font></font>
TOAST = 16GB (29%)<font></font>
PK    =  2GB ( 4%)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, comenzamos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a escribir en TOAST 2 veces con menos frecuencia</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lo que descargó no solo el disco, sino también la CPU:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jc/te/dr/jctedr4gcninasuw54qer9qu_8u.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bp/lj/wr/bpljwrysoy42rtnu3ds0btue7ka.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observo que también comenzamos a "leer" menos el disco, no solo a "escribir", porque cuando inserta un registro en una tabla, también tiene que "restar" una parte del árbol de cada uno de los índices para determinar su posición futura en ellos.</font></font><br>
<br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quién en PostgreSQL 11 vive bien</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de actualizar a PG11, decidimos continuar "ajustando" TOAST y notamos que a partir de esta versión, el parámetro estuvo disponible para la configuración </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>toast_tuple_target</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El código de procesamiento de TOAST se activa solo cuando el valor de fila que se almacenará en la tabla es mayor que TOAST_TUPLE_THRESHOLD bytes (generalmente 2 Kb). </font><font style="vertical-align: inherit;">El código de TOAST comprimirá y / o moverá los valores de campo fuera de la tabla hasta que el valor de la fila sea menor que TOAST_TUPLE_TARGET bytes (variable, generalmente también 2 KB) o sea imposible reducir el tamaño.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decidimos que los datos que usualmente tenemos son "muy cortos" o inmediatamente "muy largos", por lo que decidimos limitarnos al valor más bajo posible:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> rawplan_orig <span class="hljs-keyword">SET</span> (toast_tuple_target = <span class="hljs-number">128</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos cómo la nueva configuración afectó la carga del disco después de la migración:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pp/cz/k7/ppczk7f8qj9cu_hixtltdk_wvo4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡No está mal! </font><font style="vertical-align: inherit;">La </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cola</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> promedio </font><b><font style="vertical-align: inherit;">para un disco se redujo</font></b><font style="vertical-align: inherit;"> aproximadamente 1.5 veces, y la "ocupación" del disco - ¡en un 20 por ciento! </font><font style="vertical-align: inherit;">Pero tal vez esto de alguna manera afectó a la CPU?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xa/vj/sq/xavjsqger1hmawiiidzngvzcff0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al menos, definitivamente no empeoró. </font><font style="vertical-align: inherit;">Sin embargo, es difícil juzgar si incluso tales volúmenes aún no pueden elevar la carga promedio de la CPU por encima del </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5%</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<font color="#4060a0"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desde un cambio de posición, la suma ... ¡cambia!</font></font></h2></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como sabe, un centavo ahorra un rublo, y con nuestros volúmenes de almacenamiento de aproximadamente 10 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TB / mes,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> incluso una pequeña optimización puede dar una buena ganancia. Por lo tanto, llamamos la atención sobre la estructura física de nuestros datos: cómo se presentan exactamente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">los "campos" dentro del registro de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada tabla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debido a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la alineación de datos,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> esto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afecta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directamente </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">el volumen resultante</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muchas arquitecturas proporcionan la alineación de datos a través de los límites de palabras de máquina. </font><font style="vertical-align: inherit;">Por ejemplo, en un sistema x86 de 32 bits, los enteros (tipo entero, ocupa 4 bytes) se alinearán en el borde de las palabras de 4 bytes, así como los números de coma flotante de precisión doble (tipo de precisión doble, 8 bytes). </font><font style="vertical-align: inherit;">Y en un sistema de 64 bits, los valores dobles se alinearán en el borde de las palabras de 8 bytes. </font><font style="vertical-align: inherit;">Este es otro motivo de incompatibilidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debido a la alineación, el tamaño de la fila de la tabla depende del orden de los campos. </font><font style="vertical-align: inherit;">Por lo general, este efecto no es muy notable, pero en algunos casos puede conducir a un aumento significativo de tamaño. </font><font style="vertical-align: inherit;">Por ejemplo, si coloca campos de tipos char (1) y enteros mezclados, entre ellos, por regla general, se perderán 3 bytes por nada.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con los modelos sintéticos:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_column_size(<span class="hljs-keyword">ROW</span>(
  <span class="hljs-string">'0000-0000-0000-0000-0000-0000-0000-0000'</span>::<span class="hljs-keyword">uuid</span>
, <span class="hljs-number">0</span>::<span class="hljs-built_in">smallint</span>
, <span class="hljs-string">'2019-01-01'</span>::<span class="hljs-built_in">date</span><font></font>
));<font></font>
<span class="hljs-comment">-- 48 </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> pg_column_size(<span class="hljs-keyword">ROW</span>(
  <span class="hljs-string">'2019-01-01'</span>::<span class="hljs-built_in">date</span>
, <span class="hljs-string">'0000-0000-0000-0000-0000-0000-0000-0000'</span>::<span class="hljs-keyword">uuid</span>
, <span class="hljs-number">0</span>::<span class="hljs-built_in">smallint</span><font></font>
));<font></font>
<span class="hljs-comment">-- 46 </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿De dónde vino el par extra de bytes en el primer caso? </font><font style="vertical-align: inherit;">Todo es simple: una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">letra pequeña de 2 bytes se alinea en un límite de 4 bytes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes del siguiente campo, y cuando es el último, no hay nada y no es necesario alinearlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En teoría, todo está bien y puede reorganizar los campos a su gusto. </font><font style="vertical-align: inherit;">Veamos datos reales en el ejemplo de una de las tablas, cuya sección diaria toma 10-15GB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estructura fuente:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.plan_20190220<font></font>
(<font></font>
<span class="hljs-comment">--  from table plan:  pack uuid NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  recno smallint NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  host uuid,</span>
<span class="hljs-comment">--  from table plan:  ts timestamp with time zone,</span>
<span class="hljs-comment">--  from table plan:  exectime numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  duration numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  bufint bigint,</span>
<span class="hljs-comment">--  from table plan:  bufmem bigint,</span>
<span class="hljs-comment">--  from table plan:  bufdsk bigint,</span>
<span class="hljs-comment">--  from table plan:  apn uuid,</span>
<span class="hljs-comment">--  from table plan:  ptr uuid,</span>
<span class="hljs-comment">--  from table plan:  dt date,</span>
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190220_pkey PRIMARY <span class="hljs-keyword">KEY</span> (pack, recno),
  <span class="hljs-keyword">CONSTRAINT</span> chck_ptr <span class="hljs-keyword">CHECK</span> (ptr <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>),
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190220_dt_check <span class="hljs-keyword">CHECK</span> (dt = <span class="hljs-string">'2019-02-20'</span>::<span class="hljs-built_in">date</span>)<font></font>
)<font></font>
INHERITS (public.plan)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La sección después de cambiar el orden de las columnas es exactamente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el mismo campo, solo el orden es diferente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> public.plan_20190221<font></font>
(<font></font>
<span class="hljs-comment">--  from table plan:  dt date NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  ts timestamp with time zone,</span>
<span class="hljs-comment">--  from table plan:  pack uuid NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  recno smallint NOT NULL,</span>
<span class="hljs-comment">--  from table plan:  host uuid,</span>
<span class="hljs-comment">--  from table plan:  apn uuid,</span>
<span class="hljs-comment">--  from table plan:  ptr uuid,</span>
<span class="hljs-comment">--  from table plan:  bufint bigint,</span>
<span class="hljs-comment">--  from table plan:  bufmem bigint,</span>
<span class="hljs-comment">--  from table plan:  bufdsk bigint,</span>
<span class="hljs-comment">--  from table plan:  exectime numeric(32,3),</span>
<span class="hljs-comment">--  from table plan:  duration numeric(32,3),</span>
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190221_pkey PRIMARY <span class="hljs-keyword">KEY</span> (pack, recno),
  <span class="hljs-keyword">CONSTRAINT</span> chck_ptr <span class="hljs-keyword">CHECK</span> (ptr <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>),
  <span class="hljs-keyword">CONSTRAINT</span> plan_20190221_dt_check <span class="hljs-keyword">CHECK</span> (dt = <span class="hljs-string">'2019-02-21'</span>::<span class="hljs-built_in">date</span>)<font></font>
)<font></font>
INHERITS (public.plan)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El volumen total de la sección está determinado por el número de "hechos" y depende solo de procesos externos, por lo que dividimos el tamaño del montón ( </font></font><code>pg_relation_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) por el número de registros que contiene; es decir, obtenemos el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tamaño promedio del registro almacenado real</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jx/6e/im/jx6eimznnvdqtrzp6aohdvxluzs.png"></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menos del 6% del volumen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ¡excelente! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero todo, por supuesto, no es tan optimista, porque </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en los índices no podemos cambiar el orden de los campos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y, por lo tanto, "en general" ( </font></font><code>pg_total_relation_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ...</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/az/3m/6z/az3m6zsyv47wtawrbk_tdmwdpfg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... después de todo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ahorraron 1.5% aquí</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sin cambiar una sola línea de código. </font><font style="vertical-align: inherit;">¡Sí Sí!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gb/dr/ps/gbdrpsonli0eclk4ozdjjtofnda.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observo que la disposición anterior de los campos no es el hecho más óptimo. </font><font style="vertical-align: inherit;">Debido a que algunos bloques de campo ya no quieren ser "desgarrados" por razones estéticas, por ejemplo, un par </font></font><code>(pack, recno)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que es PK para esta tabla. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, la definición de la disposición de campo "mínimo" es una tarea "exhaustiva" bastante simple. </font><font style="vertical-align: inherit;">Por lo tanto, puede obtener resultados en sus datos incluso mejores que los nuestros: ¡pruébelo!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498280/index.html">La historia del pájaro Dodo del género Phoenix. La gran caída de Dodo es</a></li>
<li><a href="../es498282/index.html">[instrucción] Crear una cuenta y un sitio en la plataforma Google Site</a></li>
<li><a href="../es498284/index.html">Cómo optimizar el aprendizaje del inglés</a></li>
<li><a href="../es498288/index.html">Tu ciudad necesita un metro bus</a></li>
<li><a href="../es498290/index.html">Hidrología de procedimiento: simulación dinámica de ríos y lagos.</a></li>
<li><a href="../es498294/index.html">Detección de objetos Reconocer y gobernar. Parte 1</a></li>
<li><a href="../es498296/index.html">Diseño a nivel de sistema. Parte 1. De la idea al sistema</a></li>
<li><a href="../es498298/index.html">Las empresas usan recompensas de errores para comprar silencio de hackers</a></li>
<li><a href="../es498300/index.html">Blitz.Engine: sistema de activos</a></li>
<li><a href="../es498302/index.html">Licencia avanzada de la OIT. ¿Por qué se necesita en este momento?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>