<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💏 🍫 👨🏼‍🔬 コピー時のLinuxのコピーオンライトの何が問題になっていますか 👩🏽‍🤝‍👩🏻 👦🏻 👏🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="警告：この記事は、コピー時にreflinkをサポートするLinux上のすべてのCoWファイルシステムに適用されます。現時点では、BTRFS、XFS、およびOCFS2です。
 
 FSの方が優れているholivarsは控えてください：Btrfs、XFS、Reiser4、NILFS2、ZFS、またはいく...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>コピー時のLinuxのコピーオンライトの何が問題になっていますか</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/473752/"><img src="https://habrastorage.org/webt/qw/nj/qi/qwnjqihrrrxvxhguqnrmo6u7jrc.gif"><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事は、コピー時にreflinkをサポートするLinux上のすべてのCoWファイルシステムに適用されます。</font><font style="vertical-align: inherit;">現時点では、BTRFS、XFS、およびOCFS2です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FSの方が優れているholivarsは控えてください：Btrfs、XFS、Reiser4、NILFS2、ZFS、またはいくつかの言及されていないもの。</font></font></i><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックグラウンド</font></font></h4><br>
<ul>
<li>21  2001  — Namesys  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://web.archive.org/web/20010721194924/"> Reiser4</a>. DARPA  .</li>
<li>20  2003 — Namesys   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://web.archive.org/web/20031206082146/"> Reiser4</a>.</li>
<li>24  2004 — Namesys    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://web.archive.org/web/20040824015931/">Reiser4</a>.</li>
<li>14  2004 —  ZFS.</li>
<li>16  2005 — ZFS   27  OpenSolaris.</li>
<li> 2006 —      ,  .   Namesys</li>
<li>12  2007 — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Btrfs</a>   (  Namesys).</li>
<li>22  2011 —  ZFSonLinux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>     reflink.</li>
<li>2012 — Btrfs   Oracle Linux  SUSE Linux Enterprise</li>
<li>21  2013 — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    c Btrfs </a>     Linux.</li>
<li> 2019 — Btrfs   RHEL 8 (   ,   Btrfs  Oracle)</li>
</ul><br>
<h4>    CoW- </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2001年にReiser4が発表されたとき、私はコピーオンライトに刺激を受け、情熱を持っていました。考えてみれば、さまざまなプロジェクトのコピーを好きなだけ簡単に簡単に作成でき、物理的にディスクにはそれらの違いのみが保存されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、コピー速度は無作為に増加するはずです。コピーするときに、古いファイルへの参照リンクのみが作成されるためです。このような新しいファイルに書き込むと、変更されたデータのセクターが自動的に割り当てられます。その結果、ファイルの共通部分に同じセクターがあり、異なるセクターに異なる部分が記録されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、共有ホスティング用のアカウントを作成するための万能薬のように見えましたが、今では軽量の仮想マシンとコンテナに最適なソリューションです。結局のところ、同じファイルのスペースを無駄にすることができず、同時にユーザーが簡単にファイルを変更できるようにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ハンス・ライザーは屋根に行って彼の妻を殺しました、そして、彼の発案（おそらく政治的理由のために）はコアに含まれませんでした。たぶん、結局のところ、話は特定の人に依存していますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZFSはLinuxと互換性のないライセンスの下で公開されていたため、カーネルには含まれていませんでした。そのため、LinuxへのZFSの導入は長い間遅くなりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、私はBtrfsを待ち始めました。そして発表からわずか6年後には、Linuxカーネルの開発者から安定版と認められました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、データ変更は毎回新しい場所に書き込まれるため、Copy-on-Writeパラダイム自体が断片化の増大を意味するため、Cowシステムを使用するために時間をかけました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HDDの場合、読み取りヘッドのブロックを再配置するプロセスは非常に時間のかかる操作であるため、断片化によってパフォーマンスが低下します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、私は自分のマシンでのbtrfsの実装をSSDに切り替えるまで個人的に延期しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SSDはフラグメンテーションも好きではないことに注意してください。SSDの場合、線形書き込み/読み取りはランダムアクセスより数十倍高速である可能性があることは誰もが知っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、断片化されたSSDのパフォーマンスは、HDDのパフォーマンスほど劇的ではありません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、CoWでのコピー速度はどうでしょうか。</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてついに、時が来ました。</font><font style="vertical-align: inherit;">SSDの信頼性が十分になったとき、私はCoWファイルシステムをマイトとメインで使用し始めました。</font><font style="vertical-align: inherit;">より具体的には、BtrfsとNilfs2。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スナップショットのエキサイティングな可能性を習得して、しばらくの間、超高速ファイルコピーに関する2000年代からの期待を忘れていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しばらくして、テストをすることにしました。</font><font style="vertical-align: inherit;">そして、私が非常に失望したことに、コピーするときにCoWからの速度の増加は見られませんでした。</font><font style="vertical-align: inherit;">SATA SSDでの結果は次のとおりです。</font></font><br>
<br>
<pre><code class="bash hljs">time cp -a /usr /usr1<font></font>
real    0m15,572s<font></font>
user    0m0,240s<font></font>
sys     0m4,739s</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CoWを使用するには、特別なキーを指定する必要があることがわかりました。</font></font><br>
<br>
<pre><code class="bash hljs">time cp -a --reflink=auto /usr /usr2<font></font>
<font></font>
real    0m3,166s<font></font>
user    0m0,178s<font></font>
sys     0m2,891s</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合のみ、5倍の利点があります。</font><font style="vertical-align: inherit;">ちなみに、アドバンテージのサイズは、ファイルの長さが長くなると無制限に大きくなります。</font></font><code>/usr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コピーした</font><font style="vertical-align: inherit;">フォルダ</font><font style="vertical-align: inherit;">はほとんどが小さなファイルです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CoWファイルシステムの主な利点がデフォルトで使用されない理由に私は信じられないほど驚いた。</font><font style="vertical-align: inherit;">確かに、これのために彼女は作成されました！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、Btrfsセクションでコピーをテストしました。</font><font style="vertical-align: inherit;">しかし、reflinkをサポートする他のCoWファイルシステムでも同様の結果が得られます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビリー、何が問題なの？</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題はcpにあります。</font><font style="vertical-align: inherit;">デフォルトでは、コピー時にCoWを使用しません。</font><font style="vertical-align: inherit;">できますが。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたは言うことができます-私はcpを使用しません。</font><font style="vertical-align: inherit;">ただし、Linuxの内部では、ほとんどどこでも使用されています。</font><font style="vertical-align: inherit;">多くのプログラム</font></font><code>cp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、「バイク」ではなく、</font><font style="vertical-align: inherit;">何かをコピーする必要があるときに使用し</font><font style="vertical-align: inherit;">ます。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
coreutils開発者が、CoWファイルシステムの利点の半分を打ち消すほどのあいまいな決定をしたのはなぜですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結局、GNU coreutilsの開発を担当するPádraigBradyが決定しました。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに彼の論理があり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます：</font></font><br>
<br>
<blockquote><ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デフォルトでは、cpはCoWを使用しません。誰かがファイルシステムの破壊後にファイルをディスクに保存する可能性を高めるためにコピーを使用する可能性があるためです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パフォーマンスの面では、ある種の遅延に影響されやすいプロセスがある場合、コピー中にメインの記録を正確に行う必要がある場合があります。そのため、後でこれが発生した場合、ハードドライブのヘッドを再配置するときに遅れが生じることがあります。</font><font style="vertical-align: inherit;">バージョン8.24 coreutils以降、mvはデフォルトでreflinkオプションを使用することに注意してください。</font></font></li>
</ol><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PádraigBradyの回答テキスト（英語）</font></font></b><div class="spoiler_text">It's not the default since for robustness reasons one may want a copy to take place to protect against data corruption. Also for performance reasons you may want the writes to happen at copy time rather than some latency sensitive process working on a CoW file and being delayed by the writes possibly to a different part of a mechanical disk. Note that from coreutils v8.24 mv will reflink by default, since it doesn't have the above constraints.</div></div></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mvの速度に関しては、ファイルを移動するときに、CoWからのメリットはほとんどありません。</font><font style="vertical-align: inherit;">単一のファイルシステム内では、mvはほとんど常に非常に高速に動作します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
繰り返しになりますが、問題は歴史に対する人格の影響について生じます。</font><font style="vertical-align: inherit;">プログラムのソースコードにいくつかの文字を別々に配置することで、数千万から数億人のユーザーのコピーを遅くすることができます（ここでは、ほとんどの人がコンピューターを持たなくても、何らかの形でクラウドサービスを使用していることを考慮する必要があります）、ドライブの使用効率を下げます。世界中で売上を伸ばします。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パドレーグの引数の解析</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の議論は理にかなっています。経験の浅いユーザーでも、同じファイルシステム上の貴重なファイルを実際にバックアップできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の引数。パドレイグからの遅延についてさらにコメントを読むと、既存のファイルに書き込むときに、ファイルシステムが空き領域を探すために遅延が発生する可能性があるデータベースの状況を彼が念頭に置いていたことがわかります。しかし、Jan Kanisが指摘したように、CoWファイルシステムの場合、CoWの性質上、新しいセクターは常に記録のために検索されます。したがって、私の意見では、2番目の引数は受け入れられません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、CoWシステムでは、データベースファイルに書き込むときに遅延や「領域不足」エラーが発生する可能性があります。</font><font style="vertical-align: inherit;">これを回避するには、最初にデータベースのCoWを無効にして空のディレクトリを作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のように、ディレクトリ/ファイルのCoWを無効にします。</font></font><br>
<br>
<pre><code class="bash hljs">chattr +C /dir/file<font></font>
chattr +C /dir/dir</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nodatacowをマウントするオプションもあります。</font><font style="vertical-align: inherit;">新しく作成されたすべてのファイルに適用されます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、デフォルトでコピーするときにCoWを使用したい場合はどうでしょうか。</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根本的な方法は、coreutilsにパッチを適用することです。</font><font style="vertical-align: inherit;">おそらく、プライベートリポジトリにパッケージを作成します。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">パッチcp.c</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ファイル</font><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="diff hljs"><span class="hljs-deletion">-x-&gt;reflink_mode = REFLINK_NEVER;</span>
<span class="hljs-addition">+x-&gt;reflink_mode = REFLINK_AUTO;</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それほど根本的な解決策は、シェルのcpエイリアスを作成することです。</font><font style="vertical-align: inherit;">たとえば、bashの場合：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フォルダー</font><font style="vertical-align: inherit;">で、内容を</font></font><code>/etc/profile.d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">含むファイル</font></font><code>cp_reflink.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">alias</span> cp=<span class="hljs-string">'cp --reflink=auto'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このソリューションは、cpがシェルから名前でアクセスされる場合、ほとんどすべての場合に機能します。</font><font style="vertical-align: inherit;">ただし、スクリプトで/ bin / cpを使用する場合、エイリアスは機能せず、通常どおりコピーが行われます。</font></font></li>
</ol><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルマネージャーとreflink</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2019年10月31日現在の状況：</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ミッドナイトコマンダー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -サポート。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Krusader-サポートしていません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イルカ-サポートしていません。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nautilus-はサポートしていません。 </font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nemo-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サポート。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラミング言語、システムコール、reflink</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのプログラミング言語はreflinkをサポートしていません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cでは、多くのプログラマーが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ループとバッファーを使用して</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まだコピー</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">しています</font></a><font style="vertical-align: inherit;">。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">sendfile</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
システムコール</font><font style="vertical-align: inherit;">はreflinkを使用しません。</font><font style="vertical-align: inherit;">FICLONEフラグを指定</font><font style="vertical-align: inherit;">した</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ioctl</font></a><font style="vertical-align: inherit;">システムコール</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
コード内の何かをコピーする必要がある場合は、それをそのまま、</font><font style="vertical-align: inherit;">または単に呼び出すことを</font><font style="vertical-align: inherit;">お勧めします</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<code>cp</code><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>cp</code><font style="vertical-align: inherit;"></font><code>cp --reflink=auto</code><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユビキタス仮想化とSSDの時代の到来とともに、CoWファイルシステムを使用することが非常に重要になっています。</font><font style="vertical-align: inherit;">スナップショットの作成、クイックコピーに便利です。</font><font style="vertical-align: inherit;">実際、コピー時にCoWを使用すると、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動的にデータの重複排除が行われます</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、このタイプのコピーをサポートしているファイルシステムはBTRFS、XFS、OCFS2の3つだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
内部メカニズムによってすでにCoWをサポートしているため、ZFSとNILFS2でreflinkのサポートが完了することを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、すべてのLinuxディストリビューションでは、ファイルのコピー時にCoWが無効になっているため、対応するキーを明示的に指定するか、エイリアスやパッチなどのさまざまなトリックを使用する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、Reiser4の発表から18年が経過しましたが、これまでのところ、軽量のCoWコピーが私たちの生活に浸透しているわけではありません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS DockerとCoW</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerがストレージとしてbtrfsをサポートしていることを知っていますか？</font><font style="vertical-align: inherit;">このオプションを有効にする必要があります。</font><font style="vertical-align: inherit;">デフォルトでは選択されていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理論的には、CoWファイルシステムは、異なる仮想マシンが同じカーネルを使用する場合の簡単な仮想化を完全に補完します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の意見では、CoWをシミュレートするための技術的な松葉杖であるOverlayFSおよびAufsよりもはるかに有機的です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DockerでBtrfsを使用するには、次のものが必要です。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerの新規（イメージと仮想マシンなし）インストールで、別のBtrfsボリュームを </font></font><code>/var/lib/docker</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker起動構成ファイルにオプションを追加する</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GentooおよびCalculate Linuxの場合、これは </font></font><code>/etc/conf.d/docker</code><br>
<br>
<pre><code class="bash hljs">DOCKER_OPTS=<span class="hljs-string">"--storage-driver btrfs --data-root /var/lib/docker"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これ</font><font style="vertical-align: inherit;">はすべてのディストリビューションのため</font><font style="vertical-align: inherit;">の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全な指示</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメントからの追加</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XFSとCoW</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">constb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：XFSでは、CoWも常にサポートされているわけではありません。</font><font style="vertical-align: inherit;">ファイルシステムを作成する必要があるc </font></font><code>mkfs.xfs -m reflink=1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作成されたFSでは、CoWサポートを「有効」にすることはできません。</font><font style="vertical-align: inherit;">さらに、4.11より前のカーネルでは、このオプションを含めると、機能が実験的なものであることをdmesgで警告します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOSとCoW</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MMik</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：OS Xでは、同様のコマンドオプション</font></font><code>cp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はthis </font></font><code>-c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これには、アトミックシステムコールの使用が含まれます</font></font><code>clonefile()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これにより、データブロックへの参照が元のファイルと同じである新しいファイルに関するエントリがファイルシステムに作成されます。</font><font style="vertical-align: inherit;">ファイルの属性と拡張属性がコピーされ、ファイル所有者情報とsetuid / setgidビットのリセットを除いて、アクセス制御リスト（ACL）エントリがコピーされます。</font><font style="vertical-align: inherit;">同じファイルシステム内で機能し、ファイルシステムによるサポートが必要です（属性ATTR_VOL_CAPABILITIES、フラグVOL_CAP_INT_CLONE）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OS X 10.12（Sierra）以降、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルシステムでのみサポートされます</font><font style="vertical-align: inherit;">。</font></font><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
謝辞：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habréの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブログ投稿でサポートと機能を公開するための</font><font style="vertical-align: inherit;">企業</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">RUVDS</font></a><font style="vertical-align: inherit;">。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ごとのTripletConcept</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS指示さ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れたエラーを個人的に指示します。</font><font style="vertical-align: inherit;">このためにカルマを増やします。</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下のクーポンを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">RUVDS</font></a><font style="vertical-align: inherit;"> 
から仮想マシンを注文することにより、CoWファイルシステムを試すことができ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja473732/index.html">10億ドルの北極圏下のケーブルネットワークの構築における詐欺の歴史</a></li>
<li><a href="../ja473740/index.html">Linux用のCreateRemoteThread</a></li>
<li><a href="../ja473742/index.html">CADおよびGIS用のEpsonエンジニアリングプリンター、および「堅牢な設計」に関する一言</a></li>
<li><a href="../ja473748/index.html">労働経済学者のためのベジエ曲線</a></li>
<li><a href="../ja473750/index.html">Stereopi + WebRTC =自宅でのテレプレセンス</a></li>
<li><a href="../ja473756/index.html">HTTPS DNS-半分と間違ったソリューション</a></li>
<li><a href="../ja473760/index.html">Psss、ひどいITストーリーが欲しいですか？</a></li>
<li><a href="../ja473762/index.html">仕事はオオカミではない、パート1。求人検索：9周HR-a</a></li>
<li><a href="../ja473764/index.html">小包は私のお気に入りのプロジェクトビルダーです</a></li>
<li><a href="../ja473766/index.html">大量のPythonコードの静的分析：Instagramの経験。パート1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>