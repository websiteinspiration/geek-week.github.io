<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ ü¶í üî° Como eu escrevi meu messenger ‚ö±Ô∏è üåÇ üëäüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma noite, depois de outro dia frustrante, cheio de tentativas de equilibrar o jogo, decidi que precisava urgentemente de um descanso. Vou mudar para ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como eu escrevi meu messenger</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490070/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma noite, depois de outro dia frustrante, cheio de tentativas de equilibrar o jogo, decidi que precisava urgentemente de um descanso. </font><font style="vertical-align: inherit;">Vou mudar para outro projeto, faz√™-lo rapidamente, devolver a auto-estima que diminuiu durante o desenvolvimento do jogo e atacar o jogo com vigor renovado! </font><font style="vertical-align: inherit;">O principal √© escolher um projeto agrad√°vel e relaxante ... Escreva seu pr√≥prio messenger? </font><font style="vertical-align: inherit;">Ha! </font><font style="vertical-align: inherit;">Qu√£o dif√≠cil isso pode ser? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo pode ser encontrado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><img src="https://habrastorage.org/webt/_b/cw/av/_bcwavbn-h0r3vgv8zzhdkaq09y.jpeg"></td>
<td><img src="https://habrastorage.org/webt/97/4x/qd/974xqd470ltfwu6gge0hfnaqry4.jpeg"></td>
</tr>
</tbody></table></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Breve hist√≥rico</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por quase um ano antes de come√ßar a trabalhar no messenger, ele trabalhava no jogo multiplayer online Line Tower Wars. </font><font style="vertical-align: inherit;">A programa√ß√£o correu bem, todo o resto (equil√≠brio e visual em particular) n√£o foi muito bom. </font><font style="vertical-align: inherit;">De repente, verificou-se que fazer um jogo e fazer um jogo divertido (divers√£o para algu√©m que n√£o seja ele mesmo) s√£o duas coisas diferentes. </font><font style="vertical-align: inherit;">Depois de um ano de prova√ß√£o, eu precisava me distrair, ent√£o decidi tentar outra coisa. </font><font style="vertical-align: inherit;">A escolha recaiu sobre o desenvolvimento m√≥vel, chamado Flutter. </font><font style="vertical-align: inherit;">Ouvi muitas coisas boas sobre Flutter e gostei do dardo ap√≥s um breve experimento. </font><font style="vertical-align: inherit;">Eu decidi escrever meu pr√≥prio mensageiro. </font><font style="vertical-align: inherit;">Em primeiro lugar, √© uma boa pr√°tica implementar cliente e servidor. </font><font style="vertical-align: inherit;">Em segundo lugar, haver√° algo significativo para colocar no portf√≥lio em busca de trabalho, estou apenas no processo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funcionalidade agendada</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bate-papo privado e em grupo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviando texto, imagens e v√≠deos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamadas de √°udio e v√≠deo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirma√ß√£o de recebimento e leitura (ticks da Votsap)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Imprime ..."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifica√ß√µes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pesquisa por c√≥digo QR e geolocaliza√ß√£o</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No futuro, posso dizer com orgulho (e com al√≠vio) que quase tudo o que foi planejado foi implementado e ainda n√£o foi implementado - ser√° implementado em um futuro pr√≥ximo.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://player.vimeo.com/video/393246625" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sele√ß√£o de idioma</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o pensei muito tempo com a escolha do idioma. </font><font style="vertical-align: inherit;">No come√ßo, era tentador usar o dardo para o cliente e o servidor, mas uma inspe√ß√£o mais detalhada mostrou que n√£o h√° muitos drivers para dardos dispon√≠veis e aqueles que n√£o inspiram muita confian√ßa. </font><font style="vertical-align: inherit;">Embora eu n√£o prometa falar sobre o momento atual, a situa√ß√£o pode ter melhorado. </font><font style="vertical-align: inherit;">Ent√£o, minha escolha recaiu sobre C #, com a qual trabalhei no Unity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitetura</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele come√ßou pensando sobre arquitetura. </font><font style="vertical-align: inherit;">Obviamente, considerando que 3 pessoas e meia provavelmente usar√£o meu messenger, n√£o seria necess√°rio se preocupar com a arquitetura em geral. </font><font style="vertical-align: inherit;">Voc√™ pega e faz como em in√∫meros tutoriais. </font><font style="vertical-align: inherit;">Aqui est√° o n√≥, aqui est√° o mongo, aqui est√£o os soquetes da web. </font><font style="vertical-align: inherit;">Feito. </font><font style="vertical-align: inherit;">E o Firebase est√° por aqui. </font><font style="vertical-align: inherit;">Mas n√£o √© interessante. </font><font style="vertical-align: inherit;">Decidi criar um mensageiro que pode ser facilmente escalonado horizontalmente, como se eu esperasse milh√µes de clientes simult√¢neos. </font><font style="vertical-align: inherit;">No entanto, como n√£o tinha experi√™ncia nessa √°rea, tive que aprender tudo na pr√°tica pelo m√©todo dos erros e novamente erros.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A arquitetura final se parece com isso</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/xp/jc/n7/xpjcn7otuw8am5jv9yztpp1sgyu.png"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o afirmo que essa arquitetura seja super legal e confi√°vel, mas √© vi√°vel e, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em teoria,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve suportar cargas pesadas e escalar horizontalmente, mas n√£o entendo realmente como verificar. </font><font style="vertical-align: inherit;">E espero n√£o ter perdido um momento √≥bvio conhecido por todos, exceto eu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abaixo est√° uma descri√ß√£o detalhada dos componentes individuais.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor front-end</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo antes de come√ßar a fazer o jogo, fiquei fascinado pelo conceito de um servidor de thread √∫nico ass√≠ncrono. </font><font style="vertical-align: inherit;">Efetivamente e sem potencial race'ov - o que mais voc√™ pode pedir. </font><font style="vertical-align: inherit;">Para entender como esses servidores s√£o organizados, comecei a me aprofundar no m√≥dulo da </font></font><code>asyncio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linguagem python. </font><font style="vertical-align: inherit;">A solu√ß√£o que vi parecia muito elegante. </font><font style="vertical-align: inherit;">Em suma, a solu√ß√£o de pseudo-c√≥digo se parece com isso.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-comment">//  ,      ,    </span>
<span class="hljs-comment">//       .      socket.Receive</span>
<span class="hljs-comment">//     , :</span>
<span class="hljs-keyword">var</span> bytesReceived = Completer&lt;<span class="hljs-keyword">object</span>&gt;();<font></font>
selector.Register(<font></font>
    socket,<font></font>
    SocketEvent.Receive,<font></font>
    () =&gt; bytesReceived.Complete(<span class="hljs-literal">null</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">await</span> bytesReceived.Future;<font></font>
<font></font>
<span class="hljs-keyword">int</span> n = socket.Receive(...); <span class="hljs-comment">//   </span><font></font>
<font></font>
<span class="hljs-comment">// selector -     poll.   </span>
<span class="hljs-comment">//        (Receive </span>
<span class="hljs-comment">//  ), ,    ,  .</span>
<span class="hljs-comment">//   completer,      ,</span>
<span class="hljs-comment">//        , ,     .</span>
<span class="hljs-comment">//     ,       .</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando esta t√©cnica simples, podemos atender um grande n√∫mero de soquetes em uma √∫nica rosca. </font><font style="vertical-align: inherit;">Nunca bloqueamos um fluxo enquanto esperamos que os bytes sejam recebidos ou enviados. </font><font style="vertical-align: inherit;">O fluxo est√° sempre ocupado com um trabalho √∫til. </font><font style="vertical-align: inherit;">Concorr√™ncia, em uma palavra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Servidores front-end s√£o implementados dessa maneira. </font><font style="vertical-align: inherit;">Eles s√£o todos de thread √∫nico e ass√≠ncrono. </font><font style="vertical-align: inherit;">Portanto, para obter o desempenho m√°ximo, voc√™ precisa executar o n√∫mero de servidores em uma m√°quina que possua n√∫cleos (4 na imagem). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O servidor Frontend l√™ a mensagem do cliente e, com base no c√≥digo da mensagem, envia-a para um dos t√≥picos do Kafka.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma pequena nota de rodap√© para quem n√£o conhece o kafa</font></font></b><div class="spoiler_text">   ,          RabbitMQ.    .       ,              (   authentication backend     authentication, ).  ?      -  ,         (partition).      ,      .      ,   ,       . ,             ( ,   ,  ,     (headers)).<br>
<br>
  ?     ?      .   (consumer)         (  consumer'),    ( )      . , ,      ,    2 ,       .   3 ‚Äî     2.                .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O servidor front-end envia uma mensagem para o kafka sem uma chave (quando n√£o h√° chave, o kafka simplesmente envia mensagens para a parte). A mensagem √© retirada do t√≥pico por um dos servidores de back-end correspondentes. O servidor processa a mensagem e ... o que vem depois? E o que mais depende do tipo de mensagem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No caso mais comum, ocorre um ciclo de solicita√ß√£o-resposta. Por exemplo, para uma solicita√ß√£o de registro, basta responder ao cliente ( </font></font><code>Success</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code>EmailAlreadyInUse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etc). Mas para uma mensagem que cont√©m um convite para um bate-papo existente de novos membros (Vasya, Emil e Julia), precisamos responder imediatamente com tr√™s tipos diferentes de mensagens. O primeiro tipo - voc√™ precisa notificar o anfitri√£o sobre o resultado da opera√ß√£o (de repente ocorreu um erro no servidor). O segundo tipo - voc√™ precisa notificar todos os membros atuais do bate-papo que agora existem novos e novos membros no bate-papo. O terceiro √© enviar convites para Vasya, Emil e Yulia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, isso n√£o parece muito dif√≠cil, mas para enviar uma mensagem para qualquer cliente, precisamos: 1) descobrir em qual servidor front-end esse cliente est√° conectado (n√£o escolhemos em qual servidor o cliente se conectar√°, o balanceador decide por n√≥s); 2) envie uma mensagem do servidor back-end para o servidor front-end desejado; 3) envie uma mensagem para o cliente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar os pontos 1 e 2, decidi usar um t√≥pico separado (t√≥pico "servidores frontend"). A separa√ß√£o dos t√≥picos de autentica√ß√£o, sess√£o e chamada em parti√ß√µes serve como um mecanismo de paraleliza√ß√£o. Vemos que o servidor de sess√µes est√° muito carregado? Apenas adicionamos alguns novos servidores de parti√ß√£o e sess√£o, e o Kafka redistribuir√° a carga para n√≥s, descarregando os servidores de sess√£o existentes. A separa√ß√£o do t√≥pico "servidores frontend" na parti√ß√£o serve como um mecanismo de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roteamento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada servidor frontend corresponde a uma parte do t√≥pico "servidores frontend" (com o mesmo √≠ndice que o pr√≥prio servidor). Ou seja, servidor 0 - parti√ß√£o 0 e assim por diante. Kafka possibilita a assinatura n√£o apenas de um t√≥pico espec√≠fico, mas tamb√©m de uma parte espec√≠fica de um determinado t√≥pico. Todos os servidores front-end nas start-ups assinam a parti√ß√£o correspondente. Portanto, o servidor back-end pode enviar uma mensagem para um servidor front-end espec√≠fico enviando uma mensagem para uma parti√ß√£o espec√≠fica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, agora quando o cliente ingressa, voc√™ s√≥ precisa salvar em algum lugar um par de UserId - Frontend Server Index. Em caso de desconex√£o - excluir. Para esses fins, qualquer um dos muitos bancos de dados de valores-chave na mem√≥ria funcionar√°. Eu escolhi um rabanete.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como fica na pr√°tica. </font><font style="vertical-align: inherit;">Antes de tudo, depois que a conex√£o √© estabelecida, o cliente Andrey envia uma mensagem para o servidor </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O servidor Frontend recebe a mensagem e a encaminha para o t√≥pico da sess√£o, adicionando preliminarmente o cabe√ßalho ‚ÄúServidor Frontend‚Äù: {index}. </font><font style="vertical-align: inherit;">Um dos servidores de sess√£o de back-end receber√° uma mensagem, ler√° o token de autoriza√ß√£o, determinar√° que tipo de usu√°rio ingressou, ler√° o √≠ndice adicionado pelo servidor de front-end e gravar√° UserId - Index no rabanete. </font><font style="vertical-align: inherit;">A partir desse momento, o cliente √© considerado online e agora sabemos atrav√©s de qual servidor front-end (e, consequentemente, atrav√©s de qual parte do t√≥pico "servidores front-end") podemos "alcan√ß√°-lo" quando outros clientes enviam mensagens para Andrey. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* De fato, o processo √© um pouco mais complicado do que eu descrevi. </font><font style="vertical-align: inherit;">Voc√™ pode encontr√°-lo no c√≥digo fonte.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pseudo-c√≥digo do servidor front-end</font></font></h4><br>
<pre><code class="cs hljs"><span class="hljs-comment">// Frontend Server 6</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">// Consume from "Frontend Servers" topic, partition 6</span>
    <span class="hljs-keyword">var</span> messageToClient = consumer.Consume();
    <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {<font></font>
        relayMessageToClient(messageToClient);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">var</span> callbacks = selector.Poll();
    <span class="hljs-keyword">while</span> (callbacks.TryDequeue(<span class="hljs-keyword">out</span> callback)) {<font></font>
        callback();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
    <span class="hljs-keyword">while</span> (!callAtQueue.IsEmpty &amp;&amp; callAtQueue.PeekPriority() &lt;= now) {<font></font>
        callAtQueue.Dequeue()();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (messagesToRelayToBackendServers.TryDequeue(<span class="hljs-keyword">out</span> messageFromClient)) {
        <span class="hljs-comment">// choose topic</span><font></font>
        producer.Produce(topic, messageFromClient);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem alguns truques aqui. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><code>relayMessageToClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ser√° um erro simplesmente pegar o soquete desejado e come√ßar imediatamente a enviar uma mensagem para ele, porque talvez </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j√°</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> estamos </font><font style="vertical-align: inherit;">enviando outra mensagem para o cliente. Se come√ßarmos a enviar bytes sem verificar se o soquete est√° ocupado no momento, as mensagens ser√£o misturadas. Como em muitos outros lugares onde o processamento ordenado de dados √© necess√°rio, o truque √© usar uma fila, a saber, uma fila de Completadores ( </font></font><code>TaskCompletionSource</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em C #).</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-keyword">async</span> <span class="hljs-title">relayMessageToClient</span>(<span class="hljs-params">message</span>)</span> {
    <span class="hljs-comment">// find client</span>
    <span class="hljs-keyword">await</span> client.ReadyToSend();
    <span class="hljs-keyword">await</span> sendMessage(client, message);<font></font>
    client.CompleteSend();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> {
    <span class="hljs-comment">// ...</span>
    sendMessageQueue = <span class="hljs-keyword">new</span> LinkedList&lt;Completer&lt;<span class="hljs-keyword">object</span>&gt;&gt;();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">async</span> Future <span class="hljs-title">ReadyToSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = Completer&lt;<span class="hljs-keyword">object</span>&gt;();
	<span class="hljs-keyword">if</span> (sendMessageQueue.IsEmpty) {<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	} <span class="hljs-keyword">else</span> {
	    <span class="hljs-keyword">var</span> prevSendMessage = sendMessageQueue.Last;<font></font>
	    sendMessageQueue.AddLast(sendMessage);<font></font>
	    <span class="hljs-keyword">await</span> prevSendMessage.Future;<font></font>
	}<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CompleteSend</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-keyword">var</span> sendMessage = sendMessageQueue.RemoveFirst();<font></font>
	sendMessage.Complete(<span class="hljs-literal">null</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se a fila n√£o estiver vazia, o soquete j√° estar√° ocupado no momento. Crie um novo </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, adicione-o √† fila e </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ao </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anterior</font></font></i> <code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Assim, quando a mensagem anterior for enviada, ela </font></font><code>CompleteSend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√° conclu√≠da </font></font><code>completer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o que far√° com que o servidor comece a enviar a pr√≥xima mensagem. Essa fila tamb√©m permite propagar suavemente exce√ß√µes. Suponha que ocorreu um erro ao enviar uma mensagem para um cliente. Nesse caso, precisamos concluir, com a exce√ß√£o de enviar n√£o apenas esta mensagem, mas tamb√©m todas as mensagens que est√£o atualmente aguardando na fila (aguarde </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'ah'). Caso contr√°rio, eles continuar√£o travando e receberemos um vazamento de mem√≥ria. Por uma quest√£o de brevidade, o c√≥digo que faz isso n√£o √© mostrado aqui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2)</font></font><code>selector.Poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Na verdade, n√£o √© nem um truque, mas apenas uma tentativa de atenuar as defici√™ncias da implementa√ß√£o do m√©todo </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>selector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apenas um inv√≥lucro sobre esse m√©todo). Dependendo do sistema operacional, este m√©todo usa </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>poll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Mas isso n√£o √© importante aqui. O importante √© como esse m√©todo funciona com as listas que alimentamos na entrada (lista de soquetes para leitura, grava√ß√£o, verifica√ß√£o de erros). Esse m√©todo pega listas, consulta soquetes e deixa apenas os soquetes nas listas que est√£o prontos para executar a opera√ß√£o necess√°ria. Todos os outros soquetes s√£o lan√ßados das listas. O "chute" ocorre atrav√©s</font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ou seja, todos os elementos subsequentes s√£o alterados, o que √© ineficiente). Al√©m disso, como precisamos pesquisar todos os soquetes registrados a cada itera√ß√£o do ciclo, essa "limpeza" geralmente √© prejudicial, e precisamos preencher as listas todas as vezes. Podemos solucionar todos esses problemas usando um problema personalizado </font></font><code>List</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RemoveAt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cujo </font><font style="vertical-align: inherit;">m√©todo </font><font style="vertical-align: inherit;">n√£o remove o item da lista, mas simplesmente o marca como exclu√≠do. A classe </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© a minha implementa√ß√£o dessa lista. </font></font><code>ListForPolling</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√≥ funciona com o m√©todo </font></font><code>Socket.Select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e n√£o √© adequado para mais nada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3)</font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Na maioria dos casos, o servidor front-end, tendo enviado a mensagem do cliente para o servidor back-end, espera uma resposta (confirma√ß√£o de que a opera√ß√£o foi bem-sucedida ou um erro se algo der errado). Se ele n√£o esperar por uma resposta dentro de um per√≠odo configur√°vel, ele envia um erro ao cliente para que ele n√£o espere por uma resposta que nunca vir√°. </font></font><code>callAtQueue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â uma fila priorit√°ria. Imediatamente ap√≥s o servidor enviar a mensagem para Kafka, ele faz algo assim:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">long</span> now = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
callAtQueue.Enqueue(callback, now + config.WaitForReplyMSec);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No retorno de chamada, a espera de uma resposta √© cancelada e o envio do erro do servidor come√ßa. Se uma resposta do servidor back-end for recebida, o retorno de chamada n√£o far√° nada. </font><font style="vertical-align: inherit;">N√£o h√° como </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
us√°- </font></font><code>await Task.WhenAny(answerReceivedTask, Task.Delay(x))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lo, pois o c√≥digo ap√≥s a </font></font><code>Task.Delay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">execu√ß√£o no thread do pool. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, de fato, tudo sobre servidores front-end. Uma pequena corre√ß√£o √© necess√°ria aqui. De fato, o servidor n√£o est√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">totalmente</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rosca simples. Obviamente, o kafka sob o cap√¥ usa threads, mas quero dizer o c√≥digo do aplicativo. O fato √© que o envio de uma mensagem para o t√≥pico kafka (produ√ß√£o) pode n√£o ter √™xito. No caso de uma falha, Kafka repete o envio de um certo n√∫mero configur√°vel de vezes, mas, se sa√≠das repetidas falharem, Kafka abandona esse neg√≥cio como in√∫til. Voc√™ pode verificar se a mensagem foi enviada com sucesso ou n√£o na </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qual passamos para o m√©todo </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kafka chama esse manipulador no encadeamento de E / S do produtor (o encadeamento que envia mensagens). Devemos garantir que a mensagem tenha sido enviada com √™xito e, caso contr√°rio, cancelar a espera de uma resposta do servidor back-end (a resposta n√£o ocorrer√° porque a solicita√ß√£o n√£o foi enviada) e enviar um erro ao cliente. Ou seja, n√£o podemos evitar a intera√ß√£o com outro segmento.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Ao escrever um artigo, de repente percebi que n√£o podemos passar </font></font><code>deliveryHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o m√©todo </font></font><code>Produce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou simplesmente ignorar todos os erros kafka (o erro ainda ser√° enviado ao cliente pelo tempo limite que eu descrevi anteriormente) - ent√£o todo o nosso c√≥digo ser√° de thread √∫nico. </font><font style="vertical-align: inherit;">Agora estou pensando em como fazer melhor.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que, de fato, kafka, n√£o coelho?</font></font></b><div class="spoiler_text">,        ,   ,  , ,   RabbitMQ?        .  , ,   .     ?    ,         frontend .   ,     backend ,      ,          .    ,       ,     .   ,       error-prone.  ,     <code>basicGet</code> ,    ,   ,      .     .      <code>basicGet</code>,      ,       .          .<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor back-end</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comparado ao servidor front-end, praticamente n√£o h√° pontos interessantes aqui. </font><font style="vertical-align: inherit;">Todos os servidores back-end funcionam da mesma maneira. </font><font style="vertical-align: inherit;">Na inicializa√ß√£o, o servidor se inscreve no t√≥pico (autentica√ß√£o, sess√£o ou chamada, dependendo da fun√ß√£o), e o kafka atribui uma ou mais parti√ß√µes a ele. </font><font style="vertical-align: inherit;">O servidor recebe a mensagem da Kafka, processa e geralmente envia uma ou mais mensagens em resposta. </font><font style="vertical-align: inherit;">C√≥digo quase real:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">long</span> lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">var</span> consumeResult = consumer.Consume(<font></font>
            TimeSpan.FromMilliseconds(config.Consumer.PollTimeoutMSec)<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (consumeResult != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">var</span> workUnit = <span class="hljs-keyword">new</span> WorkUnit() {<font></font>
                ConsumeResult = consumeResult,<font></font>
            };<font></font>
<font></font>
            LinkedList&lt;WorkUnit&gt; workUnits;<font></font>
            <span class="hljs-keyword">if</span> (partitionToWorkUnits.ContainsKey(consumeResult.Partition)) {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition];<font></font>
            } <span class="hljs-keyword">else</span> {<font></font>
                workUnits = partitionToWorkUnits[consumeResult.Partition] =<font></font>
                    <span class="hljs-keyword">new</span> LinkedList&lt;WorkUnit&gt;();<font></font>
            }<font></font>
<font></font>
            workUnits.AddLast(workUnit);<font></font>
<font></font>
            handleWorkUnit(workUnit);<font></font>
        }<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (<font></font>
            DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - lastCommitTime &gt;=<font></font>
            config.Consumer.CommitIntervalMSec<font></font>
        ) {<font></font>
            commitOffsets();<font></font>
	    lastCommitTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que tipo de compensa√ß√µes a serem cometidas?</font></font></b><div class="spoiler_text">       .   ‚Äî   (offset)    (0, 1  ).         0.        <code>TopicPartitionOffset</code>.    (consume)   ,   <code>ConsumeResult</code>, ,   ,   <code>TopicPartitionOffset</code>.     ?<br>
<br>
  at least once delivery,  ,              (    ).     ,           (commited) . ,  consumer         16,  ,  16 ,   ,      ,   .     -  consumer'     consumer'        ,    16 + 1 (   + 1).    17   .        N ,       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desativei a confirma√ß√£o autom√°tica e me comprometo. Isso √© necess√°rio porque </font></font><code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, onde o processamento da mensagem √© realmente realizado, este √© um </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo, portanto, n√£o h√° garantia de que a mensagem 5 ser√° processada antes da mensagem 6. Kafka armazena apenas um deslocamento confirmado (e n√£o um conjunto de deslocamento), respectivamente, antes de confirmar o deslocamento 6, precisamos garantir que todas as mensagens anteriores tamb√©m tenham sido processadas. Al√©m disso, um servidor back-end pode consumir mensagens de v√°rias parti√ß√µes ao mesmo tempo e, portanto, deve certificar-se de confirmar o deslocamento correto para a parti√ß√£o correspondente. Para isso, usamos um mapa de hash da parti√ß√£o de formul√°rio: unidades de trabalho. Aqui est√° a apar√™ncia do c√≥digo </font></font><code>commitOffsets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(c√≥digo real desta vez):</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commitOffsets</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">foreach</span> (LinkedList&lt;WorkUnit&gt; workUnits <span class="hljs-keyword">in</span> partitionToWorkUnits.Values) {<font></font>
        WorkUnit lastFinishedWorkUnit = <span class="hljs-literal">null</span>;<font></font>
        LinkedListNode&lt;WorkUnit&gt; workUnit;<font></font>
        <span class="hljs-keyword">while</span> ((workUnit = workUnits.First) != <span class="hljs-literal">null</span> &amp;&amp; workUnit.Value.IsFinished) {<font></font>
            lastFinishedWorkUnit = workUnit.Value;<font></font>
            workUnits.RemoveFirst();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (lastFinishedWorkUnit != <span class="hljs-literal">null</span>) {<font></font>
            offsets.Add(lastFinishedWorkUnit.ConsumeResult.TopicPartitionOffset);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (offsets.Count &gt; <span class="hljs-number">0</span>) {<font></font>
        consumer.Commit(offsets);<font></font>
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> offset <span class="hljs-keyword">in</span> offsets) {<font></font>
            logger.Debug(<font></font>
                <span class="hljs-string">"{Identifier}: Commited offset {TopicPartitionOffset}"</span>,<font></font>
                identifier,<font></font>
                offset<font></font>
            );<font></font>
        }<font></font>
        offsets.Clear();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, iteramos sobre as unidades, localizamos a √∫ltima unidade conclu√≠da neste momento, ap√≥s a qual </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o h√°</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> unidades </font><i><font style="vertical-align: inherit;">incompletas</font></i><font style="vertical-align: inherit;"> e comprometemos o deslocamento correspondente. </font><font style="vertical-align: inherit;">Esse loop permite evitar confirma√ß√µes "holey". </font><font style="vertical-align: inherit;">Por exemplo, se atualmente tivermos 4 unidades ( </font></font><code>0: Finished, 1: Not Finished, 2: Finished, 3: Finished</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), podemos confirmar apenas a 0¬™ unidade, porque se confirmarmos a 3¬™ imediatamente, isso poder√° levar √† perda potencial da 1¬™, se o servidor morrer agora.</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkUnit</span> {
    <span class="hljs-keyword">public</span> ConsumeResult&lt;Null, <span class="hljs-keyword">byte</span>[]&gt; ConsumeResult { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> finished = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsFinished =&gt; finished == <span class="hljs-number">1</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Finish</span>(<span class="hljs-params"></span>)</span> {<font></font>
        Interlocked.Increment(<span class="hljs-keyword">ref</span> finished);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br>
<code>handleWorkUnit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como foi dito, o </font></font><code>async void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo e, consequentemente, est√° completamente envolvido </font></font><code>try-catch-finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Em </font></font><code>try</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ele chama o servi√ßo necess√°rio, e em </font></font><code>finally</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>workUnit.Finish()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os servi√ßos s√£o bastante triviais. </font><font style="vertical-align: inherit;">Aqui, por exemplo, qual c√≥digo √© executado quando o usu√°rio envia uma nova mensagem:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;ServiceResult&gt; <span class="hljs-title">createShareItem</span>(<span class="hljs-params">CreateShareItemMessage msg</span>)</span> {
    <span class="hljs-keyword">byte</span>[] message;
    <span class="hljs-keyword">byte</span>[] messageToPals1 = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">int</span>?[] partitions1 = <span class="hljs-literal">null</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  UserId  .</span>
    <span class="hljs-keyword">long</span>? userId = hashService.ValidateSessionIdentifier(msg.SessionIdentifier);
    <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">var</span> shareItem = <span class="hljs-keyword">new</span> ShareItemModel(<font></font>
            requestIdentifier: msg.RequestIdentifier,<font></font>
            roomIdentifier: msg.RoomIdentifier,<font></font>
            creatorId: userId,<font></font>
            timeOfCreation: <span class="hljs-literal">null</span>,<font></font>
            type: msg.ShareItemType,<font></font>
            content: msg.Content<font></font>
        );<font></font>
<font></font>
        <span class="hljs-comment">//      null,</span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">long</span>? timeOfCreation = <span class="hljs-keyword">await</span> storageService.CreateShareItem(shareItem);
        <span class="hljs-keyword">if</span> (timeOfCreation != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//      .</span>
            List&lt;<span class="hljs-keyword">long</span>&gt; pals = <span class="hljs-keyword">await</span> inMemoryStorageService.GetRoomPals(<font></font>
                msg.RoomIdentifier<font></font>
            );<font></font>
            <span class="hljs-keyword">if</span> (pals == <span class="hljs-literal">null</span>) {
            	<span class="hljs-comment">//     -       .</span>
                pals = <span class="hljs-keyword">await</span> storageService.GetRoomPals(msg.RoomIdentifier);
                <span class="hljs-keyword">await</span> inMemoryStorageService.SaveRoomPals(msg.RoomIdentifier, pals);<font></font>
            }<font></font>
<font></font>
            <span class="hljs-comment">//    ,  .</span><font></font>
            pals.Remove(userId.Value);<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (pals.Count &gt; <span class="hljs-number">0</span>) {
            	<span class="hljs-comment">//  ack,  ,    </span>
                <span class="hljs-comment">//    .</span>
                <span class="hljs-keyword">await</span> storageService.CreateAck(<font></font>
                    msg.RequestIdentifier, userId.Value, msg.RoomIdentifier,<font></font>
                    timeOfCreation.Value, pals<font></font>
                );<font></font>
<font></font>
                <span class="hljs-comment">// in -  UserId, out -   frontend ,</span>
                <span class="hljs-comment">//    .  -   -</span>
                <span class="hljs-comment">//   null.</span>
                partitions1 = <span class="hljs-keyword">await</span> inMemoryStorageService.GetUserPartitions(pals);<font></font>
<font></font>
                List&lt;<span class="hljs-keyword">long</span>&gt; onlinePals = getOnlinePals(pals, partitions1);<font></font>
<font></font>
                <span class="hljs-comment">//    ,       .</span>
                <span class="hljs-comment">//         .</span>
                <span class="hljs-keyword">if</span> (onlinePals.Count &gt; <span class="hljs-number">0</span>) {<font></font>
                    messageToPals1 = converterService.EncodeNewShareItemMessage(<font></font>
                        userId.Value, timeOfCreation.Value, onlinePals, shareItem<font></font>
                    );<font></font>
                    nullRepeatedPartitions(partitions1);<font></font>
                    <span class="hljs-comment">// -         </span>
                    <span class="hljs-comment">// frontend ,    null' .</span><font></font>
                }<font></font>
            }<font></font>
<font></font>
            message = converterService.EncodeSuccessfulShareItemCreationMessage(<font></font>
                msg.RequestIdentifier, timeOfCreation.Value<font></font>
            );<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            message = converterService.EncodeMessage(<font></font>
                MessageCode.RoomNotFound, msg.RequestIdentifier<font></font>
            );<font></font>
        }<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
        message = converterService.EncodeMessage(<font></font>
            MessageCode.UserNotFound, msg.RequestIdentifier<font></font>
        );<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServiceResult(<font></font>
        message: message, <span class="hljs-comment">//    .</span>
        messageToPals1: messageToPals1, <span class="hljs-comment">//  -    .</span><font></font>
        partitions1: partitions1<font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de dados</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maioria das funcionalidades dos servi√ßos chamados pelos servidores de back-end √© simplesmente adicionar novos dados ao banco de dados e processar os existentes. Obviamente, como o banco de dados est√° organizado e como operamos √© muito importante para o messenger, e aqui gostaria de dizer que abordei a quest√£o de escolher um banco de dados com muito cuidado depois de estudar cuidadosamente todas as op√ß√µes, mas n√£o √© assim. Acabei de escolher o CockroachDb porque promete muito com o m√≠nimo de esfor√ßo e possui sintaxe compat√≠vel com o postgres (eu trabalhei com o postgres antes). Havia pensamentos em usar Cassandra, mas no final decidi me debru√ßar sobre algo familiar. Eu nunca havia trabalhado com Kafka, ou com Rabbit, ou com Flutter e Dart, ou com WebRtc, ent√£o decidi n√£o arrastar Cassandra tamb√©m, porque tinha medo de me afogar em uma s√©rie de novas tecnologias para mim.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De todas as partes do meu projeto, o design do banco de dados √© o que mais duvido. N√£o tenho certeza de que as decis√µes que tomei sejam realmente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boas</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tudo funciona, mas poderia ser feito melhor. Por exemplo, existem tabelas ShareRooms (como chamo chats) e ShareItems (como chamo mensagens). Portanto, todos os usu√°rios que entram em uma sala s√£o registrados no campo jsonb dessa sala. Isso √© conveniente, mas obviamente muito lento, ent√£o provavelmente o refarei usando chaves estrangeiras. Ou, por exemplo, a tabela ShareItems armazena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todas as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mensagens. O que tamb√©m √© conveniente, mas como o ShareItems √© uma das tabelas mais carregadas (persistente </font></font><code>select</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font><code>insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), pode valer a pena criar uma nova tabela para cada sala ou algo parecido. O Kokroach dispersa registros em diferentes n√≥s; portanto, √© preciso pensar cuidadosamente sobre qual registro ir√° para obter o m√°ximo desempenho, mas n√£o o fiz. Em geral, como pode ser entendido de todas as op√ß√µes acima, os bancos de dados n√£o s√£o meu ponto forte. No momento, geralmente estou testando tudo para o postgres, e n√£o para o kokroach, porque h√° menos carga na minha m√°quina de trabalho, pois ela √© t√£o pobre em cargas que decolar√° em breve. Felizmente, o c√≥digo para postgres e kokroach difere bastante, portanto, mudar n√£o √© dif√≠cil.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, estou estudando como a cocroach realmente funciona (como o mapeamento ocorre entre SQL e o valor-chave (a cocroach usa o RocksDb sob o cap√¥), como distribui dados entre n√≥s, replica etc.). Certamente, valia a pena estudar o cocroach antes de us√°-lo, mas antes tarde do que nunca.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu acho que a base sofrer√° grandes mudan√ßas quando eu melhorar a compreens√£o desse problema. No momento, a mesa Acks est√° me assombrando. Nesta tabela, armazeno dados sobre quem ainda n√£o recebeu e quem ainda n√£o leu a mensagem (para mostrar as marcas de sele√ß√£o do usu√°rio). √â f√°cil notificar o usu√°rio que sua mensagem foi lida se o usu√°rio estiver on-line agora, mas se n√£o estiver, precisamos salvar essas informa√ß√µes para notific√°-lo mais tarde. E como as conversas em grupo est√£o dispon√≠veis, n√£o basta armazenar a sinaliza√ß√£o, voc√™ precisa de dados sobre usu√°rios individuais. Ent√£o aqui pedimos diretamente o uso de strings de bits (uma linha para usu√°rios que ainda n√£o receberam, a segunda - para aqueles que ainda n√£o leram). Especialmente suporte kokroach </font></font><code>bit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font><code>bit varying</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. No entanto, nunca descobri como implementar esse neg√≥cio, uma vez que a composi√ß√£o dos quartos pode mudar constantemente. Para que as cadeias de bits mantenham seu significado, os usu√°rios na sala devem permanecer na mesma ordem, o que √© bastante dif√≠cil de fazer quando, por exemplo, algum usu√°rio sai da sala. Existem op√ß√µes aqui. Talvez valha a pena escrever -1 em vez de excluir o usu√°rio do campo jsonb para que a ordem seja preservada ou usando algum m√©todo de controle de vers√£o, para que saibamos que essa cadeia de bits se refere √† ordem dos usu√°rios, que era ent√£o, e n√£o na ordem atual de usu√°rios. Ainda estou pensando em como implementar melhor esse neg√≥cio, mas, por enquanto, aqueles que ainda n√£o receberam e n√£o leram os usu√°rios tamb√©m s√£o apenas campos jsonb. Dado que a tabela Acks √© gravada com cada mensagem, a quantidade de dados √© grande.Embora o registro, √© claro, seja exclu√≠do quando a mensagem for recebida e lida por todos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flutter</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante muito tempo, trabalhei no servidor e usei clientes simples de console para o teste, por isso nem criei um projeto Flutter. </font><font style="vertical-align: inherit;">E quando eu o criei, pensei que a parte do servidor era uma </font><font style="vertical-align: inherit;">parte </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complexa</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o aplicativo √© assim, lixo, eu vou descobrir isso em alguns dias. </font><font style="vertical-align: inherit;">Enquanto trabalhava no servidor, criei o Hello Worlds para flutter algumas vezes para ter uma ideia da estrutura e, como o messenger n√£o requer nenhuma interface do usu√°rio complexa, pensei que estava completamente pronto. </font><font style="vertical-align: inherit;">Portanto, a interface do usu√°rio √© realmente um lixo, mas a implementa√ß√£o da funcionalidade me deu problemas (e ainda ser√° entregue, pois nem tudo est√° pronto).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gest√£o estatal</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O t√≥pico mais popular. Existem milhares de maneiras de gerenciar sua condi√ß√£o, e a abordagem recomendada √© alterada a cada seis meses. Agora, o mainstream √© o provedor. Pessoalmente, eu escolhi duas maneiras para mim: bloco e redux. Bloco (Business Logic Component) para gerenciamento de estado local e redux para gerenciamento global. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O bloco n√£o √© um tipo de biblioteca (embora, √© claro, tamb√©m exista uma biblioteca que reduz o padr√£o, mas eu n√£o a uso). O bloco √© uma abordagem baseada em fluxo. Em geral, o dardo √© uma linguagem bastante agrad√°vel, e os fluxos s√£o geralmente muito agrad√°veis. A ess√™ncia dessa abordagem √© que colocamos toda a l√≥gica de neg√≥cios em servi√ßos e nos comunicamos entre a interface do usu√°rio e os servi√ßos por meio de um controlador que nos fornece v√°rios fluxos. O usu√°rio clicou no bot√£o "encontrar contato"? Usando</font></font><code>sink</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(no outro extremo do fluxo), enviamos um evento para o controlador </font></font><code>SearchContactsEvent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o controlador chama o servi√ßo desejado, aguarda o resultado e retorna a lista de usu√°rios de volta √† interface do usu√°rio atrav√©s do fluxo tamb√©m. A interface do usu√°rio aguarda resultados usando </font></font><code>StreamBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(widget que √© reconstru√≠do toda vez que novos dados chegam ao fluxo em que s√£o inscritos). Isso, de fato, √© tudo. Em alguns casos, precisamos atualizar a interface do usu√°rio sem nenhum envolvimento do usu√°rio (por exemplo, quando uma nova mensagem chegou), mas isso tamb√©m √© feito facilmente atrav√©s de fluxos. De fato, um MVC simples com fluxos, sem m√°gica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comparado a algumas outras abordagens, o bloco requer mais clich√™, mas, na minha opini√£o, √© melhor usar solu√ß√µes nativas sem a participa√ß√£o de bibliotecas de terceiros, a menos que o uso de uma solu√ß√£o de terceiros d√™ alguns </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">significantes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vantagens. </font><font style="vertical-align: inherit;">Quanto mais abstra√ß√µes, mais dif√≠cil √© entender qual √© o erro quando ocorre um erro. </font><font style="vertical-align: inherit;">N√£o considero as vantagens do provedor significativas o suficiente para mudar para ele. </font><font style="vertical-align: inherit;">Mas como tenho pouca experi√™ncia nessa √°rea, √© prov√°vel que mude de campo no futuro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, sobre redux, e todo mundo sabe tudo, ent√£o n√£o h√° nada a dizer. </font><font style="vertical-align: inherit;">Al√©m disso, recortei o aplicativo :) Utilizei-o para gerenciar minha conta, mas, percebendo que, nesse caso, n√£o h√° vantagens especiais sobre o bloco, recortei-o para n√£o arrastar muito. </font><font style="vertical-align: inherit;">Mas, em geral, considero o redux uma coisa √∫til para gerenciar o estado global.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A parte mais excruciante</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que devo fazer se o usu√°rio enviou uma mensagem, mas antes de ser enviada, a conex√£o com a Internet foi perdida? O que devo fazer se o usu√°rio receber uma confirma√ß√£o de leitura, mas ele fechar o aplicativo antes da atualiza√ß√£o do registro correspondente no banco de dados? O que devo fazer se o usu√°rio convidar seu amigo para a sala, mas antes do envio do convite, sua bateria acaba? Voc√™ j√° fez perguntas semelhantes? Aqui estou. Antes. Mas no processo de desenvolvimento, comecei a me perguntar. Como a conex√£o pode desaparecer a qualquer momento e o telefone desligar a qualquer momento, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tudo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve ser </font><b><font style="vertical-align: inherit;">confirmado</font></b><font style="vertical-align: inherit;"> . N√£o tem gra√ßa. Portanto, a primeira mensagem que o cliente envia ao servidor ( </font></font><code>Join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se voc√™ se lembra) n√£o √© apenas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Ol√°, estou online"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , √©</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Ol√°, estou on-line e aqui est√£o as salas n√£o confirmadas, as a√ß√µes n√£o confirmadas, as opera√ß√µes de associa√ß√£o de quartos n√£o confirmadas e as √∫ltimas mensagens recebidas por sala</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">" </font></i><font style="vertical-align: inherit;">E o servidor responde com uma folha semelhante: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúEnquanto voc√™ estava offline, essas e tais mensagens foram lidas por esses e tais usu√°rios, e eles tamb√©m convidaram Petya para esta sala, e Sveta deixou essa sala e voc√™ foi convidado para esta sala, mas estes dois quartos t√™m 40 novos postos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><i><font style="vertical-align: inherit;">" </font></i><font style="vertical-align: inherit;">Eu realmente gostaria de saber como coisas semelhantes s√£o feitas em outros mensageiros, porque minha implementa√ß√£o n√£o brilha com gra√ßa.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imagens</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No momento, voc√™ pode enviar texto, texto + imagens e apenas imagens. </font><font style="vertical-align: inherit;">O upload de v√≠deo ainda n√£o foi implementado. </font><font style="vertical-align: inherit;">As imagens s√£o compactadas um pouco e salvas no armazenamento do Firebase. </font><font style="vertical-align: inherit;">A mensagem em si cont√©m links. </font><font style="vertical-align: inherit;">Ap√≥s o recebimento da mensagem, o cliente baixa imagens, gera miniaturas e salva tudo no sistema de arquivos. </font><font style="vertical-align: inherit;">Os caminhos do arquivo s√£o gravados no banco de dados. </font><font style="vertical-align: inherit;">A prop√≥sito, a gera√ß√£o de miniaturas √© o √∫nico c√≥digo executado em um encadeamento separado, pois √© uma opera√ß√£o de computa√ß√£o pesada. </font><font style="vertical-align: inherit;">Eu apenas inicio um fluxo de trabalho, alimento uma imagem e, em troca, recebo uma miniatura. </font><font style="vertical-align: inherit;">O c√≥digo √© extremamente simples, pois o dardo fornece abstra√ß√µes convenientes para trabalhar com fluxos.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThumbnailGeneratorService</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThumbnailGeneratorService</span> </span>{<font></font>
  SendPort _sendPort;<font></font>
  final Queue&lt;Completer&lt;Uint8List&gt;&gt; _completerQueue =<font></font>
      Queue&lt;Completer&lt;Uint8List&gt;&gt;();<font></font>
<font></font>
  ThumbnailGeneratorService() {<font></font>
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    Isolate.spawn(startWorker, receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((data) {<font></font>
      <span class="hljs-keyword">if</span> (data is SendPort) {<font></font>
        _sendPort = data;<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> completer = _completerQueue.removeFirst();<font></font>
        completer.complete(data);<font></font>
      }<font></font>
    });<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> startWorker(SendPort sendPort) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">var</span> receivePort = ReceivePort();<font></font>
    sendPort.send(receivePort.sendPort);<font></font>
<font></font>
    receivePort.listen((imageBytes) {<font></font>
      Image image = decodeImage(imageBytes);<font></font>
      Image thumbnail = copyResize(image, <span class="hljs-attr">width</span>: min(image.width, <span class="hljs-number">200</span>));<font></font>
<font></font>
      sendPort.send(Uint8List.fromList(encodePng(thumbnail)));<font></font>
    });<font></font>
  }<font></font>
<font></font>
  Future&lt;Uint8List&gt; generate(Uint8List imageBytes) {<font></font>
    <span class="hljs-keyword">var</span> completer = Completer&lt;Uint8List&gt;();<font></font>
    _completerQueue.add(completer);<font></font>
    <font></font>
    _sendPort.send(imageBytes);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> completer.future;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A autentica√ß√£o do Firebase tamb√©m √© usada, mas apenas para autoriza√ß√£o de acesso ao armazenamento do Firebase (para que o usu√°rio n√£o possa, digamos, preencher a foto do perfil para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outra pessoa</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Todas as outras autoriza√ß√µes s√£o feitas atrav√©s dos meus servidores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formato da mensagem</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ provavelmente est√° horrorizado aqui, pois eu uso matrizes regulares de bytes. Json desaparece porque √© necess√°ria efici√™ncia, e eu n√£o sabia sobre o protobuf quando comecei. O uso de matrizes requer muito cuidado, pois um √≠ndice est√° errado e as coisas d√£o errado. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os primeiros 4 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o o comprimento da mensagem. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O pr√≥ximo byte</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© o c√≥digo da mensagem. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os pr√≥ximos 16 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o o identificador de solicita√ß√£o (uuid). </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os pr√≥ximos 40 bytes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s√£o o token de autoriza√ß√£o. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O resto da mensagem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprimento da mensagem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necess√°rio, pois n√£o uso soquetes http ou web, ou algum outro protocolo que forne√ßa a separa√ß√£o de uma mensagem da outra. Meus servidores de front-end veem apenas fluxos de bytes e precisam saber onde uma mensagem termina e outra come√ßa. Existem v√°rias maneiras de separar mensagens (por exemplo, use algum tipo de caractere nunca encontrado nas mensagens como separador), mas eu preferi especificar o tamanho, pois esse m√©todo √© o mais f√°cil, embora implique sobrecarga, pois muitas mensagens est√£o ausentes e um byte para indicar o comprimento. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo da mensagem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© apenas um dos membros da enumera√ß√£o</font></font><code>MessageCode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O roteamento √© realizado de acordo com o c√≥digo e, como podemos extrair o c√≥digo da matriz sem desserializa√ß√£o preliminar, o servidor front-end decide em qual t√≥pico do kafka enviar uma mensagem em vez de delegar essa responsabilidade a outra pessoa. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identifica√ß√£o do Pedido</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presente na maioria das postagens, mas n√£o em todas. Ele executa 2 fun√ß√µes: por esse identificador, o cliente estabelece a correspond√™ncia entre a solicita√ß√£o enviada e a resposta recebida (se o cliente enviou as mensagens A, B, C nesta ordem, isso n√£o significa que as respostas tamb√©m ser√£o ordenadas). A segunda fun√ß√£o √© evitar duplicatas. Como mencionado anteriormente, o kafka garante pelo menos uma vez a entrega. Ou seja, em casos raros, as mensagens ainda podem ser duplicadas. Ao adicionar a coluna RequestIdentifier com uma restri√ß√£o exclusiva √† tabela de banco de dados desejada, podemos evitar a inser√ß√£o de uma duplicata. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token de autoriza√ß√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â uma assinatura de UserId (8 bytes) + 32 bytes HmacSha256. </font><font style="vertical-align: inherit;">Eu n√£o acho que vale a pena usar o Jwt aqui. </font><font style="vertical-align: inherit;">JWT √© cerca de 7-8 vezes maior para qu√™? </font><font style="vertical-align: inherit;">Meus usu√°rios n√£o t√™m reivindica√ß√µes, portanto, uma assinatura hmac simples √© adequada. </font><font style="vertical-align: inherit;">A autoriza√ß√£o atrav√©s de outros servi√ßos n√£o √© e n√£o √© planejada.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamadas de √°udio e v√≠deo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â engra√ßado adiar deliberadamente a implementa√ß√£o de chamadas de √°udio e v√≠deo, porque tinha certeza de que n√£o seria capaz de resolver os problemas, mas, na verdade, esse foi um dos recursos mais f√°ceis de implementar. </font><font style="vertical-align: inherit;">Pelo menos a funcionalidade b√°sica. </font><font style="vertical-align: inherit;">Em geral, basta adicionar o WebRtc ao aplicativo e obter a primeira sess√£o de v√≠deo em apenas algumas horas e, milagrosamente, o primeiro teste foi bem-sucedido. </font><font style="vertical-align: inherit;">Antes disso, pensei que o c√≥digo que funcionava pela primeira vez era um mito. </font><font style="vertical-align: inherit;">Normalmente, o primeiro teste de um novo recurso sempre falha devido a algum tipo de erro est√∫pido como "adicionou um servi√ßo, mas n√£o o registrou em um cont√™iner DI".</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o √© muito breve sobre o WebRtc para os n√£o iniciados</font></font></b><div class="spoiler_text">WebRtc ‚Äî  ,   peer-to-peer    , ,    peer-to-peer  ,     .   - ,     ,      .      ,      .<br>
<br>
          (peer-to-peer),     <i></i> ,  3   (     <i></i> ,  3  .           3 ).<br>
<br>
    ‚Äî stun .   stun  ,    ‚Äî  Source IP  Source Port      ,    <i></i> .    ?        - .       IP .      - , ,    ,   Source IP  Source Port    IP  -        NAT  [ Source IP | Source Port | Router External IP | Router Port ].     - ,   Dest IP  Dest Port     Router External IP  Router Port  NAT, ,    Source IP ‚Äî Source Port     ,   .   , ,       ,      , ,    ,      NAT .       stun     NAT .     stun     Router External IP ‚Äî Router Port.   ‚Äî <i></i>   .     ,  ¬´¬ª    NAT (NAT traversal)  ,      NAT  ,     stun .<br>
*  NAT ,      . ,     ,  WebRtc    .<br>
<br>
  ‚Äî turn.  ,       ,   peer-to-peer . Fallback .    , ,  ,  ,   ,   peer-to-peer     .    turn  ‚Äî coturn,      .<br>
<br>
  ‚Äî .    <i> </i>  ,    .       ,    .   ‚Äî           .       .    ,          , ,     :)       ‚Äî   .<br>
<br>
 WebRtc  3   : offer, answer  candidate.    offer     ,    answer,       .    , ,  ,    ,       .    (     )   ,  .<br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pr√≥pria tecnologia WebRtc estabelece uma conex√£o e est√° envolvida na transfer√™ncia de fluxos para l√° e para c√°, mas essa n√£o √© uma estrutura para a cria√ß√£o de chamadas completas. Por chamada, quero dizer uma sess√£o de comunica√ß√£o com a capacidade de cancelar, rejeitar e aceitar a chamada, al√©m de desligar. Al√©m disso, voc√™ precisa informar ao chamador se o outro lado j√° est√° ocupado. E tamb√©m para implementar pequenas coisas como "aguarde uma resposta para a chamada N segundos e redefina". Se voc√™ simplesmente implementar o WebRtc no aplicativo de forma simples, com uma chamada recebida, a c√¢mera e o v√≠deo ser√£o ativados espontaneamente, o que, √© claro, √© inaceit√°vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em sua forma pura, o WebRtc geralmente implica enviar candidatos para a outra parte o mais r√°pido poss√≠vel, para que as negocia√ß√µes comecem o mais r√°pido poss√≠vel, o que √© l√≥gico. Nos meus testes, os candidatos √† parte receptora geralmente </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sempre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">come√ßou a chegar mesmo antes da oferta chegar. Esses candidatos "antecipados" n√£o podem ser descartados, eles devem ser lembrados, para que mais tarde, quando a oferta chegar e </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for criada, adicione-os √† conex√£o. O fato de os candidatos come√ßarem a chegar antes mesmo da oferta, al√©m de outros motivos, torna a implementa√ß√£o de chamadas completas uma tarefa n√£o trivial. O que fazer se v√°rios usu√°rios nos ligar de uma vez? Receberemos candidatos de todos e, embora possamos separar candidatos de um usu√°rio de outro, n√£o fica claro quais candidatos rejeitar, porque n√£o sabemos de quem a oferta ser√° apresentada mais cedo. Tamb√©m haver√° problemas se os candidatos come√ßarem a vir at√© n√≥s e, em seguida, uma oferta no momento em que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√≥s mesmos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ligarmos para algu√©m.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de testar v√°rias op√ß√µes com um WebRtc simples, cheguei √† conclus√£o de que, dessa forma, seria problem√°tico e cheio de vazamentos de mem√≥ria para tentar fazer chamadas, ent√£o decidi adicionar outro est√°gio ao processo de negocia√ß√£o do WebRtc. Eu chamo essa fase </font></font><code>Inquire - Grant/Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ideia √© muito simples, mas demorei um pouco para alcan√ß√°-la. O chamador antes mesmo de criar o fluxo e </font></font><code>RTCPeerConnection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(e geralmente antes de executar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qualquer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c√≥digo relacionado ao WebRtc) envia uma mensagem atrav√©s do servidor de sinal para o outro lado </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. No lado de recebimento, √© verificado se o usu√°rio est√° em alguma outra sess√£o de comunica√ß√£o no momento ( </font></font><code>bool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">campo </font><font style="vertical-align: inherit;">simples </font><font style="vertical-align: inherit;">). Se for, uma mensagem ser√° enviada de volta.</font></font><code>Refuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e dessa maneira informamos ao chamador que o usu√°rio est√° ocupado e ao receptor - que esse e aquele telefone ligaram enquanto ele estava ocupado com outra conversa. Se o usu√°rio estiver atualmente livre, ele ser√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reservado</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O </font></font><code>Inquire</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identificador da sess√£o √© enviado </font><font style="vertical-align: inherit;">na mensagem </font><font style="vertical-align: inherit;">e esse identificador √© definido como o identificador da </font><font style="vertical-align: inherit;">sess√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atual</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se o usu√°rio estiver reservado, ele rejeitar√° todas as </font></font><code>Inquire/Offer/Candidate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mensagens com identificadores de sess√£o diferentes do atual. Ap√≥s a reserva, o destinat√°rio envia uma mensagem atrav√©s do servidor de sinal ao chamador </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Vale dizer que esse processo n√£o √© vis√≠vel para o usu√°rio receptor, pois ainda n√£o h√° chamada. E o principal aqui √© n√£o esquecer de desligar o tempo limite no lado receptor. De repente, reservaremos uma sess√£o e nenhuma oferta se seguir√°.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O chamador recebe </font></font><code>Grant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e √© aqui que o WebRtc come√ßa com ofertas, candidatos e √© para todos. </font><font style="vertical-align: inherit;">A oferta voa para o destinat√°rio e, ap√≥s o recebimento, exibe uma tela com os bot√µes Atender / Rejeitar. </font><font style="vertical-align: inherit;">Mas os candidatos, como sempre, n√£o esperam ningu√©m. </font><font style="vertical-align: inherit;">Eles novamente come√ßam a chegar ainda mais cedo que a oferta, porque n√£o h√° motivo para esperar o usu√°rio atender a chamada. </font><font style="vertical-align: inherit;">Ele pode n√£o responder, mas rejeitar ou esperar at√© o tempo limite expirar - ent√£o os candidatos ser√£o simplesmente jogados fora.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Status atual e planos futuros</font></font></h2><br>
<ul>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bate-papo privado e em grupo</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviando texto, imagens</font></font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e v√≠deos</font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamadas de √°udio e v√≠deo</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Confirma√ß√£o de recebimento e leitura</font></font></font></li>
<li><font color="#009c50"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Imprime ..."</font></font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notifica√ß√µes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pesquisa por c√≥digo QR e geolocaliza√ß√£o</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A busca pelo c√≥digo QR √© inesperadamente bastante problem√°tica de implementar, porque quase todos os plugins para a verifica√ß√£o de c√≥digo que tentei recusar-se a iniciar ou n√£o funcionam corretamente. </font><font style="vertical-align: inherit;">Mas acho que os problemas ser√£o resolvidos aqui. </font><font style="vertical-align: inherit;">E para a implementa√ß√£o da busca por geolocaliza√ß√£o, ainda n√£o iniciei. </font><font style="vertical-align: inherit;">Em teoria, n√£o deve haver problemas especiais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notifica√ß√µes em andamento, al√©m de enviar v√≠deos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que mais precisa ser feito?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ah, muito. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em primeiro lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o h√° testes. Os colegas costumavam escrever testes, ent√£o eu relaxei completamente. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em segundo lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o √© poss√≠vel convidar usu√°rios para um bate-papo existente e sair do bate-papo. O c√≥digo do servidor est√° pronto para isso, o c√≥digo do cliente n√£o. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em terceiro lugar,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se o tratamento de erros no servidor for mais ou menos, n√£o haver√° tratamento de erros no cliente. N√£o basta apenas fazer uma entrada de log; voc√™ precisa repetir a opera√ß√£o. Agora, por exemplo, o mecanismo para reenviar mensagens n√£o est√° implementado. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quarto, o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servidor n√£o executa ping no cliente, portanto, a desconex√£o n√£o √© detectada se, por exemplo, o cliente perdeu a Internet. A desconex√£o √© detectada apenas quando o cliente fecha o aplicativo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quinto, os</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √≠ndices n√£o s√£o usados ‚Äã‚Äãno banco de dados.</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sexta,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> otimiza√ß√£o. O c√≥digo tem um grande n√∫mero de lugares onde algo como est√° escrito </font></font><code>// @@TODO: Pool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A maioria das matrizes √© exatamente </font></font><code>new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isso. O servidor back-end cria muitas matrizes de comprimento fixo, portanto, aqui voc√™ pode e deve usar o pool. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©timo,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> h√° muitos lugares no cliente onde o c√≥digo </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">termina, embora isso n√£o seja necess√°rio. O envio de imagens, por exemplo, parece lento porque o c√≥digo</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele salva imagens no sistema de arquivos e gera miniaturas antes de exibir a mensagem, embora nada disso precise ser feito. Ou, por exemplo, se voc√™ abrir o aplicativo e, durante a sua aus√™ncia, receber imagens, a inicializa√ß√£o ser√° lenta, porque novamente todas essas imagens ser√£o baixadas, salvas no sistema, miniaturas s√£o geradas e somente depois que a inicializa√ß√£o for conclu√≠da e voc√™ for exibido na tela inicial na tela inicial. Todos esses redundantes </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foram criados para facilitar a depura√ß√£o, mas √© claro que voc√™ precisa se livrar da espera desnecess√°ria antes do lan√ßamento. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oitavo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A interface do usu√°rio agora est√° meio pronta, porque ainda n√£o decidi como quero v√™-la. Portanto, agora tudo n√£o √© intuitivo, metade dos bot√µes n√£o est√° claro o que est√° fazendo. E os bot√µes muitas vezes n√£o s√£o pressionados na primeira vez, porque agora s√£o apenas √≠cones com </font></font><code>GestureDetector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e sem preenchimento, portanto nem sempre √© poss√≠vel entrar neles. Al√©m disso, em alguns lugares, o excesso de pixels n√£o √© fixo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nono,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agora √© imposs√≠vel fazer login em uma conta, apenas se inscrever. Portanto, se voc√™ desinstalar o aplicativo e reinstal√°-lo, n√£o poder√° fazer login na sua conta :) </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©cimo,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o c√≥digo de verifica√ß√£o n√£o ser√° enviado para o correio. Agora, o c√≥digo geralmente √© sempre o mesmo, novamente porque √© mais f√°cil depurar. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©cima primeira</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O princ√≠pio de responsabilidade √∫nica √© violado em muitos lugares. Precisa de um refator. As classes respons√°veis ‚Äã‚Äãpela intera√ß√£o com o banco de dados (no cliente e no servidor) geralmente s√£o muito inchadas, porque est√£o envolvidas em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todas as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> opera√ß√µes do banco de dados. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em d√©cimo segundo, o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servidor front </font><b><font style="vertical-align: inherit;">-</font></b><font style="vertical-align: inherit;"> end agora sempre espera uma resposta do servidor, mesmo que a mensagem n√£o implique o envio de uma resposta (por exemplo, uma mensagem com um c√≥digo </font></font><code>IsTyping</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e algumas mensagens relacionadas ao WebRtc). Portanto, sem esperar por uma resposta, ele grava um erro no console, embora isso n√£o seja um erro. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©cimo terceiro,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> imagens completas n√£o abrem na torneira. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cem milh√µes de quintos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">algumas mensagens que precisam ser enviadas em lotes s√£o enviadas separadamente. O mesmo se aplica a algumas opera√ß√µes de banco de dados. Em vez de executar um √∫nico comando, os comandos s√£o executados em um loop com </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(brr ..). </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cem milh√µes de sextos,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alguns valores s√£o codificados em vez de serem configur√°veis. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cento e um milh√£o s√©timos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o logon no servidor agora √© apenas para o console e, em geral, para o cliente, diretamente para o widget. Na tela principal, h√° uma guia Logs, onde todos os logs na torneira s√£o descartados. O fato √© que minha m√°quina de trabalho se recusa a executar o emulador e tudo o que √© necess√°rio para o servidor (kafka, banco de dados, rabanete e todos os servidores). O d√©bito com um dispositivo conectado tamb√©m n√£o deu certo, tudo ficou pendurado na metade dos casos, porque o computador n√£o suportava as cargas. Portanto, voc√™ precisa criar uma compila√ß√£o toda vez, solt√°-la no dispositivo, instalar e testar assim. Para ver os logs, eu os solto direto no widget. Pervers√£o, eu sei, mas n√£o h√° escolha. Pelo mesmo motivo, muitos m√©todos retornam </font></font><code>Future</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eles s√£o (para capturar a exce√ß√£o e lan√ßar no widget), embora n√£o devam. Se voc√™ olhar o c√≥digo, ver√° um </font></font><code>_logError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo </font><font style="vertical-align: inherit;">feio </font><font style="vertical-align: inherit;">em muitas classes que faz isso. Isso, √© claro, tamb√©m ir√° para o lixo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cem milh√µes e oito,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sem som. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cem milh√µes e nono,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> voc√™ precisa usar mais o cache. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cem milh√µes d√©cimos,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muito c√≥digo repetitivo. Por exemplo, muitas a√ß√µes primeiro verificam a validade do token e, se n√£o for v√°lido, elas enviam um erro. Eu acho que voc√™ precisa implementar um pipeline de middleware simples. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E muitas pequenas coisas, como concatenar strings em vez de usar </font></font><code>StringBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'a,</font></font><code>Dispose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nem todo lugar √© chamado onde deveria, e assim por diante. </font><font style="vertical-align: inherit;">Em geral, o estado normal do projeto est√° em desenvolvimento. </font><font style="vertical-align: inherit;">Tudo isso √© solucion√°vel, mas h√° um problema fundamental que eu n√£o pensava at√© o √∫ltimo momento, porque saiu da minha cabe√ßa - o messenger deve funcionar mesmo quando o aplicativo n√£o est√° aberto e o meu n√£o funciona. </font><font style="vertical-align: inherit;">Para ser sincero, a solu√ß√£o para esse problema ainda n√£o passou pela minha cabe√ßa. </font><font style="vertical-align: inherit;">Aqui, aparentemente, voc√™ n√£o pode prescindir do c√≥digo nativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu classificaria a disponibilidade do projeto em 70%.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum√°rio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seis meses se passaram desde o in√≠cio dos trabalhos no projeto. </font><font style="vertical-align: inherit;">Combinado com o trabalho de meio per√≠odo e fazia longas pausas, mas, mesmo assim, o tempo e o esfor√ßo foram decentes. </font><font style="vertical-align: inherit;">Eu pretendo implementar todos os recursos declarados + adicionar algo incomum como jogo da velha ou rascunhos na sala. </font><font style="vertical-align: inherit;">Por nenhuma raz√£o, apenas porque √© interessante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ tiver alguma d√∫vida, escreva. </font><font style="vertical-align: inherit;">O correio est√° no github.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt490054/index.html">17 surpresas para o meu primeiro ano usando o Tesla Model 3</a></li>
<li><a href="../pt490056/index.html">Black Box: esque√ßa o registro</a></li>
<li><a href="../pt490060/index.html">Gr√°fico do conhecimento de pesquisa: construindo a partir de v√°rias fontes</a></li>
<li><a href="../pt490066/index.html">Da China ao Polo Sul: unindo for√ßas para resolver o quebra-cabe√ßa da massa de neutrinos</a></li>
<li><a href="../pt490068/index.html">Falsifica√ß√£o de aleatoriedade e transforma√ß√£o, ordenando sequ√™ncias pseudo-aleat√≥rias</a></li>
<li><a href="../pt490076/index.html">Classifica√ß√£o esportiva de disciplinas de e-sports</a></li>
<li><a href="../pt490080/index.html">–ö–∞–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ª–µ–≥–∫–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à —Å–∞–π—Ç</a></li>
<li><a href="../pt490082/index.html">An√°lise de C√≥digo Gen√©tico I</a></li>
<li><a href="../pt490084/index.html">No√ß√µes b√°sicas sobre a especifica√ß√£o ECMAScript, parte 1</a></li>
<li><a href="../pt490086/index.html">Guia de surf para iniciantes ou Vida do programador em Portugal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>