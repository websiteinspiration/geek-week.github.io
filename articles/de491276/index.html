<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☝🏼 🤶🏽 👨🏻‍🎨 Wie ich das Verbot der Nachrichten-API durch die Vkontakte-Dokumentation umgangen habe 🎴 🌋 🐙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo an die gesamte Habro Community. Für mich ist dieser erste Artikel unter einer gewissen Euphorie geschrieben, also beurteilen Sie diesen Artikel ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wie ich das Verbot der Nachrichten-API durch die Vkontakte-Dokumentation umgangen habe</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491276/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo an die gesamte Habro Community. </font><font style="vertical-align: inherit;">Für mich ist dieser erste Artikel unter einer gewissen Euphorie geschrieben, also beurteilen Sie diesen Artikel bitte nicht zu streng für den literarischen Teil. </font><font style="vertical-align: inherit;">Aber gut, weniger Worte und los geht's.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie alles begann</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir alle wissen, dass VC über eine API verfügt, und ich bin sicher, dass die meisten Leute versucht haben, diese für ihre eigenen Zwecke zu verwenden. </font><font style="vertical-align: inherit;">Persönlich habe ich viele Projekte im Zusammenhang damit: Teile von 5 leistungsstarken Bots, Zusammenstellung umfangreicher Datensätze aus Gruppenbeiträgen usw. </font><font style="vertical-align: inherit;">Und es ist nicht verwunderlich, dass meine Freunde mich ein paar Mal gebeten haben, Songs aus den Anhängen des Dialogs und der Fotos herunterzuladen oder den Korrespondenztext mit einer Person in einer separaten Datei zu speichern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber als „es“ kam und von diesem Moment an die Implementierung derart kleiner Anfragen keine triviale Aufgabe mehr war: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c41/913/d6c/c41913d6cfb47f8acff5c3145502c4e5.jpg" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um dieses Problem ein für alle Mal ein für alle Mal zu beseitigen, beschloss ich, meinen Wrapper über http-Anfragen zu schreiben und so zu tun, als wäre ich ein normaler Benutzer haben das gleiche leistungsstarke Tool wie die offizielle API für den Nachrichtenbereich.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kommen wir zur Sache</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also habe ich mit der Autorisierung begonnen. </font><font style="vertical-align: inherit;">Mit dem https-Sniffer und Firefox konnte ich alle „Schritte“ der Autorisierung durchlaufen und die endgültigen Cookies erhalten. </font><font style="vertical-align: inherit;">Von nun an blieb nur noch zu verstehen, wie Abfragen gestellt wurden. </font><font style="vertical-align: inherit;">Es wurde festgestellt, dass die meisten Daten durch eine POST-Anfrage von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://vk.com/wkview.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> empfangen werden. </font><font style="vertical-align: inherit;">Nur die Parameter für verschiedene Situationen ändern sich jedes Mal. </font><font style="vertical-align: inherit;">Ich habe es geschafft, Funktionen zum Abpumpen absolut aller Arten von Investitionen zu schreiben, aber wir werden nicht auf Details eingehen, da sich in einem Moment alles dramatisch geändert hat.</font></font><br>
<blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Link zur Datei zum Empfangen von Autorisierungscookies (ich habe sie nur für die Zwei-Faktor-Authentifizierung geschrieben, da sie die meisten Menschen kostet)</font></font></a></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unerwartete Entdeckung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich arbeitete an einem Laptop, als ein Freund auf mich zukam und fragte, was ich mache. Da ich ihm das ganze Problem nicht schnell an meinen Fingern erklären konnte, öffnete ich die offizielle Dokumentation im Nachrichtenbereich und war fassungslos, als ich sah, was unter der Hauptbeschreibung dieser "verbotenen" Methoden steht: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e14/077/91c/e1407791c9c79301b94f9f73c58fe5dd.jpg" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nein, Sie verstehen mich richtig, ich bin nicht der erste sehen Sie einfach diese Gelegenheit. Ich habe es viele Male mit anderen Methoden verwendet, aber ich konnte nicht einmal glauben, dass die Funktion "Beispielanforderung" bei den Methoden des Nachrichtenabschnitts verbleiben würde. Und noch stärker war meine Überraschung, als ich den Verkehr durcheinander brachte. Dies waren nur gewöhnliche API-Anfragen, nur auf der Site, die nur geringfügig unterschiedliche Parameternamen im Webformular hatten und eine Art Hash-ID hatten.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/39d/68c/a1b/39d68ca1b65fec086d6f3be18578ef91.jpg" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Innerhalb weniger Minuten wurde mir klar, dass die Hash-ID nur eine Zeichenfolge ist, die sich im Daten-Hash-Attribut des Button-Tags befindet. Nach einigen Minuten bemühte ich mich bereits, die Emulation von „Testanforderungen“ zu implementieren, und glaubte nicht vollständig, dass dies funktionieren würde. </font><font style="vertical-align: inherit;">Schließlich haben diese Anfragen mit Sicherheit eine gewisse Begrenzung der Anzahl oder ähnliches. </font><font style="vertical-align: inherit;">Aber was war meine Überraschung, als dieses Skript mit 30 Zeilen (ohne den Empfang von Cookies), das auf meinen Knien geschrieben war, in 4 Minuten eineinhalbtausend Bilder aus den Dialoganhängen herauspumpen konnte.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2f8/d30/555/2f8d3055586c0d8a63f6898c1173319e.jpg" alt="Bild"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich wende den verwendeten Code an</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> requests, pickle, re, json<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">'cookies_vk_auth.pickle'</span>, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> handle:<font></font>
    cookies_final = pickle.load(handle)<font></font>
<font></font>
session = requests.Session()<font></font>
peer_id = int(input(<span class="hljs-string">'  :  '</span>))<font></font>
<font></font>
response = session.get(<span class="hljs-string">f'https://vk.com/dev/messages.getHistoryAttachments'</span>, cookies=cookies_final)<font></font>
hash_data =  re.findall(<span class="hljs-string">r'data-hash="(\S*)"'</span>, response.text)[<span class="hljs-number">0</span>]<font></font>
<font></font>
session = requests.Session()<font></font>
response = session.post(<span class="hljs-string">f'https://vk.com/dev'</span>,<font></font>
            data=<span class="hljs-string">f'act=a_run_method&amp;al=1&amp;hash=<span class="hljs-subst">{hash_data}</span>&amp;method=messages.getHistoryAttachments&amp;param_count=20&amp;param_max_forwards_level=45&amp;param_media_type=photo&amp;param_peer_id=<span class="hljs-subst">{peer_id}</span>&amp;param_photo_sizes=0&amp;param_preserve_order=0&amp;param_v=5.103'</span>, cookies=cookies_final)<font></font>
<font></font>
count=<span class="hljs-number">20</span><font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">200</span>):<font></font>
    response_json = json.loads(json.loads(response.text[<span class="hljs-number">4</span>:])[<span class="hljs-string">'payload'</span>][<span class="hljs-number">1</span>][<span class="hljs-number">0</span>])[<span class="hljs-string">'response'</span>][<span class="hljs-string">'items'</span>]<font></font>
<font></font>
    <span class="hljs-keyword">for</span> photo <span class="hljs-keyword">in</span> response_json:<font></font>
        ph = photo[<span class="hljs-string">'attachment'</span>][<span class="hljs-string">'photo'</span>][<span class="hljs-string">'sizes'</span>][<span class="hljs-number">-1</span>][<span class="hljs-string">'url'</span>]<font></font>
        r = session.get(ph, timeout=<span class="hljs-number">10</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> r.status_code == <span class="hljs-number">200</span>:
            <span class="hljs-keyword">with</span> open(<span class="hljs-string">f'D://dev/'</span>+str(ph.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">-1</span>]), <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
                f.write(r.content)<font></font>
<font></font>
    m_id = photo[<span class="hljs-string">'message_id'</span>]<font></font>
    response = session.post(<span class="hljs-string">f'https://vk.com/dev'</span>,<font></font>
            data=<span class="hljs-string">f'act=a_run_method&amp;al=1&amp;hash=<span class="hljs-subst">{hash_data}</span>&amp;method=messages.getHistoryAttachments&amp;param_count=20&amp;param_start_from=<span class="hljs-subst">{m_id}</span>&amp;param_max_forwards_level=45&amp;param_media_type=photo&amp;param_peer_id=<span class="hljs-subst">{peer_id}</span>&amp;param_photo_sizes=0&amp;param_preserve_order=0&amp;param_v=5.103'</span>, cookies=cookies_final)
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich war so beeindruckt, dass ich mich zu diesem Zeitpunkt entschied, mich abzukühlen und zu versuchen, eine andere Methode zu implementieren (plötzlich habe ich mich nur geirrt). </font><font style="vertical-align: inherit;">Ich habe die History-Methode übernommen und das Ergebnis war ähnlich. </font><font style="vertical-align: inherit;">Nur musste ich eine Verzögerung von 0,1 Sekunden einstellen, damit der Server bei zu vielen Anfragen keinen Fehler gab. </font><font style="vertical-align: inherit;">(Wenn sich jemand wiederholt, denken Sie bitte daran, dass Sie beim Ändern der Methode auch die URL der Dokumentation ändern müssen, aus der die Hash-Daten stammen.) </font><font style="vertical-align: inherit;">Das heißt, diese Methode ermöglichte es wirklich, über die offizielle Dokumentation auf den Nachrichtenbereich zuzugreifen, wobei nur das Kennwort und die Benutzeranmeldung verwendet wurden. </font><font style="vertical-align: inherit;">Aus Gründen der Zuverlässigkeit habe ich versucht, die gleichen Schritte für ein anderes Konto auszuführen, und das gleiche Ergebnis erzielt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusammenfassen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich denke, jeder hat bereits erkannt, dass dies einen Verstoß gegen den Schutz unserer persönlichen Daten darstellt, der seit einem Jahr in der Dokumentation hängt, und es ist nicht bekannt, wie viele Personen ihn bereits verwendet haben. </font><font style="vertical-align: inherit;">Darüber hinaus ist diese Lücke sehr groß und muss bald geschlossen werden. </font><font style="vertical-align: inherit;">Und um noch einmal zu beweisen, dass dies nicht so funktionieren sollte, zitiere ich die VK-Entwickler selbst:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie nach dem 15. Februar 2019 mit der Entwicklung eines Messenger beginnen möchten, müssen Sie im Support einen Testzugriff erhalten, der die Arbeit der Methoden des Abschnitts Nachrichten mit den Schlüsseln der Administratoren Ihrer eigenständigen Anwendung impliziert.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das heißt, selbst um ein Token der internen Anwendung zu erhalten, die Zugriff auf die Korrespondenz des Benutzers hat, benötigen Sie eine persönliche Erlaubnis der VK, geschweige denn den Zugriff mit einem normalen Kennwort und der Anmeldung. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meine persönliche Meinung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Verbot des Nachrichtenbereichs hat die Sicherheit der Benutzer nicht grundlegend verändert. </font><font style="vertical-align: inherit;">Er hat gerade die Grenze ausgewiesen und eine Gruppe von "Under-Hackern" abgeschnitten, die, ohne zu verstehen, was sie taten, vollen Zugriff auf die Daten erhalten konnten. </font><font style="vertical-align: inherit;">Für den Rest der Programmierer ist es nur eine Frage der Zeit, Zugang zu Korrespondenz zu erhalten. </font><font style="vertical-align: inherit;">Und im ersten Teil des Artikels habe ich anhand meines eigenen Beispiels, das ein Programm zum Abpumpen von Anhängen erstellt hat, bewiesen, dass die Entstehung einer Bibliothek, die sich als Benutzer ausgeben kann, nicht mehr weit ist. </font><font style="vertical-align: inherit;">Vielleicht werde ich es selbst zum Ende bringen, und VK-Entwickler müssen darauf vorbereitet sein und Wege finden, um zu verdächtige Benutzeraktivitäten zu erkennen, wenn der Datenschutz unserer Daten für sie wirklich wichtig ist.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><div class="spoiler_text">       ,      )     ,       .<br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de491262/index.html">Auge um Auge. Biometrie-Probleme</a></li>
<li><a href="../de491264/index.html">Einführung in SSD. Teil 4. Physisch</a></li>
<li><a href="../de491266/index.html">SurfingAttack: Kompromittierung von Smartphones mit Soundassistenten [+ Video]</a></li>
<li><a href="../de491268/index.html">Monte-Carlo-Methoden für Markov-Ketten (MCMC). Einführung</a></li>
<li><a href="../de491272/index.html">Website-Entwicklung in Pascal (Backend)</a></li>
<li><a href="../de491278/index.html">CLRium # 7: Berichte, Praxis, Mentoren</a></li>
<li><a href="../de491280/index.html">Die Geschichte, wie ich eine Programmiersprache entwickelt habe</a></li>
<li><a href="../de491282/index.html">So steigern Sie die Teamproduktivität (und reduzieren Fehler) mithilfe von Rallyes</a></li>
<li><a href="../de491284/index.html">Analyse: Was ist Fundamentalanalyse?</a></li>
<li><a href="../de491286/index.html">IPv6-Netzwerke nur in der US-Regierung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>