<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>„äôÔ∏è ü§≤üèª ‚úã Trabaja con tarjeta SD a trav√©s de la interfaz SPI. Implementaci√≥n de VHDL üë®‚ÄçüöÄ ü§ß üéÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola habr Una vez en el trabajo, tuve la tarea de evaluar la posibilidad de implementar el almacenamiento de datos en una tarjeta SD al conectarla a u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Trabaja con tarjeta SD a trav√©s de la interfaz SPI. Implementaci√≥n de VHDL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola habr </font><font style="vertical-align: inherit;">Una vez en el trabajo, tuve la tarea de evaluar la posibilidad de implementar el almacenamiento de datos en una tarjeta SD al conectarla a un FPGA. </font><font style="vertical-align: inherit;">Se asumi√≥ el uso de SPI como una interfaz de interacci√≥n, ya que es m√°s f√°cil de implementar. </font><font style="vertical-align: inherit;">Me gustar√≠a compartir la experiencia adquirida.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/qw/p6/gaqwp6tekmw-myhnjrsmwo5cam8.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que el espacio en la placa de circuito impreso siempre es limitado, se considerar√°n las tarjetas SD en el ejemplo de las tarjetas en el factor de forma microSD.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenido</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Especificaci√≥n de lectura </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 Informaci√≥n general </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 Inicializaci√≥n </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 Borrar informaci√≥n </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 Leer informaci√≥n </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.1 Leer un bloque de datos </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.2 Leer muchos bloques de datos </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 Escribir informaci√≥n </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.1 Escribir un bloque de datos </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.2 Escribir muchos bloques de datos </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Implementar el algoritmo en hardware </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 Componente de la capa f√≠sica </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 Componente del nivel de comando </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3 Componente de comunicaci√≥n con el mundo exterior </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Verificaci√≥n en hardware </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Resultados</font></font></a><br>
<br>
<a name="SpecRead"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Especificaciones de lectura</font></font></h2><br>
<a name="GeneralInformation"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 General</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una lectura r√°pida de la especificaci√≥n nos dice las siguientes opciones de tarjeta SD:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la transferencia de datos a la tarjeta SD se realiza en una l√≠nea; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la lectura de datos de una tarjeta SD se realiza en una l√≠nea; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en modo SPI, la potencia puede ser solo + 3.3V; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frecuencia de reloj en modo de inicializaci√≥n en el rango de 100-400 kHz;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">frecuencia de reloj despu√©s de la inicializaci√≥n - 25 MHz.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto implica inmediatamente el punto en el ancho de banda m√°ximo te√≥rico: 25 MHz * 1 bit = 25 Mb / s, que es </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">algo</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peque√±o. </font><font style="vertical-align: inherit;">El segundo menos el uso de tarjetas SD, potencia + 3.3V. </font><font style="vertical-align: inherit;">En la placa de circuito impreso en la que se plane√≥ instalar la tarjeta SD, no existe ese voltaje. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las tarjetas de factor de forma MicroSD se pueden dividir en 3 categor√≠as por capacidad:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDSC </font><font style="vertical-align: inherit;">Capacidad de tarjeta de hasta 2 GB inclusive. </font><font style="vertical-align: inherit;">La direcci√≥n dentro de la tarjeta es byte.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDHC. </font><font style="vertical-align: inherit;">La capacidad de la tarjeta es de m√°s de 2 GB y hasta 32 GB inclusive. </font><font style="vertical-align: inherit;">La direcci√≥n dentro de la tarjeta indica un bloqueo de 512 bytes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDXC. </font><font style="vertical-align: inherit;">La capacidad de la tarjeta es de m√°s de 32 GB y hasta 128 TB inclusive. </font><font style="vertical-align: inherit;">La direcci√≥n dentro de la tarjeta indica un bloqueo de 512 bytes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La vista general del mapa se muestra en la figura a continuaci√≥n. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/qo/4d/wpqo4dulzwlonas-3evcspttvra.png"><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√∫mero de contacto</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nombre</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un tipo</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descripci√≥n</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSV</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No utilizado</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entrada</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selecci√≥n de chips</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DI</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entrada</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√≠nea de datos del dispositivo maestro (MOSI)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vdd</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrici√≥n</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tensi√≥n de alimentaci√≥n</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCLK</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entrada</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se√±al de reloj</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 6</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vss</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrici√≥n</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tierra</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 7</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HACER</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salida</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√≠nea de datos al dispositivo maestro (MISO)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSV</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No utilizado</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La conexi√≥n se lleva a cabo de acuerdo con el siguiente diagrama: las </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/jl/xj/eyjlxjhgg_iucbvd0ms-gzmjinu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resistencias deben ser de 50 kOhm.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Despu√©s de encender la alimentaci√≥n, la tarjeta SD est√° en modo SDIO. </font><font style="vertical-align: inherit;">Para cambiar al modo SPI, debe realizar la inicializaci√≥n. </font><font style="vertical-align: inherit;">El protocolo para trabajar con la tarjeta implica el uso de un esquema de control para la transferencia correcta de datos y comandos en forma de algoritmo CRC. </font><font style="vertical-align: inherit;">Cuando se opera en modo SPI, la verificaci√≥n CRC est√° deshabilitada de manera predeterminada. </font><font style="vertical-align: inherit;">Por lo tanto, el primer comando enviado a la tarjeta para cambiar la tarjeta al modo SPI debe contener el valor CRC correcto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los comandos transmitidos a trav√©s de la interfaz SPI tienen un tama√±o de 48 bits. </font><font style="vertical-align: inherit;">Formato de comando:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El bit 47 (m√°s a la izquierda) siempre contiene el valor 0. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El bit 46 siempre contiene el valor 1.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Los bits 45..40 contienen el √≠ndice de comando.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los bits 39..8 contienen los argumentos del comando. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los bits 7..1 contienen CRC de bits anteriores. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El bit 0 siempre contiene el valor 1.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los bits 47 y 46 le dan a la tarjeta la capacidad de rastrear sin ambig√ºedades el inicio de una transacci√≥n, ya que el bus MOSI en reposo es igual a uno. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dd/ap/8n/ddap8nsdyqcbqezjudom42bzfx8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los comandos utilizados al trabajar con la tarjeta SD recibir√°n respuestas como R1, R3, R7. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/xq/ce/btxqcevcwggh9qgt6pxznanb0pc.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una respuesta de tipo R1, tama√±o 8 bits. </font></font></sub><font style="vertical-align: inherit;"><sub><font style="vertical-align: inherit;">Tipo de respuesta R3, tama√±o 40 bits. </font></sub><sub><font style="vertical-align: inherit;">Tipo de respuesta R7, tama√±o 40 bits. </font></sub><font style="vertical-align: inherit;">
Todos los comandos y sus respuestas se detallan en la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Especificaci√≥n simplificada de la capa f√≠sica.</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/mu/dg/yb/mudgybpndrbrqpsz5icwgkb1prk.png"></a><br>
<sub><font style="vertical-align: inherit;"></font></sub><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/s-/vq/a8/s-vqa83la-g6k3bwgvvmmfoawms.png"></a><br>
<sub><font style="vertical-align: inherit;"></font></sub><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br>
<a name="Init"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 Inicializaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algoritmo de inicializaci√≥n:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de encender la alimentaci√≥n, espere al menos 1 ms.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Genere un m√≠nimo de 74 cambios de reloj para la tarjeta. </font><font style="vertical-align: inherit;">Las l√≠neas CS y MOSI deben estar en estado de unidad l√≥gica.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generar comando CMD0. </font><font style="vertical-align: inherit;">El comando CMD0 restablece la tarjeta SD.</font></font></li>
<li>    CMD0.     R1.  ,   R1    16   ,    3.   R1   ,     0x01 (     ),    3,     5. </li>
<li>  CMD8.            . </li>
<li>    CMD8.     R7.  ,     ,    ,    7, ,           ,    17,    13. </li>
<li>  CMD55.  CMD55  ,     . </li>
<li>    CMD55.     R1.     0x01 (    ),    7,    9. </li>
<li>  ACMD41.  ACMD41  ,    SDSC ( 0x00000000)    . </li>
<li>    ACMD41.     R1.      ,    ,    11. ,    0x00 ( )    14,       7.</li>
<li>  CMD1.  CMD1   ACMD41.</li>
<li>    CMD1.     R1.       ,    ,    13, ,    0x00 ( ),    14,       11.</li>
<li> .   ,   .      . </li>
<li>  CMD16.          ,  512 . </li>
<li>    CMD16.     R1.  ,    0x00 (  )    16,    13. </li>
<li>   .       .   . </li>
<li>  CMD55.  CMD55  ,     . </li>
<li>    CMD55.     R1.     0x01 (    ),    17,    19. </li>
<li>  ACMD41.   ACMD41.  ACMD41  ,    SDHC ( 0x40000000)    .</li>
<li>    ACMD41.     R1.      ,    ,    13. ,    0x00 ( )    21,       17. </li>
<li>  CMD58.    . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperando una respuesta al comando CMD58. </font><font style="vertical-align: inherit;">La respuesta es una respuesta de tipo R3. </font><font style="vertical-align: inherit;">Si se establece un bit en la respuesta de que la tarjeta funciona con direcciones de bloque de 512 bytes, vaya al paso 16, de lo contrario al paso 14.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez completada la inicializaci√≥n, la tarjeta puede funcionar en bloques de 512 bytes con una frecuencia de reloj de 25 MHz. </font><font style="vertical-align: inherit;">Esta es la versi√≥n completa del algoritmo de inicializaci√≥n, que cubre todo tipo de tarjetas. </font><font style="vertical-align: inherit;">En mi caso, cuando usaba una tarjeta de 16 GB, el algoritmo de inicializaci√≥n consist√≠a en los pasos 1-6, 17-22, 16.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algoritmo Gr√°fico</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/vp/di/pw/vpdipwdy4umv4iahsea1g2snruu.png"></a></div>
                    </div><br>
<a name="Erase"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 Borrar informaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las tarjetas de factor de forma Micro SD admiten comandos de borrado. </font><font style="vertical-align: inherit;">Despu√©s del comando de borrado, el valor de las direcciones de borrado especificadas se completar√° con el valor 0xFF o 0x00, dependiendo de la tarjeta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algoritmo de borrado de informaci√≥n</font></font><br>
<br>
<ol>
<li>  CMD32.        .</li>
<li>    CMD32.     R1.       0x00 ( -    ),    3,    4.</li>
<li> .   ,     . </li>
<li>  CMD33.        .        ,        CMD32. </li>
<li>    CMD33.     R1.       0x00 ( -    ),    3,    6 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠o del comando CMD38. </font><font style="vertical-align: inherit;">El comando para borrar informaci√≥n de los bloques seleccionados. </font><font style="vertical-align: inherit;">Cualquier 4 bytes debe enviarse como argumento, excepto los valores 0x00000001, 0x00000002.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperando una respuesta al comando CMD38. </font><font style="vertical-align: inherit;">La respuesta es una respuesta de tipo R1b. </font><font style="vertical-align: inherit;">Esta es una versi√≥n extendida de la respuesta cuando la tarjeta genera una respuesta R1 y luego dibuja la l√≠nea MISO a cero, lo que indica que el chip est√° ocupado. </font><font style="vertical-align: inherit;">Es necesario esperar hasta que el valor de la unidad aparezca en la l√≠nea MISO. </font><font style="vertical-align: inherit;">Si la respuesta no es 0x00 (hubo alg√∫n error al ejecutar el comando), vaya al paso 3, de lo contrario al paso 8</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalizaci√≥n del algoritmo de borrado. </font></font></li>
</ol><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algoritmo Gr√°fico</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/hm/qs/cq/hmqscqj62emd9yp30prqqasyjjm.png"></a></div>
                    </div><br>
<a name="Read"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 Informaci√≥n de lectura</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lectura de informaci√≥n de una tarjeta SD a trav√©s de SPI es posible de dos maneras.</font></font><br>
<br>
<a name="ReadOne"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.1 Leer un solo bloque de datos</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al leer un bloque de datos, el dispositivo Maestro genera un comando para que la tarjeta SD lea un bloque de datos, espera una respuesta de que el comando ha sido procesado y est√° esperando un paquete con datos de la tarjeta. </font><font style="vertical-align: inherit;">Despu√©s de recibir un paquete con datos de la tarjeta, finaliza la transacci√≥n de lectura. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g_/oe/q_/g_oeq_mpttrajxmeltmmb5hpl28.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vista general de una transacci√≥n que lee un bloque de datos. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, se implement√≥ dicha opci√≥n, pero la velocidad resultante estaba muy alterada (las comparaciones de velocidad ser√°n menores).</font></font><br>
<br>
<a name="ReadMore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.2 Lectura de m√∫ltiples bloques de datos</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al leer m√∫ltiples bloques de datos, el dispositivo Maestro genera un comando para que la tarjeta SD lea m√∫ltiples bloques de datos, espera una respuesta de que el comando ha sido procesado y espera un paquete de datos de la tarjeta. </font><font style="vertical-align: inherit;">Despu√©s de enviar un paquete de datos, la tarjeta env√≠a el siguiente paquete de datos. </font><font style="vertical-align: inherit;">Esto continuar√° hasta que se reciba un comando del dispositivo maestro para completar la lectura. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ai/ed/tz/aiedtzc1nfh__byzfhuozjnstjc.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vista general de una transacci√≥n que lee muchos bloques de datos. </font></font></sub><br>
<br>
<img src="https://habrastorage.org/webt/i8/ko/9l/i8ko9lasfzqwjehte6q6yg8bs1w.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura del paquete de datos</font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
donde:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token de datos </font><font style="vertical-align: inherit;">El comando de lectura usa el valor 0xFE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloque de datos </font><font style="vertical-align: inherit;">Contiene datos le√≠dos de la tarjeta.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRC </font><font style="vertical-align: inherit;">Contiene la suma de verificaci√≥n de los campos anteriores.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si se produjo un error durante la lectura, la tarjeta en lugar del token de datos devuelve un token de error. </font><font style="vertical-align: inherit;">El tama√±o del token de error es de 1 byte. </font><font style="vertical-align: inherit;">Los bits 7..5 contienen un valor de cero, los bits 4..0 codifican el tipo de error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algoritmo para leer m√∫ltiples bloques de datos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠o del comando CMD18. </font><font style="vertical-align: inherit;">El comando le dice a la tarjeta que se leer√°n varios bloques.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperando una respuesta al comando CMD18. </font><font style="vertical-align: inherit;">La respuesta es una respuesta de tipo R1. </font><font style="vertical-align: inherit;">Si la respuesta no es 0x00 (hubo alg√∫n error al ejecutar el comando), vaya al paso 3, de lo contrario al paso 4.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estado de error </font><font style="vertical-align: inherit;">Lectura fallida, saliendo del algoritmo de lectura.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperando una ficha de la tarjeta. </font><font style="vertical-align: inherit;">Si se recibe un token de error de la tarjeta, vaya al paso 3; de lo contrario, vaya al paso 5.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reciba desde una tarjeta de bloque de datos de 512 bytes de tama√±o. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recibir de la tarjeta CRC tama√±o de campo de 2 bytes. </font></font></li>
<li>    .     ,    8,    4. </li>
<li>  CMD12.       .  ,       Data Packet,   . </li>
<li>     CMD12.     R1b.     R1,         MISO  ,   .      MISO  ,      .       0x00 ( -    ),    3,    10.</li>
<li>  . </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay un ligero matiz en el algoritmo de lectura. </font><font style="vertical-align: inherit;">La se√±al de selecci√≥n de chip (CS) debe establecerse en cero l√≥gico antes de generar el comando CMD18 y establecerse en uno l√≥gico despu√©s de recibir una respuesta al comando CMD12.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algoritmo Gr√°fico</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/ht/8f/uf/ht8fufwcf9qq-bdrif-4chjd5cg.png"></a></div>
                    </div><br>
<a name="Write"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 Registro de informaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escribir informaci√≥n en la tarjeta SD a trav√©s de la interfaz SPI es posible en dos versiones.</font></font><br>
<br>
<a name="WriteOne"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.1 Escribir un solo bloque de datos</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al grabar un bloque de datos, el dispositivo Maestro genera un comando para que la tarjeta SD escriba un bloque de datos, espera una respuesta de la tarjeta de que el comando ha sido procesado, transmite un paquete con datos para grabar en la tarjeta, espera una respuesta de la tarjeta de que los datos est√°n escritos, completa la transacci√≥n. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u1/j5/7f/u1j57f-xmwqesdk1yzw_fenwvmi.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vista general de una transacci√≥n de escritura de un bloque de datos. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al igual que con la lectura, originalmente se implement√≥ un registro de un bloque de datos. </font><font style="vertical-align: inherit;">Los resultados de la velocidad fueron insatisfactorios.</font></font><br>
<br>
<a name="WriteMore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.2 Escribir m√∫ltiples bloques de datos</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al grabar m√∫ltiples bloques de datos, el dispositivo Maestro genera un comando para grabar m√∫ltiples bloques de datos, espera una respuesta de la tarjeta de que el comando ha sido procesado, transmite un paquete con datos para grabar en la tarjeta, espera una respuesta de la tarjeta de que los datos est√°n grabados. </font><font style="vertical-align: inherit;">Despu√©s de recibir una respuesta maestra, el dispositivo transmite un paquete con los siguientes datos para grabar en la tarjeta. </font><font style="vertical-align: inherit;">Esto continuar√° hasta que el dispositivo maestro env√≠e un token de datos de detenci√≥n. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-p/l7/fz/-pl7fz2rfyuv5akb7ksrcwdipsy.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vista general de una transacci√≥n de escritura para m√∫ltiples bloques de datos. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La estructura del paquete de datos es similar a la estructura del paquete de datos al leer datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Formato:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token de datos </font><font style="vertical-align: inherit;">Para el comando de escritura, se utiliza el valor 0xFC.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloque de datos </font><font style="vertical-align: inherit;">Contiene datos escritos en la tarjeta.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRC </font><font style="vertical-align: inherit;">Contiene la suma de verificaci√≥n de los campos anteriores.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El token Stop Tran utilizado para completar el comando de escritura tiene un tama√±o de 1 byte e igual a 0xFD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que el √∫ltimo bit del paquete de datos se ha introducido en la tarjeta, la tarjeta responde al siguiente reloj con el estado del registro de datos: Respuesta de datos. </font><font style="vertical-align: inherit;">La respuesta de datos tiene un tama√±o de 1 byte, los bits 7..5 pueden ser cualquiera, el bit 4 siempre es cero, el bit 0 siempre es igual a uno, los bits 3..1 codifican el estado del registro de datos. </font><font style="vertical-align: inherit;">Despu√©s de que la tarjeta ha devuelto el Paquete de datos, la tarjeta dibuja la l√≠nea MISO a cero, lo que indica que la tarjeta est√° ocupada. </font><font style="vertical-align: inherit;">Una vez que el nivel de la unidad l√≥gica est√° en la l√≠nea MISO, puede transferir el siguiente paquete de datos a la tarjeta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo para grabar m√∫ltiples bloques de datos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠o del comando CMD25. </font><font style="vertical-align: inherit;">El comando le dice a la tarjeta que se escribir√°n varios bloques.</font></font></li>
<li>    CMD25.     R1.       0x00 ( -    ),    3,    4.</li>
<li> .   ,   . </li>
<li>   . </li>
<li>   512   . </li>
<li>    CRC  2 . </li>
<li> Data Response  .       ,    3,    8. </li>
<li>   .     ,    9,    4. </li>
<li> Stop Tran Token.   ,     . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperando una respuesta de la tarjeta. </font><font style="vertical-align: inherit;">La tarjeta en Stop Tran Token dibuja la l√≠nea MISO a cero, lo que indica que la tarjeta est√° ocupada. </font><font style="vertical-align: inherit;">Es necesario esperar en la l√≠nea MISO el valor de la unidad, que indicar√° el final del comando</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La finalizaci√≥n del algoritmo de grabaci√≥n. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n hay un peque√±o matiz en el algoritmo de grabaci√≥n. </font><font style="vertical-align: inherit;">La se√±al de selecci√≥n de chip (CS) debe establecerse en cero l√≥gico antes de generar el comando CMD25 y establecerse en uno l√≥gico despu√©s de recibir una respuesta a Stop Tran Token</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algoritmo Gr√°fico</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/_9/kt/ts/_9kttsrffln_gmvgw-l4ch0ekva.png"></a></div>
                    </div><br>
<a name="Hardware"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Implementaci√≥n del algoritmo en hardware.</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de leer la especificaci√≥n, obtenemos algunas caracter√≠sticas del algoritmo que deben implementarse en el hardware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Posibles modos de funcionamiento:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formaci√≥n de frecuencia inicial. </font><font style="vertical-align: inherit;">Las l√≠neas CS y MOSI deben estar en estado de unidad l√≥gica.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfiere datos a una tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recibir datos de una tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A la espera de la finalizaci√≥n del equipo. </font><font style="vertical-align: inherit;">Se utiliza cuando, despu√©s de generar una respuesta, la tarjeta SD dibuja la l√≠nea MISO a cero para esperar la aparici√≥n de una unidad.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lea la respuesta al escribir datos. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperando un token mientras lee datos. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Posibles modos de reloj:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se√±al de reloj para inicializar. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se√±al de reloj para el trabajo. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde mi punto de vista, el algoritmo se implementa de manera √≥ptima utilizando tres componentes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El componente de la capa f√≠sica, que est√° conectada directamente a la tarjeta SD, genera se√±ales SCLK, CS, DI, lee con DO. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un componente de nivel de comando que prepara todos los datos para un componente en la capa f√≠sica. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un componente de comunicaci√≥n con el mundo exterior que oculta todo el dispositivo interno y proporciona una interfaz para comandos (lectura, escritura, borrado) y datos.</font></font></li>
</ul><br>
<a name="HwPhy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 Componente de capa f√≠sica</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SDPhy <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Control bus</span>
			iPhyTxData	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">9</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iPhyMode	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">4</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iPhyTxWrite	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oPhyTxReady	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>; 
			<span class="hljs-comment">-- Out Data</span>
			oPhyRxData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">7</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>); <font></font>
			oPhyRxWrite	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oPhyCmdEnd	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> ); 
<span class="hljs-keyword">end</span> SDPhy;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√≥nde:</font></font><br>
<br>
<ul>
<li> iPhyTxData    ,  iPhyMode  ,    . </li>
<li>iPhyTxWrite ,    iPhyTxData  iPhyMode . </li>
<li>oPhyTxReady ,      .     FULL FIFO,    .</li>
<li>oPhyRxData   ,   SD-.</li>
<li>oPhyRxWrite ,     oPhyRxData . </li>
<li>oPhyCmdEnd ,     .</li>
<li>oSdCS    (CS)  SD-. </li>
<li>oSdClk    SD-.</li>
<li>oSdMosi     SD-.</li>
<li>oSdMosiT        SD-.</li>
<li>iSdMiso     SD-. </li>
<li>sclk      SD- (50 ).</li>
<li>pclk  ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primera se√±al de reinicio, nivel uno activo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los FPGA, existen unidades especiales para trabajar con una se√±al de reloj (PLL, MMCM), sin embargo, recibir una se√±al de reloj a menos de 5 MHz de su salida es problem√°tico. </font><font style="vertical-align: inherit;">Como resultado, la capa f√≠sica opera a una frecuencia de 50 MHz. </font><font style="vertical-align: inherit;">Junto con cada dato en la se√±al iPhyMode, se recibe un bit que indica a qu√© frecuencia estos datos deben transferirse a la tarjeta SD (o recibirse de ella). </font><font style="vertical-align: inherit;">Dependiendo del bit de velocidad, se generan se√±ales de activaci√≥n del reloj. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se implementan dos aut√≥matas en el componente de la capa f√≠sica, para transferir datos a una tarjeta SD y para recibir datos de ella. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√≥digo de m√°quina para la transferencia de datos: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado SDummy proporciona conformaci√≥n de frecuencia inicial, 128 conmutaciones. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado de STxBits proporciona transferencia de datos a la tarjeta SD. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo de la m√°quina para recibir datos: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado sRxBits proporciona recepci√≥n de datos desde la tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado sBusy asegura que la tarjeta SD est√© lista (la tarjeta libera la l√≠nea MISO al nivel de la unidad). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado sResp implementa la lectura de la respuesta al escribir datos. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado sToken implementa una espera de token mientras lee datos. </font></font></li>
</ul><br>
<a name="HwCmd"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 Componente a nivel de comando</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SdCommand <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Command from host</span>
			oSdInitComp	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdInitFail	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdAddress	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdStartErase	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdStartRead	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdStartWrite	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdCmdFinish	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">1</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdhcPresent	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Data</span>
			oSdReadData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdDataR	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdWriteData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdDataW	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">32</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> );
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√≥nde:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdInitComp firma la finalizaci√≥n de la inicializaci√≥n de la tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdInitFail signo de error de inicializaci√≥n. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Direcci√≥n de iSdAddress en la tarjeta SD para ejecutar el comando. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartErase iniciar la ejecuci√≥n del comando de borrado. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartRead comienza a leer la ejecuci√≥n del comando. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartWrite iniciar la ejecuci√≥n del comando de escritura. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdCmd: Finaliza el estado de finalizaci√≥n del equipo. </font><font style="vertical-align: inherit;">El bit cero es igual a uno, el comando se complet√≥ con √©xito. </font><font style="vertical-align: inherit;">El primer bit es uno, el comando se complet√≥ con un error.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdhc Indicador actual de detecci√≥n de tarjeta SDHC / SDXC. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdReadData Leer datos para escribir en la tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datos iSdDataR para escribir en la tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indicador oSdWriteData para escribir datos le√≠dos de la tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datos de oSdDataW le√≠dos de una tarjeta SD.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las se√±ales restantes coinciden con las se√±ales de la capa f√≠sica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El componente tiene 5 m√°quinas autom√°ticas.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdInit ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): inicializaci√≥n de la tarjeta SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdErase ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): borra datos de una tarjeta SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdRead ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): lee datos de una tarjeta SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdWrite ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): escribe datos en una tarjeta SD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdCommand ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): sobre la base de las caracter√≠sticas generadas, prepara los datos para la capa f√≠sica de todas las m√°quinas anteriores.</font></font></li>
</ul><br>
<a name="HwHost"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3 Componente de comunicaci√≥n con el mundo exterior.</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SdHost <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Sd Host command</span>
			iSdCommand	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">2</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdAddress	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdStart	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdStatus	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">1</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdInitFail	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Write data to card</span>
			iSdTxData	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdTxValid	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdTxLast	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdTxReady	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Read data from card</span>
			oSdRxData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdRxValid	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdRxLast	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdRxReady	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> );
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√≥nde:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de comando de iSdCommand para ejecutar. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdAddress es la direcci√≥n para ejecutar el comando. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejecuci√≥n del comando de inicio iSdStart. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdStatus estado de finalizaci√≥n del equipo. </font><font style="vertical-align: inherit;">El bit cero es igual a uno: se completa el comando. </font><font style="vertical-align: inherit;">El primer bit es uno: el comando se complet√≥ con un error.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdInitFail signo de error de inicializaci√≥n. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxData. </font><font style="vertical-align: inherit;">Interfaz Axi-Stream para escribir datos en una tarjeta SD. </font><font style="vertical-align: inherit;">Puerto con datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxValid. </font><font style="vertical-align: inherit;">Interfaz Axi-Stream para escribir datos en una tarjeta SD. </font><font style="vertical-align: inherit;">Puerto con se√±al de escritura.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxLast. </font><font style="vertical-align: inherit;">Interfaz Axi-Stream para escribir datos en una tarjeta SD. </font><font style="vertical-align: inherit;">Puerto con un signo de la √∫ltima dw en los datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdTxReady. </font><font style="vertical-align: inherit;">Interfaz Axi-Stream para escribir datos en una tarjeta SD. </font><font style="vertical-align: inherit;">Puerto con un signo de disponibilidad para recibir datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxData. </font><font style="vertical-align: inherit;">Interfaz Axi-Stream para leer datos de una tarjeta SD. </font><font style="vertical-align: inherit;">Puerto con datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxValid. </font><font style="vertical-align: inherit;">Interfaz Axi-Stream para leer datos de una tarjeta SD. </font><font style="vertical-align: inherit;">Puerto con se√±al de escritura.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxLast. </font><font style="vertical-align: inherit;">Interfaz Axi-Stream para leer datos de una tarjeta SD. </font><font style="vertical-align: inherit;">Puerto con un signo de la √∫ltima dw en los datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdRxReady. </font><font style="vertical-align: inherit;">Interfaz Axi-Stream para leer datos de una tarjeta SD. </font><font style="vertical-align: inherit;">Puerto con un signo de disponibilidad para recibir datos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las se√±ales restantes coinciden con las se√±ales de la capa f√≠sica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El componente implementa una m√°quina smSdControl ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estado de reposo. </font><font style="vertical-align: inherit;">Esperando la inicializaci√≥n y el comando para completar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado de sWaitCmd. </font><font style="vertical-align: inherit;">Comprobando el tipo de comando.</font></font></li>
<li>sReadCmd.    FIFO,   ,     SD-      . </li>
<li>sWriteCmd. ,   FIFO      SD-,      . </li>
<li>sEraseCmd.     . </li>
<li>sWaitEnd.       . </li>
<li>sFinish.   ,  . </li>
</ul><br>
<a name="RealTest"></a><h2>3.   </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo est√° escrito, verificado en el simulador. </font><font style="vertical-align: inherit;">Es necesario verificar ahora en hierro. </font><font style="vertical-align: inherit;">De lo que estaba disponible, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">surgi√≥ la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> placa </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Zybo de Digilent</font></a><font style="vertical-align: inherit;"> 
. Tiene terminales FPGA gratuitas en un banco con un voltaje de + 3.3V, al que puede conectar f√°cilmente un dispositivo externo. </font><font style="vertical-align: inherit;">S√≠, y el tipo de FPGA utilizado es Zynq-7000, lo que significa que hay un n√∫cleo de procesador. </font><font style="vertical-align: inherit;">Puede escribir una prueba en C, lo que simplificar√° la tarea de prueba. </font><font style="vertical-align: inherit;">
Entonces, conectamos el algoritmo implementado al n√∫cleo del procesador a trav√©s del puerto GP (es posible la operaci√≥n de 4 bytes, similar a </font><abbr title="Entrada / salida programada"><font style="vertical-align: inherit;">PIO</font></abbr><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">No nos molestaremos con las interrupciones; implementamos una encuesta de temporizador. </font><font style="vertical-align: inherit;">
Cuando trabaje en el m√≥dulo del procesador, el algoritmo de grabaci√≥n de datos ser√° el siguiente:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/oe/oy/nj/oeoynjbbxwco9wrihj-f3unb3cs.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><abbr title="Entrada / salida programada"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecer direcci√≥n en la tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecer el c√≥digo de comando 2. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribir datos en un b√∫fer ubicado en l√≥gica programable. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejecute el comando </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espere hasta que se complete el comando. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restablecer el estado de finalizaci√≥n del equipo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prueba implementada:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress ++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data write to %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">2</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Write data to PL */</span>
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)<font></font>
	{<font></font>
		Xil_Out32(<span class="hljs-number">0x43c00014</span>, cntrData);<font></font>
		cntrData++;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in write \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Duration operation */</span><font></font>
	durationWrite += cntrDuration;<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cntrDuration &gt; MaxWrite )<font></font>
	{<font></font>
		MaxWrite = cntrDuration;<font></font>
	}<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A la pregunta de por qu√© se usa el l√≠mite exterior de 1024 en el bucle, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el algoritmo establece el n√∫mero de bloques igual a 8. El</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tama√±o de un bloque es de 512 bytes. </font><font style="vertical-align: inherit;">El tama√±o total de 8 bloques de datos es 8 * 512 bytes = 4096 bytes. </font><font style="vertical-align: inherit;">El bus entre el m√≥dulo procesador y la l√≥gica programable tiene un tama√±o de 4 bytes. </font><font style="vertical-align: inherit;">Resulta que para enviar 4096 bytes de 4 bytes desde el m√≥dulo del procesador a la l√≥gica programable, es necesario realizar 4096/4 = 1024 operaciones de escritura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando trabaje en el m√≥dulo del procesador, el algoritmo de lectura de datos ser√° el siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecer direcci√≥n en la tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecer c√≥digo de comando 1. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejecute el comando </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espere hasta que se complete el comando. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restablecer el estado de finalizaci√≥n del equipo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leer datos del b√∫fer en l√≥gica programable. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prueba implementada:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data read from %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			 <span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in read \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	 <span class="hljs-comment">/** Duration operation */</span><font></font>
	 durationRead += cntrDuration;<font></font>
<font></font>
	 <span class="hljs-keyword">if</span> (cntrDuration &gt; MaxRead )<font></font>
	 {<font></font>
		 MaxRead = cntrDuration;<font></font>
	 }<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Read data from PL */</span>
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)<font></font>
	{<font></font>
		DataR = Xil_In32(<span class="hljs-number">0x43c0001c</span>);
		<span class="hljs-keyword">if</span> (DataR != cntrData)<font></font>
		{<font></font>
			xil_printf(<span class="hljs-string">"Data corrupt! \n\r"</span>);<font></font>
		}<font></font>
		DataR = Xil_In32(<span class="hljs-number">0x43c00020</span>);<font></font>
		cntrData++;<font></font>
	}<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al trabajar en el m√≥dulo del procesador, el algoritmo de borrado de datos ser√° el siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecer direcci√≥n en la tarjeta SD. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecer el c√≥digo de comando 4. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejecute el comando </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espere hasta que se complete el comando. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restablecer el estado de finalizaci√≥n del equipo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prueba implementada:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data erase from %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">4</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in write! \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Duration operation */</span><font></font>
	durationErase += cntrDuration;<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cntrDuration &gt; MaxErase )<font></font>
	{<font></font>
		MaxErase = cntrDuration;<font></font>
	}<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba completamente en github.</font></font></a><br>
<br>
<a name="Results"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Resultados</font></font></h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La cantidad de datos</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leyendo </font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grabar</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Borrar </font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 bloque (512 bytes)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.7 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.36 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,58 Mbps</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 bloques (4096 bytes)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15,4 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6,38 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.66 Mbps</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 bloques (8192 bytes)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">18,82 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,26 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9,79 Mbps</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se utiliz√≥ una tarjeta de 16 GB. </font><font style="vertical-align: inherit;">Durante las pruebas, se registraron 2 GB de datos, se leyeron 2 GB de datos y se borraron 2 GB de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las conclusiones son decepcionantes. </font><font style="vertical-align: inherit;">Cuando se usa FPGA, no tiene sentido usar la tarjeta SD en modo SPI, excepto en el caso de que sea muy necesario almacenar grandes cantidades de datos sin presentar requisitos de velocidad.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495388/index.html">Programa de televisi√≥n de la d√©cada de 1970 que se convirti√≥ en un antepasado de los eSports</a></li>
<li><a href="../es495390/index.html">Vale la pena probar STM32CubeMonitor</a></li>
<li><a href="../es495392/index.html">C√≥mo buscar errores en el front-end: 4 etapas principales</a></li>
<li><a href="../es495396/index.html">Primera impresi√≥n de conceptos.</a></li>
<li><a href="../es495398/index.html">Ro.Ri.Re</a></li>
<li><a href="../es495402/index.html">El a√±o pasado, finalmente fotografiamos un agujero negro. ¬øAhora que?</a></li>
<li><a href="../es495404/index.html">¬øLas acciones ca√≠das son prometedoras? Analicemos con python</a></li>
<li><a href="../es495408/index.html"># 02 - Y un byte completo no es suficiente ... | La cruz de los cambios.</a></li>
<li><a href="../es495412/index.html">Norbert Wiener. Una persona interesante Colegas, enemigos, lucha por la independencia.</a></li>
<li><a href="../es495414/index.html">Consecuencias del miedo.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>