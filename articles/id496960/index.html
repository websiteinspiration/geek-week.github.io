<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙇🏻 💍 ⚰️ Mempercepat grafik menggunakan OffscreenCanvas 🙌🏻 🔖 ❗️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Render grafik dapat berdampak serius pada browser. Terutama ketika datang untuk mengeluarkan banyak elemen yang mewakili diagram dalam antarmuka aplik...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mempercepat grafik menggunakan OffscreenCanvas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/496960/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Render grafik dapat berdampak serius pada browser. </font><font style="vertical-align: inherit;">Terutama ketika datang untuk mengeluarkan banyak elemen yang mewakili diagram dalam antarmuka aplikasi yang kompleks. </font><font style="vertical-align: inherit;">Anda dapat mencoba memperbaiki situasi menggunakan antarmuka </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tingkat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dukungan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> yang browser secara bertahap tumbuh. </font><font style="vertical-align: inherit;">Hal ini memungkinkan, menggunakan pekerja web, untuk menggeser tugas membentuk gambar yang ditampilkan dalam elemen yang terlihat </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Artikel, terjemahan yang kami terbitkan hari ini, dikhususkan untuk penggunaan antarmuka </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Di sini kita akan berbicara tentang mengapa antarmuka ini mungkin diperlukan, tentang apa yang benar-benar dapat diharapkan dari penggunaannya, dan tentang kesulitan apa yang mungkin timbul ketika bekerja dengannya.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/mi/x3/fs/mix3fsxq_7zuda10gqvxuhwmw1u.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa memperhatikan OffscreenCanvas?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode yang terlibat dalam rendering diagram itu sendiri mungkin memiliki kompleksitas komputasi yang cukup tinggi. Di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">banyak tempat,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Anda dapat menemukan cerita terperinci tentang cara menampilkan animasi yang halus dan untuk memastikan interaksi pengguna yang nyaman dengan halaman, perlu bahwa rendering satu frame cocok dalam waktu sekitar 10 ms, yang memungkinkan Anda mencapai 60 frame per detik. Jika perhitungan yang diperlukan untuk menghasilkan satu frame membutuhkan lebih dari 10 ms, ini akan menghasilkan "pelambatan" yang nyata dari halaman tersebut. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat menampilkan diagram, situasinya diperburuk oleh hal-hal berikut:</font></font><br>
<br>
<ul>
<li>        —   - (SVG, canvas, WebGL)      ,     ,       .</li>
<li>     , ,        ,  ,  10 .          ( —   )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Masalah-masalah ini adalah kandidat ideal untuk pendekatan optimasi klasik yang disebut divide and conquer. Dalam hal ini, kita berbicara tentang distribusi beban komputasi di beberapa utas. Namun, sebelum tampilan antarmuka, </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semua kode rendering perlu dieksekusi di utas utama. Satu-satunya cara kode ini dapat menggunakan API yang diperlukan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dari sudut pandang teknis, perhitungan "berat" bisa menjadi output ke utas pekerja web sebelumnya. Tetapi, karena panggilan yang bertanggung jawab untuk rendering harus dilakukan dari aliran utama, ini membutuhkan penggunaan skema pertukaran pesan yang kompleks antara aliran pekerja dan aliran utama dalam kode output bagan. Selain itu, pendekatan ini sering hanya memberikan sedikit peningkatan kinerja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spesifikasi</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memberi kami mekanisme untuk mentransfer kontrol permukaan untuk menampilkan elemen grafik </font></font><code>&lt;canvas&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di pekerja web. </font><font style="vertical-align: inherit;">Spesifikasi ini saat ini didukung oleh browser Chrome dan Edge (setelah Edge dimigrasikan ke Chromium). </font><font style="vertical-align: inherit;">Diharapkan bahwa dukungan Firefox </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan muncul dalam waktu enam bulan. </font><font style="vertical-align: inherit;">Jika kita berbicara tentang Safari, masih belum diketahui apakah dukungan untuk teknologi ini direncanakan di browser ini.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Output bagan menggunakan OffscreenCanvas</font></font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e83/fe3/cf3/e83fe3cf3d366175052d1b6e66a65f93.jpg"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contoh bagan yang menampilkan 100.000 titik multi-warna</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Untuk menilai lebih baik potensi keuntungan dan kerugiannya</font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mari kita lihat contoh output dari diagram "berat" yang ditunjukkan pada gambar sebelumnya.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> offscreenCanvas = canvasContainer<font></font>
&nbsp;&nbsp;.querySelector(<span class="hljs-string">'canvas'</span>)<font></font>
&nbsp;&nbsp;.transferControlToOffscreen();<font></font>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> Worker(<span class="hljs-string">'worker.js'</span>);<font></font>
worker.postMessage({ offscreenCanvas }, [offscreenCanvas]);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami kueri </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elemen </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menggunakan metode baru </font></font><code>transferControlToOffscreen()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kemudian kami memanggil metode </font></font><code>worker.postMessage({ canvas: offscreenCanvas }, [offscreenCanvas])</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, melakukan ini untuk mengirim pesan kepada pekerja yang berisi tautan </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sangat penting bahwa di sini, sebagai argumen kedua, Anda perlu menggunakan </font></font><code>[offscreenCanvas]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ini memungkinkan Anda untuk membuat pemilik objek pekerja ini, yang akan memungkinkannya untuk mengelola sendiri </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">canvasContainer.addEventListener(<span class="hljs-string">'measure'</span>, ({ detail }) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> { width, height } = detail;<font></font>
&nbsp;&nbsp;worker.postMessage({ width, height });<font></font>
});<font></font>
canvasContainer.requestRedraw();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mempertimbangkan bahwa ukuran </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">awalnya diturunkan dari atribut </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elemen </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, adalah tanggung jawab kami untuk menjaga nilai-nilai ini tetap mutakhir ketika elemen diubah ukurannya </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Di sini kita menggunakan acara </font></font><code>measure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dari </font></font><code>d3fc-canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang akan memberi kita kesempatan, dalam perjanjian dengan </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, untuk menyampaikan informasi kepada pekerja tentang dimensi baru elemen </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menyederhanakan contoh, kita akan menggunakan komponen dari pustaka </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d3fc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ini adalah seperangkat komponen tambahan yang menggabungkan komponen d3 atau melengkapi fungsinya. Anda </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dapat </font><font style="vertical-align: inherit;">bekerja dengan </font><font style="vertical-align: inherit;">tanpa komponen-d3fc. Semua yang akan dibahas dapat dilakukan menggunakan fitur JavaScript standar eksklusif.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang buka kode dari file </font></font><code>worker.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dalam contoh ini, demi peningkatan kinerja rendering yang nyata, kita akan menggunakan WebGL.</font></font><br>
<br>
<pre><code class="javascript hljs">addEventListener(<span class="hljs-string">'message'</span>, ({ <span class="hljs-attr">data</span>: { offscreenCanvas, width, height } }) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (offscreenCanvas != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = offscreenCanvas.getContext(<span class="hljs-string">'webgl'</span>);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series.context(gl);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (width != <span class="hljs-literal">null</span> &amp;&amp; height != <span class="hljs-literal">null</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> gl = series.context();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.width = width;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.canvas.height = height;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gl.viewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, gl.canvas.width, gl.canvas.height);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika kami menerima pesan yang berisi properti </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, kami menganggap bahwa pesan itu berasal dari utas utama. Selanjutnya, kita mendapatkan </font></font><code>canvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">konteks </font><font style="vertical-align: inherit;">dari elemen </font></font><code>webgl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan meneruskannya ke komponen </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Kemudian kita memanggil komponen </font></font><code>series</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, meneruskannya data ( </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), yang ingin kita render menggunakannya (di bawah ini kita akan berbicara tentang dari mana variabel yang sesuai </font><font style="vertical-align: inherit;">berasal </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, kami memeriksa properti </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang datang dalam pesan, dan menggunakannya untuk mengatur dimensi </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">area tampilan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> WebGL. Tautan </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak digunakan secara langsung. Faktanya adalah bahwa pesan tersebut mengandung properti </font></font><code>offscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atau properti </font></font><code>width</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>height</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode pekerja yang tersisa bertanggung jawab untuk mengatur rendering dari apa yang ingin kita hasilkan. </font><font style="vertical-align: inherit;">Tidak ada yang istimewa di sini, jadi jika semua ini tidak asing bagi Anda, Anda dapat langsung melanjutkan ke bagian selanjutnya di mana kami membahas kinerja.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> randomNormal = d3.randomNormal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> randomLogNormal = d3.randomLogNormal();<font></font>
<font></font>
<span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Array</span>.from({ <span class="hljs-attr">length</span>: <span class="hljs-number">1e5</span> }, () =&gt; ({
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">x</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">y</span>: randomNormal(),
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">size</span>: randomLogNormal() * <span class="hljs-number">10</span><font></font>
}));<font></font>
<font></font>
<span class="hljs-keyword">const</span> xScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);<font></font>
<font></font>
<span class="hljs-keyword">const</span> yScale = d3.scaleLinear().domain([<span class="hljs-number">-5</span>, <span class="hljs-number">5</span>]);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami membuat kumpulan data yang berisi koordinat titik yang didistribusikan secara acak di sekitar titik asal x / y, dan menyesuaikan penskalaan. </font><font style="vertical-align: inherit;">Kami tidak menetapkan rentang nilai x dan y menggunakan metode ini </font></font><code>range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, karena seri WebGL ditampilkan dalam ukuran penuh elemen </font></font><code>canvas</code> <code>(-1 -&gt; +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam koordinat normalisasi perangkat).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> series = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.seriesWebglPoint()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.xScale(xScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.yScale(yScale)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.crossValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.x)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.mainValue(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.y)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.size(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.size)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.equals(<span class="hljs-function">(<span class="hljs-params">previousData, data</span>) =&gt;</span> previousData.length &gt; <span class="hljs-number">0</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, kami menyiapkan serangkaian poin menggunakan </font></font><code>xScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>yScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Kemudian kami mengonfigurasi cara akses yang sesuai yang memungkinkan Anda membaca data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, kami mendefinisikan fungsi pengecekan kesetaraan kami sendiri, yang dirancang untuk memastikan bahwa komponen tidak mengirimkan </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU pada setiap rendering. </font><font style="vertical-align: inherit;">Kami harus mengungkapkan ini secara eksplisit, karena meskipun kami tahu bahwa kami tidak akan mengubah data ini, komponen tidak dapat mengetahuinya tanpa melakukan pemeriksaan "kotor" yang intensif sumber daya.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> colorScale = d3.scaleOrdinal(d3.schemeAccent);<font></font>
<font></font>
<span class="hljs-keyword">const</span> webglColor = <span class="hljs-function"><span class="hljs-params">color</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> { r, g, b, opacity } = d3.color(color).rgb();
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> [r / <span class="hljs-number">255</span>, g / <span class="hljs-number">255</span>, b / <span class="hljs-number">255</span>, opacity];<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">const</span> fillColor = fc<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.webglFillColor()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.value(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> webglColor(colorScale(i)))<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.data(data);<font></font>
<font></font>
series.decorate(<span class="hljs-function"><span class="hljs-params">program</span> =&gt;</span> {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;fillColor(program);<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kode ini memungkinkan Anda untuk mewarnai bagan. </font><font style="vertical-align: inherit;">Kami menggunakan indeks titik dalam kumpulan data untuk memilih warna yang cocok </font></font><code>colorScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lalu mengonversinya ke format yang diperlukan dan menggunakannya untuk menghias titik keluaran.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">const</span> ease = <span class="hljs-number">5</span> * (<span class="hljs-number">0.51</span> + <span class="hljs-number">0.49</span> * <span class="hljs-built_in">Math</span>.sin(<span class="hljs-built_in">Date</span>.now() / <span class="hljs-number">1e3</span>));<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;xScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;yScale.domain([-ease, ease]);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;series(data);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;requestAnimationFrame(render);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang setelah titik-titik diwarnai, yang tersisa hanyalah menghidupkan grafik. Karena itu, kita perlu pemanggilan metode yang konstan </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ini, sebagai tambahan, akan membuat beberapa beban pada sistem. Kami mensimulasikan peningkatan dan penurunan skala grafik menggunakan </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk memodifikasi properti </font></font><code>xScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>yScale.domain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setiap frame. Di sini, nilai tergantung waktu diterapkan dan dihitung sehingga skala bagan berubah dengan lancar. Selain itu, kami memodifikasi header pesan sehingga metode dipanggil untuk memulai siklus rendering </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan agar kami tidak harus langsung menelepon </font></font><code>series(data)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="javascript hljs">importScripts(
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-array/dist/d3-array.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-collection/dist/d3-collection.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-color/dist/d3-color.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-interpolate/dist/d3-interpolate.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-random/dist/d3-random.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-scale/dist/d3-scale.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3-shape/dist/d3-shape.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-extent/build/d3fc-extent.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-random-data/build/d3fc-random-data.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-rebind/build/d3fc-rebind.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-series/build/d3fc-series.js'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'./node_modules/d3fc-webgl/build/d3fc-webgl.js'</span><font></font>
);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agar contoh ini berfungsi, tetap hanya mengimpor perpustakaan yang diperlukan ke dalam pekerja. </font><font style="vertical-align: inherit;">Kami menggunakan ini </font></font><code>importScripts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan juga, agar tidak menggunakan alat untuk membangun proyek, kami menggunakan daftar dependensi yang dikompilasi secara manual. </font><font style="vertical-align: inherit;">Sayangnya, kami tidak bisa hanya mengunduh build d3 / d3fc lengkap, karena mereka tergantung DOM, dan apa yang mereka butuhkan pada pekerja tidak tersedia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
→ Kode lengkap untuk contoh ini dapat ditemukan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kanal dan kinerja Offscreen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Animasi dalam proyek kami bekerja berkat penggunaan </font></font><code>requestAnimationFrame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pekerja. Hal ini memungkinkan pekerja untuk membuat halaman bahkan ketika utas utama sibuk dengan hal-hal lain. Jika Anda melihat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">halaman</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> proyek yang dijelaskan di bagian sebelumnya dan mengklik tombol </font></font><code>Stop main thread</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Anda dapat memperhatikan fakta bahwa ketika kotak pesan ditampilkan, pembaruan informasi cap waktu berhenti. Utas utama diblokir, tetapi animasi grafik tidak berhenti.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f1a/3ce/c20/f1a3cec2086024dcbe24cedddf1a90e7.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jendela Proyek</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Kita dapat mengatur rendering yang dimulai dengan menerima pesan dari aliran utama. Misalnya, peristiwa semacam itu dapat dikirim ketika pengguna berinteraksi dengan bagan atau ketika menerima data baru melalui jaringan. Tetapi dengan pendekatan ini, jika utas sibuk dengan sesuatu dan tidak ada pesan yang diterima pada pekerja, rendering akan berhenti.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Render bagan yang terus-menerus dalam kondisi ketika tidak ada yang terjadi di atasnya adalah cara yang bagus untuk mengganggu pengguna dengan kipas angin yang berdengung dan baterai lemah. Akibatnya, ternyata di dunia nyata, keputusan tentang bagaimana membagi tanggung jawab antara utas utama dan utas pekerja tergantung pada apakah pekerja dapat memberikan sesuatu yang bermanfaat ketika dia tidak menerima pesan tentang perubahan situasi dari utas utama.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita berbicara tentang transfer pesan di antara utas, harus dicatat bahwa di sini kita menerapkan pendekatan yang sangat sederhana. Sejujurnya, kita perlu mengirimkan sangat sedikit pesan di antara utas-utas, jadi saya lebih suka menyebut pendekatan kami sebagai konsekuensi pragmatisme, bukan kemalasan. Tetapi jika kita berbicara tentang aplikasi nyata, dapat dicatat bahwa skema transfer pesan antara aliran akan menjadi lebih rumit jika interaksi pengguna dengan diagram dan memperbarui data yang divisualisasikan akan bergantung pada mereka. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat menggunakan antarmuka </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">MessageChannel</font></a><font style="vertical-align: inherit;"> standar untuk membuat saluran pesan terpisah antara utas utama dan </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">utas</font></a><font style="vertical-align: inherit;"> pekerja </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Masing-masing saluran ini dapat digunakan untuk kategori pesan tertentu, yang membuatnya lebih mudah untuk memproses pesan. Sebagai alternatif untuk mekanisme standar, perpustakaan pihak ketiga seperti </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comlink</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dapat bertindak </font><font style="vertical-align: inherit;">. Pustaka ini menyembunyikan detail tingkat rendah di belakang antarmuka tingkat tinggi menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">objek proxy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fitur lain yang menarik dari contoh kami, yang menjadi jelas terlihat dalam retrospeksi, adalah fakta bahwa memperhitungkan fakta bahwa sumber daya GPU, seperti sumber daya sistem lainnya, jauh dari tiada akhir. Terjemahan rendering menjadi pekerja memungkinkan utas untuk menyelesaikan masalah lainnya. Tetapi browser, bagaimanapun, perlu menggunakan GPU untuk membuat DOM dan apa yang dihasilkan oleh sarana </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika pekerja mengkonsumsi semua sumber daya GPU, maka jendela aplikasi utama akan mengalami masalah kinerja, terlepas dari di mana rendering dilakukan. Perhatikan bagaimana kecepatan memperbarui stempel waktu dalam contoh menurun saat jumlah poin yang ditampilkan meningkat. Jika Anda memiliki kartu grafis yang kuat, maka Anda mungkin harus meningkatkan jumlah poin yang dikirimkan ke halaman dalam string kueri. Untuk melakukan ini, Anda dapat menggunakan nilai yang melebihi nilai maksimum 100000, ditentukan menggunakan salah satu tautan di halaman contoh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perlu dicatat bahwa di sini kita tidak menjelajahi dunia rahasia </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atribut konteks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Studi semacam itu dapat membantu kita meningkatkan produktivitas solusi. </font><font style="vertical-align: inherit;">Namun, saya tidak melakukan ini dengan melakukannya karena rendahnya dukungan untuk atribut ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kita berbicara tentang rendering menggunakan </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, maka atributnya terlihat paling menarik di sini </font></font><code>desynchronized</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Itu, jika didukung, dan tunduk pada beberapa batasan, memungkinkan Anda untuk menyingkirkan sinkronisasi antara loop peristiwa dan loop rendering yang dijalankan pada pekerja. </font><font style="vertical-align: inherit;">Ini meminimalkan keterlambatan memperbarui gambar. </font><font style="vertical-align: inherit;">Detail tentang ini dapat ditemukan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ringkasan</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antarmuka </font></font><code>OffscreenCanvas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memberi para pengembang kesempatan untuk meningkatkan kinerja pembuatan grafik, tetapi menggunakannya membutuhkan pendekatan yang bijaksana. </font><font style="vertical-align: inherit;">Dengan menggunakannya, Anda perlu mempertimbangkan hal berikut:</font></font><br>
<br>
<ul>
<li>     (,  ,     )  -        .<br>
<br>
<ul>
<li>  ,         .  ,   ,         ,    postMessage.</li>
</ul></li>
<li>,       (,  SVG/HTML-   <code>&lt;canvas&gt;</code>), ,   ,  .<br>
<br>
<ul>
<li>,  ,   ,      ,       ,   ,  ,  ,     .</li>
</ul></li>
<li>,     GPU,    <code>OffscreenCanvas</code>       .<br>
<br>
<ul>
<li>      OffscreenCanvas,        GPU-,     ,     .    ,    ,      .</li>
</ul></li>
</ul><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Berikut adalah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contoh kode, dan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">di sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah versi kerjanya. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pembaca yang budiman! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sudahkah Anda menggunakan OffscreenCanvas untuk mempercepat tampilan grafik di halaman web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id496950/index.html">Desain adalah desain, bukan keindahan gambar.</a></li>
<li><a href="../id496952/index.html">Qualcomm QCC3020 - munculnya headphone TWS Cina</a></li>
<li><a href="../id496954/index.html">Pengembangan di Wargaming - bertemu dengan Maxim Baryshnikov, Kepala Platform (Bagian I)</a></li>
<li><a href="../id496956/index.html">Mengapa server web asinkron muncul?</a></li>
<li><a href="../id496958/index.html">CSS yang menarik ditemukan di desain Facebook yang baru</a></li>
<li><a href="../id496962/index.html">Bagaimana cara merapikan server yang kelebihan beban?</a></li>
<li><a href="../id496964/index.html">Seminar Mingguan IBM - April 2020</a></li>
<li><a href="../id496966/index.html">Warna CSS LCH</a></li>
<li><a href="../id496968/index.html">4 tindakan yang tidak termaafkan untuk pemimpin selama COVID-19</a></li>
<li><a href="../id496972/index.html">Tren Keamanan Pangan 2020. Mitap Online Gratis 21 April</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>