<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍰 🎏 🏜️ Javaアプリケーション用のDockerイメージを最適化する別の方法 ♊️ ▪️ 👨🏿‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Javaアプリケーションの画像最適化のストーリーは、春のブログ記事「コンテナ内のブート」で始まりました。イメージのサイズを小さくするなどの興味深い問題を含め、スプリングブートアプリケーション用のDockerイメージを作成するさまざまな側面について説明しました。私たちのチームにとって、これはいくつかの...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Javaアプリケーション用のDockerイメージを最適化する別の方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458260/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javaアプリケーションの画像最適化のストーリーは、春のブログ記事「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナ内のブート」で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">始まりました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">イメージのサイズを小さくするなどの興味深い問題を含め、スプリングブートアプリケーション用のDockerイメージを作成するさまざまな側面について説明しました。</font><font style="vertical-align: inherit;">私たちのチームにとって、これはいくつかの理由で関連性があったため、このソリューションをアプリケーションに適用することにしました。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">よくあることですが、すべてが最初に成功したわけではありません。マルチモジュールプロジェクトには微妙なニュアンスがあり、CIシステムでこれをすべて実行しようとしたため、この記事ではこれらの問題の解決策を見つけます。 </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化の目的は</font><font style="vertical-align: inherit;">、結果として得られる画像のアセンブリ</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ごとの違い</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を減らすことです</font><font style="vertical-align: inherit;">。これにより、継続的デリバリーのプロセスで良い結果が得られます。そのため、画像のサイズを最小限に抑えることに関心がある場合は</font><font style="vertical-align: inherit;">、ハブの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他の</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">参照できます。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イメージに配置する前にマルチメーターブートアプリケーションで何かをする必要がある理由を説明する必要がない場合</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、最適化アプローチの説明に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すぐに進むことができます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">春のブログの記事に慣れた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合は、見つかった問題の解決策に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">進むことができます</font><font style="vertical-align: inherit;">。</font></font></p><a name="habracut"></a><br>
<h1 id="zachem-eto-vse-ili-obratnaya-storona-fat-jara"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜこれがすべて、または太い瓶の裏側なのか</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デフォルトでは、Spring Bootが生成するjarは、アプリケーションコードとそのすべての依存関係を含む実行可能なjarファイルです。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このアプローチの利点は明白です。1つのファイルで作業するのが便利で、実行に必要なすべてのものが揃っています</font></font><code>java -jar &lt;myapp&gt;.jar</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Dockerfileは取るに足らないものであり、重要ではありません。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">欠点は、非効率的なストレージです。</font><font style="vertical-align: inherit;">クラシックブートアプリケーションでは、コードとライブラリの比率は明らかにコードに有利ではありません。</font><font style="vertical-align: inherit;">たとえば、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start.spring.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を介して生成できる、データベースを操作するためのWebパーツとライブラリを含む空のアプリケーションは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">20MBかかり</font></a><font style="vertical-align: inherit;">、そのうち98％がライブラリになります。</font><font style="vertical-align: inherit;">そして、この比率は開発プロセス中にあまり変化しません。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ただし、アプリケーションは複数回収集しますが、CIサーバーで定期的に収集し、一連の環境を通じて展開します。</font><font style="vertical-align: inherit;">したがって、200mbで10個のアセンブリが成長し、すでに2GBで100個のアセンブリが成長します。そのうちの変更はほとんど必要ありません。</font></font></p><br>
<p> ,                ,         ,    .      :      ,    100   ,          ,                    .</p><br>
<p>,   ,  .</p><br>
<h1 id="anchoroptimizinganchor-optimiziruem-sborku-ili-chto-mozhno-pocherpnut-iz-springovogo-bloga"><a name="optimizing"></a>  ,       </h1><br>
<p>   :   ,   <code>COPY my-jar.jar app.jar</code>,     .<br>
    ,  —   .   jar-         .</p><br>
<p>   jar-  :</p><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">set</span> -e<font></font>
<font></font>
path_to_jar=<span class="hljs-variable">$1</span><font></font>
<font></font>
dir=$(dirname <span class="hljs-string">"<span class="hljs-variable">${path_to_jar}</span>"</span>)<font></font>
jar_name=$(basename <span class="hljs-string">"<span class="hljs-variable">${path_to_jar}</span>"</span>)<font></font>
<font></font>
mkdir -p <span class="hljs-string">"<span class="hljs-variable">${dir}</span>/docker-dist"</span> &amp;&amp; <span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">${dir}</span>/docker-dist"</span><font></font>
<font></font>
jar -xf ../<span class="hljs-string">"<span class="hljs-variable">${jar_name}</span>"</span></code></pre><br>
<p>Dockerfile   multi-stage    </p><br>
<pre><code class="plaintext hljs">FROM openjdk:8-jdk-alpine as build<font></font>
<font></font>
WORKDIR /wd<font></font>
<font></font>
COPY prepare_for_docker.sh /usr/local/bin/prepare_for_docker<font></font>
<font></font>
COPY target/demo.jar /wd/app.jar<font></font>
RUN prepare_for_docker /wd/app.jar<font></font>
<font></font>
FROM openjdk:8-jdk-alpine<font></font>
<font></font>
COPY --from=build /wd/docker-dist/BOOT-INF/lib /app/lib<font></font>
COPY --from=build /wd/docker-dist/META-INF /app/META-INF<font></font>
COPY --from=build /wd/docker-dist/BOOT-INF/classes /app<font></font>
<font></font>
ENTRYPOINT ["java","-cp","app:app/lib/*","com.example.demo.DemoApplication"]</code></pre><br>
<p>      ,      jar-,             .</p><br>
<p>   :</p><br>
<ol>
<li>   </li>
<li>     </li>
<li> <code>docker build</code>       <code>Using cache</code>     lib<br>
<pre><code class="plaintext hljs">...<font></font>
Step 5/10 : RUN prepare_for_docker app.jar<font></font>
---&gt; Running in c8e422491eb2<font></font>
Removing intermediate container c8e422491eb2<font></font>
---&gt; c7dcec4ae18a<font></font>
Step 6/10 : FROM openjdk:8-jdk-alpine<font></font>
---&gt; a3562aa0b991<font></font>
Step 7/10 : COPY --from=build /wd/docker-dist/BOOT-INF/lib /app/lib<font></font>
---&gt; Using cache<font></font>
---&gt; 01b600d7e350<font></font>
Step 8/10 : COPY --from=build /wd/docker-dist/META-INF /app/META-INF<font></font>
---&gt; Using cache<font></font>
---&gt; 5c0c03a3c8f1<font></font>
Step 9/10 : COPY --from=build /wd/docker-dist/BOOT-INF/classes /app<font></font>
---&gt; 5ffed6ee5696<font></font>
Step 10/10 : ENTRYPOINT ["java","-cp","app:app/lib/*","com.example.demo.DemoApplication"]<font></font>
---&gt; Running in 99957250fe5d<font></font>
Removing intermediate container 99957250fe5d<font></font>
---&gt; 6735799d9f32<font></font>
Successfully built 6735799d9f32<font></font>
Successfully tagged boot2-sample:latest</code></pre></li>
</ol><br>
<p>     —   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>  ,        .       .</p><br>
<pre><code class="plaintext hljs">FROM zeldigas/java-layered-builder as build<font></font>
<font></font>
COPY target/demo.jar app.jar<font></font>
RUN prepare_for_docker app.jar</code></pre><br>
<h1 id="anchorimprovementsanchordorabatyvaem-reshenie"><a name="improvements"></a> </h1><br>
<p>     ,  ,               .</p><br>
<h2 id="ne-vse-fayly-v-lib-odinakovo-bibliotechny">    <code>lib</code>  </h2><br>
<p>    (    ,     B,   spring fat jar),     ,  ,      .     ?</p><br>
<p>     :       ,          .      jar- maven' ( gradle'   ,   ).          (, ,   ),      .</p><br>
<p>  <code>lib</code>  2 ,        .    fat jar':</p><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-built_in">set</span> -e<font></font>
<font></font>
path_to_jar=<span class="hljs-variable">$1</span>
<span class="hljs-built_in">shift</span>                 <span class="hljs-comment">#(1)</span>
app_modules=$*        <span class="hljs-comment">#(2)</span><font></font>
<font></font>
dir=$(dirname <span class="hljs-string">"<span class="hljs-variable">${path_to_jar}</span>"</span>)<font></font>
jar_name=$(basename <span class="hljs-string">"<span class="hljs-variable">${path_to_jar}</span>"</span>)<font></font>
<font></font>
mkdir -p <span class="hljs-string">"<span class="hljs-variable">${dir}</span>/docker-dist"</span> &amp;&amp; <span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">${dir}</span>/docker-dist"</span><font></font>
<font></font>
jar -xf ../<span class="hljs-string">"<span class="hljs-variable">${jar_name}</span>"</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">${app_modules}</span>"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">#(3)</span><font></font>
<font></font>
mkdir app-lib<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$app_modules</span>; <span class="hljs-keyword">do</span>
mv <span class="hljs-string">"BOOT-INF/lib/<span class="hljs-variable">$i</span>"</span>* app-lib    <span class="hljs-comment">#(4)</span>
<span class="hljs-keyword">done</span>
<span class="hljs-keyword">fi</span></code></pre><br>
<p>        (. 1  2).     (3),        ,    (4)   .</p><br>
<p> Dockerfile'     .  <code>shared-module</code>   <code>1.0-SNAPSHOT</code></p><br>
<pre><code class="plaintext hljs">FROM openjdk:8-jdk-alpine as build<font></font>
<font></font>
COPY target/demo.jar /wd/app.jar<font></font>
RUN prepare_for_docker /wd/app.jar shared-module-1.0<font></font>
<font></font>
FROM openjdk:8-jdk-alpine<font></font>
<font></font>
COPY --from=build /wd/docker-dist/BOOT-INF/lib /app/lib<font></font>
COPY --from=build /wd/docker-dist/app-lib /app/lib<font></font>
COPY --from=build /wd/docker-dist/META-INF /app/META-INF<font></font>
COPY --from=build /wd/docker-dist/BOOT-INF/classes /app<font></font>
<font></font>
ENTRYPOINT ["java","-cp","app:app/lib/*","com.example.demo.DemoApplication"]</code></pre><br>
<h2 id="zapuskaem-na-ci-servere">  CI-</h2><br>
<p>  ,        CI-     ,    ,     :     ,        .</p><br>
<p>     — docker cache,         (        CI-).  ,       ,             .     ,     <code>--no-cache</code>,    ,       .         ,       .</p><br>
<p><img src="https://habrastorage.org/webt/k6/v0/ea/k6v0eaq02yvlokvcopiwp3fkwdm.png" alt="適切なキャッシュがなければ、異なるレイヤーができます"></p><br>
<p>    :</p><br>
<ol>
<li>  CI-     (  Circle CI <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>       )</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>     </li>
<li>       (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>--cache-from</code></a>)</li>
</ol><br>
<p>   ,         .    -,            .    ,    , ,      .    ,    ,    pull  .</p><br>
<p>       :</p><br>
<pre><code class="bash hljs"><span class="hljs-built_in">set</span> -e<font></font>
<font></font>
version=...<font></font>
<span class="hljs-comment">#     </span>
docker pull registy.example.com/my-image:latest || <span class="hljs-literal">true</span><font></font>
<font></font>
<span class="hljs-comment">#        </span>
docker build -t registry.example.com/my-image:<span class="hljs-variable">$version</span> --cache-from registry.example.com/my-image:latest .<font></font>
<font></font>
<span class="hljs-comment">#   registry    latest</span>
docker tag registry.example.com/my-image:<span class="hljs-variable">$version</span> registry.example.com/my-image:latest<font></font>
docker push registry.example.com/my-image:<span class="hljs-variable">$version</span>
docker push registry.example.com/my-image:latest</code></pre><br>
<p>        ,   ,                  id  vcs.</p><br>
<p>      CI       .</p><br>
<h1 id="itogo"></h1><br>
<p>   ,            CD .           .  ,         70-  (  60-         ).        ()   ()</p><br>
<p><img src="https://habrastorage.org/webt/ja/dj/en/jadjennx5loozk5x7iz_nxrct1o.png"></p><br>
<p>      ,    .            .</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この手法は、単一のイメージのサイズを削減することを目的とした他のアプローチ（高山およびその他の軽量の基本イメージ、アプリケーションのカスタムランタイム）と完全に互換性があることに注意したい。</font><font style="vertical-align: inherit;">主なことは、キャッシングに関してイメージを組み立てるための一般的なルールに従い、結果が再現可能であることを確認することです。</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458244/index.html">公衆Wi-Fiネットワークを安全に使用するために知っておくべきことの無限でとんでもないリスト</a></li>
<li><a href="../ja458246/index.html">人生の偶然の偶然、またはトラクターの工場でケーキが提示されたことが判明した方法</a></li>
<li><a href="../ja458250/index.html">最小のBTRFS</a></li>
<li><a href="../ja458252/index.html">超長電波望遠鏡の数学モデル</a></li>
<li><a href="../ja458256/index.html">洗脳の時間じゃないですか？</a></li>
<li><a href="../ja458262/index.html">オンライン会議室デザイナー-最適なビデオ会議ソリューションの選択</a></li>
<li><a href="../ja458264/index.html">自己文書化コードの10の原則</a></li>
<li><a href="../ja458268/index.html">自動呼吸セグメンテーション</a></li>
<li><a href="../ja458270/index.html">どこからともなく、誰にも責められることのないエラーについて：責任の塗りつけの現象</a></li>
<li><a href="../ja458272/index.html">やった！旅行者のための-一つのホームプロジェクトの物語</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>