<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>โ๏ธ ๐ฆ ๐ง๐ฟโ๐คโ๐ง๐ผ DBA: ุณุนูุงู ูุฑุงุก ุงูุฃููุงู ุงูุทุงุฆุฑุฉ ๐ฉ๐ฟโ๐ ๐ช๐ฟ ๐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูู ููุงู ุณุงุจู ุ ุญูุซ ุชุญุฏุซุช ุนู ูุฑุงูุจุฉ ูุงุนุฏุฉ ุจูุงูุงุช PostgreSQL ุ ูุงู ููุงู ูุซู ูุฐู ุงูุนุจุงุฑุฉ:
 ุชููู wait- ุงูุชุทุจูู "ุงุณุชุฑุงุญ" ุนูู ุฃููุงู ุดุฎุต ูุง . ุฅุฐุง ูุงูุช ูุฐู ุญุง...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: ุณุนูุงู ูุฑุงุก ุงูุฃููุงู ุงูุทุงุฆุฑุฉ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/503680/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ููุงู ุณุงุจู ุ ุญูุซ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชุญุฏุซุช ุนู ูุฑุงูุจุฉ ูุงุนุฏุฉ ุจูุงูุงุช PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุ ูุงู ููุงู ูุซู ูุฐู ุงูุนุจุงุฑุฉ:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชููู </font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- ุงูุชุทุจูู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ุงุณุชุฑุงุญ" ุนูู ุฃููุงู</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุดุฎุต ูุง </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">ุฅุฐุง ูุงูุช ูุฐู ุญุงูุฉ ุดุงุฐุฉ ููุฑุฉ ูุงุญุฏุฉ - ููู ููุงุณุจุฉ ูููู ุงูุณุจุจ ุงูุฃุตูู.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุนุชุจุฑ ูุฐุง ุงููููู ูู ุฃูุซุฑ ุงูุฃูุถุงุน ุบูุฑ ุงูุณุงุฑุฉ ุจุงููุณุจุฉ ูู DBA:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูููููุฉ ุงูุฃููู ุ ุงููุงุนุฏุฉ ุชุนูู</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุง ูุชู ุงุณุชููุงุฏ ููุงุฑุฏ ุงูุฎุงุฏู</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... ููู ุจุนุถ ุงูุทูุจุงุช "ุชุจุทุฆ"</font></font></li>
</ul><img src="https://habrastorage.org/webt/jy/wa/sk/jywaskrftah-9f7d9xwp3jvkn_q.png" align="right"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฅู ูุฑุต </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงุตุทูุงุฏ ุงูุฃููุงู "ูู ุงูููุช ุงูุญุงูู"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุถุฆููุฉ ููุบุงูุฉ ุ ููููู ุฃู ุชุณุชูุฑ ูุจุถุน ุซูุงูู ููุท ุ ูููููุง ุชุคุฏู ุฅูู ุชูุงูู ููุช ุงูุชูููุฐ ุงููุฎุทุท ูุนุดุฑุงุช ุงููุฑุงุช. </font><font style="vertical-align: inherit;">ููููู ูุง ุชุฑูุฏ ุงูุฌููุณ ูุงูุชูุงุท ูุง ูุญุฏุซ ุนุจุฑ ุงูุฅูุชุฑูุช ุ ูููู ูู ุฌู ูุฑูุญ ููุนุฑูุฉ ุจุนุฏ </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃู ูู ุงููุทูุฑูู ูุนุงูุจูู</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุง ูู ุงููุดููุฉ ุจุงูุถุจุท - ูู ุ ููุน ูู ูุจุณุจุจ ุฃู ูู ูุตุงุฏุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฏุฎูุช ูู ุงูุตุฑุงุน. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููู ูููุ </font><font style="vertical-align: inherit;">ูู ุงููุงูุน ุ ุนูู ุงููููุถ ูู ุงูุทูุจ ูุน ุฎุทุชู ุ ูุงูุชู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชุณูุญ ูู ุจููู ุชูุงุตูู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูููุงุฑุฏ ุงูุชู ุงุณุชุบุฑูุชูุง </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุฏุฉ ุงุณุชุบุฑุงููุง ุ ูุง ูุชุฑู ุงูููู</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุซู ูุฐู </font><b><font style="vertical-align: inherit;">ุงูุขุซุงุฑ ุงููุงุถุญุฉ</font></b><font style="vertical-align: inherit;"> ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุง ูู ูุชู ุฅุฏุฎุงู ุณุฌู ูุตูุฑ: </font><font style="vertical-align: inherit;">ููู ุฏุนููุง ูุญุงูู ุงูุฅูุณุงู ุจูุง!</font></font><code><blockquote>process ... <b>still waiting for</b> ...</blockquote></code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุจุถ ุนูู ุงูููู ูู ุงูุณุฌู</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููู ุญุชู ูุธูุฑ ูุฐุง ุงูุฎุท ุนูู ุงูุฃูู ูู ุงูุณุฌู ุ ูุฌุจ ุชูููู ุงูุฎุงุฏู ุจุดูู ุตุญูุญ:</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">log_lock_waits</a> = <b>'on'</b></code></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... ููุถุน ุญุฏ ุฃุฏูู ูุชุญููููุง:</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">deadlock_timeout</a> = <b>'100ms'</b></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุนูุฏ ุชูููู </font></font><code>log_lock_waits</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุนููุฉ ุ ุชุญุฏุฏ ูุฐู ุงููุนููุฉ ุฃูุถูุง ุจุนุฏ ุฃู ููุช ุณุชุชู ูุชุงุจุฉ ุงูุฑุณุงุฆู ุงููุชุนููุฉ ุจุงูุชุธุงุฑ ุงูุญุธุฑ ุฅูู ุณุฌู ุงูุฎุงุฏู. </font><font style="vertical-align: inherit;">ุฅุฐุง ููุช ุชุญุงูู ุงูุชุญููู ูู ุงูุชุฃุฎูุฑุงุช ุงูุชู ุชุณุจุจูุง ุงูุฃููุงู ุ ููู ุงูููุทูู ุชูููููุง ููุงุฑูุฉ ุจุงููููุฉ ุงููุนุชุงุฏุฉ </font></font><code>deadlock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณูุชูุฒู ูู ุทุฑูู ูุณุฏูุฏ ููุณ ูุฏูู ุงูููุช "ููู ุงูุงุฑุชุจุงุท" ุฎูุงู ูุฐุง ุงูููุช. </font><font style="vertical-align: inherit;">ูุฅููู ุงูุฃููุงู "ุงููุนุชุงุฏุฉ" - ุงููููุงุฉ ูู ุงูุณุฌู ุนู ุทุฑูู ุนุฏุฉ ุฅุฏุฎุงูุงุช:</font></font><br>
<blockquote><i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> still waiting for ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 100.047 ms</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest DETAIL: <b>Process holding the lock: 38154. Wait queue: <font color="red">38162</font>.</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest CONTEXT: SQL statement <code>"SELECT pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer )"<br>
 PL/pgSQL function inline_code_block line 2 at PERFORM</code><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest STATEMENT: <code> DO $$ BEGIN<br>
 PERFORM pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer );<br>
 EXCEPTION<br>
 WHEN query_canceled THEN RETURN;<br>
 END; $$;</code><br>
โฆ<br>
<br>
<i>2019-03-27 00:06:46.077</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> <font color="green">acquired</font> ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 150.741 ms</b></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุถุญ ูุฐุง ุงููุซุงู ุฃูู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุงู</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูุฏููุง </font><b><font style="vertical-align: inherit;">50 ูููู ุซุงููุฉ ููุท</font></b><font style="vertical-align: inherit;"> ูู ูุญุธุฉ ุธููุฑ ุงูููู ูู ุงูุณุฌู ุญุชู ูุญุธุฉ ุญูู. </font><font style="vertical-align: inherit;">ููุท ูู ูุฐุง ุงููุงุตู ุงูุฒููู ูููููุง ุงูุญุตูู ุนูู ุจุนุถ ุงููุนูููุงุช ุญููู ุนูู ุงูุฃูู ุ ููููุง ุงุณุชุทุนูุง ุงูููุงู ุจุฐูู ุจุดูู ุฃุณุฑุน ุ ูููุง ุฃููููุง ุชุญููู ุงููุฒูุฏ ูู ุงูุฃููุงู. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุง ุฃูู ุงููุนูููุงุช ุจุงููุณุจุฉ ููุง ูู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PID ููุนูููุฉ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูุชู ุชูุชุธุฑ ุงูููู. </font><font style="vertical-align: inherit;">ูููููุง ุฃู ููุงุฑู ุงููุนูููุงุช ุจูู ุงูุณุฌู ูุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช. </font><font style="vertical-align: inherit;">ููู ุงูููุช ููุณู ููุนุฑูุฉ ูุฏู ูุดููุฉ ููู ูุนูู - ุฃู ูู "ุนูู". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููููุงู ุจุฐูู ุ ูุญุชุงุฌ ููุท ุฅูู ุงุซููู ูู RegExp ูู </font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุณุฌู </font><font style="vertical-align: inherit;">ุงููุญุชูู </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> RE_lock_detect = <span class="hljs-regexp">/^process (\d+) still waiting for (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> RE_lock_acquire = <span class="hljs-regexp">/^process (\d+) acquired (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//   </span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุตู ุฅูู ุงูุณุฌู</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงููุงูุน ุ ูุจูู ููููุงู - ูุฃุฎุฐ ุงูุณุฌู ุ ูุชุนูู ููููุฉ ูุฑุงูุจุชู ูุงูุงุณุชุฌุงุจุฉ ููููุง ูุฐูู. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุฏููุง ุจุงููุนู ูู ุดูุก ููุฐุง - ูุญูู ุณุฌู ุนุจุฑ ุงูุฅูุชุฑูุช ูุงุชุตุงู ูุงุนุฏุฉ ุจูุงูุงุช ุชู ุชูุดูุทู ูุณุจููุง ุ ูุงูุฐู ุชุญุฏุซุช ุนูู ูู ููุงูุฉ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุญูู ูุธุงู ูุฑุงูุจุฉ PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<img src="https://habrastorage.org/webt/tc/pv/oq/tcpvoqmeliadskfh2rpnffg7uwo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููู ุฅุฐุง ูู ููู ูุฏูู ุฃู ูุธุงู ูุดุงุจู ุชู ูุดุฑู ุ ููุง ุจุฃุณ ุ ุณููุนู ูู ุดูุก "ุงูุญู ูู ูุญุฏุฉ ุงูุชุญูู"! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฅุฐุง ูุงู ุงูุฅุตุฏุงุฑ ุงููุซุจุช ูู PostgreSQL 10 ูุงูุฅุตุฏุงุฑุงุช ุงูุฃุญุฏุซ ูุญุธูุธูุง ุ ูุฃูู ุธูุฑุช ูุธููุฉ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_current_logfile ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุ ูุงูุชู ุชุนุทู ุตุฑุงุญุฉ ุงุณู ููู ุงูุณุฌู ุงูุญุงูู. </font><font style="vertical-align: inherit;">ุณูููู ุงูุญุตูู ุนููู ูู ูุญุฏุฉ ุงูุชุญูู ุณููุงู ุจูุง ูููู:</font></font><br>
<br>
<pre><code class="bash hljs">psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) &lt;&gt; '/' THEN current_setting('data_directory') ELSE '' END || '/' || pg_current_logfile()"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฅุฐุง ูุงูุช ุงููุณุฎุฉ ุฃุตุบุฑ ูุฌุฃุฉ - ูุณูุธูุฑ ูู ุดูุก ุ ูููู ุฃูุซุฑ ุชุนููุฏูุง:</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span></code></pre><br><font style="vertical-align: inherit;"></font><code>tail -f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุญุตู ุนูู </font><font style="vertical-align: inherit;">
ุงุณู ุงูููู ุงููุงูู ุ ุงูุฐู ูุนุทูู </font><font style="vertical-align: inherit;">ูุณูุชููู ุงููุธูุฑ ููุงู </font></font><code>'still waiting for'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุญุณููุง ุ ุจูุฌุฑุฏ ุธููุฑ ุดูุก ูู ูุฐุง ุงูููุถูุน ุ ูุณููู ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุทูุจ ุชุญููู</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุฃุณู ุ ููุณ ุงููุฏู ูู ุงูุญุธุฑ ูู ุงูุณุฌู ุฏุงุฆููุง ูู ุงูููุฑุฏ ุงูุฐู ุชุณุจุจ ูู ุงูุชุนุงุฑุถ. </font><font style="vertical-align: inherit;">ุนูู ุณุจูู ุงููุซุงู ุ ุฅุฐุง ุญุงููุช ุฅูุดุงุก ููุฑุณ ูุญูู ููุณ ุงูุงุณู ุจุงูุชูุงุฒู ุ ููู ูููู ููุงู ุดูุก ูุซู ูุฐุง ูู ุงูุณุฌู </font></font><code>still waiting for ExclusiveLock on transaction 12345</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุฐูู ุ ุณูููู ุนูููุง </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุฒุงูุฉ ุญุงูุฉ ุฌููุน ุงูุฃููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ููุนูููุฉ ุงูุชู ุชูููุง. </font><font style="vertical-align: inherit;">ูุงููุนูููุงุช ููุท ุญูู ุฒูุฌ ูู ุงูุนูููุงุช (ุงูุฐูู ูุถุนูู ุงูููู / ูู ูุชููุน ุฐูู) ููุณุช ูุงููุฉ ุ ูุฃูู ุบุงูุจูุง ูุง ุชููู ููุงู "ุณูุณูุฉ" ูู ุงูุชููุนุงุช ุจุดุฃู ุงูููุงุฑุฏ ุงููุฎุชููุฉ ุจูู ุงููุนุงููุงุช:</font></font><br>
<br>
<pre><code class="plaintext hljs">tx1 [resA] -&gt; tx2 [resA]<font></font>
tx2 [resB] -&gt; tx3 [resB]<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูููุงุณูููุฉ: "ุฌุฏ ุงูููุช ุ ุฌุฏุฉ ุงูุฌุฏ ุ ุญููุฏุฉ ุงูุฌุฏ ุ ..." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุฐูู ุ ุณููุชุจ ุทูุจูุง ูุฎุจุฑูุง ุจุงูุถุจุท ูู ุฃุตุจุญ ุงูุณุจุจ ุงูุฌุฐุฑู ูููุดุงูู ุนูู ุทูู ุณูุณูุฉ ุงูุฃููุงู ุจุฃููููุง ูู PID ูุญุฏุฏ:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> lm <span class="hljs-keyword">AS</span> (
<span class="hljs-comment">-- lock modes</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    rn<font></font>
  , <span class="hljs-keyword">CASE</span>
      <span class="hljs-keyword">WHEN</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">THEN</span> row_number() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rn)
    <span class="hljs-keyword">END</span> rx<font></font>
  , lm || <span class="hljs-string">'Lock'</span> lm
  <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
      row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
    , lm<font></font>
    <span class="hljs-keyword">FROM</span>
      <span class="hljs-keyword">unnest</span>(
        <span class="hljs-built_in">ARRAY</span>[
          <span class="hljs-string">'AccessShare'</span>
        , <span class="hljs-string">'RowShare'</span>
        , <span class="hljs-string">'RowExclusive'</span>
        , <span class="hljs-string">'ShareUpdateExclusive'</span>
        , <span class="hljs-string">'Share'</span>
        , <span class="hljs-string">'ShareRowExclusive'</span>
        , <span class="hljs-string">'Exclusive'</span>
        , <span class="hljs-string">'AccessExclusive'</span><font></font>
        ]<font></font>
      ) T(lm)<font></font>
  ) T<font></font>
)<font></font>
<span class="hljs-comment">-- lock types</span>
, lt <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
  , lt<font></font>
  <span class="hljs-keyword">FROM</span>
    <span class="hljs-keyword">unnest</span>(
      <span class="hljs-built_in">ARRAY</span>[
        <span class="hljs-string">'relation'</span>
      , <span class="hljs-string">'extend'</span>
      , <span class="hljs-string">'page'</span>
      , <span class="hljs-string">'tuple'</span>
      , <span class="hljs-string">'transactionid'</span>
      , <span class="hljs-string">'virtualxid'</span>
      , <span class="hljs-string">'object'</span>
      , <span class="hljs-string">'userlock'</span>
      , <span class="hljs-string">'advisory'</span>
      , <span class="hljs-string">''</span><font></font>
      ]<font></font>
    ) T(lt)<font></font>
)<font></font>
<span class="hljs-comment">-- lock modes conflicts</span>
, lmx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    lr.rn lrn<font></font>
  , lr.rx lrx<font></font>
  , lr.lm lr<font></font>
  , ld.rn ldn<font></font>
  , ld.rx ldx<font></font>
  , ld.lm ld<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    lm lr<font></font>
  <span class="hljs-keyword">JOIN</span>
    lm ld <span class="hljs-keyword">ON</span>
      ld.rx &gt; (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rx) <span class="hljs-keyword">FROM</span> lm) - lr.rx <span class="hljs-keyword">OR</span><font></font>
      (<font></font>
        (lr.rx = ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
        (lr.rx, ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span>
        ld.rn &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rn) <span class="hljs-keyword">FROM</span> lm) - lr.rn<font></font>
      )<font></font>
)<font></font>
<span class="hljs-comment">-- locked targets/pids</span>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
    (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) target<font></font>
  , ld.pid  ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid  lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks ld<font></font>
  <span class="hljs-keyword">JOIN</span>
    pg_locks lr <span class="hljs-keyword">ON</span>
      lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
      (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (ld.locktype, ld.database, ld.relation, ld.page, ld.tuple, ld.virtualxid, ld.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, ld.classid, ld.objid, ld.objsubid) <span class="hljs-keyword">AND</span>
      (lr.granted, ld.granted) = (<span class="hljs-literal">TRUE</span>, <span class="hljs-literal">FALSE</span>)
  <span class="hljs-keyword">JOIN</span>
    lmx <span class="hljs-keyword">ON</span><font></font>
      (lmx.lr, lmx.ld) = (lr.mode, ld.mode)<font></font>
  <span class="hljs-keyword">WHERE</span>
    (ld.pid, ld.granted) = ($<span class="hljs-number">1</span>::<span class="hljs-built_in">integer</span>, <span class="hljs-literal">FALSE</span>) <span class="hljs-comment">-- PID</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span>          <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span>         <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span>    <span class="hljs-keyword">THEN</span> regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-string">"locked"</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, (lc.locktype, lc.database, lc.relation, lc.page, lc.tuple, lc.virtualxid, lc.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lc.classid, lc.objid, lc.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-string">"conflict"</span>
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span>
  pg_locks lc <span class="hljs-keyword">ON</span>
    lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุดููุฉ ุฑูู 1 - ุจุฏุงูุฉ ุจุทูุฆุฉ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุง ุชุฑู ูู ุงููุซุงู ูู ุงูุณุฌู ุ ุจุฌูุงุฑ ุงูุณุทุฑ ุงูุฐู ูุดูุฑ ุฅูู ุญุฏูุซ ููู ( </font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ุ ููุงู 3 ุฎุทูุท ุฃุฎุฑู ( </font></font><code>DETAIL, CONTEXT, STATEMENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) ุชุดูุฑ ุฅูู ูุนูููุงุช ููุณุนุฉ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฃููุงู ุ ุงูุชุธุฑูุง ุชุดููู "ุญุฒูุฉ" ูุงููุฉ ูู ุฌููุน ุงูุฅุฏุฎุงูุงุช ุงูุฃุฑุจุนุฉ ูุจุนุฏ ุฐูู ุงูุชูููุง ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. </font><font style="vertical-align: inherit;">ูููู ูุง ูููููุง ุฅููุงู ุชุดููู ุงูุญุฒูุฉ ุฅูุง ุนูุฏ ูุตูู ุงูุณุฌู ุงูุชุงูู (ุงูุฎุงูุณ ุจุงููุนู!) ุ ูุน ุชูุงุตูู ุนูููุฉ ุฃุฎุฑู ุ ุฃู ุนูุฏ ุงูุชูุงุก ุงููููุฉ. </font><font style="vertical-align: inherit;">ูู ุงููุงุถุญ ุฃู ููุง ุงูุฎูุงุฑูู ูุซูุฑุงู ุงูุชุธุงุฑูุง ุบูุฑ ุถุฑูุฑู. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุชุฎูุต ูู ูุฐู ุงูุชุฃุฎูุฑุงุช ุ ูููุง ุจุงูุชุจุฏูู ุฅูู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุนุงูุฌุฉ ุฏูู ุณุฌูุงุช</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูููู. </font><font style="vertical-align: inherit;">ุฃู ุ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุชูู</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุงูุขู </font><b><font style="vertical-align: inherit;">ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุณุชูุฏูุฉ</font></b><font style="vertical-align: inherit;"> ุจูุฌุฑุฏ ูุฑุฒ ุงูุณุฌู ุงูุฃูู ุ ูุฃุฏุฑููุง ุฃูู ุงูููู ุงูููุตูู ููุงู.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุดููุฉ ุฑูู 2 - ุทูุจ ุจุทูุก</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููู ูุน ุฐูู ุ ูู ููู ูุฏู ุจุนุถ ุงูุฃููุงู ููุช ููุชุญููู. </font><font style="vertical-align: inherit;">ุจุฏุฃูุง ูู ุงูุชุนูู - ููุฌุฏูุง ุฃูู ูู ุจุนุถ ุงูุฎูุงุฏู ูุชู ุชูููุฐ ุทูุจ ุงูุชุญููู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุฎุงุต ุจูุง ููุฏุฉ 15-20 ูููู ุซุงููุฉ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงุชุถุญ ุฃู ุงูุณุจุจ ุดุงุฆุน - ุฅุฌูุงูู ุนุฏุฏ ุงูุฃููุงู ุงููุดุทุฉ ุนูู ุงููุงุนุฏุฉ ุ ูุงูุชู ุชุตู ุฅูู ุนุฏุฉ ุขูุงู:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/sp/ex/lkspexwtgdfrqhmh3siwsnx_s30.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุง ูุฌุจ ููุงุญุธุฉ ุฃู ุงูุฃููุงู ูู PostgreSQL ููุณุช "ูุฎุฒูุฉ" ูู ุฃู ููุงู ุ ูููู ูุชู ุชูุฏูููุง ููุท ูู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุทุฑููุฉ ุนุฑุถ ุงููุธุงู pg_locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุ ููู ุงูุนูุงุณ ูุจุงุดุฑ ูููุธููุฉ </font></font><code>pg_lock_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">ููู ุทูุจูุง </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุฑุฃ ููู ุซูุงุซ ูุฑุงุช</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">ูู ูุฐู ุงูุฃุซูุงุก ุ ููุฑุฃ ูุฐู ุงูุขูุงู ูู ุญุงูุงุช ุงูุฃููุงู ุ ููุชุฌุงูู ุชูู ุงูุชู ูุง ุชุชุนูู ุจู PID ุงูุฎุงุต ุจูุง ุ ูุชููู ุงูููู ููุณู ูู "ุญู" ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุงู ุงูุญู ูู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ุชุฌุณูุฏ" ุญุงูุฉ pg_locks ูู CTE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ุจุนุฏ ุฐูู ููููู ุชุดุบููู ุนุฏุฉ ูุฑุงุช ููุง ุชุดุงุก ุ ุฅูู ุจุงููุนู ูู ูุชุบูุฑ. </font><font style="vertical-align: inherit;">ุนูุงูุฉ ุนูู ุฐูู ุ ุจุนุฏ ุงูุฌููุณ ุนูู ุงูุฎูุงุฑุฒููุฉ ุ ูุงู ูู ุงููููู ุชูููู ูู ุดูุก ุฅูู ุงุซููู ููุท ูู ุนูููุงุช ุงููุณุญ.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฏููุงููุงุช ููุฑุทุฉ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุญุชู ูู ูุธุฑุฉ ูุงุญุตุฉ ููููุง ูู ุงูุงุณุชุนูุงู ุฃุนูุงูุ ูููููุง ุฃู ูุฑู ุฃู CTE </font></font><code>lm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ู </font></font><code>lmx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุณ ุจุฃู ุญุงู ูู ุงูุฃุญูุงู ูุฑุชุจุทุฉ ุงูุจูุงูุงุชุ ูููู ุจุจุณุงุทุฉ ุญุณุงุจ ุฏุงุฆูุง ููุณ "ุซุงุจุช" ุชุนุฑูู ูุตูููุฉ ูู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูุตุฑุงุน ุจูู ูุณุงุฆู ููุน</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">ูุฐุง ุฏุนูุง ูุถุนูุง ูุฌูุฏุฉ </font></font><code>VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุดููุฉ ุฑูู 3 - ุงูุฌูุฑุงู</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููู ุฌุฒุกูุง ูู ุงูุฃููุงู ูุงู ูุง ูุฒุงู ูุชู ุชุฎุทูู. ุนุงุฏุฉ ูุง ูุญุฏุซ ูุฐุง ููููุง ูููุฎุทุท ุงูุชุงูู - ูุงู ุดุฎุต ูุง ุจุญุธุฑ ููุฑุฏ ุดุงุฆุน ุ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุงุฌูุชู ุนุฏุฉ ุนูููุงุช</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุจุณุฑุนุฉ ูุจุณุฑุนุฉ ุฃู ุนูู ุทูู ุณูุณูุฉ ุฃุฎุฑู </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุชูุฌุฉ ูุฐูู ุ ุงูุชูุทูุง PID ุงูุฃูู ุ ูุฐูุจูุง ุฅูู ุงููุงุนุฏุฉ ุงููุณุชูุฏูุฉ (ูููู ูุง ููุฑุท ูู ุงูุชุญููู ุ ูุญุชูุธ ุจุงุชุตุงู ูุงุญุฏ ููุท) ุ ููููุง ุจุงูุชุญููู ุ ูุนุงุฏูุง ุจุงููุชูุฌุฉ ุ ูุฃุฎุฐูุง PID ุงูุชุงูู ... ููู ุงูุญูุงุฉ ูุง ุชุณุชุญู ุฐูู ุนูู ุงููุงุนุฏุฉ ุ ูููู PID # 2 ุฐูุจ ุจุงููุนู! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงููุงูุน ุ ููุงุฐุง ูุญุชุงุฌ ุฅูู ุงูุฐูุงุจ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููู PID ุจุดูู ูููุตู ุ ุฅุฐุง ูุง ุฒููุง ูููู ุจุชุตููุฉ ุงูุฃููุงู ูู ุงููุงุฆูุฉ ุงูุนุงูุฉ ูู ุงูุทูุจุ ุฏุนูุง ูุฃุฎุฐ ุนูู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงูููุฑ ุงููุงุฆูุฉ ุงููุงููุฉ ููุนูููุงุช ุงููุชุถุงุฑุจุฉ ูุจุงุดุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ูููุฒุน ุฃููุงููุง ุนุจุฑ ุฌููุน ูุนุฑููุงุช PID ุงูุชู ุณูุทุช ุฃุซูุงุก ุชูููุฐ ุงูุทูุจ:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> lm(ld, lr) <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'AccessShareLock'</span>, <span class="hljs-string">'{AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowShareLock'</span>, <span class="hljs-string">'{ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowExclusiveLock'</span>, <span class="hljs-string">'{ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareUpdateExclusiveLock'</span>, <span class="hljs-string">'{ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareRowExclusiveLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ExclusiveLock'</span>, <span class="hljs-string">'{RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'AccessExclusiveLock'</span>, <span class="hljs-string">'{AccessShareLock,RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
)<font></font>
, locks <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    (<font></font>
      locktype<font></font>
    , <span class="hljs-keyword">database</span><font></font>
    , relation<font></font>
    , page<font></font>
    , tuple<font></font>
    , virtualxid<font></font>
    , transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span><font></font>
    , classid<font></font>
    , objid<font></font>
    , objsubid<font></font>
    ) target<font></font>
  , *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks<font></font>
)<font></font>
, ld <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> granted<font></font>
)<font></font>
, lr <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    target::<span class="hljs-built_in">text</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
        target::<span class="hljs-built_in">text</span>
      <span class="hljs-keyword">FROM</span><font></font>
        ld<font></font>
    )) <span class="hljs-keyword">AND</span><font></font>
    granted<font></font>
)<font></font>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span><font></font>
    lr.target<font></font>
  , ld.pid ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    ld<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    lr<font></font>
      <span class="hljs-keyword">ON</span> lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
        lr.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> ld.target<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span> <span class="hljs-keyword">THEN</span>
      regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-keyword">as</span> <span class="hljs-keyword">locked</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, lc.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-keyword">as</span> conflict
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span><font></font>
  locks lc<font></font>
    <span class="hljs-keyword">ON</span> lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูุขู ูุฏููุง ุงูููุช ูุชุญููู ุญุชู ุงูุฃููุงู ุงูููุฌูุฏุฉ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุท 1-2 ูููู ุซุงููุฉ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุจุนุฏ ุงูุฏุฎูู ุฅูู ุงูุณุฌู.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุญูู ูุฐุง</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงููุงูุน ุ ููุงุฐุง ุญุงูููุง ุทูููุงุ </font><font style="vertical-align: inherit;">ููุงุฐุง ูุนุทููุง ูุฐุง ูุชูุฌุฉุ ..</font></font><br>
<br>
<pre><code class="plaintext hljs">type     | target                  | locked | pid    | mode        | granted | conflict<font></font>
---------------------------------------------------------------------------------------<font></font>
relation | {225388639}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {423576026}             | f      | 216547 | AccessShare | t       | f<font></font>
advisory | {225386226,194303167,2} | t      |  24964 | Exclusive   | f       | t<font></font>
relation | {341894815}             | t      |  24964 | AccessShare | t       | f<font></font>
relation | {416441672}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {225964322}             | f      | 216547 | AccessShare | t       | f<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ูุฐู ุงูููุญุฉ ุ ุชููู ุงูููู </font></font><code>target</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฐุงุช ุงูููุน </font><font style="vertical-align: inherit;">ูููุฏุฉ ููุง </font></font><code>relation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุ ูุฃู ูู ูููุฉ ูุซู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OID ูุฌุฏูู ุฃู ููุฑุณ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">ุงูุขู ูู ูุชุจู ุณูู ุงููููู ุฌุฏูุง - ููุนุฑูุฉ ููููุฉ ุงุณุชุฌูุงุจ ูุงุนุฏุฉ ุจูุงูุงุช OID ุงูุชู ูุง ุชุฒุงู ุบูุฑ ูุนุฑููุฉ ููุง ุ ูู ุฃุฌู ุชุฑุฌูุชูุง ุฅูู ุดูู ูููู ูุฑุงุกุชู ุจูุงุณุทุฉ ุงูุฅูุณุงู:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> $<span class="hljs-number">1</span>::<span class="hljs-keyword">oid</span>::regclass;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูุขู ุ ุจูุนุฑูุฉ "ุงููุตูููุฉ" ุงููุงููุฉ ููุฃููุงู ูุฌููุน ุงูุฃุดูุงุก ุงูุชู ูุฑุถุช ุนูููุง ูู ูุนุงููุฉ ุ ูููููุง ุฃู </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุณุชูุชุฌ "ูุง ุญุฏุซ ุนูู ุงูุฅุทูุงู"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ููุง ูู ุงูููุฑุฏ ุงูุฐู ุชุณุจุจ ูู ุงูุตุฑุงุน ุ ุญุชู ูู ุชู ุญุธุฑ ุงูุทูุจ ุ ูู ููู ูุนุฑู. </font><font style="vertical-align: inherit;">ูููู ุฃู ูุญุฏุซ ูุฐุง ุจุณูููุฉ ุ ุนูู ุณุจูู ุงููุซุงู ุ ุนูุฏูุง ูุง ูููู ููุช ุชูููุฐ ุทูุจ ุงูุญุธุฑ ุทููููุง ุจูุง ูููู ูููุตูู ุฅูู ุงูุณุฌู ุ ูููู ูุงูุช ุงููุนุงููุฉ ูุดุทุฉ ุจุนุฏ ุงูุชูุงููุง ูุฎููุช ูุดุงูู ููุชุฑุฉ ุทูููุฉ. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4m/4m/j7/4m4mj7nqgpeoxe13qoldzrmhhr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูููู ุนู ูุฐุง - ูู ููุงู ุขุฎุฑ.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ูุญุฏูุง"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ูุฐู ุงูุฃุซูุงุก ุ ุณูุฌูุน ุงููุณุฎุฉ ุงููุงููุฉ ูู "ุงููุฑุงูุจุฉ" ุ ูุงูุชู ุณุชุฒูู ุชููุงุฆููุง ุญุงูุฉ ุงูุฃููุงู ูุฃุฑุดูููุง ุจูุฌุฑุฏ ุธููุฑ ุดูุก ูุฑูุจ ูู ุงูุณุฌู:</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span> \<font></font>
  | xargs -l -I{} tail -f {} \<font></font>
  | stdbuf -o0 grep <span class="hljs-string">'still waiting for'</span> \<font></font>
  | xargs -l -I{} date <span class="hljs-string">'+%Y%m%d-%H%M%S.%N'</span> \<font></font>
  | xargs -l -I{} psql -U postgres postgres -f detect-lock.sql -o {}-lock.log<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุจุฌุงูุจ </font></font><code>detect-lock.sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุถุน ุงูุทูุจ ุงูุฃุฎูุฑ. </font><font style="vertical-align: inherit;">ุชุดุบูู - ูุงุญุตู ุนูู ูุฌููุนุฉ ูู ุงููููุงุช ูุน ุงููุญุชูู ุงููุทููุจ ูู ุงูุฏุงุฎู:</font></font><br>
<br>
<pre><code class="plaintext hljs"># cat 20200526-181433.331839375-lock.log<font></font>
     type      |     target     | locked |  pid   |     mode     | granted | conflict<font></font>
---------------+----------------+--------+--------+--------------+---------+----------<font></font>
 relation      | {279588430}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | t      | 136325 | RowExclusive | t       | f<font></font>
 virtualxid    | {110,12171420} | t      | 136325 | Exclusive    | t       | f<font></font>
 relation      | {279588430}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | f      |  39339 | RowExclusive | t       | f<font></font>
 virtualxid    | {360,11744113} | f      |  39339 | Exclusive    | t       | f<font></font>
 virtualxid    | {638,4806358}  | t      |  80553 | Exclusive    | t       | f<font></font>
 advisory      | {1,1,2}        | t      |  80553 | Exclusive    | f       | t<font></font>
 advisory      | {1,1,2}        | f      |  80258 | Exclusive    | t       | t<font></font>
 transactionid | {3852607686}   | t      | 136325 | Exclusive    | t       | f<font></font>
 extend        | {279588422}    | t      | 136325 | Exclusive    | f       | t<font></font>
 extend        | {279588422}    | f      |  39339 | Exclusive    | t       | t<font></font>
 transactionid | {3852607712}   | f      |  39339 | Exclusive    | t       | f<font></font>
(15 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุญุณููุง ุ ุฅุฐู - ุงุฌูุณ ูุญูู ...</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar503668/index.html">ุฏุงุฆุฑุฉ ูุฑุจุนุฉ: ุฏููู ูุฑุฆู</a></li>
<li><a href="../ar503670/index.html">ูู ูุชุจุงุทุฃ ูุธุงู ุงูุชุดุบูู Macุ - ุชุชุญูู ูุงุชุงูููุง ูู ุฃู ุฑูุฒ ุบูุฑ ูููุน ุนุจุฑ ุงูุฅูุชุฑูุช ุนูุฏ ุจุฏุก ุงูุชุดุบูู</a></li>
<li><a href="../ar503672/index.html">ูู ุฃู ุฌุงูุจ ุฃูุช: ุงุฏูุน ูุงุณุญุจ ูู ุชููุฆุฉ ุงูุญุงูุฉ ุงููุฑุบูุจุฉ</a></li>
<li><a href="../ar503676/index.html">ุซูุงุซุฉ ูุดุงุฑูุน ุงููููุณ ูููู ุงููููุณ ุงููุฎุฑ</a></li>
<li><a href="../ar503678/index.html">Vuex ููุณุฑ ุงูุชุบููู</a></li>
<li><a href="../ar503682/index.html">Snom Exchange ูู ุงูุฃูู ุฅูู ุงููุงุก</a></li>
<li><a href="../ar503688/index.html">ุฌููู ุณุจููุณูู: ูุงุฐุง ูุนูู ุฃู ุชููู ูุทูุฑ ุจุฑุงูุฌ (ููุฏูุฉ ูููุจุฑูุฌ ูููุทูุฑ)</a></li>
<li><a href="../ar503690/index.html">ุฃูุถู ููุงุฑุณุงุช Kubernetes. Kubernetes ุตูุฑ ุชุฑููุฉ ูุฌููุนุฉ ุงูุชููู</a></li>
<li><a href="../ar503696/index.html">ุชุณุชุนุฏ ููุญุฑุจ: ุนูุฏูุง ุญููุช ุฃุฌูุฒุฉ ุงูููุจููุชุฑ ุงูุชูุงุธุฑูุฉ ุงููููุงููููุฉ ุงูุจุญุฑ</a></li>
<li><a href="../ar503698/index.html">ุงููุญุงุณุจุฉ ุนู ุจุนุฏ - ููููุนุฉ ุชุฌุงุฑูุฉ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>