<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📨 👨🏿‍🍳 👩🏿‍🤝‍👩🏽 完璧なSAST。パーサー 🌉 📘 👞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="一連の記事では、専門家向けに設計された静的コード分析ツールを実装するための最適なアプローチについて説明しています。この作業の目的は、ツールの開発とサポート/変更の複雑さを最小限に抑えながら、ツールのパフォーマンスを最大化するためのアプローチ、モデル、およびテクニックです。この記事では、パーサーを高速...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>完璧なSAST。パーサー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487716/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一連の記事では、専門家向けに設計された静的コード分析ツールを実装するための最適なアプローチについて説明しています。</font><font style="vertical-align: inherit;">この作業の目的は、ツールの開発とサポート/変更の複雑さを最小限に抑えながら、ツールのパフォーマンスを最大化するためのアプローチ、モデル、およびテクニックです。</font><font style="vertical-align: inherit;">この記事では、パーサーを高速化してメモリ消費を削減する方法について説明します。</font><font style="vertical-align: inherit;">記事は、読者がTerrence Parrによって書かれたマニュアルを読むように構成されています。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ANTLRを最大限に使用する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ANTLRは、約1 kb〜10 kbの間で最適に機能します。大きなファイルは、このライブラリによって最大速度で解析されません。</font><font style="vertical-align: inherit;">また、大きなファイルのデバッグ作業はほとんど不可能になります。</font><font style="vertical-align: inherit;">パーサーの入力データを指定された制限内に維持する必要がある主な理由は、ANTLRの分岐予測アルゴリズムが積極的にスタックを使用するため、特定のルールを含む他の多くのルールを通じて1つのルールがそれ自体を呼び出すときに、文法内のサイクルを取り除く必要があるためですそのような接続のアクティブ化条件、例を考えてみましょう：</font></font><br>
<br>
<pre><code class="plaintext hljs">var f = fun a(b) { b = 10; return b; }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードは、次の文法で説明できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">start: stmt* EOF;<font></font>
stmt: varDecl | funDecl | expr ';' | 'return' expr ';';<font></font>
varDecl: 'var' id '=' expr;<font></font>
expr: id ('=' expr)? | number;<font></font>
funDecl: 'fun' id '(' id* ')' '{' stmt* '}'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
stmtがfunDeclルール内で呼び出されていることは簡単にわかります。これにより、実際のアプリケーションでは、最大のパフォーマンス、または機能するために100 kbのファイルに4 GBのRAMヒープが必要になるループが形成されますが、これは絶対に許容できない状況です。 。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この欠点を克服する1つの方法は、トークンの作成プロセスに特別な変更を加えることです。つまり、{}ブロックをトークンに畳み込み、後でこれらのトークンを新しいパーサーで処理して、折りたたまれたトークンが送信される入力に追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、ANTLRでlexerのorg.antlr.v4.runtime.Lexer＃nextTokenメソッドをオーバーライドし、畳み込み機能を実装できます。</font></font><br>
<br>
<pre><code class="scala hljs">  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">nextToken</span></span>(): <span class="hljs-type">Token</span> = <span class="hljs-keyword">super</span>.nextToken() <span class="hljs-keyword">match</span> {
      <span class="hljs-keyword">case</span> x: <span class="hljs-type">RScanToken</span> <span class="hljs-keyword">if</span> x.getType == foldOpen =&gt; buildFoldToken(x)
      <span class="hljs-keyword">case</span> x: <span class="hljs-type">Token</span> =&gt; x<font></font>
  }<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">buildFoldToken</span></span>(start: <span class="hljs-type">RScanToken</span>): <span class="hljs-type">RScanToken</span> = {
    <span class="hljs-keyword">val</span> (token, list) = createFoldBlockBody(<font></font>
      mutable.<span class="hljs-type">MutableList</span>[<span class="hljs-type">RScanToken</span>]()<font></font>
        ++ <span class="hljs-type">List</span>(start.asInstanceOf[<span class="hljs-type">RScanToken</span>])<font></font>
    )<font></font>
    <span class="hljs-keyword">val</span> result = <span class="hljs-keyword">new</span> <span class="hljs-type">RScanToken</span>(path, _tokenFactorySourcePair, foldBlock, <span class="hljs-type">Lexer</span>.<span class="hljs-type">DEFAULT_TOKEN_CHANNEL</span>, start.getStartIndex, token.getStopIndex)<font></font>
    result.setLine(start.getLine)<font></font>
    result.setCharPositionInLine(start.getCharPositionInLine)<font></font>
    result.setFoldedTokens(list)<font></font>
    result<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">createFoldBlockBody</span></span>(list: mutable.<span class="hljs-type">MutableList</span>[<span class="hljs-type">RScanToken</span>]): (<span class="hljs-type">RScanToken</span>, mutable.<span class="hljs-type">MutableList</span>[<span class="hljs-type">RScanToken</span>]) = {
    <span class="hljs-keyword">var</span> current: <span class="hljs-type">RScanToken</span> = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">while</span> (current == <span class="hljs-literal">null</span> || current.getType != <span class="hljs-type">Token</span>.<span class="hljs-type">EOF</span> &amp;&amp; current.getType != foldClose) {<font></font>
      current = nextToken().asInstanceOf[<span class="hljs-type">RScanToken</span>]<font></font>
      list += current<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (current.getType == <span class="hljs-type">Token</span>.<span class="hljs-type">EOF</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">IllegalStateException</span>()<font></font>
    (current, list)<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文法は以下によって補足されるべきです：</font></font><br>
<br>
<pre><code class="plaintext hljs">startJavaScript <font></font>
    :   HashBangLine? jsFileBody? EOF<font></font>
    ;<font></font>
<font></font>
startFoldBlock<font></font>
   :   block EOF<font></font>
   ;<font></font>
<font></font>
block<font></font>
    :   LBRACE stmtList? RBRACE<font></font>
    |   FoldBlock <font></font>
//     ,<font></font>
//     startFoldBlock<font></font>
    ;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチでは、再帰アルゴリズムがトークンを吸収して保存するため、畳み込みの内容は再度処理されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
処理速度は2倍から10倍に増加し、違いは特に縮小化されたjsファイルで顕著になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例としていくつかのJavaScriptファイルを使用した、提案された最適化のANTLR操作への影響：</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイズkb</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化前のミリ秒</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化後、ms</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">normalize-and-load-metadata.js</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1839</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1372</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rewrite-live-references.js</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">899</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">528</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dom.umd.min.js</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">130</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">43852</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6607</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">react.pure.umd.min.js</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">139</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">51668</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6495</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tsserver.js</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8151</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">362857</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">117787</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適化を行わない場合、作業は1つのスレッドで実行されます。最適化を使用すると、可能な場合、処理は並列になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この起動は、64 GBのRAM、Intel®Core（TM）i7-9700K CPU @ 3.60GHz、OpenJDKランタイム環境AdoptOpenJDK（ビルド11.0.4 + 11）を搭載したマシンで実行されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JVM起動キー：-Xmx4G -XX：+ UseG1GC -XX：MaxHeapFreeRatio = 30 -XX：MinHeapFreeRatio = 10 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tsserver.jsファイルの場合、キーは-Xmx32Gですが、メモリ消費量は22 GBに達しました！</font><font style="vertical-align: inherit;">最適化された最大200 kbの縮小ファイルは、ガベージコレクターがプロセッサに負荷をかけることなく、並列モードで128 mbのヒープ制限で分析されますが、最大2％です！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロファイリング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ANTLRは、実行時にパーサー/レクサーのプロファイリングをサポートしています。これを有効にするには、ルールが実行される前に、org.antlr.v4.runtime.Parser＃setProfileメソッドを呼び出す必要があります。</font><font style="vertical-align: inherit;">次に、たとえば次のようにして、すべての情報を取得できます。</font></font><br>
<br>
<pre><code class="scala hljs">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printProfileInfo</span></span>(parser: <span class="hljs-type">AbstractRScanParser</span>, tokenStream: <span class="hljs-type">TokenStream</span>): <span class="hljs-type">Unit</span> = {
      <span class="hljs-comment">// do the actual parsing</span>
      <span class="hljs-keyword">val</span> parseInfo = parser.getParseInfo
      <span class="hljs-keyword">val</span> atn = parser.getATN
      <span class="hljs-keyword">for</span> (di &lt;- parseInfo.getDecisionInfo <span class="hljs-keyword">if</span> di.ambiguities.size() &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">val</span> ds = atn.decisionToState.get(di.decision)
        <span class="hljs-keyword">val</span> ruleName = parser.ruleName(ds.ruleIndex)<font></font>
        log.debug(<span class="hljs-string">"Ambiguity in rule '"</span> + ruleName + <span class="hljs-string">"' -&gt; {}"</span>, di)<font></font>
        log.debug(<span class="hljs-string">"========================="</span>)<font></font>
        log.debug(tokenStream.getText)<font></font>
        log.debug(<span class="hljs-string">"========================="</span>)<font></font>
      }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法の明らかな利点は、たたみ込みを{}で置き換えて常にローカルたたみ込みで機能できるため、分析する必要があるデータの量が減ることです。これにより、文法の最適化プロセスが大幅に高速化されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、ANTLRライブラリを使用して実装された正式な文法の作業を最適化する方法を提案しますが、アプローチ自体は他のライブラリにも適用できます。最適化の機能は、入力トークンストリームを検証するための前方遷移の数の削減です。また、シングルスレッド処理で512 mbのメモリコストで大きなファイル（1 mbを超える）を分析することもできますが、最適化の欠如により、同じ文法を使用して高速に作業するには50倍のメモリが必要になります。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">githubで</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
入手可能なソースコード</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このプロジェクトは、最適化作業を示すために作成されました。プロジェクトは可能な限り簡略化されています。GrammarTesterクラスで調査を開始することをお勧めします。起動構成が作成されています。入力データを含むフォルダーへのパスを登録するだけで済みます。 rscan.tester.cache.dirキーに注意してください。一時ファイルがこのフォルダーに書き込まれます。成功したファイル分析はこのフォルダーで修正され、パーサーがもう一度分析することはできません-エラーの修正に便利です。現時点では、文法は、コア反応アプリケーション用に作成されたnode_modulesからの17000個のファイルでテストされています。ネストされたnode_modulesのみが無視されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次回の記事では、最小限のメモリ消費で分析オブジェクトとして初期データを最適に表現するためのデータとR（リフレクション）モデルを整理するためのオプション、複雑度O（1）の要素の検索アルゴリズムを実装する機能、およびシリアル化された形式でディスクに保存できる機能について検討しますすべてのオブジェクト、およびツールの単体テスト部分。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja487696/index.html">2月10〜16日のモスクワでのデジタルイベント</a></li>
<li><a href="../ja487698/index.html">2月10〜16日のサンクトペテルブルクでのデジタルイベント</a></li>
<li><a href="../ja487702/index.html">機械学習に関する記事の選択：2020年1月のケーススタディ、ガイド、および研究</a></li>
<li><a href="../ja487704/index.html">SSRS 2014で動的レポートを作成する方法</a></li>
<li><a href="../ja487706/index.html">Consulの例を使用した分散システムでのサービス検出。アレクサンドル・シガチェフ</a></li>
<li><a href="../ja487720/index.html">競争的コーティニズムについて（例としてリアクティブプログラミングを使用）</a></li>
<li><a href="../ja487724/index.html">BlazingPizza：最初から最後までBlazorアプリ。パート2.コンポーネントを追加する</a></li>
<li><a href="../ja487728/index.html">@Pythonetcコンパイル、2020年1月</a></li>
<li><a href="../ja487730/index.html">自然言語処理。2019年の結果と2020年の傾向</a></li>
<li><a href="../ja487734/index.html">Entity Framework Coreの高速化</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>