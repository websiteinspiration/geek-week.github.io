<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤜🏼 👩🏽‍🏭 ⬇️ Celesta 7.x：ORM、移行および「1つのパッケージ」でのテスト 🧛🏼 👃🏻 👲🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="おそらくあなたはすでにオープンソースのCelestaライブラリについて何か知っています。そうでない場合、それは問題ではありません。今からすべてを説明します。もう1年が経過し、バージョン7.xがリリースされ、多くの変更がありました。変更を要約すると同時に、Celestaの概要を思い出しました。
 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Celesta 7.x：ORM、移行および「1つのパッケージ」でのテスト</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455746/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おそらくあなたはすでにオープンソースの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Celesta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリについて何か知っています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そうでない場合、それは問題ではありません。今からすべてを説明します。</font><font style="vertical-align: inherit;">もう1年が経過し、バージョン7.xがリリースされ、多くの変更がありました。変更を要約すると同時に、Celestaの概要を思い出しました。</font></font></p><br>
<div style="text-align:center;"><img width="350" src="https://habrastorage.org/webt/jj/7z/jt/jj7zjthmrh2dhdo4v0ueefqj6uq.png"></div><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Celestaについてまだ何も聞いたことがなく、この記事を読むときに、そのアプリケーションが最も効果的なビジネスタスクについて知りたい場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">古い投稿の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の部分</font><font style="vertical-align: inherit;">またはこの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30分のビデオ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（Python言語の使用に関する言葉を除く）を</font><font style="vertical-align: inherit;">お勧めし</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ただし、この記事を最初に読むことをお勧めします。</font><font style="vertical-align: inherit;">バージョン7で行われた変更から始めて、次に、最新バージョンのCelestaを使用して、Spring Bootを使用するJavaアプリケーション用の小さなバックエンドサービスを作成する完全な技術例を説明します。</font></font></p><br>
<h2 id="chto-izmenilos-v-versii-7x"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バージョン7.xで何が変更されましたか？</font></font></h2><br>
<ol>
<li>    Jython    Celesta .       Celesta  ,  -   ,  …  -    Java-: Java, Groovy, JRuby    Jython.   Celesta   -,   -  Celesta          Java-. , -    ,   ,     .  ,    Jython .        Jython,      ,      ,     ,     pip-  .         ,     production-.     Jython   ,      . Celesta     Jython.</li>
<li>        Java (  Python,  )   Maven-.    -        ,             .</li>
<li> Extension  JUnit5,    ,    ,      JUnit5 (     ).</li>
<li>   — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">spring-boot-starter-celesta</a>, ,    ,   Celesta  Spring Boot.   Celesta-     Spring Boot             Python-.</li>
<li>     Wiki   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">AsciiDoctor</a>,                   Celesta.         : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://courseorchestra.github.io/celesta/ru</a></li>
<li>  ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> DDL</a>   Celesta.        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">2bass</a>.</li>
</ol><br>
<h2 id="chto-takoe-selesta-i-chto-ona-umeet">  elesta    ?</h2><br>
<p>  , Celesta :</p><br>
<ul>
<li>       -,   <em>database-first</em>   ,</li>
<li>   ,</li>
<li>   ,   . </li>
</ul><br>
<p>     : PostgreSQL, MS SQL Server, Oracle  H2.</p><br>
<p>   Celesta:</p><br>
<ol>
<li>,      Java: «Write once, run on every supported RDBMS».  -  ,        .     -     MS SQL Server,    PostgreSQL,      (,  :)</li>
<li>    «»  .     Celesta- ,          ,   ,         .     Celesta —    «»      .</li>
<li>.    ,    Celesta  ,      ,    ,   ,   ,      DbUnit  .</li>
</ol><br>
<h2 id="dlya-chego-nuzhna-nezavisimost-ot-tipa-subd">      ?</h2><br>
<p>  -         : ,   Celesta,   ,     . ?</p><br>
<p>-, - ,     –    ,  .    -,   ,        ,    ,          .   :         PostgreSQL,          MS SQL Server. Celesta     ,      .</p><br>
<p>-, ,      ,        ,   .          email    ,           ?</p><br>
<p>- —   ,    —       DbUnit       H2,    in-memory.     H2  . Celesta       ,        «» .    -   ,     ,  ,       H2,         PostgreSQL. ,      Celesta        ,  ,       API   .    .   -    .</p><br>
<h2 id="celestasql">CelestaSQL</h2><br>
<p>    «»? ,  ,         API,      . Celesta  Java-    ,   ,  SQL-       ,   .</p><br>
<p>Celesta   object-relational mapping   ,           ,     . . .   ER- ,       Celesta   -    .</p><br>
<p>            ,        .     « »         ,    :</p><br>
<div style="text-align:center;"><img width="300" src="https://habrastorage.org/getpro/habr/post_images/7d9/2ad/1e1/7d92ad1e1a3bc0bb83b5c4bcc511ec66.png"></div><br>
<p>       ,    ,     -,       .    ,    . : -  , , SQL Server    .        ,  ,  (views),  (sequences), SQL-  JOIN  GROUP BY. ,      .    « SQL»,   «CelestaSQL»,       SQL-    .</p><br>
<p> CelestaSQL    DDL       SELECT-    ,     DML:     ,     .</p><br>
<p>        .   CelestaSQL     .      ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a>              Java.</p><br>
<p> ,    —   (   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>, , PostgreSQL),        ,  ,   , ,  : ,  , , , boolean-  BLOB-      .</p><br>
<p>  CelestaSQL   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>     .</p><br>
<h2 id="modifikaciya-struktury-bazy-dannyh-idempotentnyy-ddl">   .  DDL</h2><br>
<p>     Celesta –            .      Celesta     DDL. </p><br>
<p>  ,     CelestaSQL  :</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> OrderLine(<font></font>
  order_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  line_no <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  item_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  item_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),<font></font>
  qty <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  <span class="hljs-keyword">cost</span> <span class="hljs-built_in">REAL</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.0</span>,
  <span class="hljs-keyword">CONSTRAINT</span> Idx_OrderLine PRIMARY <span class="hljs-keyword">KEY</span> (order_id, line_no)<font></font>
);</code></pre><br>
<p>—    Celesta   « ,     ,   »,  «    ».  : «   — ,   , ,    ,   ,  ,   ,  default-  . .     -    ,      ».</p><br>
<p>              :</p><br>
<ul>
<li>     « » ,</li>
<li>,        ,        ,</li>
<li>  ALTER-,   , « »    Celesta   .</li>
</ul><br>
<p>,      . Celesta   ,       ,       . ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a> (   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>).</p><br>
<p> ,     /    , Celesta        DDL- (    ,        ).      ,         ,         .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<h2 id="sozdanie-proekta-celesta-i-modeli-dannyh">  Celesta   </h2><br>
<p>-,    , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a>.  ,    Celesta   Spring Boot .    Maven-:</p><br>
<ul>
<li><code>org.springframework.boot:spring-boot-starter-web</code>  <code>ru.curs:spring-boot-starter-celesta</code> (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>  ).</li>
<li>    Spring Boot,     <code>ru.curs:celesta-system-services</code> .</li>
<li>        Celesta-SQL   <code>ru.curs:celesta-maven-plugin</code> —   -   ,   .</li>
<li>    JUnit5    ,  ,    scope  <code>ru.curs:celesta-unit</code>.</li>
</ul><br>
<p>         .</p><br>
<p>,      -,      .      .   ,         ,      ,   ,  . </p><br>
<p>  « »    : HTTP-  CRUD-,     .</p><br>
<p>  ,  Celesta  Database-first   ,       ,  . ,  ,  :    ,     ,      ,      ( ).</p><br>
<p>,  : </p><br>
<ul>
<li> <code>src/main/celestasql</code> —  ,    CelestaSQL  </li>
<li>  ,    java- (<code>ru/curs/demo</code>   ).</li>
<li>    <code>.sql</code>   :</li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SCHEMA</span> demo <span class="hljs-keyword">VERSION</span> <span class="hljs-string">'1.0'</span>;<font></font>
<font></font>
<span class="hljs-comment">/** */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> OrderHeader(
  <span class="hljs-keyword">id</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-built_in">date</span> DATETIME,<font></font>
  customer_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>),<font></font>
<font></font>
  <span class="hljs-comment">/**  */</span>
  customer_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),<font></font>
  manager_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>),
  <span class="hljs-keyword">CONSTRAINT</span> Pk_OrderHeader PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">/** */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> OrderLine(<font></font>
  order_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  line_no <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  item_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  item_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),<font></font>
  qty <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  <span class="hljs-keyword">cost</span> <span class="hljs-built_in">REAL</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.0</span>,
  <span class="hljs-keyword">CONSTRAINT</span> Idx_OrderLine PRIMARY <span class="hljs-keyword">KEY</span> (order_id, line_no)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> OrderLine <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_OrderLine <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (order_id) <span class="hljs-keyword">REFERENCES</span> OrderHeader(<span class="hljs-keyword">id</span>);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> OrderedQty <span class="hljs-keyword">AS</span>
  <span class="hljs-keyword">SELECT</span> item_id, <span class="hljs-keyword">sum</span>(qty) <span class="hljs-keyword">AS</span> qty <span class="hljs-keyword">FROM</span> OrderLine <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> item_id;</code></pre><br>
<p>    ,   ,   ,       ,    .  ,      SQL,    <code>CREATE SCHEMA</code>,       <code>demo</code> ( ,       , . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>).    . ,     ,   ,    ,          Java    .  ,  .   ,  ,          ,     /*,  ,   /**,    JavaDoc —   ! ,    ,   /**,        <code>.getCelestaDoc()</code>  .   ,        -: , human readable  ,   ,        . .</p><br>
<p>CelestaSQL      : -,   /    ,  -,      .</p><br>
<p>        ,      <code>mvn generate-sources</code> ,     IDEA,    'Generate sources and update folders'    Maven.    IDEA «»   <code>target/generated-sources/celesta</code>            .       —         :</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/3q/cs/2x3qcsydsu3y5vplbyh7oz15z-s.png"></div><br>
<p>       ,    —   <code>src/main/resources/application.yml</code>.   spring-boot-starter-celesta, IDEA    code completion   .</p><br>
<p>          «» ,    Celesta      H2  in-memory     :</p><br>
<pre><code class="plaintext hljs">celesta:<font></font>
  h2:<font></font>
    inMemory: true</code></pre><br>
<p>  «»     - </p><br>
<pre><code class="plaintext hljs">celesta:<font></font>
  jdbc:<font></font>
    url: jdbc:postgresql://127.0.0.1:5432/celesta<font></font>
    username: &lt;your_username&gt;<font></font>
    password: &lt;your_password&gt;</code></pre><br>
<p>(        Maven-     PostgreSQL JDBC-).</p><br>
<p>  Celesta-      ,  ,   , ,   . .     ,    —     DDL .</p><br>
<h2 id="sozdanie-metodov-rabotayuschih-s-dannymi"> ,   </h2><br>
<p>     ,     -.</p><br>
<p> ,           ,      Celesta     , «»   .   Celesta-   <em> </em>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">CallContext</a>.</p><br>
<ul>
<li>  ,      , <code>CallContext</code> .</li>
<li>             .</li>
<li>    <code>CallContext</code>-   <code>commit()</code>,    ,  <code>rollback()</code>,       , <code>CallContext</code>         .</li>
</ul><br>
<p>   spring-boot-starter-celesta,        ,  <code>@CelestaTransaction</code>.</p><br>
<p>,    ,    .         : </p><br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentController</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DocumentService srv;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DocumentController</span><span class="hljs-params">(DocumentService srv)</span> </span>{
        <span class="hljs-keyword">this</span>.srv = srv;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@PutMapping("/save")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderDto order)</span> </span>{<font></font>
        CallContext ctx = <span class="hljs-keyword">new</span> CallContext(<span class="hljs-string">"user1"</span>); <span class="hljs-comment">//new SystemCallContext();</span><font></font>
        srv.postOrder(ctx, order);<font></font>
    }</code></pre><br>
<p> ,     (. .    )           <code>CallContext</code>.          ,      ,    . ,      ,    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>       "user1".           Celesta         ,     <code>SystemCallContext</code>.</p><br>
<p>        :</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentService</span> </span>{
    <span class="hljs-meta">@CelestaTransaction</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postOrder</span><span class="hljs-params">(CallContext context, OrderDto doc)</span> </span>{
        <span class="hljs-keyword">try</span> (OrderHeaderCursor header = <span class="hljs-keyword">new</span> OrderHeaderCursor(context);<font></font>
             OrderLineCursor line = <span class="hljs-keyword">new</span> OrderLineCursor(context)) {<font></font>
            header.setId(doc.getId());<font></font>
            header.setDate(Date.from(doc.getDate().atStartOfDay(ZoneId.systemDefault()).toInstant()));<font></font>
            header.setCustomer_id(doc.getCustomerId());<font></font>
            header.setCustomer_name(doc.getCustomerName());<font></font>
            header.insert();<font></font>
            <span class="hljs-keyword">int</span> lineNo = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (OrderLineDto docLine : doc.getLines()) {<font></font>
                lineNo++;<font></font>
                line.setLine_no(lineNo);<font></font>
                line.setOrder_id(doc.getId());<font></font>
                line.setItem_id(docLine.getItemId());<font></font>
                line.setQty(docLine.getQty());<font></font>
                line.insert();<font></font>
            }<font></font>
        }<font></font>
    }</code></pre><br>
<p>    <code>@CelestaTransaction</code>.   - <code>DocumentService</code>         <code>CallContext ctx</code>,   . . .             ,     .       -.    —   <code>OrderDto</code>      .</p><br>
<p>       — ,    <code>celesta-maven-plugin</code>.   ,     .          –      .                -.</p><br>
<p>         ,    :</p><br>
<pre><code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword">new</span> OrderHeaderCursor(context);<font></font>
header.tryFirst();</code></pre><br>
<p>   header            :</p><br>
<div style="text-align:center;"><img width="450" src="https://habrastorage.org/webt/_8/gl/9i/_8gl9ikjbprpjano2dbvj0reme8.png"></div><br>
<p>         —     .             .</p><br>
<p> -     : ,   ,  , , ,    .  API     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<p>,         :</p><br>
<pre><code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword">new</span> OrderHeaderCursor(context);<font></font>
header.setRange(<span class="hljs-string">"manager_id"</span>, <span class="hljs-string">"manager1"</span>);<font></font>
header.tryFirst();<font></font>
header.setCounter(header.getCounter() + <span class="hljs-number">1</span>);<font></font>
header.update();</code></pre><br>
<p>        manager_id,      tryFirst.</p><br>
<div class="spoiler"><b class="spoiler_title">( «try»)</b><div class="spoiler_text"><p> <code>get</code>, <code>first</code>, <code>insert</code>, <code>update</code>   :   try ( <code>get(...)</code>  . .)    try (<code>tryGet(...)</code>, <code>tryFirst()</code>  . .).    try  ,          .  , first()  ,           .        try   ,      ,       .        try ,   .    «  » ,       /    . </p></div></div><br>
<p>   <code>tryFirst</code>      ,       .       ,   <code>update()</code>,        .</p><br>
<p>      ?  ,  race condition/lost update!    ,        «tryFirst»,  ,         «update», -    ,       .  ,   ,         !      Celesta   optimistic lock.      Celesta   <code>recversion</code>,    ON UPDATE-      ,       ,    .    —  .         «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   </a>». </p><br>
<p>  ,    CallContext  .  Celesta-  ,  commit.  Celesta-    ,  rollback.  ,     -   —       ,           ,   .   -  commit  , , -  ,   commit  ,  <code>context.commit()</code>.</p><br>
<h2 id="testirovanie-metodov-rabotayuschih-s-dannymi"> ,   </h2><br>
<p>  ,     ,  <code>OrderDto</code>   .</p><br>
<p>  JUnit5     <code>celesta-unit</code>   JUnit5,    .   :</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@CelestaTest</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentServiceTest</span> </span>{<font></font>
    DocumentService srv = <span class="hljs-keyword">new</span> DocumentService();<font></font>
<font></font>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">documentIsPutToDb</span><span class="hljs-params">(CallContext context)</span> </span>{<font></font>
        OrderDto doc =...<font></font>
<font></font>
        srv.postOrder(context, doc);<font></font>
        <span class="hljs-comment">//Check the fact that records are in the database</span>
        OrderHeaderCursor header = <span class="hljs-keyword">new</span> OrderHeaderCursor(context);<font></font>
        header.tryFirst();<font></font>
        assertEquals(doc.getId(), header.getId());<font></font>
<font></font>
        OrderLineCursor line = <span class="hljs-keyword">new</span> OrderLineCursor(context);<font></font>
        line.setRange(<span class="hljs-string">"order_id"</span>, doc.getId());<font></font>
        assertEquals(<span class="hljs-number">2</span>, line.count());<font></font>
    }<font></font>
}</code></pre><br>
<p>  <code>@CelestaTest</code>,     JUnit5,      <code>CallContext context</code>   .          (in-memory H2),        ,       —      <code>new</code>,     Spring. ,        Spring,     .</p><br>
<p>     ,          ,   ,   ,          ,    «»  .       .</p><br>
<p>   ,  JSON   , ,      .</p><br>
<p>     ,     ,    <code>getAggregateReport</code>:</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">reportReturnsAggregatedQuantities</span><span class="hljs-params">(CallContext context)</span> </span>{<font></font>
    srv.postOrder(context, . . .);<font></font>
    srv.postOrder(context, . . .);<font></font>
    Map&lt;String, Integer&gt; result = srv.getAggregateReport(context);<font></font>
    assertEquals(<span class="hljs-number">5</span>, result.get(<span class="hljs-string">"A"</span>).intValue());<font></font>
    assertEquals(<span class="hljs-number">7</span>, result.get(<span class="hljs-string">"B"</span>).intValue());<font></font>
}</code></pre><br>
<p>   <code>getAggregateReport</code>    OrderedQty, , ,  CelestaSQL-  :</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> OrderedQty <span class="hljs-keyword">as</span>
     <span class="hljs-keyword">select</span> item_id, <span class="hljs-keyword">sum</span>(qty) <span class="hljs-keyword">as</span> qty <span class="hljs-keyword">from</span> OrderLine <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> item_id;</code></pre><br>
<p> :           .      OrderedQtyCursor,    .    ,       <code>Map&lt;String, Integer&gt;</code>:</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@CelestaTransaction</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Integer&gt; <span class="hljs-title">getAggregateReport</span><span class="hljs-params">(CallContext context)</span> </span>{<font></font>
    Map&lt;String, Integer&gt; result = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    <span class="hljs-keyword">try</span> (OrderedQtyCursor ordered_qty = <span class="hljs-keyword">new</span> OrderedQtyCursor(context)) {
        <span class="hljs-keyword">for</span> (OrderedQtyCursor line : ordered_qty) {<font></font>
            result.put(ordered_qty.getItem_id(), ordered_qty.getQty());<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<h2 id="materializovannye-predstavleniya-celesta">  Celesta</h2><br>
<p>       ?    ,            :  ,   SQL-,           .        .   ?</p><br>
<p>Celesta    ,      -,    .</p><br>
<p> MS SQL Server    () ,          ,      .      «» MS SQL Server,             ,  :          ,                          .</p><br>
<p>  ,     PostgreSQL  Celesta,    ?  ,   materialized:</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">materialized</span> <span class="hljs-keyword">view</span> OrderedQty <span class="hljs-keyword">as</span>
     <span class="hljs-keyword">select</span> item_id, <span class="hljs-keyword">sum</span>(qty) <span class="hljs-keyword">as</span> qty <span class="hljs-keyword">from</span> OrderLine <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> item_id;</code></pre><br>
<p>   ,     .</p><br>
<p> ,   <code>OrderedQty</code> ,      <code>OrderedQty</code>.  ,      OrderLine,   OrderedQty  « »  , ,    OrderedQty   .</p><br>
<p>   ,     ,    <code>OrderLine</code>. Celesta,    « »,        <code>OrderLine</code>,  <code>OrderedQty</code>.     — <code>materialized</code> —  CelestaSQL-     ,   -    !</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当然、このアプローチには独自の制限があり、厳密な制限があります。</font><font style="vertical-align: inherit;">Celestaでは、GROUP BYによる集計を使用して、JOINなしで同じテーブル上に構築されたビューのみが実体化できます。</font><font style="vertical-align: inherit;">ただし、これは、たとえば、実際のレポートで頻繁に発生する、口座の残高、倉庫のセルごとの商品などの残高明細を作成するには十分です。</font></font></p><br>
<h2 id="zaklyuchenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Celestaシステムの主な機能について説明しました。</font><font style="vertical-align: inherit;">テクノロジーに興味がある場合は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントに</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ようこそ</font><font style="vertical-align: inherit;">。</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja455736/index.html">ハイブリッドおよびマルチポーマイニングによる暗号通貨のコンセンサス</a></li>
<li><a href="../ja455738/index.html">データを収益化して10億ドルを稼ぐ方法は？</a></li>
<li><a href="../ja455740/index.html">投資会社での機械学習：テクニカルサポートの呼び出しを分類します</a></li>
<li><a href="../ja455742/index.html">音楽を作る：シンプルなソリューションがディープラーニングよりも優れている場合</a></li>
<li><a href="../ja455744/index.html">視覚的リアリズムを改善した迷路風景生成システム[Jinmo Kimによる記事の翻訳]</a></li>
<li><a href="../ja455754/index.html">漂流ストラトスタットのテスト。ロゴジンとロラの成層圏への進水</a></li>
<li><a href="../ja455756/index.html">目です</a></li>
<li><a href="../ja455758/index.html">小売ロケットの成長ハッキング：仮説の検索からテスト手法まで</a></li>
<li><a href="../ja455760/index.html">SwiftUIの魔法または関数ビルダーについて</a></li>
<li><a href="../ja455762/index.html">マルコフ連鎖の簡単な紹介</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>