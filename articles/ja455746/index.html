<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤œğŸ¼ ğŸ‘©ğŸ½â€ğŸ­ â¬‡ï¸ Celesta 7.xï¼šORMã€ç§»è¡ŒãŠã‚ˆã³ã€Œ1ã¤ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€ã§ã®ãƒ†ã‚¹ãƒˆ ğŸ§›ğŸ¼ ğŸ‘ƒğŸ» ğŸ‘²ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ãŠãã‚‰ãã‚ãªãŸã¯ã™ã§ã«ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®Celestaãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ä½•ã‹çŸ¥ã£ã¦ã„ã¾ã™ã€‚ãã†ã§ãªã„å ´åˆã€ãã‚Œã¯å•é¡Œã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šã‹ã‚‰ã™ã¹ã¦ã‚’èª¬æ˜ã—ã¾ã™ã€‚ã‚‚ã†1å¹´ãŒçµŒéã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³7.xãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€å¤šãã®å¤‰æ›´ãŒã‚ã‚Šã¾ã—ãŸã€‚å¤‰æ›´ã‚’è¦ç´„ã™ã‚‹ã¨åŒæ™‚ã«ã€Celestaã®æ¦‚è¦ã‚’æ€ã„å‡ºã—ã¾ã—ãŸã€‚
 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Celesta 7.xï¼šORMã€ç§»è¡ŒãŠã‚ˆã³ã€Œ1ã¤ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€ã§ã®ãƒ†ã‚¹ãƒˆ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455746/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŠãã‚‰ãã‚ãªãŸã¯ã™ã§ã«ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Celesta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ä½•ã‹çŸ¥ã£ã¦ã„ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ãã†ã§ãªã„å ´åˆã€ãã‚Œã¯å•é¡Œã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šã‹ã‚‰ã™ã¹ã¦ã‚’èª¬æ˜ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚‚ã†1å¹´ãŒçµŒéã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³7.xãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€å¤šãã®å¤‰æ›´ãŒã‚ã‚Šã¾ã—ãŸã€‚å¤‰æ›´ã‚’è¦ç´„ã™ã‚‹ã¨åŒæ™‚ã«ã€Celestaã®æ¦‚è¦ã‚’æ€ã„å‡ºã—ã¾ã—ãŸã€‚</font></font></p><br>
<div style="text-align:center;"><img width="350" src="https://habrastorage.org/webt/jj/7z/jt/jj7zjthmrh2dhdo4v0ueefqj6uq.png"></div><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Celestaã«ã¤ã„ã¦ã¾ã ä½•ã‚‚èã„ãŸã“ã¨ãŒãªãã€ã“ã®è¨˜äº‹ã‚’èª­ã‚€ã¨ãã«ã€ãã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæœ€ã‚‚åŠ¹æœçš„ãªãƒ“ã‚¸ãƒã‚¹ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„å ´åˆã¯ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¤ã„æŠ•ç¨¿ã®</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€åˆã®éƒ¨åˆ†</font><font style="vertical-align: inherit;">ã¾ãŸã¯ã“ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30åˆ†ã®ãƒ“ãƒ‡ã‚ª</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆPythonè¨€èªã®ä½¿ç”¨ã«é–¢ã™ã‚‹è¨€è‘‰ã‚’é™¤ãï¼‰ã‚’</font><font style="vertical-align: inherit;">ãŠå‹§ã‚ã—</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã ã—ã€ã“ã®è¨˜äº‹ã‚’æœ€åˆã«èª­ã‚€ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒãƒ¼ã‚¸ãƒ§ãƒ³7ã§è¡Œã‚ã‚ŒãŸå¤‰æ›´ã‹ã‚‰å§‹ã‚ã¦ã€æ¬¡ã«ã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Celestaã‚’ä½¿ç”¨ã—ã¦ã€Spring Bootã‚’ä½¿ç”¨ã™ã‚‹Javaã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®å°ã•ãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã™ã‚‹å®Œå…¨ãªæŠ€è¡“ä¾‹ã‚’èª¬æ˜ã—ã¾ã™ã€‚</font></font></p><br>
<h2 id="chto-izmenilos-v-versii-7x"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒãƒ¼ã‚¸ãƒ§ãƒ³7.xã§ä½•ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ</font></font></h2><br>
<ol>
<li>    Jython    Celesta .       Celesta  ,  -   ,  â€¦  -    Java-: Java, Groovy, JRuby    Jython.   Celesta   -,   -  Celesta          Java-. , -    ,   ,     .  ,    Jython .        Jython,      ,      ,     ,     pip-  .         ,     production-.     Jython   ,      . Celesta     Jython.</li>
<li>        Java (  Python,  )   Maven-.    -        ,             .</li>
<li> Extension  JUnit5,    ,    ,      JUnit5 (     ).</li>
<li>   â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">spring-boot-starter-celesta</a>, ,    ,   Celesta  Spring Boot.   Celesta-     Spring Boot             Python-.</li>
<li>     Wiki   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">AsciiDoctor</a>,                   Celesta.         : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://courseorchestra.github.io/celesta/ru</a></li>
<li>  ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> DDL</a>   Celesta.        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">2bass</a>.</li>
</ol><br>
<h2 id="chto-takoe-selesta-i-chto-ona-umeet">  elesta    ?</h2><br>
<p>  , Celesta :</p><br>
<ul>
<li>       -,   <em>database-first</em>   ,</li>
<li>   ,</li>
<li>   ,   . </li>
</ul><br>
<p>     : PostgreSQL, MS SQL Server, Oracle  H2.</p><br>
<p>   Celesta:</p><br>
<ol>
<li>,      Java: Â«Write once, run on every supported RDBMSÂ».  -  ,        .     -     MS SQL Server,    PostgreSQL,      (,  :)</li>
<li>    Â«Â»  .     Celesta- ,          ,   ,         .     Celesta â€”    Â«Â»      .</li>
<li>.    ,    Celesta  ,      ,    ,   ,   ,      DbUnit  .</li>
</ol><br>
<h2 id="dlya-chego-nuzhna-nezavisimost-ot-tipa-subd">      ?</h2><br>
<p>  -         : ,   Celesta,   ,     . ?</p><br>
<p>-, - ,     â€“    ,  .    -,   ,        ,    ,          .   :         PostgreSQL,          MS SQL Server. Celesta     ,      .</p><br>
<p>-, ,      ,        ,   .          email    ,           ?</p><br>
<p>- â€”   ,    â€”       DbUnit       H2,    in-memory.     H2  . Celesta       ,        Â«Â» .    -   ,     ,  ,       H2,         PostgreSQL. ,      Celesta        ,  ,       API   .    .   -    .</p><br>
<h2 id="celestasql">CelestaSQL</h2><br>
<p>    Â«Â»? ,  ,         API,      . Celesta  Java-    ,   ,  SQL-       ,   .</p><br>
<p>Celesta   object-relational mapping   ,           ,     . . .   ER- ,       Celesta   -    .</p><br>
<p>            ,        .     Â« Â»         ,    :</p><br>
<div style="text-align:center;"><img width="300" src="https://habrastorage.org/getpro/habr/post_images/7d9/2ad/1e1/7d92ad1e1a3bc0bb83b5c4bcc511ec66.png"></div><br>
<p>       ,    ,     -,       .    ,    . : -  , , SQL Server    .        ,  ,  (views),  (sequences), SQL-  JOIN  GROUP BY. ,      .    Â« SQLÂ»,   Â«CelestaSQLÂ»,       SQL-    .</p><br>
<p> CelestaSQL    DDL       SELECT-    ,     DML:     ,     .</p><br>
<p>        .   CelestaSQL     .      ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a>              Java.</p><br>
<p> ,    â€”   (   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>, , PostgreSQL),        ,  ,   , ,  : ,  , , , boolean-  BLOB-      .</p><br>
<p>  CelestaSQL   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>     .</p><br>
<h2 id="modifikaciya-struktury-bazy-dannyh-idempotentnyy-ddl">   .  DDL</h2><br>
<p>     Celesta â€“            .      Celesta     DDL. </p><br>
<p>  ,     CelestaSQL  :</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> OrderLine(<font></font>
  order_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  line_no <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  item_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  item_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),<font></font>
  qty <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  <span class="hljs-keyword">cost</span> <span class="hljs-built_in">REAL</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.0</span>,
  <span class="hljs-keyword">CONSTRAINT</span> Idx_OrderLine PRIMARY <span class="hljs-keyword">KEY</span> (order_id, line_no)<font></font>
);</code></pre><br>
<p>â€”    Celesta   Â« ,     ,   Â»,  Â«    Â».  : Â«   â€” ,   , ,    ,   ,  ,   ,  default-  . .     -    ,      Â».</p><br>
<p>              :</p><br>
<ul>
<li>     Â« Â» ,</li>
<li>,        ,        ,</li>
<li>  ALTER-,   , Â« Â»    Celesta   .</li>
</ul><br>
<p>,      . Celesta   ,       ,       . ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a> (   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>).</p><br>
<p> ,     /    , Celesta        DDL- (    ,        ).      ,         ,         .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<h2 id="sozdanie-proekta-celesta-i-modeli-dannyh">  Celesta   </h2><br>
<p>-,    , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  </a>.  ,    Celesta   Spring Boot .    Maven-:</p><br>
<ul>
<li><code>org.springframework.boot:spring-boot-starter-web</code>  <code>ru.curs:spring-boot-starter-celesta</code> (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>  ).</li>
<li>    Spring Boot,     <code>ru.curs:celesta-system-services</code> .</li>
<li>        Celesta-SQL   <code>ru.curs:celesta-maven-plugin</code> â€”   -   ,   .</li>
<li>    JUnit5    ,  ,    scope  <code>ru.curs:celesta-unit</code>.</li>
</ul><br>
<p>         .</p><br>
<p>,      -,      .      .   ,         ,      ,   ,  . </p><br>
<p>  Â« Â»    : HTTP-  CRUD-,     .</p><br>
<p>  ,  Celesta  Database-first   ,       ,  . ,  ,  :    ,     ,      ,      ( ).</p><br>
<p>,  : </p><br>
<ul>
<li> <code>src/main/celestasql</code> â€”  ,    CelestaSQL  </li>
<li>  ,    java- (<code>ru/curs/demo</code>   ).</li>
<li>    <code>.sql</code>   :</li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SCHEMA</span> demo <span class="hljs-keyword">VERSION</span> <span class="hljs-string">'1.0'</span>;<font></font>
<font></font>
<span class="hljs-comment">/** */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> OrderHeader(
  <span class="hljs-keyword">id</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
  <span class="hljs-built_in">date</span> DATETIME,<font></font>
  customer_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>),<font></font>
<font></font>
  <span class="hljs-comment">/**  */</span>
  customer_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>),<font></font>
  manager_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>),
  <span class="hljs-keyword">CONSTRAINT</span> Pk_OrderHeader PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-keyword">id</span>)<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">/** */</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> OrderLine(<font></font>
  order_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  line_no <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  item_id <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,<font></font>
  item_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">100</span>),<font></font>
  qty <span class="hljs-built_in">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  <span class="hljs-keyword">cost</span> <span class="hljs-built_in">REAL</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0.0</span>,
  <span class="hljs-keyword">CONSTRAINT</span> Idx_OrderLine PRIMARY <span class="hljs-keyword">KEY</span> (order_id, line_no)<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> OrderLine <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_OrderLine <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (order_id) <span class="hljs-keyword">REFERENCES</span> OrderHeader(<span class="hljs-keyword">id</span>);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> OrderedQty <span class="hljs-keyword">AS</span>
  <span class="hljs-keyword">SELECT</span> item_id, <span class="hljs-keyword">sum</span>(qty) <span class="hljs-keyword">AS</span> qty <span class="hljs-keyword">FROM</span> OrderLine <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> item_id;</code></pre><br>
<p>    ,   ,   ,       ,    .  ,      SQL,    <code>CREATE SCHEMA</code>,       <code>demo</code> ( ,       , . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>).    . ,     ,   ,    ,          Java    .  ,  .   ,  ,          ,     /*,  ,   /**,    JavaDoc â€”   ! ,    ,   /**,        <code>.getCelestaDoc()</code>  .   ,        -: , human readable  ,   ,        . .</p><br>
<p>CelestaSQL      : -,   /    ,  -,      .</p><br>
<p>        ,      <code>mvn generate-sources</code> ,     IDEA,    'Generate sources and update folders'    Maven.    IDEA Â«Â»   <code>target/generated-sources/celesta</code>            .       â€”         :</p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/3q/cs/2x3qcsydsu3y5vplbyh7oz15z-s.png"></div><br>
<p>       ,    â€”   <code>src/main/resources/application.yml</code>.   spring-boot-starter-celesta, IDEA    code completion   .</p><br>
<p>          Â«Â» ,    Celesta      H2  in-memory     :</p><br>
<pre><code class="plaintext hljs">celesta:<font></font>
  h2:<font></font>
    inMemory: true</code></pre><br>
<p>  Â«Â»     - </p><br>
<pre><code class="plaintext hljs">celesta:<font></font>
  jdbc:<font></font>
    url: jdbc:postgresql://127.0.0.1:5432/celesta<font></font>
    username: &lt;your_username&gt;<font></font>
    password: &lt;your_password&gt;</code></pre><br>
<p>(        Maven-     PostgreSQL JDBC-).</p><br>
<p>  Celesta-      ,  ,   , ,   . .     ,    â€”     DDL .</p><br>
<h2 id="sozdanie-metodov-rabotayuschih-s-dannymi"> ,   </h2><br>
<p>     ,     -.</p><br>
<p> ,           ,      Celesta     , Â«Â»   .   Celesta-   <em> </em>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">CallContext</a>.</p><br>
<ul>
<li>  ,      , <code>CallContext</code> .</li>
<li>             .</li>
<li>    <code>CallContext</code>-   <code>commit()</code>,    ,  <code>rollback()</code>,       , <code>CallContext</code>         .</li>
</ul><br>
<p>   spring-boot-starter-celesta,        ,  <code>@CelestaTransaction</code>.</p><br>
<p>,    ,    .         : </p><br>
<pre><code class="java hljs"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentController</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DocumentService srv;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DocumentController</span><span class="hljs-params">(DocumentService srv)</span> </span>{
        <span class="hljs-keyword">this</span>.srv = srv;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-meta">@PutMapping("/save")</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderDto order)</span> </span>{<font></font>
        CallContext ctx = <span class="hljs-keyword">new</span> CallContext(<span class="hljs-string">"user1"</span>); <span class="hljs-comment">//new SystemCallContext();</span><font></font>
        srv.postOrder(ctx, order);<font></font>
    }</code></pre><br>
<p> ,     (. .    )           <code>CallContext</code>.          ,      ,    . ,      ,    ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"> </a>       "user1".           Celesta         ,     <code>SystemCallContext</code>.</p><br>
<p>        :</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentService</span> </span>{
    <span class="hljs-meta">@CelestaTransaction</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postOrder</span><span class="hljs-params">(CallContext context, OrderDto doc)</span> </span>{
        <span class="hljs-keyword">try</span> (OrderHeaderCursor header = <span class="hljs-keyword">new</span> OrderHeaderCursor(context);<font></font>
             OrderLineCursor line = <span class="hljs-keyword">new</span> OrderLineCursor(context)) {<font></font>
            header.setId(doc.getId());<font></font>
            header.setDate(Date.from(doc.getDate().atStartOfDay(ZoneId.systemDefault()).toInstant()));<font></font>
            header.setCustomer_id(doc.getCustomerId());<font></font>
            header.setCustomer_name(doc.getCustomerName());<font></font>
            header.insert();<font></font>
            <span class="hljs-keyword">int</span> lineNo = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (OrderLineDto docLine : doc.getLines()) {<font></font>
                lineNo++;<font></font>
                line.setLine_no(lineNo);<font></font>
                line.setOrder_id(doc.getId());<font></font>
                line.setItem_id(docLine.getItemId());<font></font>
                line.setQty(docLine.getQty());<font></font>
                line.insert();<font></font>
            }<font></font>
        }<font></font>
    }</code></pre><br>
<p>    <code>@CelestaTransaction</code>.   - <code>DocumentService</code>         <code>CallContext ctx</code>,   . . .             ,     .       -.    â€”   <code>OrderDto</code>      .</p><br>
<p>       â€” ,    <code>celesta-maven-plugin</code>.   ,     .          â€“      .                -.</p><br>
<p>         ,    :</p><br>
<pre><code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword">new</span> OrderHeaderCursor(context);<font></font>
header.tryFirst();</code></pre><br>
<p>   header            :</p><br>
<div style="text-align:center;"><img width="450" src="https://habrastorage.org/webt/_8/gl/9i/_8gl9ikjbprpjano2dbvj0reme8.png"></div><br>
<p>         â€”     .             .</p><br>
<p> -     : ,   ,  , , ,    .  API     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.</p><br>
<p>,         :</p><br>
<pre><code class="java hljs">OrderHeaderCursor header = <span class="hljs-keyword">new</span> OrderHeaderCursor(context);<font></font>
header.setRange(<span class="hljs-string">"manager_id"</span>, <span class="hljs-string">"manager1"</span>);<font></font>
header.tryFirst();<font></font>
header.setCounter(header.getCounter() + <span class="hljs-number">1</span>);<font></font>
header.update();</code></pre><br>
<p>        manager_id,      tryFirst.</p><br>
<div class="spoiler"><b class="spoiler_title">( Â«tryÂ»)</b><div class="spoiler_text"><p> <code>get</code>, <code>first</code>, <code>insert</code>, <code>update</code>   :   try ( <code>get(...)</code>  . .)    try (<code>tryGet(...)</code>, <code>tryFirst()</code>  . .).    try  ,          .  , first()  ,           .        try   ,      ,       .        try ,   .    Â«  Â» ,       /    . </p></div></div><br>
<p>   <code>tryFirst</code>      ,       .       ,   <code>update()</code>,        .</p><br>
<p>      ?  ,  race condition/lost update!    ,        Â«tryFirstÂ»,  ,         Â«updateÂ», -    ,       .  ,   ,         !      Celesta   optimistic lock.      Celesta   <code>recversion</code>,    ON UPDATE-      ,       ,    .    â€”  .         Â«<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">   </a>Â». </p><br>
<p>  ,    CallContext  .  Celesta-  ,  commit.  Celesta-    ,  rollback.  ,     -   â€”       ,           ,   .   -  commit  , , -  ,   commit  ,  <code>context.commit()</code>.</p><br>
<h2 id="testirovanie-metodov-rabotayuschih-s-dannymi"> ,   </h2><br>
<p>  ,     ,  <code>OrderDto</code>   .</p><br>
<p>  JUnit5     <code>celesta-unit</code>   JUnit5,    .   :</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@CelestaTest</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DocumentServiceTest</span> </span>{<font></font>
    DocumentService srv = <span class="hljs-keyword">new</span> DocumentService();<font></font>
<font></font>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">documentIsPutToDb</span><span class="hljs-params">(CallContext context)</span> </span>{<font></font>
        OrderDto doc =...<font></font>
<font></font>
        srv.postOrder(context, doc);<font></font>
        <span class="hljs-comment">//Check the fact that records are in the database</span>
        OrderHeaderCursor header = <span class="hljs-keyword">new</span> OrderHeaderCursor(context);<font></font>
        header.tryFirst();<font></font>
        assertEquals(doc.getId(), header.getId());<font></font>
<font></font>
        OrderLineCursor line = <span class="hljs-keyword">new</span> OrderLineCursor(context);<font></font>
        line.setRange(<span class="hljs-string">"order_id"</span>, doc.getId());<font></font>
        assertEquals(<span class="hljs-number">2</span>, line.count());<font></font>
    }<font></font>
}</code></pre><br>
<p>  <code>@CelestaTest</code>,     JUnit5,      <code>CallContext context</code>   .          (in-memory H2),        ,       â€”      <code>new</code>,     Spring. ,        Spring,     .</p><br>
<p>     ,          ,   ,   ,          ,    Â«Â»  .       .</p><br>
<p>   ,  JSON   , ,      .</p><br>
<p>     ,     ,    <code>getAggregateReport</code>:</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">reportReturnsAggregatedQuantities</span><span class="hljs-params">(CallContext context)</span> </span>{<font></font>
    srv.postOrder(context, . . .);<font></font>
    srv.postOrder(context, . . .);<font></font>
    Map&lt;String, Integer&gt; result = srv.getAggregateReport(context);<font></font>
    assertEquals(<span class="hljs-number">5</span>, result.get(<span class="hljs-string">"A"</span>).intValue());<font></font>
    assertEquals(<span class="hljs-number">7</span>, result.get(<span class="hljs-string">"B"</span>).intValue());<font></font>
}</code></pre><br>
<p>   <code>getAggregateReport</code>    OrderedQty, , ,  CelestaSQL-  :</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> OrderedQty <span class="hljs-keyword">as</span>
     <span class="hljs-keyword">select</span> item_id, <span class="hljs-keyword">sum</span>(qty) <span class="hljs-keyword">as</span> qty <span class="hljs-keyword">from</span> OrderLine <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> item_id;</code></pre><br>
<p> :           .      OrderedQtyCursor,    .    ,       <code>Map&lt;String, Integer&gt;</code>:</p><br>
<pre><code class="java hljs"><span class="hljs-meta">@CelestaTransaction</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, Integer&gt; <span class="hljs-title">getAggregateReport</span><span class="hljs-params">(CallContext context)</span> </span>{<font></font>
    Map&lt;String, Integer&gt; result = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    <span class="hljs-keyword">try</span> (OrderedQtyCursor ordered_qty = <span class="hljs-keyword">new</span> OrderedQtyCursor(context)) {
        <span class="hljs-keyword">for</span> (OrderedQtyCursor line : ordered_qty) {<font></font>
            result.put(ordered_qty.getItem_id(), ordered_qty.getQty());<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br>
<h2 id="materializovannye-predstavleniya-celesta">  Celesta</h2><br>
<p>       ?    ,            :  ,   SQL-,           .        .   ?</p><br>
<p>Celesta    ,      -,    .</p><br>
<p> MS SQL Server    () ,          ,      .      Â«Â» MS SQL Server,             ,  :          ,                          .</p><br>
<p>  ,     PostgreSQL  Celesta,    ?  ,   materialized:</p><br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">materialized</span> <span class="hljs-keyword">view</span> OrderedQty <span class="hljs-keyword">as</span>
     <span class="hljs-keyword">select</span> item_id, <span class="hljs-keyword">sum</span>(qty) <span class="hljs-keyword">as</span> qty <span class="hljs-keyword">from</span> OrderLine <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> item_id;</code></pre><br>
<p>   ,     .</p><br>
<p> ,   <code>OrderedQty</code> ,      <code>OrderedQty</code>.  ,      OrderLine,   OrderedQty  Â« Â»  , ,    OrderedQty   .</p><br>
<p>   ,     ,    <code>OrderLine</code>. Celesta,    Â« Â»,        <code>OrderLine</code>,  <code>OrderedQty</code>.     â€” <code>materialized</code> â€”  CelestaSQL-     ,   -    !</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½“ç„¶ã€ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã¯ç‹¬è‡ªã®åˆ¶é™ãŒã‚ã‚Šã€å³å¯†ãªåˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">Celestaã§ã¯ã€GROUP BYã«ã‚ˆã‚‹é›†è¨ˆã‚’ä½¿ç”¨ã—ã¦ã€JOINãªã—ã§åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ä¸Šã«æ§‹ç¯‰ã•ã‚ŒãŸãƒ“ãƒ¥ãƒ¼ã®ã¿ãŒå®Ÿä½“åŒ–ã§ãã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã ã—ã€ã“ã‚Œã¯ã€ãŸã¨ãˆã°ã€å®Ÿéš›ã®ãƒ¬ãƒãƒ¼ãƒˆã§é »ç¹ã«ç™ºç”Ÿã™ã‚‹ã€å£åº§ã®æ®‹é«˜ã€å€‰åº«ã®ã‚»ãƒ«ã”ã¨ã®å•†å“ãªã©ã®æ®‹é«˜æ˜ç´°ã‚’ä½œæˆã™ã‚‹ã«ã¯ååˆ†ã§ã™ã€‚</font></font></p><br>
<h2 id="zaklyuchenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çµè«–</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Celestaã‚·ã‚¹ãƒ†ãƒ ã®ä¸»ãªæ©Ÿèƒ½ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã«èˆˆå‘³ãŒã‚ã‚‹å ´åˆã¯ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚ˆã†ã“ã</font><font style="vertical-align: inherit;">ã€‚</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja455736/index.html">ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãŠã‚ˆã³ãƒãƒ«ãƒãƒãƒ¼ãƒã‚¤ãƒ‹ãƒ³ã‚°ã«ã‚ˆã‚‹æš—å·é€šè²¨ã®ã‚³ãƒ³ã‚»ãƒ³ã‚µã‚¹</a></li>
<li><a href="../ja455738/index.html">ãƒ‡ãƒ¼ã‚¿ã‚’åç›ŠåŒ–ã—ã¦10å„„ãƒ‰ãƒ«ã‚’ç¨¼ãæ–¹æ³•ã¯ï¼Ÿ</a></li>
<li><a href="../ja455740/index.html">æŠ•è³‡ä¼šç¤¾ã§ã®æ©Ÿæ¢°å­¦ç¿’ï¼šãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚µãƒãƒ¼ãƒˆã®å‘¼ã³å‡ºã—ã‚’åˆ†é¡ã—ã¾ã™</a></li>
<li><a href="../ja455742/index.html">éŸ³æ¥½ã‚’ä½œã‚‹ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã‚ˆã‚Šã‚‚å„ªã‚Œã¦ã„ã‚‹å ´åˆ</a></li>
<li><a href="../ja455744/index.html">è¦–è¦šçš„ãƒªã‚¢ãƒªã‚ºãƒ ã‚’æ”¹å–„ã—ãŸè¿·è·¯é¢¨æ™¯ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ [Jinmo Kimã«ã‚ˆã‚‹è¨˜äº‹ã®ç¿»è¨³]</a></li>
<li><a href="../ja455754/index.html">æ¼‚æµã‚¹ãƒˆãƒ©ãƒˆã‚¹ã‚¿ãƒƒãƒˆã®ãƒ†ã‚¹ãƒˆã€‚ãƒ­ã‚´ã‚¸ãƒ³ã¨ãƒ­ãƒ©ã®æˆå±¤åœã¸ã®é€²æ°´</a></li>
<li><a href="../ja455756/index.html">ç›®ã§ã™</a></li>
<li><a href="../ja455758/index.html">å°å£²ãƒ­ã‚±ãƒƒãƒˆã®æˆé•·ãƒãƒƒã‚­ãƒ³ã‚°ï¼šä»®èª¬ã®æ¤œç´¢ã‹ã‚‰ãƒ†ã‚¹ãƒˆæ‰‹æ³•ã¾ã§</a></li>
<li><a href="../ja455760/index.html">SwiftUIã®é­”æ³•ã¾ãŸã¯é–¢æ•°ãƒ“ãƒ«ãƒ€ãƒ¼ã«ã¤ã„ã¦</a></li>
<li><a href="../ja455762/index.html">ãƒãƒ«ã‚³ãƒ•é€£é–ã®ç°¡å˜ãªç´¹ä»‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>