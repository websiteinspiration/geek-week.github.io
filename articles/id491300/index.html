<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¡ ğŸŒ‰ ğŸ™ STM32 Bagian 2: Inisialisasi ğŸ–Œï¸ ğŸ”œ ğŸ‘¨â€ğŸ«</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pemrograman adalah memecah sesuatu yang besar dan tidak mungkin menjadi sesuatu yang kecil dan sangat nyata.
 
 Halo semua, untuk mulai dengan, saya i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Bagian 2: Inisialisasi</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491300/"><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pemrograman adalah memecah sesuatu yang besar dan tidak mungkin menjadi sesuatu yang kecil dan sangat nyata.</font></font></blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Halo semua, untuk mulai dengan, saya ingin mengucapkan terima kasih kepada moderator karena melewatkan posting (menjijikkan) pertama saya, dan untuk menyapa ibu! Dan saya juga ingin mengucapkan terima kasih kepada semua pembaca dan orang-orang yang menunjukkan kesalahan saya dan membantu memperbaikinya. Saya segera membuat reservasi bahwa dalam bahasa Rusia saya tidak menulis dari kelas 6, secara umum, jangan marah. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32 Bagian 1: Dasar-Dasar</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Jadi mari kita mulai. Dalam artikel sebelumnya, saya dengan cepat menelusuri poin pertama. Ini adalah file startup.c kami, yang bertanggung jawab untuk 2 vektor (stack, Reset_Handler) dan sedikit tentang skrip linker. Hari ini kami akan menambah kode inisialisasi kami, menganalisis tautan untuk suku cadang dan mencari tahu bagaimana semuanya bekerja.</font></font><br>
<a name="habracut"></a><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika kode ini tidak jelas bagi seseorang, maka Anda dapat membacanya di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (artikelnya bukan air mancur, tetapi mencoba menjelaskannya). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang mari kita cari tahu apa yang hilang di sini dan bagaimana cara menambahkannya. Jelas, mikron memiliki vektor lain. Misalnya, vektor Hard_Fault adalah vektor yang dipanggil untuk tindakan yang tidak benar dengan Î¼, misalnya, jika ia mencoba menjalankan instruksi yang tidak dimengerti oleh prosesor, ia akan melompat ke alamat vektor Hard_Fault. Ada banyak vektor seperti itu dan bukan fakta bahwa dalam program kami kami akan menggunakan segalanya. Juga, vektor interupsi berada di tabel yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(Bagi mereka yang masih belum tahu apa itu vektor, ini adalah penunjuk ke alamat, alias "penunjuk"). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami melengkapi kode kami, dan kemudian saya akan menjelaskan apa yang saya lakukan.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Default_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">NMI_Handler</span><span class="hljs-params">()</span>   __<span class="hljs-title">attribute__</span><span class="hljs-params">((weak, alias(<span class="hljs-string">"Default_Handler"</span>)))</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HardFault_Handler</span><span class="hljs-params">()</span>   __<span class="hljs-title">attribute__</span><span class="hljs-params">((weak, alias(<span class="hljs-string">"Default_Handler"</span>)))</span></span>;
<span class="hljs-comment">//     </span><font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
    &amp;NMI_Handler,<font></font>
    &amp;HardFault_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Default_Handler(){
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini saya menambahkan fungsi baru Default_Handler (); yang akan menangani semua interupsi, tentu saja. Tetapi juga dengan bantuan, </font></font><code>__attribute__((weak, alias("Default_Handler")));</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">saya mencatat bahwa jika suatu fungsi dengan nama yang sama dideklarasikan, maka itu akan menjadi pengendali interupsi ini. Dengan kata lain, sekarang ini hanya nama panggilan untuk Default_Handler. Jadi kami dapat menambahkan semua vektor dalam daftar dari manual Referensi Anda. Ini dilakukan agar jika Anda tiba-tiba memutuskan untuk menggunakan interupsi, tetapi lupa membuat function handler, maka Default_Handler biasa dipanggil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya pikir pada titik ini dengan vektor Anda dapat menyelesaikan dan pergi ke inisialisasi sektor dan ke linker. Untuk memulai, mari perbarui startup.c kami lagi dengan menambahkan inisialisasi sektor data dan bss ke badan Reset_Handler serta beberapa variabel eksternal.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_sidata, *_sdata, *_edata, *_sbss, *_ebss;<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
<font></font>
<font></font>
	<span class="hljs-keyword">void</span> **pSource, **pDest;
	<span class="hljs-keyword">for</span> (pSource = &amp;_sidata, pDest = &amp;_sdata; pDest != &amp;_edata; pSource++, pDest++)<font></font>
		*pDest = *pSource;<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (pDest = &amp;_sbss; pDest != &amp;_ebss; pDest++)<font></font>
		*pDest = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, variabel baru, dan lagi mereka dideklarasikan dalam skrip linker kami. </font><font style="vertical-align: inherit;">Ingat kembali </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skrip sebelumnya</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dan juga membandingkannya dengan yang baru.</font></font><br>
<br>
<pre><code class="markdown hljs">MEMORY{
<span class="hljs-code">	ROM(rx) : ORIGIN = 0x08000000, LENGTH = 1M
	SRAM (rwx):     ORIGIN = 0x20010000, LENGTH = 240K
}
</span>
<span class="hljs-emphasis">_estack = LENGTH(SRAM) + ORIGIN(SRAM);

SECTIONS{
	.isr_</span>vector : {
<span class="hljs-code">	KEEP(*(.isr_vector))
	} &gt;ROM
	
	.text : {
        . = ALIGN(4);
        *(.text)
    } &gt;ROM
	
	_sidata = LOADADDR(.data);
        .data : {
		. = ALIGN(4);
		_sdata = .;
		*(.data)
		. = ALIGN(4);
		_edata = .;
	} &gt;SRAM AT&gt;ROM
	
	.bss : {
		. = ALIGN(4);
		_sbss = .;
		*(.bss)
		. = ALIGN(4);
		_ebss = .;
	} &gt;SRAM
}</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dua bagian baru telah ditambahkan, yaitu .data dan .bss. </font><font style="vertical-align: inherit;">mengapa kita membutuhkan mereka? </font><font style="vertical-align: inherit;">well. data akan meninggalkan variabel global dan statis akan pergi ke bss. </font><font style="vertical-align: inherit;">Kedua bagian ini dalam RAM, dan jika semuanya sederhana dengan bagian bss (ini hanya nol), maka ada beberapa kesulitan dengan bagian data. </font><font style="vertical-align: inherit;">Pertama, data sudah menginisialisasi data yang diketahui pada waktu kompilasi. </font><font style="vertical-align: inherit;">Dengan demikian, pada awalnya bagian data akan terletak di suatu tempat di memori flash. </font><font style="vertical-align: inherit;">Kedua, kita perlu menunjukkan ke skrip apakah ada di memori flash, tetapi itu akan ditransfer ke RAM selama eksekusi program. </font><font style="vertical-align: inherit;">Mari kita lihat sepotong skrip tempat kami menggambarkan bagian data.</font></font><br>
<br>
<pre><code class="markdown hljs">
<span class="hljs-code">        _sidata = LOADADDR(.data);
        .data : {
		. = ALIGN(4);
		_sdata = .;
		*(.data)
		. = ALIGN(4);
		_edata = .;
	} &gt;SRAM AT&gt;ROM</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu dimulai dengan deklarasi _sidata dan penugasan, pada saat ini, dari makna yang tidak jelas bagi kami. Selanjutnya, deskripsi bagian itu sendiri dimulai. Saya menyarankan Anda untuk membaca tentang fungsi ALIGN di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tetapi secara singkat, kami memberikan nilai (alamat saat ini) ke nilai kami yang lebih mudah diterima oleh prosesor kami ketika mencoba memuat data atau instruksi dari sana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Juga termasuk _sdata, _edata, dan bagian akhir. Tetapi pada akhir bagian ada yang kita butuhkan.</font></font><code>SRAM AT&gt;ROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Baris ini memberi tahu linker kami bahwa bagian tersebut ada dalam SRAM tetapi bagian ini dimuat ke ROM atau memori flash. Sekarang kembali ke variabel _sidata kami dan fungsi LOADADDR. Fungsi ini akan mengembalikan kita nilai yang akan sama dengan alamat bagian pemuatan. Yaitu, kami mengindikasikan bahwa bagian tersebut dimuat ke dalam memori flash, tetapi kami menggunakannya dalam RAM, dan untuk mentransfer bagian ini, kami perlu mengetahui alamatnya dalam memori flash, yang merupakan fungsi dari pengembalian LOADADDR. Sementara itu, variabel _sdata dan _edata menunjukkan lokasi bagian dalam RAM, sehingga memberi kita kesempatan untuk memuat bagian data ke dalam memori yang benar. Biarkan saya mengingatkan Anda bahwa ini adalah kode inisialisasi yang kami tambahkan di atas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengapa kita memerlukan tautan ini dan kesulitannya dengan distribusi bagian dari aplikasi kita? Bagian Data hanyalah contoh kecil mengapa kita harus dapat menempatkan dan menggeser bagian dalam memori. Di bawah ini adalah contoh dari bagian teks yang saya gunakan.</font></font><br>
<br>
<pre><code class="markdown hljs">.text (ORIGIN(ROM<span class="hljs-emphasis">_ITCM) + SIZEOF(.isr_</span>vector)): {
<span class="hljs-code">        . = ALIGN(4);
        *(.text)
    } AT&gt;ROM_AXIM</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inti dari blok ini adalah saya memuat bagian teks juga ke dalam memori flash tetapi menggunakan bus yang berbeda untuk mengakses instruksi dan akselerator ART (semacam seperti cache biasa). </font><font style="vertical-align: inherit;">Dan agar semuanya berfungsi, saya menunjukkan alamat muat dan alamat selama eksekusi kode, tetapi itu tidak akan berfungsi jika saya tidak menunjukkan bahwa bagian tersebut harus diimbangi. </font><font style="vertical-align: inherit;">Ada banyak lagi penemuan seperti itu, saya tidak akan menunjukkan semuanya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada tahap ini, bagian dimuat jika perlu dan diinisialisasi. </font><font style="vertical-align: inherit;">kami memiliki basis kerja untuk penulisan kode lebih lanjut. </font><font style="vertical-align: inherit;">Pada artikel selanjutnya, kita akan menulis driver pertama kita dan mengedipkan LED. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terima kasih atas perhatian Anda, dan sukses atas usaha Anda.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id491286/index.html">IPv6 hanya jaringan di pemerintahan AS</a></li>
<li><a href="../id491288/index.html">Ahli poligrafi menjadi gila satu per satu</a></li>
<li><a href="../id491294/index.html">Transaksi terdistribusi untuk database heterogen di MS .NET</a></li>
<li><a href="../id491296/index.html">Dagaz: A Persistence Story</a></li>
<li><a href="../id491298/index.html">Cara menemukan malware (tidak) dengan WinDbg</a></li>
<li><a href="../id491302/index.html">Klien OVPN di telepon Grandstream</a></li>
<li><a href="../id491304/index.html">Helsinki: kota kebahagiaan dan kenyamanan</a></li>
<li><a href="../id491308/index.html">ClickHouse - analisis data yang cepat dan intuitif secara visual di Tabix. Igor Strykhar</a></li>
<li><a href="../id491310/index.html">Cara memecahkan arsip kata sandi sendiri</a></li>
<li><a href="../id491312/index.html">Bagaimana kami mengambil saringan dari seorang lelaki dan membantu penggilingan itu</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>