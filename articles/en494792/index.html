<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêâ üëâüèæ ü§ö Yandex.Routing: how we plunged into logistics and decided to change the future üë®‚Äçüîß üêô üêÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This text arose due to the random coffee fun in Yandex - the system makes an appointment for two random employees if they indicated that they want to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Yandex.Routing: how we plunged into logistics and decided to change the future</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/494792/"><img src="https://habrastorage.org/webt/og/rb/na/ogrbnanpkk0zlisr_px0zrilcw0.jpeg" width="40%" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This text arose due to the random coffee fun in Yandex - the system makes an appointment for two random employees if they indicated that they want to participate in such meetings. My interlocutors found the story about what I was doing interesting, and now I got my hands on offering it to a wider audience. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before Habr, I gave a guest lecture at the Faculty of Computer Science of HSE and Yandex - I told the students of the FCS exactly the same thing, which I will tell you about now (at the end of the post there is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">Namely, how traveling with drivers delivering orders from online stores convinced our team to make a new service about logistics. </font><font style="vertical-align: inherit;">I hope I can manage to convey to you my feelings from this area: I traveled to Gazelles and Largus, listened to complaints from employees about the picky ‚Äúaunt from Noginsk‚Äù and witnessed how an order of three scooters for three children turned into a drama . </font><font style="vertical-align: inherit;">And in the end, let's talk about technology.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 1. How it all began</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A few years ago, walking around the office thinking about whether it‚Äôs time for me to change something in my life, I almost accidentally ran into a corridor with a colleague whom I respected greatly on one of my past projects. It turned out that he switched to an internal startup, and they are just looking for an analyst. So I ended up in a division called B2BGeo. This small group at that time was supposed to do some kind of thing for companies based on Yandex geo-services - only no one knew which ones. Historically, geoservice employees have made desktop Yandex.Maps, Maps, Navigator and Metro mobile applications. Also, this unit includes an impressive infrastructure: development of a routing engine, a map service, recognition of road signs, extraction of data from satellite images, and much more. Both web maps and Yandex.Navigator are applications,intended for the mass user. Of the services for companies, we had only a set of mapping APIs: a JS map widget for sites, MapKit for applications, and a REST route building API.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So the B2BGeo team, before starting to sell products for companies, had to come up with these products. We spent some time on market research and prototyping. The prototypes were interesting, for example, a map of the quality of a cellular signal inside buildings. Then the cellular operators did not use the huge amounts of data that they have, measured quality mainly on the streets and in a rather primitive way. Another example of a prototype is a universal customizable router with machine learning. By the way, hereinafter referred to as a router and router is not network equipment, but a route-building program.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some prototypes did not take off, others would not be interested in a sufficient number of companies. Something larger was needed. In the future, it will turn the world around and open new horizons, and for a start it will bring significant benefits through geotechnologies. We had a strategic session: we left the office and brainstormed for two days. Based on the results of the session, we identified an industry where there are sufficient prospects for us. Our choice fell on logistics.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Russia, a lot of commercial vehicles, many transport and courier companies carry something somewhere. And all of them, most likely, make their routes either manually or with the help of programs that probably do not work very well, because they do not take traffic jams into account. And behind us there was a whole Yandex with a lot of hardware, only a small number of companies (only a rare example - Google) had sample data, and good programmers. Competencies in this area are rare and valuable: Uber at some point </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bought out a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> whole cartographic team.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encouraged by this prospect, we agreed with one of the delivery aggregators (a company that delivers orders from various online stores) so that they would let us look at their work from the inside out, "immerse themselves in the industry." </font><font style="vertical-align: inherit;">The members of our small team traveled with couriers delivering orders, and sat next to the logistician who plans the routes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 2. Immersion in the industry</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8 am, one of the industrial zones behind the Third Ring Road, where the warehouse and office of the aggregator are located. A small room, reminiscent of the post office: the corner is fenced with a desk, inside - logistic computers, telephones, printers. Greasy chairs and computer chairs with cracked dermantine. A box with cheap Chinese phones, a paper with a number is glued on each - they are handed out to drivers. There are simple sofas-banquets along the walls, a stand with printouts at the exit: transportation rules, some kind of internal instructions, a table of fines - for example, 200-300 rubles will be taken from the driver for an undelivered order. The aggregator also has a normal office, where the director, managers and bookkeeping are sitting at beautiful tables, but the key events for us are happening in this small room.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/of/e5/xz/ofe5xz8z3wc9fqrfzec1x43ouya.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Drivers smoke outside, but it‚Äôs cool there, most are inside, so it‚Äôs crowded and stuffy in the room. Mat-remat in three floors, many gloomy in the morning, someone wants to get his bundle of invoices and leave to load, someone has a hitch, he is unhappy. The situation is tense, there are two logisticians, and they are in the soap. We are told that this is a normal day, just in the morning, when leaving for routes, there is always a park. At night, when the planning went on, there was also a drowning, somewhere in an hour the tension will decrease, and the logistician will be able to rest. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Several drivers are told that Yandex will go with you. They are surprised and not particularly happy - it is not clear why they are so happy and whether they have set us to follow them. We, </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">office</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> workers, IT workers with backpacks, are in stark contrast to this gloomy men.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I got the Gazelle, it has a driver and a forwarder, I sit down third with a backpack in my arms and try not to take up too much space. Orders are already loaded into the body, we start. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o_/az/6k/o_az6km31b8hwmpzop9wf0shmks.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Later I learned that usually precedes the departure of cars on the route.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose today is Wednesday, you order a refrigerator on a small site that you found on Yandex.Market, this store has the best price and reasonable reviews. Delivery is possible only on Friday, it suits you. The site is really just a showcase; for very small sites, the manager who confirmed the order can generally be the only employee. Your refrigerator is located somewhere in a warehouse near Podolsk along with other refrigerators of the same company (a small store does not have its own warehouse - in fact, the sale is from the manufacturer‚Äôs warehouse). The manager reserves this refrigerator and sends the order to the delivery aggregator. During Wednesday, the aggregator collects orders and on Thursday sends a large truck to Podolsk for your and other refrigerators ordered in other stores.All this comes to the warehouse rented by the aggregator in the Moscow industrial zone.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On Thursday evening, when all the goods to be delivered on Friday are collected at the warehouse, logisticians sit down for work. By 4-5 in the morning they should distribute orders by machine, warehouse workers will put the goods in heaps, each machine has its own heap - you need to leave them a margin of time for this work. A bunch will be loaded into the car, and it will go to please customers.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/y_/sg/qay_sg2fm9qw0d04daann-jogms.png" width="35%"><img src="https://habrastorage.org/webt/kz/2w/sa/kz2wsatnelv2nd7bqmg0yrx2qqq.jpeg" width="35%"><br>
<img src="https://habrastorage.org/webt/r6/xq/9o/r6xq9oh7amzcw_df7w8ao8ygwbc.png" width="70%"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To distribute orders by machine, the logistician uses a specially purchased program. It integrates with 1C: Enterprise, data on machines (allowable weight and volume of cargo, cost of a day of work) and on goods (weight, volume, address and delivery interval, customer contacts, comments) are loaded into it. Some of the cars belong to the aggregator, this one had heels (Lada Largus) and Gazelles (Gazelle / Ford Transit / Hyundai Porter). There were also hired couriers on personal vehicles, usually on station wagons (we saw Ford Focus, Mitsubishi Pajero and even some old Lexus).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The program was written by good programmers, it knows how to distribute loads on cars and build the optimal (by time or mileage) route to avoid orders, given a bunch of parameters. But the logistician does not use this functionality in any way. But he actively uses the visualization of orders on the map. The program allows you to draw polygons-areas on the map and display statistics of cargo and routes inside these areas. Logisticians divided all of Moscow and Moscow Region up to the Big Concrete (highway A108) into zones of approximately the following type: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bz/mx/wu/bzmxwueya97nevpbqh7mbfxxar4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the center, there are some small areas, and then radial sectors begin that run along major highways and encompass the region.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In each such zone, certain drivers work, who are usually familiar with it, know the roads, the features of the traffic, know where the traffic cops are, what restrictions and signs are for trucks. The logistician, in turn, knows how many orders the crew can carry. He gives more experienced under 30 orders, and for those who have started working recently, 20-25 orders. He looks at how many orders are in a certain area, and if there are too many, he throws them to the next one. Or adds from a neighboring: let's say, the logistician is friends with some drivers and gives them ‚Äúlight‚Äù orders, which are likely to be on the way. And the unloved driver can annoy. For example, to toss an order for a client, about whom it is known in advance that he is picky, will require delivery strictly at the indicated time, will print all the goods, will examine them for a long time. Besides,the logistician can simply give the driver fewer orders: for each order the driver receives 200 rubles, he is interested in having more.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ability to plan routes in the program is completely ignored. This possibility does not make sense in such a system: if the logistician tells the driver how he needs to go round the orders, the driver will answer him: ‚ÄúYou are sitting in the office there, and I‚Äôm in this area like the back of my hand‚Äù. So the logistician only assigns orders for the car, the task for the driver is formulated as a pile in the warehouse and a pile of printed invoices. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, back to the Gazelle. Our region is the Enthusiasts highway and further towards Noginsk, there will be about 15 orders to the Moscow Ring Road, I will go there. The driver leaves for the Third Transport Ring, at which time the forwarder takes a pack of invoices and transfers them in the correct order. The correct order is this:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- First, we will drive along the Enthusiasts highway towards the Moscow Ring Road and take all orders that are on the right. We don‚Äôt always take it on the left, there may be traffic jams when crossing the highway, it‚Äôs better to take them in the evening. Then we‚Äôll leave for the region, we‚Äôll take it there. In the evening we will go back and carry the rest. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- But, for example, the first order in the pile - with the wish ‚Äúafter 14 hours‚Äù? Leave it for the evening? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- It is possible for the evening, but it‚Äôs better to try to agree to give it now. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The negotiation process was immediately demonstrated. At 9:30, the forwarder called the phone order after 14 hours:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Hello, delivery, we are already in your area, can you accept the order? .. We will go to the region after your area, and we won‚Äôt return here before evening. Maybe we‚Äôll return after nine, or maybe we‚Äôll stay completely in the region, this is an unpredictable business, we may have to postpone the delivery the next day ... Well, then we‚Äôll arrive in 15 minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was then that I realized where the couriers come from, who say: "Hello, I‚Äôm already with you!" - and completely ignore my comments and delivery interval!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Colleagues who drove in other cars told me that someone had a driver or forwarder honestly called the client an hour before delivery. Mine were not very sociable, they called for about fifteen minutes, pronounced the comments of customers aloud. Simple wishes (‚Äúdo not call the intercom, the child is sleeping‚Äù) were taken into account, but everything that influenced the route was usually ignored. Shifting invoices, the forwarder fished out an order that had to be taken to a village a few kilometers from Noginsk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Oh, this aunt again. Remember, she had an order, then a return on marriage? Now a new order. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Yeah, raise the washing machine again. Another interesting one is: ‚Äúplease deliver from 12 to 16‚Äù. How does she imagine it? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Yes, in general, they do not understand what they are writing.</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I think so: if you order a washing machine in Noginsk, then sit there and wait calmly until it is brought. Either agree somehow with the neighbors, or take leave of work. We cannot go to her this Noginsk every day.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
I got off near the Moscow Ring Road, and the driver took the Gazelle further along the Gorky Highway. In fact, they are not bad guys, and despite the buzz against customers (it amounted to at least two-thirds of all conversations), they most likely would have managed to deliver the washer to 16. Simply if they hadn‚Äôt, they would not even bother.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My second trip took place in a smaller car: the cargo Largus drove around the North-Western Administrative District. The cargo was small, no refrigerators, so the driver was alone. Uncle got sociable, we talked a lot about him. He said that in general he is a master of sports in wrestling, works as a coach, but now everything is deaf, so he moonlights as a courier. The money is small, but the increase is pleasant: about 2 thousand are obtained per day. It‚Äôs easy to deliver orders, it works when it wants. Of course, there are nuances: you come across unpleasant customers, you have to eat stored sandwiches in the car, you are in a hurry, you don‚Äôt even go to the toilet, you have to ask customers. But on the whole, he is quite prosperous, for him it is more likely entertainment.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's funny: colleagues, especially girls, delivery service employees also told stories that ‚ÄúThe courier is not the main job, but purely for the soul‚Äù, ‚ÄúIn general, I usually go in a behhe‚Äù, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I remember that in the area of ‚Äã‚ÄãRublevka or Krylatsky such a conversation: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- Once in the City he brought an order, there they have apartments in a skyscraper, the corridors are all in marble, I go into the apartment - carpets, paintings in golden frames, some fur coats hang, which just isn't there. An order for 5800, so he asked for a change of 200 rubles, count up ?! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- So, maybe he has fur coats and paintings precisely because he saves even 200 rubles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After my words, the driver thought hard. And an hour later we arrived in Schukino and I ‚Äúunderstood everything‚Äù about this business.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the next overhead pen, a note was made that not everything was in order with the order: out of three purchased children's scooters with a total value of 20 thousand rubles, only two were in the car. The driver called the logistician. It turned out that the woman made an order for three scooters on Monday, but yesterday, Wednesday, the third scooter was mistakenly put in the wrong car. And it was a private car, for some reason he didn‚Äôt return to the warehouse in the evening, as the ‚Äúregular‚Äù drivers do, and the scooter still rides with it. We could try to intercept him, but today he goes about his business, it is impossible to cross. Next time he will work tomorrow (Friday), but this is not accurate. It is guaranteed to reunite all three scooters and take them all at once will only be possible on Saturday.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Armed with this information, the driver called the client. </font><font style="vertical-align: inherit;">There was a very displeased woman. </font><font style="vertical-align: inherit;">She said: on Saturday at 10 am they have a family holiday, where they wanted to give scooters to her three children. </font><font style="vertical-align: inherit;">Therefore, she needs them strictly in the amount of three pieces, she does not agree to a partial redemption and does not understand how it is possible at all - she placed the order on Monday, and now we, the scooter store, are substituting her for that. </font><font style="vertical-align: inherit;">Delivery on Saturday at an indefinite time does not categorically suit her. </font><font style="vertical-align: inherit;">Tomorrow she is at home before dinner, if you cannot today or tomorrow morning, she cancels the order and curses the store to the third knee (and you can understand it).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 3. Local minimum</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The store buys an order delivery service from a courier company. For undelivered scooters, he will fine a courier company for 500 rubles. The company will fine its storekeeper and driver who did not bring the scooter back on time by 200-300 rubles. An upset woman will give her 20 thousand to a more agile store, and one star on Yandex.Market will slap this. The store can provide the best service, but the "last mile" is carried out by gloomy men at Gazelles and Largus. If they behave badly with customers, the store will not be able to influence this.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, the store usually looks for the lowest cost delivery - in the sense that if you pay drivers even less, they will go to work as taxi drivers or somewhere else. Drivers optimize their daily earnings - you need to carry more orders and not be fined. If we compose a global cost function that describes the system as a whole, then this state of the function will certainly correspond to its local minimum, the ‚Äúpotential well‚Äù.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o0/gl/pe/o0glpeevpeoucvi20vgzt5yn6fk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are clearly large, systemic problems in this pit. Firstly, the most difficult work was handed over to the most unskilled employee: the driver controls the machine and plans the route and communicates with the client. He also carries money. He has additional skills and specializations - for example, the ability to deliver 30 orders per day in a certain area. It turns out that the company must train inexperienced drivers, and experienced ones not to lose, because they (unfortunately for the company) are difficult to replace.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secondly, the delivery process is completely unpredictable. The client does not know what time they will come to him. The customer is usually offered wide delivery windows - four, six hours or more. This creates great inconvenience for him: it is not always possible to sit in one place for six hours. And even drivers cannot always get into these windows. The opportunity to make narrower windows convenient for customers (two hours, or better an hour) is possible only for large companies that were able to push harder and jump out of a potential hole into a more optimal state. We are talking about companies with their own delivery and couriers. ‚ÄúOwn‚Äù couriers would be useful to all companies: this way you can control the quality of their work and even do some kind of upsale (when the courier offers a person something to buy to order).But keeping a staff of couriers is very expensive - only the largest companies like WildBerries or Lamoda can afford it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thirdly, logisticians are constantly cheating. Tricks such as overloading cars and breaking drivers' shifts are considered commonplace (instead of 8 hours, they work 10-12). ‚ÄúIt's okay - if it does not fit in the volume, then he will put the excess in the cab‚Äù - even this happens. For this, fines are imposed, especially for overloading trucks: to the fine itself (from one hundred thousand rubles per company) will be added compensation for damage to the roadbed. It is considered to be a multiplication of the overload coefficient by a distance and can easily reach hundreds of thousands of rubles. Fleet owners would love to drive without breaking. But suppose the logistician has a choice: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- ‚ÄúShove the extra pallet, a little exceeded‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- ‚ÄúAdd the extra car, increase costs, but without breaking‚Äù </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- ‚ÄúSit for another half an hour and make a plan properly‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Often he chooses the first.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a depressing picture inspired us with great optimism. </font><font style="vertical-align: inherit;">We conducted several interviews with companies in other branches of logistics, such as the delivery of large goods, the delivery of documents. </font><font style="vertical-align: inherit;">All our hypotheses that the world is not perfect in this place have been confirmed. </font><font style="vertical-align: inherit;">So, before us a large window of opportunity opened. </font><font style="vertical-align: inherit;">We eagerly set to work.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 4. MVRP and traffic jams</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below are the technical details of our product, so let's start with the definition. </font><font style="vertical-align: inherit;">MVRP is a multiple vehicle routing problem, that is, a task in which you need to optimally go around several locations, having a fleet of several cars. </font><font style="vertical-align: inherit;">We use terminology in which a similar task for a single machine is called SVRP (single VRP). </font><font style="vertical-align: inherit;">It differs from the classic traveling salesman problem (TSP, traveling salesman problem) by the presence of delivery windows. </font><font style="vertical-align: inherit;">There seems to be no common terminology: in the </font><font style="vertical-align: inherit;">Wikipedia </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the tasks we solve are called the complex abbreviation VRPPDTW (VRP with pickup-and-delivery mode and delivery windows). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Programs that solve such problems are traditionally called ‚Äúsolvers‚Äù. </font><font style="vertical-align: inherit;">For versatility, you need to put a bunch of options and restrictions in the solver:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examples of additional options</font></font></b><div class="spoiler_text">‚Äî    ,  .<br>
‚Äî    (,  ),   .<br>
‚Äî         (      ,        ).<br>
‚Äî      .  ,         :   ,      .<br>
‚Äî      .<br>
‚Äî   .<br>
‚Äî         (,      -),      :           .       ,    *   .<br>
‚Äî     ¬´¬ª ,      .          ,   ,  -        .<br>
‚Äî   : ,        .</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are several types of algorithms that can be used in solvers. For example, there is a large group of universal open source and paid constraint solvers (Google OR-Tools, OptaPlanner, Choco-solver). Within each of them, a functional is built that is optimized taking into account the required restrictions. Such solvers are usually able to solve a whole bunch of tasks: VRP-tasks, scheduling, optimal allocation of resources in the cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are also many commercial solutions tailored specifically for MVRP tasks and ready for integration with enterprise management systems. VeeRoute, Maxoptra, Antor are known in Russia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solver Yandex.Routing uses a combination of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">annealing simulation algorithm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and genetic algorithm. We do not know what competitors are using, but most likely something similar. According to our measurements, in VRP-tasks constraint-solvers very much lose to commercial solvers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i7/zb/-s/i7zb-sjhxjxpnhcslcrfiysfwwi.gif"><br>
<b><sup><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution of the TSP-problem of the roundabout of states in America</font></font></sub></sup></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
I‚Äôll immediately make a reservation: the topic of solving the MVRP-problem is so great that in the article we will not discuss it in detail, but rather we will write a separate article.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main input for a solver is a matrix of distances between points involved in planning (order points plus one or more depots). In fact, this is not one matrix, but two: by mileage and travel time. It is through these matrices that optimization is done. As already mentioned, Yandex, unlike the developers of other commercial solutions, has traffic information. That is, for us, the matrix is ‚Äã‚Äãnot constant, but changes in time, and we take this into account in the solver. As far as we know, no one does this in the world: even knowing everything about traffic jams, it is difficult to build a set of distance matrices with reasonable discretization (sufficient to ensure that the resulting routes are good). The fact is that the number of matrix cells grows quadratically from the number of orders.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose we are solving a VRP task for delivering 10,000 orders using a fleet of 500 cars. Then we get two huge matrices that change in time. Downloading them on the network alone will take a lot of time, but their contents must first be calculated. If this is not done efficiently enough, we will need to wait a couple of hours until the matrices are built and downloaded, and only then can the solver be launched. The Dijkstra algorithm helps us here: the calculation of large distance matrices can be realized in almost linear (from the matrix size) time. But our team will also talk about this in a separate article in the coming weeks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we built a smart solver, parallelized it to a bunch of cars, made a router with ultrafast distance matrices that take into account traffic jams, and also figured out how to put these matrices into the solver. </font><font style="vertical-align: inherit;">As a result, they got the opportunity in 15 minutes to solve the problem of driving around 3,000 locations. </font><font style="vertical-align: inherit;">Result on the map:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tr/gn/vn/trgnvn5-ffqkfcybc6qfw-drwxi.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part 5. Results and difficulties of implementation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can compare our routes and those built by logisticians who plan trips manually or (sometimes) in semi-automatic mode using competitor programs. In a typical case, our solution allows you to beat logisticians by an average of 20% with a small route in optimality. At the same time, the time to get the finished route is much lower - 15 minutes instead of a few hours. In a wonderful future, the logistician should turn from a nervous exhausted person scattering orders by cars in the middle of the night, into a respectable member of society. He will use our automatic planning and occasionally correct single edge cases with his hands.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The implementation went most smoothly when customers bought our solution at the time of opening their delivery service. But most of our customers are not new. They already have an implemented solution for logistics, and the larger the client, the stronger it has overgrown with all sorts of features of the processes of this particular company, and just crutches. Their development and support is carried out by their own or hired IT-service. It is believed that large companies (even if the advantages of our product are obvious to them) can implement Routing only together with a major update of the IT infrastructure. And this usually happens every few years. In May 2018, our newborn service was announced at the YaC 2018 conference in partnership with IKEA. Six months later, the implementation began, we began to exchange data,and a year later at the industry conference on logistics, the project manager at IKEA spoke about the results.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The results were positive, but a little unexpected for us. </font><font style="vertical-align: inherit;">For example, informing customers increased their satisfaction and significantly reduced the number of calls to the call center (before, without knowing anything about the fate of the sofa, people were nervous and started calling).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Or another example - with oil industry workers.</font></font></b><div class="spoiler_text">   ,       .        ,       . ,   ¬´ ¬ª ‚Äî        .      ,       ,        ,   ¬´¬ª    ( ,  YouTube    ,   ).    ,        (  ,   ),           ,       .   :       ‚Äî       ,      ,  ,         . .           .</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, it turned out that our initial installation is not entirely correct. </font><font style="vertical-align: inherit;">We thought that we would sell an effective detour of points, but it turned out that companies need different products that affect different indicators, and not only and not so much on efficiency. </font><font style="vertical-align: inherit;">Fortunately, we supply several more with the core technology product. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Smaller companies are better at overcoming integration difficulties, but may face human factors. </font><font style="vertical-align: inherit;">It is very difficult to convince the driver to follow the planned route and keep the phone with the tracking application turned on. </font><font style="vertical-align: inherit;">This is somewhat reminiscent of stories about peasants of the 19th century breaking mechanized mowers and plows. </font><font style="vertical-align: inherit;">Everything, of course, is not so sad, but there is resistance to progress.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a short time, we managed to build a product that, we hope, will turn all the logistics in the country (or at least affect it strongly). </font><font style="vertical-align: inherit;">Our current customers and Yandex believe in us. </font><font style="vertical-align: inherit;">The latter is also important: yes, the internal startup is calmer than the startup outside the company, but we also need to show the result. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We started with an emphasis on large companies, in our future plans - to lower the threshold for entering the service. </font><font style="vertical-align: inherit;">You can play around with solving SVRP problems directly on Yandex.Maps: when you add a fourth point to the route, the ‚ÄúOptimize‚Äù button appears, which calls our solver.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/iq/cn/kaiqcnhai128l_r83lj18fe2lgm.png"><br>
<br>
<a name="video"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video of the same story for students of FCN in HSE:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8yDh9Q7shag" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All the best routes!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494780/index.html">Revelations and fears of an Amazon employee in the era of the coronavirus</a></li>
<li><a href="../en494782/index.html">Classify images on Android using TensorFlow Lite and Azure Custom Vision</a></li>
<li><a href="../en494784/index.html">DBLog - a common framework for Change Data Capture</a></li>
<li><a href="../en494786/index.html">MitM-like RTOS support in GDB</a></li>
<li><a href="../en494788/index.html">How email works</a></li>
<li><a href="../en494794/index.html">We have long arms</a></li>
<li><a href="../en494798/index.html">Snowden: pandemic will end, but surveillance of the population will remain</a></li>
<li><a href="../en494800/index.html">Reverse engineering of Chinese USB IR transceiver protocol</a></li>
<li><a href="../en494804/index.html">‚ÄúSorry, I recognized ...‚Äù or recognize raspberries and controllers using the Tensorflow Object Detection API</a></li>
<li><a href="../en494806/index.html">Cyber ‚Äã‚Äãtargets 2019 as trends 2020 - hackers have changed focus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>