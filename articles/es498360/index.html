<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëí üçª üëàüèæ Evaluaci√≥n integrada de m√©tricas de carga del servidor üê∑ üç∏ üë©üèº‚Äçü§ù‚Äçüë®üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Al trabajar en uno de los bancos m√°s grandes del pa√≠s, tuve que enfrentar la tarea de evaluar la eficiencia del uso de recursos de aproximadamente 16 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Evaluaci√≥n integrada de m√©tricas de carga del servidor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498360/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al trabajar en uno de los bancos m√°s grandes del pa√≠s, tuve que enfrentar la tarea de evaluar la eficiencia del uso de recursos de aproximadamente 16 mil servidores. </font><font style="vertical-align: inherit;">La tarea se formul√≥ de manera muy simple: fue necesario desarrollar una metodolog√≠a para evaluar las m√©tricas de carga del servidor durante un per√≠odo. </font><font style="vertical-align: inherit;">Idealmente, la carga del servidor por per√≠odo debe estimarse utilizando uno o varios (no m√°s de 8) n√∫meros.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algunas palabras sobre las caracter√≠sticas del uso de servidores virtuales</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las grandes organizaciones (especialmente los bancos) tienen un abigarrado zool√≥gico de aplicaciones heredadas implementadas en diferentes servidores que utilizan una variedad de tecnolog√≠as de virtualizaci√≥n. Una nube privada es una tecnolog√≠a prometedora, pero en realidad, las grandes organizaciones utilizar√°n durante mucho tiempo varias plataformas de virtualizaci√≥n para implementar una variedad de aplicaciones.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A medida que las plataformas de virtualizaci√≥n evolucionan, llega un momento en el que nadie en la empresa puede comprender cu√°n eficientemente se utilizan los recursos. Incluso las herramientas de monitoreo m√°s avanzadas no brindan una respuesta a esta pregunta debido a varios escenarios de uso del servidor. Por ejemplo, un departamento puede tener un servidor de informes que se cargar√° completamente solo por un per√≠odo limitado de tiempo. Digamos 3-4 horas al final del mes. En escenarios de la vida real, nadie asigna recursos din√°micamente para dichos servidores; esto es dif√≠cil t√©cnica y organizativamente. Los recursos se asignan espec√≠ficamente para la carga m√°xima peri√≥dica del servidor, aunque ocurre con poca frecuencia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resumen, en grandes organizaciones, los recursos de la granja virtual se gastan de manera extremadamente ineficiente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, propongo una metodolog√≠a con la que puede justificar f√°cilmente el aumento y la disminuci√≥n de los recursos asignados al servidor virtual, independientemente del escenario.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metodolog√≠a</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para evaluar la carga de recursos, es necesario recopilar estad√≠sticas de varios contadores; para evaluar la carga de recursos, se utilizar√°n varias m√©tricas. Convencionalmente, los contadores se pueden dividir en 2 tipos (de acuerdo con la tasa de cambio): "r√°pido" y "lento". Un buen ejemplo de un contador "r√°pido" es el contador de carga del procesador (% CPU). Un ejemplo de contador lento es el porcentaje de espacio libre en el disco duro (% FreeSpace). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La evaluaci√≥n de contadores lentos consiste en calcular el valor extremo (m√≠nimo o m√°ximo) de la m√©trica para el per√≠odo. Este enfoque permite (por ejemplo, al evaluar el espacio libre en disco) estimar el recurso libre y, si es necesario, asignar vol√∫menes adicionales o reducir los actuales.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para contadores r√°pidos, se utiliza un enfoque diferente. Las desventajas de usar m√©tricas integrales simples (promedio, m√°ximo, m√≠nimo y mediana) para evaluar la din√°mica de dichos contadores se describen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Las desventajas comunes incluyen la falta de informaci√≥n sobre el aumento de las cargas (medio y pico). Si tomamos el valor m√°ximo para el per√≠odo como una m√©trica integral, entonces la presencia de valores at√≠picos (por ejemplo, carga instant√°nea de la CPU de hasta el 100% cuando se inicia el programa) no dar√° informaci√≥n objetiva. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">articulo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se propone utilizar el cuantil 0.9 para estimar la m√©trica r√°pida (este es un valor que indica el nivel por debajo del cual se encuentra el valor observado en el 90% de las muestras). Con una carga de servidor uniforme de acuerdo con esta m√©trica, podemos estimar adecuadamente la carga promedio del procesador. Pero este enfoque tiene los mismos inconvenientes: la falta de informaci√≥n sobre el aumento de las cargas (medio y pico). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, como ilustraci√≥n, el gr√°fico semanal y diario del contador% CPU. El valor m√°ximo del contador en los gr√°ficos fue del 100%.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ym/al/xi/ymalxitgoyqlsthnyhs0cjttbie.png"><br>
<br>
<img src="https://habrastorage.org/webt/wj/xk/aj/wjxkajy2y3enm93easqblqnl-x8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El gr√°fico muestra que durante el per√≠odo indicado hay una explosi√≥n de carga, que dura aproximadamente 3 horas. Para este contador, se calcul√≥ una variedad de m√©tricas para la semana. La Figura 2 muestra que la mediana (l√≠nea verde, valor del 5%), promedio (amarillo, valor del 12%) y el cuantil 0.9 (rojo, valor del 27%) filtran el cambio de carga y se pierde informaci√≥n al respecto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como desarrollo de la idea de cuantiles, me gustar√≠a proponer la idea de un cuantil m√≥vil. Este es un an√°logo de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">media m√≥vil.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pero el cuantil 0.9 se usa como una funci√≥n de ventana. </font><font style="vertical-align: inherit;">Adem√°s, utilizaremos 2 cuantiles deslizantes para estimar el nivel del contador: r√°pido con un per√≠odo corto (1 hora) y lento con un per√≠odo largo (24 horas). </font><font style="vertical-align: inherit;">Un cuantil r√°pido filtrar√° las emisiones instant√°neas y proporcionar√° informaci√≥n sobre la carga m√°xima. </font><font style="vertical-align: inherit;">Un cuantil lento le permitir√° estimar la carga promedio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver en los gr√°ficos, los cuantiles m√≥viles de 0.9 son caracter√≠sticas din√°micas (marr√≥n - r√°pido, p√∫rpura - lento). </font><font style="vertical-align: inherit;">Para simplificar, evaluar el estado del contador como m√©trica que se propone utilizar:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el valor cuantil m√°ximo con un per√≠odo de 1 hora, que muestra la carga m√°xima continua del servidor para el per√≠odo,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el valor cuantil promedio con un per√≠odo de 24 horas, que muestra la carga promedio del servidor para el per√≠odo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el gr√°fico, el valor m√°ximo del cuantil r√°pido es la l√≠nea negra al 85%, el valor promedio del cuantil lento es la l√≠nea rosa al 30%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, al analizar la carga de recursos del servidor (de acuerdo con el contador del% de CPU), si tomamos el promedio del mes (12%) como una m√©trica, podemos tomar una decisi√≥n err√≥nea de reducir los recursos asignados. </font><font style="vertical-align: inherit;">La m√©trica cu√°ntica de doble movimiento r√°pido / lento (85 y 30%) muestra que hay suficientes recursos asignados, pero no hay excedentes.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La implementaci√≥n de la evaluaci√≥n de la eficiencia del uso de los recursos se ha descompuesto en 3 tareas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recopilaci√≥n de datos </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desarrollo de metodolog√≠a de evaluaci√≥n </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementaci√≥n de metodolog√≠a en la arquitectura actual </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arriba, examin√© la tarea 2 de esta implementaci√≥n, a continuaci√≥n hablaremos un poco sobre la tercera tarea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los datos se recopilaron en la base de datos ClickHouse. Esta columna DBMS es ideal para almacenar datos de series temporales. Esto se discuti√≥ en detalle en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouse Meetup</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el 5 de septiembre de 2019. Una comparaci√≥n de ClickHouse con otros DBMS de series de tiempo se puede encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de la recopilaci√≥n de datos, formamos varias tablas en las que los datos se organizaron l√≠nea por l√≠nea (los valores de cada contador se escribieron en una l√≠nea separada). Y, por supuesto, hubo problemas con los datos sin procesar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer problema es la desigualdad de los intervalos entre las entradas del contador. Por ejemplo, si el per√≠odo est√°ndar de grabaci√≥n del contador fue de 5 minutos, a veces hubo lagunas y el siguiente registro fue m√°s de 5 minutos (hasta 20 minutos) del anterior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo problema es que a veces los datos del contador llegaron 2 o m√°s veces (con valores diferentes) con la misma marca de tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y el tercer problema: ClickHouse no tiene funciones de ventana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver el primer problema, puede usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASOF JOIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La idea es bastante simple: para cada contador de cada servidor crear una tabla de manera uniforme con intervalos de tiempo llenos de manera uniforme. El uso de ASOF JOIN permite llenar los valores de la nueva tabla con los valores m√°s cercanos de la tabla de datos sin procesar (se pueden configurar opciones de llenado similares a ffill y bfill). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soluci√≥n al segundo problema es la agregaci√≥n con la elecci√≥n del valor m√°ximo en un momento dado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver el tercer problema, se consideraron varias soluciones. </font><font style="vertical-align: inherit;">Primero, el script Python fue rechazado debido a un rendimiento insuficiente. </font><font style="vertical-align: inherit;">La segunda soluci√≥n, copiar datos sin procesar a una base de datos MSSQL, calcular m√©tricas y volver a copiar, parec√≠a demasiado complicada de implementar. </font><font style="vertical-align: inherit;">MSSQL tambi√©n tiene funciones de ventana, pero no se necesita una funci√≥n agregada. </font><font style="vertical-align: inherit;">Uno podr√≠a estar perplejo y escribir su propia funci√≥n SQL CLR. </font><font style="vertical-align: inherit;">Pero esta opci√≥n fue rechazada debido a la excesiva complejidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una soluci√≥n de trabajo podr√≠a ser un script SQL para ClickHouse. </font><font style="vertical-align: inherit;">Un ejemplo de este script se da a continuaci√≥n. </font><font style="vertical-align: inherit;">Para simplificar, busqu√© calcular solo el cuantil r√°pido para un solo contador para m√∫ltiples servidores. </font><font style="vertical-align: inherit;">La soluci√≥n no parece muy simple y no muy conveniente, pero funciona.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, se cre√≥ un informe de prueba en PowerBI para demostrar la metodolog√≠a. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qk/t9/kgqkt92tcilmz8h9gqieermwz3w.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/c_/m5/tk/c_m5tk-r1ehlvrdhh_dbsj3rzie.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conclusi√≥n, me gustar√≠a especular sobre el desarrollo de la soluci√≥n. </font><font style="vertical-align: inherit;">Si observa la soluci√≥n desde el punto de vista de los almacenes de datos, puede ver que de esta manera se resuelve la tarea de crear un almac√©n de datos (Almac√©n de datos) a partir de una capa de datos sin procesar (√Årea de ensayo). </font><font style="vertical-align: inherit;">Puede analizar la arquitectura, pero para ClickHouse como una base de datos de columnas, la normalizaci√≥n no es cr√≠tica (o incluso perjudicial). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El desarrollo adicional del repositorio se ve en la creaci√≥n de tablas agregadas (d√≠a \ semana \ mes) con diferentes vidas (TTL). </font><font style="vertical-align: inherit;">Esto evitar√° una hinchaz√≥n excesiva del almacenamiento. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente paso puede ser utilizar datos para an√°lisis predictivos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PD </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo y los datos para las pruebas se publican </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498346/index.html">GoLand 2020.1: soporte mejorado para m√≥dulos Go, mucha autocompletaci√≥n y mucho m√°s</a></li>
<li><a href="../es498350/index.html">Los mejores materiales para entrevistas de trabajo y b√∫squedas de trabajo.</a></li>
<li><a href="../es498352/index.html">SHISHUA: el generador de n√∫meros pseudoaleatorios m√°s r√°pido del mundo</a></li>
<li><a href="../es498354/index.html">C√≥mo traducir "Lista de deseos" en "hardware", o semi-escritorio semi-m√≥vil semi-ideal</a></li>
<li><a href="../es498358/index.html">Aprenda franc√©s o c√≥mo obtener un adaptador universal de un esc√°ner de diagn√≥stico PSA</a></li>
<li><a href="../es498362/index.html">Kingston mantiene el liderazgo en env√≠os SSD: ¬øc√≥mo lo hacemos?</a></li>
<li><a href="../es498368/index.html">La historia de un interruptor</a></li>
<li><a href="../es498370/index.html">SAP UI5 y Windows de confirmaci√≥n: nuevamente sobre el contexto</a></li>
<li><a href="../es498372/index.html">Simulador de red tutorial ns-3. Cap√≠tulo 5</a></li>
<li><a href="../es498374/index.html">Computaci√≥n GPU: por qu√©, cu√°ndo y c√≥mo. Adem√°s de algunas pruebas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>