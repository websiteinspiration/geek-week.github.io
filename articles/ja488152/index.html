<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘† ğŸ”¼ ğŸ§”ğŸ½ åˆå¾Œ3æ™‚ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚²ãƒ¼ãƒ ã§ã™ã‹ï¼Ÿ ğŸ¤±ğŸ¾ ğŸ° ğŸ‘¨â€ğŸŒ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã¾ãŸä¼šã„ã¾ã—ãŸã­ï¼æ–‡å­—é€šã‚Šçœ ã‚‹ã“ã¨ã‚’å¦¨ã’ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ€ã„ã¤ãã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã‚ãªãŸãŒå¿ƒé…ã™ã‚‹ã¨ãã®ãã®æ°—æŒã¡ã€å¿ƒé…ã—ã¦ã€é€šå¸¸ã¯ä»–ã®ã“ã¨ã«å–ã‚Šçµ„ã‚€ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ãã‚Œã¯å¹´ã«æ•°å›ç§ã«èµ·ã“ã‚Šã¾ã™ã€‚ã„ãã¤ã‹ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã€ãƒˆãƒ”ãƒƒã‚¯ã‚’æ˜ã‚Šä¸‹ã’ã¦ã€ãã®ã‚ˆã†ãªã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–ã‹ã‚‰åˆ©ç›Šã‚’å¾—ã‚‹ã®ã¯éå¸¸ã«é›£...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>åˆå¾Œ3æ™‚ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚²ãƒ¼ãƒ ã§ã™ã‹ï¼Ÿ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488152/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¾ãŸä¼šã„ã¾ã—ãŸã­ï¼æ–‡å­—é€šã‚Šçœ ã‚‹ã“ã¨ã‚’å¦¨ã’ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ€ã„ã¤ãã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã‚ãªãŸãŒå¿ƒé…ã™ã‚‹ã¨ãã®ãã®æ°—æŒã¡ã€å¿ƒé…ã—ã¦ã€é€šå¸¸ã¯ä»–ã®ã“ã¨ã«å–ã‚Šçµ„ã‚€ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ãã‚Œã¯å¹´ã«æ•°å›ç§ã«èµ·ã“ã‚Šã¾ã™ã€‚ã„ãã¤ã‹ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã€ãƒˆãƒ”ãƒƒã‚¯ã‚’æ˜ã‚Šä¸‹ã’ã¦ã€ãã®ã‚ˆã†ãªã‚¤ãƒ‹ã‚·ã‚¢ãƒãƒ–ã‹ã‚‰åˆ©ç›Šã‚’å¾—ã‚‹ã®ã¯éå¸¸ã«é›£ã—ã„ã“ã¨ã‚’ç†è§£ã—ãŸå¾Œã€è‡ªç„¶ã«æ¶ˆãˆã¾ã™ã€‚ã—ã‹ã—ã€ãã®ã‚ˆã†ãªã‚¢ã‚¤ãƒ‡ã‚¢ãŒã‚ã‚Šã€æ•°æ™‚é–“ã§ã•ãˆã‚‚ç§ã‚’æ•ã¾ãˆã¦ã€ã‚ã¾ã‚Šé£Ÿã¹ã‚‰ã‚Œãªããªã£ã¦ã„ã¾ã™ã€‚ã“ã®æŠ•ç¨¿ã¯ã€ç§ãŒä»•äº‹ã®å¾Œã®æ•°æ™©ã§ã“ã‚Œã‚‰ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã®1ã¤ã‚’ãªã‚“ã¨ã‹å®Ÿç¾ã—ã€é£¢é¤“ã§äº¡ããªã‚‰ãªã‹ã£ãŸæ–¹æ³•ã«ã¤ã„ã¦ã§ã™ã€‚ã—ã‹ã—ã€ã‚¢ã‚¤ãƒ‡ã‚¢è‡ªä½“ã¯å½“åˆã€éå¸¸ã«é‡å¿ƒçš„ã«èã“ãˆ</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¾ã—ãŸã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒäº’ã„ã«ç«¶ã„åˆã£ã¦è³ªå•ã«ç­”ãˆã‚‹PvPã‚²ãƒ¼ãƒ ã§ã™ã€‚</font></font></strong></p><br>
<p><img src="https://habrastorage.org/webt/6t/lx/nv/6tlxnvshyavyiioz_ofsltrkwae.jpeg"></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰å›ã€è‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ŒBotlifyãƒ“ã‚¸ãƒã‚¹ç”¨ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã€ã§</font><font style="vertical-align: inherit;">å¿™ã—ã‹ã£ãŸã€‚</font><font style="vertical-align: inherit;">ãã®æ­´å²ã®æœ€åˆã®éƒ¨åˆ†ã¯ã€</font><font style="vertical-align: inherit;">ãƒãƒ–ãƒ¬ã¸</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã®ãƒªãƒ³ã‚¯ã§</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">èª­ã‚€ã“ã¨ãŒã§ãã‚‹</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ç§ã¯æ°—ã‚’æ•£ã‚‰ã—ã¦ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ãƒ“ã‚¸ãƒã‚¹ã§ã¯ãªãã‚²ãƒ¼ãƒ ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">æ­£ç›´ãªã¨ã“ã‚ã€14æ­³ã‹ã‚‰15æ­³ã¾ã§ã¯ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚²ãƒ¼ãƒ ã‚„ãƒ¢ãƒã‚¤ãƒ«ã‚²ãƒ¼ãƒ ã‚’ã»ã¨ã‚“ã©ãƒ—ãƒ¬ã‚¤ã—ã¦ã„ã¾ã›ã‚“ãŒã€ãã®ãŸã³ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’æ¥½ã—ã‚“ã§ã„ã¾ã™ã€‚</font></font></p><br>
<h3 id="ideya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è€ƒãˆ</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚‚ã†ä¸€åº¦ã€æ‚ªåé«˜ã„ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒ†ãƒ¼ãƒ—ã‚’ã‚ãã£ã¦ã€2013å¹´ã«ä¼šç¤¾ã§å–ã‚Šçµ„ã‚“ã ã‚²ãƒ¼ãƒ ã«å‡ºä¼šã„ã¾ã—ãŸã€‚ç§ãŒå–ã‚Šçµ„ã‚“ã§ã„ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åŠ ãˆã¦ã€ã“ã®ä¼šç¤¾ã«ã¯åˆ¥ã®ã‚²ãƒ¼ãƒ ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯100å¯¾1ã®ãƒ†ãƒ¬ãƒ“ç•ªçµ„ã‚’æ”¹ä½œã—ãŸã‚‚ã®ã§ã™ã€‚é©šã„ãŸã“ã¨ã«ã€ãƒ†ãƒ¬ãƒ“ã‚²ãƒ¼ãƒ ã¯ã¾ã å­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸãŒã€ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“ã§ã—ãŸã€‚ã‚²ãƒ¼ãƒ è‡ªä½“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ã€ç§ã®è€ƒãˆã«ã‚ˆã‚Œã°ã€ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«éå¸¸ã«ç°¡å˜ã«é©åˆã™ã‚‹ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ³ã‚¸ãƒ£ãƒ¼ã«é©å¿œã•ã›ã‚‹ã®ã¯ç´ æ™´ã‚‰ã—ã„ã“ã¨ã ã¨æ€ã„ã¾ã—ãŸã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚‚ã†1ã¤ã®åˆ©ç‚¹ã¯ã€Telegram APIã®éå¸¸ã«è²´é‡ãªçµŒé¨“ã§ã—ãŸã€‚ã“ã‚Œã¯ã€ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚’é–‹ç™ºã™ã‚‹ã¨ãã«éå¸¸ã«å½¹ç«‹ã¡ã¾ã—ãŸã€‚</font></font></p><br>
<p>,    :   -,  ,  ,    (  ,     1% â€” <strong>YAGNI</strong>),     ,   ,   . ,    ,           .               .              <em> 3 </em>.    â€” ,    -         . ,       : "    ,       , <strong> </strong>".     ,       .      , , .   â€”       . <strong>     10   ,   ,   ,      .</strong></p><br>
<p> ,        ,             ,      Telegram.</p><br>
<h3 id="shag-1-pravila"> 1. </h3><br>
<p>  ,             .  Telegram    .        .           :</p><br>
<p>    <strong>3 </strong>.             .   ,             .  <strong>   6 </strong>,        3     .</p><br>
<ol>
<li>  â€” 8 </li>
<li>   â€” 5 </li>
<li> â€” 3 </li>
<li> â€” 2 </li>
<li> â€” 1 </li>
<li> â€” 1 </li>
<li>   â€” 0 </li>
</ol><br>
<p>  ,    ,     .       â€”   .     ,    1 "".        â€”         "".      â€”     .    ,    ,  <strong>    20 .</strong>  ?    ,     0 .   3      .</p><br>
<p>     ,   ,    ,     " ",       (,  ,     ).     ,    ,  ,   <br>
<img src="https://habrastorage.org/webt/ai/0h/mm/ai0hmmnxcggfv6gp1w685b5jsq0.jpeg" alt="ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ†ãƒ¬ãƒ“ç•ªçµ„"></p><br>
<h3 id="shag-2-abstrakcii"> 2. </h3><br>
<p>                ,           .       ,  ,  ,      "":</p><br>
<ul>
<li>(Player) â€”     id ,   , , ,     ,      .</li>
<li>(Game) â€”      ,  ,    ,   ,      ..</li>
<li>(Round) â€”     .          ,    ,   .</li>
<li>(Question) â€”  ,  -  .  </li>
<li>(Answer) â€”    ,  -           </li>
</ul><br>
<p>         .  ,       ,       ,      ,     - ,    , , , (,  ?),  â€”  .</p><br>
<p>     ,     : "       ,       ?".  ,      :</p><br>
<ul>
<li> </li>
<li>  </li>
<li>  </li>
<li>          </li>
<li>      </li>
</ul><br>
<p>     -       ,  :      ,        ,   ,   .          :<br>
  /start       . ,            ,             â€” .   N-       ,          .      â€”            ,      "  ".           .</p><br>
<h3 id="poehali">!</h3><br>
<p>,          .       ,       â€” ,     .         <strong>NodeJS c TypeScript</strong>   .      ?    . 10         :</p><br>
<pre><code class="javascript hljs">interface Player {
    <span class="hljs-attr">id</span>: string; <span class="hljs-comment">//   </span>
    rating: number;  <span class="hljs-comment">//  </span>
    username: string; <span class="hljs-comment">//   </span>
    games: number; <span class="hljs-comment">// -  </span>
    wins: number; <span class="hljs-comment">// - </span>
    losses: number; <span class="hljs-comment">// - </span>
    createdAt: number; <span class="hljs-comment">// timestamp "" </span>
    lastGame: number|<span class="hljs-literal">null</span>; <span class="hljs-comment">// timestamp    </span>
}</code></pre><br>
<p>      ,      ,  -     .     ,    ,    ""   MySQL, Postgres  MongoDB   .       <strong>Redis</strong>.         ,      ,       key-value     JSON.         ,    Redis     .  ,   Redis      "" ,     ,      ""(scores), pub/sub,     Redis  ,     .</p><br>
<p> ,           ,   ,     winGame  looseGame,         .     ,   ,  Redis     <strong>sorted set</strong>,       ,      (<strong>score</strong>).       .           sorted set    id  ,  (score)   .</p><br>
<p>,      ,     .      ,            ,       .     ?                "Rating system".     -    ,      <strong>ELO Rating.</strong>  ,       ,   ,     .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">npmjs.com</a>    elo-rating    <strong>!</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://www.npmjs.com/package/elo-rating</a>.      ,   . ,           â€” , .     ,        , !    "" player.service.ts      ,  ,  ,    ""  ""   130  .   ,   ,    â€”   ,      ,   ,     Player          - .</p><br>
<pre><code class="javascript hljs">interface IPlayerService {<font></font>
  createPlayer(id: string, name?: string): <span class="hljs-built_in">Promise</span>&lt;boolean&gt;;<font></font>
  getPlayerName(id: string): <span class="hljs-built_in">Promise</span>&lt;string&gt;;<font></font>
  countPlayers(): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getRatingPosition(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getTopPlayerIds(): <span class="hljs-built_in">Promise</span>&lt;string[]&gt;;<font></font>
  getTopPlayerScores(): <span class="hljs-built_in">Promise</span>&lt;{<span class="hljs-attr">id</span>: string, <span class="hljs-attr">value</span>: number}[]&gt;;<font></font>
  listPlayers(): <span class="hljs-built_in">Promise</span>&lt;Player[]&gt;;<font></font>
  getPlayerRating(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getPlayerScores(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getPlayerScorePosition(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getPlayerGames(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  getPlayerWins(id: string): <span class="hljs-built_in">Promise</span>&lt;number&gt;;<font></font>
  winGame(id: string, <span class="hljs-attr">newRating</span>: number): <span class="hljs-built_in">Promise</span>&lt;boolean&gt;;<font></font>
  looseGame(id: string, <span class="hljs-attr">newRating</span>: number): <span class="hljs-built_in">Promise</span>&lt;boolean&gt;;<font></font>
  setSession(id: string, <span class="hljs-attr">data</span>: any): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt;;<font></font>
  getSession(id: string): <span class="hljs-built_in">Promise</span>&lt;any&gt;;<font></font>
}</code></pre><br>
<p>   ,        ,   ""      ,             .       .</p><br>
<h3 id="vtoroy-vecher"> </h3><br>
<p>        ,       â€”    .       .  ,    ,     ,        :</p><br>
<ul>
<li>    \</li>
<li>  </li>
<li> </li>
</ul><br>
<p>       . -,      .       -  ,    (  ).</p><br>
<pre><code class="javascript hljs">interface Question {
  <span class="hljs-attr">id</span>: string;<font></font>
  message: string;<font></font>
  createdAt: number;<font></font>
}</code></pre><br>
<p>      key-value,    â€” ID,    JSON-  .     <strong> (set)</strong>    ID   ,     .      ?   :</p><br>
<ul>
<li> </li>
<li>   ID</li>
<li>  </li>
</ul><br>
<p>      ,           :</p><br>
<div class="spoiler"><b class="spoiler_title"></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QuestionService</span> </span>{<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Get redis key of question by id
   * <span class="hljs-doctag">@param <span class="hljs-variable">id</span></span>
   */</span>
  public <span class="hljs-keyword">static</span> getQuestionKey(id: string) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`questions:<span class="hljs-subst">${id}</span>`</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Get redis key of questions list
   */</span>
  public <span class="hljs-keyword">static</span> getQuestionsListKey() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'questions'</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Return question object
   * <span class="hljs-doctag">@param <span class="hljs-variable">id</span></span>
   */</span>
  <span class="hljs-keyword">async</span> getQuestion(id: string) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient().get(QuestionService.getQuestionKey(id))<font></font>
    );<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Add new question to the store
   * <span class="hljs-doctag">@param <span class="hljs-variable">question</span></span>
   */</span>
  <span class="hljs-keyword">async</span> addQuestion(message: string): <span class="hljs-built_in">Promise</span>&lt;string&gt; {
    <span class="hljs-keyword">const</span> data =  {
      <span class="hljs-attr">id</span>: randomStringGenerator(),
      <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">Date</span>.now(),<font></font>
      message,<font></font>
    };<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .set(QuestionService.getQuestionKey(data.id), <span class="hljs-built_in">JSON</span>.stringify(data));
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .sadd(QuestionService.getQuestionsListKey(), data.id);<font></font>
    <span class="hljs-keyword">return</span> data.id;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Return ID of the random question
   */</span>
  <span class="hljs-keyword">async</span> getRandomQuestionId(): <span class="hljs-built_in">Promise</span>&lt;string&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .srandmember(QuestionService.getQuestionsListKey());<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Return random question
   */</span>
  <span class="hljs-keyword">async</span> getRandomQuestion() {
    <span class="hljs-keyword">const</span> id = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getRandomQuestionId(gameId);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getQuestion(id);<font></font>
  }<font></font>
<font></font>
}</code></pre></div></div><br>
<p>   ,          Redis. ,         ,         . ,     â€”   .</p><br>
<p>-,      . -,     ,    ,    . , ,       . ,  ,        ,    ,    ,  -        ,         .      -  ,        ,    .      ,              - .   5                <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">https://github.com/aceakash/string-similarity</a>    .  ,    â€”   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"></a>.     ,     ,    0.75   ,          .    â€” ,  .</p><br>
<p>        <strong> (sorted set)</strong>        .                QuestionService,     ,     ,   -(   ),         ,  ,      ..</p><br>
<p>,                       .  ,   -     .  ,  QuestionService   :</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="javascript hljs">private turnScores: number[] = [<span class="hljs-number">8</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>];<font></font>
<font></font>
<span class="hljs-comment">/**
 * Get key of list of the answers
 * @param questionId
 */</span>
public <span class="hljs-keyword">static</span> getAnswersKey(questionId: string): string {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`answers:<span class="hljs-subst">${questionId}</span>`</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> addAnswer(questionId: string, <span class="hljs-attr">answer</span>: string): <span class="hljs-built_in">Promise</span>&lt;string&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
    .zincrby(QuestionService.getAnswersKey(questionId), <span class="hljs-number">1</span>, answer);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Get all answers for the given question
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 */</span>
<span class="hljs-keyword">async</span> getQuestionAnswers(questionId: string): <span class="hljs-built_in">Promise</span>&lt;string[]&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
    .zrevrange(QuestionService.getAnswersKey(questionId), <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Top 6 answers
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 */</span>
<span class="hljs-keyword">async</span> getTopAnswers(gameId: string, <span class="hljs-attr">questionId</span>: string): <span class="hljs-built_in">Promise</span>&lt;string[]&gt; {
  <span class="hljs-keyword">const</span> copiedAnswers = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
    .get(<span class="hljs-string">`answers:game:<span class="hljs-subst">${gameId}</span>:q:<span class="hljs-subst">${questionId}</span>`</span>);
  <span class="hljs-keyword">if</span> (!copiedAnswers) {
    <span class="hljs-keyword">const</span> ans = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .zrevrange(QuestionService.getAnswersKey(questionId), <span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .set(<span class="hljs-string">`answers:game:<span class="hljs-subst">${gameId}</span>:q:<span class="hljs-subst">${questionId}</span>`</span>, <span class="hljs-built_in">JSON</span>.stringify(ans));
    <span class="hljs-keyword">return</span> ans;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(copiedAnswers);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Find if answer already exists and return it if found
 * null if answer doesnt exist
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 * <span class="hljs-doctag">@param <span class="hljs-variable">answer</span></span>
 */</span>
<span class="hljs-keyword">async</span> existingAnswer(questionId: string, <span class="hljs-attr">answer</span>: string): <span class="hljs-built_in">Promise</span>&lt;string | <span class="hljs-literal">null</span>&gt; {
  <span class="hljs-keyword">const</span> answers = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getQuestionAnswers(questionId);
  <span class="hljs-keyword">const</span> matches = stringSimilarity.findBestMatch(answer, answers);
  <span class="hljs-keyword">return</span> matches.bestMatch.rating &gt;= <span class="hljs-number">0.75</span><font></font>
    ? <font></font>
    matches.bestMatch.target<font></font>
    :<font></font>
    <span class="hljs-literal">null</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Existing answer scores
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 * <span class="hljs-doctag">@param <span class="hljs-variable">answer</span></span>
 */</span>
<span class="hljs-keyword">async</span> getExistingAnswerScore(<font></font>
  gameId: string, <span class="hljs-attr">questionId</span>: string, <span class="hljs-attr">answer</span>: string<font></font>
): <span class="hljs-built_in">Promise</span>&lt;number&gt; {
    <span class="hljs-keyword">const</span> topAnswers = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getTopAnswers(gameId, questionId);
    <span class="hljs-keyword">const</span> matches = stringSimilarity.findBestMatch(answer, topAnswers);
    <span class="hljs-keyword">return</span> matches.bestMatch.rating &gt;= <span class="hljs-number">0.75</span><font></font>
      ?<font></font>
      <span class="hljs-keyword">this</span>.turnScores[matches.bestMatchIndex]<font></font>
      :<font></font>
      <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/**
 * Submit the new answer. Updates answer counter, save if doesn't exist, return answer score
 * <span class="hljs-doctag">@param <span class="hljs-variable">questionId</span></span>
 * <span class="hljs-doctag">@param <span class="hljs-variable">answer</span></span>
 */</span>
<span class="hljs-keyword">async</span> submitAnswer(gameId: string, <span class="hljs-attr">questionId</span>: string, <span class="hljs-attr">answer</span>: string): <span class="hljs-built_in">Promise</span>&lt;number&gt; {<font></font>
  answer = answer.toLowerCase();<font></font>
  <span class="hljs-keyword">const</span> existingAnswer = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.existingAnswer(questionId, answer);
  <span class="hljs-keyword">if</span> (!existingAnswer) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.addAnswer(questionId, answer);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.addAnswer(questionId, existingAnswer);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getExistingAnswerScore(gameId, questionId, existingAnswer);<font></font>
  }<font></font>
}</code></pre></div></div><br>
<p>     ,     :     . ,      ,   â€”       0   .    ,   ""  ,       ,        . ,   ,       .           ,     ,    â‰¥ 0.75   .  ""          ,    -             .       getTopAnswers? ,    â€”    ;)       ,      &lt; 300            ,              (   - gameId,       ).</p><br>
<p> ,       ?     ,                    .       ,   ?</p><br>
<h3 id="igra"></h3><br>
<p>    ,  ()     .      2  â€” player1  player2 .     :  ,  , .         ,     ,   " "   ,           .     â€”     .</p><br>
<pre><code class="javascript hljs">enum GameStatus {<font></font>
  WaitingForPlayers,<font></font>
  Active,<font></font>
  Finished,<font></font>
}</code></pre><br>
<p>     <em>key-value</em>,     = ID,  value = JSON.stringify(data).  ,      </p><br>
<pre><code class="javascript hljs">interface Game {
    <span class="hljs-attr">id</span>: string;<font></font>
    player1: string;<font></font>
    player2: string;<font></font>
    joined: string[];<font></font>
    status: GameStatus;<font></font>
    round?: number;<font></font>
    winner?: string;<font></font>
    createdAt: number;<font></font>
    updatedAt?: number;<font></font>
}</code></pre><br>
<p>      ,    ,  (? 1  â€” 1 ),    .</p><br>
<pre><code class="javascript hljs">interface GameRound {
    <span class="hljs-attr">index</span>: number;<font></font>
    question: string;<font></font>
    currentPlayer: string;<font></font>
    turn: number;<font></font>
    answers: UserAnswer[];<font></font>
    updatedAt?: number;<font></font>
}</code></pre><br>
<p>     <em>game.service.ts</em>      ,  :  ,  ,  ,  ,       .     ,       - , ,        .        Redis pub/sub.    ,     .       ,     â€”  ,      -  ,     ,     .</p><br>
<div class="spoiler"><b class="spoiler_title"> GameService</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GameService</span> </span>{<font></font>
<font></font>
  <span class="hljs-comment">//       </span>
  public <span class="hljs-keyword">static</span> CHANNEL_G_CREATED = <span class="hljs-string">'game-created'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_STARTED = <span class="hljs-string">'game-started'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_ENDED = <span class="hljs-string">'game-ended'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_NEXT_ROUND = <span class="hljs-string">'game-next-round'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_NEXT_TURN = <span class="hljs-string">'game-next-turn'</span>;<font></font>
  public <span class="hljs-keyword">static</span> CHANNEL_G_ANSWER_SUBMIT = <span class="hljs-string">'game-next-turn'</span>;<font></font>
<font></font>
  private defaultRounds: number; <span class="hljs-comment">//  </span>
  private defaultTurns: number; <span class="hljs-comment">//     </span><font></font>
<font></font>
  private timers: any = {}; <span class="hljs-comment">// . -, any - </span><font></font>
<font></font>
    <span class="hljs-comment">//  ,       </span>
    <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">constructor</span>(<font></font>
    private readonly redisService: RedisService,<font></font>
    private readonly playerService: PlayerService,<font></font>
    private readonly questionService: QuestionService,<font></font>
    @Inject('EventPublisher') private readonly eventPublisher,<font></font>
  ) {<font></font>
    <span class="hljs-keyword">this</span>.defaultRounds = config.game.defaultRounds;
    <span class="hljs-keyword">this</span>.defaultTurns = config.game.defaultTurns;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Get redis key of game
   * <span class="hljs-doctag">@param </span>id string identifier of game
   */</span>
  public <span class="hljs-keyword">static</span> getGameKey(id: string) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`game:<span class="hljs-subst">${id}</span>`</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Get game object by id
   * <span class="hljs-doctag">@param <span class="hljs-variable">gameId</span></span>
   */</span>
  <span class="hljs-keyword">async</span> getGame(gameId: string): <span class="hljs-built_in">Promise</span>&lt;Game&gt; {
    <span class="hljs-keyword">const</span> game = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .get(GameService.getGameKey(gameId));<font></font>
    <span class="hljs-keyword">if</span> (!game) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`Game <span class="hljs-subst">${gameId}</span> not found`</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(game);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Save the game state to database
   * <span class="hljs-doctag">@param <span class="hljs-variable">game</span></span>
   */</span>
  <span class="hljs-keyword">async</span> saveGame(game: Game) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().set(<font></font>
      GameService.getGameKey(game.id),<font></font>
      <span class="hljs-built_in">JSON</span>.stringify(game)<font></font>
    );<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Save round
   * <span class="hljs-doctag">@param <span class="hljs-variable">gameId</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">round</span></span>
   */</span>
  <span class="hljs-keyword">async</span> saveRound(gameId: string, <span class="hljs-attr">round</span>: GameRound) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().set(<font></font>
      GameService.getRoundKey(gameId, round.index),<font></font>
      <span class="hljs-built_in">JSON</span>.stringify(round)<font></font>
    );<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Initialize default game structure, generate id
   * and save new game to the storage
   *
   * <span class="hljs-doctag">@param <span class="hljs-variable">player1</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">player2</span></span>
   */</span>
  <span class="hljs-keyword">async</span> initGame(player1: string, <span class="hljs-attr">player2</span>: string): <span class="hljs-built_in">Promise</span>&lt;Game&gt; {
    <span class="hljs-keyword">const</span> game: Game = {
      <span class="hljs-attr">id</span>: randomStringGenerator(),<font></font>
      player1,<font></font>
      player2,<font></font>
      <span class="hljs-attr">joined</span>: [],
      <span class="hljs-attr">status</span>: GameStatus.WaitingForPlayers,
      <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">Date</span>.now(),<font></font>
    };<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveGame(game);
    <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_CREATED, <span class="hljs-built_in">JSON</span>.stringify(game)<font></font>
    );<font></font>
    <span class="hljs-keyword">return</span> game;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * When the game is created and is in the  "Waiting for players" state
   * users can approve participation
   * <span class="hljs-doctag">@param <span class="hljs-variable">playerId</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">gameId</span></span>
   */</span>
  <span class="hljs-keyword">async</span> joinGame(playerId: string, <span class="hljs-attr">gameId</span>: string) {
    <span class="hljs-keyword">const</span> game: Game = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getGame(gameId);
    <span class="hljs-keyword">if</span> (!game) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Game not found err'</span>)
    <span class="hljs-keyword">if</span> (isUndefined(game.joined.find(<span class="hljs-function"><span class="hljs-params">element</span> =&gt;</span> element === playerId))) {<font></font>
      game.joined.push(playerId);<font></font>
      game.updatedAt = <span class="hljs-built_in">Date</span>.now();
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveGame(game);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (game.joined.length === <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.startGame(game);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Start the game
   * <span class="hljs-doctag">@param <span class="hljs-variable">game</span></span>
   */</span>
  <span class="hljs-keyword">async</span> startGame(game: Game) {<font></font>
    game.round = <span class="hljs-number">0</span>;<font></font>
    game.updatedAt = <span class="hljs-built_in">Date</span>.now();<font></font>
    game.status = GameStatus.Active;<font></font>
    <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_STARTED, <span class="hljs-built_in">JSON</span>.stringify(game)<font></font>
    );<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.questionService.pickQuestionsForGame(game.id);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.nextRound(game);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Start the next round
   * <span class="hljs-doctag">@param <span class="hljs-variable">game</span></span>
   */</span>
  <span class="hljs-keyword">async</span> nextRound(game: Game) {<font></font>
    clearTimeout(<span class="hljs-keyword">this</span>.timers[game.id]);
    <span class="hljs-keyword">if</span> (game.round &gt;= <span class="hljs-keyword">this</span>.defaultRounds) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.endGame(game);<font></font>
    }<font></font>
    game.round++;<font></font>
    <span class="hljs-keyword">const</span> round: GameRound = {
      <span class="hljs-attr">index</span>: game.round,
      <span class="hljs-attr">question</span>: <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.questionService.getRandomQuestionId(game.id),
      <span class="hljs-attr">currentPlayer</span>: game.player1,
      <span class="hljs-attr">turn</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">answers</span>: [],<font></font>
    };<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveGame(game);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.saveRound(game.id, round);<font></font>
<font></font>
    <span class="hljs-comment">//        </span>
    <span class="hljs-comment">//     20    </span>
    <span class="hljs-comment">//        0 </span>
    <span class="hljs-keyword">this</span>.timers[game.id] = setTimeout(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.submitAnswer(round.currentPlayer, game.id, <span class="hljs-string">''</span>);<font></font>
    }, <span class="hljs-number">20000</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_NEXT_ROUND,<font></font>
      <span class="hljs-built_in">JSON</span>.stringify({game, round})<font></font>
    );<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Switch round to next turn
   * <span class="hljs-doctag">@param <span class="hljs-variable">game</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">round</span></span>
   */</span>
  <span class="hljs-keyword">async</span> nextTurn(game: Game, <span class="hljs-attr">round</span>: GameRound) {<font></font>
    clearTimeout(<span class="hljs-keyword">this</span>.timers[game.id]);
    <span class="hljs-keyword">if</span> (round.turn &gt;= <span class="hljs-keyword">this</span>.defaultTurns) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.nextRound(game);<font></font>
    }<font></font>
    round.turn++;<font></font>
    round.currentPlayer = <span class="hljs-keyword">this</span>.anotherPlayer(round.currentPlayer, game);<font></font>
    round.updatedAt = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_NEXT_TURN,<font></font>
      <span class="hljs-built_in">JSON</span>.stringify({game, round})<font></font>
    );<font></font>
    <span class="hljs-keyword">this</span>.timers[game.id] = setTimeout(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.submitAnswer(round.currentPlayer, game.id, <span class="hljs-string">''</span>);<font></font>
    }, <span class="hljs-number">20000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.saveRound(game.id, round);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> answerExistInRound(round: GameRound, <span class="hljs-attr">answer</span>: string) {
    <span class="hljs-keyword">const</span> existingKey = round.answers.find(
      <span class="hljs-function"><span class="hljs-params">rAnswer</span> =&gt;</span> stringSimilarity.compareTwoStrings(answer, rAnswer.value) &gt;= <span class="hljs-number">0.85</span><font></font>
    );<font></font>
    <span class="hljs-keyword">return</span> !isUndefined(existingKey);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> submitAnswer(playerId: string, <span class="hljs-attr">gameId</span>: string, <span class="hljs-attr">answer</span>: string) {
    <span class="hljs-keyword">const</span> game = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getGame(gameId);
    <span class="hljs-keyword">const</span> round = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getCurrentRound(gameId);
    <span class="hljs-keyword">if</span> (playerId !== round.currentPlayer) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Its not your turn'</span>);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (answer.length === <span class="hljs-number">0</span>) {<font></font>
      round.updatedAt = <span class="hljs-built_in">Date</span>.now();
      <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
        GameService.CHANNEL_G_ANSWER_SUBMIT,<font></font>
        <span class="hljs-built_in">JSON</span>.stringify({game, answer, <span class="hljs-attr">score</span>: <span class="hljs-number">0</span>, playerId})<font></font>
      );<font></font>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.nextTurn(game, round);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.answerExistInRound(round, answer)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'       '</span>);<font></font>
    }<font></font>
    round.answers.push({ <span class="hljs-attr">value</span>: answer, playerId, <span class="hljs-attr">turn</span>: round.turn });
    <span class="hljs-keyword">const</span> score = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.questionService.submitAnswer(<font></font>
      gameId, round.question, answer<font></font>
    );<font></font>
    <span class="hljs-keyword">if</span> (score &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.addGameScore(gameId, playerId, score);<font></font>
    }<font></font>
    round.updatedAt = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">this</span>.eventPublisher.emit(<font></font>
      GameService.CHANNEL_G_ANSWER_SUBMIT,<font></font>
      <span class="hljs-built_in">JSON</span>.stringify({game, answer, score, playerId})<font></font>
    );<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.nextTurn(game, round);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">/**
   * Adds game score in specified game for specified player
   * <span class="hljs-doctag">@param <span class="hljs-variable">gameId</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">playerId</span></span>
   * <span class="hljs-doctag">@param <span class="hljs-variable">score</span></span>
   */</span>
  <span class="hljs-keyword">async</span> addGameScore(gameId: string, <span class="hljs-attr">playerId</span>: string, <span class="hljs-attr">score</span>: number) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .zincrby(<span class="hljs-string">`game:<span class="hljs-subst">${gameId}</span>:player:scores`</span>, score, playerId);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> endGame(game: Game) {<font></font>
    clearTimeout(<span class="hljs-keyword">this</span>.timers[game.id]);<font></font>
    game.updatedAt = <span class="hljs-built_in">Date</span>.now();<font></font>
    game.status = GameStatus.Finished;<font></font>
    game.updatedAt = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">const</span> places = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
      .zrevrange(<span class="hljs-string">`game:<span class="hljs-subst">${game.id}</span>:player:scores`</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<font></font>
    game.winner = places[<span class="hljs-number">0</span>];
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">const</span> winnerRating: number = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.getPlayerRating(game.winner);
    <span class="hljs-keyword">const</span> looserRating: number = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.getPlayerRating(places[<span class="hljs-number">1</span>]);
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">const</span> newRatings = rating.calculate(winnerRating, looserRating);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.winGame(game.winner, newRatings.playerRating); 
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.looseGame(places[<span class="hljs-number">1</span>], newRatings.opponentRating);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient().expire(GameService.getGameKey(game.id), <span class="hljs-number">600</span>)
    <span class="hljs-keyword">this</span>.eventPublisher.emit(GameService.CHANNEL_G_ENDED, <span class="hljs-built_in">JSON</span>.stringify(game));
    <span class="hljs-keyword">return</span> game;<font></font>
  }<font></font>
}</code></pre></div></div><br>
<p>,  -.      ,      .        ,          â€”    . ,       ,      ,          .      Redis    (sorted sets).              (          ,    ).           .      .             <em>game.service.ts</em>,    </p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">async</span> addPlayerToMatchmakingList(id: string) {
  <span class="hljs-keyword">const</span> playerRating = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.getPlayerRating(id);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().zadd(<span class="hljs-string">'matchmaking-1-1'</span>, playerRating, id);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> removePlayerFromMatchmakingList(id: string) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().zrem(<span class="hljs-string">'matchmaking-1-1'</span>, id);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> getMatchmakingListData() {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.redisService.getClient().zrange(<span class="hljs-string">'matchmaking-1-1'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">async</span> matchPlayers(): <span class="hljs-built_in">Promise</span>&lt;Game&gt; {
  <span class="hljs-keyword">const</span> players = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.redisService.getClient()<font></font>
        .zrevrange(<span class="hljs-string">'matchmaking-1-1'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);
  <span class="hljs-keyword">while</span> (players.length &gt; <span class="hljs-number">0</span>) {
     <span class="hljs-keyword">const</span> pair = players.splice(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>);
     <span class="hljs-keyword">if</span> (pair.length === <span class="hljs-number">2</span>) {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.coinflip() <font></font>
         ?<font></font>
         <span class="hljs-keyword">this</span>.initGame(pair[<span class="hljs-number">0</span>], pair[<span class="hljs-number">1</span>])<font></font>
         :<font></font>
         <span class="hljs-keyword">this</span>.initGame(pair[<span class="hljs-number">1</span>], pair[<span class="hljs-number">0</span>]);<font></font>
     }<font></font>
  }<font></font>
}</code></pre><br>
<p>,   ,          . ,              .          , -   .</p><br>
<p> ,     .        ,       .</p><br>
<h3 id="polzovatelskiy-interfeys"> </h3><br>
<p>- â€”   .    ,     -     ,  css   JS- â€”        Telegram.        .   ,    API       .   ,       ,    .</p><br>
<p> ,   ,      -  ,        .</p><br>
<blockquote>    "100  1", AndreyDegtyaruk!<br>
        , ,     !    ,     .   /help            </blockquote><p>  ,           ,   :</p><br>
<blockquote>  "100  1"              .   !    ,      <br>
    3 .              .    ,             .     6 ,        3     <br>
   <br>
<ol>
<li>  â€” 8 </li>
<li>   â€” 5 </li>
<li>   â€” 3 </li>
<li>   â€” 2 .</li>
<li> â€” 1 .</li>
<li> â€” 1 .</li>
<li>   â€” 0 </li>
</ol><br>
<br>
!    !     20   .   ?   0      .   3       ,        </blockquote><p>  ,    ,     -  ,    ,     ( ,   ).  2 : pull  push. Pull  ,   "" Telegram   ,    API Telegram   getUpdates. Push       ,   ,   â€”  webhook.      ,      ""        ,           . ,  !</p><br>
<p>        SDK   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Telegraf</a>,   ,           â€” ,    .      ,    .</p><br>
<p>  ,  ""   ,  API key   ,      ,       .         â€” <em>bot.service.ts</em>,          Telegram.  ,     ,      .            :</p><br>
<ul>
<li>/start â€”      (-    inline, , custom keyboard     )</li>
<li>/help â€”      </li>
<li>/player_info â€”   (, , )   </li>
<li>/global_rating â€”       </li>
<li>/go â€”      </li>
</ul><br>
<p> ,        . ,          -  </p><br>
<pre><code class="javascript hljs">    getMainMenuKeyboard() {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">inline_keyboard</span>: [<font></font>
            [<font></font>
            {<font></font>
                    <span class="hljs-attr">text</span>: <span class="hljs-string">'    '</span>,
                <span class="hljs-attr">callback_data</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">type</span>: <span class="hljs-string">'go'</span>})<font></font>
            }<font></font>
             ],<font></font>
             [<font></font>
            {<font></font>
                <span class="hljs-attr">text</span>: <span class="hljs-string">'  '</span>,
                <span class="hljs-attr">callback_data</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">type</span>: <span class="hljs-string">'player-rating'</span>})<font></font>
            }<font></font>
             ],<font></font>
             [<font></font>
            {<font></font>
                <span class="hljs-attr">text</span>: <span class="hljs-string">' '</span>,
                <span class="hljs-attr">callback_data</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">type</span>: <span class="hljs-string">'rules'</span>})<font></font>
            }<font></font>
              ],<font></font>
             [<font></font>
            {<font></font>
                <span class="hljs-attr">text</span>: <span class="hljs-string">'  '</span>,
                <span class="hljs-attr">callback_data</span>: <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">type</span>: <span class="hljs-string">'stats'</span>})<font></font>
            }<font></font>
             ],<font></font>
          ],<font></font>
        };<font></font>
      }</code></pre><br>
<p>     <em>callback_data.</em> Telegram       ,  ,              .</p><br>
<p>        ,    switch/case statement   type,      .       start  help,           ,     .    ,  Telegram     https,    -     .  ,                 <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">Ngrok</a></strong>     .</p><br>
<pre><code class="javascript hljs">    <span class="hljs-keyword">async</span> commandStart(ctx) {
      <span class="hljs-keyword">let</span> name = <span class="hljs-string">`<span class="hljs-subst">${escapeHtml(ctx.<span class="hljs-keyword">from</span>.first_name)}</span>`</span>;<font></font>
      name += ctx.from.last_name ? escapeHtml(ctx.from.last_name) : <span class="hljs-string">''</span>;
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.createPlayer(ctx.from.id.toString(<span class="hljs-number">10</span>), name);
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.bot.telegram.sendMessage(ctx.from.id, messages.start(name), {
        <span class="hljs-attr">parse_mode</span>: <span class="hljs-string">'HTML'</span>,
        <span class="hljs-attr">reply_markup</span>: <span class="hljs-keyword">this</span>.getMainMenuKeyboard(),<font></font>
      });<font></font>
    }</code></pre><br>
<p> ,              .   ,        .       ,   ,        . ,  ,  .  ,         .</p><br>
<p>    ,      Redis pub/sub.       .     ,        ,  ,   (        ).        main.ts,    ,     ,  .      .  ""    </p><br>
<pre><code class="javascript hljs">    <span class="hljs-keyword">const</span> redisClient = app.get(<span class="hljs-string">'EventSubscriber'</span>);<font></font>
    redisClient.on(GameService.CHANNEL_G_CREATED, <span class="hljs-keyword">async</span> (data) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> botService.sendGameCreated(<span class="hljs-built_in">JSON</span>.parse(data));<font></font>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error in CHANNEL_G_CREATED'</span>);
        <span class="hljs-built_in">console</span>.log(error);<font></font>
      }<font></font>
    });</code></pre><br>
<p> BotService.sendGameCreated,             ,          .</p><br>
<p>       (    ,  ),   -   ,   ,     ,   .    ,   ?     Stages  Scenes,  Telegraf,         ,   . ,  ,  30               ,     Redis.</p><br>
<p>      ,  ,       .  ,       ,   ,    â€”  (    ).      â€”    ,    ,   .</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">this</span>.bot.on(<span class="hljs-string">'text'</span>, <span class="hljs-keyword">async</span> (ctx: any) =&gt; {<font></font>
  ctx.message.text = escapeHtml(ctx.message.text);<font></font>
  ctx.message.text = ctx.message.text.toLowerCase();<font></font>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerService.getSession(ctx.from.id.toString());
    <span class="hljs-keyword">if</span> (!state.currentGame) {
      <span class="hljs-keyword">return</span> ctx.reply(
        <span class="hljs-string">' ,   . 
          /help,     '</span><font></font>
        );<font></font>
    }<font></font>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.gameIncomingMessage(ctx, state);<font></font>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error during processing TEXT message'</span>);
    <span class="hljs-built_in">console</span>.log(error);<font></font>
  }<font></font>
});<font></font>
<span class="hljs-keyword">this</span>.bot.on(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">async</span> ctx =&gt; {<font></font>
    ctx.reply(<span class="hljs-string">'   '</span>);<font></font>
});</code></pre><br>
<p>  ,    ,    .</p><br>
<p> Telegram-  ,         . ,    - .   ,           &lt;/&gt;,     parseMode HTML,     : "   html"       .             ,    .                localhost    50 .     ,  NodeJS        .                     - , ,    -    .</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç§ã®æŠ•ç¨¿ãŒèª°ã‹ã«ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å®Ÿè£…ã—ã¦ã‚‚ã‚‰ã„ã€ãƒšãƒƒãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒãã‚Œã‚’ã‚ˆã‚Šé€Ÿãå®Ÿè¡Œã—ã¦ãƒªãƒªãƒ¼ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆã‹ã‚‰å®Ÿè£…ã¾ã§ã®ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã‚’æ”¯æ´ã—ãŸã‚Šã€ã‚ã‚‹ã„ã¯å°‘ãªãã¨ã‚‚å°‘ã—ã ã‘èª­æ›¸ã‚’æ¥½ã—ã‚“ã ã‚Šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒœãƒƒãƒˆã¯å¤šãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è€ãˆã‚‰ã‚Œãªã„ã¨ç¢ºä¿¡ã—ã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãã‚Œã§ã‚‚ã€ã‚¿ã‚¤ãƒãƒ¼ã€ãƒ¡ã‚¤ãƒ³ã®ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã€1ã¤ã®ãƒ—ãƒ­ã‚»ã‚¹ãªã©ã€‚</font><font style="vertical-align: inherit;">ãã‚Œã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€èª°ã‹ãŒçµæœã‚’ç¢ºèªã™ã‚‹ã“ã¨ã«èˆˆå‘³ãŒã‚ã‚‹å ´åˆã¯ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@QuizMatchGameBot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒœãƒƒãƒˆã‚’æ¢ã—ã¾ã™</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">çš†ã®ãŸã‚ã®å¹³å’Œï¼</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja488142/index.html">ç‰©æ€ã„ã‚¢ãƒãƒ­ãƒ‹ã‚¢</a></li>
<li><a href="../ja488144/index.html">Javaãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŠã‚ˆã³æ©Ÿèƒ½ã‚¬ã‚¤ãƒ‰</a></li>
<li><a href="../ja488146/index.html">[ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³]ï¼šITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã‹ï¼ŸITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã‹ï¼Ÿ</a></li>
<li><a href="../ja488148/index.html">HighLoad ++ã€Mikhail Raichenkoï¼ˆManyChatï¼‰ï¼šã»ã¨ã‚“ã©é­”æ³•ãŒãªã„ã€ã¾ãŸã¯ãƒ†ãƒ©ãƒ“ãƒƒãƒˆãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã®é…å¸ƒãŒã„ã‹ã«ç°¡å˜ã‹</a></li>
<li><a href="../ja488150/index.html">éª¨è‘£å“ï¼šThinkPad X200ãŠã‚ˆã³ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ã‚½ãƒ¼ã‚¹</a></li>
<li><a href="../ja488154/index.html">ç§ãŸã¡ã¯ã‚ªãƒ•ã‚£ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ç«‹å ´ã«ç«‹ã¡ã¾ã™ã€‚åŸºæœ¬çš„ãªä¾›çµ¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </a></li>
<li><a href="../ja488160/index.html">Windows Server 2019ã¨ é™æ­¢ã‚’ä¼´ã†VMwareã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼šå•é¡Œã«å¯¾ã™ã‚‹ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³</a></li>
<li><a href="../ja488162/index.html">è©•ä¾¡ãŒé«˜ã„ã»ã©ã€ã‚ˆã‚Šå¤šãã®ãŠé‡‘ã¨ãã®é€†</a></li>
<li><a href="../ja488164/index.html">é›»å ±ã«å¯¾ã™ã‚‹SECã®æˆ¦ã„</a></li>
<li><a href="../ja488166/index.html">ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€ã¾ãŸã¯å®Œç’§ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ¢ã™ï¼šä¸€è²«æ€§</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>