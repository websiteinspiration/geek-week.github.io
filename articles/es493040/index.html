<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòû ü¶å üíö Barra de desplazamiento que fall√≥ ‚úä üïú üë®üèº‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente lanz√≥ una nueva versi√≥n de Windows Terminal. Todo estar√≠a bien, pero el rendimiento de su barra de desplazamiento dejaba mucho que desea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Barra de desplazamiento que fall√≥</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/493040/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/b6/xe/uj/b6xeuj-pps_cnuo5ky22sr0yl5o.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recientemente lanz√≥ una nueva versi√≥n de Windows Terminal. </font><font style="vertical-align: inherit;">Todo estar√≠a bien, pero el rendimiento de su barra de desplazamiento dejaba mucho que desear. </font><font style="vertical-align: inherit;">Por lo tanto, es hora de pegarle un palito y tocar la pandereta.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© suelen hacer los usuarios con la nueva versi√≥n de cualquier aplicaci√≥n? </font><font style="vertical-align: inherit;">As√≠ es, exactamente lo que los evaluadores no hicieron. </font><font style="vertical-align: inherit;">Por lo tanto, despu√©s de un breve uso del terminal para su prop√≥sito previsto, comenc√© a hacer cosas terribles con √©l. </font><font style="vertical-align: inherit;">Est√° bien, est√° bien, acabo de derramar caf√© en el teclado y sujet√© accidentalmente &lt;Enter&gt; cuando lo limpi√©. </font><font style="vertical-align: inherit;">¬øQue pas√≥ al final?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/ev/at/tqevatebkqh9qhtc7meqb8gd9y8.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√≠, no se ve muy impresionante, pero no te apresures a tirarme piedras. </font><font style="vertical-align: inherit;">Presta atenci√≥n al lado derecho. </font><font style="vertical-align: inherit;">Primero trate de descubrir qu√© le pasa. </font><font style="vertical-align: inherit;">Aqu√≠ hay una captura de pantalla para una pista:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/33/g5/nz/33g5nz7ix7fpgot21hpt-flsw0m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, el t√≠tulo del art√≠culo era un serio spoiler. :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, hay un problema con la barra de desplazamiento. Al pasar a una nueva l√≠nea muchas veces, despu√©s de cruzar el borde inferior, generalmente espera que aparezca una barra de desplazamiento y puede desplazarse hacia arriba. Sin embargo, esto no sucede hasta que escribimos un comando con la salida de algo. Digamos que el comportamiento es extra√±o. Sin embargo, esto podr√≠a no haber sido tan cr√≠tico si la barra de desplazamiento funcionara ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de probar un poco, descubr√≠ que cambiar a una nueva l√≠nea no aumenta el b√∫fer. Esto solo genera la salida de comandos. Entonces, el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whoami</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> anterior </font><font style="vertical-align: inherit;">aumentar√° el b√∫fer en solo una l√≠nea. Debido a esto, con el tiempo perderemos mucha historia, especialmente despu√©s de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">despejar.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo primero que se me ocurri√≥ fue usar nuestro analizador y ver qu√© dice:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/dt/op/hfdtop2yyl-2hnm0fdzu2bg6jmo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La conclusi√≥n, por supuesto, es de un tama√±o impresionante, por lo que aprovechar√© el poder de filtrar y recortar todo excepto el que contiene la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">barra de desplazamiento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/kb/k9/nh/kbk9nhstx9w90yxa5q8sm542fvk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No puedo decir que hay muchos mensajes ... Bueno, ¬øtal vez hay algo relacionado con el b√∫fer?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ym/u0/jsymu0ehvgbwmldkhi30tkr8duw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El analizador no fall√≥ y encontr√≥ algo interesante. </font><font style="vertical-align: inherit;">Destaqu√© esta advertencia arriba. </font><font style="vertical-align: inherit;">Veamos qu√© est√° mal all√≠: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V501</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hay subexpresiones id√©nticas a la izquierda y a la derecha del operador '-': bufferHeight - bufferHeight TermControl.cpp 592</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(bufferHeight - bufferHeight); <span class="hljs-comment">// &lt;=  </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este c√≥digo va acompa√±ado de un comentario: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Configure la altura del ScrollViewer y la cuadr√≠cula que estamos utilizando para simular nuestra altura de desplazamiento". </font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simular la altura de desplazamiento es, por supuesto, bueno, pero ¬øpor qu√© ponemos 0 al m√°ximo? </font><font style="vertical-align: inherit;">En cuanto a la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qued√≥ claro que el c√≥digo no es muy sospechoso. </font><font style="vertical-align: inherit;">No me malinterpreten: restar una variable de s√≠ mismo es, por supuesto, sospechoso, pero obtenemos un cero en la salida, lo que no nos perjudica. </font><font style="vertical-align: inherit;">En cualquier caso, intent√© especificar el </font><font style="vertical-align: inherit;">valor predeterminado (1) </font><font style="vertical-align: inherit;">en el campo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°ximo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/my/pz/-r/mypz-rza0bhmadv3_q32c5oklkc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aparece la barra de desplazamiento, pero tampoco funciona:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/_n/ii/xg/_niixgvkmgqfoy_fmiyaouu6rog.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En todo caso, sujet√© &lt;Enter&gt; durante 30 segundos. Aparentemente este no es el problema, as√≠ que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dej√©moslo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como estaba, excepto reemplazando </font><i><font style="vertical-align: inherit;">bufferHeight</font></i><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con 0:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(<span class="hljs-number">0</span>); <span class="hljs-comment">// &lt;=   </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, no estamos particularmente cerca de resolver el problema. En ausencia de una mejor oferta para entrar en debate. Al principio podr√≠amos poner un punto de quiebre en la l√≠nea cambiada, pero dudo que nos ayude de alguna manera. Por lo tanto, primero tenemos que encontrar el fragmento responsable del desplazamiento de la ventana gr√°fica en relaci√≥n con el b√∫fer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un poco sobre c√≥mo funciona la barra de desplazamiento local (y muy probablemente cualquier otra). Tenemos un gran b√∫fer que almacena toda la salida. Para interactuar con √©l, se utiliza alg√∫n tipo de abstracci√≥n para dibujar en la pantalla, en este caso, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando estas dos primitivas, podemos entender cu√°l es nuestro problema. Ir a una nueva l√≠nea no aumenta el b√∫fer, y debido a esto, simplemente no tenemos a d√≥nde ir. Por lo tanto, el problema est√° en eso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Armados con este conocimiento com√∫n, continuamos nuestro debate heroico. </font><font style="vertical-align: inherit;">Despu√©s de un peque√±o paseo por la funci√≥n, llam√© la atenci√≥n sobre este fragmento:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de haber configurado el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> anterior </font><font style="vertical-align: inherit;">, podemos configurar diversas funciones de devoluci√≥n de llamada y ejecutar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__connection.Start ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la ventana de nuevo cu√±o. </font><font style="vertical-align: inherit;">Despu√©s de lo cual se llama la lambda anterior. </font><font style="vertical-align: inherit;">Como esta es la primera vez que estamos escribiendo algo en el b√∫fer, sugiero comenzar nuestra depuraci√≥n desde all√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Establecemos un punto de interrupci√≥n dentro de la lambda y miramos en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_terminal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/0z/lz/rb/0zlzrbnxlr94nbnb2jkgnmmf1sq.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora tenemos dos variables que son extremadamente importantes para nosotros: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_mutableViewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ponles puntos de quiebre y averigua d√≥nde cambian. Es cierto, con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> har√© </font><i><font style="vertical-align: inherit;">un</font></i><font style="vertical-align: inherit;"> poco de </font><i><font style="vertical-align: inherit;">trampa</font></i><font style="vertical-align: inherit;"> y pondr√© un punto de interrupci√≥n no en la variable en s√≠, sino en su campo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">superior</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (solo lo necesitamos). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora haga clic en &lt;F5&gt;, y no pasa nada ... Bueno, entonces peguemos un par de docenas de veces &lt;Enter&gt;. No pas√≥ nada. Aparentemente, en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> establecimos un punto de interrupci√≥n demasiado imprudentemente, y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , como se esperaba, permaneci√≥ en la parte superior del b√∫fer, que no aument√≥ de tama√±o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, tiene sentido ingresar un comando para provocar una actualizaci√≥n de v√©rtice.</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Despu√©s de eso, nos encontramos con un c√≥digo muy interesante:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se√±al√© un comentario donde lo dejamos. </font><font style="vertical-align: inherit;">Si observa los comentarios sobre el fragmento, queda claro que estamos m√°s cerca de la soluci√≥n que nunca. </font><font style="vertical-align: inherit;">Es en este lugar que la parte visible se desplaza en relaci√≥n con el b√∫fer, y tenemos la oportunidad de desplazarnos. </font><font style="vertical-align: inherit;">Despu√©s de observar un poco el comportamiento, not√© un punto interesante: al pasar a una nueva l√≠nea, el valor de la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es igual al valor de la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ventana gr√°fica</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , por lo que no lo omitimos y nada funciona. </font><font style="vertical-align: inherit;">Adem√°s, hay un problema similar con la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newViewTop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por lo tanto, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumentemos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el valor de </font><i><font style="vertical-align: inherit;">cursorPosAfter.Y</font></i><font style="vertical-align: inherit;"> en uno y veamos qu√© sucedi√≥:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y + <span class="hljs-number">1</span> &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y + <span class="hljs-number">1</span> - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y el resultado del lanzamiento:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/6g/7d/xc/6g7dxcp_8o_uw-jzmlx6qxy6xjy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maravillas! </font><font style="vertical-align: inherit;">Ingres√© una cantidad ne y la barra de desplazamiento funciona. </font><font style="vertical-align: inherit;">Es cierto, hasta el momento en que presentamos algo ... Para demostrar el archivo, adjuntar√© un gif:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/ed/8y/cled8yrho-rrvtihhjf7uoo7ybq.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aparentemente, estamos haciendo algunos saltos adicionales a una nueva l√≠nea. </font><font style="vertical-align: inherit;">Entonces tratemos de limitar nuestras transiciones usando la coordenada X. Solo cambiaremos la l√≠nea cuando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sea ‚Äã‚Äã0:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (   proposedCursorPosition.X == <span class="hljs-number">0</span><font></font>
      &amp;&amp; proposedCursorPosition.Y == _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    proposedCursorPosition.Y++;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Update Cursor Position</span><font></font>
  ursor.SetPosition(proposedCursorPosition);<font></font>
<font></font>
  <span class="hljs-keyword">const</span> COORD cursorPosAfter = cursor.GetPosition();<font></font>
<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....);<font></font>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El fragmento escrito arriba desplazar√° la coordenada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el cursor. </font><font style="vertical-align: inherit;">Luego actualizamos la posici√≥n del cursor. </font><font style="vertical-align: inherit;">En teor√≠a, esto deber√≠a funcionar ... ¬øQu√© pas√≥?</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/7i/kc/xs/7ikcxsonvzc4h99f-6obibt1o8u.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, por supuesto, mejor. </font><font style="vertical-align: inherit;">Sin embargo, hay un problema en que cambiamos el punto de salida, pero no cambiamos el b√∫fer. </font><font style="vertical-align: inherit;">Por lo tanto, vemos dos llamadas del mismo comando. </font><font style="vertical-align: inherit;">Por supuesto, puede parecer que s√© lo que estoy haciendo, pero esto no es as√≠. </font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este punto, decid√≠ verificar el contenido del b√∫fer, as√≠ que volv√≠ al punto en el que comenc√© la depuraci√≥n:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Establec√≠ un punto de interrupci√≥n en el mismo lugar que la √∫ltima vez, y comenc√© a mirar el contenido de la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Comencemos con lo que vi en mi pantalla:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ha/ll/4c/hall4czp0c9scl5ybzmduvpa2iy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© crees que estar√° en la cadena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cuando presione &lt;Enter&gt;?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cadena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LARGA DESCRIPCI√ìN"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo el b√∫fer que ahora vemos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo el b√∫fer, pero sin la primera l√≠nea.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No languidecer√©: todo el b√∫fer, pero sin la primera l√≠nea. </font><font style="vertical-align: inherit;">Y este es un problema considerable, porque es precisamente por eso que estamos perdiendo la historia, adem√°s, puntiagudos. </font><font style="vertical-align: inherit;">As√≠ es como se ver√° nuestro fragmento de salida de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ayuda</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> despu√©s de ir a una nueva l√≠nea:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/rc/n8/d9/rcn8d94h6tyf1qtscqyqvfvtn24.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con una flecha marqu√© el lugar donde estaba </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"DESCRIPCI√ìN LARGA"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">¬øQuiz√°s entonces sobrescribir el b√∫fer con un desplazamiento de una l√≠nea? </font><font style="vertical-align: inherit;">Esto funcionar√≠a si no se llamara a esta devoluci√≥n de llamada por cada estornudo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He descubierto al menos tres situaciones cuando se llama,</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando ingresamos cualquier personaje;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando nos movemos por la historia;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando ejecutamos el comando.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema es que solo necesita mover el b√∫fer cuando ejecutamos el comando o ingresar &lt;Enter&gt;. </font><font style="vertical-align: inherit;">En otros casos, hacer esto es una mala idea. </font><font style="vertical-align: inherit;">Por lo tanto, debemos determinar de alguna manera dentro de lo que se debe cambiar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/yo/ij/pbyoijjc9y4dezbt9wizjxrwnb0.png" alt="Cuadro 18"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este art√≠culo fue un intento de mostrar cu√°n h√°bilmente PVS-Studio pudo encontrar c√≥digo defectuoso que condujo al error que not√©. </font><font style="vertical-align: inherit;">El mensaje sobre el tema de restar una variable de s√≠ mismo me motiv√≥ fuertemente y proced√≠ vigorosamente a escribir el texto. </font><font style="vertical-align: inherit;">Pero como puede ver, mi alegr√≠a fue prematura y todo result√≥ ser mucho m√°s complicado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces decid√≠ parar. </font><font style="vertical-align: inherit;">Todav√≠a se pod√≠a pasar un par de noches, pero cuanto m√°s tiempo hac√≠a esto, surg√≠an m√°s y m√°s problemas. </font><font style="vertical-align: inherit;">Todo lo que puedo hacer es desear buena suerte a los desarrolladores de Windows Terminal para solucionar este error. </font><font style="vertical-align: inherit;">:)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero no haber decepcionado al lector de que no termin√© la investigaci√≥n y fue interesante para m√≠ dar un paseo por el interior del proyecto. Como compensaci√≥n, sugiero usar el c√≥digo de promoci√≥n #WindowsTerminal, gracias al cual recibir√° una versi√≥n demo de PVS-Studio no durante una semana, sino inmediatamente durante un mes. Si no ha probado el analizador est√°tico PVS-Studio en la pr√°ctica, esta es una buena raz√≥n para hacerlo. Simplemente ingrese "#WindowsTerminal" en el campo "Mensaje" en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la p√°gina de descarga</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y tambi√©n, aprovechando esta oportunidad, quiero recordarles que pronto habr√° una versi√≥n del analizador C # que funcione bajo Linux y macOS. Y ahora puedes inscribirte para las pruebas preliminares.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea compartir este art√≠culo con una audiencia de habla inglesa, utilice el enlace a la traducci√≥n: Maxim Zvyagintsev. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La peque√±a barra de desplazamiento que no pudo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es493026/index.html">Pruebas en productos: Despliegue de Canarias</a></li>
<li><a href="../es493032/index.html">5. Preguntas frecuentes de Check Point Maestro (FAQ)</a></li>
<li><a href="../es493034/index.html">COVID-19: prediciendo el n√∫mero de pacientes con coronavirus</a></li>
<li><a href="../es493036/index.html">Giro y giro, quiero confundir: manipulaciones con grafeno de dos capas</a></li>
<li><a href="../es493038/index.html">Sobre cultura corporativa para equipos distribuidos y no solo</a></li>
<li><a href="../es493042/index.html">Segmento de datos de audiencia del mercado de publicidad y marketing en l√≠nea. Parte. 1. Cambios en la legislaci√≥n</a></li>
<li><a href="../es493046/index.html">C√≥mo planificar la apertura de un caf√© o escribir su propio planificador para abrir establecimientos</a></li>
<li><a href="../es493050/index.html">Buscar no es qu√© encontrar</a></li>
<li><a href="../es493052/index.html">Problema</a></li>
<li><a href="../es493060/index.html">El trabajo remoto como una oportunidad para revelar al gerente del proyecto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>