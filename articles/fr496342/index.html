<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úíÔ∏è üéê üë©üèº‚Äçüè´ Mise √† jour du processus CI / CD: teamcity üë∏üèª ü§≤üèª ü§òüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il s'agit du deuxi√®me article d'une s√©rie sur la mise √† jour des processus CI / CD. Jusque-l√†, des pr√©paratifs √©taient en cours pour la mise en place ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mise √† jour du processus CI / CD: teamcity</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496342/"><img src="https://habrastorage.org/webt/cu/y-/hg/cuy-hgxvywohqkg_tbyr2wn268c.png" alt="image" align="left" width="300"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit du deuxi√®me article d'une s√©rie sur la mise √† jour des processus CI / CD. Jusque-l√†, des pr√©paratifs √©taient en cours pour la mise en place de nouveaux outils, √† savoir: la planification, les rassemblements quotidiens, la r√©solution des d√©saccords, en g√©n√©ral, sans lesquels il ne serait pas possible de construire avec comp√©tence un processus de travail. Et maintenant, tous les probl√®mes ont √©t√© r√©solus, nous sommes convaincus que nous pouvons poursuivre le d√©veloppement, et notre code ne s'enfoncera pas dans le trou noir avec le d√©but de l'√©t√©.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permettez-moi de vous rappeler la table des mati√®res de la liste des articles, ainsi que les brefs r√©sultats de la partie pr√©c√©dente. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 1: ce qui est, pourquoi ce n'est pas comme, la planification, un petit coup bash.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J'appellerais cette partie presque technique. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 2: teamcity. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 3: d√©ploiement de poulpe.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Partie 4: dans les coulisses. Moments d√©sagr√©ables, plans pour l'avenir, √©ventuellement FAQ. Tr√®s probablement, il peut √©galement √™tre qualifi√© de quasi-technique.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons fourni au client une preuve de concept d'un nouveau syst√®me de livraison de mise √† jour, identifi√© les lacunes du syst√®me existant, s√©lectionn√© la base du nouveau, √©labor√© un plan de transition et converti notre r√©f√©rentiel mercurial en git. De plus, dans la partie pr√©c√©dente, nous avons d√©crit les caract√©ristiques du projet qui affecteront l'ensemble du processus ult√©rieur.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme mentionn√© pr√©c√©demment, la solution existante ne r√©pondait pas aux exigences modernes. Initialement, tr√®s probablement, une version a √©t√© configur√©e dans ccnet. La toute premi√®re construction avec laquelle tout a commenc√© (comme un big bang, ouais). Ensuite, apparemment, la personne qui a tout configur√©, a appuy√© sur ctrl + c, ctrl + v, a corrig√© quelques lignes et a re√ßu une nouvelle configuration. Et pour tout le temps suivant, cela a √©t√© fait un nombre suffisant de fois pour que le code source sur le serveur de build prenne plus de 60G. Et ce ne sont que la source! Et il y a des journaux, des artefacts de construction, des fichiers temporaires, etc. Seulement cela m'a fait r√©fl√©chir. En regardant l'ancien syst√®me, on pouvait voir ce qui suit: une √©tape de construction a √©t√© effectu√©e pour chaque module. En fait, le m√™me noyau a √©t√© assembl√©. Et cet assemblage a √©t√© stock√© pour chaque module (ainsi que la source) sur le serveur.Les r√©sultats de la construction (identiques √† 90%) ont √©t√© transf√©r√©s dans des r√©f√©rentiels locaux (d√©ploiement git), et ont bien s√ªr √©galement pris leur place. Il √©tait possible et n√©cessaire de laisser cela.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©glages g√©n√©raux&nbsp;</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce stade, il est suppos√© qu'il existe d√©j√† une √©quipe et une pieuvre configur√©es. </font><font style="vertical-align: inherit;">Au stade de l'installation et de la configuration, nous ne nous arr√™tons pas en d√©tail. </font><font style="vertical-align: inherit;">Pour plus de commodit√©, nous √©crivons l'url et le jeton api de la pieuvre dans env teamcity, qui, en passant, pour le projet racine ressemble √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sa/vw/ir/savwiryxdsw8fpgrgvdzavejho0.png" alt="image"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.apiUserName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.apiUserPassword</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont des acc√®s api √† l'utilisateur teamcity (seront n√©cessaires plus tard), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.buildPath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env .sourcePath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le chemin par d√©faut vers les fichiers de g√©n√©ration et source, respectivement, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoApiKey</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoUrl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le jeton et l'url de la pieuvre. </font><font style="vertical-align: inherit;">Ils ont toujours </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.teamcityUrl</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ajout√©. </font><font style="vertical-align: inherit;">Eh bien, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tt.exe</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- chemin vers l'utilitaire de transformation de texte. </font><font style="vertical-align: inherit;">Cet utilitaire g√©n√®re toutes les configurations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parmi les plugins tiers, seule l'int√©gration d'Octopus Deploy est install√©e.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de ne pas surcharger la quantit√© d√©j√† √©norme de texte, seules les √©tapes dans lesquelles il y a quelque chose qui m√©rite l'attention seront examin√©es en d√©tail. </font><font style="vertical-align: inherit;">On suppose que tout le reste est compr√©hensible sur la base des donn√©es pr√©sent√©es et des connaissances du lecteur. </font><font style="vertical-align: inherit;">En tout cas, si vous avez des questions, je me ferai un plaisir d'y r√©pondre.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©partition du projet, versioning, noms</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le r√©sultat √©tait un tel sch√©ma de projet (comme une image, car il y a un probl√®me avec l'affichage d'une liste √† plusieurs niveaux): </font></font><br>
<img src="https://habrastorage.org/webt/-4/oq/gh/-4oqghadht5sr4rdpk7f3igz5do.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons versionner les packages comme suit: major.minor.patch, o√π major est toujours 1, mineur - compteur de build de la configuration de construction, patch - compteur de build pour la configuration D√©ployer (pas n√©cessaire pour la configuration de Build, donc toujours 0). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque: l'</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ancienne version est d√©crite ici. Nous le repensons pour qu'il soit bas√© sur la balise git. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3v/kl/ov/3vklovvjqjnhwa8yg0b3lxtduns.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, ici 1 est majeur, 95 est mineur et 1 est patch.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le nouveau processus pour les modules, il y aura une build qui sera ensuite d√©ploy√©e sur chaque module. Autrement dit, le code source est stock√© dans une seule copie pour chaque environnement, le r√©sultat de la construction l'est √©galement, car il est commun √† tous les modules. Les configurations et biblioth√®ques uniques sont regroup√©es dans un package individuel au stade du d√©ploiement. Cela utilisera efficacement l'espace disque et r√©duira le d√©lai de livraison de chaque paquet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au stade de la pr√©paration, il y a eu une br√®ve r√©union s√©par√©e sur la convention de d√©nomination des fichiers de configuration. C'√©tait (c'√©tait juste), mais pas toujours pareil. De plus, le nom de la configuration ne contenait pas toujours suffisamment d'informations. Par cons√©quent, tous les noms de configuration √©taient les suivants: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigurationType.Environment.ModName.config</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o√π ConfigurationType peut √™tre AppSettings, Web, etc. </font><font style="vertical-align: inherit;">Environnement - d√©veloppement, test, mise en sc√®ne, production. </font><font style="vertical-align: inherit;">ModName est le nom unique du module.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modules</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les projets de modules fonctionnent sur le m√™me principe.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque environnement a une configuration Build qui:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effectue la restauration de nuget (programme d'installation NuGet, restauration de nuget)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">G√©n√®re des configurations (ligne de commande, transformation de texte)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution Buildit (Visual Studio SLN)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©cup√®re les fichiers de env.buildPath dans zip et les pousse dans octopus (Octopus deploy: push packages)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation de version (pas de d√©ploiement) (Octopus deploy create release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©initialise la version du correctif (PowerShell)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe √©galement des configurations de d√©ploiement qui fonctionnent sur la base du mod√®le et effectuent les op√©rations suivantes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©cup√®re les configurations g√©n√©r√©es au stade de la construction (√©tape 2) (Octopus d√©ploie des packages push)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ployer la version principale (qui a √©t√© cr√©√©e √† l'√©tape 6 de la build) (Octopus deploy: deploy release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version individuelle de d√©ploiement (cr√©√©e √† l'√©tape 1 de la configuration actuelle) (Octopus deploy: deploy release)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Affiche une liste de tous les domaines pour ce module dans le journal (√©tape pour la commodit√© du testeur et du d√©veloppeur). </font><font style="vertical-align: inherit;">(Powershell).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour chaque configuration de d√©ploiement, la configuration de g√©n√©ration est ajout√©e √† la d√©pendance. </font><font style="vertical-align: inherit;">Cela permet de lancer automatiquement la build lorsqu'elle est d√©ploy√©e si elle n'est pas pertinente, ainsi que la possibilit√© de r√©initialiser la version du patch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuration de Deploy_all. </font><font style="vertical-align: inherit;">En fait, il s'agit d'une cha√Æne de g√©n√©ration qui d√©crit que vous devez d'abord ex√©cuter la g√©n√©ration si elle n'est pas pertinente, puis installer simultan√©ment tous les modes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela ressemble √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rq/ps/ck/rqpsckl2g8rrt9voltbt082itcu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons certaines des √©tapes un peu plus en d√©tail.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.General settings</font></font></h3><br>
<img src="https://habrastorage.org/webt/g_/5j/b9/g_5jb95h7ei6qexbvckqd8sxs7e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Du format de num√©ro de build inhabituel uniquement. </font><font style="vertical-align: inherit;">Sera expliqu√© plus tard.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.env</font></font></h3><br>
<img src="https://habrastorage.org/webt/a4/nr/bx/a4nrbxt_8ol6yjuo64npqfxuota.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un int√©r√™t: </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.coreProjectName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - d√©fini pour l'ensemble du projet. </font><font style="vertical-align: inherit;">N√©cessaire pour identifier le projet dans la pieuvre. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.Environment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - d√©fini pour le sous-projet Modules. </font><font style="vertical-align: inherit;">Il est n√©cessaire de s√©lectionner les bonnes configurations en fonction de l'environnement. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.octoChannel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le canal de la pieuvre dans lequel le paquet tombe. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identique</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† l' </font><i><font style="vertical-align: inherit;">environnement</font></i><font style="vertical-align: inherit;"> . </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.serviceName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le nom de la solution. </font><font style="vertical-align: inherit;">Fondamentalement, la variable est ajout√©e pour faciliter la visualisation. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tenantRoleTag</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - balise de </font><i><font style="vertical-align: inherit;">locataire</font></i><font style="vertical-align: inherit;"> dans la pieuvre. </font><font style="vertical-align: inherit;">Plus de d√©tails dans la section poulpe.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.4 </font></font></h3><br>
<img src="https://habrastorage.org/webt/a4/da/r1/a4dar1z6_kawzfttqbuvoivu_mm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez √† l'archive avec le nom </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% env.serviceName%.% Build.number% .zip</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fichiers du r√©pertoire avec le r√©sultat de la construction, √† l'exclusion de toutes les configurations, et dll du dossier bin / native. </font><font style="vertical-align: inherit;">Les derniers ont √©t√© ajout√©s manuellement au serveur Web une fois et personne ne les touchera √† nouveau. </font><font style="vertical-align: inherit;">Si n√©cessaire, ils seront √©galement mis √† jour manuellement (pour cela, il est pr√©vu d'√©crire un script s√©par√©, mais nous serons honn√™tes). </font><font style="vertical-align: inherit;">Cela est d√ª au fait que ces biblioth√®ques sont ¬´d√©tenues¬ª par le pool IIS, et pour un d√©ploiement r√©ussi, il doit √™tre arr√™t√© puis lanc√©, ce qui prend un certain temps. </font><font style="vertical-align: inherit;">En excluant ces biblioth√®ques du d√©ploiement, nous pouvons ignorer l'√©tape d'arr√™t du pool, ce qui r√©duira le temps de d√©ploiement et, par cons√©quent, les temps d'arr√™t.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.5</font></font></h3><br>
<img src="https://habrastorage.org/webt/us/hu/zx/ushuzxwer8u3iwqnuuqpjbuoodo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense que tout est clair ici, sauf pourquoi le champ Environnement est vide. </font><font style="vertical-align: inherit;">Dans ce que le paquet obtient, la pieuvre prend une d√©cision bas√©e sur la balise de pr√©-version (configur√©e dans les canaux). </font><font style="vertical-align: inherit;">Cette balise est contenue dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% build.number%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (la m√™me mise en sc√®ne √† l'√©cran dans Build.General). </font><font style="vertical-align: inherit;">Dans ce cas, cela s'est av√©r√© plus pratique. </font><font style="vertical-align: inherit;">Il convient √©galement de pr√™ter attention √† la case </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Afficher le processus de d√©ploiement¬ª</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">S'il n'est pas install√©, timsity consid√®re la construction r√©ussie d√®s que la pieuvre a commenc√© (mais pas termin√©!) Le travail. </font><font style="vertical-align: inherit;">Autrement dit, si la case √† cocher n'est pas install√©e et que quelque chose s'est mal pass√© pendant la phase de d√©ploiement - sans regarder l'interface octopus, nous ne le saurons pas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build.6</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rien d'inhabituel, juste un script PowerShell et des informations de la documentation de Teamcity.</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$pair</span> = <span class="hljs-string">"%env.apiUserName%:%env.apiUserPassword%"</span>
<span class="hljs-variable">$encodedCreds</span> = [<span class="hljs-type">System.Convert</span>]::ToBase64String([<span class="hljs-type">System.Text.Encoding</span>]::ASCII.GetBytes(<span class="hljs-variable">$pair</span>))
<span class="hljs-variable">$basicAuthValue</span> = <span class="hljs-string">"Basic <span class="hljs-variable">$encodedCreds</span>"</span>
<span class="hljs-variable">$depUri</span>=<span class="hljs-string">"%env.teamcityUrl%/app/rest/buildTypes?locator=snapshotDependency:(from:(build:(id:%teamcity.build.id%)),includeInitial:false)"</span>
<span class="hljs-comment"># Get all dependencies of main build</span>
<span class="hljs-variable">$result</span> = (<span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Headers</span> <span class="hljs-selector-tag">@</span>{<span class="hljs-string">'Origin'</span>=<span class="hljs-string">'http://localhost:8090'</span>; <span class="hljs-string">"Authorization"</span>=<span class="hljs-string">"<span class="hljs-variable">$basicAuthValue</span>"</span>} <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$depUri</span>)
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$i</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$result</span>.buildTypes.buildType.Count) { <span class="hljs-variable">$buildId</span> += <span class="hljs-variable">$result</span>.buildTypes.buildType.id }
<span class="hljs-variable">$buildId</span> = <span class="hljs-variable">$buildId</span> | <span class="hljs-built_in">Where-Object</span> { <span class="hljs-variable">$_</span> <span class="hljs-operator">-ne</span> <span class="hljs-string">'Module_DeployAll'</span> }
<span class="hljs-comment"># Reset all child build counters to 1. This build counters are patch versions in every build. (1.build.patch)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$buildId</span>.Count; <span class="hljs-variable">$i</span>++) {
  <span class="hljs-variable">$buildCounterUri</span> = <span class="hljs-string">"%env.teamcityUrl%/httpAuth/app/rest/buildTypes/"</span>+<span class="hljs-variable">$buildId</span>[<span class="hljs-variable">$i</span>]+<span class="hljs-string">"/settings/buildNumberCounter"</span>
  <span class="hljs-built_in">Invoke-RestMethod</span> <span class="hljs-literal">-Method</span> Put <span class="hljs-literal">-Headers</span> <span class="hljs-selector-tag">@</span>{<span class="hljs-string">'accept'</span>=<span class="hljs-string">'text/plain'</span>; <span class="hljs-string">'Origin'</span>=<span class="hljs-string">'http://localhost:8090'</span>; <span class="hljs-string">"Authorization"</span>=<span class="hljs-string">"<span class="hljs-variable">$basicAuthValue</span>"</span>} <span class="hljs-literal">-Uri</span> <span class="hljs-variable">$buildCounterUri</span> <span class="hljs-literal">-ContentType</span> <span class="hljs-string">"text/plain"</span> <span class="hljs-literal">-Body</span> <span class="hljs-number">1</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous avons besoin d'un utilisateur api dans teamcity (env est cr√©√© pour lui). </font><font style="vertical-align: inherit;">Nous nous connectons, prenons toutes les configurations qui d√©pendent de la configuration de Build et remettons leur compteur de build √† 1. C'est-√†-dire, en fait, pour chaque version de patch, c'est un indicateur du nombre de fois o√π la m√™me build a √©t√© d√©ploy√©e pour un module particulier. </font><font style="vertical-align: inherit;">S'il n'y en a pas 1, cela signifie que quelque chose s'est mal pass√© avec le processus de d√©ploiement ou de travail du module sur la version actuelle, et n√©cessite une attention.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ployer.G√©n√©ral</font></font></h3><br>
<img src="https://habrastorage.org/webt/aa/lx/p4/aalxp4uzeiofjnfo0tfdx57z0cs.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Format de version: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.% dep.Module_Build.build.counter%.% Build.counter% -staging</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o√π </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% dep.Module_Build.build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est la variable syst√®me teamcity dont la valeur correspond au compteur de build de la configuration de build correspondante (doit √™tre ajout√©e √† d√©pendances). </font><font style="vertical-align: inherit;">En fait, ici 1 est la version principale, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% dep.Module_Build.build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est mineur et </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">% build.counter%</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est patch. </font><font style="vertical-align: inherit;">staging est une balise de pr√©-version.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.Env</font></font></h3><br>
<img src="https://habrastorage.org/webt/wl/lc/sv/wllcsv3zxji40gzu-p1ef-vlgu4.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'ajout d'un nouveau module, seule la configuration de son d√©ploiement est ajout√©e et la valeur de la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.modName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est </font><i><font style="vertical-align: inherit;">indiqu√©e</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Toutes les autres variables sont h√©rit√©es des projets parents. </font><font style="vertical-align: inherit;">La variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.tenantModTag</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour une pieuvre est form√©e √† partir de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">env.modName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy.2</font></font></h3><br>
<img src="https://habrastorage.org/webt/zt/yx/2q/ztyx2q7ffqxfpwxtsrrol6ojfqy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©ployer le package principal.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Num√©ro de version le plus r√©cent: utilisez la derni√®re version disponible pour cet environnement. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tag locataire - tag client / organisation. </font><font style="vertical-align: inherit;">Plus de d√©tails dans la section poulpe. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Param√®tres cli suppl√©mentaires. </font><font style="vertical-align: inherit;">Ici, nous indiquons le canal dans lequel notre package tombera, ainsi que des param√®tres suppl√©mentaires. </font><font style="vertical-align: inherit;">Cela sera √©galement discut√© s√©par√©ment dans la section poulpe.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ployer.3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme Deploy.2, seul un package de module individuel est d√©ploy√©.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ployer.4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette √©tape sera √©galement d√©crite en d√©tail ci-dessous, car elle re√ßoit des donn√©es de la pieuvre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les configurations pour le site Web de la soci√©t√© et le module sp√©cial sont construites sur le m√™me principe, et les principaux points y sont les m√™mes, donc je ne vois pas l'int√©r√™t de les d√©crire avec le m√™me d√©tail. Ils ne font qu'un, ils n'ont pas besoin d'√™tre d√©ploy√©s plusieurs fois, et en fait il y a restauration de nuget, transformation de texte, msbuild, octopus push, octopus create release + deploy.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En savoir plus sur les configurations uniques. </font><font style="vertical-align: inherit;">Pour certains mods, il peut ne pas y avoir d'environnements (par exemple, de transfert), ils doivent √™tre d√©ploy√©s sur d'autres serveurs, ou vous devez d√©finir manuellement l'identifiant client (prenez la configuration de base et modifiez certains champs √† l'aide de PowerShell). </font><font style="vertical-align: inherit;">Autrement dit, ils fonctionnent sur le m√™me principe que les modules principaux. </font><font style="vertical-align: inherit;">Leur caract√®re unique r√©side dans le fait que des √©tapes sont ajout√©es / modifi√©es pour eux, ou que le serveur de d√©ploiement est modifi√© et qu'ils ne rentrent pas dans le mod√®le, il faut donc un peu plus de temps pour les cr√©er. </font><font style="vertical-align: inherit;">Heureusement, il y en a peu.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teamcity: R√©sum√©</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'impl√©mentation de teamcity a permis une approche plus optimale du processus d'assemblage des applications. Maintenant, cela prend beaucoup moins de temps: au lieu de construire le m√™me code √† chaque fois, nous le construisons une fois. Nous utilisons √©galement mieux l'espace disque, le trafic r√©seau et le temps de calcul. Auparavant, le nombre de packages √† d√©ployer (r√©f√©rentiels avec artefacts) √©tait √©gal au nombre de modules. Chaque colis pesait environ 100M sous forme compress√©e. Nous avons maintenant le nombre de packages un de plus que le nombre de modules, avec un package pesant environ les m√™mes 100M, et le reste environ 500K. De plus, une interface plus conviviale, des journaux pratiques et, surtout, r√©duisant le temps de maintenance du syst√®me de construction et l'ajout de configurations. L'ajout d'un nouveau module prend maintenant de 15 minutes √† une demi-heure.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√©par√©ment, il convient de dire √† propos des mod√®les, car c'est la normalisation qui nous permet de gagner du temps sur la cr√©ation de nouvelles configurations et leur maintenance ult√©rieure. Toutes les configurations d'interaction avec Octopus (d√©ploiement) sont construites sur la base d'un mod√®le unique. Tout d'abord, il permet d'unifier, et donc de simplifier le processus. Deuxi√®mement, comme d√©j√† mentionn√©, cela fait gagner du temps sur l'ajout de nouvelles configurations: nous avons connect√© un mod√®le, chang√© une variable, et c'est tout. Et surtout, les mod√®les simplifient la maintenance. Toutes les modifications apport√©es au mod√®le sont h√©rit√©es par des configurations bas√©es sur celui-ci. Donc, si nous devons ajouter une √©tape √† toutes les configurations √† la fois, nous n'avons pas besoin de toutes les cliquer, ajoutez simplement cette √©tape au mod√®le.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naturellement, le processus de configuration de teamcity allait de pair avec la configuration de poulpe. </font><font style="vertical-align: inherit;">Il est tout simplement impossible de d√©crire en parall√®le dans le texte, car il existe un grand risque de confusion. </font><font style="vertical-align: inherit;">Par cons√©quent, la description a √©t√© partag√©e et dans cette partie, seules les √©tapes de fourniture de CI sont d√©crites. </font><font style="vertical-align: inherit;">Le processus de configuration de la pieuvre sera d√©crit ci-dessous.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr496332/index.html">Antidron: reflet des attaques d'UAV et de quadricopt√®res</a></li>
<li><a href="../fr496334/index.html">Dell U4919DW Review: Moniteur √† √©cran incurv√© ultra-large de 49 pouces</a></li>
<li><a href="../fr496336/index.html">√Ä quoi servent les compteurs intelligents?</a></li>
<li><a href="../fr496338/index.html">Crise et c'est tout</a></li>
<li><a href="../fr496340/index.html">Nous formons un r√©seau comp√©titif g√©n√©ratif pour dessiner des images sur Azure ML</a></li>
<li><a href="../fr496344/index.html">Les hackathons en ligne de quarantaine sont-ils le bon moment?</a></li>
<li><a href="../fr496346/index.html">Nous ajoutons une v√©rification de hachage de chasseur de rootkit dans le script quotidien</a></li>
<li><a href="../fr496348/index.html">√âtudes de cas sur l'API de stockage Web</a></li>
<li><a href="../fr496350/index.html">Vous ne pouvez pas passer! - Les imprimantes 3D r√©pondent au coronavirus</a></li>
<li><a href="../fr496354/index.html">Programmation informatique ternaire: jouer avec l'√©mulateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>