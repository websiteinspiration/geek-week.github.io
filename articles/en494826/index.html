<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∏Ô∏è üèáüèΩ üë®‚Äç‚úàÔ∏è To be ‚Äúnew‚Äù or not to be ... ‚õπüèæ üë©üèæ‚Äçüîß ‚ôêÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello again. In anticipation of the start of the basic and advanced courses on Android development, we have prepared for you another interesting trans...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>To be ‚Äúnew‚Äù or not to be ...</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/494826/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello again. In anticipation of the start of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">basic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advanced</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> courses on Android development, we have prepared for you another interesting translation.</font></font><br>
</i></b><br>
<br>
<img src="https://habrastorage.org/webt/hs/u-/yp/hsu-ypxo7-folltm3lmhdm9p91w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dependency injection requires us</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to separate the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operators </font><font style="vertical-align: inherit;">and the application logic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This separation encourages you to use</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> factories in your code that are responsible for linking your application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . However, rather than writing factories, we would rather use</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> automatic dependency injection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , such as GUICE, to take over the binding. But can dependency injection really save us from all</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operators</font><font style="vertical-align: inherit;">?</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at two extremes. Say you have a MusicPlayer class that should get AudioDevice. Here we want to use dependency injection and request an AudioDevice in the MusicPlayer constructor. This will allow us to add a test-friendly AudioDevice, which we can use to claim that the correct sound comes out of our MusicPlayer. If we used the new operator to create an instance of BuiltInSpeakerAudioDevice, then we would have some testing difficulties. So let's call objects like AudioDevice or MusicPlayer ‚ÄúInjectable‚Äù. Injectable are the objects that you will request in the constructors and expect that the framework for implementing dependencies will provide you with them.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now to the other extreme. Suppose you have an int int primitive, but you want to auto-pack it into Integer, the simplest is to call new Integer (5), and that's the end. But if dependency injection is the new ‚Äúnew‚Äù, why do we call new in-line? Will it hurt our testing? It turns out that frameworks for injecting dependencies cannot give you the Integer you need, because they don‚Äôt understand what kind of Integer it is. This is a bit of a toy example, so let's look at something more complex. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose a user has entered an email address in the login field, and you need to call new Email (</font></font><code>¬´a@b.com¬ª</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Can we leave it like this, or should we request Email in our constructor? Again, the dependency injection framework cannot provide you with Email, because you must first get the String in which the email is located. And there are a lot of String s to choose from. As you can see, there are many objects that the dependency injection framework can never provide. Let's call them "Newable", as you will be forced to call </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for them </font><font style="vertical-align: inherit;">manually.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, let's set some basic rules. An Injectable class can query other Injectable in its constructor. (Sometimes I call Injectable as a Service Object, but this term is overloaded.) Injectable tend to have interfaces, as there is a chance that we will have to replace them with an implementation that is convenient for testing. However, Injectable can never query non-Injectable (Newable) in its constructor. This is because the dependency injection framework does not know how to create a Newable. Here are some examples of classes I would expect from my dependency injection framework: CreditCardProcessor, MusicPlayer, MailSender, OfflineQueue. Similarly, Newable can be requested by other Newable in their constructor, but not Injectable (sometimes I call Newable as a Value Object, but again,this term is overloaded). Some examples of Newable: Email, MailMessage, User, CreditCard, Song. If you follow these distinctions, your code will be easy to test and work with. If you break these rules, your code will be difficult to test.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at the example of MusicPlayer and Song</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<font></font>
  Song(String name, <span class="hljs-keyword">byte</span>[] content);<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MusicPlayer</span> </span>{
  <span class="hljs-meta">@Injectable</span><font></font>
  MusicPlayer(AudioDevice device);<font></font>
  play(Song song);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that Song only queries objects that are Newable. </font><font style="vertical-align: inherit;">This makes it very easy to instantiate a Song in a test. </font><font style="vertical-align: inherit;">MusicPlayer is completely Injectable, like its AudioDevice argument, so it can be obtained from the framework for dependency injection. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see what happens if MusicPlayer breaks the rule and requests Newable in its constructor.</font></font><br>
 <br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<font></font>
  String name;<font></font>
  <span class="hljs-keyword">byte</span>[] content;<font></font>
  Song(String name, <span class="hljs-keyword">byte</span>[] content);<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MusicPlayer</span> </span>{<font></font>
  AudioDevice device;<font></font>
  Song song;<font></font>
  <span class="hljs-meta">@Injectable</span><font></font>
  MusicPlayer(AudioDevice device, Song song);<font></font>
  play();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, Song is still Newable, and it's easy to create in your test or in your code. MusicPlayer is already a problem. If you ask MusicPlayer from your framework for dependency injection, it will crash because the framework will not know which Song it is about. Most people new to dependency injection frameworks rarely make this mistake, as it is easy to notice: your code will not work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see what happens if Song breaks the rule and requests Injectable in its constructor.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MusicPlayer</span> </span>{<font></font>
  AudioDevice device;<font></font>
  <span class="hljs-meta">@Injectable</span><font></font>
  MusicPlayer(AudioDevice device);<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<font></font>
  String name;<font></font>
  <span class="hljs-keyword">byte</span>[] content;<font></font>
  MusicPlayer palyer;<font></font>
  Song(String name, <span class="hljs-keyword">byte</span>[] content, MusicPlayer player);<font></font>
  play();<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SongReader</span> </span>{<font></font>
  MusicPlayer player<font></font>
  <span class="hljs-meta">@Injectable</span><font></font>
  SongReader(MusicPlayer player) {<font></font>
    <span class="hljs-keyword">this</span>.player = player;<font></font>
  }<font></font>
  <span class="hljs-function">Song <span class="hljs-title">read</span><span class="hljs-params">(File file)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Song(file.getName(),<font></font>
                    readBytes(file),<font></font>
                    player);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first glance, everything is fine. But think about how Songs will be created. Presumably, the songs are stored on disk, so we need SongReader. SongReader will have to request MusicPlayer so that when calling new for Song, it can satisfy Song's dependencies on MusicPlayer. Have you noticed anything wrong here? What fright does SongReader need to know about MusicPlayer? This is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">violation of the law of Demeter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. SongReader should not know about MusicPlayer. At least because SongReader does not call methods with MusicPlayer. He only knows about MusicPlayer because Song has violated the Newable / Injectable separation. SongReader pays for the error in Song. Since the place where the error is made and where the consequences are manifested is not the same thing, this error is very subtle and difficult to diagnose. It also means that many people are likely to make this mistake.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In terms of testing, this is a real pain. Suppose you have SongWriter and want to make sure it serializes Song to disk correctly. You need to create a MockMusicPlayer so that you can pass it to Song so that you can pass it to SongWritter. Why do we even come across MusicPlayer here? Let's look at it the other way. Song is what you might want to serialize, and the easiest way to do this is to use Java serialization. Thus, we serialize not only Song, but also MusicPlayer and AudioDevice. Neither MusicPlayer nor AudioDevice should be serialized. As you can see, small changes greatly facilitate testability.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, working with code is easier if we separate these two kinds of objects. If you mix them, your code will be difficult to test. Newable are the objects that are at the end of the object graph of your application. Newable may depend on other Newable, for example, how CreditCard may depend on Address, which may depend on City - these things are sheets of the application graph. Since they are sheets and do not communicate with any external services (external services are Injectable), they do not need to do stubs. Nothing looks like String anymore than String itself. Why should I make a stub for User, if I can just call new User, why make stubs for any of this: Email, MailMessage, User, CreditCard, Song? Just call </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and end it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's pay attention to something very subtle. </font><font style="vertical-align: inherit;">It is normal for Newable to know about Injectable. </font><font style="vertical-align: inherit;">What is not normal is that Newable has a reference to Injectable as a field. </font><font style="vertical-align: inherit;">In other words, Song can know about MusicPlayer. </font><font style="vertical-align: inherit;">For example, it is normal for Injectable MusicPlayer to be passed through the stack to Newable Song. </font><font style="vertical-align: inherit;">Because passing through the stack is independent of the framework for dependency injection. </font><font style="vertical-align: inherit;">Like in this example:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{<font></font>
  Song(String name, <span class="hljs-keyword">byte</span>[] content);
  <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isPlayable</span><span class="hljs-params">(MusicPlayer player)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem occurs when Song has a link field to MusicPlayer. </font><font style="vertical-align: inherit;">Link fields are set through the constructor, which will cause a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">violation of the Demeter law</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the caller, and difficulties for our tests.</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn more about courses</font></font></h4><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android developer. </font><font style="vertical-align: inherit;">Basic course</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android developer. </font><font style="vertical-align: inherit;">Advanced course</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494810/index.html">Introduction to 3D: Three.js Basics</a></li>
<li><a href="../en494814/index.html">Is Slurm useful?</a></li>
<li><a href="../en494818/index.html">How to choose a trading terminal to work on the exchange</a></li>
<li><a href="../en494820/index.html">How Intel's ATX12VO Power Supply Specification Will Change the Future</a></li>
<li><a href="../en494824/index.html">How the content system of Turbo pages is arranged: schemes, facts and a bit of history</a></li>
<li><a href="../en494830/index.html">ViennaNET: a set of libraries for the backend</a></li>
<li><a href="../en494838/index.html">GSM / 3G / 4G modems in embedded systems using the Quectel EC21 LTE modem and Yocto Project as an example</a></li>
<li><a href="../en494848/index.html">15 women who have made a great contribution to astronomy</a></li>
<li><a href="../en494850/index.html">Configure Microsoft Windows Server 2016/2019 to provide DHCP services for VXLAN (DFA)</a></li>
<li><a href="../en494854/index.html">Security Week 14: pandemic privacy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>