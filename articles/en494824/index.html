<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∏üèª üìé ü§± How the content system of Turbo pages is arranged: schemes, facts and a bit of history üèÇüèª ü§ñ üà∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to TelecomDaily , almost 30% of mobile Internet users in Russia daily have problems downloading sites. However, the reason may be not only i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How the content system of Turbo pages is arranged: schemes, facts and a bit of history</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/494824/"><img src="https://habrastorage.org/webt/hq/a5/mv/hqa5mvtylx0m3ns_yixifxt1qw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TelecomDaily</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , almost 30% of mobile Internet users in Russia daily have problems downloading sites. However, the reason may be not only in uneven coverage, but also in too much "weight" of the page. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We cannot influence the quality of the connection, but to help webmasters simplify the content of the site, make it easier - why not? So, the technology of Turbo pages appeared in Yandex: everything needed for placement is transferred to our content system, and it converts this data into easy and fast materials. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How does this magic work? What is the data path before becoming a full Turbo page? My name is Stas Makeev, I lead the development of technology Turbo pages. Now I‚Äôll try to explain everything.</font></font><br>
 <a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But first, it‚Äôs a bit of a summary so that you don‚Äôt get lost when I start to delve into the details.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A key advantage of the Turbo pages system is the quick conversion of data from the original form to the final one: the materials of news sites are most in demand in the first minutes after publication, and the cards of goods of online stores should be updated promptly and always correspond to the current status of availability. The second important parameter is reliability: the content system should be as stable as possible, be able to survive the breakdown of individual servers or even entire data centers. And, of course, it was important to prevent excessive load on the hosts of our partners connected to the Turbo pages. That is, when designing the service, it was necessary to somehow find a balance between the speed of data processing and the increase in the number of requests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Site owners have several ways to connect to the system:</font></font><br>
<br>
<ul>
<li>  . : YML ‚Äî  -, RSS ‚Äì   ;</li>
<li>   API:          (    );</li>
<li> : -       .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The content system stores the results of its work in a special storage of the "key-value" type (key-value-storage or KV-storage), where the key is the URL of the original site, and the value stores the content of the Turbo page. </font><font style="vertical-align: inherit;">As soon as the data enters this KV-storage, the next Turbo page immediately becomes available to search users, and in Yandex services the corresponding document has a special icon with a rocket. </font><font style="vertical-align: inherit;">Also, to speed up work, we cache pictures and videos in our CDNs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A very simplified general scheme of work looks like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/mq/u5/aomqu5polx3u8fse71spyit1eam.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it all began</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The very first version of the content system was arranged quite simply: every few minutes, according to the schedule, the same program was launched on the Yandex internal cloud server. </font><font style="vertical-align: inherit;">It consisted of several steps, each next run after the previous data was ready for all the feeds we know:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The list of RSS feeds was downloaded, the document parser was launched;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a list of images was extracted from the parser results;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not cached pictures were loaded into the CDN yet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processed documents were poured into the KV repository.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a scheme worked perfectly when the system dealt with several thousand rather light RSS feeds of news agencies (in total - information about a little less than 100,000 documents). But with the increase in the number of feeds, a problem was quickly discovered: each step took more and more time, there was a delay between the appearance of a new document in the original source and its display in Turbo mode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We managed to keep the situation under control with the help of various tricks: the first thing we did was select the first step (downloading RSS feeds + a document parser) into a separate process. That is, while one was processing pictures for the previous iteration, the other process was already downloading feeds for the next. After some time, it became clear: in this form, the system is very difficult to scale. We need something fundamentally new.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processing RSS, API and YML in the new content system</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main problem of the old content system was that all the data was processed in one piece: there was no transition to the next step until each document passed the previous one. </font><font style="vertical-align: inherit;">To get rid of this, it was decided to build a certain pipeline: let the feeds and individual documents be processed as independently as possible. </font><font style="vertical-align: inherit;">All steps were separated into separate service cubes - at the top level, the scheme turned out like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g6/lp/xd/g6lpxdauqtwxm9alh-mrgyf_wro.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the first cube downloads RSS feeds and passes on;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the second - takes feeds one by one, parses the contents. </font><font style="vertical-align: inherit;">At the exit - separate documents;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the third - takes documents one at a time, processes pictures and videos, records everything in the KV-storage.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same feeds can be registered not only in Turbo, but also on our other services - in the News or in the Market, for example. If each of them downloads data on its own, the load on the webmasters server will be several times higher than the allowable one. How right? Download the feed once, and then distribute the content to all consumer services - Yandex.Robot does this. We use his services for downloading content: we take from Yandex.Webmaster a list of RSS and YML feeds registered in Turbo, transfer it to Robot and subscribe to the download results.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the received data, start the parser. Just in case, let me remind you: an RSS feed is just a file in the ‚Äú.XML‚Äù format, accessible by a static URL on the partner‚Äôs host. This file contains information about all updates on the site - which documents are new, which are changed. Only the most up-to-date information in the last few hours would be in ideal feeds: no more than 100 documents per several hundred kilobytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reality bites: sometimes the files are inside the feed for a very long time and never change. How to avoid reprocessing in such cases? We calculate the hash of each document, store it in the database, and do nothing until the hash changes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Processing YML feeds and APIs from the point of view of the content system is practically no different from interacting with RSS: for YML, we start another parser, and the data transmitted through the API is obtained directly from Yandex.Webmaster.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/hh/gz/rehhgz4wtfo8nqylaexh74z5dga.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Image and video processing</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The document that is received at the output of the parser is almost ready for writing to the KV-storage. </font><font style="vertical-align: inherit;">The only thing left to do before sending is to process the images and videos: cache in the CDN and replace the links in the document. </font><font style="vertical-align: inherit;">Here again we turn to the Robot for help. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we check each picture and video: are they in the CDN? </font><font style="vertical-align: inherit;">If everything is already cached, replace the links and send the updated document to the KV repository. </font><font style="vertical-align: inherit;">Otherwise:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we send the list of missing URLs to the Robot for planning and downloading;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the document itself is in temporary storage, so after a while try to check it again.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another cube at this time receives the download results, uploads the data to the CDN and updates the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In such a scheme, another important problem related to planning can be solved: the robot understands how fast it is possible to download data from different hosts, and does not allow overloads. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2n/g4/oz/2ng4oz6c5ocn3jjbld4armtcewk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Typical path that a new document follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The document appears in the feed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The robot downloads the feed;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the parser discovers a new document and sends it further;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we check that the pictures from the document are not mentioned in the database, order the download, the document is sent to temporary storage (Delay). </font><font style="vertical-align: inherit;">While the document is there, the Robot downloads the pictures, they are cached in the CDN, and the links appear in the database;</font></font></li>
<li>       ,    CDN,      KV-. </li>
<li> :    ,       Delay.</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is another way to connect to Turbo pages, for which the webmaster does not need to do anything - Autoparser. </font><font style="vertical-align: inherit;">It builds Turbo pages based on the source data of the content site. </font><font style="vertical-align: inherit;">You can connect, see examples of finished pages, configure ads and analytics in Yandex.Webmaster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main difficulty that AutoParser faces is to recognize by HTML markup what basic information should be used when building a Turbo page. </font><font style="vertical-align: inherit;">To do this, we have several offline processes that are trying to understand exactly how to parse a specific host. </font><font style="vertical-align: inherit;">I will focus on two main ones:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first</font></font></b>     RSS-    HTML-  .  ‚Äî    ,       RSS- (    ),   .   ,    .        CatBoost  ,   ,      .     ,          , , .  ,          .  ,     ,  ,        HTML     . ?  :     .  ‚Äì    ,    .</li>
<li><b></b>   :            ..  ,    ,   ,          ,   ‚Äî  .       ‚Äî   .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, one more frequent obstacle - many sites block the ability to download images by robots in robots.txt. Unfortunately, it is impossible to get around this problem, and the Autoparser is not available for such pages. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the full scheme of the content system looks like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ll/jx/-a/lljx-adtt8ykngcnfnutykobxr4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system turned out to be well scalable: now a significant amount of resources are used to service the database, autoparser and other components of the system (only the cube responsible for parsing RSS, YML and API uses more than 300 processor cores), and in case of increased load it will not be too difficult to connect additional capacities. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for reading to the end! I hope, after this material, in the work of Turbo pages you will get more logic and less magic (by the way, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- even more details about Turbo pages). </font><font style="vertical-align: inherit;">If something is still incomprehensible, write in the comments - we are in touch.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494808/index.html">Product analyst: what does it do, how much does it make, what benefits does the business bring</a></li>
<li><a href="../en494810/index.html">Introduction to 3D: Three.js Basics</a></li>
<li><a href="../en494814/index.html">Is Slurm useful?</a></li>
<li><a href="../en494818/index.html">How to choose a trading terminal to work on the exchange</a></li>
<li><a href="../en494820/index.html">How Intel's ATX12VO Power Supply Specification Will Change the Future</a></li>
<li><a href="../en494826/index.html">To be ‚Äúnew‚Äù or not to be ...</a></li>
<li><a href="../en494830/index.html">ViennaNET: a set of libraries for the backend</a></li>
<li><a href="../en494838/index.html">GSM / 3G / 4G modems in embedded systems using the Quectel EC21 LTE modem and Yocto Project as an example</a></li>
<li><a href="../en494848/index.html">15 women who have made a great contribution to astronomy</a></li>
<li><a href="../en494850/index.html">Configure Microsoft Windows Server 2016/2019 to provide DHCP services for VXLAN (DFA)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>