<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüíª üìÜ üöµüèº Under the hood of the Yandex.Music bot client üßô ‚ô¶Ô∏è ü§∞üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction
 Hello, Habr! Again, I am with the second article affecting the Yandex.Music API. The case is planned and mentioned in the first article ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Under the hood of the Yandex.Music bot client</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487428/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello, Habr! </font><font style="vertical-align: inherit;">Again, I am with the second article affecting the Yandex.Music API. </font><font style="vertical-align: inherit;">The case is planned and mentioned in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hands reached, done. </font><font style="vertical-align: inherit;">Today I will talk about interesting, in my opinion, moments that are present in the codebase of my Telegram bot, which positions itself as a full-fledged client of music. </font><font style="vertical-align: inherit;">We will also touch the Yandex music recognition API. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before proceeding to the point-by-point story of the implementation of a particular thing, it would be worthwhile to have an idea about the bot itself and its functional capabilities.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Client video demo</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/YOw9hs8tFg0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the main part I will talk about the following:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sign in to your account through the site on </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub Pages</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (why and why).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The data format, its packaging, and use in button data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update routing, data versioning, context throwing into handlers.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Services:</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Service reloading track in Telegram.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The service of ‚Äúsubscriptions‚Äù to receive a track with sending the status of the download.</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The simplest and most elegant query caching implementation.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recognition of a track by voice message and how it generally appeared in the bot.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Small notes.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are interested in at least one point - welcome to cat.</font></font><br>
<img src="https://habrastorage.org/webt/uv/4s/a3/uv4sa3pslohuzlmuzrjzteju2dk.png"><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The bot works with users who have logged into their account, but no. </font><font style="vertical-align: inherit;">Everything revolves around four main classes of service: album, artist, playlist and track. </font><font style="vertical-align: inherit;">All entity data is supported, there is pagination with page selection. </font><font style="vertical-align: inherit;">To interact with them, an authorized user can use their personal menu, which includes: smart playlists, the ‚ÄúI like‚Äù playlist and their own playlists. </font><font style="vertical-align: inherit;">For unauthorized users, search is available - sending a search query as a regular message. </font><font style="vertical-align: inherit;">Now there‚Äôs just a dry list of what else is there: receiving tracks and other objects via a direct link, receiving lyrics, the ability to like / dislike the track and the artist, viewing similar tracks, recognizing the track by voice message and more.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Main part</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Login to account</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, the bot was not planned to work without authorization, therefore, even during the design, it was decided how authorization should occur - through </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">its website</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The main arguments were security and transparency. In no case did not want to accept user logins and passwords in clear messages. And authorization from the user's computer is elementary. Therefore, a site was written for authorization on </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">React</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It is a form of authorization with a redirect back to the bot. A piece with authorization and processing of captcha was taken from the library in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and rewritten in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaScript</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For authorization, the received OAuth token is used, which is transferred back to the bot via </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deep linking</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The final link for redirection looks like this: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/music_yandex_bot?start={oauth_token}</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
I wanted the best, but the users did not have trust. Only every tenth user was authorized (at the time when it was mandatory). Therefore, with the following updates, I had to explain why you should trust. All items about </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPS</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , exclusively about requests from the client side and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> were published on the site for authorization and duplicated in a welcome message in the bot. Got better. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, among the factors of low authorization, the inaccessibility of mirrors for t.me in Russia turned out to be and support for only users with a subscription (more on this in the notes, paragraph 7).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first item was resolved using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URI</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tg: //</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), and in a pinch, there‚Äôs already a link to the mirror (if the automatic redirect didn‚Äôt work, and the button didn‚Äôt help), and the second one is again in item 7.</font></font><br>
<img src="https://habrastorage.org/webt/ez/2_/0j/ez2_0japfosbu9k4bjelikl8x-i.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Data format</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this bot, I decided for the first time to use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NoSQL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DB - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Understood: when </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">embed a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> document, when not. Liked working with mongoengine. But I really didn‚Äôt want to store all the button data at home, and the client only has the </font><font style="vertical-align: inherit;">record </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the database. I was terrified of the amount of data, but I wanted to take a free Mongo server with a limit of 512 MB for data storage. To come up with a beautiful reuse of records if the data matches in several buttons and to clean outdated ones is much more difficult than storing everything in the buttons themselves. After analyzing the size of the data to be stored, I concluded that it fits easily. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, I just used </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSON</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but he very quickly refused it when he ran into a limit. In Telegram, the contents of the button data can only be no more than 64 bytes in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTF-8</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, with a friend‚Äôs prompt, I started looking at </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pack</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> module </font><font style="vertical-align: inherit;">. So the types of queries were born, the primitive format, packaging and unpacking. Now it is used in the bot absolutely everywhere. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The format is very simple. The first byte is the type, the second is the version. Everything else is data for a particular type. Types are stored as Enum, have an </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is the first byte. In addition to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , each type has a format for packing and unpacking data. For example: type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SHOW_TRACK_MENU</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whose format has the value "s?", where "s" is the unique identifier of the track, and "?" - Does the track have text. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At tracks used string type because: first, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the track can be a concatenation of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and album </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of the track through the colon, and secondly, it may be </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the UUID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tracks with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UUID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - self-loaded tracks, available only to the user who downloaded them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the data does not always correspond to the format, for example, the same </font><font style="vertical-align: inherit;">track </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be represented simply by a number, before packing it must be cast into a type for the format. In this case, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Therefore, in the class there is a method that normalizes the transferred data for packaging, so as not to do it yourself when passing to the constructor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Strings are self-sufficient and are able to indicate their length when packaging and take this length into account when unpacking. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Support for older versions was not planned, so an exception is thrown if versions do not match. </font><font style="vertical-align: inherit;">When processing updates, which I will discuss in the next paragraph, the necessary logic is called. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since Telegram eats exclusively </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTF-8</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the packed data is encoded in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base85</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Yes, I am losing speed here and saving the smallest in size without using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base64</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but given the small data, I consider using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base85</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appropriate.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source. </font><font style="vertical-align: inherit;">File callback_data.py</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">import</span> base64<font></font>
<font></font>
<span class="hljs-keyword">from</span> ext.query_types <span class="hljs-keyword">import</span> QueryType<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadDataVersion</span>(<span class="hljs-params">Exception</span>):</span>
    <span class="hljs-keyword">pass</span><font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CallbackData</span>:</span>
    ACTUAL_VERSION = <span class="hljs-number">7</span>
    BASE_FORMAT = <span class="hljs-string">'&lt;BB'</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, type_: QueryType, data=None, version=None</span>):</span><font></font>
        self.type = type_<font></font>
        self.version = version <span class="hljs-keyword">or</span> CallbackData.ACTUAL_VERSION<font></font>
        self.data = data<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> isinstance(self.data, list):<font></font>
            self.data = [self.data]<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.data = self._normalize_data_to_format(self.data)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f'&lt;CallbackData&gt; Type: <span class="hljs-subst">{self.type}</span> Version: <span class="hljs-subst">{self.version}</span> Data: <span class="hljs-subst">{self.data}</span>'</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_normalize_data_to_format</span>(<span class="hljs-params">self, data, bytes_object=False</span>):</span><font></font>
        normalized_data = data.copy()<font></font>
        <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> enumerate(self.type.format):<font></font>
            cast = str<font></font>
            <span class="hljs-keyword">if</span> c.lower() <span class="hljs-keyword">in</span> <span class="hljs-string">'bhilqn'</span>:<font></font>
                cast = int<font></font>
            <span class="hljs-keyword">elif</span> c <span class="hljs-keyword">in</span> <span class="hljs-string">'efd'</span>:<font></font>
                cast = float<font></font>
            <span class="hljs-keyword">elif</span> c == <span class="hljs-string">'?'</span>:<font></font>
                cast = bool<font></font>
<font></font>
            casted = cast(data[i])<font></font>
            <span class="hljs-keyword">if</span> bytes_object <span class="hljs-keyword">and</span> cast == str:<font></font>
                casted = casted.encode(<span class="hljs-string">'utf-8'</span>)<font></font>
            normalized_data[i] = casted<font></font>
<font></font>
        <span class="hljs-keyword">return</span> normalized_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode_type</span>(<span class="hljs-params">callback_data</span>):</span>
        decoded = base64.b85decode(callback_data.encode(<span class="hljs-string">'utf-8'</span>))<font></font>
        type_, version = struct.unpack(CallbackData.BASE_FORMAT, decoded[:<span class="hljs-number">2</span>])<font></font>
<font></font>
        <span class="hljs-keyword">if</span> CallbackData.ACTUAL_VERSION != version:
            <span class="hljs-keyword">raise</span> BadDataVersion()<font></font>
<font></font>
        <span class="hljs-keyword">return</span> QueryType(type_), version, decoded<font></font>
<font></font>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode</span>(<span class="hljs-params">cls, type_, version, decoded</span>):</span>
        start, data = <span class="hljs-number">2</span>, []<font></font>
<font></font>
        <span class="hljs-keyword">if</span> start &lt; len(decoded):<font></font>
            format_iter = iter(type_.format)<font></font>
<font></font>
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                <span class="hljs-keyword">if</span> start &gt;= len(decoded):
                    <span class="hljs-keyword">break</span><font></font>
<font></font>
                format_ = next(format_iter, type_.format[<span class="hljs-number">-1</span>])<font></font>
<font></font>
                decode_str = format_ <span class="hljs-keyword">in</span> <span class="hljs-string">'ps'</span>
                <span class="hljs-keyword">if</span> decode_str:
                    <span class="hljs-comment"># struct.calcsize('b') = 1</span>
                    length = list(struct.unpack(<span class="hljs-string">'b'</span>, decoded[start: start + <span class="hljs-number">1</span>]))[<span class="hljs-number">0</span>]<font></font>
                    start += <span class="hljs-number">1</span><font></font>
<font></font>
                    format_ = <span class="hljs-string">f'<span class="hljs-subst">{length}</span><span class="hljs-subst">{format_}</span>'</span><font></font>
<font></font>
                step = struct.calcsize(format_)<font></font>
<font></font>
                unpacked = list(struct.unpack(<span class="hljs-string">f'<span class="hljs-subst">{format_}</span>'</span>, decoded[start: start + step]))
                <span class="hljs-keyword">if</span> decode_str:<font></font>
                    unpacked[<span class="hljs-number">0</span>] = unpacked[<span class="hljs-number">0</span>].decode(<span class="hljs-string">'UTF-8'</span>)<font></font>
<font></font>
                data += unpacked<font></font>
                start += step<font></font>
<font></font>
        <span class="hljs-keyword">return</span> cls(type_, data <span class="hljs-keyword">if</span> data <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>, version)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encode</span>(<span class="hljs-params">self</span>):</span><font></font>
        encode = struct.pack(self.BASE_FORMAT, self.type.value, self.version)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            format_iter = iter(self.type.format)<font></font>
            normalized_data = self._normalize_data_to_format(self.data, bytes_object=<span class="hljs-literal">True</span>)<font></font>
<font></font>
            <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> normalized_data:<font></font>
                format_ = next(format_iter, self.type.format[<span class="hljs-number">-1</span>])<font></font>
<font></font>
                <span class="hljs-keyword">if</span> format_ <span class="hljs-keyword">in</span> <span class="hljs-string">'ps'</span>:
                    <span class="hljs-comment">#        .  'b'  </span>
                    <span class="hljs-comment"># -      ,    &gt; 36 </span>
                    encode += struct.pack(<span class="hljs-string">'b'</span>, len(data))<font></font>
                    encode += struct.pack(<span class="hljs-string">f'<span class="hljs-subst">{len(data)}</span><span class="hljs-subst">{format_}</span>'</span>, data)
                <span class="hljs-keyword">else</span>:<font></font>
                    encode += struct.pack(<span class="hljs-string">f'<span class="hljs-subst">{format_}</span>'</span>, data)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> base64.b85encode(encode).decode(<span class="hljs-string">'utf-8'</span>)<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Routing updates and context</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The project uses the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">python-telegram-bot</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">to work with the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram Bot API</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It already has a system for registering handlers for certain types of updates that have arrived, filters for regular expressions, commands, and so on. </font><font style="vertical-align: inherit;">But, given my own data format and my types, I had to inherit from </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TelegramHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and implement my </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update and context are passed to each handler through arguments. </font><font style="vertical-align: inherit;">In this case, I have my own context and it is in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler'e</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is being formed, and this is: receiving and / or adding a user to the database, checking the relevance of the token to gain access to music, initializing the Yandex.Music client, depending on the authorization status and the availability of a subscription. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further from my </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler'a there</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are more specific handlers, for example, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CallbackQueryHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . With it, a handler is registered for a certain type of update (my type, with a data format). To check whether this update is suitable for the current handler, not all data is unpacked, but only the first two bytes. At this stage, the need to launch a callback is verified. Only if launching the callback is necessary - is the data completely unpacked and transferred as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kwargs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the final handler. </font><font style="vertical-align: inherit;">Immediately there is a sending of analytical data to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ChatBase</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Registration takes place sequentially, and the priority is higher for who will be registered earlier (in fact, as in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Django</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> routing, and in other projects). </font><font style="vertical-align: inherit;">Therefore, registering a handler for an obsolete version is the first among </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CallBackQuery</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> handlers </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The logic of processing the outdated version is simple - inform the user about this and send updated data, if possible.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Services</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All services are initialized when the bot is launched in one control class, which is then universally used anywhere in the bot ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DJ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each service has its own </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadPoolExecutor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a certain number of workers into which tasks are submitted.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reloading a track in Telegram</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, this service has not been rewritten to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User Bot</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to bypass the limit on the size of the downloaded file in Telegram. As it turned out, in Yandex.Music there are files larger than 50 mb - podcasts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The service checks the file size and, in case of excess, throws an alert to the user. Thanks to the caching system described in paragraph 5, this checks for the availability and receipt of the lyrics. Tracks are also cached. The hash of the file is stored in the database. If there is one, audio with a known cache is being sent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the absence of a file in the database, a direct link is received from Yandex.Music. Although at the moment, users do not have the ability to change the quality settings, but all are set to standard values. The file is searched for by bitrate and codec from the user settings.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The file and its cover are downloaded as </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempfile.TemporaryFile ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , after which they are uploaded to Telegram. </font><font style="vertical-align: inherit;">It is worth noting that TG does not always correctly recognize the duration of the track, but I generally am silent about the artist and the title. </font><font style="vertical-align: inherit;">Therefore, these data are taken from Yandex, fortunately, it is possible to transmit them to the cart. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When an audio file is sent by this service, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finished_callback ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is called </font><font style="vertical-align: inherit;">, signaling the service by subscription about the end of the download.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Subscription service for receiving tracks and sending download status</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tracks are not loaded instantly. It is possible that several users requested the same track. In this case, the user who requested the track first is the initiator and owner of the track. When reloading more than a second, the download status starts: ‚ÄúThe user sends a voice message‚Äù. Other users who requested the same track are regular subscribers. They, like the owner, are sent the download status once every ~ 4 seconds so that the message does not interrupt (the status hangs for 5 seconds). As soon as the download of the track for the owner is completed, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finished_callback ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is called </font><font style="vertical-align: inherit;">from the service above. After that, all subscribers are deleted from the status list and receive the downloaded track.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the architectural solution, the owner of the track is also a subscriber, but with a certain mark, since the ways of sending the track are different.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Query caching</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we recall from my last article, requests to the Yandex.Music API are very heavy. The list of tracks can be 3 or 5 mb. Moreover, there are just a lot of requests. With each update processing, at least 2 requests are sent to Yandex: for initializing the client and for a specific action. In some places, to collect enough information (for example, for a playlist), you need to make a request for a playlist, for receiving its tracks, for information from the landing page (if this is a smart playlist), and do not forget about the initialization of the client. In general, quiet horror in terms of the number of requests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wanted something very universal, and not make any kind of storage for certain objects, the same clients. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the library allows you to specify your own instance for query execution, on top of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requests</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then I took advantage of this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The point is simple. The cache class itself is a singleton. It has only two parameters: cache lifetime, size. When the request is executed, the wrapper is called. He is overridden. Checking the cache occurs by hash of frozen args and quarts. The cache has time to add. When checking the necessity of updating the data, either data from </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LimitedSizeDict is obtained,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or a real request is made and added to the cache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some requests cannot be cached, for example, setting a like / dislike. If the user presses the following sequence: like, dislike, like, then in the end the like will not be delivered. For such cases, when sending a request, you need to pass the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use_cache</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> argument </font><font style="vertical-align: inherit;">with a value equal to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">False</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Actually, this is the only place where the cache is not used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to this, I make the most bold requests so that they are cached. </font><font style="vertical-align: inherit;">I‚Äôm not trying to break it into small ones and needed only for the current page. </font><font style="vertical-align: inherit;">I take everything at once, and when switching between pages I have a huge switching speed (in comparison with the old approach). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As for me, the cached request class turned out beautifully and was simply integrated.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> copy
<span class="hljs-keyword">import</span> time<font></font>
<font></font>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Union
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> OrderedDict<font></font>
<font></font>
<span class="hljs-keyword">import</span> requests<font></font>
<font></font>
<span class="hljs-keyword">from</span> yandex_music.utils.request <span class="hljs-keyword">import</span> Request <span class="hljs-keyword">as</span> YandexMusicRequest<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LimitedSizeDict</span>(<span class="hljs-params">OrderedDict</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        self.size_limit = kwargs.pop(<span class="hljs-string">"size_limit"</span>, <span class="hljs-literal">None</span>)<font></font>
        OrderedDict.__init__(self, *args, **kwargs)<font></font>
        self._check_size_limit()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__setitem__</span>(<span class="hljs-params">self, key, value</span>):</span><font></font>
        OrderedDict.__setitem__(self, key, value)<font></font>
        self._check_size_limit()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_check_size_limit</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">if</span> self.size_limit <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">while</span> len(self) &gt; self.size_limit:<font></font>
                self.popitem(last=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachedItem</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, response: requests.Response</span>):</span><font></font>
        self.timestamp = time.time()<font></font>
        self.response = response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span>:</span>
    __singleton: <span class="hljs-string">'Cache'</span> = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, lifetime: Union[str, int], size: Union[str, int]</span>):</span><font></font>
        Cache.__singleton = self<font></font>
<font></font>
        self.lifetime = int(lifetime) * <span class="hljs-number">60</span><font></font>
        self.size = int(size)<font></font>
<font></font>
        self.storage: LimitedSizeDict = LimitedSizeDict(size_limit=int(size))<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> self.storage[hash_].response<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">self, response: requests.Response, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
        self.storage.update({hash_: CachedItem(response)})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">need_to_fetch</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
        cached_item = self.storage.get(hash_)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cached_item:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> time.time() - cached_item.timestamp &gt; self.lifetime:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><font></font>
<font></font>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_instance</span>(<span class="hljs-params">cls</span>) -&gt; 'Cache':</span>
        <span class="hljs-keyword">if</span> cls.__singleton <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> cls.__singleton
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f'<span class="hljs-subst">{cls.__name__}</span> not initialized'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">freeze_dict</span>(<span class="hljs-params">d: dict</span>) -&gt; Union[frozenset, tuple, dict]:</span>
        <span class="hljs-keyword">if</span> isinstance(d, dict):
            <span class="hljs-keyword">return</span> frozenset((key, Cache.freeze_dict(value)) <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> d.items())
        <span class="hljs-keyword">elif</span> isinstance(d, list):
            <span class="hljs-keyword">return</span> tuple(Cache.freeze_dict(value) <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> d)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> d<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_hash</span>(<span class="hljs-params">*args, **kwargs</span>):</span>
        <span class="hljs-keyword">return</span> hash((args, Cache.freeze_dict(kwargs)))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span>(<span class="hljs-params">YandexMusicRequest</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_request_wrapper</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        use_cache = kwargs.get(<span class="hljs-string">'use_cache'</span>, <span class="hljs-literal">True</span>)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'use_cache'</span> <span class="hljs-keyword">in</span> kwargs:<font></font>
            kwargs.pop(<span class="hljs-string">'use_cache'</span>)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> use_cache:<font></font>
            response = super()._request_wrapper(*args, **copy.deepcopy(kwargs))<font></font>
        <span class="hljs-keyword">elif</span> use_cache <span class="hljs-keyword">and</span> Cache.get_instance().need_to_fetch(*args, **kwargs):<font></font>
            response = super()._request_wrapper(*args, **copy.deepcopy(kwargs))<font></font>
            Cache.get_instance().update(response, *args, **kwargs)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            response = Cache.get_instance().get(*args, **kwargs)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> response<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Track recognition by voice message</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the beginning, there was no thought to add this to the bot, but an interesting situation happened. The bot has a chat (it is indicated in the description of the bot). After some time, I noticed that people go into it and send voice messages with music. At first, I thought it was a new kind of spam such that someone botted and was kidding. But, when there were already 10 such people and everyone was doing the same thing, my friend (the same one suggested by </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) suggested that users drive Yandex.Music in search of an official bot for recognizing music from Yandex, they see a chat room there and send voice messages to it in all seriousness! It was just a brilliant and true assumption. Then I jokingly said that it was time to make recognition and add a bot to the chat. For fun ... After a while, this was done!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now about the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Recently, Yandex has increasingly used web sockets. I met their use in the management of an i.module and an i.station. The music recognition service also works on it. I threw the minimum working solution in my bot, but I did not add the implementation to the library. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WS</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is located at the following address: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wss: //voiceservices.yandex.net/uni.ws</font></font></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We need only two messages - authorization and a request for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recognize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex itself, in its official application, sends short files in a second or three. In response, you can get the need to send more data or the result - found or not. If the result is found, then the track ID will be returned. </font><i><font style="vertical-align: inherit;">.Ogg</font></i><font style="vertical-align: inherit;"> files are </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sent </font><font style="vertical-align: inherit;">with</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ENCODER = SpeechKit Mobile SDK v3.28.0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I did not check how it works with other encoders, I just change it in the file recorded by Telegram. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When reversing with a web socket, sometimes magic happened. </font><font style="vertical-align: inherit;">Sometimes I couldn‚Äôt find the track, but when I changed the language in the message with the recognition request, I did. </font><font style="vertical-align: inherit;">Or at first it found, and then it stopped, although the file is the same. </font><font style="vertical-align: inherit;">I thought that the language of the track is set by their </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SpeechKit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the client. </font><font style="vertical-align: inherit;">Not having such an opportunity to do it myself, I do a brute force search.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My knee-made implementation of voice recognition by voice messages from Telegram</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> lomond<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_auth_data</span>():</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"event"</span>: {
            <span class="hljs-string">"header"</span>: {
                <span class="hljs-string">"messageId"</span>: str(uuid.uuid4()),
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"SynchronizeState"</span>,
                <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"System"</span><font></font>
            },<font></font>
            <span class="hljs-string">"payload"</span>: {
                <span class="hljs-string">"accept_invalid_auth"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"auth_token"</span>: <span class="hljs-string">"5983ba91-339e-443c-8452-390fe7d9d308"</span>,
                <span class="hljs-string">"uuid"</span>: str(uuid.uuid4()).replace(<span class="hljs-string">'-'</span>, <span class="hljs-string">''</span>),<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_asr_data</span>():</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"event"</span>: {
            <span class="hljs-string">"header"</span>: {
                <span class="hljs-string">"messageId"</span>: str(uuid.uuid4()),
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"Recognize"</span>,
                <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"ASR"</span>,
                <span class="hljs-string">"streamId"</span>: <span class="hljs-number">1</span><font></font>
            },<font></font>
            <span class="hljs-string">"payload"</span>: {
                <span class="hljs-string">"advancedASROptions"</span>: {
                    <span class="hljs-string">"manual_punctuation"</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">"partial_results"</span>: <span class="hljs-literal">False</span><font></font>
                },<font></font>
                <span class="hljs-string">"disableAntimatNormalizer"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"format"</span>: <span class="hljs-string">"audio/opus"</span>,
                <span class="hljs-string">"music_request2"</span>: {
                    <span class="hljs-string">"headers"</span>: {
                        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"audio/opus"</span><font></font>
                    }<font></font>
                },<font></font>
                <span class="hljs-string">"punctuation"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"tags"</span>: <span class="hljs-string">"PASS_AUDIO;"</span>,
                <span class="hljs-string">"topic"</span>: <span class="hljs-string">"queries"</span><font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recognition</span>:</span>
    URI = <span class="hljs-string">'wss://voiceservices.yandex.net/uni.ws'</span>
    LANGS = [<span class="hljs-string">''</span>, <span class="hljs-string">'ru-RU'</span>, <span class="hljs-string">'en-US'</span>]<font></font>
    POLL_DELAY = <span class="hljs-number">0.3</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, binary_data, status_msg</span>):</span><font></font>
        self.status_msg = status_msg<font></font>
        self.websocket = lomond.WebSocket(self.URI)<font></font>
        self.chunks = self.get_chunks_and_replace_encoder(binary_data)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_track_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">for</span> lang <span class="hljs-keyword">in</span> Recognition.LANGS:<font></font>
            asr_data = get_asr_data()<font></font>
            <span class="hljs-keyword">if</span> lang:<font></font>
                asr_data[<span class="hljs-string">'event'</span>][<span class="hljs-string">'payload'</span>].update({<span class="hljs-string">'lang'</span>: lang})<font></font>
                self.status_msg.edit_text(<span class="hljs-string">f'     <span class="hljs-subst">{lang}</span>...'</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                self.status_msg.edit_text(<span class="hljs-string">f'      ...'</span>)<font></font>
<font></font>
            <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> self.websocket.connect(poll=self.POLL_DELAY):
                <span class="hljs-keyword">if</span> msg.name == <span class="hljs-string">'ready'</span>:<font></font>
                    self.websocket.send_json(get_auth_data())<font></font>
                    self.websocket.send_json(asr_data)<font></font>
<font></font>
                    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> self.chunks:<font></font>
                        self.websocket.send_binary(chunk)<font></font>
<font></font>
                <span class="hljs-keyword">if</span> msg.name == <span class="hljs-string">'text'</span>:<font></font>
                    response = msg.json.get(<span class="hljs-string">'directive'</span>)<font></font>
<font></font>
                    <span class="hljs-keyword">if</span> self.is_valid_response(response):<font></font>
                        self.websocket.close()<font></font>
<font></font>
                        <span class="hljs-keyword">return</span> self.parse_track_id(response)
                    <span class="hljs-keyword">elif</span> self.is_fatal_error(response):<font></font>
                        self.websocket.close()<font></font>
<font></font>
                        <span class="hljs-keyword">break</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_valid_response</span>(<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'header'</span>, {}).get(<span class="hljs-string">'name'</span>) == <span class="hljs-string">'MusicResult'</span> <span class="hljs-keyword">and</span> \<font></font>
                response.get(<span class="hljs-string">'payload'</span>, {}).get(<span class="hljs-string">'result'</span>) == <span class="hljs-string">'success'</span>:<font></font>
            self.status_msg.edit_text(<span class="hljs-string">f' ,  !'</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_fatal_error</span>(<span class="hljs-params">response</span>):</span>
        <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'header'</span>, {}).get(<span class="hljs-string">'name'</span>) == <span class="hljs-string">'MusicResult'</span> <span class="hljs-keyword">and</span> \<font></font>
                response.get(<span class="hljs-string">'payload'</span>, {}).get(<span class="hljs-string">'result'</span>) == <span class="hljs-string">'music'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_track_id</span>(<span class="hljs-params">response</span>):</span>
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">'payload'</span>][<span class="hljs-string">'data'</span>][<span class="hljs-string">'match'</span>][<span class="hljs-string">'id'</span>]<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_chunks_and_replace_encoder</span>(<span class="hljs-params">binary_data</span>):</span><font></font>
        chunks = []<font></font>
<font></font>
        <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> binary_data.split(<span class="hljs-string">b'OggS'</span>)[<span class="hljs-number">1</span>:]:
            <span class="hljs-keyword">if</span> <span class="hljs-string">b'OpusTags'</span> <span class="hljs-keyword">in</span> chunk:<font></font>
                pos = chunk.index(<span class="hljs-string">b'OpusTags'</span>) + <span class="hljs-number">12</span><font></font>
                size = len(chunk)<font></font>
                chunk = chunk[:pos] + <span class="hljs-string">b'#\x00\x00\x00\x00ENCODER=SpeechKit Mobile SDK v3.28.0'</span>
                chunk += <span class="hljs-string">b"\x00"</span> * (size - len(chunk))<font></font>
<font></font>
            chunks.append(<span class="hljs-string">b'\x00\x00\x00\x01OggS'</span> + chunk)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> chunks<font></font>
<font></font>
</code></pre><br>
     ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> </a>.<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Small notes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, only users with a subscription could use the bot due to the fact that the service can be used in a limited number of countries (without a subscription), and the server with the bot is located in Europe. The problem is solved by using a proxy to execute requests from users without a subscription. The proxy server is located in Moscow. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a choice of pages, but it is limited to 100 (no more buttons can be added, Telegram restriction). Some common page requests have a lot more pages.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Yandex search, the number of elements on the page is hardcoded. How many tracks, how many playlists. Sometimes this does not even correspond to the amount of data displayed on the front. There is a page change, the number of elements is floating. Therefore, in the bot it also jumps, which is not very beautiful. And to combine their paginator with his own - something like that. In other places where it is possible to request a certain number of elements per page, everything is perfect. The voice message after implementing the search in the bot is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/MarshalC/416</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When forward audio in Telegram, the author is lost and assigned to the one who made the forward. Therefore, all tracks are sent with the signature of the bot username. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voice message with everything that I met after the implementation of the radio in the library - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/MarshalC/422</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(about the chain of tracks, going through it with sending a heap of feedback, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_id</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the fact that this is another article about the Telegram bot, you read it right up to here, most likely because you were interested in one of the items in the cut and this is wonderful, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">thank you very much</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, I did not open the source code of the bot entirely (because in some places I need to refactor). </font><font style="vertical-align: inherit;">Much has been described in this article, but some aspects, for example, with virtual keyboards and their generation are not affected. </font><font style="vertical-align: inherit;">For the most part, what is not in the article is just working with my library, nothing interesting.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The classes around which everything revolves, I showed in the form in which they are now. I admit there are bugs, but it all works for a long time. In some places I like my code, in some places I don‚Äôt - and this is normal. Do not forget that working with WS for recognition is a solution on the knee. Ready to read reasoned criticism in the comments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although the bot was planned even when I started writing the library, then I disowned this idea, but, apparently, I returned (it was boring). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Music Bot - a project that proves the suitability of using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library to work with the API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in projects.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many thanks to Mom, Yana, Sana'a, Glory. </font><font style="vertical-align: inherit;">Someone for proofreading mistakes, some for hints, without which some points in this article might not have existed, and for some simply for evaluating the article before publication. </font><font style="vertical-align: inherit;">Arthur for picci for the article, Lyod for the logo. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now I have an acute issue with distribution after study. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are ready to make a call on me - tell me where to send the CV, interview me, please. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All my contacts are in the profile. </font><font style="vertical-align: inherit;">Timing is burning, I hope for you. </font><font style="vertical-align: inherit;">According to the law, I can only work out in the Republic of Belarus. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This was the second article of three, but without the slightest idea I will have time to do another project on this topic and whether it is needed. </font><font style="vertical-align: inherit;">I‚Äôll publicly reveal his topic - the cross-platform client Yandex.Music.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en487428/">https://habr.com/ru/post/en487428/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487418/index.html">What is SAP?</a></li>
<li><a href="../en487420/index.html">Sound War Z. Testing MusicDealer speakers and headphones</a></li>
<li><a href="../en487422/index.html">Salesforce Administrator Responsibilities: What Should Be Done and When</a></li>
<li><a href="../en487424/index.html">How to scale from 1 to 100,000 users</a></li>
<li><a href="../en487426/index.html">Flexibility determines success.</a></li>
<li><a href="../en487430/index.html">What skills are needed to create an iOS application? Yandex Report</a></li>
<li><a href="../en487432/index.html">In the footsteps of DevConf and CfgMgmtCamp or what you can learn by going to the speaker at 2 international conferences in 2 weeks</a></li>
<li><a href="../en487438/index.html">How to create an IT company from scratch - without experience in this field and programming skills?</a></li>
<li><a href="../en487444/index.html">‚ÄúWhile drinking coffee, billed and received a push for payment‚Äù - innovations that allow you to conduct business 24/7</a></li>
<li><a href="../en487446/index.html">Can a company ‚Äúown‚Äù color?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>