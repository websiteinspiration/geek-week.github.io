<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👇🏻 👖 👨🏿‍🚒 如何使用Prometheus检测GitLab中的异常 ♨️ 🌟 🌛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prometheus查询语言的基本功能之一是时间序列的实时汇总。您还可以使用Prometheus查询语言来检测时间序列数据中的异常。 
 
 该Mail.ru云解决方案团队已经翻译由GitLab基础架构团队的工程师的文章，在那里你会找到的代码示例，你可以尝试在你的系统中。
 
 什么是异常检测？
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>如何使用Prometheus检测GitLab中的异常</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometheus查询语言的基本功能之一是</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间序列</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的实时</font><font style="vertical-align: inherit;">汇总</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">您还可以使用Prometheus查询语言来检测时间序列数据中的异常。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru云解决方案</font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">团队已经</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻译</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">由GitLab基础架构团队的工程师的文章</font></a><font style="vertical-align: inherit;">，在那里你会找到的代码示例，你可以尝试在你的系统中。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">什么是异常检测？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
确定GitLab异常检测的重要性的四个主要原因：</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事件诊断</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：我们可以通过减少事件检测时间（MTTD）来检测哪些服务超出了正常范围，从而提供了更快的解决方案。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检测性能下降</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：例如，如果将回归引入到服务中，导致它过于频繁地访问另一个服务，则我们可以快速检测并解决此问题。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检测和消除滥用</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：GitLab提供了交付和集成机制（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）和托管（GitLab Pages），并且只有少数用户可以使用这些机制。</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安全性</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：异常检测对于检测GitLab时间序列中的异常趋势非常重要。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于这些和其他原因，本文的作者决定找出如何使用Prometheus查询和规则在GitLab时间序列中配置异常的定义。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正确的聚合级别是多少？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，必须正确汇总时间序列。</font><font style="vertical-align: inherit;">在下面的示例中，我们使用标准的http_requests_total计数器来检索数据，尽管许多其他指标也可以这样做。</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该测试指标具有多个参数：方法，控制器，状态码（status_code），环境以及Prometheus自身添加的参数，例如作业和实例。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您需要选择正确的数据聚合级别。</font><font style="vertical-align: inherit;">太多或太少-所有这些对于检测异常都很重要。</font><font style="vertical-align: inherit;">如果数据汇总过多，则存在两个潜在问题：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以跳过异常，因为聚合隐藏了数据子集中出现的问题。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果发现异常，则不付出额外努力就很难将其与系统的单独部分相关联。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果数据聚合不充分，则可能导致误报次数增加，以及将有效数据错误解释为错误。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据我们的经验，最正确的聚合级别是服务级别，也就是说，我们包括工作（工作）标签和环境（环境）标签，并丢弃所有其他标签。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将在本文中讨论的聚合包括：job-http_request，聚合-五分钟，这是根据五分钟内的工作和环境计算得出的。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从上面的示例中可以明显看出，从工作和环境的上下文中选择了一系列http_requests_total子集，然后将其数目考虑了5分钟。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Z分数检测异常</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
统计的基本原理可用于检测异常。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您知道</font><font style="vertical-align: inherit;">Prometheus系列</font><font style="vertical-align: inherit;">的均值和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标准差</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则可以使用该系列中的任何样本来计算z得分。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Z分数是对观测值或测量值的相对范围的度量，它显示了</font><font style="vertical-align: inherit;">其范围相对于</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">平均值的</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标准偏差</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。&nbsp;</font><font style="vertical-align: inherit;">
也就是说，z分数= 0意味着z分数与具有标准分布的数据集中的平均值相同，而z分数= 1意味着与平均值的标准偏差= 1.0。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们假设基本数据具有正态分布，这意味着99.7％的样本的z得分从0到3。z得分距离零越远，则其存在的可能性就越小。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们应用此属性来检测Prometheus数据系列中的异常：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们使用样本量较大的数据计算指标的均值和标准差。</font><font style="vertical-align: inherit;">在此示例中，我们使用每周数据。</font><font style="vertical-align: inherit;">如果我们假设记录每分钟评估一次，那么一周内我们将有10,000多个样本。</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一旦获得聚合的平均值和标准偏差，我们就可以计算Prometheus查询的z得分。</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据正态分布的统计原理，假定+3到-3范围之外的任何值都是异常。</font><font style="vertical-align: inherit;">因此，我们可以创建有关此类异常的警告。</font><font style="vertical-align: inherit;">例如，当我们的聚合超出此范围超过五分钟时，我们将收到警报。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">48小时内每秒对GitLab页面服务的请求数的图表。</font><font style="vertical-align: inherit;">+3到-3范围内的Z分数以绿色突出显示</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
，由于该值没有度量单位，</font><i><font style="vertical-align: inherit;">因此</font></i><font style="vertical-align: inherit;"> Z分数可能难以在图形上解释。</font><font style="vertical-align: inherit;">但是，此图中的异常非常容易确定。</font><font style="vertical-align: inherit;">超出绿色区域的所有内容均显示为异常值，绿色区域显示z得分为-3到+3的值的走廊。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果数据分发不正常怎么办</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们假设数据分布是正常的。</font><font style="vertical-align: inherit;">否则，我们的z得分将为false。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有很多统计技巧可以确定数据分布的正态性，但是最好的方法是检查数据的z得分是否在-4.0到+4.0范围内。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
两个Prometheus查询，显示最小和最大z得分：</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您的结果在-20到+20的范围内，则意味着使用了过多的数据并且结果失真。</font><font style="vertical-align: inherit;">还要记住，您必须使用汇总行。</font><font style="vertical-align: inherit;">没有正态分布的度量标准包括错误率，延迟，队列长度等参数。</font><font style="vertical-align: inherit;">但是，在固定警报阈值的情况下，这些指标中的许多指标会更好地工作。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">统计季节性异常检测</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管计算z分数与时序数据的正态分布效果很好，但是还有第二种方法可以给出更准确的异常检测结果。</font><font style="vertical-align: inherit;">这是统计季节性的使用。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
季节性是时间序列度量标准的特征，当该度量标准经历定期且可预测的更改（在每个周期中重复进行）时。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从星期一到星期日连续四周的每秒请求数（RPS）</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
图表上面</font><i><font style="vertical-align: inherit;">的</font></i><font style="vertical-align: inherit;">图表说明了</font><i><font style="vertical-align: inherit;">从星期一到星期日连续7周的</font></i><font style="vertical-align: inherit;"> 7天的RPS（每秒请求数）。</font><font style="vertical-align: inherit;">这七天的范围称为“偏移”，即用于测量的模式。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
图表上的每个星期都有不同的颜色。</font><font style="vertical-align: inherit;">数据的季节性由图表中所示趋势的顺序表示-每个星期一早晨，我们观察到RPS都有类似的增加，而在星期五晚上，我们总是观察到RPS下降。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用时间序列数据中的季节性，我们可以更准确地预测异常的发生及其检测。&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何使用季节性</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
普罗米修斯使用几种不同的统计机制来计算季节性。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们进行计算，将本周的增长趋势添加到前一周的结果中。增长趋势计算如下：从上周的移动平均值中减去上周的移动平均值。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; — job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一次迭代结果有些“狭窄”-我们使用本周和上周的五分钟窗口来获取预测。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在第二次迭代中，我们通过获取上一周的四个小时周期的平均值并将其与当前一周进行比较来扩展我们的覆盖范围。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，如果我们尝试预测星期一早上八点的指标值，而不是前一周的相同五分钟窗口，我们将指标的平均值从上周一的早上六点选到十点。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该请求显示166小时，比整周（7 * 24 = 168）少两个小时，因为我们要根据当前时间使用四个小时，因此我们需要将偏移量比整周少两个小时。&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">两周</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
内的实际</font><i><font style="vertical-align: inherit;">RPS（黄色）和预测的（蓝色）</font></i><font style="vertical-align: inherit;">将实际RPS与我们的预测进行比较表明，我们的计算相当准确。但是，该方法具有缺点。</font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，5月1日，周三使用GitLab的时间比平常少，因为这一天是休息日。由于估计的增长趋势取决于前一周使用该系统的方式，因此我们对下周（即5月8日（星期三））的预测给出的RPS低于实际值。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可以通过在5月1日星期三之前连续三周进行三个预测（即前三个星期三）来纠正此错误。该请求保持不变，但偏移量已调整。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5月8日之前的三个星期，图表上有3个预测，而5月8日，星期三的实际RPS则为预测。您可以看到这两个预测非常准确，但是5月1日这一周的预测仍然不准确，</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
此外，我们不需要三个预测，我们需要一个预测。平均值不是一个选择，因为我们从5月1日起扭曲的RPS数据将使平均值模糊。相反，您需要计算中位数。 Prometheus没有中位数查询，但是我们可以使用分位数聚合而不是中位数。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
唯一的问题是我们试图将三个系列包括在汇总中，而这三个系列实际上是三周内的同一系列。换句话说，它们具有相同的标签，因此很难将它们放在一起。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为避免混淆，我们创建了一个名为offset的标签，并使用label-replace函数为三个星期中的每个星期添加一个offset。</font><font style="vertical-align: inherit;">然后，在分位数聚合中，我们丢弃这些标签，这使我们得到三个平均值。</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们对三个聚合的中位数的预测变得更加准确。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中位数预测与实际RPS</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何发现我们的预测确实准确</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要检查预测的准确性，我们可以返回z得分。</font><font style="vertical-align: inherit;">它用于测量样本的差异及其在标准偏差中的预测。</font><font style="vertical-align: inherit;">与预测的标准偏差越大，则特定值离群的可能性越大。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">预计的偏差范围是从+1.5到-1.5。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
您可以将Grafana图表更改为使用季节性预测，而不是每周移动平均值。</font><font style="vertical-align: inherit;">一天中特定时间的正常值范围以绿色阴影显示。</font><font style="vertical-align: inherit;">超出绿色区域的所有内容均视为异常值。</font><font style="vertical-align: inherit;">在这种情况下，离群值发生在周日下午，当时我们的云提供商遇到了一些网络问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
优良作法是将±2 z分数用于季节性预测。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何使用Prometheus设置警报</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果要为异常事件设置警报，则可以应用相当简单的Prometheus规则，该规则检查指标的z得分是否在+2到-2之间。</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在GitLab中，我们使用自定义路由规则，该规则会在检测到任何异常时通过Slack发送警报，但不会与我们的支持团队联系。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何使用Prometheus在GitLab中检测异常</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">普罗米修斯可以用来检测一些异常。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正确的聚集是发现异常的关键。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您的数据具有正态分布，则Z评分有效。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">统计季节性是检测异常的有力机制。</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">经</font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">支持翻译</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仍然有用</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI中的简单缓存方法：图片指南</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCS市场中现成的和定制的GitLab CE工具</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们关于数字转换的电报频道</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN499014/index.html">JavaScript面试的23个难题</a></li>
<li><a href="../zh-CN499016/index.html">与ESIA for .Net集成：比听起来容易</a></li>
<li><a href="../zh-CN499018/index.html">6个家庭运动应用</a></li>
<li><a href="../zh-CN499020/index.html">一项模糊行为的研究</a></li>
<li><a href="../zh-CN499030/index.html">在20分钟内在isic上监视Grafana的MySQL性能</a></li>
<li><a href="../zh-CN499034/index.html">如何向100万用户推广危险的重构？</a></li>
<li><a href="../zh-CN499036/index.html">提供商的工作：有关协议，IT和网络基础结构的精选材料</a></li>
<li><a href="../zh-CN499038/index.html">我使用立式显示器的经验</a></li>
<li><a href="../zh-CN499040/index.html">周末阅读：有关DNS，IT法规和硬件历史的精选材料1cloud.ru</a></li>
<li><a href="../zh-CN499044/index.html">来自世界开放地图508号的新闻（04/07/2020/13/04/2020）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>