<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘‡ğŸ» ğŸ‘– ğŸ‘¨ğŸ¿â€ğŸš’ å¦‚ä½•ä½¿ç”¨Prometheusæ£€æµ‹GitLabä¸­çš„å¼‚å¸¸ â™¨ï¸ ğŸŒŸ ğŸŒ›</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PrometheusæŸ¥è¯¢è¯­è¨€çš„åŸºæœ¬åŠŸèƒ½ä¹‹ä¸€æ˜¯æ—¶é—´åºåˆ—çš„å®æ—¶æ±‡æ€»ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨PrometheusæŸ¥è¯¢è¯­è¨€æ¥æ£€æµ‹æ—¶é—´åºåˆ—æ•°æ®ä¸­çš„å¼‚å¸¸ã€‚Â 
 
 è¯¥Mail.ruäº‘è§£å†³æ–¹æ¡ˆå›¢é˜Ÿå·²ç»ç¿»è¯‘ç”±GitLabåŸºç¡€æ¶æ„å›¢é˜Ÿçš„å·¥ç¨‹å¸ˆçš„æ–‡ç« ï¼Œåœ¨é‚£é‡Œä½ ä¼šæ‰¾åˆ°çš„ä»£ç ç¤ºä¾‹ï¼Œä½ å¯ä»¥å°è¯•åœ¨ä½ çš„ç³»ç»Ÿä¸­ã€‚
 
 ä»€ä¹ˆæ˜¯å¼‚å¸¸æ£€æµ‹ï¼Ÿ
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>å¦‚ä½•ä½¿ç”¨Prometheusæ£€æµ‹GitLabä¸­çš„å¼‚å¸¸</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PrometheusæŸ¥è¯¢è¯­è¨€çš„åŸºæœ¬åŠŸèƒ½ä¹‹ä¸€æ˜¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ—¶é—´åºåˆ—</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„å®æ—¶</font><font style="vertical-align: inherit;">æ±‡æ€»</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ‚¨è¿˜å¯ä»¥ä½¿ç”¨PrometheusæŸ¥è¯¢è¯­è¨€æ¥æ£€æµ‹æ—¶é—´åºåˆ—æ•°æ®ä¸­çš„å¼‚å¸¸ã€‚&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ruäº‘è§£å†³æ–¹æ¡ˆ</font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å›¢é˜Ÿå·²ç»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¿»è¯‘</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">ç”±GitLabåŸºç¡€æ¶æ„å›¢é˜Ÿçš„å·¥ç¨‹å¸ˆçš„æ–‡ç« </font></a><font style="vertical-align: inherit;">ï¼Œåœ¨é‚£é‡Œä½ ä¼šæ‰¾åˆ°çš„ä»£ç ç¤ºä¾‹ï¼Œä½ å¯ä»¥å°è¯•åœ¨ä½ çš„ç³»ç»Ÿä¸­ã€‚</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»€ä¹ˆæ˜¯å¼‚å¸¸æ£€æµ‹ï¼Ÿ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¡®å®šGitLabå¼‚å¸¸æ£€æµ‹çš„é‡è¦æ€§çš„å››ä¸ªä¸»è¦åŸå› ï¼š</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº‹ä»¶è¯Šæ–­</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡å‡å°‘äº‹ä»¶æ£€æµ‹æ—¶é—´ï¼ˆMTTDï¼‰æ¥æ£€æµ‹å“ªäº›æœåŠ¡è¶…å‡ºäº†æ­£å¸¸èŒƒå›´ï¼Œä»è€Œæä¾›äº†æ›´å¿«çš„è§£å†³æ–¹æ¡ˆã€‚</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ£€æµ‹æ€§èƒ½ä¸‹é™</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šä¾‹å¦‚ï¼Œå¦‚æœå°†å›å½’å¼•å…¥åˆ°æœåŠ¡ä¸­ï¼Œå¯¼è‡´å®ƒè¿‡äºé¢‘ç¹åœ°è®¿é—®å¦ä¸€ä¸ªæœåŠ¡ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥å¿«é€Ÿæ£€æµ‹å¹¶è§£å†³æ­¤é—®é¢˜ã€‚</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ£€æµ‹å’Œæ¶ˆé™¤æ»¥ç”¨</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šGitLabæä¾›äº†äº¤ä»˜å’Œé›†æˆæœºåˆ¶ï¼ˆ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰å’Œæ‰˜ç®¡ï¼ˆGitLab Pagesï¼‰ï¼Œå¹¶ä¸”åªæœ‰å°‘æ•°ç”¨æˆ·å¯ä»¥ä½¿ç”¨è¿™äº›æœºåˆ¶ã€‚</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®‰å…¨æ€§</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šå¼‚å¸¸æ£€æµ‹å¯¹äºæ£€æµ‹GitLabæ—¶é—´åºåˆ—ä¸­çš„å¼‚å¸¸è¶‹åŠ¿éå¸¸é‡è¦ã€‚</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”±äºè¿™äº›å’Œå…¶ä»–åŸå› ï¼Œæœ¬æ–‡çš„ä½œè€…å†³å®šæ‰¾å‡ºå¦‚ä½•ä½¿ç”¨PrometheusæŸ¥è¯¢å’Œè§„åˆ™åœ¨GitLabæ—¶é—´åºåˆ—ä¸­é…ç½®å¼‚å¸¸çš„å®šä¹‰ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®çš„èšåˆçº§åˆ«æ˜¯å¤šå°‘ï¼Ÿ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œå¿…é¡»æ­£ç¡®æ±‡æ€»æ—¶é—´åºåˆ—ã€‚</font><font style="vertical-align: inherit;">åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ ‡å‡†çš„http_requests_totalè®¡æ•°å™¨æ¥æ£€ç´¢æ•°æ®ï¼Œå°½ç®¡è®¸å¤šå…¶ä»–æŒ‡æ ‡ä¹Ÿå¯ä»¥è¿™æ ·åšã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥æµ‹è¯•æŒ‡æ ‡å…·æœ‰å¤šä¸ªå‚æ•°ï¼šæ–¹æ³•ï¼Œæ§åˆ¶å™¨ï¼ŒçŠ¶æ€ç ï¼ˆstatus_codeï¼‰ï¼Œç¯å¢ƒä»¥åŠPrometheusè‡ªèº«æ·»åŠ çš„å‚æ•°ï¼Œä¾‹å¦‚ä½œä¸šå’Œå®ä¾‹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæ‚¨éœ€è¦é€‰æ‹©æ­£ç¡®çš„æ•°æ®èšåˆçº§åˆ«ã€‚</font><font style="vertical-align: inherit;">å¤ªå¤šæˆ–å¤ªå°‘-æ‰€æœ‰è¿™äº›å¯¹äºæ£€æµ‹å¼‚å¸¸éƒ½å¾ˆé‡è¦ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ•°æ®æ±‡æ€»è¿‡å¤šï¼Œåˆ™å­˜åœ¨ä¸¤ä¸ªæ½œåœ¨é—®é¢˜ï¼š</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨å¯ä»¥è·³è¿‡å¼‚å¸¸ï¼Œå› ä¸ºèšåˆéšè—äº†æ•°æ®å­é›†ä¸­å‡ºç°çš„é—®é¢˜ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœå‘ç°å¼‚å¸¸ï¼Œåˆ™ä¸ä»˜å‡ºé¢å¤–åŠªåŠ›å°±å¾ˆéš¾å°†å…¶ä¸ç³»ç»Ÿçš„å•ç‹¬éƒ¨åˆ†ç›¸å…³è”ã€‚</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ•°æ®èšåˆä¸å……åˆ†ï¼Œåˆ™å¯èƒ½å¯¼è‡´è¯¯æŠ¥æ¬¡æ•°å¢åŠ ï¼Œä»¥åŠå°†æœ‰æ•ˆæ•°æ®é”™è¯¯è§£é‡Šä¸ºé”™è¯¯ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ ¹æ®æˆ‘ä»¬çš„ç»éªŒï¼Œæœ€æ­£ç¡®çš„èšåˆçº§åˆ«æ˜¯æœåŠ¡çº§åˆ«ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åŒ…æ‹¬å·¥ä½œï¼ˆå·¥ä½œï¼‰æ ‡ç­¾å’Œç¯å¢ƒï¼ˆç¯å¢ƒï¼‰æ ‡ç­¾ï¼Œå¹¶ä¸¢å¼ƒæ‰€æœ‰å…¶ä»–æ ‡ç­¾ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­è®¨è®ºçš„èšåˆåŒ…æ‹¬ï¼šjob-http_requestï¼Œèšåˆ-äº”åˆ†é’Ÿï¼Œè¿™æ˜¯æ ¹æ®äº”åˆ†é’Ÿå†…çš„å·¥ä½œå’Œç¯å¢ƒè®¡ç®—å¾—å‡ºçš„ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸­å¯ä»¥æ˜æ˜¾çœ‹å‡ºï¼Œä»å·¥ä½œå’Œç¯å¢ƒçš„ä¸Šä¸‹æ–‡ä¸­é€‰æ‹©äº†ä¸€ç³»åˆ—http_requests_totalå­é›†ï¼Œç„¶åå°†å…¶æ•°ç›®è€ƒè™‘äº†5åˆ†é’Ÿã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨Zåˆ†æ•°æ£€æµ‹å¼‚å¸¸</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç»Ÿè®¡çš„åŸºæœ¬åŸç†å¯ç”¨äºæ£€æµ‹å¼‚å¸¸ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ‚¨çŸ¥é“</font><font style="vertical-align: inherit;">Prometheusç³»åˆ—</font><font style="vertical-align: inherit;">çš„å‡å€¼å’Œ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ ‡å‡†å·®</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œåˆ™å¯ä»¥ä½¿ç”¨è¯¥ç³»åˆ—ä¸­çš„ä»»ä½•æ ·æœ¬æ¥è®¡ç®—zå¾—åˆ†ã€‚&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zåˆ†æ•°æ˜¯å¯¹è§‚æµ‹å€¼æˆ–æµ‹é‡å€¼çš„ç›¸å¯¹èŒƒå›´çš„åº¦é‡ï¼Œå®ƒæ˜¾ç¤ºäº†</font><font style="vertical-align: inherit;">å…¶èŒƒå›´ç›¸å¯¹äº</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">å¹³å‡å€¼çš„</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ ‡å‡†åå·®</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚&nbsp;</font><font style="vertical-align: inherit;">
ä¹Ÿå°±æ˜¯è¯´ï¼Œzåˆ†æ•°= 0æ„å‘³ç€zåˆ†æ•°ä¸å…·æœ‰æ ‡å‡†åˆ†å¸ƒçš„æ•°æ®é›†ä¸­çš„å¹³å‡å€¼ç›¸åŒï¼Œè€Œzåˆ†æ•°= 1æ„å‘³ç€ä¸å¹³å‡å€¼çš„æ ‡å‡†åå·®= 1.0ã€‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å‡è®¾åŸºæœ¬æ•°æ®å…·æœ‰æ­£æ€åˆ†å¸ƒï¼Œè¿™æ„å‘³ç€99.7ï¼…çš„æ ·æœ¬çš„zå¾—åˆ†ä»0åˆ°3ã€‚zå¾—åˆ†è·ç¦»é›¶è¶Šè¿œï¼Œåˆ™å…¶å­˜åœ¨çš„å¯èƒ½æ€§å°±è¶Šå°ã€‚&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬åº”ç”¨æ­¤å±æ€§æ¥æ£€æµ‹Prometheusæ•°æ®ç³»åˆ—ä¸­çš„å¼‚å¸¸ï¼š</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬ä½¿ç”¨æ ·æœ¬é‡è¾ƒå¤§çš„æ•°æ®è®¡ç®—æŒ‡æ ‡çš„å‡å€¼å’Œæ ‡å‡†å·®ã€‚</font><font style="vertical-align: inherit;">åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¯å‘¨æ•°æ®ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæˆ‘ä»¬å‡è®¾è®°å½•æ¯åˆ†é’Ÿè¯„ä¼°ä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€å‘¨å†…æˆ‘ä»¬å°†æœ‰10,000å¤šä¸ªæ ·æœ¬ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸€æ—¦è·å¾—èšåˆçš„å¹³å‡å€¼å’Œæ ‡å‡†åå·®ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—PrometheusæŸ¥è¯¢çš„zå¾—åˆ†ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ ¹æ®æ­£æ€åˆ†å¸ƒçš„ç»Ÿè®¡åŸç†ï¼Œå‡å®š+3åˆ°-3èŒƒå›´ä¹‹å¤–çš„ä»»ä½•å€¼éƒ½æ˜¯å¼‚å¸¸ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºæœ‰å…³æ­¤ç±»å¼‚å¸¸çš„è­¦å‘Šã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬çš„èšåˆè¶…å‡ºæ­¤èŒƒå›´è¶…è¿‡äº”åˆ†é’Ÿæ—¶ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°è­¦æŠ¥ã€‚</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">48å°æ—¶å†…æ¯ç§’å¯¹GitLabé¡µé¢æœåŠ¡çš„è¯·æ±‚æ•°çš„å›¾è¡¨ã€‚</font><font style="vertical-align: inherit;">+3åˆ°-3èŒƒå›´å†…çš„Zåˆ†æ•°ä»¥ç»¿è‰²çªå‡ºæ˜¾ç¤º</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ï¼Œç”±äºè¯¥å€¼æ²¡æœ‰åº¦é‡å•ä½ï¼Œ</font><i><font style="vertical-align: inherit;">å› æ­¤</font></i><font style="vertical-align: inherit;"> Zåˆ†æ•°å¯èƒ½éš¾ä»¥åœ¨å›¾å½¢ä¸Šè§£é‡Šã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œæ­¤å›¾ä¸­çš„å¼‚å¸¸éå¸¸å®¹æ˜“ç¡®å®šã€‚</font><font style="vertical-align: inherit;">è¶…å‡ºç»¿è‰²åŒºåŸŸçš„æ‰€æœ‰å†…å®¹å‡æ˜¾ç¤ºä¸ºå¼‚å¸¸å€¼ï¼Œç»¿è‰²åŒºåŸŸæ˜¾ç¤ºzå¾—åˆ†ä¸º-3åˆ°+3çš„å€¼çš„èµ°å»Šã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœæ•°æ®åˆ†å‘ä¸æ­£å¸¸æ€ä¹ˆåŠ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å‡è®¾æ•°æ®åˆ†å¸ƒæ˜¯æ­£å¸¸çš„ã€‚</font><font style="vertical-align: inherit;">å¦åˆ™ï¼Œæˆ‘ä»¬çš„zå¾—åˆ†å°†ä¸ºfalseã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ‰å¾ˆå¤šç»Ÿè®¡æŠ€å·§å¯ä»¥ç¡®å®šæ•°æ®åˆ†å¸ƒçš„æ­£æ€æ€§ï¼Œä½†æ˜¯æœ€å¥½çš„æ–¹æ³•æ˜¯æ£€æŸ¥æ•°æ®çš„zå¾—åˆ†æ˜¯å¦åœ¨-4.0åˆ°+4.0èŒƒå›´å†…ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸¤ä¸ªPrometheusæŸ¥è¯¢ï¼Œæ˜¾ç¤ºæœ€å°å’Œæœ€å¤§zå¾—åˆ†ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ‚¨çš„ç»“æœåœ¨-20åˆ°+20çš„èŒƒå›´å†…ï¼Œåˆ™æ„å‘³ç€ä½¿ç”¨äº†è¿‡å¤šçš„æ•°æ®å¹¶ä¸”ç»“æœå¤±çœŸã€‚</font><font style="vertical-align: inherit;">è¿˜è¦è®°ä½ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨æ±‡æ€»è¡Œã€‚</font><font style="vertical-align: inherit;">æ²¡æœ‰æ­£æ€åˆ†å¸ƒçš„åº¦é‡æ ‡å‡†åŒ…æ‹¬é”™è¯¯ç‡ï¼Œå»¶è¿Ÿï¼Œé˜Ÿåˆ—é•¿åº¦ç­‰å‚æ•°ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œåœ¨å›ºå®šè­¦æŠ¥é˜ˆå€¼çš„æƒ…å†µä¸‹ï¼Œè¿™äº›æŒ‡æ ‡ä¸­çš„è®¸å¤šæŒ‡æ ‡ä¼šæ›´å¥½åœ°å·¥ä½œã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»Ÿè®¡å­£èŠ‚æ€§å¼‚å¸¸æ£€æµ‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°½ç®¡è®¡ç®—zåˆ†æ•°ä¸æ—¶åºæ•°æ®çš„æ­£æ€åˆ†å¸ƒæ•ˆæœå¾ˆå¥½ï¼Œä½†æ˜¯è¿˜æœ‰ç¬¬äºŒç§æ–¹æ³•å¯ä»¥ç»™å‡ºæ›´å‡†ç¡®çš„å¼‚å¸¸æ£€æµ‹ç»“æœã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯ç»Ÿè®¡å­£èŠ‚æ€§çš„ä½¿ç”¨ã€‚&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å­£èŠ‚æ€§æ˜¯æ—¶é—´åºåˆ—åº¦é‡æ ‡å‡†çš„ç‰¹å¾ï¼Œå½“è¯¥åº¦é‡æ ‡å‡†ç»å†å®šæœŸä¸”å¯é¢„æµ‹çš„æ›´æ”¹ï¼ˆåœ¨æ¯ä¸ªå‘¨æœŸä¸­é‡å¤è¿›è¡Œï¼‰æ—¶ã€‚</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸæ—¥è¿ç»­å››å‘¨çš„æ¯ç§’è¯·æ±‚æ•°ï¼ˆRPSï¼‰</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
å›¾è¡¨ä¸Šé¢</font><i><font style="vertical-align: inherit;">çš„</font></i><font style="vertical-align: inherit;">å›¾è¡¨è¯´æ˜äº†</font><i><font style="vertical-align: inherit;">ä»æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸæ—¥è¿ç»­7å‘¨çš„</font></i><font style="vertical-align: inherit;"> 7å¤©çš„RPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰ã€‚</font><font style="vertical-align: inherit;">è¿™ä¸ƒå¤©çš„èŒƒå›´ç§°ä¸ºâ€œåç§»â€ï¼Œå³ç”¨äºæµ‹é‡çš„æ¨¡å¼ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å›¾è¡¨ä¸Šçš„æ¯ä¸ªæ˜ŸæœŸéƒ½æœ‰ä¸åŒçš„é¢œè‰²ã€‚</font><font style="vertical-align: inherit;">æ•°æ®çš„å­£èŠ‚æ€§ç”±å›¾è¡¨ä¸­æ‰€ç¤ºè¶‹åŠ¿çš„é¡ºåºè¡¨ç¤º-æ¯ä¸ªæ˜ŸæœŸä¸€æ—©æ™¨ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°RPSéƒ½æœ‰ç±»ä¼¼çš„å¢åŠ ï¼Œè€Œåœ¨æ˜ŸæœŸäº”æ™šä¸Šï¼Œæˆ‘ä»¬æ€»æ˜¯è§‚å¯Ÿåˆ°RPSä¸‹é™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½¿ç”¨æ—¶é—´åºåˆ—æ•°æ®ä¸­çš„å­£èŠ‚æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å‡†ç¡®åœ°é¢„æµ‹å¼‚å¸¸çš„å‘ç”ŸåŠå…¶æ£€æµ‹ã€‚&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚ä½•ä½¿ç”¨å­£èŠ‚æ€§</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ™®ç½—ç±³ä¿®æ–¯ä½¿ç”¨å‡ ç§ä¸åŒçš„ç»Ÿè®¡æœºåˆ¶æ¥è®¡ç®—å­£èŠ‚æ€§ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬è¿›è¡Œè®¡ç®—ï¼Œå°†æœ¬å‘¨çš„å¢é•¿è¶‹åŠ¿æ·»åŠ åˆ°å‰ä¸€å‘¨çš„ç»“æœä¸­ã€‚å¢é•¿è¶‹åŠ¿è®¡ç®—å¦‚ä¸‹ï¼šä»ä¸Šå‘¨çš„ç§»åŠ¨å¹³å‡å€¼ä¸­å‡å»ä¸Šå‘¨çš„ç§»åŠ¨å¹³å‡å€¼ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; â€” job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¬¬ä¸€æ¬¡è¿­ä»£ç»“æœæœ‰äº›â€œç‹­çª„â€-æˆ‘ä»¬ä½¿ç”¨æœ¬å‘¨å’Œä¸Šå‘¨çš„äº”åˆ†é’Ÿçª—å£æ¥è·å–é¢„æµ‹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨ç¬¬äºŒæ¬¡è¿­ä»£ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è·å–ä¸Šä¸€å‘¨çš„å››ä¸ªå°æ—¶å‘¨æœŸçš„å¹³å‡å€¼å¹¶å°†å…¶ä¸å½“å‰ä¸€å‘¨è¿›è¡Œæ¯”è¾ƒæ¥æ‰©å±•æˆ‘ä»¬çš„è¦†ç›–èŒƒå›´ã€‚&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•é¢„æµ‹æ˜ŸæœŸä¸€æ—©ä¸Šå…«ç‚¹çš„æŒ‡æ ‡å€¼ï¼Œè€Œä¸æ˜¯å‰ä¸€å‘¨çš„ç›¸åŒäº”åˆ†é’Ÿçª—å£ï¼Œæˆ‘ä»¬å°†æŒ‡æ ‡çš„å¹³å‡å€¼ä»ä¸Šå‘¨ä¸€çš„æ—©ä¸Šå…­ç‚¹é€‰åˆ°åç‚¹ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥è¯·æ±‚æ˜¾ç¤º166å°æ—¶ï¼Œæ¯”æ•´å‘¨ï¼ˆ7 * 24 = 168ï¼‰å°‘ä¸¤ä¸ªå°æ—¶ï¼Œå› ä¸ºæˆ‘ä»¬è¦æ ¹æ®å½“å‰æ—¶é—´ä½¿ç”¨å››ä¸ªå°æ—¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†åç§»é‡æ¯”æ•´å‘¨å°‘ä¸¤ä¸ªå°æ—¶ã€‚&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸¤å‘¨</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
å†…çš„å®é™…</font><i><font style="vertical-align: inherit;">RPSï¼ˆé»„è‰²ï¼‰å’Œé¢„æµ‹çš„ï¼ˆè“è‰²ï¼‰</font></i><font style="vertical-align: inherit;">å°†å®é™…RPSä¸æˆ‘ä»¬çš„é¢„æµ‹è¿›è¡Œæ¯”è¾ƒè¡¨æ˜ï¼Œæˆ‘ä»¬çš„è®¡ç®—ç›¸å½“å‡†ç¡®ã€‚ä½†æ˜¯ï¼Œè¯¥æ–¹æ³•å…·æœ‰ç¼ºç‚¹ã€‚</font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¾‹å¦‚ï¼Œ5æœˆ1æ—¥ï¼Œå‘¨ä¸‰ä½¿ç”¨GitLabçš„æ—¶é—´æ¯”å¹³å¸¸å°‘ï¼Œå› ä¸ºè¿™ä¸€å¤©æ˜¯ä¼‘æ¯æ—¥ã€‚ç”±äºä¼°è®¡çš„å¢é•¿è¶‹åŠ¿å–å†³äºå‰ä¸€å‘¨ä½¿ç”¨è¯¥ç³»ç»Ÿçš„æ–¹å¼ï¼Œå› æ­¤æˆ‘ä»¬å¯¹ä¸‹å‘¨ï¼ˆå³5æœˆ8æ—¥ï¼ˆæ˜ŸæœŸä¸‰ï¼‰ï¼‰çš„é¢„æµ‹ç»™å‡ºçš„RPSä½äºå®é™…å€¼ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯ä»¥é€šè¿‡åœ¨5æœˆ1æ—¥æ˜ŸæœŸä¸‰ä¹‹å‰è¿ç»­ä¸‰å‘¨è¿›è¡Œä¸‰ä¸ªé¢„æµ‹ï¼ˆå³å‰ä¸‰ä¸ªæ˜ŸæœŸä¸‰ï¼‰æ¥çº æ­£æ­¤é”™è¯¯ã€‚è¯¥è¯·æ±‚ä¿æŒä¸å˜ï¼Œä½†åç§»é‡å·²è°ƒæ•´ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w â€” job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w â€” job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w â€” job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5æœˆ8æ—¥ä¹‹å‰çš„ä¸‰ä¸ªæ˜ŸæœŸï¼Œå›¾è¡¨ä¸Šæœ‰3ä¸ªé¢„æµ‹ï¼Œè€Œ5æœˆ8æ—¥ï¼Œæ˜ŸæœŸä¸‰çš„å®é™…RPSåˆ™ä¸ºé¢„æµ‹ã€‚æ‚¨å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªé¢„æµ‹éå¸¸å‡†ç¡®ï¼Œä½†æ˜¯5æœˆ1æ—¥è¿™ä¸€å‘¨çš„é¢„æµ‹ä»ç„¶ä¸å‡†ç¡®ï¼Œ</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
æ­¤å¤–ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸‰ä¸ªé¢„æµ‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé¢„æµ‹ã€‚å¹³å‡å€¼ä¸æ˜¯ä¸€ä¸ªé€‰æ‹©ï¼Œå› ä¸ºæˆ‘ä»¬ä»5æœˆ1æ—¥èµ·æ‰­æ›²çš„RPSæ•°æ®å°†ä½¿å¹³å‡å€¼æ¨¡ç³Šã€‚ç›¸åï¼Œæ‚¨éœ€è¦è®¡ç®—ä¸­ä½æ•°ã€‚ Prometheusæ²¡æœ‰ä¸­ä½æ•°æŸ¥è¯¢ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ†ä½æ•°èšåˆè€Œä¸æ˜¯ä¸­ä½æ•°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å”¯ä¸€çš„é—®é¢˜æ˜¯æˆ‘ä»¬è¯•å›¾å°†ä¸‰ä¸ªç³»åˆ—åŒ…æ‹¬åœ¨æ±‡æ€»ä¸­ï¼Œè€Œè¿™ä¸‰ä¸ªç³»åˆ—å®é™…ä¸Šæ˜¯ä¸‰å‘¨å†…çš„åŒä¸€ç³»åˆ—ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒä»¬å…·æœ‰ç›¸åŒçš„æ ‡ç­¾ï¼Œå› æ­¤å¾ˆéš¾å°†å®ƒä»¬æ”¾åœ¨ä¸€èµ·ã€‚&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºé¿å…æ··æ·†ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸ºoffsetçš„æ ‡ç­¾ï¼Œå¹¶ä½¿ç”¨label-replaceå‡½æ•°ä¸ºä¸‰ä¸ªæ˜ŸæœŸä¸­çš„æ¯ä¸ªæ˜ŸæœŸæ·»åŠ ä¸€ä¸ªoffsetã€‚</font><font style="vertical-align: inherit;">ç„¶åï¼Œåœ¨åˆ†ä½æ•°èšåˆä¸­ï¼Œæˆ‘ä»¬ä¸¢å¼ƒè¿™äº›æ ‡ç­¾ï¼Œè¿™ä½¿æˆ‘ä»¬å¾—åˆ°ä¸‰ä¸ªå¹³å‡å€¼ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w â€” job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w â€” job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w â€” job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬å¯¹ä¸‰ä¸ªèšåˆçš„ä¸­ä½æ•°çš„é¢„æµ‹å˜å¾—æ›´åŠ å‡†ç¡®ã€‚</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­ä½æ•°é¢„æµ‹ä¸å®é™…RPS</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚ä½•å‘ç°æˆ‘ä»¬çš„é¢„æµ‹ç¡®å®å‡†ç¡®</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦æ£€æŸ¥é¢„æµ‹çš„å‡†ç¡®æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è¿”å›zå¾—åˆ†ã€‚</font><font style="vertical-align: inherit;">å®ƒç”¨äºæµ‹é‡æ ·æœ¬çš„å·®å¼‚åŠå…¶åœ¨æ ‡å‡†åå·®ä¸­çš„é¢„æµ‹ã€‚</font><font style="vertical-align: inherit;">ä¸é¢„æµ‹çš„æ ‡å‡†åå·®è¶Šå¤§ï¼Œåˆ™ç‰¹å®šå€¼ç¦»ç¾¤çš„å¯èƒ½æ€§è¶Šå¤§ã€‚</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é¢„è®¡çš„åå·®èŒƒå›´æ˜¯ä»+1.5åˆ°-1.5ã€‚</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
æ‚¨å¯ä»¥å°†Grafanaå›¾è¡¨æ›´æ”¹ä¸ºä½¿ç”¨å­£èŠ‚æ€§é¢„æµ‹ï¼Œè€Œä¸æ˜¯æ¯å‘¨ç§»åŠ¨å¹³å‡å€¼ã€‚</font><font style="vertical-align: inherit;">ä¸€å¤©ä¸­ç‰¹å®šæ—¶é—´çš„æ­£å¸¸å€¼èŒƒå›´ä»¥ç»¿è‰²é˜´å½±æ˜¾ç¤ºã€‚</font><font style="vertical-align: inherit;">è¶…å‡ºç»¿è‰²åŒºåŸŸçš„æ‰€æœ‰å†…å®¹å‡è§†ä¸ºå¼‚å¸¸å€¼ã€‚</font><font style="vertical-align: inherit;">åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¦»ç¾¤å€¼å‘ç”Ÿåœ¨å‘¨æ—¥ä¸‹åˆï¼Œå½“æ—¶æˆ‘ä»¬çš„äº‘æä¾›å•†é‡åˆ°äº†ä¸€äº›ç½‘ç»œé—®é¢˜ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¼˜è‰¯ä½œæ³•æ˜¯å°†Â±2 zåˆ†æ•°ç”¨äºå­£èŠ‚æ€§é¢„æµ‹ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚ä½•ä½¿ç”¨Prometheusè®¾ç½®è­¦æŠ¥</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœè¦ä¸ºå¼‚å¸¸äº‹ä»¶è®¾ç½®è­¦æŠ¥ï¼Œåˆ™å¯ä»¥åº”ç”¨ç›¸å½“ç®€å•çš„Prometheusè§„åˆ™ï¼Œè¯¥è§„åˆ™æ£€æŸ¥æŒ‡æ ‡çš„zå¾—åˆ†æ˜¯å¦åœ¨+2åˆ°-2ä¹‹é—´ã€‚</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨GitLabä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰è·¯ç”±è§„åˆ™ï¼Œè¯¥è§„åˆ™ä¼šåœ¨æ£€æµ‹åˆ°ä»»ä½•å¼‚å¸¸æ—¶é€šè¿‡Slackå‘é€è­¦æŠ¥ï¼Œä½†ä¸ä¼šä¸æˆ‘ä»¬çš„æ”¯æŒå›¢é˜Ÿè”ç³»ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚ä½•ä½¿ç”¨Prometheusåœ¨GitLabä¸­æ£€æµ‹å¼‚å¸¸</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ™®ç½—ç±³ä¿®æ–¯å¯ä»¥ç”¨æ¥æ£€æµ‹ä¸€äº›å¼‚å¸¸ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®çš„èšé›†æ˜¯å‘ç°å¼‚å¸¸çš„å…³é”®ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœæ‚¨çš„æ•°æ®å…·æœ‰æ­£æ€åˆ†å¸ƒï¼Œåˆ™Zè¯„åˆ†æœ‰æ•ˆã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»Ÿè®¡å­£èŠ‚æ€§æ˜¯æ£€æµ‹å¼‚å¸¸çš„æœ‰åŠ›æœºåˆ¶ã€‚</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç»</font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">æ”¯æŒç¿»è¯‘</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»ç„¶æœ‰ç”¨</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CIä¸­çš„ç®€å•ç¼“å­˜æ–¹æ³•ï¼šå›¾ç‰‡æŒ‡å—</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCSå¸‚åœºä¸­ç°æˆçš„å’Œå®šåˆ¶çš„GitLab CEå·¥å…·</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬å…³äºæ•°å­—è½¬æ¢çš„ç”µæŠ¥é¢‘é“</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN499014/index.html">JavaScripté¢è¯•çš„23ä¸ªéš¾é¢˜</a></li>
<li><a href="../zh-CN499016/index.html">ä¸ESIA for .Neté›†æˆï¼šæ¯”å¬èµ·æ¥å®¹æ˜“</a></li>
<li><a href="../zh-CN499018/index.html">6ä¸ªå®¶åº­è¿åŠ¨åº”ç”¨</a></li>
<li><a href="../zh-CN499020/index.html">ä¸€é¡¹æ¨¡ç³Šè¡Œä¸ºçš„ç ”ç©¶</a></li>
<li><a href="../zh-CN499030/index.html">åœ¨20åˆ†é’Ÿå†…åœ¨isicä¸Šç›‘è§†Grafanaçš„MySQLæ€§èƒ½</a></li>
<li><a href="../zh-CN499034/index.html">å¦‚ä½•å‘100ä¸‡ç”¨æˆ·æ¨å¹¿å±é™©çš„é‡æ„ï¼Ÿ</a></li>
<li><a href="../zh-CN499036/index.html">æä¾›å•†çš„å·¥ä½œï¼šæœ‰å…³åè®®ï¼ŒITå’Œç½‘ç»œåŸºç¡€ç»“æ„çš„ç²¾é€‰ææ–™</a></li>
<li><a href="../zh-CN499038/index.html">æˆ‘ä½¿ç”¨ç«‹å¼æ˜¾ç¤ºå™¨çš„ç»éªŒ</a></li>
<li><a href="../zh-CN499040/index.html">å‘¨æœ«é˜…è¯»ï¼šæœ‰å…³DNSï¼ŒITæ³•è§„å’Œç¡¬ä»¶å†å²çš„ç²¾é€‰ææ–™1cloud.ru</a></li>
<li><a href="../zh-CN499044/index.html">æ¥è‡ªä¸–ç•Œå¼€æ”¾åœ°å›¾508å·çš„æ–°é—»ï¼ˆ04/07/2020/13/04/2020ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>