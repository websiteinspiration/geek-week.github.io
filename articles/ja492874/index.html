<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>#⃣ 👑 👩🏼‍🤝‍👨🏻 モバイル向けのレンダリングの最適化 👋🏽 🛀🏽 👲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは親愛なる読者、アマチュアおよびグラフィックスプログラミングの専門家！モバイルデバイス向けのレンダリングの最適化に焦点を当てた一連の記事（iOSおよびAndroidベースの携帯電話およびタブレット）に注目します。サイクルは3つの部分で構成されます。最初のパートでは、モバイルで人気のあるGPU...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>モバイル向けのレンダリングの最適化</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/playrix/blog/492874/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは親愛なる読者、アマチュアおよびグラフィックスプログラミングの専門家！モバイルデバイス向けのレンダリングの最適化に焦点を当てた一連の記事（iOSおよびAndroidベースの携帯電話およびタブレット）に注目します。サイクルは3つの部分で構成されます。最初のパートでは、モバイルで人気のある</font><font style="vertical-align: inherit;">GPU </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アーキテクチャの</font><font style="vertical-align: inherit;">機能を確認し</font><font style="vertical-align: inherit;">ます。 2番目のセクションでは、最新のデバイスで提供されるGPUの主なファミリについて説明し、それらの長所と短所を検討します。 3番目のパートでは、シェーダー最適化の機能について学びます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、最初の部分に取り掛かりましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デスクトップおよびコンソールでのビデオカードの開発は、電力消費に大きな制限がない状態で行われました。モバイルデバイス用のビデオカードの登場により、エンジニアは同等のデスクトップ解像度で許容可能なパフォーマンスを確保するという課題に直面しましたが、そのようなビデオカードの消費電力は2桁低くなるはずです。&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/51e/4fa/969/51e4fa969a3e5ede3b31064499c33226.png"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソリューションは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイルベースのレンダリング（TBR）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれる特別なアーキテクチャで見つかりました</font><font style="vertical-align: inherit;">。 PC開発の経験を持つグラフィックスプログラマーにとって、モバイル開発に慣れると、何もかもおなじみのように見えます。同様のOpenGL ES APIが使用され、グラフィックスパイプラインの構造は同じです。ただし、モバイルGPUのタイルアーキテクチャは、PC / </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イミディエイトモード</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソールで使用されるものとは大きく異なります</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TBRの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長所と短所を知ることは</font><font style="vertical-align: inherit;">、モバイルで正しい決定を下し、優れたパフォーマンスを得るのに役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、30年にわたってPCとコンソールで使用されていた古典的なグラフィックスパイプラインの簡略図です。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/281/67b/5e2/28167b5e2eaa4746ebd1ed45f8aa2dfb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ジオメトリ処理の段階で、頂点属性がGPUビデオメモリから読み取られます。さまざまな変換</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（頂点シェーダー）の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">後</font><font style="vertical-align: inherit;">、元の順序でレンダリングできる状態のプリミティブ（FIFO）が、プリミティブをピクセルに分割するラスタライザに渡されます。その後、各ピクセル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（フラグメントシェーダー）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のフラグメント処理のステップ</font><b><font style="vertical-align: inherit;">が</font></b><font style="vertical-align: inherit;">実行され</font><font style="vertical-align: inherit;">、取得されたカラー値がビデオバッファーにあるスクリーンバッファーに書き込まれます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「イミディエイトモード」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の従来のアーキテクチャの特徴は、</font><font style="vertical-align: inherit;">単一の</font><b><font style="vertical-align: inherit;">描画呼び出しを</font></b><font style="vertical-align: inherit;">処理するときに、画面バッファーの任意のセクションにフラグメントシェーダーの結果を記録することです。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。したがって、描画呼び出しごとに、画面バッファー全体へのアクセスが必要になる場合があります。大容量のメモリアレイを操作するには、適切なバス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帯域幅</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font><b><font style="vertical-align: inherit;">帯域幅</font></b><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">が必要であり、</font><font style="vertical-align: inherit;">消費電力が高くなります。したがって、モバイル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は異なるアプローチを採用し始めました。モバイルビデオカードに典型的なタイルアーキテクチャでは、画面の一部であるタイルに対応する小さなメモリでレンダリングが行われます。タイルのサイズが小さい（たとえば、Maliビデオカードの場合は16x16ピクセル、PowerVRの場合は32x32）タイルをビデオカードチップに直接配置できるため、アクセス速度はシェーダーコアレジスタへのアクセス速度に匹敵します。とても早い。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/7bf/c65/86d7bfc65e53739ab9be0d5ea1242c0e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、プリミティブは画面バッファーの任意のセクションに入る可能性があり、タイルはその一部しかカバーしないため、グラフィックスパイプラインに追加の手順が必要でした。</font><font style="vertical-align: inherit;">以下は、パイプラインがタイルアーキテクチャでどのように機能するかを示す簡略図です。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/531/ea5/00c/531ea500c507eb47558676582e20c94c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頂点を処理してプリミティブを構築した後、プリミティブはフラグメントパイプラインに送信される代わりに、いわゆる</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tilerに分類され</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ここで、プリミティブはタイルによって、それらが含まれるピクセルに分散されます。</font><font style="vertical-align: inherit;">原則として、1つの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フレームバッファーオブジェクト</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レンダーターゲットとも</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼ばれ</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">へのすべての描画呼び出しをカバーするこのような配分の後</font><font style="vertical-align: inherit;">、タイルは順次レンダリングされます。</font><font style="vertical-align: inherit;">各タイルに対して、次の一連のアクションが実行されます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムメモリからの</font><font style="vertical-align: inherit;">古い</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツのロード</font><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このタイルに入るプリミティブのレンダリング</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムメモリへの</font><font style="vertical-align: inherit;">新しい</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツのアップロード</font><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Store</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></li>
</ol><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9ea/20b/74b/9ea20b74b9fb716af30d5e0fa4ee1b34.png"></div><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロード</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作は、圧縮なしの「フルスクリーンテクスチャ」の追加の重ね合わせと見なすことができる</font><font style="vertical-align: inherit;">
ことに注意してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">可能な場合は、この操作を避けてください。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBOの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">切り替えを許可しないでください</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">レンダリングする前に</font><font style="vertical-align: inherit;">その内容がすべてクリアされている</font><font style="vertical-align: inherit;">場合</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロード</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作は実行されません。</font><font style="vertical-align: inherit;">ただし、ドライバーに正しい信号を送信するには、そのようなクリーニングのパラメーターが特定の基準を満たしている必要があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">無効にする必要があり</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シザーのRectを</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのカラーチャネルとアルファでの記録を許可する必要があります。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デプスバッファーとステンシル</font><font style="vertical-align: inherit;">
の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み込み</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作</font><font style="vertical-align: inherit;">を防ぐために、</font><font style="vertical-align: inherit;">レンダリングを開始する前にそれらもクリーンアップする必要があります。</font><font style="vertical-align: inherit;">デプス/ステンシルバッファーの</font><b><font style="vertical-align: inherit;">ストア</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
操作を回避することもでき</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">結局のところ、これらのバッファの内容は画面にまったく表示されません。</font><font style="vertical-align: inherit;">前</font><b><font style="vertical-align: inherit;">glSwapBuffersの</font></b><font style="vertical-align: inherit;">操作、</font><b><font style="vertical-align: inherit;">あなたが</font></b><font style="vertical-align: inherit;">呼び出すことができ</font><b><font style="vertical-align: inherit;">glDiscardFramebufferEXT</font></b><font style="vertical-align: inherit;">または</font><b><font style="vertical-align: inherit;">glInvalidateFramebufferを</font></b></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> GLenum attachments[] = {GL_DEPTH_ATTACHMENT, GL_STENCIL_ATTACHMENT};<font></font>
glDiscardFramebufferEXT (GL_FRAMEBUFFER, <span class="hljs-number">2</span>, attachments);</code></pre><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> GLenum attachments[] = {GL_DEPTH_ATTACHMENT, GL_STENCIL_ATTACHMENT};<font></font>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, attachments);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
深度/ステンシルバッファー、および</font><font style="vertical-align: inherit;">システムメモリ内の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファー</font><font style="vertical-align: inherit;">の配置が</font><font style="vertical-align: inherit;">不要な</font><font style="vertical-align: inherit;">レンダリングシナリオがあります</font><font style="vertical-align: inherit;">。たとえば</font><font style="vertical-align: inherit;">、深度バッファを使用</font><font style="vertical-align: inherit;">した</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">のレンダリング</font><font style="vertical-align: inherit;">が連続的で、前のフレームからの深度情報が使用されない場合、深度バッファをレンダリングの開始前にタイルメモリにロードしたり、レンダリングの完了後にアンロードしたりする必要はありません。したがって、システムメモリーを深度バッファーの下に割り当てることはできません。以下のような現代のグラフィックスAPI </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バルカン</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">金属が</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明示的にあなたのためにメモリモードを設定することができ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBOの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カウンターパート</font><font style="vertical-align: inherit;"> &nbsp;（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTLStorageModeMemoryless</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VK_IMAGE_USAGE_TRANSIENT_ATTACHMENT_BIT +、メタル</font></font></b> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VK_MEMORY_PROPERTY_LAZILY_ALLOCATED_BIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vulkanの場合</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特に注目すべきは、</font><font style="vertical-align: inherit;">タイルアーキテクチャ</font><font style="vertical-align: inherit;">での</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の実装です</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の高解像度バッファーは</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をより多くのタイルに</font><font style="vertical-align: inherit;">分割することによってタイルメモリを残しません</font><font style="vertical-align: inherit;">。たとえば、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSAA 2x2の場合</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><b><font style="vertical-align: inherit;">ストア</font></b><font style="vertical-align: inherit;">操作</font><font style="vertical-align: inherit;">中</font><b><font style="vertical-align: inherit;">に</font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16x16</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイル</font><font style="vertical-align: inherit;">は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8x8</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">として解決されます</font><font style="vertical-align: inherit;">。合計で、4倍以上のタイルを処理する必要があります。ただし、</font><b><font style="vertical-align: inherit;">MSAAに</font></b><font style="vertical-align: inherit;">追加のメモリ</font><font style="vertical-align: inherit;">は必要</font><b><font style="vertical-align: inherit;">あり</font></b><font style="vertical-align: inherit;">ません。高速タイルメモリでのレンダリングにより、</font><b><font style="vertical-align: inherit;">帯域幅に</font></b><font style="vertical-align: inherit;">大きな制限はありません</font><b><font style="vertical-align: inherit;">。</font></b><font style="vertical-align: inherit;">ただし使用</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイルアーキテクチャ上の</font><b><font style="vertical-align: inherit;">MSAA</font></b><font style="vertical-align: inherit;">は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tiler</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の負荷を増加させ、</font><font style="vertical-align: inherit;">ジオメトリの多いシーンのレンダリングパフォーマンスに悪影響を及ぼす可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記を要約すると、タイルアーキテクチャでFBOを使用する望ましいスキームが提示されます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// 1.   ,    auxFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, auxFBO);<font></font>
glDisable(GL_SCISSOR);<font></font>
glColorMask(GL_TRUE, GL_TRUE, GL_TRUE, GL_TRUE);<font></font>
glDepthMask(GL_TRUE);<font></font>
<span class="hljs-comment">// glClear,     </span><font></font>
glClear(GL_COLOR_BUFFER_BIT |&nbsp;GL_DEPTH_BUFFER_BIT |&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GL_STENCIL_BUFFER_BIT);<font></font>
<font></font>
renderAuxFBO();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
<font></font>
<span class="hljs-comment">//   /      </span>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, depth_and_stencil);
<span class="hljs-comment">// 2.   mainFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
glDisable(GL_SCISSOR);<font></font>
<font></font>
glClear(...);<font></font>
<span class="hljs-comment">//   mainFBO    auxFBO</span><font></font>
renderMainFBO(auxFBO);<font></font>
<font></font>
glInvalidateFramebuffer(GL_FRAMEBUFFER, <span class="hljs-number">2</span>, depth_and_stencil);
</code></pre><br><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">mainFBO</font></b><font style="vertical-align: inherit;">形成の途中で</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auxFBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
レンダリング</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">切り替えると</font><font style="vertical-align: inherit;">、不要な</font><b><font style="vertical-align: inherit;">ロード</font></b><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">保存の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作が発生し、フレーム形成時間が大幅に増加する可能性があります。</font><font style="vertical-align: inherit;">私たちの練習では、アイドル状態のFBO設定の場合でも、レンダリングの速度が低下しました。</font><font style="vertical-align: inherit;">それらの実際のレンダリングなし。</font><font style="vertical-align: inherit;">エンジンのアーキテクチャにより、古い回路は次のようになりました。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//   mainFBO</span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
<span class="hljs-comment">//   </span><font></font>
glBindFramebuffer(GL_FRAMEBUFFER, auxFBO);<font></font>
<span class="hljs-comment">//  auxFBO</span><font></font>
renderAuxFBO();<font></font>
<font></font>
glBindFramebuffer(GL_FRAMEBUFFER, mainFBO);<font></font>
<span class="hljs-comment">//   mainFBO</span><font></font>
renderMainFBO(auxFBO);<font></font>
</code></pre><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mainFBO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の最初のインストール後はgl呼び出しがなかったにもかかわらず、</font><font style="vertical-align: inherit;">一部のデバイスでは追加の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロードとストア</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作が行われ、パフォーマンスが低下しました。</font><font style="vertical-align: inherit;">中間</font><b><font style="vertical-align: inherit;">FBO</font></b><font style="vertical-align: inherit;">を使用</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
することによる</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オーバーヘッドの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理解を深めるために、</font><font style="vertical-align: inherit;">模擬テストを使用して</font><font style="vertical-align: inherit;">フルスクリーン</font><b><font style="vertical-align: inherit;">FBO</font></b><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">切り替えるための時間損失を測定しました</font><font style="vertical-align: inherit;">。この表は、</font><font style="vertical-align: inherit;">1つのフレームで</font><b><font style="vertical-align: inherit;">FBOを</font></b><font style="vertical-align: inherit;">複数回切り替えたときに</font><b><font style="vertical-align: inherit;">Store</font></b><font style="vertical-align: inherit;">操作に</font><font style="vertical-align: inherit;">費やされた時間を示しています</font><font style="vertical-align: inherit;">（そのような操作の1つの時間が示されています）。</font><b><font style="vertical-align: inherit;">glClear</font></b><font style="vertical-align: inherit;">により</font><b><font style="vertical-align: inherit;">ロード</font></b><font style="vertical-align: inherit;">操作がありません</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、つまり </font><font style="vertical-align: inherit;">より好ましいシナリオが測定されました。</font><font style="vertical-align: inherit;">デバイスで使用される権限が貢献しました。</font><font style="vertical-align: inherit;">それは多かれ少なかれインストールされたGPUのパワーに対応する可能性があります。</font><font style="vertical-align: inherit;">したがって、これらの数値は、さまざまな世代のモバイルビデオカードでのターゲットの切り替えがどれほどコストがかかるかについての一般的な考えのみを示しています。</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ミリ秒</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ミリ秒</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 320</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.2</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 512</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.74</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerVR G6200</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレノ615</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.7</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マリ-400</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adreno 530</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.4</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-t720</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.9</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マリ-g51</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.32</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerVR SXG 544</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mali-t830</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.15</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
取得したデータに基づいて、少なくとも古いビデオカードでは、フレームごとに1つまたは2つを超えるFBOスイッチを使用しないことをお勧めします。ゲームにローエンドデバイス用の個別のコードパスがある場合は、そこでFBOの変更を使用しないことをお勧めします。ただし、ローエンドでは、解像度を下げる問題が関係することがよくあります。 Androidでは、</font><b><font style="vertical-align: inherit;">SurfaceHolder.setFixedSize（）を</font></b><font style="vertical-align: inherit;">呼び出すことで、中間FBOを使用せずにレンダリング解像度を下げることができます</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></b><br>
<br>
<pre><code class="java hljs">surfaceView.getHolder().setFixedSize(...)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッドは、ゲームがメインの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surface</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーション（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NativeActivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">操作</font></b><font style="vertical-align: inherit;">するための一般的なスキーム）を</font><font style="vertical-align: inherit;">介してレンダリングされる場合は機能しません</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">メインの</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Surface</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用する場合</font><font style="vertical-align: inherit;">、ネイティブ関数</font><b><font style="vertical-align: inherit;">ANativeWindow_setBuffersGeometryを</font></b><font style="vertical-align: inherit;">呼び出すことで</font><b><font style="vertical-align: inherit;">、</font></b><font style="vertical-align: inherit;">より低い解像度を設定できます</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">JNIEXPORT <span class="hljs-keyword">void</span> JNICALL <span class="hljs-title">Java_com_organization_app_AppNativeActivity_setBufferGeometry</span><span class="hljs-params">(JNIEnv *env, jobject thiz, jobject surface, jint width, jint height)</span>
</span>{<font></font>
ANativeWindow* window = ANativeWindow_fromSurface(env, surface);&nbsp;<font></font>
ANativeWindow_setBuffersGeometry(window, width, height, AHARDWAREBUFFER_FORMAT_R8G8B8X8_UNORM);&nbsp;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Javaの場合：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBufferGeometry</span><span class="hljs-params">(Surface surface, <span class="hljs-keyword">int</span> width , <span class="hljs-keyword">int</span> height )</span></span>;&nbsp;<font></font>
...<font></font>
<span class="hljs-comment">//   SurfaceHolder.Callback</span>
<span class="hljs-meta">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">surfaceChanged</span><span class="hljs-params">(SurfaceHolder holder, <span class="hljs-keyword">int</span> format, <span class="hljs-keyword">int</span> width, <span class="hljs-keyword">int</span> height)</span>
</span>{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setBufferGeometry(holder.getSurface(), <span class="hljs-number">768</span>, <span class="hljs-number">1366</span>); <span class="hljs-comment">/* ... */</span>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、Androidで選択したサーフェスバッファーを制御するための便利なADBコマンドについて説明します。</font></font><br>
<br>
<pre><code class="plaintext hljs">adb shell dumpsys surfaceflinger
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーフェスバッファーのメモリ消費量を推定できる同様の結論を得ることができます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/2fe/ea6/5242feea615abe186c6c3538c9d60565.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリーンショットは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLSurfaceView</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゲーム</font><font style="vertical-align: inherit;">をトリプルバッファリングするための3つのバッファー</font><font style="vertical-align: inherit;">（黄色で強調表示）と、メイン</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーフェスの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2つのバッファー</font><font style="vertical-align: inherit;">（赤色で強調表示）を強調表示</font><font style="vertical-align: inherit;">するシステムを示しています</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NativeActivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用するときのデフォルトのスキームであるメインのSurfaceを介してレンダリングする場合、</font><font style="vertical-align: inherit;">追加のバッファーの割り当てを回避できます。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは今のところすべてです。</font><font style="vertical-align: inherit;">次の記事では、モバイルGPUを分類し、それらのシェーダーを最適化する方法を分析します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja492862/index.html">開発者向けの15のOracle APEXパフォーマンスチューニングのヒント</a></li>
<li><a href="../ja492864/index.html">船をハックできますか？</a></li>
<li><a href="../ja492866/index.html">本「言葉のない機械学習」</a></li>
<li><a href="../ja492868/index.html">ClickHouseの文字列最適化。Yandexレポート</a></li>
<li><a href="../ja492872/index.html">リモートアクセスを整理してハッカーの被害を受けない方法</a></li>
<li><a href="../ja492878/index.html">オタクのスリッパ：一時的なオフィス閉鎖でポジティブを探す</a></li>
<li><a href="../ja492880/index.html">私たちはスマートホームを何を建てるべきですか？</a></li>
<li><a href="../ja492884/index.html">YouTubeブロードキャストからのメッセージの受信+ PHPでのGoogle認証</a></li>
<li><a href="../ja492886/index.html">大量採用テスターのレシピ</a></li>
<li><a href="../ja492888/index.html">WireGuardを使用すべきでない理由</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>