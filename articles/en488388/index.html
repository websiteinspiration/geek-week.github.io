<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèº‚Äçü§ù‚Äçüßëüèª ‚ôÇÔ∏è üóÑÔ∏è Relogin and HTTP Basic Auth üéë üë®üèø‚Äçüî¨ üë®üèª‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Web developers have long been aware of the problem of logging and logging in to sites protected by HTTP Basic Authorization. Although there are other ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Relogin and HTTP Basic Auth</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488388/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web developers have long been aware of the problem of logging and logging in to sites protected by HTTP Basic Authorization. </font><font style="vertical-align: inherit;">Although there are other authentication methods that do not suffer from this problem, Basic Authorization is still often the best choice. </font><font style="vertical-align: inherit;">The network has enough materials describing various general and particular solutions. </font><font style="vertical-align: inherit;">But all of them, which I found, unfortunately, describe only some partial solutions that work in one browser and do not work in another. </font><font style="vertical-align: inherit;">Under cat I give a generalized end result of my research on this problem</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll make a reservation right away that I‚Äôm not a front-end developer, and I didn‚Äôt go into the whole variety of ‚Äúbrands‚Äù and browser versions. </font><font style="vertical-align: inherit;">Only mainstream with versions relevant at the time of writing. </font><font style="vertical-align: inherit;">For most web tasks this is enough. </font><font style="vertical-align: inherit;">For those developers who need support for the entire "zoo" of browsers, the article can be a good starting point. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The essence of the problem is that the HTTP Basic Authorization standard does not provide for logging. </font><font style="vertical-align: inherit;">Generally. </font><font style="vertical-align: inherit;">When you go to a page protected by Basic Authorization, the browser itself displays you its own window with a request for login / password and, with a successful login, saves them somewhere in its depths. </font><font style="vertical-align: inherit;">Then, all subsequent requests to other protected pages of this site will automatically use these values ‚Äã‚Äãin the Authorization header:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Authorization: Basic bm9uZTpub25l</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where bm9uZTpub25l is the base64-encoded login / password link none: none (your username and password may be different) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to log in, you just need to reset the old username / password in those very depths of the browser and on them place to record new ones. </font><font style="vertical-align: inherit;">This is where a surprise awaits us. </font><font style="vertical-align: inherit;">Since no standard regulates this action, each browser does this on its own understanding.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even worse, since the login / password request window is its own browser window, which already responds to HTTP page headers only, this window pops up before any processing of the page body. </font><font style="vertical-align: inherit;">That is, to execute some javascript when receiving a server response with a status of 401 does not work. </font><font style="vertical-align: inherit;">Before the user this window will pop out again and again with a repeated request for login / password.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, this point is critical, since for almost all browsers the only way to log out is to send a request to the server with obviously wrong login / password, receive a server response with the status 401 and then reset the browser‚Äôs login / password cache. </font><font style="vertical-align: inherit;">But if at the same time the browser does not allow you to process the response 401 and continue the login process already for the new user, taking control even at the stage of reading HTTP headers and throwing the very form of authorization into which you enter it will not work in your face, then this already a problem. </font><font style="vertical-align: inherit;">It doesn‚Äôt matter if this is a normal request by reference or XMLHttpRequest or fetch. </font><font style="vertical-align: inherit;">The browser still takes control at the stage of parsing the headers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So‚Ä¶</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initial data:</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a separate logout.html page on which all the logic is located in the javascript script, parts of which are given in the course of presentation</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Url specified - page address to redirect after successful login</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Url401 is specified - the address of the page that always returns the HTTP 401 error (not authorized)</font></font></li>
</ol><br>
<pre><code class="javascript hljs"><span class="hljs-comment">// file logout.html</span>
<span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"http://mysite.com/"</span>);
<span class="hljs-keyword">const</span> url401 = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"http://mysite.com/401"</span>);
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet explorer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our product does not require support for this browser, so the solution I have not personally tested. </font><font style="vertical-align: inherit;">Nevertheless, according to Google, there is a solution for it, and it is perhaps the simplest and most elegant of all. </font><font style="vertical-align: inherit;">Moreover, I have never met any information that this solution for Microsoft browsers has lost its relevance:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.execCommand(<span class="hljs-string">"ClearAuthenticationCache"</span>)) {
    <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In IE, there is a ClearAuthenticationCache method that discards "those very deep bowels." </font><font style="vertical-align: inherit;">Simple and elegant. </font><font style="vertical-align: inherit;">And no dancing with the auxiliary page 401. I do not know if this method works in Edge. </font><font style="vertical-align: inherit;">Probably yes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The document.execCommand construct returns true if the method exists and "worked". </font><font style="vertical-align: inherit;">Then window.location.assign (url) redirects the user to enter a new username and password</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firefox (72.0.1)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the context of our task, this is the most problematic browser. </font><font style="vertical-align: inherit;">For him, a complete solution still does not exist. </font><font style="vertical-align: inherit;">For 15-20 years, a request for the indicated problem has been hanging in the bug tracker of the team of its developers. </font><font style="vertical-align: inherit;">But "things are still there." </font><font style="vertical-align: inherit;">The maximum that can be achieved is the curve razlogin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Input: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firefox does not reset the password cache after receiving a 401 response through either XMLHttpRequest or fetch request. </font><font style="vertical-align: inherit;">Only through a regular request with the login / password in the URL itself. </font><font style="vertical-align: inherit;">That is, something like</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http: // none: none@mysite.com/</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The code:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/firefox|iceweasel|fxios/i</span>.test(<span class="hljs-built_in">window</span>.navigator.userAgent)) {<font></font>
    url.username = <span class="hljs-string">'none'</span>;<font></font>
    url.password = <span class="hljs-string">'none'</span>;
    <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After which the user receives a login / password input form, into which whatever you enter, it will pop up again and again. </font><font style="vertical-align: inherit;">The fact is that the entered values ‚Äã‚Äãwill not override the login / password values ‚Äã‚Äãspecified in the URL. </font><font style="vertical-align: inherit;">That is, instead of the entered values, a bunch of none: none will go to the server each time. </font><font style="vertical-align: inherit;">And to log in under a different name, the user must click cancel, go to the start page (http: //mysite.com/) and enter a new login / password there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crooked? </font><font style="vertical-align: inherit;">But alas, there is no other solution</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Chrome (79.0.3945.88)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Chrome, the fetch method works great. </font><font style="vertical-align: inherit;">But XMLHttpRequest does not work (((The cache is not reset, and the logging does not occur. Moreover, I tried to set the login / password both as parameters for the open method and setting the header.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/chrome/i</span>.test(<span class="hljs-built_in">window</span>.navigator.userAgent)) {<font></font>
    fetch(url401, {<font></font>
      <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Basic '</span> + btoa(<span class="hljs-string">'none:none'</span>),
        <span class="hljs-string">'X-Requested-With'</span>: <span class="hljs-string">'XMLHttpRequest'</span><font></font>
      }<font></font>
    }).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
    }).catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-built_in">console</span>.error(err));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We make a fetch request to page 401 with obviously incorrect username / password, we get a 401 response from the server, the browser flushes its cache. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMPORTANT! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The server should NOT return a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WWW-Authenticate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> header </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Otherwise, the browser will take control, and redirects from page 401 will never happen. </font><font style="vertical-align: inherit;">By convention, the server should not return this header if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X-Requested-With: XMLHttpRequest is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> specified in the request </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Therefore, the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X-Requested-With</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> header has been added to the request </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Safari (12)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Safari, the situation is exactly the opposite: XMLHttpRequest works, but fetch does not work</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();<font></font>
    xhr.open(<span class="hljs-string">"GET"</span>, url401, <span class="hljs-literal">true</span>, <span class="hljs-string">'none'</span>, <span class="hljs-string">'none'</span>);<font></font>
    xhr.setRequestHeader(<span class="hljs-string">'X-Requested-With'</span>, <span class="hljs-string">'XMLHttpRequest'</span>);<font></font>
    xhr.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-built_in">console</span>.error(err);<font></font>
    };<font></font>
    xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-built_in">window</span>.location.assign(url);<font></font>
    };<font></font>
    xhr.send()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The actions are the same as in Chrome, only through XMLHttpRequest </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Should work for versions of Safari 6+. </font><font style="vertical-align: inherit;">Earlier versions had their own bugs. </font><font style="vertical-align: inherit;">In particular, for example, in versions from 5.1, with each redirect, the browser forcibly re-requested authorization, which is why authorization with redirection to the final page did not work in principle. </font><font style="vertical-align: inherit;">And in versions prior to 5.0, the logging did not work.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488376/index.html">When the principle "to hell with everything, take it and do it!" not working: procrastinator notes</a></li>
<li><a href="../en488378/index.html">Briefly about naming in JS</a></li>
<li><a href="../en488380/index.html">The easiest start in STM through "one place"</a></li>
<li><a href="../en488382/index.html">I add 3-25 seconds delay to sites that I visit</a></li>
<li><a href="../en488386/index.html">Cases for applying network anomaly analysis tools: attacks through browser plug-ins</a></li>
<li><a href="../en488390/index.html">How to make Telegram bot friends with OpenId Connect</a></li>
<li><a href="../en488392/index.html">Production-ready images for k8s</a></li>
<li><a href="../en488404/index.html">Games worth waiting for in 2020</a></li>
<li><a href="../en488406/index.html">IPv6 - you are doing it wrong</a></li>
<li><a href="../en488408/index.html">STM32 Ethernet-RS485 IoT Gateway</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>