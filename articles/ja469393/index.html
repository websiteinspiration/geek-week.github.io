<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎒 🎲 🤛🏿 Flare-On 2019の記事 👃🏿 👩🏻‍🤝‍👨🏼 🤶🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="-0x01-はじめに
 

 Flare-On 2019 — - FireEye. . 11- , 13 . , 54 , 3 .
 

 , , IDA, . , , - . , .
 

 , !
 0x00 — 
 

1. 0x01 — Memecat Battlestation [Shar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Flare-On 2019の記事</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/469393/"><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/bz/4g/sb/bz4gsbxbvka4sjtartbqmxccw6q.png"></div><br>
<a name="intro"></a><br>
<h2 id="-0x01---intro"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-0x01-はじめに</font></font></h2><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Flare-On 2019</a> —    -  FireEye.         .        11-    ,      13 .       ,     54 ,    3    .</p><br>
<p>       ,      ,          IDA,          . ,  ,     -   .     ,             <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p>  ,     !</p><a name="habracut"></a><br>
<h2 id="0x00---soderzhanie">0x00 — </h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x01 — Memecat Battlestation [Shareware Demo Edition]</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x02 — Overlong</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x03 — Flarebear</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x04 — Dnschess</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x05 — demo</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x06 — bmphide</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x07 — wopr</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x08 — snake</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x09 — reloadered</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x0A — Mugatu</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x0B — vv_max</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x0C — help</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">0x0D — </a></li>
</ol><br>
<a name="task01"></a><br>
<h2 id="0x01---memecat-battlestation-shareware-demo-edition">0x01 — Memecat Battlestation [Shareware Demo Edition]</h2><br>
<blockquote>Welcome to the Sixth Flare-On Challenge!<br>
<br>
This is a simple game. Reverse engineer it to figure out what "weapon codes" you need to enter to defeat each of the two enemies and the victory screen will reveal the flag. Enter the flag here on this site to score and move on to the next level.<br>
<br>
* This challenge is written in .NET. If you don't already have a favorite .NET reverse engineering tool I recommend dnSpy<br>
<br>
** If you already solved the full version of this game at our booth at BlackHat or the subsequent release on twitter, congratulations, enter the flag from the victory screen now to bypass this level.</blockquote><p>       Black Hat USA 2019,       . <del>  ,   </del>   ,      .</p><br>
<a name="task02"></a><br>
<h2 id="0x02---overlong">0x02 — Overlong</h2><br>
<blockquote>The secret of this next challenge is cleverly hidden. However, with the right approach, finding the solution will not take an overlong amount of time.</blockquote><p> x86 .exe .        :</p><br>
<p><img src="https://habrastorage.org/webt/gb/0q/ee/gb0qeertq_z-3wk0jyry5tuyjts.png"></p><br>
<p>    ,           ( 1  4 ).         ,    , -    .                :</p><br>
<p><img src="https://habrastorage.org/webt/5q/lp/be/5qlpbeezlg3hmwbr8-bqnmd-50o.png"></p><br>
<p>       Python   :</p><br>
<pre><code class="python hljs">msg = [ ... ]  <span class="hljs-comment">#     </span><font></font>
<font></font>
output = []<font></font>
i = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> i &lt; len(msg):
    <span class="hljs-keyword">if</span> (msg[i] &gt;&gt; <span class="hljs-number">3</span>) == <span class="hljs-number">0x1e</span>:<font></font>
        out_char = (<font></font>
            ((msg[i + <span class="hljs-number">3</span>] &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span> ) |<font></font>
            ((msg[i + <span class="hljs-number">2</span>] &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span> ) |<font></font>
            ((msg[i + <span class="hljs-number">1</span>] &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">12</span>) |<font></font>
            ((msg[i + <span class="hljs-number">0</span>] &amp;    <span class="hljs-number">7</span>) &lt;&lt; <span class="hljs-number">18</span>)<font></font>
        )<font></font>
        output.append(out_char)<font></font>
        i += <span class="hljs-number">4</span>
    <span class="hljs-keyword">elif</span> (msg[i] &gt;&gt; <span class="hljs-number">4</span>) == <span class="hljs-number">0x0e</span>:<font></font>
        out_char = (<font></font>
            ((msg[i + <span class="hljs-number">2</span>] &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span> ) |<font></font>
            ((msg[i + <span class="hljs-number">1</span>] &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">6</span> ) |<font></font>
            ((msg[i + <span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xF</span>) &lt;&lt; <span class="hljs-number">12</span>)<font></font>
        )<font></font>
        output.append(out_char)<font></font>
        i += <span class="hljs-number">3</span>
    <span class="hljs-keyword">elif</span> (msg[i] &gt;&gt; <span class="hljs-number">5</span>) == <span class="hljs-number">6</span>:<font></font>
        out_char = (<font></font>
            ((msg[i + <span class="hljs-number">1</span>] &amp; <span class="hljs-number">0x3F</span>) &lt;&lt; <span class="hljs-number">0</span> ) |<font></font>
            ((msg[i + <span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xF</span>) &lt;&lt; <span class="hljs-number">6</span> )<font></font>
        )<font></font>
        output.append(out_char)<font></font>
        i += <span class="hljs-number">2</span>
    <span class="hljs-keyword">else</span>:<font></font>
        output.append(msg[i])<font></font>
        i += <span class="hljs-number">1</span><font></font>
<font></font>
print(bytes([i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> output]))
<span class="hljs-comment"># b'I never broke the encoding: I_a_M_t_h_e_e_n_C_o_D_i_n_g@flare-on.com'</span></code></pre><br>
<a name="task03"></a><br>
<h2 id="0x03---flarebear">0x03 — Flarebear</h2><br>
<blockquote>We at Flare have created our own Tamagotchi pet, the flarebear. He is very fussy. Keep him alive and happy and he will give you the flag.</blockquote><p>    <code>apk</code>   <code>Android</code>.       .</p><br>
<p>      .       <code>dex2jar</code>  <code>apk</code>  <code>jar</code>       <code>Java</code>   ,       <code>cfr</code>.</p><br>
<pre><code class="plaintext hljs">~/retools/d2j/d2j-dex2jar.sh flarebear.apk<font></font>
java -jar ~/retools/cfr/cfr-0.146.jar --outputdir src flarebear-dex2jar.jar</code></pre><br>
<p>   ,     <code>.danceWithFlag()</code>,     <code>FlareBearActivity.java</code>.  <code>.danceWithFlag()</code>   <code>raw</code>-     <code>.decrypt(String, byte[])</code>,     ,     <code>.getPassword()</code>.      ,    .        ,    <code>Android</code>       ,        .  ,  ,  ,   <code>.getPassword()</code>      .        <code>0</code>  <code>N</code>,          .</p><br>
<p>    :</p><br>
<div class="spoiler"><b class="spoiler_title">Main.java</b><div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.nio.charset.Charset;
<span class="hljs-keyword">import</span> java.security.Key;
<span class="hljs-keyword">import</span> java.security.spec.AlgorithmParameterSpec;
<span class="hljs-keyword">import</span> java.security.spec.KeySpec;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Collection;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;
<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> javax.crypto.Cipher;
<span class="hljs-keyword">import</span> javax.crypto.SecretKey;
<span class="hljs-keyword">import</span> javax.crypto.SecretKeyFactory;
<span class="hljs-keyword">import</span> javax.crypto.spec.IvParameterSpec;
<span class="hljs-keyword">import</span> javax.crypto.spec.PBEKeySpec;
<span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>{<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span> <span class="hljs-params">(String args [])</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
        Main a = <span class="hljs-keyword">new</span> Main();<font></font>
<font></font>
        InputStream inputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"ecstatic"</span>);
        <span class="hljs-keyword">long</span> fileSize = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"ecstatic"</span>).length();
        <span class="hljs-keyword">byte</span>[] file1 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[(<span class="hljs-keyword">int</span>) fileSize];<font></font>
        inputStream.read(file1);<font></font>
<font></font>
        inputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"ecstatic2"</span>);<font></font>
        fileSize = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"ecstatic2"</span>).length();
        <span class="hljs-keyword">byte</span>[] file2 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[(<span class="hljs-keyword">int</span>) fileSize];<font></font>
        inputStream.read(file2);<font></font>
<font></font>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">9</span>; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">7</span>; j++)<font></font>
            {<font></font>
                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> k = <span class="hljs-number">1</span>; k &lt; <span class="hljs-number">16</span>; k++)<font></font>
                {<font></font>
                    String pass = a.getPassword(i, j, k);<font></font>
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">byte</span>[] out1 = a.decrypt(pass, file1);
                        <span class="hljs-keyword">byte</span>[] out2 = a.decrypt(pass, file2);<font></font>
                        OutputStream outputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">"out1"</span>);<font></font>
                        outputStream.write(out1);<font></font>
                        outputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">"out2"</span>);<font></font>
                        outputStream.write(out2);<font></font>
                        System.out.println(<span class="hljs-string">"yep!"</span>);<font></font>
<font></font>
                    } <span class="hljs-keyword">catch</span> (javax.crypto.BadPaddingException ex) {<font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] decrypt(Object object, <span class="hljs-keyword">byte</span>[] arrby) <span class="hljs-keyword">throws</span> Exception  {<font></font>
        Object object2 = Charset.forName(<span class="hljs-string">"UTF-8"</span>);<font></font>
        object2 = <span class="hljs-string">"pawsitive_vibes!"</span>.getBytes((Charset)object2);<font></font>
        object2 = <span class="hljs-keyword">new</span> IvParameterSpec((<span class="hljs-keyword">byte</span>[])object2);<font></font>
        object = ((String)object).toCharArray();<font></font>
        Object object3 = Charset.forName(<span class="hljs-string">"UTF-8"</span>);<font></font>
        object3 = <span class="hljs-string">"NaClNaClNaCl"</span>.getBytes((Charset)object3);<font></font>
        object = <span class="hljs-keyword">new</span> PBEKeySpec((<span class="hljs-keyword">char</span>[])object, (<span class="hljs-keyword">byte</span>[])object3, <span class="hljs-number">1234</span>, <span class="hljs-number">256</span>);<font></font>
        object = SecretKeyFactory.getInstance(<span class="hljs-string">"PBKDF2WithHmacSHA1"</span>).generateSecret((KeySpec)object);<font></font>
        object3 = <span class="hljs-keyword">new</span> SecretKeySpec(((SecretKey)object).getEncoded(), <span class="hljs-string">"AES"</span>);<font></font>
        object = Cipher.getInstance(<span class="hljs-string">"AES/CBC/PKCS5Padding"</span>);<font></font>
        ((Cipher)object).init(<span class="hljs-number">2</span>, (Key)object3, (AlgorithmParameterSpec)object2);<font></font>
        object = ((Cipher)object).doFinal(arrby);<font></font>
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">byte</span> [])object;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n, <span class="hljs-keyword">int</span> n2, <span class="hljs-keyword">int</span> n3)</span> </span>{<font></font>
        String string2 = <span class="hljs-string">"*"</span>;<font></font>
        String string3 = <span class="hljs-string">"*"</span>;
        <span class="hljs-keyword">switch</span> (n % <span class="hljs-number">9</span>) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">8</span>: {<font></font>
                string2 = <span class="hljs-string">"*"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>: {<font></font>
                string2 = <span class="hljs-string">"&amp;"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>: {<font></font>
                string2 = <span class="hljs-string">"@"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: {<font></font>
                string2 = <span class="hljs-string">"#"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: {<font></font>
                string2 = <span class="hljs-string">"!"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: {<font></font>
                string2 = <span class="hljs-string">"+"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: {<font></font>
                string2 = <span class="hljs-string">"$"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: {<font></font>
                string2 = <span class="hljs-string">"-"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: {<font></font>
                string2 = <span class="hljs-string">"_"</span>;<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-keyword">switch</span> (n3 % <span class="hljs-number">7</span>) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>: {<font></font>
                string3 = <span class="hljs-string">"@"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: {<font></font>
                string3 = <span class="hljs-string">"&amp;"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: {<font></font>
                string3 = <span class="hljs-string">"#"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: {<font></font>
                string3 = <span class="hljs-string">"+"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: {<font></font>
                string3 = <span class="hljs-string">"_"</span>;
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: {<font></font>
                string3 = <span class="hljs-string">"$"</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<font></font>
        }<font></font>
        String string4 = String.join(<span class="hljs-string">""</span>, Collections.nCopies(n / n3, <span class="hljs-string">"flare"</span>));<font></font>
        String string5 = String.join(<span class="hljs-string">""</span>, Collections.nCopies(n2 * <span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>.rotN(<span class="hljs-string">"bear"</span>, n * n2)));<font></font>
        String string6 = String.join(<span class="hljs-string">""</span>, Collections.nCopies(n3, <span class="hljs-string">"yeah"</span>));<font></font>
        StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder();<font></font>
        stringBuilder.append(string4);<font></font>
        stringBuilder.append(string2);<font></font>
        stringBuilder.append(string5);<font></font>
        stringBuilder.append(string3);<font></font>
        stringBuilder.append(string6);<font></font>
        <span class="hljs-keyword">return</span> stringBuilder.toString();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">rotN</span><span class="hljs-params">(String charSequence, <span class="hljs-keyword">int</span> n)</span> </span>{<font></font>
        Collection&lt;String&gt; collection = <span class="hljs-keyword">new</span> ArrayList(charSequence.length());
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; charSequence.length(); ++i) {
            <span class="hljs-keyword">char</span> c;
            <span class="hljs-keyword">char</span> c2 = c = charSequence.charAt(i);
            <span class="hljs-keyword">if</span> (Character.isLowerCase(c)) {
                <span class="hljs-keyword">char</span> c3;<font></font>
                c2 = c3 = (<span class="hljs-keyword">char</span>)(c + n);
                <span class="hljs-keyword">if</span> (c3 &gt; <span class="hljs-string">'z'</span>) {<font></font>
                    c2 = c3 = (<span class="hljs-keyword">char</span>)(c3 - n * <span class="hljs-number">2</span>);<font></font>
                }<font></font>
            }<font></font>
            collection.add(Character.valueOf(c2).toString());<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> collection.stream().collect(Collectors.joining());
        <span class="hljs-comment">// return ArraysKt.joinToString$default(CollectionsKt.toCharArray((List)collection), (CharSequence)FLARE_BEAR_NAME, null, null, 0, null, null, 62, null);</span><font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>  ,     :</p><br>
<pre><code class="plaintext hljs">$ ~/retools/apktool/apktool d flarebear.apk<font></font>
$ cp flarebear/res/raw/* .<font></font>
$ javac Main.java<font></font>
$ java Main</code></pre><br>
<p> ,   ́     .        :</p><br>
<pre><code class="plaintext hljs">~/flareon2019/3 - Flarebear$ file out*<font></font>
out1: PNG image data, 2100 x 2310, 8-bit/color RGB, non-interlaced<font></font>
out2: PNG image data, 2100 x 2310, 8-bit/color RGB, non-interlaced</code></pre><br>
<img width="400" src="https://habrastorage.org/webt/eo/sp/wv/eospwvjutdz_76f4qrwzqqzstie.png"><br>
<img width="400" src="https://habrastorage.org/webt/mr/cf/wk/mrcfwklfuon1ebo1ctqafdzicti.png"><br>
<a name="task04"></a><br>
<h2 id="0x04---dnschess">0x04 — Dnschess</h2><br>
<blockquote>Some suspicious network traffic led us to this unauthorized chess program running on an Ubuntu desktop. This appears to be the work of cyberspace computer hackers. You'll need to make the right moves to solve this one. Good luck!</blockquote><p>     ,  <code>ELF</code>- <code>ChessUI</code>   <code>ChessAI.so</code>.   ,    .</p><br>
<img width="500" src="https://habrastorage.org/webt/5t/7m/gn/5t7mgn6jyrc2zndnuwliuiuzovc.png"><br>
<p>    .</p><br>
<p><img src="https://habrastorage.org/webt/br/00/-5/br00-59yyrbti3rrdxgvizcfkdk.png"></p><br>
<p>      <code>DNS</code>-  <code>A</code>.      ,         <code>.game-of-thrones.flare-on.com</code>,  <code>rook-c3-c6.game-of-thrones.flare-on.com</code>.           <code>ChessAI.so</code>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">signed</span> __int64 __fastcall <span class="hljs-title">getNextMove</span><span class="hljs-params">(<span class="hljs-keyword">int</span> idx, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *chess_name, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> pos_from, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> pos_to, \__int64 a5)</span>
</span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hostent</span> *<span class="hljs-title">v9</span>;</span> <span class="hljs-comment">// [rsp+20h] [rbp-60h]</span>
  <span class="hljs-keyword">char</span> *ip_addr; <span class="hljs-comment">// [rsp+28h] [rbp-58h]</span>
  <span class="hljs-keyword">char</span> dns_name; <span class="hljs-comment">// [rsp+30h] [rbp-50h]</span>
  <span class="hljs-keyword">unsigned</span> __int64 v12; <span class="hljs-comment">// [rsp+78h] [rbp-8h]</span><font></font>
<font></font>
  v12 = __readfsqword(<span class="hljs-number">0x28</span>u);
  <span class="hljs-built_in">strcpy</span>(&amp;dns_name, chess_name);<font></font>
  pos_to_str(&amp;dns_name, pos_from);<font></font>
  pos_to_str(&amp;dns_name, pos_to);<font></font>
  <span class="hljs-built_in">strcat</span>(&amp;dns_name, <span class="hljs-string">".game-of-thrones.flare-on.com"</span>);<font></font>
  v9 = gethostbyname(&amp;dns_name);<font></font>
  <span class="hljs-keyword">if</span> ( !v9 )
    <span class="hljs-keyword">return</span> <span class="hljs-number">2L</span>L;<font></font>
  ip_addr = *v9-&gt;h_addr_list;<font></font>
  <span class="hljs-keyword">if</span> ( *ip_addr != <span class="hljs-number">127</span> || ip_addr[<span class="hljs-number">3</span>] &amp; <span class="hljs-number">1</span> || idx != (ip_addr[<span class="hljs-number">2</span>] &amp; <span class="hljs-number">0xF</span>) )
    <span class="hljs-keyword">return</span> <span class="hljs-number">2L</span>L;<font></font>
  sleep(<span class="hljs-number">1u</span>);<font></font>
  flag[<span class="hljs-number">2</span> * idx] = ip_addr[<span class="hljs-number">1</span>] ^ key[<span class="hljs-number">2</span> * idx];<font></font>
  flag[<span class="hljs-number">2</span> * idx + <span class="hljs-number">1</span>] = ip_addr[<span class="hljs-number">1</span>] ^ key[<span class="hljs-number">2</span> * idx + <span class="hljs-number">1</span>];<font></font>
  *(_DWORD *)a5 = (<span class="hljs-keyword">unsigned</span> __int8)ip_addr[<span class="hljs-number">2</span>] &gt;&gt; <span class="hljs-number">4</span>;<font></font>
  *(_DWORD *)(a5 + <span class="hljs-number">4</span>) = (<span class="hljs-keyword">unsigned</span> __int8)ip_addr[<span class="hljs-number">3</span>] &gt;&gt; <span class="hljs-number">1</span>;
  <span class="hljs-built_in">strcpy</span>((<span class="hljs-keyword">char</span> *)(a5 + <span class="hljs-number">8</span>), off_4120[idx]);
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">unsigned</span> __int8)ip_addr[<span class="hljs-number">3</span>] &gt;&gt; <span class="hljs-number">7</span>;<font></font>
}</code></pre><br>
<p>  ,     <code>ip</code>-    ,     ,    <code>flag</code>.</p><br>
<p>       <code>ip</code>-   .       :</p><br>
<pre><code class="plaintext hljs">tshark -r capture.pcap | grep -P -o '127.(\d+).(\d+).(\d+)' | grep -v '127.0.0.1'</code></pre><br>
<p>  <code>ip</code>-   <code>ips</code>      <code>Python</code>   :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">with</span> open(<span class="hljs-string">'ips'</span>) <span class="hljs-keyword">as</span> f:<font></font>
    ips = f.read().split()<font></font>
<font></font>
flag = bytearray(<span class="hljs-number">64</span>)<font></font>
key = <span class="hljs-string">b'yZ\xb8\xbc\xec\xd3\xdf\xdd\x99\xa5\xb6\xac\x156\x85\x8d\t\x08wRMqT}\xa7\xa7\x08\x16\xfd\xd7'</span>
<span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> ips:<font></font>
    a, b, c, d = map(int, ip.split(<span class="hljs-string">'.'</span>))
    <span class="hljs-keyword">if</span> d &amp; <span class="hljs-number">1</span>:
        <span class="hljs-keyword">continue</span>
    idx = c &amp; <span class="hljs-number">0xf</span>
    <span class="hljs-keyword">if</span> idx &gt; <span class="hljs-number">14</span>:
        <span class="hljs-keyword">continue</span>
    flag[<span class="hljs-number">2</span>*idx] = b ^ key[<span class="hljs-number">2</span>*idx]<font></font>
    flag[<span class="hljs-number">2</span>*idx + <span class="hljs-number">1</span>] = b ^ key[<span class="hljs-number">2</span>*idx + <span class="hljs-number">1</span>]<font></font>
print(flag.decode() + <span class="hljs-string">'@flare-on.com'</span>)
<span class="hljs-comment"># LooksLikeYouLockedUpTheLookupZ@flare-on.com</span></code></pre><br>
<a name="task05"></a><br>
<h2 id="0x05---demo">0x05 — demo</h2><br>
<blockquote>Someone on the Flare team tried to impress us with their demoscene skills. It seems blank. See if you can figure it out or maybe we will have to fire them. No pressure.</blockquote><p>   <code>4k.exe</code>,   <code>DirectX</code>.         <code>FlareOn</code>.</p><br>
<p><img src="https://habrastorage.org/webt/db/cw/ll/dbcwllgkqhasqqyvcmjv0iugwoc.png"></p><br>
<p>      ,     .       .          ,      <code>ret</code>  ,   .      <code>0x00420000</code>,       :</p><br>
<p><img src="https://habrastorage.org/webt/ba/ns/cb/banscbeyqmgqabaf6nbg5khebgk.png"></p><br>
<p>           <code>IDA</code>   <code>API</code>    .</p><br>
<p>         .        .      :</p><br>
<p><img src="https://habrastorage.org/webt/hj/em/xv/hjemxvwadjd5f6z-paauo9vh4by.png"></p><br>
<p>""      :</p><br>
<p><img src="https://habrastorage.org/webt/5l/gl/-4/5lgl-4g3pzgrxf0gigfh5m99uqe.png"></p><br>
<p>    <code>DeviceInterface</code>  <code>IDirect3DDevice9 **</code>.      ,         .      , ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.          <code>IDA</code>.     <code>DeviceInterface</code>,      .                  .</p><br>
<p><img src="https://habrastorage.org/webt/gh/yc/35/ghyc35pxpo9mhyi8dx-louqlcsy.png"></p><br>
<p><img src="https://habrastorage.org/webt/wg/sk/ql/wgskqlsgkdxsul3hqll8m-ohv8c.png"></p><br>
<p>    ,        (, polygon mesh),         .          <code>XOR</code>,    .     .     , ..     .   ,  ,   <code>Z</code>      0,           <code>matplotlib</code>.       :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">'vertexes'</span>, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
    data = f.read()<font></font>
<font></font>
n = len(data) // <span class="hljs-number">4</span>
data = list(struct.unpack(<span class="hljs-string">'{}I'</span>.format(n), data))<font></font>
key = [<span class="hljs-number">0xCB343C8</span>, <span class="hljs-number">0x867B81F0</span>, <span class="hljs-number">0x84AF72C3</span>]<font></font>
data = [data[i] ^ key[i % <span class="hljs-number">3</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(data))]<font></font>
data = struct.pack(<span class="hljs-string">'{}I'</span>.format(n), *data)<font></font>
data = list(struct.unpack(<span class="hljs-string">'{}f'</span>.format(n), data))<font></font>
<font></font>
x = data[<span class="hljs-number">0</span>::<span class="hljs-number">3</span>]<font></font>
y = data[<span class="hljs-number">1</span>::<span class="hljs-number">3</span>]<font></font>
z = data[<span class="hljs-number">2</span>::<span class="hljs-number">3</span>]<font></font>
<font></font>
print(z)<font></font>
<font></font>
plt.plot(x, y)<font></font>
plt.show()</code></pre><br>
<p><img src="https://habrastorage.org/webt/ke/5w/z5/ke5wz52y1nkpe3jpgxsrl9vcg4c.png"></p><br>
<a name="task06"></a><br>
<h2 id="0x06---bmphide">0x06 — bmphide</h2><br>
<blockquote>Tyler Dean hiked up Mt. Elbert (Colorado's tallest mountain) at 2am to capture this picture at the perfect time. Never skip leg day. We found this picture and executable on a thumb drive he left at the trail head. Can he be trusted?</blockquote><p>     <code>bmphide.exe</code>   <code>image.bmp</code>.  ,          .</p><br>
<p>   <code>C#</code>,       <code>dnSpy</code>.   ,     .     <code>Program.Main</code>,             :</p><br>
<pre><code class="cs hljs"><span class="hljs-comment">// BMPHIDE.Program</span>
<span class="hljs-comment">// Token: 0x06000018 RID: 24 RVA: 0x00002C18 File Offset: 0x00002C18</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span><font></font>
{<font></font>
    Program.Init();<font></font>
    Program.yy += <span class="hljs-number">18</span>;
    <span class="hljs-keyword">string</span> filename = args[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">string</span> fullPath = Path.GetFullPath(args[<span class="hljs-number">0</span>]);
    <span class="hljs-keyword">string</span> fullPath2 = Path.GetFullPath(args[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">byte</span>[] data = File.ReadAllBytes(fullPath2);<font></font>
    Bitmap bitmap = <span class="hljs-keyword">new</span> Bitmap(fullPath);
    <span class="hljs-keyword">byte</span>[] data2 = Program.h(data);<font></font>
    Program.i(bitmap, data2);<font></font>
    bitmap.Save(filename);<font></font>
}<font></font>
</code></pre><br>
<ul>
<li>      <code>Program.Init()</code></li>
<li>     </li>
<li>   <code>byte [] Program.h(byte [])</code>     </li>
<li>   <code>Program.i(Bitmap, byte[])</code>      </li>
<li>     </li>
</ul><br>
<p>       <code>A</code>.            <code>ConfuserEx</code> ( <code>AntiTamper.JIT.cs</code>).     .         <code>de4dot</code>     ,     .</p><br>
<p>  <code>Program.i</code>,       .</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">i</span>(<span class="hljs-params">Bitmap bm, <span class="hljs-keyword">byte</span>[] data</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">int</span> num = Program.j(<span class="hljs-number">103</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = Program.j(<span class="hljs-number">103</span>); i &lt; bm.Width; i++)<font></font>
  {<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = Program.j(<span class="hljs-number">103</span>); j &lt; bm.Height; j++)<font></font>
    {<font></font>
      <span class="hljs-keyword">bool</span> flag = num &gt; data.Length - Program.j(<span class="hljs-number">231</span>);
      <span class="hljs-keyword">if</span> (flag)<font></font>
      {<font></font>
        <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
      Color pixel = bm.GetPixel(i, j);<font></font>
      <span class="hljs-keyword">int</span> red = ((<span class="hljs-keyword">int</span>)pixel.R &amp; Program.j(<span class="hljs-number">27</span>)) | ((<span class="hljs-keyword">int</span>)data[num] &amp; Program.j(<span class="hljs-number">228</span>));
      <span class="hljs-keyword">int</span> green = ((<span class="hljs-keyword">int</span>)pixel.G &amp; Program.j(<span class="hljs-number">27</span>)) | (data[num] &gt;&gt; Program.j(<span class="hljs-number">230</span>) &amp; Program.j(<span class="hljs-number">228</span>));
      <span class="hljs-keyword">int</span> blue = ((<span class="hljs-keyword">int</span>)pixel.B &amp; Program.j(<span class="hljs-number">25</span>)) | (data[num] &gt;&gt; Program.j(<span class="hljs-number">100</span>) &amp; Program.j(<span class="hljs-number">230</span>));<font></font>
      Color color = Color.FromArgb(Program.j(<span class="hljs-number">103</span>), red, green, blue);<font></font>
      bm.SetPixel(i, j, color);<font></font>
      num += Program.j(<span class="hljs-number">231</span>);<font></font>
    }<font></font>
  }<font></font>
}</code></pre><br>
<p>    <code>LSB</code>,   ,   ,   <code>int Program.j(byte)</code>.        , ,   ,     <code>Program.Init()</code>.      ,        . <code>dnSpy</code>         .      <code>Program.Main</code>  :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span><font></font>
{<font></font>
    Program.Init();<font></font>
    Program.yy += <span class="hljs-number">18</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">256</span>; i++)<font></font>
    {<font></font>
        Console.WriteLine(<span class="hljs-keyword">string</span>.Format(<span class="hljs-string">"j({0}) = {1}"</span>, i, Program.j((<span class="hljs-keyword">byte</span>)i)));<font></font>
    }<font></font>
}</code></pre><br>
<p>     :</p><br>
<pre><code class="plaintext hljs">E:\&gt;bmphide_j.exe<font></font>
j(0) = 206<font></font>
j(1) = 204<font></font>
j(2) = 202<font></font>
j(3) = 200<font></font>
j(4) = 198<font></font>
j(5) = 196<font></font>
j(6) = 194<font></font>
j(7) = 192<font></font>
j(8) = 222<font></font>
j(9) = 220<font></font>
j(10) = 218<font></font>
j(11) = 216<font></font>
j(12) = 214<font></font>
j(13) = 212<font></font>
j(14) = 210<font></font>
j(15) = 208<font></font>
j(16) = 238<font></font>
j(17) = 236<font></font>
j(18) = 234<font></font>
j(19) = 232<font></font>
j(20) = 230<font></font>
...</code></pre><br>
<p>  <code>Program.j</code>   <code>Program.i</code>   :</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">i</span>(<span class="hljs-params">Bitmap bm, <span class="hljs-keyword">byte</span>[] data</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">int</span> num = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; bm.Width; i++)<font></font>
  {<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; bm.Height; j++)<font></font>
    {<font></font>
      <span class="hljs-keyword">bool</span> flag = num &gt; data.Length - <span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (flag)<font></font>
      {<font></font>
        <span class="hljs-keyword">break</span>;<font></font>
      }<font></font>
      Color pixel = bm.GetPixel(i, j);<font></font>
      <span class="hljs-keyword">int</span> red = ((<span class="hljs-keyword">int</span>)pixel.R &amp; <span class="hljs-number">0xf8</span>) | ((<span class="hljs-keyword">int</span>)data[num] &amp; <span class="hljs-number">0x7</span>);
      <span class="hljs-keyword">int</span> green = ((<span class="hljs-keyword">int</span>)pixel.G &amp; <span class="hljs-number">0xf8</span>) | (data[num] &gt;&gt; <span class="hljs-number">3</span> &amp; <span class="hljs-number">0x7</span>);
      <span class="hljs-keyword">int</span> blue = ((<span class="hljs-keyword">int</span>)pixel.B &amp; <span class="hljs-number">0xfc</span>) | (data[num] &gt;&gt; <span class="hljs-number">6</span> &amp; <span class="hljs-number">0x3</span>);<font></font>
      Color color = Color.FromArgb(<span class="hljs-number">0</span>, red, green, blue);<font></font>
      bm.SetPixel(i, j, color);<font></font>
      num += <span class="hljs-number">1</span>;<font></font>
    }<font></font>
  }<font></font>
}</code></pre><br>
<p>         :</p><br>
<ul>
<li>  0  2   3     </li>
<li>  3  5   3     </li>
<li>  6  7   2     </li>
</ul><br>
<p>       ,        .  ,   <code>A</code>       ( <code>A.VerifySignature(MethodInfo m1, MethodInfo m2)</code>)   <code>IL</code> -  ( <code>A.IncrementMaxStack</code>).</p><br>
<p>  ,     <code>Program</code>,  <code>Program.Init</code>   <code>IL</code> -        .    .  ,  ,    ,     <code>A.VerifySignature</code>,      <code>A.CalculateStack()</code>  <code>Program.Init</code>, ..   .</p><br>
<p><img src="https://habrastorage.org/webt/v7/2o/l4/v72ol4f8pcefzyg7lnmkywe4tyw.png"></p><br>
<p>   ,   <code>Program.a</code>   <code>Program.b</code>,  <code>Program.c</code> —  <code>Program.d</code>.</p><br>
<p>     -:</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint</span> <span class="hljs-title">IncrementMaxStack</span>(<span class="hljs-params">IntPtr self, A.ICorJitInfo* comp, A.CORINFO_METHOD_INFO* info, <span class="hljs-keyword">uint</span> flags, <span class="hljs-keyword">byte</span>** nativeEntry, <span class="hljs-keyword">uint</span>* nativeSizeOfCode</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">bool</span> flag = info != <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (flag)<font></font>
    {<font></font>
        MethodBase methodBase = A.c(info-&gt;ftn);<font></font>
        <span class="hljs-keyword">bool</span> flag2 = methodBase != <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (flag2)<font></font>
        {<font></font>
            <span class="hljs-keyword">bool</span> flag3 = methodBase.MetadataToken == <span class="hljs-number">100663317</span>;
            <span class="hljs-keyword">if</span> (flag3)<font></font>
            {<font></font>
                <span class="hljs-keyword">uint</span> flNewProtect;<font></font>
                A.VirtualProtect((IntPtr)((<span class="hljs-keyword">void</span>*)info-&gt;ILCode), info-&gt;ILCodeSize, <span class="hljs-number">4u</span>, <span class="hljs-keyword">out</span> flNewProtect);<font></font>
                Marshal.WriteByte((IntPtr)((<span class="hljs-keyword">void</span>*)info-&gt;ILCode), <span class="hljs-number">23</span>, <span class="hljs-number">20</span>);<font></font>
                Marshal.WriteByte((IntPtr)((<span class="hljs-keyword">void</span>*)info-&gt;ILCode), <span class="hljs-number">62</span>, <span class="hljs-number">20</span>);<font></font>
                A.VirtualProtect((IntPtr)((<span class="hljs-keyword">void</span>*)info-&gt;ILCode), info-&gt;ILCodeSize, flNewProtect, <span class="hljs-keyword">out</span> flNewProtect);<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span><font></font>
            {<font></font>
                <span class="hljs-keyword">bool</span> flag4 = methodBase.MetadataToken == <span class="hljs-number">100663316</span>;
                <span class="hljs-keyword">if</span> (flag4)<font></font>
                {<font></font>
                    <span class="hljs-keyword">uint</span> flNewProtect2;<font></font>
                    A.VirtualProtect((IntPtr)((<span class="hljs-keyword">void</span>*)info-&gt;ILCode), info-&gt;ILCodeSize, <span class="hljs-number">4u</span>, <span class="hljs-keyword">out</span> flNewProtect2);<font></font>
                    Marshal.WriteInt32((IntPtr)((<span class="hljs-keyword">void</span>*)info-&gt;ILCode), <span class="hljs-number">6</span>, <span class="hljs-number">309030853</span>);<font></font>
                    Marshal.WriteInt32((IntPtr)((<span class="hljs-keyword">void</span>*)info-&gt;ILCode), <span class="hljs-number">18</span>, <span class="hljs-number">209897853</span>);<font></font>
                    A.VirtualProtect((IntPtr)((<span class="hljs-keyword">void</span>*)info-&gt;ILCode), info-&gt;ILCodeSize, flNewProtect2, <span class="hljs-keyword">out</span> flNewProtect2);<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> A.originalDelegate(self, comp, info, flags, nativeEntry, nativeSizeOfCode);<font></font>
}</code></pre><br>
<p>,        <code>MetadataToken</code>,   <code>0x6000015</code>  <code>0x6000014</code>.     <code>Program.h</code>  <code>Program.g</code>.  <code>dnSpy</code>   <code>hex</code>-,       :   ( )  - ( ),    .      <code>hex</code>-           (, <code>File Offset: 0x00002924</code>).</p><br>
<p><img src="https://habrastorage.org/webt/xt/i6/e6/xti6e6knsrkyrapcutnkypgfeau.png"></p><br>
<p>    :   ,   hex-     ,     <code>dnSpy</code>     <code>a -&gt; b</code>  <code>c -&gt; d</code>  <code>Program.h</code>.    <code>Program.Init</code>     <code>A</code>.    ,                 ,      .           .</p><br>
<p><img src="https://habrastorage.org/webt/lq/wo/em/lqwoemy3gsysvsptxholl6ioyey.png"></p><br>
<p><img src="https://habrastorage.org/webt/le/tw/j6/letwj6p_uzdmlglrgsky2gifwuy.png"></p><br>
<p>    .   ,       <code>Python</code>:</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<font></font>
<font></font>
<span class="hljs-comment"># Rotate left: 0b1001 --&gt; 0b0011</span>
rol = <span class="hljs-keyword">lambda</span> val, r_bits, max_bits: \<font></font>
    (val &lt;&lt; r_bits%max_bits) &amp; (<span class="hljs-number">2</span>**max_bits<span class="hljs-number">-1</span>) | \<font></font>
    ((val &amp; (<span class="hljs-number">2</span>**max_bits<span class="hljs-number">-1</span>)) &gt;&gt; (max_bits-(r_bits%max_bits)))<font></font>
<font></font>
<span class="hljs-comment"># Rotate right: 0b1001 --&gt; 0b1100</span>
ror = <span class="hljs-keyword">lambda</span> val, r_bits, max_bits: \<font></font>
    ((val &amp; (<span class="hljs-number">2</span>**max_bits<span class="hljs-number">-1</span>)) &gt;&gt; r_bits%max_bits) | \<font></font>
    (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (<span class="hljs-number">2</span>**max_bits<span class="hljs-number">-1</span>))<font></font>
<font></font>
rol8 = <span class="hljs-keyword">lambda</span> a, b: rol(a, b, <span class="hljs-number">8</span>)<font></font>
ror8 = <span class="hljs-keyword">lambda</span> a, b: ror(a, b, <span class="hljs-number">8</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract</span>(<span class="hljs-params">fname</span>):</span><font></font>
    img = Image.open(fname)<font></font>
    w, h = img.size<font></font>
    result = bytearray()<font></font>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(w):
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(h):<font></font>
            r, g, b = img.getpixel((i, j))<font></font>
            <span class="hljs-comment"># print('{:02x} {:02x} {:02x}'.format(r, g, b))</span>
            byte = (r &amp; <span class="hljs-number">0b111</span>) | ((g &amp; <span class="hljs-number">0b111</span>) &lt;&lt; <span class="hljs-number">3</span>) | ((b &amp; <span class="hljs-number">0b11</span>) &lt;&lt; <span class="hljs-number">6</span>)<font></font>
            result.append(byte)<font></font>
    <span class="hljs-keyword">return</span> result<font></font>
<font></font>
enc = extract(<span class="hljs-string">'image.bmp'</span>)<font></font>
n = len(enc)<font></font>
dec = bytearray()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">g</span>(<span class="hljs-params">idx</span>):</span>
    b = ((idx + <span class="hljs-number">1</span>) * <span class="hljs-number">309030853</span>) &amp; <span class="hljs-number">0xff</span>
    k = ((idx + <span class="hljs-number">2</span>) * <span class="hljs-number">209897853</span>) &amp; <span class="hljs-number">0xff</span>
    <span class="hljs-keyword">return</span> b ^ k<font></font>
<font></font>
j = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(n):<font></font>
    x = enc[i]<font></font>
    x = rol8(x, <span class="hljs-number">3</span>)<font></font>
    x ^= g(<span class="hljs-number">2</span>*i + <span class="hljs-number">1</span>)<font></font>
    x = ror8(x, <span class="hljs-number">7</span>)<font></font>
    x ^= g(<span class="hljs-number">2</span>*i + <span class="hljs-number">0</span>)<font></font>
    dec.append(x)<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">'output'</span>, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
    f.write(dec)</code></pre><br>
<p>  ,     <code>bmp</code>   .    ,     .</p><br>
<p><img src="https://habrastorage.org/webt/jj/ba/yq/jjbayqp9cpownsuf1wlrwar-rem.png"></p><br>
<a name="task07"></a><br>
<h2 id="0x07---wopr">0x07 — wopr</h2><br>
<blockquote>We used our own computer hacking skills to "find" this AI on a military supercomputer. It does strongly resemble the classic 1983 movie WarGames. Perhaps life imitates art? If you can find the launch codes for us, we'll let you pass to the next challenge. We promise not to start a thermonuclear war.</blockquote><p>     <code>worp.exe</code>.   ,       .</p><br>
<p><img src="https://habrastorage.org/webt/ji/1p/2w/ji1p2w_9cpkv8vsaxbezvicozjc.png"></p><br>
<p>   ,    .       <code>_MEIPASS2</code>.    ,    ,     ,           <code>_MEIPASS2</code>.  :</p><br>
<pre><code class="plaintext hljs">.<font></font>
├── api-ms-win-core-console-l1-1-0.dll<font></font>
├── ...<font></font>
├── ...<font></font>
├── api-ms-win-crt-utility-l1-1-0.dll<font></font>
├── base_library.zip<font></font>
├── _bz2.pyd<font></font>
├── _ctypes.pyd<font></font>
├── _hashlib.pyd<font></font>
├── libcrypto-1_1.dll<font></font>
├── libssl-1_1.dll<font></font>
├── _lzma.pyd<font></font>
├── pyexpat.pyd<font></font>
├── python37.dll<font></font>
├── select.pyd<font></font>
├── _socket.pyd<font></font>
├── _ssl.pyd<font></font>
├── this<font></font>
│&nbsp;&nbsp; ├── __init__.py<font></font>
│&nbsp;&nbsp; └── key<font></font>
├── ucrtbase.dll<font></font>
├── unicodedata.pyd<font></font>
├── VCRUNTIME140.dll<font></font>
└── wopr.exe.manifest<font></font>
<font></font>
1 directory, 56 files</code></pre><br>
<p>  ,       <code>exe</code>    <code>Python</code>.              <code>Python</code>: <code>PyMarshal_ReadObjectFromString</code>, <code>PyEval_EvalCode</code>  .      <code>Python</code> -.              <code>_MEIPASS2</code>   .      ,     <code>PyMarshal_ReadObjectFromString</code>.            <code>Python</code>-   .         .     2 ,        ,    .</p><br>
<p>           <code>.pyc</code>  ( - <code>Python</code>)     <code>uncompyle6</code>.        16- .       :</p><br>
<pre><code class="plaintext hljs">00000000: 42 0d 0d 0a 00 00 00 00 de cd 57 5d 00 00 00 00  B.........W]....<font></font>
00000010: e3 00 00 00 00 00 00 00 00 00 00 00 00 09 00 00  ................<font></font>
00000020: 00 40 00 00 00 73 3c 01 00 00 64 00 5a 00 64 01  .@...s&lt;...d.Z.d.<font></font>
00000030: 64 02 6c 01 5a 01 64 01 64 02 6c 02 5a 02 64 01  d.l.Z.d.d.l.Z.d.</code></pre><br>
<p>      <code>uncompyle6</code>:</p><br>
<pre><code class="plaintext hljs">uncompyle6 task.pyc &gt; task.py</code></pre><br>
<p>    ,       <code>BOUNCE = pkgutil.get_data('this', 'key')</code>.   ,    <code>BOUNCE</code>   <code>key</code>  .   ,     <code>LOADING...</code>.   ,    - ,  .     <code>Python</code>-.      :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">256</span>):
    <span class="hljs-keyword">try</span>:<font></font>
        print(lzma.decompress(fire(eye(__doc__.encode()), bytes([i]) + BOUNCE)))<font></font>
    <span class="hljs-keyword">except</span> Exception:
        <span class="hljs-keyword">pass</span></code></pre><br>
<p> ,   <code>print</code>      <code>exec</code>,       <code>__doc__.encode()</code> —    .       <code>print</code>       <code>print</code>   <code>try-except</code>.         . ,   <code>__doc__</code>   .    <code>__doc__</code>      :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> marshal<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">'pycode1'</span>, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> inp:<font></font>
    data = inp.read()<font></font>
    code = marshal.loads(data)<font></font>
    doc = code.co_consts[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">with</span> open(<span class="hljs-string">'doc.txt'</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> outp:<font></font>
        outp.write(doc)</code></pre><br>
<p>   ,   <code>__doc__</code>.  ,    <code>i</code>,     .       .   <code>wrong</code>    :</p><br>
<pre><code class="python hljs">trust = windll.kernel32.GetModuleHandleW(<span class="hljs-literal">None</span>)</code></pre><br>
<p>         ,         .      <code>0x100000</code>            <code>wrong</code>,        .          ,     .</p><br>
<p>        .    <code>z3</code>:</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> stage2 <span class="hljs-keyword">import</span> wrong<font></font>
<font></font>
xor = [<span class="hljs-number">212</span>, <span class="hljs-number">162</span>, <span class="hljs-number">242</span>, <span class="hljs-number">218</span>, <span class="hljs-number">101</span>, <span class="hljs-number">109</span>, <span class="hljs-number">50</span>, <span class="hljs-number">31</span>, <span class="hljs-number">125</span>, <span class="hljs-number">112</span>, <span class="hljs-number">249</span>, <span class="hljs-number">83</span>, <span class="hljs-number">55</span>, <span class="hljs-number">187</span>, <span class="hljs-number">131</span>, <span class="hljs-number">206</span>]<font></font>
h = list(wrong())<font></font>
h = [h[i] ^ xor[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>)]<font></font>
b = <span class="hljs-number">16</span> * [<span class="hljs-literal">None</span>]<font></font>
<font></font>
x = []<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):<font></font>
    x.append(BitVec(<span class="hljs-string">'x'</span> + str(i), <span class="hljs-number">32</span>))<font></font>
<font></font>
b[<span class="hljs-number">0</span>] = x[<span class="hljs-number">2</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">4</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">14</span>]<font></font>
b[<span class="hljs-number">1</span>] = x[<span class="hljs-number">0</span>] ^ x[<span class="hljs-number">1</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">14</span>]<font></font>
b[<span class="hljs-number">2</span>] = x[<span class="hljs-number">0</span>] ^ x[<span class="hljs-number">1</span>] ^ x[<span class="hljs-number">2</span>] ^ x[<span class="hljs-number">4</span>] ^ x[<span class="hljs-number">5</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">9</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">14</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">3</span>] = x[<span class="hljs-number">5</span>] ^ x[<span class="hljs-number">6</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">9</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">12</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">4</span>] = x[<span class="hljs-number">1</span>] ^ x[<span class="hljs-number">6</span>] ^ x[<span class="hljs-number">7</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">12</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">14</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">5</span>] = x[<span class="hljs-number">0</span>] ^ x[<span class="hljs-number">4</span>] ^ x[<span class="hljs-number">7</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">9</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">12</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">14</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">6</span>] = x[<span class="hljs-number">1</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">7</span>] ^ x[<span class="hljs-number">9</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">12</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">7</span>] = x[<span class="hljs-number">0</span>] ^ x[<span class="hljs-number">1</span>] ^ x[<span class="hljs-number">2</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">4</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">14</span>]<font></font>
b[<span class="hljs-number">8</span>] = x[<span class="hljs-number">1</span>] ^ x[<span class="hljs-number">2</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">5</span>] ^ x[<span class="hljs-number">9</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">12</span>]<font></font>
b[<span class="hljs-number">9</span>] = x[<span class="hljs-number">6</span>] ^ x[<span class="hljs-number">7</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">12</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">10</span>] = x[<span class="hljs-number">0</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">4</span>] ^ x[<span class="hljs-number">7</span>] ^ x[<span class="hljs-number">8</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">12</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">14</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">11</span>] = x[<span class="hljs-number">0</span>] ^ x[<span class="hljs-number">2</span>] ^ x[<span class="hljs-number">4</span>] ^ x[<span class="hljs-number">6</span>] ^ x[<span class="hljs-number">13</span>]<font></font>
b[<span class="hljs-number">12</span>] = x[<span class="hljs-number">0</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">6</span>] ^ x[<span class="hljs-number">7</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">12</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">13</span>] = x[<span class="hljs-number">2</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">4</span>] ^ x[<span class="hljs-number">5</span>] ^ x[<span class="hljs-number">6</span>] ^ x[<span class="hljs-number">7</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">12</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">14</span>]<font></font>
b[<span class="hljs-number">14</span>] = x[<span class="hljs-number">1</span>] ^ x[<span class="hljs-number">2</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">5</span>] ^ x[<span class="hljs-number">7</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">14</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
b[<span class="hljs-number">15</span>] = x[<span class="hljs-number">1</span>] ^ x[<span class="hljs-number">3</span>] ^ x[<span class="hljs-number">5</span>] ^ x[<span class="hljs-number">9</span>] ^ x[<span class="hljs-number">10</span>] ^ x[<span class="hljs-number">11</span>] ^ x[<span class="hljs-number">13</span>] ^ x[<span class="hljs-number">15</span>]<font></font>
<font></font>
solver = Solver()<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):<font></font>
    solver.add(x[i] &lt; <span class="hljs-number">128</span>)<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">16</span>):<font></font>
    solver.add(b[i] == h[i])<font></font>
<font></font>
<span class="hljs-keyword">if</span> solver.check() == sat:<font></font>
    m = solver.model()<font></font>
    print(bytes([m[i].as_long() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> x]))
<span class="hljs-keyword">else</span>:<font></font>
    print(<span class="hljs-string">'unsat'</span>)</code></pre><br>
<p>  ,    : <code>5C0G7TY2LWI2YXMB</code></p><br>
<p><img src="https://habrastorage.org/webt/yp/ox/jh/ypoxjh3rafci2a5-ukpy2uvbgu0.png"></p><br>
<a name="task08"></a><br>
<h2 id="0x08---snake">0x08 — snake</h2><br>
<blockquote>The Flare team is attempting to pivot to full-time twitch streaming video games instead of reverse engineering computer software all day. We wrote our own classic NES game to stream content that nobody else has seen and watch those subscribers flow in. It turned out to be too hard for us to beat so we gave up. See if you can beat it and capture the internet points that we failed to collect.</blockquote><p>   <code>NES</code>- .       <code>FCEUX</code>, ..      .  ,   .</p><br>
<p><img src="https://habrastorage.org/webt/tk/fx/sq/tkfxsqug4puqwqs893v5zceereg.png"></p><br>
<p> ,  ,     <code>0x25</code>    .    ,   .     <code>NES</code>-  <code>IDA</code>.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">inesldr</a>.     <code>0x25</code>.   <code>C82A</code>    ,           .      <code>0x33</code>.</p><br>
<p><img src="https://habrastorage.org/webt/uo/2b/h8/uo2bh8iawskqdff-153-964ljwq.png"></p><br>
<p>,     —   <code>0x32</code>   <code>0x25</code>       .     ,    .  , <code>FCEUX</code>    .          .</p><br>
<p><img src="https://habrastorage.org/webt/jn/nu/jh/jnnujhs5-fugmpqugrp1z9m7p0o.png"></p><br>
<a name="task09"></a><br>
<h2 id="0x09---reloadered">0x09 — reloadered</h2><br>
<blockquote>This is a simple challenge, enter the password, receive the key. I hear that it caused problems when trying to analyze it with ghidra. Remember that valid flare-on flags will always end with @flare-on.com</blockquote><p>     <code>reloaderd.exe</code>,     .    ,     ,     .     ,       ,         <code>XOR</code>    ,     <code>@FLAG.com</code>,     .</p><br>
<p><img src="https://habrastorage.org/webt/ki/ug/mv/kiugmvs_ouxbeziqmqnzjhxgqmu.png"></p><br>
<p>        ,   <code>NOP</code>.          ,     ,   .          .   ,     .    ,      ,       .   ,      ,     <code>NOP</code>,      .</p><br>
<p>       ,      ,      <code>XOR</code>  ,  .      <code>@flare-on.com</code>,    .            :</p><br>
<pre><code class="python hljs">flag = bytearray(<span class="hljs-string">b'D)6\n)\x0f\x05\x1be&amp;\x10\x04+h0/\x003/\x05\x1a\x1f\x0f8\x02\x18B\x023\x1a(\x04*G?\x04&amp;dfM\x107&gt;(&gt;w\x1c?~64*\x00'</span>)<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">0x539</span>):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">0x34</span>):
        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">3</span>) == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (i % <span class="hljs-number">7</span>) == <span class="hljs-number">0</span>:<font></font>
            flag[j] ^= (i &amp; <span class="hljs-number">0xff</span>)<font></font>
<font></font>
end = <span class="hljs-string">b'@flare-on.com'</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">xor</span>(<span class="hljs-params">a, b</span>):</span>
    <span class="hljs-keyword">return</span> bytes([i^j <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> zip(a, b)])<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(flag)):<font></font>
    print(i, xor(end, flag[i:]))<font></font>
<font></font>
print(xor(flag, <span class="hljs-string">b'3HeadedMonkey'</span>*<span class="hljs-number">4</span>))</code></pre><br>
<p><img src="https://habrastorage.org/webt/th/qz/9b/thqz9bwdjdkt-a7smd_tb8uncxs.png"></p><br>
<a name="task10"></a><br>
<h2 id="0x0a---mugatu">0x0A — Mugatu</h2><br>
<blockquote>Hello,<br>
<br>
I’m working an incident response case for Derek Zoolander. He clicked a link and was infected with MugatuWare! As a result, his new headshot compilation GIF was encrypted.<br>
<br>
To secure an upcoming runway show, Derek needs this GIF decrypted; however, he refuses to pay the ransom.<br>
<br>
We received an additional encrypted GIF from an anonymous informant. The informant told us the GIF should help in our decryption efforts, but we were unable to figure it out.<br>
<br>
We’re reaching out to you, our best malware analyst, in hopes that you can reverse engineer this malware and decrypt Derek’s GIF.<br>
<br>
I've included a directory full of files containing:<br>
<ul>
<li>MugatuWare malware</li>
<li>Ransom note (GIFtToDerek.txt)</li>
<li>Encrypted headshot GIF (best.gif.Mugatu)</li>
<li>Encrypted informant GIF (the_key_to_success_0000.gif.Mugatu)</li>
</ul><br>
<br>
Thanks,<br>
Roy</blockquote><p>    :</p><br>
<ul>
<li>best.gif.Mugatu</li>
<li>GIFtToDerek.txt</li>
<li>Mugatuware.exe</li>
<li>the_key_to_success_0000.gif.Mugatu</li>
</ul><br>
<p>  ,    ,   <code>GIF</code>-. ,      <code>.Mugatu</code>.      <code>Mugatuware.exe</code>. ,     —           .    ,      ,   .</p><br>
<p><img src="https://habrastorage.org/webt/no/au/se/noauseew8d2jezeoaqj9kd-pp9e.png"></p><br>
<p>       <code>IDA</code>,     :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> ida_segment
<span class="hljs-keyword">import</span> ida_name
<span class="hljs-keyword">import</span> ida_bytes
<span class="hljs-keyword">import</span> ida_typeinf<font></font>
<font></font>
idata = ida_segment.get_segm_by_name(<span class="hljs-string">'.idata'</span>)<font></font>
<font></font>
type_map = {}<font></font>
<font></font>
<span class="hljs-keyword">for</span> addr <span class="hljs-keyword">in</span> range(idata.start_ea, idata.end_ea, <span class="hljs-number">4</span>):<font></font>
    name = ida_name.get_name(addr)<font></font>
    <span class="hljs-keyword">if</span> name:<font></font>
        tp = ida_typeinf.idc_get_type(addr)<font></font>
        <span class="hljs-keyword">if</span> tp:<font></font>
            type_map[name] = tp<font></font>
<font></font>
<span class="hljs-keyword">for</span> addr <span class="hljs-keyword">in</span> range(idata.start_ea, idata.end_ea, <span class="hljs-number">4</span>):<font></font>
    imp = ida_bytes.get_dword(addr)<font></font>
    <span class="hljs-keyword">if</span> imp != <span class="hljs-number">0</span>:<font></font>
        imp_name = ida_name.get_name(imp)<font></font>
        name_part = imp_name.split(<span class="hljs-string">'_'</span>)[<span class="hljs-number">-1</span>]<font></font>
        ida_name.set_name(addr, name_part + <span class="hljs-string">'_imp'</span>)
        <span class="hljs-keyword">if</span> name_part <span class="hljs-keyword">in</span> type_map:<font></font>
            tp = type_map[name_part]<font></font>
            ida_typeinf.apply_decl(addr, tp.replace(<span class="hljs-string">'('</span>, <span class="hljs-string">'func('</span>) + <span class="hljs-string">';'</span>)</code></pre><br>
<p>       :</p><br>
<p><img src="https://habrastorage.org/webt/f-/cl/ad/f-cladmcmadtfx1v9bdhjhobt28.png"></p><br>
<p>  ,        ,     <code>in-memory</code>  <code>PE</code>-.           ,        <code>CrazyPills!!!</code>.     ,      .       <code>Sleep</code>,      <code>http</code>-.    ,     ,      ,        .   ,          ,    ,     .    .</p><br>
<p><img src="https://habrastorage.org/webt/np/pq/5q/nppq5qbcpyirk9xgamtl0wh89h0.png"></p><br>
<p> -         :</p><br>
<ul>
<li>        ;</li>
<li>  ;</li>
<li>          <code>Mailslots</code>;</li>
<li>       <code>really, really, really, ridiculously good looking gifs</code>;</li>
<li>        <code>.gif</code>.      <code>.Mugatu</code>.      <code>GIFtToDerek.txt</code>   .</li>
</ul><br>
<p> ,   — 8 .          <code>XOR</code>     <code>CrazyPills!!!</code>,        .  ,        :</p><br>
<p><img src="https://habrastorage.org/webt/bm/em/6u/bmem6uqdty4xdugfaxuz0j9efuw.png"></p><br>
<p>    <code>XTEA</code>,    —     <code>BYTE</code>,    <code>DWORD</code>.           .         <code>Python</code>:</p><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">crypt</span>(<span class="hljs-params">a, b, key</span>):</span>
    i = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">32</span>):<font></font>
        t = (i + key[i &amp; <span class="hljs-number">3</span>]) &amp; <span class="hljs-number">0xffffffff</span>
        a = (a + (t ^ (b + ((b &gt;&gt; <span class="hljs-number">5</span>) ^ (b &lt;&lt; <span class="hljs-number">4</span>))))) &amp; <span class="hljs-number">0xffffffff</span><font></font>
<font></font>
        i = (<span class="hljs-number">0x100000000</span> + i - <span class="hljs-number">0x61C88647</span>) &amp; <span class="hljs-number">0xffffffff</span><font></font>
<font></font>
        t = (i + key[(i &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>]) &amp; <span class="hljs-number">0xffffffff</span>
        b = (b + (t ^ (a + ((a &gt;&gt; <span class="hljs-number">5</span>) ^ (a &lt;&lt; <span class="hljs-number">4</span>))))) &amp; <span class="hljs-number">0xffffffff</span>
    <span class="hljs-keyword">return</span> a, b<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt</span>(<span class="hljs-params">a, b, key</span>):</span>
    i = <span class="hljs-number">0xc6ef3720</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(<span class="hljs-number">32</span>):<font></font>
        t = (i + key[(i &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>]) &amp; <span class="hljs-number">0xffffffff</span>
        b = (<span class="hljs-number">0x100000000</span> + b - (t ^ (a + ((a &gt;&gt; <span class="hljs-number">5</span>) ^ (a &lt;&lt; <span class="hljs-number">4</span>))))) &amp; <span class="hljs-number">0xffffffff</span><font></font>
<font></font>
        i = (i + <span class="hljs-number">0x61C88647</span>) &amp; <span class="hljs-number">0xffffffff</span><font></font>
<font></font>
        t = (i + key[i &amp; <span class="hljs-number">3</span>]) &amp; <span class="hljs-number">0xffffffff</span>
        a = (<span class="hljs-number">0x100000000</span> + a - (t ^ (b + ((b &gt;&gt; <span class="hljs-number">5</span>) ^ (b &lt;&lt; <span class="hljs-number">4</span>))))) &amp; <span class="hljs-number">0xffffffff</span>
    <span class="hljs-keyword">return</span> a, b
</code></pre><br>
<p> ,  <code>the_key_to_success_0000.gif.Mugatu</code>     .        ,     .     :</p><br>
<p><img src="https://habrastorage.org/webt/lm/bb/jl/lmbbjl90qtlexwxwtywt6wbh09i.gif"></p><br>
<p> ,        ,        .        <code>C</code>.     <code>GIF</code>-.</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">decrypt</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> * inp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> * outp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> * key)</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> i = <span class="hljs-number">0xc6ef3720</span>;<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> a = inp[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> b = inp[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> t;<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">32</span>; j++)<font></font>
    {<font></font>
        t = i + key[(i &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>];<font></font>
        b -= t ^ (a + ((a &gt;&gt; <span class="hljs-number">5</span>) ^ (a &lt;&lt; <span class="hljs-number">4</span>)));<font></font>
<font></font>
        i += <span class="hljs-number">0x61C88647</span>;<font></font>
<font></font>
        t = i + key[i &amp; <span class="hljs-number">3</span>];<font></font>
        a -= t ^ (b + ((b &gt;&gt; <span class="hljs-number">5</span>) ^ (b &lt;&lt; <span class="hljs-number">4</span>)));<font></font>
    }<font></font>
<font></font>
    outp[<span class="hljs-number">0</span>] = a;<font></font>
    outp[<span class="hljs-number">1</span>] = b;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">int</span> fd = open(<span class="hljs-string">"best.gif.Mugatu"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> inp[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> outp[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> key = <span class="hljs-number">0</span>;<font></font>
    read(fd, inp, <span class="hljs-number">8</span>);<font></font>
    close(fd);<font></font>
<font></font>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> key = <span class="hljs-number">0</span>; key &lt; <span class="hljs-number">0x100000000</span>; key++)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span>((key &amp; <span class="hljs-number">0xffffff</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%lf\n"</span>, ((<span class="hljs-keyword">double</span>)key) / ((<span class="hljs-keyword">double</span>)<span class="hljs-number">0x100000000</span>) * <span class="hljs-number">100.0</span>);<font></font>
        }<font></font>
        decrypt(inp, outp, &amp;key);<font></font>
        <span class="hljs-keyword">if</span>( ((<span class="hljs-keyword">char</span> *)outp)[<span class="hljs-number">0</span>] == <span class="hljs-string">'G'</span> &amp;&amp;<font></font>
            ((<span class="hljs-keyword">char</span> *)outp)[<span class="hljs-number">1</span>] == <span class="hljs-string">'I'</span> &amp;&amp;<font></font>
            ((<span class="hljs-keyword">char</span> *)outp)[<span class="hljs-number">2</span>] == <span class="hljs-string">'F'</span> &amp;&amp;<font></font>
            ((<span class="hljs-keyword">char</span> *)outp)[<span class="hljs-number">5</span>] == <span class="hljs-string">'a'</span>)<font></font>
        {<font></font>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%#llx\n"</span>, key);<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<p>       <code>0xb1357331</code>      :</p><br>
<p><img src="https://habrastorage.org/webt/cw/s5/fz/cws5fzu68wbv5mf-myteh-o8uqk.gif"></p><br>
<a name="task11"></a><br>
<h2 id="0x0b---vv_max">0x0B — vv_max</h2><br>
<blockquote>Hey, at least its not subleq.</blockquote><p>    <code>vv_max.exe</code>,      .          256-     .       <code>AVX2</code> ,   <code>vpermd</code>, <code>vpslld</code>  .    -    :</p><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><pre><code class="plaintext hljs">0000    clear_regs<font></font>
0001    r0 = 393130324552414c46<font></font>
0023    r1 = 3030303030303030303030303030303030303030303030303030303030303030<font></font>
0045    r3 = 1a1b1b1b1a13111111111111111111151a1b1b1b1a1311111111111111111115<font></font>
0067    r4 = 1010101010101010080408040201101010101010101010100804080402011010<font></font>
0089    r5 = b9b9bfbf041310000000000000000000b9b9bfbf04131000<font></font>
00ab    r6 = 2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f<font></font>
00cd    r10 = 140014001400140014001400140014001400140014001400140014001400140<font></font>
00ef    r11 = 1100000011000000110000001100000011000000110000001100000011000<font></font>
0111    r12 = ffffffff0c0d0e08090a040506000102ffffffff0c0d0e08090a040506000102<font></font>
0133    r13 = ffffffffffffffff000000060000000500000004000000020000000100000000<font></font>
0155    r16 = ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff<font></font>
0177    r17 = 6a09e667bb67ae853c6ef372a54ff53a510e527f9b05688c1f83d9ab5be0cd19<font></font>
0199    r18 = 428a2f9871374491b5c0fbcfe9b5dba53956c25b59f111f1923f82a4ab1c5ed5<font></font>
01bb    r19 = 300000002000000010000000000000007000000060000000500000004<font></font>
01dd    r20 = 0<font></font>
01ff    r21 = 100000001000000010000000100000001000000010000000100000001<font></font>
0221    r22 = 200000002000000020000000200000002000000020000000200000002<font></font>
0243    r23 = 300000003000000030000000300000003000000030000000300000003<font></font>
0265    r24 = 400000004000000040000000400000004000000040000000400000004<font></font>
0287    r25 = 500000005000000050000000500000005000000050000000500000005<font></font>
02a9    r26 = 600000006000000060000000600000006000000060000000600000006<font></font>
02cb    r27 = 700000007000000070000000700000007000000070000000700000007<font></font>
02ed    r20 = vpermd(r0, r20)<font></font>
02f1    r21 = vpermd(r0, r21)<font></font>
02f5    r22 = vpermd(r0, r22)<font></font>
02f9    r23 = vpermd(r0, r23)<font></font>
02fd    r24 = vpermd(r0, r24)<font></font>
0301    r25 = vpermd(r0, r25)<font></font>
0305    r26 = vpermd(r0, r26)<font></font>
0309    r27 = vpermd(r0, r27)<font></font>
030d    r7 = vpsrld(r1, 4)<font></font>
0311    r28 = r20 ^ r21<font></font>
0315    r28 = r28 ^ r22<font></font>
0319    r28 = r28 ^ r23<font></font>
031d    r28 = r28 ^ r24<font></font>
0321    r28 = r28 ^ r25<font></font>
0325    r28 = r28 ^ r26<font></font>
0329    r28 = r28 ^ r27<font></font>
032d    r7 = r7 &amp; r6<font></font>
0331    r29 = vpslld(r17, 7)<font></font>
0335    r30 = vpsrld(r17, 25)<font></font>
0339    r15 = r29 | r30<font></font>
033d    r8 = vpcmpeqb(r1, r6)<font></font>
0341    r29 = vpslld(r17, 21)<font></font>
0345    r30 = vpsrld(r17, 11)<font></font>
0349    r29 = r29 | r30<font></font>
034d    r15 = r15 ^ r29<font></font>
0351    r8 = vpcmpeqb(r1, r6)<font></font>
0355    r29 = vpslld(r17, 26)<font></font>
0359    r30 = vpsrld(r17, 6)<font></font>
035d    r29 = r29 | r30<font></font>
0361    r15 = r15 ^ r29<font></font>
0365    r29 = r20 ^ r16<font></font>
0369    r30 = r20 &amp; r18<font></font>
036d    r29 = r29 ^ r30<font></font>
0371    r15 = add_d(r29, r15)<font></font>
0375    r20 = add_d(r15, r0)<font></font>
0379    r7 = add_b(r8, r7)<font></font>
037d    r29 = r20 ^ r28<font></font>
0381    r17 = vpermd(r29, r19)<font></font>
0385    r7 = vpshufb(r5, r7)<font></font>
0389    r29 = vpslld(r17, 7)<font></font>
038d    r30 = vpsrld(r17, 25)<font></font>
0391    r15 = r29 | r30<font></font>
0395    r29 = vpslld(r17, 21)<font></font>
0399    r30 = vpsrld(r17, 11)<font></font>
039d    r29 = r29 | r30<font></font>
03a1    r15 = r15 ^ r29<font></font>
03a5    r29 = vpslld(r17, 26)<font></font>
03a9    r30 = vpsrld(r17, 6)<font></font>
03ad    r29 = r29 | r30<font></font>
03b1    r15 = r15 ^ r29<font></font>
03b5    r2 = add_b(r1, r7)<font></font>
03b9    r29 = r21 ^ r16<font></font>
03bd    r30 = r21 &amp; r18<font></font>
03c1    r29 = r29 ^ r30<font></font>
03c5    r15 = add_d(r29, r15)<font></font>
03c9    r21 = add_d(r15, r0)<font></font>
03cd    r29 = r21 ^ r28<font></font>
03d1    r17 = vpermd(r29, r19)<font></font>
03d5    r20 = r20 ^ r21<font></font>
03d9    r29 = vpslld(r17, 7)<font></font>
03dd    r30 = vpsrld(r17, 25)<font></font>
03e1    r15 = r29 | r30<font></font>
03e5    r29 = vpslld(r17, 21)<font></font>
03e9    r30 = vpsrld(r17, 11)<font></font>
03ed    r29 = r29 | r30<font></font>
03f1    r15 = r15 ^ r29<font></font>
03f5    r29 = vpslld(r17, 26)<font></font>
03f9    r30 = vpsrld(r17, 6)<font></font>
03fd    r29 = r29 | r30<font></font>
0401    r15 = r15 ^ r29<font></font>
0405    r7 = vpmaddubsw(r2, r10)<font></font>
0409    r29 = r22 ^ r16<font></font>
040d    r30 = r22 &amp; r18<font></font>
0411    r29 = r29 ^ r30<font></font>
0415    r15 = add_d(r29, r15)<font></font>
0419    r22 = add_d(r15, r0)<font></font>
041d    r29 = r22 ^ r28<font></font>
0421    r17 = vpermd(r29, r19)<font></font>
0425    r20 = r20 ^ r22<font></font>
0429    r29 = vpslld(r17, 7)<font></font>
042d    r30 = vpsrld(r17, 25)<font></font>
0431    r15 = r29 | r30<font></font>
0435    r29 = vpslld(r17, 21)<font></font>
0439    r30 = vpsrld(r17, 11)<font></font>
043d    r29 = r29 | r30<font></font>
0441    r15 = r15 ^ r29<font></font>
0445    r29 = vpslld(r17, 26)<font></font>
0449    r30 = vpsrld(r17, 6)<font></font>
044d    r29 = r29 | r30<font></font>
0451    r15 = r15 ^ r29<font></font>
0455    r2 = vpmaddwd(r7, r11)<font></font>
0459    r29 = r23 ^ r16<font></font>
045d    r30 = r23 &amp; r18<font></font>
0461    r29 = r29 ^ r30<font></font>
0465    r15 = add_d(r29, r15)<font></font>
0469    r23 = add_d(r15, r0)<font></font>
046d    r29 = r23 ^ r28<font></font>
0471    r17 = vpermd(r29, r19)<font></font>
0475    r20 = r20 ^ r23<font></font>
0479    r29 = vpslld(r17, 7)<font></font>
047d    r30 = vpsrld(r17, 25)<font></font>
0481    r15 = r29 | r30<font></font>
0485    r29 = vpslld(r17, 21)<font></font>
0489    r30 = vpsrld(r17, 11)<font></font>
048d    r29 = r29 | r30<font></font>
0491    r15 = r15 ^ r29<font></font>
0495    r29 = vpslld(r17, 26)<font></font>
0499    r30 = vpsrld(r17, 6)<font></font>
049d    r29 = r29 | r30<font></font>
04a1    r15 = r15 ^ r29<font></font>
04a5    r29 = r24 ^ r16<font></font>
04a9    r30 = r24 &amp; r18<font></font>
04ad    r29 = r29 ^ r30<font></font>
04b1    r15 = add_d(r29, r15)<font></font>
04b5    r24 = add_d(r15, r0)<font></font>
04b9    r29 = r24 ^ r28<font></font>
04bd    r17 = vpermd(r29, r19)<font></font>
04c1    r20 = r20 ^ r24<font></font>
04c5    r29 = vpslld(r17, 7)<font></font>
04c9    r30 = vpsrld(r17, 25)<font></font>
04cd    r15 = r29 | r30<font></font>
04d1    r29 = vpslld(r17, 21)<font></font>
04d5    r30 = vpsrld(r17, 11)<font></font>
04d9    r29 = r29 | r30<font></font>
04dd    r15 = r15 ^ r29<font></font>
04e1    r29 = vpslld(r17, 26)<font></font>
04e5    r30 = vpsrld(r17, 6)<font></font>
04e9    r29 = r29 | r30<font></font>
04ed    r15 = r15 ^ r29<font></font>
04f1    r29 = r25 ^ r16<font></font>
04f5    r30 = r25 &amp; r18<font></font>
04f9    r29 = r29 ^ r30<font></font>
04fd    r15 = add_d(r29, r15)<font></font>
0501    r25 = add_d(r15, r0)<font></font>
0505    r29 = r25 ^ r28<font></font>
0509    r17 = vpermd(r29, r19)<font></font>
050d    r20 = r20 ^ r25<font></font>
0511    r2 = vpshufb(r2, r12)<font></font>
0515    r29 = vpslld(r17, 7)<font></font>
0519    r30 = vpsrld(r17, 25)<font></font>
051d    r15 = r29 | r30<font></font>
0521    r29 = vpslld(r17, 21)<font></font>
0525    r30 = vpsrld(r17, 11)<font></font>
0529    r29 = r29 | r30<font></font>
052d    r15 = r15 ^ r29<font></font>
0531    r29 = vpslld(r17, 26)<font></font>
0535    r30 = vpsrld(r17, 6)<font></font>
0539    r29 = r29 | r30<font></font>
053d    r15 = r15 ^ r29<font></font>
0541    r29 = r26 ^ r16<font></font>
0545    r30 = r26 &amp; r18<font></font>
0549    r29 = r29 ^ r30<font></font>
054d    r15 = add_d(r29, r15)<font></font>
0551    r26 = add_d(r15, r0)<font></font>
0555    r29 = r26 ^ r28<font></font>
0559    r17 = vpermd(r29, r19)<font></font>
055d    r20 = r20 ^ r26<font></font>
0561    r29 = vpslld(r17, 7)<font></font>
0565    r30 = vpsrld(r17, 25)<font></font>
0569    r15 = r29 | r30<font></font>
056d    r29 = vpslld(r17, 21)<font></font>
0571    r30 = vpsrld(r17, 11)<font></font>
0575    r29 = r29 | r30<font></font>
0579    r15 = r15 ^ r29<font></font>
057d    r29 = vpslld(r17, 26)<font></font>
0581    r30 = vpsrld(r17, 6)<font></font>
0585    r29 = r29 | r30<font></font>
0589    r15 = r15 ^ r29<font></font>
058d    r2 = vpermd(r2, r13)<font></font>
0591    r29 = r27 ^ r16<font></font>
0595    r30 = r27 &amp; r18<font></font>
0599    r29 = r29 ^ r30<font></font>
059d    r15 = add_d(r29, r15)<font></font>
05a1    r27 = add_d(r15, r0)<font></font>
05a5    r29 = r27 ^ r28<font></font>
05a9    r17 = vpermd(r29, r19)<font></font>
05ad    r20 = r20 ^ r27<font></font>
05b1    r19 = ffffffffffffffffffffffffffffffffffffffffffffffff<font></font>
05d3    r20 = r20 &amp; r19<font></font>
05d7    r31 = 2176620c3a5c0f290b583618734f07102e332623780e59150c05172d4b1b1e22</code></pre></div></div><br>
<p>            <code>FLARE2019</code>.        ,     ,    .  ,      <code>FLARE2019</code>.    <code>r2</code>  <code>r20</code>.     ,   <code>r20</code>      .     <code>r2</code>  —      6  <code>r2</code>.           ,   6       .     <code>Frida</code>:</p><br>
<pre><code class="python hljs"><span class="hljs-comment"># vvmax.py</span>
<span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function
<span class="hljs-keyword">import</span> frida
<span class="hljs-keyword">import</span> string
<span class="hljs-keyword">import</span> hexdump<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check</span>(<span class="hljs-params">val</span>):</span>
    <span class="hljs-keyword">global</span> gdata
    <span class="hljs-keyword">with</span> open(<span class="hljs-string">'vvmax.js'</span>, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:<font></font>
        script_src = f.read()<font></font>
<font></font>
    pid = frida.spawn([<span class="hljs-string">'vv_max.exe'</span>, <span class="hljs-string">'FLARE2019'</span>, val.ljust(<span class="hljs-number">32</span>, <span class="hljs-string">'a'</span>)])<font></font>
<font></font>
    session = frida.attach(pid)<font></font>
    script = session.create_script(script_src)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handler</span>(<span class="hljs-params">message, data</span>):</span><font></font>
        handler.data = data<font></font>
<font></font>
    script.on(<span class="hljs-string">'message'</span>, handler)<font></font>
<font></font>
    script.load()<font></font>
<font></font>
    frida.resume(pid)<font></font>
<font></font>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> hasattr(handler, <span class="hljs-string">'data'</span>):
        <span class="hljs-keyword">pass</span><font></font>
<font></font>
    session.detach()<font></font>
    <span class="hljs-keyword">return</span> handler.data<font></font>
<font></font>
alph = string.printable<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">to_bits</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join(bin(ord(i))[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">8</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> x)<font></font>
<font></font>
target = to_bits(<span class="hljs-string">'pp\xb2\xac\x01\xd2^a\n\xa7*\xa8\x08\x1c\x86\x1a\xe8E\xc8)\xb2\xf3\xa1\x1e\x00\x00\x00\x00\x00\x00\x00\x00'</span>)<font></font>
password = <span class="hljs-string">''</span><font></font>
<font></font>
<span class="hljs-keyword">while</span> len(password) != <span class="hljs-number">32</span>:
    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> alph:<font></font>
        data = to_bits(check(password + c))<font></font>
        i = <span class="hljs-number">6</span>*len(password + c)
        <span class="hljs-keyword">if</span> data[:i] == target[:i]:<font></font>
            password += c<font></font>
            i += <span class="hljs-number">1</span>
            <span class="hljs-keyword">break</span><font></font>
    print()<font></font>
    print(<span class="hljs-string">'-----&gt;'</span>, `password`)<font></font>
    print()</code></pre><br>
<pre><code class="plaintext hljs">// vvmax.js<font></font>
var modules = Process.enumerateModules();<font></font>
var base = modules[0].base;<font></font>
<font></font>
Interceptor.attach(base.add(0x1665), function() {<font></font>
    var p = this.context.rdx.add(0x840);<font></font>
    var res = p.readByteArray(32);<font></font>
    send(null, res);<font></font>
});</code></pre><br>
<p>       :</p><br>
<p><img src="https://habrastorage.org/webt/wo/d7/xp/wod7xpefz_k328dmgnuvnmy7ifi.png"></p><br>
<a name="task12"></a><br>
<h2 id="0x0c---help">0x0C — help</h2><br>
<blockquote>You're my only hope FLARE-On player! One of our developers was hacked and we're not sure what they took. We managed to set up a packet capture on the network once we found out but they were definitely already on the system. I think whatever they installed must be buggy — it looks like they crashed our developer box. We saved off the dump file but I can't make heads or tails of it — PLEASE HELP!!!!!!</blockquote><p>      .      <code>RAM</code>-    .       <code>4444</code>, <code>6666</code>, <code>7777</code>  <code>8888</code>.   ,   , ,    <code>RAM</code>-.      <code>volatility</code>.           <code>volatility</code>   <code>Win10x64_15063</code>,    ,     <code>Win7SP1x64</code>,        .</p><br>
<p>     <code>volatility</code>       :</p><br>
<pre><code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp modules<font></font>
Volatility Foundation Volatility Framework 2.6<font></font>
Offset(V)          Name                 Base                             Size File<font></font>
------------------ -------------------- ------------------ ------------------ ----<font></font>
0xfffffa800183e890 ntoskrnl.exe         0xfffff80002a49000           0x5e7000 \SystemRoot\system32\ntoskrnl.exe<font></font>
<font></font>
...<font></font>
0xfffffa800428ff30 man.sys              0xfffff880033bc000             0xf000 \??\C:\Users\FLARE ON 2019\Desktop\man.sys</code></pre><br>
<p>    :</p><br>
<pre><code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp moddump --base 0xfffff880033bc000  -D drivers<font></font>
Volatility Foundation Volatility Framework 2.6<font></font>
Module Base        Module Name          Result<font></font>
------------------ -------------------- ------<font></font>
0xfffff880033bc000 man.sys              Error: e_magic 0000 is not a valid DOS signature.</code></pre><br>
<p>,   .       <code>volshell</code>    .</p><br>
<pre><code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp volshell<font></font>
<font></font>
In [1]: db(0xfffff880033bc000)<font></font>
0xfffff880033bc000  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................<font></font>
0xfffff880033bc010  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................<font></font>
0xfffff880033bc020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................<font></font>
0xfffff880033bc030  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................<font></font>
0xfffff880033bc040  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................<font></font>
0xfffff880033bc050  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................<font></font>
0xfffff880033bc060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................<font></font>
0xfffff880033bc070  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................<font></font>
<font></font>
In [2]: db(0xfffff880033bc000 + 0x1100)<font></font>
0xfffff880033bd100  01 48 8b 4c 24 20 48 8b 44 24 28 48 89 41 08 48   .H.L$.H.D$(H.A.H<font></font>
0xfffff880033bd110  83 c4 18 c3 cc cc cc cc cc cc cc cc cc cc cc cc   ................<font></font>
0xfffff880033bd120  48 89 4c 24 08 48 83 ec 38 48 8b 44 24 40 0f be   H.L$.H..8H.D$@..<font></font>
0xfffff880033bd130  48 43 48 8b 44 24 40 0f be 40 42 83 c0 01 3b c8   HCH.D$@..@B...;.<font></font>
0xfffff880033bd140  7e 27 45 33 c9 41 b8 15 5b 00 00 48 8d 15 de 44   ~'E3.A..[..H...D<font></font>
0xfffff880033bd150  00 00 48 8d 0d 07 45 00 00 ff 15 71 4f 00 00 c7   ..H...E....qO...<font></font>
0xfffff880033bd160  44 24 20 00 00 00 00 eb 08 c7 44 24 20 01 00 00   D$........D$....<font></font>
0xfffff880033bd170  00 48 8b 44 24 40 48 8b 80 b8 00 00 00 48 83 c4   .H.D$@H......H..<font></font>
<font></font>
In [4]: man = addrspace().read(0xfffff880033bc000, 0xf000)<font></font>
<font></font>
In [5]: with open('man_writeup.sys', 'wb') as f:<font></font>
   ...:     f.write(man)<font></font>
   ...:</code></pre><br>
<p>,    ,   <code>moddump</code>  .   .      .  -    ,   ,      .</p><br>
<p>          <code>RC4</code>   .          ,        .</p><br>
<p>            <code>user-space</code>.      <code>DLL</code>-   .          <code>DLL</code>- (<code>m.dll</code>),    .         ,                 .          :</p><br>
<ul>
<li>     ( <code>+0x8</code>)</li>
<li>  <code>_EPROCESS</code>   ( <code>+0x68</code>)</li>
<li>    ( <code>+0x48</code>)</li>
<li>  ( <code>+0x58</code>)</li>
</ul><br>
<p> <code>DLL</code>-           <code>RC4</code>,       <code>0x2c</code>-   ,    <code>0x48</code>.</p><br>
<p>     <code>volatility</code>      <code>volshell</code>:</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> ARC4<font></font>
<font></font>
head = <span class="hljs-number">0xfffff880033c8158</span><font></font>
krnl = addrspace()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">u64</span>(<span class="hljs-params">x</span>):</span>
    <span class="hljs-keyword">return</span> struct.unpack(<span class="hljs-string">'Q'</span>, x)[<span class="hljs-number">0</span>]<font></font>
<font></font>
fd = u64(krnl.read(head, <span class="hljs-number">8</span>))
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<font></font>
    proc_addr = u64(krnl.read(fd + <span class="hljs-number">0x68</span>, <span class="hljs-number">8</span>))<font></font>
    base = u64(krnl.read(fd + <span class="hljs-number">0x48</span>, <span class="hljs-number">8</span>))<font></font>
    key = krnl.read(fd + <span class="hljs-number">0x48</span>, <span class="hljs-number">0x2c</span>)<font></font>
    sz = u64(krnl.read(fd + <span class="hljs-number">0x58</span>, <span class="hljs-number">8</span>))<font></font>
    fd = u64(krnl.read(fd, <span class="hljs-number">8</span>))<font></font>
<font></font>
    p = obj.Object(<span class="hljs-string">'_EPROCESS'</span>, proc_addr, krnl)
    <span class="hljs-keyword">print</span> p.ImageFileName.v(), hex(proc_addr), hex(base), hex(sz)<font></font>
<font></font>
    proc_space = p.get_process_address_space()<font></font>
    dump = proc_space.read(base, sz)<font></font>
    <span class="hljs-keyword">if</span> dump[:<span class="hljs-number">0x100</span>] == <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0x100</span>:<font></font>
        dump = ARC4.new(key).decrypt(dump)<font></font>
    <span class="hljs-keyword">with</span> open(<span class="hljs-string">'proc_{:016x}'</span>.format(base), <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
        f.write(dump)<font></font>
<font></font>
    <span class="hljs-keyword">if</span> fd == head:
        <span class="hljs-keyword">break</span></code></pre><br>
<p>  ,  ,            <code>RC4</code>.         <code>IDA</code>,   ,         :</p><br>
<div class="spoiler"><b class="spoiler_title">  IDA</b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">from</span> idaapi <span class="hljs-keyword">import</span> get_func, decompile, get_name_ea, auto_wait, BADADDR
<span class="hljs-keyword">from</span> idaapi <span class="hljs-keyword">import</span> cot_call, cot_obj, init_hexrays_plugin, qexit
<span class="hljs-keyword">import</span> ida_typeinf
<span class="hljs-keyword">import</span> ida_lines<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">rc4</span>(<span class="hljs-params">key, data</span>):</span>
    S = list(range(<span class="hljs-number">256</span>))<font></font>
    j = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> list(range(<span class="hljs-number">256</span>)):<font></font>
        j = (j + S[i] + ord(key[i % len(key)])) % <span class="hljs-number">256</span><font></font>
        S[i], S[j] = S[j], S[i]<font></font>
    j = <span class="hljs-number">0</span>
    y = <span class="hljs-number">0</span><font></font>
    out = []<font></font>
    <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> data:<font></font>
        j = (j + <span class="hljs-number">1</span>) % <span class="hljs-number">256</span>
        y = (y + S[j]) % <span class="hljs-number">256</span><font></font>
        S[j], S[y] = S[y], S[j]<font></font>
        out.append(chr(ord(char) ^ S[(S[j] + S[y]) % <span class="hljs-number">256</span>]))
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join(out)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_stack_str_args</span>(<span class="hljs-params">ea</span>):</span><font></font>
<font></font>
    func = get_func(ea)<font></font>
    <span class="hljs-keyword">if</span> func <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">return</span><font></font>
<font></font>
    <span class="hljs-keyword">try</span>:<font></font>
        c_func = decompile(func)<font></font>
        c_func.pseudocode<font></font>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:
        <span class="hljs-keyword">return</span><font></font>
<font></font>
    <span class="hljs-keyword">for</span> citem <span class="hljs-keyword">in</span> c_func.treeitems:<font></font>
        citem = citem.to_specific_type<font></font>
<font></font>
        <span class="hljs-keyword">if</span> citem.is_expr() <span class="hljs-keyword">and</span>\<font></font>
                citem.op == cot_call <span class="hljs-keyword">and</span>\<font></font>
                citem.ea == ea:<font></font>
<font></font>
            args = []<font></font>
<font></font>
            key = citem.a[<span class="hljs-number">0</span>]<font></font>
            key_len = citem.a[<span class="hljs-number">1</span>]<font></font>
            s = citem.a[<span class="hljs-number">2</span>]<font></font>
            s_len = citem.a[<span class="hljs-number">3</span>]<font></font>
<font></font>
            <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_var_idx</span>(<span class="hljs-params">obj</span>):</span>
                <span class="hljs-keyword">while</span> obj.opname != <span class="hljs-string">'var'</span>:
                    <span class="hljs-keyword">if</span> obj.opname <span class="hljs-keyword">in</span> (<span class="hljs-string">'ref'</span>, <span class="hljs-string">'cast'</span>):<font></font>
                        obj = obj.x<font></font>
                    <span class="hljs-keyword">else</span>:
                        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">'can\'t find type'</span>)
                <span class="hljs-keyword">return</span> obj.v.idx<font></font>
<font></font>
            <span class="hljs-keyword">if</span> key_len.opname != <span class="hljs-string">'num'</span> <span class="hljs-keyword">or</span> s_len.opname != <span class="hljs-string">'num'</span>:<font></font>
                print(<span class="hljs-string">'[!] can\'t get length: 0x{:08x}'</span>.format(ea))
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">try</span>:<font></font>
                    key_len_val = key_len.n._value<font></font>
                    s_len_val = s_len.n._value<font></font>
                    print(<span class="hljs-string">'0x{:08x}'</span>.format(ea),
                        <span class="hljs-string">'key_len ='</span>, key_len_val,
                        <span class="hljs-string">', s_len ='</span>, s_len_val)<font></font>
<font></font>
                    hx_view = idaapi.open_pseudocode(ea, <span class="hljs-number">-1</span>)<font></font>
<font></font>
                    key_var_stkoff = hx_view.cfunc.get_lvars()[get_var_idx(key)].location.stkoff()<font></font>
                    s_var_stkoff = hx_view.cfunc.get_lvars()[get_var_idx(s)].location.stkoff()<font></font>
<font></font>
                    key_var = [v <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> hx_view.cfunc.get_lvars() <span class="hljs-keyword">if</span> v.location.stkoff() == key_var_stkoff][<span class="hljs-number">0</span>]<font></font>
                    tif = ida_typeinf.tinfo_t()<font></font>
                    ida_typeinf.parse_decl(tif, <span class="hljs-literal">None</span>,
                        <span class="hljs-string">'unsigned __int8 [{}];'</span>.format(key_len_val), <span class="hljs-number">0</span>)<font></font>
                    hx_view.set_lvar_type(key_var, tif)<font></font>
<font></font>
                    s_var = [v <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> hx_view.cfunc.get_lvars() <span class="hljs-keyword">if</span> v.location.stkoff() == s_var_stkoff][<span class="hljs-number">0</span>]<font></font>
                    tif = ida_typeinf.tinfo_t()<font></font>
                    ida_typeinf.parse_decl(tif, <span class="hljs-literal">None</span>,
                        <span class="hljs-string">'unsigned __int8 [{}];'</span>.format(s_len_val + <span class="hljs-number">1</span>), <span class="hljs-number">0</span>)<font></font>
                    hx_view.set_lvar_type(s_var, tif)<font></font>
<font></font>
                    key_var = [v <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> hx_view.cfunc.get_lvars() <span class="hljs-keyword">if</span> v.location.stkoff() == key_var_stkoff][<span class="hljs-number">0</span>]<font></font>
                    s_var = [v <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> hx_view.cfunc.get_lvars() <span class="hljs-keyword">if</span> v.location.stkoff() == s_var_stkoff][<span class="hljs-number">0</span>]<font></font>
                    key_regex = re.compile(<span class="hljs-string">'{}\[(.+)\] = (.+);'</span>.format(key_var.name))<font></font>
                    s_regex = re.compile(<span class="hljs-string">'{}\[(.+)\] = (.+);'</span>.format(s_var.name))<font></font>
                    key = bytearray(key_len_val)<font></font>
                    s = bytearray(s_len_val + <span class="hljs-number">1</span>)<font></font>
                    src = <span class="hljs-string">'\n'</span>.join([ida_lines.tag_remove(i.line) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> hx_view.cfunc.pseudocode])
                    <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> s_regex.findall(src):<font></font>
                        s[int(i)] = (<span class="hljs-number">0x100</span> + int(j)) &amp; <span class="hljs-number">0xff</span>
                    <span class="hljs-keyword">for</span> i, j <span class="hljs-keyword">in</span> key_regex.findall(src):<font></font>
                        key[int(i)] = (<span class="hljs-number">0x100</span> + int(j)) &amp; <span class="hljs-number">0xff</span>
                    key = <span class="hljs-string">''</span>.join(chr(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> key)<font></font>
                    s = <span class="hljs-string">''</span>.join(chr(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s)<font></font>
                    result = rc4(key, s[:<span class="hljs-number">-1</span>])
                    <span class="hljs-comment"># unicode to ascii</span>
                    <span class="hljs-keyword">if</span> set(ord(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> result[<span class="hljs-number">1</span>::<span class="hljs-number">2</span>]) == {<span class="hljs-number">0</span>}:<font></font>
                        result = <span class="hljs-string">'wide_'</span> + <span class="hljs-string">''</span>.join(result[<span class="hljs-number">0</span>::<span class="hljs-number">2</span>])<font></font>
                    hx_view.rename_lvar(s_var, <span class="hljs-string">'s_'</span> + result, <span class="hljs-literal">True</span>)<font></font>
<font></font>
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:<font></font>
                    print(<span class="hljs-string">'[!] error: {}'</span>.format(ex))<font></font>
<font></font>
print(<span class="hljs-string">'#### decryption helper script ####'</span>)<font></font>
xref_to = get_name_ea(BADADDR, <span class="hljs-string">'decrypt_stack_str'</span>)<font></font>
xref_from = get_first_cref_to(xref_to)<font></font>
<span class="hljs-keyword">while</span> xref_from != BADADDR:<font></font>
    print(<span class="hljs-string">'### 0x{:08x}'</span>.format(xref_from))<font></font>
    decrypt_stack_str_args(xref_from)<font></font>
    xref_from = get_next_cref_to(xref_to, xref_from)</code></pre></div></div><br>
<p>   :</p><br>
<p><img src="https://habrastorage.org/webt/v9/xx/cg/v9xxcgdktosjrdfyg8ohucbha6g.png"></p><br>
<p>     .       :</p><br>
<ul>
<li><code>m.dll</code> — ,    .   <code>4444</code>   .   —           ;</li>
<li><code>n.dll</code> —         <code>192.168.1.243</code>;</li>
<li><code>c.dll</code> —          <code>RC4</code>.       ;</li>
<li><code>k.dll</code> —            (keylogger);</li>
<li><code>s.dll</code> —       ;</li>
<li><code>f.dll</code> —       .</li>
</ul><br>
<p>     ,       <code>XOR</code>    8.      <code>4444</code>       , ..       .       :    ,       —      . ,   -   .</p><br>
<p>   ( <code>4444</code>)     . ,     -   .       ,      .            :</p><br>
<ul>
<li>keys.kdb</li>
<li>C:\</li>
<li>C:\keypass\keys.kdb</li>
</ul><br>
<p>,        <code>f.dll</code>:       <code>keys.kdb</code>,      .</p><br>
<p>    <code>6666</code>     .      <code>LZNT1</code>     <code>RC4</code>  <code>XOR</code>.   ,  <code>XOR</code>-  , ..       .   <code>RC4</code>    ,     <code>RAM</code>-: <code>FLARE ON 2019</code>.  ,   <code>GetUserNameA</code>,        ,            -   ,      <code>RC4</code>.      <code>LZNT1</code>     :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<font></font>
nt = windll.ntdll<font></font>
<font></font>
<span class="hljs-keyword">for</span> fname <span class="hljs-keyword">in</span> [<span class="hljs-string">'input'</span>]:
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
      buf = f.read()<font></font>
    dec_data = create_string_buffer(<span class="hljs-number">0x10000</span>)<font></font>
    final_size = c_ulong(<span class="hljs-number">0</span>)<font></font>
<font></font>
    status = nt.RtlDecompressBuffer(<font></font>
        <span class="hljs-number">0x102</span>,             <span class="hljs-comment"># COMPRESSION_FORMAT_LZNT1</span>
        dec_data,          <span class="hljs-comment"># UncompressedBuffer</span>
        <span class="hljs-number">0x10000</span>,           <span class="hljs-comment"># UncompressedBufferSize</span>
        c_char_p(buf),     <span class="hljs-comment"># CompressedBuffer</span>
        <span class="hljs-number">0xFFFFFF</span>,          <span class="hljs-comment"># CompressedBufferSize</span>
        byref(final_size)  <span class="hljs-comment"># FinalUncompressedSize</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-keyword">with</span> open(fname + <span class="hljs-string">'.uncompressed'</span>, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
        f.write(dec_data.raw[:final_size.value])</code></pre><br>
<p>        <code>6666</code>.    :</p><br>
<pre><code class="plaintext hljs">00000000: CC 69 94 FA 6A 37 18 29  CB 8D 87 EF 11 63 8E 73  .i..j7.).....c.s<font></font>
00000010: FE AB 43 3B B3 94 28 4B  4D 19 00 00 00 4F DB C7  ..C;..(KM....O..<font></font>
00000020: F3 1E E4 13 15 34 8F 51  A9 2B C2 D7 C1 96 78 F7  .....4.Q.+....x.<font></font>
00000030: 91 98</code></pre><br>
<p>    ,  :</p><br>
<pre><code class="plaintext hljs">00000000: 19 00 00 00 4F DB C7 F3  1E E4 13 15 34 8F 51 A9  ....O.......4.Q.<font></font>
00000010: 2B C2 D7 C1 96 78 F7 91  98                       +....x...</code></pre><br>
<p> 4   —    ,     25.   :</p><br>
<pre><code class="plaintext hljs">00000000: 12 B0 00 43 3A 5C 6B 65  79 70 61 04 73 73 01 70  ...C:\keypa.ss.p<font></font>
00000010: 73 2E 6B 64 62                                    s.kdb</code></pre><br>
<p>       <code>C:\keypass\keys.kdb</code>.   ,      ,     .      <code>6666</code>     —      <code>KeePass</code>.</p><br>
<p>    <code>7777</code>        <code>BMP</code>.       <code>XOR</code> ,   ,     , ..          .       ,   ,    <code>KeePass</code>.</p><br>
<p><img src="https://habrastorage.org/webt/3h/wg/ud/3hwgud3zz5s77zqiv2siwqjexve.png"></p><br>
<p><img src="https://habrastorage.org/webt/su/u2/dl/suu2dlwj1a8sqd5nq0vt2oqqkg8.png"></p><br>
<p>    <code>8888</code>     <code>k.dll</code> —      .</p><br>
<pre><code class="plaintext hljs">C:\Windows\system32\cmd.exe<font></font>
nslookup googlecom<font></font>
ping 1722173110<font></font>
nslookup soeblogcom<font></font>
nslookup fiosquatumgatefiosrouterhome<font></font>
C:\Windows\system32\cmd.exe<font></font>
Start<font></font>
Start menu<font></font>
Start menu<font></font>
chrome<font></font>
www.flare-on.com - Google Chrome<font></font>
tis encrypting something twice better than once<font></font>
Is encrypting something twice better than once? - Google Search - Google Chrome<font></font>
Start<font></font>
Start menu<font></font>
Start menu<font></font>
keeKeePass<font></font>
&lt;DYN_TITLE&gt;<font></font>
th1sisth33nd111<font></font>
KeePass<font></font>
keys.kdb - KeePass<font></font>
Is encrypting something twice better than once? - Google Search - Google Chrome<font></font>
Start<font></font>
Start menu<font></font>
Start menu<font></font>
KeePass<font></font>
&lt;DYN_TITLE&gt;<font></font>
th1sisth33nd111<font></font>
Open Database - keys.kdb<font></font>
KeePass<font></font>
Start<font></font>
Start menu<font></font>
Start menu<font></font>
KeePass<font></font>
Start menu<font></font>
Start menu<font></font>
Start menu<font></font>
KeePass<font></font>
&lt;DYN_TITLE&gt;<font></font>
th1sisth33nd111</code></pre><br>
<p>      <code>th1sisth33nd111</code>     ,    .    ,     .   ,  keylogger          . ,   ,    <code>ping</code>    .      <code>hashcat</code>      <code>KeePass</code>   ,    .              :</p><br>
<pre><code class="plaintext hljs">$ strings help.dmp | grep -i '3nd!'<font></font>
!s_iS_th3_3Nd!!!</code></pre><br>
<p> <code>Th</code>        .</p><br>
<p><img src="https://habrastorage.org/webt/xb/9g/yb/xb9gyb5mnp6evacpllttaz1czco.png"></p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>     .      ,   -.</p><br>
<a name="outro"></a><br>
<h2 id="0x0d---itog">0x0D — </h2><br>
<p>,  .   ,       ,        .      ,        <code>volatility</code>,      .            (  UTC+3:00):</p><br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/am/yq/ul/amyquljwc2ieb2qzb4ct9nemtnm.png"></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja469381/index.html">アゴネス、マルチプレイヤーゲームサーバーを作成します。アーキテクチャとインストール</a></li>
<li><a href="../ja469383/index.html">ハイパーコンバージドソリューションAERODISK vAIR。基礎-ARDFSファイルシステム</a></li>
<li><a href="../ja469387/index.html">ある「開発者」の物語、または初心者がiOS用のアプリケーションを作成する方法</a></li>
<li><a href="../ja469389/index.html">トポロジー最適化問題を解くための物理モデルのニューラルネットワークによるパラメーター化</a></li>
<li><a href="../ja469391/index.html">オーディオインターフェース：道路、オフィス、空の情報源としての音</a></li>
<li><a href="../ja469395/index.html">マルチカラム（CSSカラム）を使用する場所と方法</a></li>
<li><a href="../ja469399/index.html">Arkhangelskoye Museum-EstateでのWi-Fi</a></li>
<li><a href="../ja469401/index.html">3CX WebMeetingサービスの更新、Elastixオンラインコンバーター、新しいビデオチュートリアル</a></li>
<li><a href="../ja469403/index.html">上級ソフトウェア開発者のポジションの候補者にインタビューしています</a></li>
<li><a href="../ja469405/index.html">ディープラーニングがJavaになりました</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>