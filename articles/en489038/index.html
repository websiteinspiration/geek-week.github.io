<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÇ üë®üèæ‚Äçüöí üìå The book "Java Concurrency in Practice" üòä üàöÔ∏è üå∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, habrozhiteli! Streams are a fundamental part of the Java platform. Multi-core processors are commonplace, and the effective use of concurrency ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The book "Java Concurrency in Practice"</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/489038/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/1r/ku/4r/1rku4rb0w0tevxfiae9gxkkkzse.jpeg" align="left" alt="image"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, habrozhiteli! Streams are a fundamental part of the Java platform. Multi-core processors are commonplace, and the effective use of concurrency has become necessary to create any high-performance application. An improved Java virtual machine, support for high-performance classes and a rich set of building blocks for parallelization tasks were at one time a breakthrough in the development of parallel applications. In Java Concurrency in Practice, the creators of breakthrough technology themselves explain not only how they work, but also talk about design patterns. It‚Äôs easy to create a competitive program that seems to work. However, the development, testing, and debugging of multi-threaded programs pose many problems. The code stops working just when it is most important: under heavy load.In ‚ÄúJava Concurrency in Practice‚Äù you will find both theory and specific methods for creating reliable, scalable and supported parallel applications. The authors do not offer a list of APIs and parallelism mechanisms; they introduce design rules, patterns and models that are independent of the Java version and remain relevant and effective for many years.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excerpt. </font><font style="vertical-align: inherit;">Thread safety</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You may be surprised that competitive programming is associated with threads or locks </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(1)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no more than civil engineering is associated with rivets and I-beams. </font><font style="vertical-align: inherit;">Of course, the construction of bridges requires the correct use of a large number of rivets and I-beams, and the same applies to the construction of competitive programs, which requires the correct use of threads and locks. </font><font style="vertical-align: inherit;">But these are just mechanisms - means of achieving the goal. </font><font style="vertical-align: inherit;">Writing thread-safe code is, in essence, controlling access to a state, and, in particular, to a mutable state.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, the state of an object is its data stored in state variables, such as instance and static fields or fields from other dependent objects. The state of the HashMap hash is partially stored in the HashMap itself, but also in many Map.Entry objects. The state of an object includes any data that may affect its behavior. </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(1)</font></font></b>     lock  block,      ¬´¬ª,     ,  .            blocking.   lock    ¬´¬ª, ¬´  ¬ª.     lock ,  ,   ,    ¬´¬ª.  ‚Äî          .       ,          , ,         . ‚Äî . . .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Several threads can access a shared variable, mutated - changes its value. In fact, we are trying to protect data, not code, from uncontrolled competitive access. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creating a thread-safe object requires synchronization to coordinate access to a mutated state, failure to fulfill which can lead to data corruption and other undesirable consequences. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Whenever more than one thread accesses a state variable and one of the threads possibly writes to it, all threads must coordinate their access to it using synchronization. Synchronization in Java is provided by the synchronized keyword, which gives exclusive locking, as well as volatile and atomic variables and explicit locks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resist the temptation to think that there are situations that do not require synchronization. </font><font style="vertical-align: inherit;">The program can work and pass its tests, but remain malfunctioning and crash at any time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If multiple threads access the same variable with a mutated state without proper synchronization, then your program is malfunctioning. </font><font style="vertical-align: inherit;">There are three ways to fix it:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not share the state variable in all threads</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make the state variable non-mutable;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use state synchronization every time you access the state variable.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Corrections may require significant design changes, so it is much easier to design a class thread-safe right away than to upgrade it later.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Whether or not multiple threads will access this or that variable is difficult to find out. Fortunately, object-oriented technical solutions that help create well-organized and easy-to-maintain classes ‚Äî such as encapsulating and hiding data ‚Äî also help create thread-safe classes. The fewer threads that have access to a particular variable, the easier it is to ensure synchronization and set the conditions under which this variable can be accessed. The Java language does not force you to encapsulate the state - it is perfectly acceptable to store the state in public fields (even public static fields) or publish a link to an object that is otherwise internal - but the better the state of your program is encapsulated,the easier it is to make your program thread safe and help maintainers keep it that way.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When designing thread-safe classes, good object-oriented technical solutions: encapsulation, mutability, and a clear specification of invariants will be your assistants.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If good object-oriented design technical solutions diverge from the needs of the developer, you should sacrifice the rules of good design for the sake of performance or backward compatibility with legacy code. </font><font style="vertical-align: inherit;">Sometimes abstraction and encapsulation are at variance with performance - although not as often as many developers believe - but the best practice is to make the code right first and then fast. </font><font style="vertical-align: inherit;">Try to use optimization only if measurements of productivity and needs indicate that you must do it </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(2)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(2)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In competitive code, you should adhere to this practice even more than usual. Since competitive errors are extremely difficult to reproduce and are not easy to debug, the advantage of a small performance gain on some rarely used code branches can be quite negligible compared to the risk that the program will crash under operating conditions.</font></font><br>
</i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If you decide that you need to break encapsulation, then not everything is lost. Your program can still be made thread safe, but the process will be more complicated and more expensive, and the result will be unreliable. Chapter 4 describes the conditions under which encapsulation of state variables can safely be mitigated.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far, we have used the terms ‚Äúthread safe class‚Äù and ‚Äúthread safe program‚Äù almost interchangeably. Is a thread safe program built entirely from thread safe classes? Optional: a program that consists entirely of thread safe classes may not be thread safe, and a thread safe program may contain classes that are not thread safe. Issues related to the layout of thread-safe classes are also discussed in Chapter 4. In any case, the concept of a thread-safe class makes sense only if the class encapsulates its own state. The term ‚Äúthread safety‚Äù can be applied to the code, but it speaks of the state and can only be applied to that array of code that encapsulates its state (it can be an object or the whole program).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1. </font><font style="vertical-align: inherit;">What is thread safety?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Defining thread safety is not easy. </font><font style="vertical-align: inherit;">A quick Google search gives you numerous options like these: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... can be called from multiple program threads without unwanted interactions between threads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... can be called by two or more threads at the same time, without requiring any other action from the caller. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Given such definitions, it is not surprising that we find thread safety confusing! </font><font style="vertical-align: inherit;">How to distinguish a thread-safe class from an unsafe class? </font><font style="vertical-align: inherit;">What do we mean by the word "safe"? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the heart of any reasonable definition of thread safety is the notion of correctness.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Correctness implies that a class conforms to its specification. </font><font style="vertical-align: inherit;">The specification defines invariants that limit the state of an object and postconditions that describe the effects of operations. </font><font style="vertical-align: inherit;">How do you know that the specifications for classes are correct? </font><font style="vertical-align: inherit;">No way, but this does not prevent us from using them after we have convinced ourselves that the code works. </font><font style="vertical-align: inherit;">So let's assume that single-threaded correctness is something visible. </font><font style="vertical-align: inherit;">Now we can assume that the thread-safe class behaves correctly during access from multiple threads.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A class is thread safe if it behaves correctly during access from multiple threads, regardless of how these threads are scheduled or interleaved by the working environment, and without additional synchronization or other coordination on the part of the calling code.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A multi-threaded program cannot be thread safe if it is not correct even in a single-threaded environment </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If the object is implemented correctly, then no sequence of operations ‚Äî accessing public methods and reading or writing to public fields ‚Äî should violate its invariants or postconditions. </font><font style="vertical-align: inherit;">No set of operations performed sequentially or competitively on instances of a thread-safe class can cause an instance to be in an invalid state. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3) </font></font></b> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the loose use of the term correctness bothers you here, then you can think of a thread-safe class as a class that is faulty in a competitive environment, as well as in a single-threaded environment.</font></font></i><br>
 <br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thread-safe classes encapsulate any necessary synchronization themselves and do not need the help of a client.</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1.1. </font><font style="vertical-align: inherit;">Example: servlet without internal state support</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Chapter 1, we have listed the structures that create threads and call components from them that you are responsible for thread safety. </font><font style="vertical-align: inherit;">Now we intend to develop a servlet factorization service and gradually expand its functionality while maintaining thread safety. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listing 2.1 shows a simple servlet that decompresses a number from a query, factors it, and wraps the results in response. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listing 2.1. </font><font style="vertical-align: inherit;">Servlet without internal state support</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@ThreadSafe</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatelessFactorizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Servlet</span> </span>{
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(ServletRequest req, ServletResponse resp)</span> </span>{<font></font>
            BigInteger i = extractFromRequest(req);<font></font>
            BigInteger[] factors = factor(i);<font></font>
            encodeIntoResponse(resp, factors);<font></font>
      }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The StatelessFactorizer class, like most servlets, has no internal state: it does not contain fields and does not refer to fields from other classes. </font><font style="vertical-align: inherit;">The state for a particular calculation exists only in local variables that are stored in the stream stack and are available only to the executing stream. </font><font style="vertical-align: inherit;">One thread accessing StatelessFactorizer cannot affect the result of another thread doing the same, because these threads do not share state.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Objects without internal state support are always thread safe.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact that most servlets can be implemented without internal state support significantly reduces the burden of threading the servlets themselves. </font><font style="vertical-align: inherit;">And only when servlets need to remember something, the requirements for their thread safety increase.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2. </font><font style="vertical-align: inherit;">Atomicity</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What happens when a state item is added to an object without internal state support? Suppose we want to add a hit counter that measures the number of requests processed. You can add a field of type long to the servlet and increment it with each request, as shown in UnsafeCountingFactorizer in Listing 2.2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listing 2.2. A servlet that counts requests without the necessary synchronization. This should not be done.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/lj/hg/geljhgzyo9aogxu-ttztrzuawqo.jpeg" alt="image"></div><br>
<pre><code class="java hljs"><span class="hljs-meta">@NotThreadSafe</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UnsafeCountingFactorizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Servlet</span> </span>{
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> count = <span class="hljs-number">0</span>;<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> count; }<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(ServletRequest req, ServletResponse resp)</span> </span>{<font></font>
            BigInteger i = extractFromRequest(req);<font></font>
            BigInteger[] factors = factor(i);<font></font>
            ++count;<font></font>
            encodeIntoResponse(resp, factors);<font></font>
      }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, the UnsafeCountingFactorizer class is not thread safe, even if it works fine in a single-threaded environment. Like UnsafeSequence, it is prone to lost updates. Although the increment operation ++ count has compact syntax, it is not atomic, that is, indivisible, but a sequence of three operations: delivering the current value, adding one to it and writing the new value back. In the ‚Äúread, change, write‚Äù operations, the resulting state is derived from the previous one.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fig. </font><font style="vertical-align: inherit;">1.1 it is shown what can happen if two threads try to increase the counter at the same time, without synchronization. </font><font style="vertical-align: inherit;">If the counter is 9, then due to unsuccessful time coordination, both threads will see the value 9, add one to it, and set the value to 10. So the hit counter will start to lag by one. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You might think that having a slightly inaccurate hit counter in a web service is an acceptable loss, and sometimes it is. </font><font style="vertical-align: inherit;">But if the counter is used to create sequences or unique identifiers of objects, then returning the same value from multiple activations can lead to serious data integrity problems. </font><font style="vertical-align: inherit;">The possibility of the appearance of incorrect results due to unsuccessful temporal coordination arises in a race condition.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2.1. </font><font style="vertical-align: inherit;">Race conditions</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The UnsafeCountingFactorizer class has several race conditions </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(4)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The most common type of race condition is the ‚Äúcheck and then act‚Äù situation, where a potentially obsolete observation is used to decide what to do next. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(4)</font></font></b> <i>          (data race).   ,            .        ,    ,       ,   ,         ,      .               Java.       ,        ,             . UnsafeCountingFactorizer   .       16.</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We often encounter a race condition in real life. Suppose you plan to meet a friend at noon at Starbucks Caf√© on Universitetskiy Prospekt. But you will find out that there are two Starbucks on University Avenue. At 12:10 you do not see your friend in cafe A and go to cafe B, but he is not there either. Either your friend is late, or he arrived at cafe A immediately after you left, or he was at cafe B, but went looking for you and is now on his way to cafe A. We will accept the latter, that is, the worst case scenario. Now 12:15, and both of you are wondering if your friend kept his promise. Will you return to another cafe? How many times will you go back and forth? If you have not agreed on a protocol, you can spend the whole day walking along University Avenue in caffeinated euphoria.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem with the ‚Äútake a walk and see if he is there‚Äù approach is that a walk along the street between two cafes takes several minutes, and during this time the state of the system can change. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The example with Starbucks illustrates the dependence of the result on the relative time coordination of events (on how long you wait for a friend while in a cafe, etc.). </font><font style="vertical-align: inherit;">The observation that he is not in cafe A becomes potentially invalid: as soon as you exit the front door, he can enter through the back door. </font><font style="vertical-align: inherit;">Most race conditions cause problems such as an unexpected exception, overwritten data, and file corruption.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2.2. </font><font style="vertical-align: inherit;">Example: race conditions in lazy initialization</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A common trick using the ‚Äúcheck and then act‚Äù approach is lazy initialization (LazyInitRace). Its purpose is to postpone the initialization of the object until it is needed, and to ensure that it is initialized only once. In Listing 2.3, the getInstance method verifies that the ExpensiveObject is initialized and returns an existing instance, or, otherwise, creates a new instance and returns it after maintaining a reference to it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listing 2.3. The race condition is in lazy initialization. This should not be done</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/lj/hg/geljhgzyo9aogxu-ttztrzuawqo.jpeg" alt="image"></div><br>
<pre><code class="java hljs"><span class="hljs-meta">@NotThreadSafe</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyInitRace</span> </span>{
      <span class="hljs-keyword">private</span> ExpensiveObject instance = <span class="hljs-keyword">null</span>;<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> ExpensiveObject <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-keyword">null</span>)<font></font>
                instance = <span class="hljs-keyword">new</span> ExpensiveObject();
            <span class="hljs-keyword">return</span> instance;<font></font>
      }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The LazyInitRace class contains race conditions. Suppose that threads A and B execute the getInstance method at the same time. A sees that the instance field is null, and creates a new ExpensiveObject. Thread B also checks to see if the instance field is the same null. The presence of null in the field at this moment depends on the time coordination, including the vagaries of planning and the amount of time required to create an instance of the ExpensiveObject and set the value in the instance field. If the instance field is null when B checks it, two code elements calling the getInstance method can get two different results, even if the getInstance method is supposed to always return the same instance.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The hit counter in UnsafeCountingFactorizer also contains race conditions. The ‚Äúread, change, write‚Äù approach implies that in order to increment the counter, the stream must know its previous value and make sure that no one else changes or uses this value during the update process.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Like most competitive errors, race conditions do not always lead to failure: temporary coordination is successful. </font><font style="vertical-align: inherit;">But if the LazyInitRace class is used to instantiate the registry of the entire application, then when it will return different instances from multiple activations, registrations will be lost or actions will receive conflicting representations of the set of registered objects. </font><font style="vertical-align: inherit;">Or if the UnsafeSequence class is used to generate entity identifiers in a data conservation structure, then two different objects can have the same identifier, violating identity restrictions.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2.3. </font><font style="vertical-align: inherit;">Compound actions</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Both LazyInitRace and UnsafeCountingFactorizer contain a sequence of operations that must be atomic. </font><font style="vertical-align: inherit;">But to prevent a race condition, there must be an obstacle for other threads to use the variable while one thread modifies it.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operations A and B are atomic if, from the point of view of the thread performing operation A, operation B was either entirely performed by another thread or not even partially performed.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The atomicity of the increment operation in UnsafeSequence would avoid the race condition shown in Fig. 1.1. The operations ‚Äúcheck and then act‚Äù and ‚Äúread, change, write‚Äù should always be atomic. They are called compound actions ‚Äî sequences of operations that must be performed atomically in order to remain thread safe. In the next section, we will consider locking - a mechanism built into Java that provides atomicity. In the meantime, we will fix the problem in another way by applying the existing thread-safe class, as shown in the Countingfactorizer in Listing 2.4. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listing 2.4. Servlet counting requests using AtomicLong</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@ThreadSafe</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountingFactorizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Servlet</span> </span>{
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong count = <span class="hljs-keyword">new</span> AtomicLong(<span class="hljs-number">0</span>);<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> count.get(); }<font></font>
<font></font>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(ServletRequest req, ServletResponse resp)</span> </span>{<font></font>
            BigInteger i = extractFromRequest(req);<font></font>
            BigInteger[] factors = factor(i);<font></font>
            count.incrementAndGet();<font></font>
            encodeIntoResponse(resp, factors);<font></font>
      }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The java.util.concurrent.atomic package contains atomic variables for managing class states. Replacing the counter type from long to AtomicLong, we guarantee that all actions that refer to the state of the counter are atomic1. Since the state of the servlet is the state of the counter, and the counter is thread safe, our servlet becomes thread safe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When a single state element is added to a class that does not support internal state, the resulting class will be thread safe if the state is completely controlled by the thread safe object. But, as we will see in the next section, the transition from one state variable to the next will not be as simple as the transition from zero to one.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Where convenient, use existing thread-safe objects, such as AtomicLong, to control the state of your class. </font><font style="vertical-align: inherit;">Possible states of existing thread-safe objects and their transitions to other states are easier to maintain and check for thread-safety than arbitrary state variables.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬ªMore information about the book can be found on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the publisher‚Äôs website</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
¬ª </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contents</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
¬ª </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excerpt</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For Khabrozhiteley 25% discount on coupon - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After the payment of the paper version of the book, an electronic book is sent by e-mail.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489022/index.html">Using RabbitMQ with MonsterMQ Part 2</a></li>
<li><a href="../en489024/index.html">Webix JavaScript library through the eyes of a beginner. Part 5. Work with data on the user side</a></li>
<li><a href="../en489026/index.html">Changing Google AdSense Algorithms May Lead to Site Owners and Webmasters</a></li>
<li><a href="../en489028/index.html">About remote work</a></li>
<li><a href="../en489034/index.html">The new UIS mobile app - torment or salvation for those seeking public procurement?</a></li>
<li><a href="../en489040/index.html">Contact Center AI: third party in conversation is fine</a></li>
<li><a href="../en489042/index.html">Grand reopening of the Store: loading data into Android using coroutine</a></li>
<li><a href="../en489044/index.html">Physics of the text. Part 1. Symbols</a></li>
<li><a href="../en489046/index.html">Self-driving GAZ66 Monster Truck 1/16</a></li>
<li><a href="../en489048/index.html">Logging and query tracing are best practices. Yandex Report</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>