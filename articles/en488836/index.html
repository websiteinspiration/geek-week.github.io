<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîò üÜò üöà Some aspects of working with Dictionary when developing loaded applications ü¶ó üë©‚Äçüë©‚Äçüë¶‚Äçüë¶ üëåüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To write this short note, I was prompted by several recent interviews for the position of lead developer in our company. Some applicants, as it turned...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Some aspects of working with Dictionary when developing loaded applications</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488836/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To write this short note, I was prompted by several recent interviews for the position of lead developer in our company. Some applicants, as it turned out, are not well versed in what kind of mechanism this is, Dictionary, and how it should be used. I even came across a very radical opinion: they say that the dictionary works very slowly, and due to the fact that when it is immediately placed in the heap of large objects (LOH), it cannot be used in code and it is better to apply queries to regular collections using LINQ filters !</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, these are not entirely true statements. </font><font style="vertical-align: inherit;">A dictionary as a mechanism is very often in demand both in building highly loaded code and in implementing business logic. </font><font style="vertical-align: inherit;">The developer must imagine how the dictionary is organized, how it works with memory, how expensive it is, how many ‚Äútraces‚Äù it will leave in generations and LOH, causing unnecessary load on the garbage collector; </font><font style="vertical-align: inherit;">how to initialize it better, in which cases it is better to use a collection of key-value pairs instead, in which a sorted collection, etc.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article we will try to deal with some of these issues. </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The implementation of the dictionary from Microsoft is based, as everyone knows, on the hash table mechanism. </font><font style="vertical-align: inherit;">This gives in some scenarios the constant constant complexity O (1) that is unattainable for other algorithms for insert, search, and delete operations. </font><font style="vertical-align: inherit;">In some scenarios, the refusal to use this mechanism is fraught with significant problems with performance and memory consumption.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An important feature of the architecture is that data storage is organized using two arrays of the same size:</font></font></p><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">int</span>[] _buckets = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[size];<font></font>
    Entry[] _entries = <span class="hljs-keyword">new</span> Entry[size];</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These arrays store useful data and service elements for quick access to them. </font><font style="vertical-align: inherit;">Arrays are created with a margin, that is, they are almost always empty.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Entry helper entity that wraps each key-value pair is a significant type:</font></font></p><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">struct</span> Entry<font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">uint</span> hashCode;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> next;
        <span class="hljs-keyword">public</span> TKey key;
        <span class="hljs-keyword">public</span> TValue <span class="hljs-keyword">value</span>;<font></font>
    }</code></pre><br>
<p>           ,     ,        ,   _entries.   ,    ConcurrentDictionary,      .       (      64     16      8    )    ,              . </p><br>
<p>     _entries     Dictionary    85000        LOH (,       ,   64      3372  ,       1932).  ,        ,        .</p><br>
<p>  Microsoft   _entries   ,   Entry?       LOH        (,  ,   ). , ,     .</p><br>
<p>      ,      .         12   (4    _buckets   4    hashCode  next  Entry).        , ,  ,     12  .      ? .</p><br>
<p> Dictionary          .            .          Dictionary&lt;int, int&gt;    ( ).   ,      ‚Äì     ( ).     500 .  13 .      500 .</p><br>
<img src="https://habrastorage.org/webt/lc/y0/bt/lcy0btcer22ad_y0fkmorjaob34.png"><br>
<p> ,           .      ,       ,       ,         .</p><br>
<p>        ,      _buckets  _entries             ,      ¬´¬ª,     .              LOH,      .<br>
,            746   3     .</p><br>
<p>   ,     Dictionary             .           ,     , ,    .NET Core     TrimExcess,           .</p><br>
<p>            :</p><br>
<ul>
<li>     ,               EnsureCapacity.        .</li>
<li>  ,          400    10.  (80  ).        new Dictionary&lt;int, int&gt;(10001000),          190.        ,             ,      .</li>
<li>     ,      Dictionary        EnsureCapacity(capacity*),     .  ,         _buckets  _entries        .       .    ,  EnsureCapacity(0).</li>
<li>         ,   ( ) ,   ,        Dictionary:    .    ,                  .    ,          (       ).</li>
<li>      TrimExcess.             LOH           .              .</li>
</ul><br>
<p>                 Dictionary.    ,      Dictionary&lt;Key, Value&gt;, :</p><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Key</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Item { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Key</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> item</span>)</span><font></font>
        {<font></font>
            Item = item;<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">Equals</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> obj</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> Item.Equals(obj);<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">int</span> <span class="hljs-title">GetHashCode</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> Item.GetHashCode();<font></font>
        }<font></font>
    }<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Value</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Item { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Value</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> item</span>)</span><font></font>
        {<font></font>
            Item = item;<font></font>
        }<font></font>
    }</code></pre><br>
<p>  .</p><br>
<img src="https://habrastorage.org/webt/cg/aj/6u/cgaj6ulgpefgivt8q_kjgwklfpu.png"><br>
<p>      ? </p><br>
<p>  :</p><br>
<ul>
<li>    64        (8 )      (8 ). </li>
<li>,    ,  8   ¬´¬ª .</li>
<li> Item   Key  Value  8 ,    ,    Item     4 .</li>
</ul><br>
<p>         20  76 .</p><br>
<p>      :</p><br>
<ul>
<li>           (      ),            .</li>
<li>     ,    .      . </li>
</ul><br>
<p> ,         .      ?     ,           ( 10-20-30 ) .    ?</p><br>
<p>   . ,      Dictionary&lt;int, int&gt;(int count)      :</p><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">struct</span> Entry&lt;TValue&gt;<font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span>[] Keys;
        <span class="hljs-keyword">public</span> TValue[] Values;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Entry</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> count</span>)</span><font></font>
        {<font></font>
            Keys = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[count];<font></font>
            Values = <span class="hljs-keyword">new</span> TValue[count];<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">TryGetValue</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> key, <span class="hljs-keyword">out</span> TValue <span class="hljs-keyword">value</span></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; Keys.Length; ++j)<font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (Keys[j] == key)<font></font>
                {<font></font>
                    <span class="hljs-keyword">value</span> = Values[j];
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-keyword">value</span> = <span class="hljs-keyword">default</span>(TValue);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
        }<font></font>
    }</code></pre><br>
<p> count ‚Äì   -,    .<br>
   .</p><br>
<img src="https://habrastorage.org/webt/b3/qb/2b/b3qb2bpspnpxd8dvivge8i52jz0.png"><br>
<p> ,          18   count=10  134   count=190 (   50 .   ).            (  ‚Äì  29 ),      (     150)   ,           (,       ). </p><br>
<p>         ,        (,   ,       Entry     ,   ).<br>
       ,      (callvirt  GetHashCode  Equals).   ‚Äì   . ,   ,       ,           (generic)     .               .</p><br>
<p>         SortedList&lt;int, int&gt;.<br>
       .</p><br>
<img src="https://habrastorage.org/webt/vi/wv/9e/viwv9et5uwjt7mdwh3wyv4lrbxk.png"><br>
<p> ,            . </p><br>
<p>     :             ,                   .         .</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In all the examples presented, it should be borne in mind that small data is used in the test configuration, therefore, the overhead for service information is relatively high. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test projects can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488826/index.html">Recognize privilege escalation in ABBYY FineReader</a></li>
<li><a href="../en488828/index.html">Spam, spam, spam ...</a></li>
<li><a href="../en488830/index.html">Internet in Turkmenistan: price, availability and restrictions</a></li>
<li><a href="../en488832/index.html">Surprisingly, last year, corporate HDDs were more popular than SSDs and their sales are growing</a></li>
<li><a href="../en488834/index.html">How the error from 2009 causes a conflict between Docker for Windows and Razer Synapse</a></li>
<li><a href="../en488842/index.html">Catch an electron: observing a process that takes a quintillionth of a second</a></li>
<li><a href="../en488844/index.html">Borders for border guards: US court has established rules for checking devices - discuss the situation</a></li>
<li><a href="../en488846/index.html">Postgresso 19</a></li>
<li><a href="../en488848/index.html">CTO all startup</a></li>
<li><a href="../en488850/index.html">Using RabbitMQ with MonsterMQ Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>