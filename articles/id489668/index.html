<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👌 👨 🤩 Batas CPU dan pembatasan agresif di Kubernetes 💄 ✊🏻 🕙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Catatan perev. : Kisah peringatan Omio, agregator perjalanan Eropa, membawa pembaca dari teori dasar ke seluk-beluk praktis praktis konfigurasi Kubern...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Batas CPU dan pembatasan agresif di Kubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/489668/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Catatan perev.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Kisah peringatan Omio, agregator perjalanan Eropa, membawa pembaca dari teori dasar ke seluk-beluk praktis praktis konfigurasi Kubernetes. Keakraban dengan kasus-kasus seperti itu membantu tidak hanya untuk memperluas wawasan seseorang, tetapi juga untuk mencegah masalah-masalah yang tidak sepele.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/bw/jr/on/bwjronw-hyhosv46aa1d6pqldie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pernahkah Anda menemukan fakta bahwa aplikasi "macet" pada tempatnya, berhenti merespons permintaan pemeriksaan kesehatan, dan Anda tidak dapat memahami alasan perilaku ini? Satu penjelasan yang mungkin adalah batas kuota untuk sumber daya CPU. Dia akan dibahas dalam artikel ini.</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TL; DR: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami sangat menyarankan Anda memilih keluar dari batas CPU di Kubernetes (atau menonaktifkan kuota CFS di Kubelet) jika Anda menggunakan versi kernel Linux dengan kesalahan kuota CFS. Pada intinya </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ada</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bug yang </font><font style="vertical-align: inherit;">serius dan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terkenal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> yang menyebabkan pelambatan dan penundaan yang berlebihan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di Omio, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seluruh infrastruktur dikelola oleh Kubernetes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Semua muatan negara dan stateless kami bekerja secara eksklusif di Kubernetes (kami menggunakan Google Kubernetes Engine). </font><font style="vertical-align: inherit;">Dalam enam bulan terakhir, kami mulai mengamati perlambatan acak. </font><font style="vertical-align: inherit;">Aplikasi membeku atau berhenti merespons pemeriksaan kesehatan, kehilangan koneksi ke jaringan, dll. </font><font style="vertical-align: inherit;">Perilaku seperti itu telah lama membingungkan kami, dan, akhirnya, kami memutuskan untuk menangani masalah ini dengan cermat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ringkasan artikel:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Beberapa kata tentang wadah dan Kubernet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bagaimana permintaan dan batasan CPU diimplementasikan;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bagaimana batas CPU bekerja di lingkungan multi-core;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cara melacak throttling CPU;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Memecahkan masalah dan nuansa.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa kata tentang wadah dan Kubernet</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes, pada kenyataannya, adalah standar modern di dunia infrastruktur. </font><font style="vertical-align: inherit;">Tugas utamanya adalah mengatur wadah.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wadah</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di masa lalu, kami harus membuat artefak seperti Java JARs / WARs, Python Eggs, atau executable untuk peluncuran berikutnya di server. </font><font style="vertical-align: inherit;">Namun, untuk membuatnya berfungsi, mereka harus melakukan pekerjaan tambahan: menginstal runtime (Java / Python), menempatkan file yang diperlukan di tempat yang tepat, memastikan kompatibilitas dengan versi spesifik dari sistem operasi, dll. </font><font style="vertical-align: inherit;">Dengan kata lain, Anda harus memperhatikan manajemen konfigurasi (yang sering menyebabkan pertentangan antara pengembang dan administrator sistem). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wadah telah mengubah segalanya.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sekarang gambar wadah bertindak sebagai artefak. </font><font style="vertical-align: inherit;">Ini dapat direpresentasikan sebagai jenis file executable yang diperluas yang tidak hanya berisi program, tetapi juga runtime penuh (Java / Python / ...), serta file / paket yang diperlukan yang sudah diinstal sebelumnya dan siap dijalankan. </font><font style="vertical-align: inherit;">Kontainer dapat digunakan dan dijalankan di berbagai server tanpa langkah tambahan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, kontainer bekerja di lingkungan kotak pasir mereka sendiri. </font><font style="vertical-align: inherit;">Mereka memiliki adapter jaringan virtual mereka sendiri, sistem file mereka sendiri dengan akses terbatas, hierarki proses mereka sendiri, pembatasan mereka sendiri pada CPU dan memori, dll. Semua ini diwujudkan berkat subsistem khusus dari kernel Linux - namespaces (namespace).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang dinyatakan sebelumnya, Kubernetes adalah wadah orkestra. </font><font style="vertical-align: inherit;">Ini berfungsi sebagai berikut: Anda memberinya kumpulan mesin, dan kemudian berkata: "Hai Kubernetes, luncurkan sepuluh instance dari wadah saya dengan masing-masing 2 prosesor dan 3 GB memori, dan biarkan operasional!" </font><font style="vertical-align: inherit;">Kubernetes mengurus sisanya. </font><font style="vertical-align: inherit;">Dia akan menemukan kapasitas gratis, meluncurkan wadah, dan memulai kembali jika perlu, meluncurkan pembaruan saat mengubah versi, dll. </font><font style="vertical-align: inherit;">Bahkan, Kubernetes memungkinkan Anda untuk abstrak dari komponen perangkat keras dan membuat seluruh variasi sistem cocok untuk penerapan dan pengoperasian aplikasi. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hs/ux/tu/hsuxtucqvih716edmdtgac_btxa.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernet dari sudut pandang orang awam yang sederhana</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa itu permintaan dan batasan di Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oke, kami sudah menemukan wadah dan Kubernet. Kita juga tahu bahwa beberapa kontainer bisa berada di mesin yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat menggambar analogi dengan apartemen komunal. Ruang yang luas diambil (mobil / node) dan disewakan ke beberapa penyewa (wadah). Kubernetes bertindak sebagai makelar. Muncul pertanyaan, bagaimana menjaga penyewa dari konflik satu sama lain? Bagaimana jika salah satu dari mereka, misalnya, memutuskan untuk menempati kamar mandi selama setengah hari? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sinilah permintaan dan batasan ikut berperan. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permintaan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU </font><b><font style="vertical-align: inherit;">hanya</font></b><font style="vertical-align: inherit;"> untuk tujuan perencanaan. Ini adalah sesuatu seperti "daftar keinginan" wadah, dan digunakan untuk memilih simpul yang paling cocok. Pada saat yang sama, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Batas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU </font><font style="vertical-align: inherit;">dapat dibandingkan dengan leasing - segera setelah kami mengambil node untuk container, itu</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak akan dapat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> melampaui batas yang ditetapkan. </font><font style="vertical-align: inherit;">Dan di sini muncul masalah ...</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana permintaan dan batasan diterapkan di Kubernetes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes menggunakan mekanisme pelambatan kernel (skipping clock) untuk mengimplementasikan batas CPU. </font><font style="vertical-align: inherit;">Jika aplikasi melebihi batas, pembatasan diaktifkan (mis. Menerima siklus CPU lebih sedikit). </font><font style="vertical-align: inherit;">Permintaan dan batasan memori diatur secara berbeda, sehingga lebih mudah dideteksi. </font><font style="vertical-align: inherit;">Untuk melakukan ini, cukup memeriksa status restart pod terakhir: apakah "OOMKilled". </font><font style="vertical-align: inherit;">Dengan pembatasan CPU, semuanya tidak begitu sederhana, karena K8 hanya membuat metrik yang tersedia untuk digunakan, bukan cgroup.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permintaan CPU</font></font></h4><br>
<img src="https://habrastorage.org/webt/hh/fk/qn/hhfkqnuy5oe4tq_ubi57aeblvqe.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana permintaan CPU diimplementasikan</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Untuk kesederhanaan, mari kita lihat proses menggunakan contoh mesin dengan CPU 4-core. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K8 menggunakan mekanisme cgroup untuk mengontrol alokasi sumber daya (memori dan prosesor). Model hierarkis tersedia untuknya: seorang keturunan mewarisi batas-batas kelompok induk. Detail distribusi disimpan dalam sistem file virtual ( </font></font><code>/sys/fs/cgroup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Dalam hal prosesor, ini </font></font><code>/sys/fs/cgroup/cpu,cpuacct/*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K8 menggunakan file </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk mengalokasikan sumber daya prosesor. Dalam kasus kami, grup kontrol root menerima 4096 bagian sumber daya CPU - 100% dari daya prosesor yang tersedia (1 inti = 1024; ini adalah nilai tetap). Grup root mendistribusikan sumber daya secara proporsional tergantung pada bagian keturunan yang ditentukan dalam</font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan mereka, pada gilirannya, melakukan hal yang sama kepada keturunan mereka, dll. Biasanya Kubernetes akar kelompok kontrol node memiliki tiga anak: </font></font><code>system.slice</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>user.slice</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>kubepods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dua subkelompok pertama digunakan untuk mendistribusikan sumber daya antara beban sistem kritis dan program pengguna di luar K8. Yang terakhir - - </font></font><code>kubepods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dibuat oleh Kubernetes untuk mendistribusikan sumber daya antar pod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diagram di atas menunjukkan bahwa subkelompok pertama dan kedua menerima </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1024</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saham, dengan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4096</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saham </font><font style="vertical-align: inherit;">dialokasikan untuk subkelompok kuberpod </font><font style="vertical-align: inherit;">. Bagaimana ini mungkin: setelah semua, grup root hanya memiliki </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.096</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saham tersedia, dan jumlah saham keturunannya secara signifikan melebihi jumlah ini ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6144</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)? Faktanya adalah bahwa nilainya masuk akal, sehingga Linux Scheduler (CFS) menggunakannya untuk mengalokasikan sumber daya CPU secara proporsional. Dalam kasus kami, dua kelompok pertama menerima </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">680</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saham riil (16,6% dari 4096), dan kubepod menerima sisanya </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2736</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saham. Dalam hal downtime, dua kelompok pertama tidak akan menggunakan sumber daya yang dialokasikan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untungnya, scheduler memiliki mekanisme untuk menghindari hilangnya sumber daya CPU yang tidak digunakan. Ini mentransfer kapasitas "idle" ke kumpulan global, dari mana mereka didistribusikan di antara kelompok-kelompok yang membutuhkan kapasitas prosesor tambahan (transfer terjadi dalam batch untuk menghindari pembulatan kerugian). Metode serupa berlaku untuk semua keturunan keturunan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mekanisme ini memastikan distribusi daya prosesor yang adil dan memastikan bahwa tidak ada proses yang "mencuri" sumber daya dari orang lain.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Batas CPU</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terlepas dari kenyataan bahwa konfigurasi batas dan permintaan dalam K8 terlihat serupa, implementasinya secara fundamental berbeda: ini adalah bagian yang </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paling menyesatkan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan paling tidak terdokumentasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K8 menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mekanisme kuota CFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk menerapkan batas. Pengaturan mereka ditentukan dalam file </font></font><code>cfs_period_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>cfs_quota_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dalam direktori cgroup (file tersebut juga terletak di sana </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebaliknya </font></font><code>cpu.share</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, kuota didasarkan pada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">periode waktu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan bukan pada kekuatan prosesor yang tersedia. </font></font><code>cfs_period_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menetapkan durasi periode (era) - selalu 100.000 μs (100 ms). K8 memiliki kemampuan untuk mengubah nilai ini, tetapi saat ini hanya tersedia dalam versi alpha. Penjadwal menggunakan era untuk me-restart kuota yang digunakan. File kedua</font></font><code>cfs_quota_us</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, menetapkan waktu yang tersedia (kuota) di setiap era. Harap dicatat bahwa ini juga ditunjukkan dalam mikrodetik. Kuota dapat melebihi durasi era; dengan kata lain, bisa lebih dari 100 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita lihat dua skenario pada mesin 16-core (tipe komputer paling umum yang kita miliki di Omio): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pt/wr/dm/ptwrdmpxueuy4p1mn7mb8vfdhyg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skenario 1: 2 utas dan batas 200 ms. Tanpa pelambatan </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/7f/no/i9/7fnoi9e7kz6ib6jksx2mkqmc-zo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skenario 2: 10 mengalir dan batas 200 ms. Pelambatan dimulai setelah 20 ms, akses ke sumber daya prosesor dilanjutkan setelah 80 ms lainnya.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Misalkan Anda menetapkan batas CPU menjadi </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> core; Kubernetes akan menerjemahkan nilai ini menjadi 200 ms. Ini berarti bahwa wadah dapat menggunakan waktu CPU maksimum 200 ms tanpa pembatasan.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan di sini kesenangan dimulai. </font><font style="vertical-align: inherit;">Seperti disebutkan di atas, kuota yang tersedia adalah 200 ms. </font><font style="vertical-align: inherit;">Jika Anda memiliki </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sepuluh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utas yang </font><font style="vertical-align: inherit;">berjalan secara paralel </font><font style="vertical-align: inherit;">pada mesin 12-inti (lihat ilustrasi untuk skenario 2), sementara semua polong lainnya menganggur, kuota akan habis hanya dalam 20 ms (karena 10 * 20 ms = 200 ms), dan semua utas pod ini adalah </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">throttle</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk 80 ms berikutnya. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bug scheduler yang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sudah disebutkan memperparah situasi </font><font style="vertical-align: inherit;">, karena terjadi pelambatan yang berlebihan dan kontainer bahkan tidak dapat mengerjakan kuota yang ada.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana cara mengevaluasi pembatasan dalam polong?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cukup buka pod dan jalankan </font></font><code>cat /sys/fs/cgroup/cpu/cpu.stat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<ul>
<li> <code>nr_periods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - jumlah total periode penjadwal;</font></font></li>
<li> <code>nr_throttled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- jumlah periode yang dibatasi dalam komposisi </font></font><code>nr_periods</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>throttled_time</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Waktu dipercepat kumulatif dalam nanodetik.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/fb/kp/tp/fbkptpvc9e6c1yua63aawbropk8.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang sebenarnya sedang terjadi?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasilnya, kami mendapatkan pelambatan tinggi di semua aplikasi. </font><font style="vertical-align: inherit;">Terkadang </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">satu setengah kali</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lebih kuat dari yang dihitung! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hal ini menyebabkan berbagai kesalahan - kegagalan pemeriksaan kesiapan, hang kontainer, putus koneksi jaringan, timeout di dalam panggilan layanan. </font><font style="vertical-align: inherit;">Pada akhirnya, ini berarti latensi yang meningkat dan kesalahan yang meningkat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keputusan dan konsekuensi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya sederhana di sini. </font><font style="vertical-align: inherit;">Kami mengabaikan batas CPU dan mulai memperbarui kernel OS dalam kelompok ke versi terbaru di mana bug diperbaiki. </font><font style="vertical-align: inherit;">Jumlah kesalahan (HTTP 5xx) dalam layanan kami segera turun secara signifikan:</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesalahan HTTP 5xx</font></font></h3><br>
<img src="https://habrastorage.org/webt/rg/t4/wt/rgt4wttq-x7-0dz8-5pfybrk_d8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTP 5xx kesalahan satu layanan penting</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waktu respons P95</font></font></h3><br>
<img src="https://habrastorage.org/webt/xc/ds/er/xcdservm7jabpev6yly59uq_u3i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penundaan Permintaan Layanan Penting, persentil ke-95</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biaya operasional</font></font></h3><br>
<img src="https://habrastorage.org/webt/zb/ym/nc/zbymnckdg75bfpktepdi8ex4byg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jumlah jam yang dihabiskan</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang menangkap?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang dinyatakan di awal artikel:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat menggambar analogi dengan apartemen komunal ... Kubernetes bertindak sebagai makelar. </font><font style="vertical-align: inherit;">Tetapi bagaimana menjaga penyewa dari konflik satu sama lain? </font><font style="vertical-align: inherit;">Bagaimana jika salah satu dari mereka, misalnya, memutuskan untuk menempati kamar mandi selama setengah hari?</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu tangkapannya. </font><font style="vertical-align: inherit;">Satu wadah lalai dapat menyerap semua sumber daya prosesor yang tersedia di mesin. </font><font style="vertical-align: inherit;">Jika Anda memiliki tumpukan aplikasi yang cerdas (misalnya, JVM, Go, Node VM dikonfigurasi dengan benar), maka ini bukan masalah: Anda dapat bekerja dalam kondisi seperti itu untuk waktu yang lama. </font><font style="vertical-align: inherit;">Tetapi jika aplikasi dioptimalkan dengan buruk atau tidak dioptimalkan sama sekali ( </font></font><code>FROM java:latest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), situasinya mungkin lepas kendali. </font><font style="vertical-align: inherit;">Kami di Omio memiliki Dockerfiles dasar otomatis dengan pengaturan default yang memadai untuk tumpukan bahasa utama, jadi tidak ada masalah seperti itu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami menyarankan Anda memantau metrik </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (penggunaan, saturasi, dan kesalahan), penundaan API, dan tingkat kesalahan. </font><font style="vertical-align: inherit;">Pastikan hasilnya seperti yang diharapkan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu adalah kisah kami. </font><font style="vertical-align: inherit;">Materi berikut sangat membantu untuk memahami apa yang terjadi:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel.org → Penjadwal CFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel.org → Kontrol Bandwidth CFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memahami Penjadwalan Kontainer Linux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semua yang Perlu Anda Ketahui tentang Wadah Linux, Bagian I: Grup Kontrol Linux dan Proses Isolasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes Failure Stories</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">Cari</font></a><font style="vertical-align: inherit;"> “cpu throttling”.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pelaporan Kesalahan Kubernetes:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 51135: Hindari pengaturan batas CPU untuk polong yang Dijamin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 67577: Kuota CFS dapat menyebabkan pelambatan yang tidak perlu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CFS terlalu agresif</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pernahkah Anda mengalami masalah serupa dalam praktik Anda atau memiliki pengalaman dengan pelambatan di lingkungan produksi yang kemas? </font><font style="vertical-align: inherit;">Bagikan kisah Anda di komentar!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS dari penerjemah</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baca juga di blog kami:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penskalaan otomatis dan manajemen sumber daya di Kubernetes (laporan ulasan dan video)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana cara Manajer CPU di Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang terjadi di Kubernet ketika run kubectl dimulai? </font><font style="vertical-align: inherit;">Bagian 2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id489642/index.html">Paten lucu dari industri otomotif</a></li>
<li><a href="../id489650/index.html">Otomasi seorang jurnalis. Bagian 1: Tugas dan Kalender</a></li>
<li><a href="../id489662/index.html">PHP Digest No. 174 (10 - 24 Februari 2020)</a></li>
<li><a href="../id489664/index.html">NPS, conveyor, komputasi otomatis dan lagi ... coroutine</a></li>
<li><a href="../id489666/index.html">Kelebihan dalam C ++. Bagian II Operator Kelebihan</a></li>
<li><a href="../id489672/index.html">Kami menghidupkan kembali hexapod. Bagian kedua</a></li>
<li><a href="../id489674/index.html">Angular: pengantar yang jelas untuk NGRX</a></li>
<li><a href="../id489676/index.html">Kami membuat klon dari layanan pengiriman makanan menggunakan Nuxt.js, GraphQL, Strapi dan Stripe. Bagian 1/7</a></li>
<li><a href="../id489678/index.html">Memori tidak bisa dihancurkan, proses tidak bisa dihancurkan</a></li>
<li><a href="../id489682/index.html">Pemblokiran Baca Lintas Sumber (CORB) dalam Ekstensi Chrome</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>