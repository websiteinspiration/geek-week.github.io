<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖖🏻 👍🏽 😸 An easy way to protect your Mikrotik from attacks ✊🏼 👨‍💼 👈</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with the community a simple and working way how to use Mikrotik to protect my network and services that “look out” because of it from ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>An easy way to protect your Mikrotik from attacks</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499146/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I want to share with the community a simple and working way how to use Mikrotik to protect my network and services that “look out” because of it from external attacks. Namely, with just three rules, organize a honeypot on Mikrotik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, let's imagine that we have a small office, an external IP behind which is an RDP server, for employees to work remotely. The first rule is of course to change port 3389 on the external interface to another. But this is not for long, after a couple of days, the terminal server audit log will begin to show several failed authorizations per second from unknown clients.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another situation, you have asterisk hidden behind Mikrotik, of course, not on the 5060 udp port, and after a couple of days password guessing also starts ... yes yes, I know, fail2ban is our whole thing, but I still have to puff over it ... for example, I recently lifted it to ubuntu On April 18, I was surprised to find that out of the box fail2ban does not contain the actual settings for asterisk from the same box of the same ubuntu distribution ... but Google can’t google quick settings of ready-made “recipes”, the numbers of releases grow over the years, and articles with “ recipes ”for the old versions no longer work, but almost no new ones ... But something I digress ...</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, what is honeypot in a nutshell - is a decoy, in our case, some popular port on an external IP, any request to this port from an external client sends the src address to the black list. </font><font style="vertical-align: inherit;">All.</font></font><br>
 <br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=add-src-to-address-list address-list="Honeypot Hacker" \<font></font>
    address-list-timeout=30d0h0m chain=input comment="block honeypot ssh rdp winbox" \<font></font>
    connection-state=new dst-port=22,3389,8291 in-interface=\<font></font>
    ether4-wan protocol=tcp<font></font>
add action=add-src-to-address-list address-list="Honeypot Hacker" \<font></font>
    address-list-timeout=30d0h0m chain=input comment=\<font></font>
    "block honeypot asterisk" connection-state=new dst-port=5060 \<font></font>
    in-interface=ether4-wan protocol=udp <font></font>
/ip firewall raw<font></font>
add action=drop chain=prerouting in-interface=ether4-wan src-address-list=\<font></font>
    "Honeypot Hacker"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first rule on the popular TCP ports 22, 3389, 8291 of the external ether4-wan interface sends the guest IP to the Honeypot Hacker list (ports for ssh, rdp and winbox are disabled in advance or changed to others). The second does the same on the popular UDP 5060. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The third rule at the pre-routing stage drops packets of the "guests" whose srs-address got into the "Honeypot Hacker". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After two weeks of work at my home Mikrotik, the Honeypot Hacker list included about one and a half thousand IP addresses of udder-friendly fans of my network resources (home telephony, mail, nextcloud, rdp). Brute-force attacks stopped, bliss ensued. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At work, not everything turned out to be so simple, they continue to break the rdp server with brute force passwords.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apparently, the port number was determined by the scanner long before the honeypot was turned on, and during quarantine it is not so easy to reconfigure more than 100 users, of which 20% are over 65 years old. </font><font style="vertical-align: inherit;">In the case when the port cannot be changed, there is a small working recipe. </font><font style="vertical-align: inherit;">I met similar on the Internet, but there is a finished and fine-tuning:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rules for configuring Port Knocking</font></font></b>
                        <div class="spoiler_text"> <pre><code class="plaintext hljs"> /ip firewall filter<font></font>
add action=add-src-to-address-list address-list=rdp_blacklist \<font></font>
    address-list-timeout=15m chain=forward comment=rdp_to_blacklist \<font></font>
    connection-state=new dst-port=3389 protocol=tcp src-address-list=\<font></font>
    rdp_stage12<font></font>
add action=add-src-to-address-list address-list=rdp_stage12 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage11<font></font>
add action=add-src-to-address-list address-list=rdp_stage11 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage10<font></font>
add action=add-src-to-address-list address-list=rdp_stage10 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage9<font></font>
add action=add-src-to-address-list address-list=rdp_stage9 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage8<font></font>
add action=add-src-to-address-list address-list=rdp_stage8 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage4<font></font>
add action=add-src-to-address-list address-list=rdp_stage7 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage6<font></font>
add action=add-src-to-address-list address-list=rdp_stage6 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage5<font></font>
add action=add-src-to-address-list address-list=rdp_stage5 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=\<font></font>
    3389 protocol=tcp src-address-list=rdp_stage4<font></font>
add action=add-src-to-address-list address-list=rdp_stage4 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=\<font></font>
    3389 protocol=tcp src-address-list=rdp_stage3<font></font>
add action=add-src-to-address-list address-list=rdp_stage3 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage2<font></font>
add action=add-src-to-address-list address-list=rdp_stage2 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage1<font></font>
add action=add-src-to-address-list address-list=rdp_stage1 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp <font></font>
/ip firewall raw<font></font>
add action=drop chain=prerouting in-interface=ether4-wan src-address-list=\<font></font>
rdp_blacklist<font></font>
</code></pre> </div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 4 minutes, the remote client is allowed to make only 12 new “requests” to the RDP server. </font><font style="vertical-align: inherit;">One login attempt is from 1 to 4 “requests”. </font><font style="vertical-align: inherit;">At the 12th “request” - a lock for 15 minutes. </font><font style="vertical-align: inherit;">In my case, the attackers didn’t stop hacking the server, they adapted to the timers and now they do it very slowly, this selection speed reduces the attack efficiency to zero. </font><font style="vertical-align: inherit;">The employees of the enterprise practically do not experience any inconvenience in the work taken.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another little trick</font></font></b>
                        <div class="spoiler_text">            5,     ,     .<br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter <font></font>
add action=add-src-to-address-list address-list=rdp_blacklist \<font></font>
    address-list-timeout=1w0d0h0m chain=forward comment=\<font></font>
    "night_rdp_blacklist" connection-state=new disabled=\<font></font>
    yes dst-port=3389 protocol=tcp src-address-list=rdp_stage8</code></pre><br>
  8    IP       . !<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, in addition to the above, I will add a link to the Wiki article, with the working setting of protecting Mikrotik from network scanners. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki.mikrotik.com/wiki/Drop_port_scanners</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
On my devices, this setting works in conjunction with the honeypot rules described above, complementing them well. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: As suggested in the comments, the packet drop rule has been moved to RAW to reduce the load on the router.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499130/index.html">BlockAdBlock Advertising Anti-Blocking Reverse Engineering</a></li>
<li><a href="../en499134/index.html">4 steps to increase LTV product through user communication</a></li>
<li><a href="../en499136/index.html">#BeeFree, or ... Beeline - you could not resist?</a></li>
<li><a href="../en499138/index.html">Topological sorting</a></li>
<li><a href="../en499140/index.html">Generation under control: how to curb powerful language models</a></li>
<li><a href="../en499148/index.html">Aerosol and chlorine dioxide (ClO2): how is this related?</a></li>
<li><a href="../en499150/index.html">And one warrior in the field: is it possible to provide quality hosting services without a team</a></li>
<li><a href="../en499152/index.html">DLL & Python</a></li>
<li><a href="../en499154/index.html">The digest of interesting materials for the mobile # 342 developer (on April 20 - 26)</a></li>
<li><a href="../en499160/index.html">Russian SCRUM. Senseless and merciless</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>