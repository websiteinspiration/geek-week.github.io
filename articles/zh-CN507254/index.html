<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙂 🕺🏽 🤵 Zabbix-扩展宏边界 👩🏽‍🤝‍👩🏻 🤜🏽 🍘</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="为客户解决方案时，我想通过常规Zabbix功能精美地解决2个任务。
 
 任务1.在Mikrotik路由器上跟踪当前固件版本。
 
 通过将代理添加到HTTP模板，可以轻松解决该任务。该代理从Mikrotik网站接收当前版本，并且触发器将当前版本与当前版本进行比较，如果出现差异，则发出警报。
 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Zabbix-扩展宏边界</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/507254/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为客户解决方案时，我想通过常规Zabbix功能精美地解决2个任务。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任务1.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Mikrotik路由器上跟踪当前固件版本。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过将代理添加到HTTP模板，可以轻松解决该任务。该代理从Mikrotik网站接收当前版本，并且触发器将当前版本与当前版本进行比较，如果出现差异，则发出警报。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当您有10个路由器时，此算法并不重要，但是使用3000个路由器怎么办？向服务器发送3000个请求？当然，这样的方案可以用，但是3000个查询的想法不适合我，我想找到另一个解决方案。此外，这种算法还有一个缺点：另一端可以计算来自一个IP的如此多的DoS攻击请求，他们可以简单地禁止它。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任务2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在不同的HTTP代理中使用授权会话。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过HTTP代理时，您需要从“关闭的”页面接收信息，则需要授权cookie。为此，通常会有一个标准的授权表单，其中包含一个登录名/密码对，并在cookie中设置会话ID。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是有一个问题，您无法访问HTTP代理中一项的另一项中的数据来替换Header中的该值。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有一个“ Web场景”，它有另一个限制，它不允许接收内容进行分析和进一步存储。您只能检查页面上是否存在必要的变量，或者在Web脚本的步骤之间传递先前获得的变量。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在对这些任务进行了一点思考之后，我决定使用在监视系统的任何部分中都完全可见的宏：在模板，主机，触发器或项目中。</font><font style="vertical-align: inherit;">宏可以通过Web界面API进行更新。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbix具有良好而详细的API文档。</font><font style="vertical-align: inherit;">要通过api交换数据，请使用Json数据格式。</font><font style="vertical-align: inherit;">详细信息可以在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">官方文档中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下图显示了获取所需数据并将其记录在宏中的操作顺序。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xj/of/h-/xjofh-pgwt34jl-vwzzrhhe8fly.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">步骤1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一步可能包含一个动作或多个动作。</font><font style="vertical-align: inherit;">在第一步中，奠定了所有基本逻辑，而主要的是最后三步。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我的示例中，第一步是在PBX上获取第一个任务的授权cookie。</font><font style="vertical-align: inherit;">对于第二项任务，我获得了当前Mikrotik固件版本的编号。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当前Mikrotik固件版本的URL</font></font></b>
                        <div class="spoiler_text"><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">upgrade.mikrotik.com/routeros/LATEST.6-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当前稳定版本的URL</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">upgrade.mikrotik.com/routeros/LATEST.6fix</a> — URL   LTS </li>
</ul><br>
      Mikrotik,      .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一步对于每种情况都是完全独立的，其工作逻辑可能会有所不同。</font><font style="vertical-align: inherit;">这完全取决于您的任务。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用Web脚本时，请跟踪需要哪种方法来获取响应。</font><font style="vertical-align: inherit;">HTTP响应</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标头</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">还是</font><font style="vertical-align: inherit;">没有标头</font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">响应</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主体</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本身</font><font style="vertical-align: inherit;">？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果需要授权cookie，则</font><font style="vertical-align: inherit;">像Asterisk一样</font><font style="vertical-align: inherit;">设置</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Headers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">响应方法</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您需要数据（与mikrotik服务器的</font><font style="vertical-align: inherit;">响应一样）</font><font style="vertical-align: inherit;">，请将</font><font style="vertical-align: inherit;">响应</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正文</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不带标题。</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2步</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们进入第二步。</font><font style="vertical-align: inherit;">获取授权会话：</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">POST</span> http://company.com/zabbix/api_jsonrpc.php HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><font></font>
Content-Type: application/json-rpc<font></font>
<font></font>
{<font></font>
    "jsonrpc": "2.0",<font></font>
    "method": "user.login",<font></font>
    "params": {<font></font>
        "user": "Admin"<font></font>
        "password": "zabbix"<font></font>
    },<font></font>
    "id": 1,<font></font>
    "auth": <span class="hljs-attribute">null</span>
}</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jsonrpc是所使用的JSON-RPC协议的版本；</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zabbix实现JSON-RPC版本2.0；</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method-被调用的方法；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">params-方法传递的参数；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id-任意请求标识符；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auth-用户认证密钥；</font><font style="vertical-align: inherit;">就像我们还没有一样，我们将其设置为null。</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了使用API​​，我创建了一个具有有限权限的单独帐户。首先，您不需要访问不需要的位置。其次，在版本5.0之前，可以读取通过宏指定的密码。因此，如果使用Zabbix管理员密码，则很容易盗用该管理员帐户。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当通过第三方脚本使用API​​并在侧面存储凭据时，尤其如此。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从5.0版开始，出现了隐藏保存在宏中的密码的选项。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/26/y5/pr/26y5pr4auyxr1cszmm4xzfsswv4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当创建用于通过API更新数据的单独帐户时，请确保检查所需的数据是否可通过Web界面获得，以及是否可以更新。我没有检查，然后很长一段时间我不明白为什么API看不到我需要的宏。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hb/wp/xp/hbwpxpunvf_aji_5pbnlx0ao4xw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您在API中获得授权后，我们将继续获取宏列表。 </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第三步</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
API不允许按名称更新主机宏，为此，您需要首先获取宏ID。</font><font style="vertical-align: inherit;">此外，要获取特定主机的宏列表，您需要找出该主机的ID，这是一个额外的请求。</font><font style="vertical-align: inherit;">您</font><font style="vertical-align: inherit;">不能在请求中</font><font style="vertical-align: inherit;">使用常规宏</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{HOST.ID}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该限制决定解决此问题：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/va/1d/qava1dngv9wr_wmydwyw-wmb030.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我使用该主机的ID创建了一个本地宏。</font><font style="vertical-align: inherit;">从Web界面中查找主机ID非常容易。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
带有给定主机的所有宏列表的响应可以通过模板进行过滤：</font></font><br>
<br>
<pre><code class="perl hljs">regex:{<span class="hljs-string">"hostmacroid"</span>:<span class="hljs-string">"([0-9]+)"</span>[A-z<span class="hljs-number">0</span>-<span class="hljs-number">9</span>,<span class="hljs-string">":]+"</span>{\$MIKROTIK_VERSION}<span class="hljs-string">"</span></code></pre><br>
<img src="https://habrastorage.org/webt/vg/9q/od/vg9qod-ek9z0rdxyeuszidxvy6e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们获得了所需宏的ID，其中</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIKROTIK_VERSION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是我们要查找的宏的名称。</font><font style="vertical-align: inherit;">就我而言，它搜索</font><font style="vertical-align: inherit;">已分配给主机</font><font style="vertical-align: inherit;">的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIKROTIK_VERSION</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宏</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请求本身看起来像这样：</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">POST</span> http://company.com/zabbix/api_jsonrpc.php HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><font></font>
Content-Type: application/json-rpc<font></font>
<font></font>
{<font></font>
    "jsonrpc":"2.0",<font></font>
    "method":"usermacro.get",<font></font>
    "params":{<font></font>
        "output":"extend",<font></font>
        "hostids":"{$HOST_ID}"<font></font>
    },<font></font>
    "auth":"{sid}",<font></font>
    "id":1<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
变量</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{sid}是</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第二步中获得的，将在需要使用API​​接口的地方不断使用。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后4步-宏更新</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们知道需要更新的宏ID，授权cookie或路由器的固件版本。</font><font style="vertical-align: inherit;">您可以更新宏本身。</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">POST</span> http://company.com/zabbix/api_jsonrpc.php HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><font></font>
Content-Type: application/json-rpc<font></font>
<font></font>
{<font></font>
    "jsonrpc":"2.0",<font></font>
    "method":"usermacro.update",<font></font>
    "params":{<font></font>
        "hostmacroid":"{hostmacroid}",<font></font>
        "value":"{mikrotik_version}"<font></font>
    },<font></font>
    "auth":"{sid}",<font></font>
    "id":1<font></font>
}<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{mikrotik_version}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -第一步中获得的值。</font><font style="vertical-align: inherit;">在我的示例中-当前固件的版本mikrotik </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{hostmacroid}</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -该值是在第三步-我们更新的宏ID中获得的。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发现</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用常规功能来解决问题的方法要复杂得多且更长。</font><font style="vertical-align: inherit;">特别是如果您了解编程并且可以快速在脚本中抛出必要的逻辑。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种方法的明显优势是解决方案在不同服务器之间的“可移植性”。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就我个人而言，这很奇怪，因为我无法访问HTTP代理中另一个项目的数据，并且无法在请求正文或标头中替换它[ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZBXNEXT-5993</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完成的模板可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在GitHub上下载</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN507234/index.html">Snort或Suricata。第2部分：Suricata的安装和初始设置</a></li>
<li><a href="../zh-CN507236/index.html">我们提高了设计师与前端开发人员之间互动的效率</a></li>
<li><a href="../zh-CN507238/index.html">我们使用DS处理来自大型网站的客户评论</a></li>
<li><a href="../zh-CN507242/index.html">华为性能中有趣的Wi-Fi 6</a></li>
<li><a href="../zh-CN507250/index.html">使用map / reduce在JavaScript中定义成功的扑克手</a></li>
<li><a href="../zh-CN507256/index.html">Peter Hinchens：精神病患者源代码</a></li>
<li><a href="../zh-CN507258/index.html">IT的奖金，收益和奖金：Habr Career研究的结果</a></li>
<li><a href="../zh-CN507260/index.html">用于应用程序增长的快速Lifehack-其他语言的ASO</a></li>
<li><a href="../zh-CN507264/index.html">Python 3.9的新功能</a></li>
<li><a href="../zh-CN507270/index.html">选择项目的依存关系</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>