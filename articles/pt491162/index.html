<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤳🏽 👩🏼‍🍳 👼 Antipadrões do PostgreSQL: um conto sobre o refinamento iterativo da pesquisa por nome ou “Otimização para frente e para trás” 🆙 💃🏾 🚨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Milhares de gerentes de escritórios de vendas em todo o país registram dezenas de milhares de contatos em nosso sistema de CRM  todos os dias - fatos ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Antipadrões do PostgreSQL: um conto sobre o refinamento iterativo da pesquisa por nome ou “Otimização para frente e para trás”</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/491162/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Milhares de gerentes de escritórios de vendas em todo o país registram </font><b><font style="vertical-align: inherit;">dezenas de milhares de contatos</font></b><font style="vertical-align: inherit;"> em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nosso sistema de CRM </font></font></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos os dias</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fatos de comunicação com clientes em potencial ou que já trabalham conosco. E para esse cliente, você deve primeiro encontrar, e de preferência muito rapidamente. E isso acontece com mais frequência pelo nome. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, não surpreende que, mais uma vez analisando solicitações "pesadas" em um dos bancos de dados mais carregados - nossa própria </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conta VLSI corporativa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , encontrei "no topo" uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitação de uma pesquisa "rápida" por nome</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de cartões de empresa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, uma investigação adicional revelou um exemplo interessante de </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otimização e, em seguida, degradação do desempenho</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pedido em seu refinamento subsequente por várias equipes, cada uma das quais agiu unicamente de bem-intencionado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0: o que o usuário queria</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/du/k9/mg/duk9mgzeofw0ka5_lrg8lewch7k.png"></div><font color="#c0c0c0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[KDPV a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partir daqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]</font></font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
O que o usuário geralmente quer dizer quando diz "pesquisa rápida" por nome? </font><font style="vertical-align: inherit;">Quase nunca acaba sendo uma pesquisa "honesta" em uma substring do tipo </font></font><code>... LIKE '%%'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- porque, então, não apenas </font><font style="vertical-align: inherit;">e </font><font style="vertical-align: inherit;">, mas </font><font style="vertical-align: inherit;">até mesmo </font><font style="vertical-align: inherit;">obtém o resultado </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
O usuário implica, no nível doméstico, que você forneça a ele uma </font><b><font style="vertical-align: inherit;">pesquisa no início de uma palavra</font></b><font style="vertical-align: inherit;"> no título e mostre mais relevante o que </font><b><font style="vertical-align: inherit;">começa com a</font></b><font style="vertical-align: inherit;"> entrada. </font><font style="vertical-align: inherit;">E faça isso </font><b><font style="vertical-align: inherit;">quase instantaneamente</font></b><font style="vertical-align: inherit;"> - com entrada interlinear.</font></font><code>'<u></u>'</code><font style="vertical-align: inherit;"></font><code>' <u></u>'</code><font style="vertical-align: inherit;"></font><code>'<u></u>'</code><font style="vertical-align: inherit;"></font><code>'  <u></u>'</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1: limitar a tarefa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ainda mais, uma pessoa não entra especificamente </font></font><code>' '</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que você tenha que procurar por cada prefixo de palavra. </font><font style="vertical-align: inherit;">Não, é muito mais fácil para o usuário responder a uma dica rápida da última palavra do que deliberadamente "errar" as anteriores - veja como funciona qualquer mecanismo de pesquisa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, </font><font style="vertical-align: inherit;">formular </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corretamente os</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> requisitos para uma tarefa é mais da metade da solução. </font><font style="vertical-align: inherit;">Às vezes, uma análise cuidadosa do caso de uso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode afetar significativamente o resultado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que o desenvolvedor abstrato faz?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.0: mecanismo de pesquisa externo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh, pesquisar é difícil, não quero fazer nada - vamos dar aos devops! </font><font style="vertical-align: inherit;">Deixe-os implantar para nós um mecanismo de pesquisa externo em relação ao banco de dados: Sphinx, ElasticSearch, ... Uma opção </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
funcional, embora demorada, em termos de sincronização e velocidade da mudança. </font><font style="vertical-align: inherit;">Mas não no nosso caso, uma vez que a pesquisa é realizada para cada cliente apenas dentro da estrutura dos dados de sua conta. </font><font style="vertical-align: inherit;">E os dados têm uma variabilidade bastante alta - e se o gerente inseriu o cartão </font></font><code>' '</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, depois de 5 a 10 segundos, ele já se lembra de que esqueceu de indicar o e-mail e deseja encontrá-lo e corrigi-lo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto - vamos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">procurar "diretamente no banco de dados"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Felizmente, o PostgreSQL nos permite fazer isso, e não apenas uma opção - nós as consideraremos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1: substring "honesto"</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos apegamos à palavra "substring". </font><font style="vertical-align: inherit;">Mas exatamente para pesquisa de índice por substring (e até por expressões regulares!) Existe um excelente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">módulo pg_trgm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Somente então será necessário classificar corretamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos tentar pegar uma placa para simplificar o modelo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> firms(
  <span class="hljs-keyword">id</span>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">text</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nós preenchemos lá 7,8 milhões de registros de organizações reais e indexamos:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> EXTENSION pg_trgm;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms <span class="hljs-keyword">USING</span> gin(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) gin_trgm_ops);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos procurar as 10 primeiras entradas para a pesquisa entre linhas:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'(^|\s)'</span> || <span class="hljs-string">''</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--  " "</span>
, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;
</code></pre><br>
<img src="https://habrastorage.org/webt/0m/pk/su/0mpksuspk5xdasdj7mtg5ch4jvw.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[dê uma olhada em explica.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Bem, são 26 </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ms, 31 MB de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dados lidos e mais de </font><i><b><font style="vertical-align: inherit;">1,7 mil</font></b></i><font style="vertical-align: inherit;"> registros filtrados - para 10 pessoas. </font><font style="vertical-align: inherit;">A sobrecarga é muito alta, é possível ser de alguma forma mais eficiente?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2: pesquisa de texto? </font><font style="vertical-align: inherit;">é STF!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, o PostgreSQL fornece um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mecanismo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muito poderoso </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">para a pesquisa de texto completo</font></a><font style="vertical-align: inherit;"> ( </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Pesquisa de texto</font></a><font style="vertical-align: inherit;"> completo), incluindo a possibilidade de pesquisa de prefixo. </font><font style="vertical-align: inherit;">Uma ótima opção, mesmo as extensões não precisam ser instaladas! </font><font style="vertical-align: inherit;">Vamos tentar:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms <span class="hljs-keyword">USING</span> gin(to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)));</code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)) @@ to_tsquery(<span class="hljs-string">'simple'</span>, <span class="hljs-string">':*'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span>
, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/wd/ln/tq/wdlntqgqo_zvb4sbhcq-wln_jrw.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[olhada explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Aqui paralelização de execução da consulta nos ajudou um pouco, reduzindo o tempo pela metade, para </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11 ms</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sim, e tivemos que ler 1,5 vezes menos - apenas </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20 MB</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">E aqui, quanto menor, melhor, porque quanto maior a quantidade que subtraímos, maiores as chances de perda de cache e cada página de dados extra lida em disco é um "freio" em potencial para a solicitação.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3: Ainda gosta?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solicitação anterior é boa para todos, mas somente se você a extrair centenas de milhares de vezes por dia, </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 TB de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dados </font><i><b><font style="vertical-align: inherit;">de</font></b></i><font style="vertical-align: inherit;"> leitura </font><font style="vertical-align: inherit;">serão executados </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Na melhor das hipóteses - a partir da memória, mas se você não tiver sorte, então a partir do disco. </font><font style="vertical-align: inherit;">Então, vamos tentar torná-lo menor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lembre-se de que o usuário deseja ver </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeiro "que começa com ..."</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, esta é, na sua forma pura, uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pesquisa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">prefixo</font></a></font><code>text_pattern_ops</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">E somente se "não for suficiente" até 10 registros necessários, teremos que lê-los usando a pesquisa do STF:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) text_pattern_ops);</code></pre><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/_7/e_/jx/_7e_jxpnkc7n97e9rj2rbbk2ukq.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[veja em explan.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Excelente desempenho - apenas </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,05ms e um pouco mais de 100 KB de</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> leitura! </font><font style="vertical-align: inherit;">Só nos esquecemos de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">classificar por nome</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para que o usuário não se perca nos resultados:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ku/d4/r1/kud4r1oipobzbsljhvbavzd2ypa.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[veja explan.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ah, algo não é mais tão bonito - parece que existe um índice, mas a classificação passa por ele ... É claro que já é várias vezes mais eficaz que a versão anterior, mas ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4: “modificar com um arquivo”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas há um índice que permite pesquisar por faixa e é normal usar a classificação - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">btree normal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> firms(<span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Somente uma solicitação para isso terá que ser "montada manualmente":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &gt;= <span class="hljs-string">''</span> <span class="hljs-keyword">AND</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &lt;= (<span class="hljs-string">''</span> || <span class="hljs-keyword">chr</span>(<span class="hljs-number">65535</span>)) <span class="hljs-comment">--  UTF8,   - chr(255)</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
   <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/eh/o3/-i/eho3-irvjqbcpgpmmp7fuheb9nm.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[veja explan.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ótimo - tanto a triagem quanto o consumo de recursos permanecem "microscópicos", </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">milhares de vezes mais eficientes que o STF "puro"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Resta coletar em uma única solicitação:</font></font><br>
<br>
<pre><code class="sql hljs">(
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    firms<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &gt;= <span class="hljs-string">''</span> <span class="hljs-keyword">AND</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) &lt;= (<span class="hljs-string">''</span> || <span class="hljs-keyword">chr</span>(<span class="hljs-number">65535</span>)) <span class="hljs-comment">--  UTF8,    - chr(255)</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
     <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
(<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    firms<font></font>
  <span class="hljs-keyword">WHERE</span>
    to_tsvector(<span class="hljs-string">'simple'</span>::regconfig, <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)) @@ to_tsquery(<span class="hljs-string">'simple'</span>, <span class="hljs-string">':*'</span>) <span class="hljs-keyword">AND</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>) <span class="hljs-comment">-- " "    </span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) ~ (<span class="hljs-string">'^'</span> || <span class="hljs-string">''</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--    ,     btree-</span>
  , <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>)
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observo que a segunda subconsulta é executada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apenas se a primeira retornar menos do que o</font></font></b><font style="vertical-align: inherit;"></font><code>LIMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> número de linhas </font><b><font style="vertical-align: inherit;">esperado pela</font></b><font style="vertical-align: inherit;"> última </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">já escrevi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre esse método de otimização de consultas </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então, sim, agora temos btree e gin na mesa ao mesmo tempo, mas estatisticamente aconteceu que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menos de 10% das solicitações atingem o segundo bloco</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ou seja, com tais limitações típicas conhecidas para a tarefa, conseguimos reduzir o consumo total de recursos do servidor em quase mil vezes!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 *: dispensar o arquivo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acima </font></font><code>LIKE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, fomos impedidos de usar o tipo errado. </font><font style="vertical-align: inherit;">Mas pode ser "definido no caminho verdadeiro" especificando a instrução USING:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O padrão está implícito </font></font><code>ASC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Além disso, você pode especificar o nome de um operador de classificação específico em uma frase </font></font><code>USING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O operador de classificação deve ser um membro menor ou maior que uma determinada família de operadores de árvore B. </font></font><code>ASC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geralmente equivalente </font></font><code>USING &lt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>DESC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">geralmente equivalente </font></font><code>USING &gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No nosso caso, "menos" é </font></font><code>~&lt;~</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  firms<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">LIKE</span> (<span class="hljs-string">''</span> || <span class="hljs-string">'%'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-keyword">lower</span>(<span class="hljs-keyword">name</span>) <span class="hljs-keyword">USING</span> ~&lt;~
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/s8/6r/4u/s86r4ujfiklgl9rqwn0fl7_g44i.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[veja em explicar.tensor.ru]</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2: como "azedar" solicitações</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora deixamos nosso pedido de "insistir" por meio ano ou um ano e, com surpresa, novamente o encontramos "no topo" com indicadores do total de "bombeamento" diário de memória ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buffers compartilhados</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5,5 TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ou seja, ainda mais do que era originalmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não, é claro, nosso negócio cresceu e a carga aumentou, mas não tanto! </font><font style="vertical-align: inherit;">Então, algo está sujo aqui - vamos descobrir.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1: o nascimento da paginação</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em algum momento, outra equipe de desenvolvimento queria tornar possível “pular” no registro a partir de uma pesquisa rápida de subscrito com os mesmos resultados, mas ampliados. </font><font style="vertical-align: inherit;">E qual registro sem navegação na página? </font><font style="vertical-align: inherit;">Vamos estragar tudo!</font></font><br>
<br>
<pre><code class="sql hljs">( ... LIMIT &lt;N&gt; + 10)<font></font>
UNION ALL<font></font>
( ... LIMIT &lt;N&gt; + 10)<font></font>
LIMIT 10 OFFSET &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora era possível, sem esforço, que o desenvolvedor mostrasse o registro dos resultados da pesquisa com o carregamento de "página de tipo". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certamente, de fato, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para cada página seguinte de dados, cada vez mais está sendo lida</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (o tempo todo, que descartamos, mais a “cauda” desejada) - isto é, este é um antipadrão inequívoco. </font><font style="vertical-align: inherit;">E seria mais correto iniciar a pesquisa na próxima iteração a partir da chave armazenada na interface, mas sobre isso - outra vez.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2: quer exótico</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em algum momento, o desenvolvedor quis </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diversificar a seleção resultante com dados</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de outra tabela, para qual finalidade toda a solicitação anterior foi enviada ao CTE:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> q <span class="hljs-keyword">AS</span> (<font></font>
  ...<font></font>
  <span class="hljs-keyword">LIMIT</span> &lt;N&gt; + <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
, (<span class="hljs-keyword">SELECT</span> ...) sub_query <span class="hljs-comment">-- -    </span>
<span class="hljs-keyword">FROM</span><font></font>
  q<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E mesmo assim - nada mal, porque uma subconsulta é calculada apenas para 10 registros retornados, se não ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3: DISTINTA sem sentido e sem piedade</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em algum lugar do processo dessa evolução, uma </font><b><font style="vertical-align: inherit;">condição foi </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perdida</font></font><code>NOT LIKE</code><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na 2ª subconsulta </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">É claro que depois disso </font></font><code>UNION ALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comecei a retornar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alguns registros duas vezes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - primeiro encontrados no início da linha e depois novamente - no início da primeira palavra dessa linha. </font><font style="vertical-align: inherit;">No limite, todos os registros da 2ª subconsulta podem coincidir com os registros da primeira. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que um desenvolvedor faz em vez de procurar um motivo? .. Sem dúvida!</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dobrar o tamanho das</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> amostras originais</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coloque DISTINCT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para obter apenas instâncias únicas de cada linha</font></font></li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> q <span class="hljs-keyword">AS</span> (<font></font>
  ( ... <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span>)
  <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
  ( ... <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span>)
  <span class="hljs-keyword">LIMIT</span> &lt;<span class="hljs-number">2</span> * N&gt; + <span class="hljs-number">10</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span><font></font>
  *<font></font>
, (<span class="hljs-keyword">SELECT</span> ...) sub_query
<span class="hljs-keyword">FROM</span><font></font>
  q<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span> <span class="hljs-keyword">OFFSET</span> &lt;N&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, é claro que o resultado, no final, é exatamente o mesmo, mas a chance de "voar" para a 2ª subconsulta CTE se tornou muito maior e, sem isso, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é claramente lida mais</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas isso não é a coisa mais triste. </font><font style="vertical-align: inherit;">Como o desenvolvedor me pediu para selecionar, </font></font><b><code>DISTINCT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não por específico, mas imediatamente por todos os campos do</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> registro, o campo sub_query, o resultado da subconsulta, também chegou lá automaticamente. </font><font style="vertical-align: inherit;">Agora, para execução </font></font><code>DISTINCT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o banco de dados precisava executar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">não 10 subconsultas, mas todas &lt;2 * N&gt; + 10</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4: cooperação acima de tudo!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, os desenvolvedores viveram - eles não se incomodaram, porque no registro foram "corrigidos" para valores significativos de N com uma desaceleração crônica no recebimento de cada "página" seguinte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Até os desenvolvedores de outro departamento chegarem até eles e não desejarem usar um método tão conveniente </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para a pesquisa iterativa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ou seja, pegamos um pedaço de alguma amostra, filtramos por condições adicionais, desenhamos o resultado e depois o próximo (que, no nosso caso, é alcançado por aumentar N) e assim sucessivamente até preenchermos a tela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, no espécime capturado, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N atingiu valores de quase 17K</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e em apenas 24 horas pelo menos 4K esses pedidos foram executados “na cadeia”. </font><font style="vertical-align: inherit;">O último deles já audaciosamente digitalizado</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 GB de memória a cada iteração</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ...</font></font><br>
<br>
<h2></h2><br>
<img src="https://habrastorage.org/webt/zt/yx/ss/ztyxssr661ga_wndmpmqmvgtrq0.png"></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt491138/index.html">Integração via satélite e torre Ansible</a></li>
<li><a href="../pt491146/index.html">UML para desenvolvedores</a></li>
<li><a href="../pt491150/index.html">Como eu invadi os golpistas ou apenas o interior dos painéis de phishing</a></li>
<li><a href="../pt491154/index.html">Pesquisa de curso: como construir um caminho de aprendizado</a></li>
<li><a href="../pt491156/index.html">Empatia mensurável: predizer simpatia pela ressonância magnética cerebral</a></li>
<li><a href="../pt491164/index.html">Como programador escreve um diploma. Guia completo</a></li>
<li><a href="../pt491170/index.html">Como o Amplifer usa o Logux - uma ferramenta para comunicação entre cliente e servidor</a></li>
<li><a href="../pt491172/index.html">Quando um desenvolvedor front-end deve mudar do React para o Vue e quando isso complicará o desenvolvimento</a></li>
<li><a href="../pt491174/index.html">Não escreva a mesma coisa: como os componentes reutilizáveis ​​do React ajudarão os desenvolvedores front-end a criar aplicativos mais rapidamente</a></li>
<li><a href="../pt491176/index.html">5 sinais de um produto de TI a ser vendido</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>