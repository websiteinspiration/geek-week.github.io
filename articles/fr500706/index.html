<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😖 🔝 🙌🏿 Mise à niveau de MySQL (Percona Server) de 5.7 à 8.0 💥 🤨 🤲🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les progrès ne sont pas immobiles, les raisons de la mise à niveau vers les dernières versions de MySQL deviennent de plus en plus importantes. Il n'y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mise à niveau de MySQL (Percona Server) de 5.7 à 8.0</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/500706/"><img src="https://habrastorage.org/webt/gr/ty/r9/grtyr9g5ysbgx9woi8ldfpn91ac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les progrès ne sont pas immobiles, les raisons de la mise à niveau vers les dernières versions de MySQL deviennent de plus en plus importantes. </font><font style="vertical-align: inherit;">Il n'y a pas si longtemps, dans l'un de nos projets, il était temps de mettre à niveau les clusters confortables de Percona Server 5.7 vers la version 8. </font><font style="vertical-align: inherit;">Tout cela s'est passé sur la plate-forme Ubuntu Linux 16.04. </font><font style="vertical-align: inherit;">Comment effectuer une opération similaire avec un temps d'arrêt minimal et quels problèmes nous avons rencontrés lors de la mise à niveau - lisez cet article.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entraînement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toute mise à jour du serveur de base de données est très probablement liée à la migration de la base de données: changements dans les exigences de limites sur les ressources système et la correction des configurations de base de données, qui doivent être débarrassées des directives obsolètes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant la mise à jour, nous allons certainement nous tourner vers la documentation officielle:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notes de version de MySQL 8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guide de mise à niveau depuis MySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guide de mise à niveau de Percona</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tutoriel MySQL sur la mise à jour des répliques et des assistants</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et faites un plan d'action:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Corrigez les fichiers de configuration en supprimant les directives obsolètes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vérifiez la compatibilité avec les utilitaires.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mettez à jour les bases de données esclaves en installant le package </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mettez à jour l'assistant en mettant le même package.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous analyserons chaque élément du plan et verrons ce qui peut mal tourner. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMPORTANT! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La procédure de mise à niveau du cluster MySQL basée sur Galera a ses propres subtilités qui ne sont pas décrites dans l'article. </font><font style="vertical-align: inherit;">Vous ne devez pas utiliser cette instruction dans ce cas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 1: Vérification des configurations</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la version 8, MySQL a été supprimé </font></font><code>query_cache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En fait, il a été </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déclaré obsolète</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la version 5.7, mais il est maintenant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complètement supprimé</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En conséquence, il est nécessaire de supprimer les directives connexes. </font><font style="vertical-align: inherit;">Et pour la mise en cache des requêtes, vous pouvez désormais utiliser des outils externes - par exemple, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des directives pro obsolètes ont également été trouvées dans la configuration </font></font><code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si dans MySQL 5.7 il était possible de sélectionner le format InnoDB, alors la 8ème version </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fonctionne déjà </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">qu'avec le format Barracuda</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre résultat est la suppression des directives suivantes:</font></font><br>
<br>
<ul>
<li> <code>query_cache_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>query_cache_limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>query_cache_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>innodb_file_format_max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour vérification, nous utiliserons l'image Docker de Percona Server. </font><font style="vertical-align: inherit;">Nous allons mettre la configuration du serveur dans le répertoire </font></font><code>mysql_config_test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et créer ensuite les répertoires pour les données et les journaux. </font><font style="vertical-align: inherit;">Exemple de test de configuration de percona-server:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p {mysql_config_test,mysql_data,mysql_logs}<font></font>
cp -r /etc/mysql/conf.d/* mysql_config_test/<font></font>
docker run  --name some-percona -v $(<span class="hljs-built_in">pwd</span>)/mysql_config_test:/etc/my.cnf.d/  -v $(<span class="hljs-built_in">pwd</span>)/mysql_data/:/var/lib/mysql/ -v $(<span class="hljs-built_in">pwd</span>)/mysql_logs/:/var/<span class="hljs-built_in">log</span>/mysql/ -e MYSQL_ROOT_PASSWORD=<span class="hljs-variable">${MYSQL_PASSWORD}</span> -d percona:8-centos</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Résultat: soit dans les journaux Docker, soit dans le répertoire avec les journaux - selon vos configurations - un fichier apparaîtra dans lequel les directives du problème seront décrites. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici ce que nous avions:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-03T12:44:19.670831Z 0 [Warning] [MY-011068] [Server] The syntax 'expire-logs-days' is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.<font></font>
2020-04-03T12:44:19.671678Z 0 [Warning] [MY-013242] [Server] --character-set-server: 'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.<font></font>
2020-04-03T12:44:19.671682Z 0 [Warning] [MY-013244] [Server] --collation-server: 'utf8_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous devions encore gérer les encodages et remplacer la directive obsolète </font></font><code>expire-logs-days</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 2: Vérification des installations en cours d'exécution</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe 2 utilitaires dans la documentation de mise à jour pour vérifier la compatibilité de la base de données. </font><font style="vertical-align: inherit;">Leur utilisation aide l'administrateur à vérifier la compatibilité de la structure de données existante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par l'utilitaire classique mysqlcheck. </font><font style="vertical-align: inherit;">Exécutez simplement:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlcheck -u root -p --all-databases --check-upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si aucun problème n'est détecté, l'utilitaire se fermera avec le code 0: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/f-/yk/xcf-yknfyh2puesxjqupkstv_qo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, l'utilitaire </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql-shell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est disponible dans les versions modernes de MySQL </font><font style="vertical-align: inherit;">(dans le cas de Percona, il s'agit d'un package </font></font><code>percona-mysql-shell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Il remplace le client mysql classique et combine les fonctions du client, de l'éditeur SQL et des outils d'administration MySQL. Pour vérifier le serveur avant la mise à jour, vous pouvez exécuter les commandes suivantes via celui-ci:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlsh -- util check-for-server-upgrade { --user=root --host=1.1.1.1 --port=3306 } --config-path=/etc/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici les commentaires que nous avons reçus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o_/nd/r5/o_ndr55tsfxrr0gbbu7zgala-vu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, rien de critique - juste des avertissements sur les encodages </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(voir ci-dessous)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le résultat global de l'implémentation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/uy/xc/afuyxccks5gfu2w2bl1pgruvv-8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nous avons décidé que la mise à jour se passerait sans problème. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une note sur les avertissements ci-dessus qui indiquent des problèmes d'encodage. </font><font style="vertical-align: inherit;">Le fait est que UTF-8 dans MySQL jusqu'à récemment n'était </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas un "vrai" UTF-8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car il ne stockait que 3 octets au lieu de 4. Dans MySQL 8, ils ont finalement </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">décidé de le corriger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : l'alias </font></font><code>utf8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conduira bientôt au codage </font></font><code>utf8mb4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et les anciens les colonnes dans les tableaux deviendront </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">À l'avenir, l'encodage </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sera supprimé, mais pas dans cette version. </font><font style="vertical-align: inherit;">Par conséquent, nous avons décidé de corriger les encodages déjà sur une installation de travail du SGBD, après l'avoir mise à jour.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partie 3: Mises à jour du serveur</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-ce qui peut mal tourner quand il y a un plan aussi chic? .. Bien conscient que les nuances se produisent toujours, nous avons mené la première expérience sur le dev-cluster MySQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme déjà mentionné, la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation officielle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> met en évidence le problème de la mise à jour des serveurs MySQL avec des répliques. L'essentiel est qu'au début, cela vaut la peine de mettre à jour toutes les répliques (esclaves), car MySQL 8 peut se répliquer à partir de l'assistant de la version 5.7. Une certaine difficulté réside dans le fait que nous utilisons le mode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maître &lt;-&gt; maître</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lorsque le maître distant est en mode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lecture seule</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En fait, le trafic de combat entre dans un centre de données et le second est une sauvegarde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La topologie est la suivante: la </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uw/kx/j0/uwkxj0bwhbtjxd27brnug5iosaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mise à niveau doit commencer avec les </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">répliques mysql replica dc 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql master dc 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><code>mysql replica dc 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et se retrouvant avec le serveur mysql master dc 1. Pour une meilleure fiabilité, nous avons arrêté les machines virtuelles, leur avons fait des instantanés et arrêté la réplication avec la commande juste avant la mise à jour </font></font><code>STOP SLAVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le reste de la mise à jour ressemble à ceci:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chaque redémarrage réplique, en </font><font style="vertical-align: inherit;">ajoutant l'option de configuration 3: </font></font><code>skip-networking</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-slave-start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-log-bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le fait est que la mise à jour de la base de données génère des journaux binaires avec mise à jour des tables système. </font><font style="vertical-align: inherit;">Ces directives garantissent qu'aucune modification ne sera apportée aux données d'application dans la base de données et que les informations sur la mise à jour des tables système ne seront pas entrées dans les journaux binaires. </font><font style="vertical-align: inherit;">Cela évitera des problèmes lors de la reprise de la réplication.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installez le package </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est important de noter que dans MySQL 8, vous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'avez pas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> besoin d'exécuter la commande </font></font><code>mysqlupgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">après la mise à jour du serveur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Après un démarrage réussi, redémarrez le serveur à nouveau - déjà sans les paramètres qui ont été ajoutés dans le premier paragraphe.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous nous assurons que la réplication fonctionne correctement: nous vérifions </font></font><code>SHOW SLAVE STATUS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et voyons que les tables avec des compteurs dans la base de données d'application sont mises à jour.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela semble assez simple: la mise à jour du développeur a réussi. </font><font style="vertical-align: inherit;">Ok, vous pouvez planifier en toute sécurité une mise à niveau du jour au lendemain pour la production.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il n'y avait aucune tristesse - nous avons mis à jour prod</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, le transfert de l'expérience de développement réussie à la production n'était pas sans surprises. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, le processus de mise à jour lui-même commence par des répliques. Par conséquent, ayant rencontré des difficultés, nous avons arrêté le travail et restauré la réplique à partir de l'instantané. L'étude du problème a été reportée le lendemain matin. Les entrées suivantes sont apparues dans les journaux:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-01-14T21:43:21.500563Z 2 [ERROR] [MY-012069] [InnoDB] table: t1 has 19 columns but InnoDB dictionary has 20 columns<font></font>
2020-01-14T21:43:21.500722Z 2 [ERROR] [MY-010767] [Server] Error in fixing SE data for db1.t1<font></font>
2020-01-14T21:43:24.208365Z 0 [ERROR] [MY-010022] [Server] Failed to Populate DD tables.<font></font>
2020-01-14T21:43:24.208658Z 0 [ERROR] [MY-010119] [Server] Aborting</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une étude des archives de diverses listes de diffusion sur Google a permis de comprendre qu'un tel problème se produit en raison d'un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bogue MySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Bien que ce soit même un bug utilitaire </font></font><code>mysqlcheck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>mysqlsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'avère que MySQL a changé la façon dont les données sont présentées pour les champs décimaux (int, tinyint, etc.), donc une autre façon de les stocker est utilisée dans mysql-server. Si votre base de données </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">était à l'origine</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la version 5.5 ou 5.1, puis que vous avez effectué une mise à niveau vers 5.7, vous devrez peut-être produire </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des tables. Ensuite, MySQL mettra à jour les fichiers de données, les transférant au format de stockage actuel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez également vérifier cela avec l'utilitaire </font></font><code>mysqlfrm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlfrm --diagnostic -vv /var/lib/mysql/db/table.frm<font></font>
...<font></font>
 <span class="hljs-string">'field_length'</span>: 8,
  <span class="hljs-string">'field_type'</span>: 246, <span class="hljs-comment">#  </span>
  <span class="hljs-string">'field_type_name'</span>: <span class="hljs-string">'decimal'</span>,
  <span class="hljs-string">'flags'</span>: 3,
  <span class="hljs-string">'flags_extra'</span>: 67,
  <span class="hljs-string">'interval_nr'</span>: 0,
 <span class="hljs-string">'name'</span>: <span class="hljs-string">'you_deciaml_column'</span>,<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si </font></font><code>field_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous avez 0, l'ancien type est utilisé dans le tableau - cela doit être fait </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cependant, si la valeur est 246, vous avez déjà un nouveau type. Plus d'informations sur les types peuvent être trouvées dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce bogue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> considère la deuxième raison possible qui nous a contourné - le manque de tables InnoDB dans la table système </font></font><code>INNODB_SYS_TABLESPACES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, si elles, tables, ont été créées dans la version 5.1. Pour éviter les problèmes lors de la mise à niveau, vous pouvez utiliser le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script SQL joint</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi n'avons-nous pas eu de tels problèmes avec les développeurs? La base y est périodiquement copiée de la production - ainsi, les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tables sont recréées</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, sur une grande base de données vraiment fonctionnelle, elle ne fonctionnera pas uniquement pour prendre et exécuter l'omniprésente </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Percona-toolkit vous aidera ici: l'utilitaire pt-online-schema-change est excellent pour l'opération OPTIMIZE en ligne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le plan mis à jour était le suivant:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimisez toutes les tables.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Effectuez une mise à niveau de la base de données.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le vérifier et en même temps connaître l'heure de mise à jour, nous avons désactivé l'une des répliques et pour toutes les tables, nous avons exécuté la commande suivante:</font></font><br>
<br>
<pre><code class="bash hljs">pt-online-schema-change --critical-load Threads_running=150 --alter <span class="hljs-string">"ENGINE=InnoDB"</span> --execute --chunk-size 100 --quiet --alter-foreign-keys-method auto h=127.0.0.1,u=root,p=<span class="hljs-variable">${MYSQL_PASSWORD}</span>,D=db1,t=t1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les tables sont mises à jour sans longs verrous car l'utilitaire crée une nouvelle table temporaire dans laquelle il copie les données de la table principale. </font><font style="vertical-align: inherit;">Au moment où les deux tables sont identiques, la table d'origine est verrouillée et remplacée par une nouvelle. </font><font style="vertical-align: inherit;">Dans notre cas, un test a montré que la mise à jour de toutes les tables prendrait environ une journée, mais la copie des données causait trop de charge sur les disques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour éviter cela, lors de la production, nous avons ajouté un argument </font></font><code>--sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une valeur de 10 </font><font style="vertical-align: inherit;">à la commande </font><font style="vertical-align: inherit;">- ce paramètre contrôle la durée de l'attente après le transfert d'un paquet de données vers une nouvelle table. </font><font style="vertical-align: inherit;">De cette façon, vous pouvez réduire la charge si une application réellement en cours d'exécution demande du temps de réponse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir effectué l'optimisation, la mise à jour a réussi.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... mais pas complètement!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une demi-heure après la mise à jour, le client a rencontré un problème. </font><font style="vertical-align: inherit;">La base fonctionnait très étrangement: périodiquement, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des baisses de connexion</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> commençaient </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Voici à quoi cela ressemblait dans la surveillance: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hu/gn/7v/hugn7vq8clkacetlzfb-gli1bcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique en dents de scie est visible dans la capture d'écran, car une partie des threads du serveur MySQL tombait périodiquement avec une erreur. </font><font style="vertical-align: inherit;">Des erreurs sont apparues dans l'application:</font></font><br>
<br>
<pre><code class="plaintext hljs">[PDOException] SQLSTATE[HY000] [2002] Connection refused</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une inspection rapide des journaux a révélé que le démon mysqld n'a pas pu obtenir les ressources requises du système d'exploitation. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors du traitement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> des erreurs, nous avons trouvé dans les </font><b><font style="vertical-align: inherit;">fichiers de stratégie de l'apparmeur «orphelins» du système</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># dpkg -S /etc/apparmor.d/cache/usr.sbin.mysqld</span><font></font>
dpkg-query: no path found matching pattern /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/local/usr.sbin.mysqld</span>
dpkg-query: no path found matching pattern /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/usr.sbin.mysqld</span><font></font>
mysql-server-5.7: /etc/apparmor.d/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -l mysql-server-5.7</span>
rc  mysql-server-5.7 5.7.23-0ubuntu0.16.04.1      amd64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces fichiers ont été formés lors de la mise à niveau vers MySQL 5.7 il y a quelques années et appartiennent au package distant. </font><font style="vertical-align: inherit;">La suppression de fichiers et le redémarrage du service Apparmor ont résolu le problème:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl stop apparmor<font></font>
rm /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/usr.sbin.mysqld<font></font>
systemctl start apparmor</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finalement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'importe quelle opération, même la plus simple, peut entraîner des problèmes inattendus. </font><font style="vertical-align: inherit;">Et même avoir un plan bien pensé ne garantit pas toujours le résultat escompté. </font><font style="vertical-align: inherit;">Désormais, dans tous les plans de mise à jour, notre équipe inclut également le nettoyage obligatoire des fichiers supplémentaires qui pourraient apparaître à la suite d'actions récentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et avec ce travail graphique pas si professionnel, je voudrais remercier Percona pour ses excellents produits!</font></font><br>
<br>
<img height="75" width="75" src="https://habrastorage.org/webt/b1/af/mg/b1afmgyaozxjh0dqcbr3jrkdlk4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez aussi dans notre blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bases de données et Kubernetes (revue et reportage vidéo)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trucs et astuces de Kubernetes: accélérer le bootstrap des grandes bases de données</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">« </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 histoires pratiques de notre vie quotidienne SRE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> »;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    Redis  K8s  -      </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  MongoDB  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr500694/index.html">68 conseils non sollicités</a></li>
<li><a href="../fr500696/index.html">Comment les chaussures de course tentent de s'adapter au pied féminin</a></li>
<li><a href="../fr500698/index.html">Evgeny Katyshev: «OpenStreetMap ne convient à aucune information»</a></li>
<li><a href="../fr500700/index.html">Prise en charge de TLS1.3 et extension de votre compte personnel: ce qui a été fait pour le premier trimestre 2020</a></li>
<li><a href="../fr500704/index.html">Les licornes (Airbnb, Uber, Lyft, Careem) licencient des milliers d'employés en raison de problèmes lors de la pandémie de coronavirus</a></li>
<li><a href="../fr500708/index.html">Sécurité et SGBD: ce dont vous devez vous souvenir lors du choix des outils de protection</a></li>
<li><a href="../fr500712/index.html">Coronavirus numérique - une combinaison de ransomware et d'infostealer</a></li>
<li><a href="../fr500718/index.html">EPAM en mode distant: comment cela fonctionne</a></li>
<li><a href="../fr500720/index.html">Nouvelles normes de sécurité de l'information: rendre la vie plus difficile aux attaquants</a></li>
<li><a href="../fr500722/index.html">"Cuire jusqu'à ce que prêt": qui enregistre des enregistrements sur bande rares d'une manière si inhabituelle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>