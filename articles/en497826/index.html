<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñ≤Ô∏è ü§ôüèø üë¨ How to quickly capture the world or manage a network of windows computers using OPSI ü§¥üèª üì∞ üîû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Disclaimer: 
 The author loves short and straight crutches, and also gently adores free open software for the flexibility and scalability that it give...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to quickly capture the world or manage a network of windows computers using OPSI</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497826/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disclaimer: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The author loves short and straight crutches, and also gently adores free open software for the flexibility and scalability that it gives. </font><font style="vertical-align: inherit;">The purpose of this article is the desire to promote, as well as talk about the OPSI (Open PC Server Integration) software management system, undeservedly unknown on the Russian Internet.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was sitting in the office and drinking coffee when Ilon Mask called me and in pure Russian told me that it‚Äôs enough to endure it already, it‚Äôs time to collect the best minds to fight a certain virus, and for that right now, five minutes later I‚Äôm in 100 computers will be brought to the office, I urgently need to deploy windows 10, and tomorrow morning, scientists from all over the world will come to the office to start work on the antivirus. </font><font style="vertical-align: inherit;">Well, isn't that what I have been waiting for all my life? </font><font style="vertical-align: inherit;">A worthy challenge for a good tool.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To implement the plan, I will use the OPSI system - Open PC Server Integration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OPSI is written in python in Germany and, apparently, crutches, free of charge and scalability are also very fond of it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basic system features:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatic software deployment </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It works like this: you analyze the installer and make the opsi package out of it, which installs the program in the right way. </font><font style="vertical-align: inherit;">It works best with msi packages, it knows a few more formats that it also copes with. </font><font style="vertical-align: inherit;">It can run a bat file or powershell script, but in principle, any interpreter. </font><font style="vertical-align: inherit;">There are built-in registry systems, in general, full stuffing, probably the best part of the system.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatic installation of operating systems </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I use only installation from an image, as the fastest, but there are options with offline installation of the system from scratch.</font></font></li>
<li>   <br>
<br>
         ,          ,       ,      ,      windows.  ,   ,    windows,    ,          . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Several convenient management interfaces with the possibility of flexible integration </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a program with a graphical interface, there is an http interface to which you can send commands, from the server console you can control OPSI, embed commands in your scripts, you can access the backend from python, but I, unfortunately , while I do not own such magic.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support for multiple depot servers (servers containing directly the software from which the deployment is ongoing). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can add many servers to each subnet or group of computers, each of which will serve its own network.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
System features implemented by modules (there are free and paid modules):</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LDAP connector (paid) A </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
connector connecting a domain and opsi into a single whole</font></font></li>
<li>  ()<br>
<br>
     : , ...</li>
<li>MySQL  () <br>
<br>
  OPSI  mysql   ,  300 </li>
<li>Nagios  ()<br>
<br>
 </li>
<li>   ()<br>
<br>
 , opsi      ,   ,      .</li>
<li>    ()<br>
<br>
    .</li>
<li>  ()<br>
<br>
  ,   ,      ,  . ,    ansible  puppet,    .    linux  windows      .</li>
<li>WAN  ()<br>
<br>
        ,   . </li>
<li>   ()<br>
<br>
 </li>
<li>OTRS::ITSM  ()<br>
<br>
  </li>
<li>   ()<br>
<br>
 ,      ,            ,   ¬´   ¬ª,  ,  . </li>
</ol><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can learn more in detail here.The</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
monetization model they have is as follows: they sell modules until they collect the amount to make them free. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
While computers are brought into my office and assembled, I install the AD server on the Windows server, raise the domain domain.local on it, as well as DNS and DHCP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can install OPSI in the workgroup and in the domain, we will install in the domain, but without binding to the AD (LDAP connector).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will deploy windows 10 to a network of computers according to the following scheme: we will prepare a deployable windows 10 image with all the programs, boot over the network via opsi, use clonezilla to automatically save it to a file, then set all computers to automatically install via opsi, boot over the network and automatically we‚Äôll spill this file on all computers in the broadcast network segment via tftp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, on the DHCP server area, set parameter 66 in the ip of our future opsi 192.168.1.229 server </font></font><br>
<br>
<img src="https://habrastorage.org/webt/at/sl/hj/atslhjfu6ebadvwdih0bcdzzg2q.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and set parameter 67 to linux / pxelinux.0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In DNS, add opsiserver.domain.local under its static address 192.168.1.229</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we will create a virtual machine for our opsi server on iron, which will withstand your loads and will suit you in terms of speed. Ssd and several network cards are welcome. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Opsi does not support all systems; the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compatibility</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> list </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">can be found here</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We install immediately in the English locale, I strongly advise you not to use the Cyrillic alphabet anywhere on this server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My favorite debian 10 distribution I install in a minimal configuration with the name opsiserver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After installation and reboot, just in case, we configure the locales:</font></font><br>
<br>
<pre><code class="bash hljs">dpkg-reconfigure locales</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I select everything where there is de_ en_ and ru_ system leave en_US.UTF8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further installation is a retelling of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this tutorial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adapted to the task </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Change the server name if it is different from what we need:</font></font><br>
<br>
<pre><code class="bash hljs">hostname opsiserver.domain.local</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verification:</font></font><br>
<br>
<pre><code class="bash hljs">hostname -f</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's bring / etc / hosts to the following form:</font></font><br>
<br>
<pre><code class="plaintext hljs">127.0.0.1 localhost<font></font>
127.1.1.1 localhost.localdomain<font></font>
192.168.1.229 opsiserver.domain.local opsiserver</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we will forget about its existence forever, since opsi is demanding on the contents of this file, and when it is changed, it sometimes starts to rebel and sprinkle with errors. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install the required packages:</font></font><br>
<br>
<pre><code class="bash hljs">apt install wget host pigz mc -y</code></pre> <br>
<pre><code class="bash hljs">apt install samba samba-common smbclient cifs-utils -y </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We install the mysql server by default, maria-db gets up for me, it will work too.</font></font><br>
<br>
<pre><code class="bash hljs">apt install default-mysql-server -y</code></pre><br>
<pre><code class="bash hljs">sudo mysql_secure_installation</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We answer the questions in the affirmative, changing the root password and remembering it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add OPSI repositories to the system:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">echo</span> <span class="hljs-string">"deb http://download.opensuse.org/repositories/home:/uibmz:/opsi:/4.1:/stable/Debian_10/ /"</span> &gt; /etc/apt/sources.list.d/opsi.list</code></pre><br>
<pre><code class="bash hljs">wget -nv https://download.opensuse.org/repositories/home:uibmz:opsi:4.1:stable/Debian_10/Release.key -O Release.key<font></font>
apt-key add - &lt; Release.key</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Updated:</font></font><br>
<br>
<pre><code class="bash hljs">apt update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We remove tftpd if it is, since OPSI will conflict with it:</font></font><br>
<br>
<pre><code class="bash hljs">apt remove tftpd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We remove tftp support from inetd, because if it is, OPSI will conflict with it:</font></font><br>
<br>
<pre><code class="bash hljs">update-inetd --remove tftp<font></font>
apt install opsi-tftpd-hpa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And directly install opsi server:</font></font><br>
<br>
<pre><code class="bash hljs">apt install opsi-server</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in the process they will ask for the data that is needed to create a self-signed certificate, which in turn is needed for encrypted connection of clients with the server. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install windows support:</font></font><br>
<br>
<pre><code class="bash hljs">apt install opsi-windows-support</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
configure mysql backend:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-setup --configure-mysql</code></pre><br>
<img src="https://habrastorage.org/webt/b0/7g/zh/b07gzhpoteem9-pgzopqghvkmga.png" width="600" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We set the server address (localhost), the user from whom we are acting (root), the root password in mysql (which we remembered earlier), the name of the database for opsi (opsi), the name of the user who will work in this database (opsi), the password for this user (we invent new). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, for debian 10 you need to add / usr / sbin to PATH:</font></font><br>
<br>
<pre><code class="bash hljs">PATH=<span class="hljs-variable">$PATH</span>:/usr/sbin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and the same line should be added to .bashrc in your home directory. </font><font style="vertical-align: inherit;">If this is not done, in the next step you will get the error "chpasswd not found". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We initialize the system and set the necessary rights to the files and directories of the system:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-setup --init-current-config<font></font>
opsi-set-rights</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Service restart:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl restart opsiconfd.service<font></font>
systemctl restart opsipxeconfd.service</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configure samba:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-setup --auto-configure-samba</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OPSI clients connect to the main server via https on port 4447, and if you need to call some kind of installation, the clients will mount the samba ball from the opsi server and install software from it. </font><font style="vertical-align: inherit;">To make this possible, we allow OPSI to reconfigure samba. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Samba restart:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl restart smbd.service<font></font>
systemctl restart nmbd.service</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Set the administrator password for the pcpatch system user: </font></font><br>
<br>
<pre><code class="bash hljs">opsi-admin -d task setPcpatchPassword</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now create a user to administer the system:</font></font><br>
<br>
<pre><code class="bash hljs">useradd -m -s /bin/bash adminuser</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a password for him:</font></font><br>
<br>
<pre><code class="bash hljs">passwd adminuser</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the password for samba, I create the same as in the system:</font></font><br>
<br>
<pre><code class="bash hljs">smbpasswd -a adminuser</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add to the group:</font></font><br>
<br>
<pre><code class="bash hljs">usermod -aG pcpatch adminuser</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we will do something with OPSI under the root, then we need to add the root to the group:</font></font><br>
<br>
<pre><code class="bash hljs">usermod -aG pcpatch root</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A few more crutches:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-setup --patch-sudoers-file</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can download packages to the system, and while they are loading, drink coffee.</font></font><br>
<br>
<pre><code class="bash hljs">opsi-package-updater -v install</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Subsequently, the packages can be updated with the command:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-package-updater -v update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now go to </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://download.uib.de/opsi4.1/misc/helper/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , download and install the opsi-configed management interface from there to </font></font><br>
<br>
<code>opsi-configed-setup.exe</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
enter the server, enter the server address, our adminuser user and his password, </font></font><br>
<br>
<code>https://opsiserver.domain.local:4447/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and we are in the system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this point, the server is installed! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a-/yg/ft/a-ygftvat-_6wioezy6v7rmuszq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 - all clients connected to this server, they can be disassembled into groups, including nested ones, apply the assignment to the entire group at once. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 - a tab with clients, this is a list of those computers that are controlled by opsi </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 - clients are a list, here you can select them in any order to apply the purpose </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4 - ‚Äúproduct configuration‚Äù - a victim of translation. In fact, there are packages that can be installed in Windows, in the terminology opsi - localboot products</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5 - Netboot products - this is all that is downloaded over the network </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6 - opsi-mac-address - the computer‚Äôs poppy is what it is determined during network boot </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7 - opsiHostKey is the ‚Äúpassword‚Äù of the client in the opsi system, if you delete it from computer opsi client, and then reinstall it, it will not work, since the password will remain old and will not be suitable. This is both a bug and a feature. And how would you do? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we will prepare windows 10 image which we will spill. Clonezilla, which we will use, is not as good as the acronis, but it still knows how to spill the image from a smaller disk to the same or larger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We put in the system all the programs we need, as well as Remote Server Administration Tools for Windows 10. I have windows 10 1903, I installed for 1803 and everything that needs to be started up. You can download it from here:</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.microsoft.com/en-us/download/details.aspx?id=45520</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We need it for the netdom utility, which allows you to automatically enter the computer into the domain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we download files from here </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/valmont2k/renamejoin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the c: \ renamejoin directory. We create a domain administrator on the domain controller with the ability to only enter computers into the domain with the Joinadmin login with password password1234QWE. If an attacker intercepts this password, then he can only bring computers into our domain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run the line from createtesk.txt in the admin console of the fully prepared Windows, which will create a task to start at boot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The whole scheme will work as follows:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we split the image into all the computers, at the first boot, windows will launch a task </font></font><code>C:\renamejoin\step1.cmd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that renames the computer to </font></font><code>win-%random%</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, reboot the computer, deleting </font></font><code>C:\renamejoin\step1.cmd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and renaming </font></font><code>C:\renamejoin\step2.cmd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>C:\renamejoin\step1.cmd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. On the next boot, windows will start </font></font><code>C:\renamejoin\step1.cmd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which will enter this computer into the domain, reboot it and delete it </font></font><code>C:\renamejoin\step1.cmd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We can remove the potentially dangerous task from the domain computers later. Through OPSI of course! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ft/58/nn/ft58nnalinh1dzsqyx2clhilaym.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's time to convert the prepared Windows into an image.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Through the computer icon with a plus sign, add our computer to the opsi opsi-configed management interface, set its poppy address. </font><font style="vertical-align: inherit;">Save. </font><font style="vertical-align: inherit;">We pass to Netboot products, opposite clonezilla we put "setup". </font><font style="vertical-align: inherit;">In the configuration for the client, we expose everything as in the screenshot: the name of the file and the command by which we fill the entire disk into the image. </font><font style="vertical-align: inherit;">In the BIOS of the computer with Windows, we set the download from the network. </font><font style="vertical-align: inherit;">Reboot the comp. </font><font style="vertical-align: inherit;">If you did everything correctly, you will see how Windows flows into the image without the help of hands. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/zi/e6/wuzie6bgshbkngnutgpsqw9lfz0.png" width="500" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meanwhile, computers are assembled, but they need to be added as clients in opsi together with their poppy addresses, adding them with pens is not at all a boyar affair, right? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The solution is:</font></font><br>
<br>
<pre><code class="bash hljs">apt install tcpdump</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run on opsiserver:</font></font><br>
<br>
<pre><code class="bash hljs">tcpdump -n udp -vvvvv -e port 69 &gt; /var/<span class="hljs-built_in">log</span>/tftp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And, setting the BIOS settings for all computers to boot over the network (and at the same time wake up from PCI-E devices, over the network, you will understand why later), load them. If the blue window of the opsi boot menu appears during boot, </font></font><br>
<br>
<img src="https://habrastorage.org/webt/po/7c/h7/po7ch7eco5daftbhmaqr3fspcjs.png" width="500" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
then you are doing everything right. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When booting, computers access our server, tcpdump writes their poppy addresses to a file </font></font><code>/var/log/tftp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and using a repo script </font></font><code>https://github.com/valmont2k/opsi-hosts-importer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to run on opsiserver after all computers are marked in opsi and leave their poppy addresses there. This script uses the opsi API from here </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://download.uib.de/opsi4.1/experimental/documentation/html/opsi-api-documentation/opsi_API.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and a bit of magic. After starting it, you will have clients on opsiserver of the form win% random32% .domain.local</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to cast the windows image (which should have already been done) to all computers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yn/6g/ik/yn6gikht6l5aizhym_t839uk7mo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, select all the computers on which you need to install Windows and opposite clonezilla we set the values ‚Äã‚Äãas in the screenshot. You turn off the computers, then turn on several of them in turn and watch how Windows automatically rolls onto them, they themselves are renamed and entered into the domain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to automate this too, put etherwake and write a script that with a specified delay takes the mac-addresses from the / tmp / newmacs file and wakes up their hosts so that they take turns rolling Windows. See </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">update 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I made a gesture of Ronaldo from an advertisement for shampoo and was already packing for coffee when Ilon Mask again called on my phone and added:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Yes, I forgot to say, it is necessary that the </font></font><code>%program%</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">latest version be </font><font style="vertical-align: inherit;">on all computers tomorrow </font><font style="vertical-align: inherit;">, can you handle it? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Of course, everything will be tomorrow! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I can‚Äôt upset the idol of technocrats, so you need to put your brains back in your hands. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would be nice if at startup the computers set themselves an opsi client called opsi-client-agent. This can be done through domain group policies. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this to happen without entering a password during installation, you need to </font><font style="vertical-align: inherit;">
add the password of your user </font><font style="vertical-align: inherit;">in the </font><font style="vertical-align: inherit;">file </font></font><br>
<code>/var/lib/opsi/depot/opsi-client-agent/files/opsi/cfg/config.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on opsiserver </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as the value of service_hidden_password</font></font><code>adminuser</code><font style="vertical-align: inherit;"></font><code>base64</code><br>
<br>
<pre><code class="plaintext hljs">[installation]<font></font>
service_user=adminuser<font></font>
service_password=none<font></font>
service_hidden_password=base64HERE</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, add the group policy in the setupOPSI domain and take the script for it from here. </font></font><code>https://github.com/valmont2k/opsi-install-opsi-client-agent-over-active-directory-domain-policy</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remember to insert your values ‚Äã‚Äãin the script. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pi/bq/gr/pibqgrvntzwy6vlhvkwljjs4fki.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you did everything correctly, then at the first reboot in the domain, clients will install </font></font><code>opsi-client-agent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, reboot and appear under their names </font></font><code>win-%random%</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the OPSI management interface. </font><font style="vertical-align: inherit;">Old customers with the same poppy addresses can be deleted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can proceed to the installation </font></font><code>%program%</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We go here </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://forum.opsi.org/viewtopic.php?f=22&amp;t=7573</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and find a link to the package </font></font><code>*.opsi</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the name </font></font><code>packagebuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, something like </font></font><code>"opsi PackageBuilder Windows (opsi Paket)"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download the package to the directory </font></font><code>/var/lib/opsi/workbench</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on opsiserver</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /var/lib/opsi/workbench</code></pre><br>
<pre><code class="bash hljs">wget https://opsipackagebuilder.s3.amazonaws.com/opsiPackageBuilder/python/opsipackagebuilder_8.4.4-1.opsi </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and install it:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-package-manager -d ALL -i opsipackagebuilder_8.4.4-1.opsi</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, in the opsi management interface, click on the update button and see that we have new packages </font></font><code>opsipackagebuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>opsi-setup-detector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We put them through the control interface on a test machine under Windows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the program </font></font><code>opsipackagebuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>opsi-setup-detector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">established, run </font></font><code>opsi-setup-detector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and play off it on the installer program </font></font><code>windirstat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, downloaded from the official website pre-program. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before installing, you need to configure the program settings. We mount the ball on the test machine \\ opsiserver.domain.local \ opsi_workbench as drive z: write your name and your mail in the specified fields: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a3/zx/gz/a3zxgzhluvq6-vb6utpdveqfoqi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OPSI can make one package using 32 and 64 installers at the same time and setting them based on the capacity of the system, we have 64 bits everywhere, so click "Analyze single file ...":</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n-/ev/s9/n-evs94sic7qrqsafbish6zhjno.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the detector did not understand the installation directory, we can find out for ourselves by trying to install the program through the installer. But he detected the type of installer, the version of the program, the size of the application in assembled and deployed form, the offline installation key, the offline removal key and the name uninstaller. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vh/u7/ys/vhu7ysu1f6hjlkxbvuetosk2xcu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We enter the installation directory ourselves and click Next Step: </font></font><br>
<img src="https://habrastorage.org/webt/wl/lx/nf/wllxnfx3gtvrhtdspigvxznyply.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you can add the product name, its ID, description and set the version of the package, that is, put in the attempt that we make to assemble the package (in our case, the first attempt): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ip/_g/fa/ip_gfarn7c49hwtnvhdy0cnxesm.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can put down the dependencies, this means that to install the current package, the packages themselves put up for installation are those that are stated in the requirements for ours: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/be/mn/os/bemnosq2zhjnugxp5ywu8ahysqi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create OPSI package: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vd/s8/-2/vds8-2ho3zriw5pt7l4dtjouhpq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We created the package, now we need to go to opsiserver in</font></font><code>/var/lib/opsi/workbench/windirstat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Collect package:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-makepackage</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Install it:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-package-manager -d ALL -i windirstat-1.1.2-1.opsi</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If everything went well, then in the opsi-configed management interface, click on the ‚Äúupdate‚Äù button and see that we have a new package </font></font><code>windirstat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that can be installed on selected computers on our network. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bingo! </font><font style="vertical-align: inherit;">The first package is assembled! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To complicate our task, using powershell we will create a rule in the Windows firewall that gives access to the client to port 4441 and 4447 and make this application autoload for the user through the registry tweak, as if it would be, for example, a messenger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open opsi package builder: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ry/35/br/ry35brmfbx9wcefpvejn45ofq1i.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Choose to open the package and open our package with windirstat:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7q/fi/tb/7qfitbgjqlx1kceksjhko2qokc0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OPSI by default acts as follows: when you remove a program from uninstall.opsiscript, delsub.opsiscript is called, which removes the program. When installing a program from setup.opsiscript, delsub.opsiscript is called, which removes the program, and then setup.opsiscript installs it. Therefore, we make edits to create something in setup.opsiscript, and edits to delete something in delsub.opsiscript. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All the magic of these scripts is reflected in the documentation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://download.uib.de/opsi4.1/documentation/html/en/opsi-winst-manual/opsi-winst-manual.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
setup.opsiscript can be opened through the pencil icon, and delsub.opsiscript via Script Tree. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bk/_s/y_/bk_sy_fdgjsl6x4lbokjcrtjhc0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the complete file menu. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/wc/lb/o9wclbi4d3hob_bx9mdrlibnxwi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each attempt to build a package should be increased by one.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/8n/ry/km8nrypi8ie323expcio-ms0kum.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We add the program to autoload via opsi, for this, insert the lines in setup.opsiscript:</font></font><br>
<br>
<pre><code class="plaintext hljs">Registry_changes  /AllNTUserdats /64bit<font></font>
[Registry_changes]<font></font>
OpenKey [Software\Microsoft\Windows\CurrentVersion\Run]<font></font>
Set "WinDirStat" = "C:\Program Files (x86)\WinDirStat\windirstat.exe"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in delsub.opsiscript, insert the lines:</font></font><br>
<br>
<pre><code class="plaintext hljs">Registry_changes  /AllNTUserdats /64bit<font></font>
[Registry_changes]<font></font>
OpenKey [HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run]<font></font>
;Set "WinDirStat" = "C:\Program Files (x86)\WinDirStat\windirstat.exe"<font></font>
DeleteVar "WinDirStat"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We add the rule to the firewall by running the powershell script, for this, insert the lines in setup.opsiscript:</font></font><br>
<br>
<pre><code class="plaintext hljs">DosInAnIcon_PowerShell_ExecutionPolicy<font></font>
ExecWith_PowerShell_NichtPDCAktionen powershell.exe winst /sysnative<font></font>
[DosInAnIcon_PowerShell_ExecutionPolicy]<font></font>
echo "powershell set-executionpolicy RemoteSigned ..."<font></font>
powershell.exe set-executionpolicy RemoteSigned<font></font>
exit %ERRORLEVEL%<font></font>
<font></font>
[ExecWith_PowerShell_NichtPDCAktionen]<font></font>
; hier Dein PS-Code<font></font>
<font></font>
New-NetFirewallRule -DisplayName 'OPSI-Inbound' -Profile @('Domain', 'Private', 'Public') -Direction Inbound -Action Allow -Protocol TCP -LocalPort @('4441', '4447')</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in delsub.opsiscript, insert the lines:</font></font><br>
<br>
<pre><code class="plaintext hljs">DosInAnIcon_PowerShell_ExecutionPolicy<font></font>
ExecWith_PowerShell_NichtPDCAktionen powershell.exe winst /sysnative<font></font>
[DosInAnIcon_PowerShell_ExecutionPolicy]<font></font>
echo "powershell set-executionpolicy RemoteSigned ..."<font></font>
powershell.exe set-executionpolicy RemoteSigned<font></font>
exit %ERRORLEVEL%<font></font>
<font></font>
[ExecWith_PowerShell_NichtPDCAktionen]<font></font>
; hier Dein PS-Code<font></font>
Remove-NetFirewallRule -DisplayName 'OPSI-Inbound'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full code can be viewed here: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/valmont2k/WinDirStatOpsiPackageTest</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
I have already relaxed, watching as opsi rolls the </font></font><code>%program%</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">latest version to the entire network, as Ilon again interrupted my thoughts on high. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Next week another 500 people will come, offices have already been rented, computers are being imported, there is a networker, you need to deploy a windows network in six branches around the city, can you handle it? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Well, of course, this is not rocket science - I joked tiredly in response. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We clone our opsiserver server using the hypervisor and deploy it in the branch. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We assume that the central office is connected to branches through a VPN with a speed of at least 10 Mbps.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we will make a depot server, that is, a server for storing packages in the branch. </font><font style="vertical-align: inherit;">Clients in the branch will knock on https to the main server, and if you need to install software, they will mount the depot server in your branch and be installed from it, this is done in particular to save the Internet channel between the office and the branch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We configure on the branch server opsiserver-2 a static address from the local network changing the file </font></font><code>/etc/network/interfaces</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">according to the new network. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Change hostname and hosts:</font></font><br>
<br>
<pre><code class="bash hljs">sed -i <span class="hljs-string">'s/opsiserver/opsiserver-2/'</span> /etc/hostname<font></font>
sed -i <span class="hljs-string">'s/opsiserver/opsiserver-2/g'</span> /etc/hosts</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in / etc / hosts we update the data by driving in a new ip address </font></font><br>
<br>
<pre><code class="bash hljs">reboot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rename the opsi server using opsi:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-admin --no-depot -d method host_renameOpsiDepotserver opsiserver.domain.local opsiserver-2.domain.local</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From the server opsiserver-2.domain.local we connect it to opsiserver.domain.local as depot:</font></font><br>
<br>
<pre><code class="bash hljs">opsi-setup --register-depot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Specify the name of the main server, to which we connect the new depot, administrator and password: You </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yx/02/y_/yx02y_bcvpikxgkubku2-fl8try.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
do not need to change anything here </font><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">You </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n2/1j/_l/n21j_lmeiwlsn3ghmkcxr4yadgg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
can verify that everything is done correctly in opsi-configed: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6u/s9/nu/6us9nurw4d3rsetl0nemcy_x_re.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to configure the system so that clients choose their own depot server. We select all customers and set them dynamic depot. By default, the client looks at its ip address and selects depot from its network. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vp/4v/mg/vp4vmg0czhi2vmkwobeddecf1dc.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we configure that all future clients immediately choose depot dynamically: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/h7/-j/c4/h7-jc4kpf-5vyavsz_mckjp44-a.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all, the setup of the new depot server is done, you can install opsi-client-agent for computers on the local network with the same script that we installed in the main office earlier, not forgetting to change the ip address inside the script.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In each branch we set a domain controller (you can Readonly), do our own network addressing, divide the default-site inside the windows domain into sub-sites, each of which we make our subnet, our group policy with its opsi-client-agent installation script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we repeat in the new branch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I finished my coffee and went home, and the LED on the network card signaled that new and new systems were rolling out to the noise of coolers ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Update 1: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As it turned out, it is not necessary to script, opsi-configed allows you to click on the awakening of clients with the mouse on the sheduler.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497814/index.html">Five stages of accepting the inevitable, or How we developed a program for automated profiling</a></li>
<li><a href="../en497816/index.html">Russian Railways sends me someone else's tickets</a></li>
<li><a href="../en497818/index.html">Remote access to VMs with GPU using Citrix</a></li>
<li><a href="../en497820/index.html">Statistical regularization of incorrect inverse problems to them. Turchin (part 1)</a></li>
<li><a href="../en497822/index.html">Man in a bottle</a></li>
<li><a href="../en497828/index.html">2 in 1: encryption with security protection</a></li>
<li><a href="../en497830/index.html">OWASP Moscow 2020/1 Recordings</a></li>
<li><a href="../en497832/index.html">What is hidden behind VestaCP</a></li>
<li><a href="../en497834/index.html">Advanced resource authorization system in Laravel. Part 2. Gateways, Policies</a></li>
<li><a href="../en497836/index.html">Comparison of the speed of programming languages ‚Äã‚Äãusing the example of solving the problem of training a neural network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>