<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆗 👲🏼 🚊 「I Have Peend Pwned」での検索を49マイクロ秒に加速（C ++） 🧝🏿 🚵🏾 🧗🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私はPwnedされた（HIBP）サイトについて長い間知っていました。確かに、最近まで、彼はそこにいなかった。私はいつも二つのパスワードを持っていました。そのうちの1つは、ゴミメールや奇妙なサイトの2つのアカウントで繰り返し使用されました。しかし、メールがハッキングされたので、私はそれを拒否しなければ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>「I Have Peend Pwned」での検索を49マイクロ秒に加速（C ++）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490920/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/fu/rg/hn/furghncw9u08teobuskqawx2y7u.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はPwnedされた（HIBP）サイト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">について長い間知ってい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ました</font></a><font style="vertical-align: inherit;">。確かに、最近まで、彼はそこにいなかった。私はいつも二つのパスワードを持っていました。そのうちの1つは、ゴミメールや奇妙なサイトの2つのアカウントで繰り返し使用されました。しかし、メールがハッキングされたので、私はそれを拒否しなければなりませんでした。正直なところ、ハッカーに感謝します。このイベントによって、パスワードの使用方法と保存方法が確認されたからです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、侵害されたパスワードがあったすべてのアカウントのパスワードを変更しました。それから、漏洩したパスワードがHIBPデータベースにあるのかと思いました。サイトにパスワードを入力したくなかったので、データベース（</font></font><code>pwned-passwords-sha1-ordered-by-count-v5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">ベースはとても印象的です。</font><font style="vertical-align: inherit;">これは、カウンタを含む各行に1つずつ、一連​​のSHA-1ハッシュを含む22.8 GBのテキストファイルで、このハッシュを含むパスワードがリークで発生した回数です。</font><font style="vertical-align: inherit;">クラックされたパスワードのSHA-1を見つけて、見つけようとしました。</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目次</font></font></h1><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[G]担当者</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トライ構造</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">二分探索</font></font></a><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕分け</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜマージバック？</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並列処理</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利己的な野郎にならないで</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B3</font></font></a><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">挿入ソート</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別々かどうか？</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HIBPツリーのプロパティ</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力ファイル</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベンチマーク</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">okon-ライブラリとCLI</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンクとディスカッション</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読んでくれてありがとう</font></font></a></li>
</ul><br>
<a name="1"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[G]担当者</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各行にハッシュを含むテキストファイルがあります。</font><font style="vertical-align: inherit;">おそらく、行くのに最適な場所はgrepです。</font></font><br>
<br>
<code>grep -m 1 '^XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX' pwned-passwords-sha1-ordered-by-count-v5.txt</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のパスワードは1,500回を超える頻度でリストの最上位にありました。</font><font style="vertical-align: inherit;">したがって、検索結果はほぼ瞬時に返されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、誰もが弱いパスワードを持っているわけではありません。</font><font style="vertical-align: inherit;">最悪のシナリオを見つけるのにかかる時間を確認したいと思いました-ファイルの最後のハッシュ：</font></font><br>
<br>
<code>time grep -m 1 '^4541A1E4605EEBF3F4C166329C18502DF75D348A' pwned-passwords-sha1-ordered-by-count-v5.txt</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果：</font></font><code>33,35s user 23,39s system 41% cpu 2:15,35 total</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは悲しいです。</font><font style="vertical-align: inherit;">結局のところ、メールがハッキングされたので、データベースに古いパスワードと新しいパスワードがすべて存在するかどうかを確認したかったのです。</font><font style="vertical-align: inherit;">しかし、2分間のgrepでは、これを快適に行うことができません。</font><font style="vertical-align: inherit;">もちろん、スクリプトを作成して実行し、散歩することもできますが、これはオプションではありません。</font><font style="vertical-align: inherit;">より良い解決策を見つけ、何かを学びたかった。</font></font><br>
<br>
<a name="2"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トライ構造</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のアイデアは、trieデータ構造を使用することでした。この構造は、SHA-1ハッシュを格納するのに理想的です。アルファベットは小さいので、ノードも小さくなり、結果のファイルも小さくなります。多分それはRAMにも収まりますか？キー検索は非常に高速でなければなりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、この構造を実装しました。次に、ソースデータベースの最初の1,000,000ハッシュを取得して結果のファイルを作成し、作成されたファイルにすべてが含まれているかどうかを確認しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、ファイル内のすべてを見つけることができたので、構造はうまくいきました。問題は違いました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果のファイルは、サイズ2283686592B（2.2 GB）でリリースされました。これは良くない。数えて、何が起こるか見てみましょう。ノードは、16個の32ビット値の単純な構造です。値は、指定されたSHA-1ハッシュシンボルを持つ次のノードへの「ポインター」です。したがって、1つのノードは16 * 4バイト= 64バイトになります。少し見えますか？しかし、考えてみると、1つのノードはハッシュの1つの文字を表します。したがって、最悪の場合、SHA-1ハッシュは40 * 64バイト= 2560バイトになります。これは、たとえば、40バイトしか使用しないハッシュのテキスト表現よりもはるかに悪いです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トライ構造には、ノードを再利用できるという利点があります。 2つの単語</font></font><code>aaa</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">がある場合</font></font><code>abb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、文字は同じなので、最初の文字のノードが再利用され</font></font><code>a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題に戻りましょう。</font><font style="vertical-align: inherit;">結果のファイルに保存されているノードの数を計算してみましょう。</font></font><code>file_size / node_size = 2283686592 / 64 = 35682603</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、100万ハッシュから最悪の場合に作成されるノードの数を見てみましょう。</font></font><code>1000000 * 40 = 40000000</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、トライ構造は</font></font><code>40000000 - 35682603 = 4317397</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノード</font><font style="vertical-align: inherit;">のみを再利用し</font><font style="vertical-align: inherit;">ます。これは最悪のシナリオの10.8％です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなインジケーターを使用すると、HIBPデータベース全体の結果ファイルは1421513361920バイト（1.02 TB）になります。</font><font style="vertical-align: inherit;">キー検索の速度をチェックするのに十分なハードドライブさえありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その日、トライ構造は比較的ランダムなデータには適さないことがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の解決策を探しましょう。</font></font><br>
<br>
<a name="3"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">二分探索</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SHA-1ハッシュには2つの優れた機能があります。それらは互いに比較可能であり、すべて同じサイズです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、元のHIBPデータベースを処理し、ソートされたSHA-1値からファイルを作成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、22 GBのファイルをソートする方法は？</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">質問。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースファイルを並べ替える理由 </font><font style="vertical-align: inherit;">HIBPは、ハッシュでソートされた文字列を含むファイルを返します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">回答。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私はそれについて考えませんでした。</font><font style="vertical-align: inherit;">その瞬間、私はソートされたファイルについて知りませんでした。</font></font></i> <br>
<br>
<a name="4"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仕分け</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RAM内のすべてのハッシュを並べ替えることはオプションではありません;私は多くのRAMを持っていません。</font><font style="vertical-align: inherit;">解決策はこれでした：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなファイルをRAMに収まる小さなファイルに分割します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小さなファイルからデータをダウンロードし、RAMでソートして、ファイルに書き戻します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並べ替えられたすべての小さなファイルを1つの大きなファイルに結合します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソートされた大きなファイルでは、バイナリ検索を使用してハッシュを検索できます。</font><font style="vertical-align: inherit;">ハードドライブへのアクセスが重要です。</font><font style="vertical-align: inherit;">バイナリ検索で必要なヒット数</font></font><code>log2(555278657) = 29.0486367039</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、つまり30ヒットを</font><font style="vertical-align: inherit;">計算してみましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そんなに悪くない。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の段階で、最適化を実行できます。</font><font style="vertical-align: inherit;">テキストハッシュをバイナリデータに変換します。</font><font style="vertical-align: inherit;">これにより、結果のデータのサイズが半分になります（22 GBから11 GBに）。</font><font style="vertical-align: inherit;">いいよ</font></font><br>
<br>
<a name="5"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜマージバック？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その瞬間、私はあなたがもっと賢くできることに気づきました。</font><font style="vertical-align: inherit;">小さなファイルを1つの大きなファイルに結合せずに、RAM内のソートされた小さなファイルでバイナリ検索を実行するとどうなりますか？</font><font style="vertical-align: inherit;">問題は、キーを探すために必要なファイルをどのように見つけるかです。</font><font style="vertical-align: inherit;">解決策は非常に簡単です。</font><font style="vertical-align: inherit;">新しいアプローチ：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"00" ... "FF"という名前の256個のファイルを作成します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなファイルからハッシュを読み取るときは、「00 ..」で始まるハッシュを「00」というファイルに書き込み、「01 ..」で始まるハッシュをファイル「01」に書き込みます。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小さなファイルからデータをダウンロードし、RAMでソートして、ファイルに書き戻します。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが非常に簡単です。</font><font style="vertical-align: inherit;">さらに、別の最適化オプションが表示されます。</font><font style="vertical-align: inherit;">ハッシュがファイル「00」に格納されている場合、「00」で始まることがわかります。</font><font style="vertical-align: inherit;">ハッシュがファイル「F2」に格納されている場合、「F2」で始まります。</font><font style="vertical-align: inherit;">したがって、ハッシュを小さなファイルに書き込む場合、各ハッシュの最初のバイトを省略できます！</font><font style="vertical-align: inherit;">これは全データの5％です。</font><font style="vertical-align: inherit;">合計で555 MBが節約されます。</font></font><br>
<br>
<a name="6"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">並列処理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小さいファイルへの分離は、最適化のもう1つの機会を提供します。</font><font style="vertical-align: inherit;">ファイルは互いに独立しているため、並列でソートできます。</font><font style="vertical-align: inherit;">すべてのプロセッサーが同時に発汗するのを好むことを覚えています;）</font></font><br>
<br>
<a name="7"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利己的な野郎にならないで</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のソリューションを実装したとき、他の人にも同様の問題があると思いました。おそらく他の多くもHIBPデータベースをダウンロードして検索しています。だから私は自分の仕事を共有することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その前に、もう一度アプローチを修正し、Githubにコードとツールを投稿する前に修正したい問題をいくつか見つけました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、エンドユーザーとして、何が保存されているのか不明な、奇妙な名前の奇妙なファイルを大量に作成するツールを使いたくありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、これはファイル「00」..「FF」を組み合わせることで解決できます。 1つの大きなファイル。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、ソート用に1つの大きなファイルを使用すると、新しい問題が発生します。</font><font style="vertical-align: inherit;">このファイルにハッシュを挿入したい場合はどうなりますか？</font><font style="vertical-align: inherit;">ハッシュは1つだけです。</font><font style="vertical-align: inherit;">これはわずか20バイトです。</font><font style="vertical-align: inherit;">ああ、ハッシュは「000000000 ..」で始まります。</font><font style="vertical-align: inherit;">はい。</font><font style="vertical-align: inherit;">11 GBの他のハッシュを移動して、そのためのスペースを解放しましょう... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題が何であるかを理解しました。</font><font style="vertical-align: inherit;">ファイルの途中にデータを挿入することは、最速の操作ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチのもう1つの欠点は、最初のバイトを再度格納する必要があることです。これは555 MBのデータです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に重要なことですが、ハードドライブに保存されたデータのバイナリ検索は、RAMへのアクセスよりもはるかに低速です。</font><font style="vertical-align: inherit;">つまり、これは30回のディスク読み取りに対して0回のディスク読み取りです。</font></font><br>
<br>
<a name="8"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B3</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再び。</font><font style="vertical-align: inherit;">私たちが持っているものと達成したいこと。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
11 GBのバイナリ値があります。</font><font style="vertical-align: inherit;">すべての値は比較可能であり、サイズは同じです。</font><font style="vertical-align: inherit;">保存されたデータに特定のキーが存在するかどうかを確認し、データベースを変更したいと考えています。</font><font style="vertical-align: inherit;">そして、すべてが迅速に機能するようにします。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/18c/851/d23/18c851d23c6bbe290fcccb763c6f09eb.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bツリー？</font><font style="vertical-align: inherit;">正しい </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bツリーを使用すると、検索、変更などの際にディスクへのアクセスを最小限に抑えることができます。Bツリーにはさらに多くの機能がありますが、これら2つが必要です。</font></font><br>
<br>
<a name="9"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">挿入ソート</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のステップは、データをHIBPソースファイルからBツリーに変換することです。つまり、すべてのハッシュを順番に抽出して、構造に挿入する必要があります。通常の挿入アルゴリズムがこれに適しています。しかし、私たちの場合、あなたはもっとうまくやることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの生データをBツリーに挿入することは、よく知られたシナリオです。賢明な人々は、通常の挿入よりも優れたアプローチを発明しました。まず、データを並べ替える必要があります。これは上記のように実行できます（ファイルをより小さなファイルに分割し、RAMでソートします）。次に、データをツリーに挿入します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常のアルゴリズムでは、値を挿入するリーフノードが見つかり、それが入力されている場合、新しいノード（右側）を作成し、左右の2つのノードの間に値を均等に分配します（1つの値が親ノードに移動します）ただし、ここでは重要ではありません）。つまり、左側のノードの値は常に右側の値よりも小さくなります。実際のところ、ソートされたデータを挿入すると、小さい値がツリーに挿入されなくなるため、左側のノードに移動する値がなくなることがわかります。左側のノードは常に半分空のままです。さらに、十分な値を挿入すると、右側のノードがいっぱいになることがあるため、値の半分を新しい右側のノードに移動する必要があります。前の場合と同様に、分割ノードは半分空のままです。等…</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、すべての挿入後に、ほとんどすべてのノードが半分空のツリーが表示されます。</font><font style="vertical-align: inherit;">これは非常に効率的なスペースの使用ではありません。</font><font style="vertical-align: inherit;">私たちはもっとうまくやることができます。</font></font><br>
<br>
<a name="10"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別々かどうか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソートされたデータを挿入する場合は、挿入アルゴリズムに小さな変更を加えることができます。</font><font style="vertical-align: inherit;">値を貼り付けたいノードがいっぱいの場合は、分割しないでください。</font><font style="vertical-align: inherit;">新しい空のノードを作成し、値を親ノードに貼り付けるだけです。</font><font style="vertical-align: inherit;">次に、次の値（前の値よりも大きい）を挿入すると、それらを新しい空のノードに挿入します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bツリーのプロパティを保持するには、すべての挿入後に、ツリーの各レイヤー（ルートを除く）の右端のノードを並べ替え、この極端なノードとその左隣の値を均等に分割する必要があります。</font><font style="vertical-align: inherit;">つまり、可能な限り最小のツリーが得られます。</font></font><br>
<br>
<a name="11"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HIBPツリーのプロパティ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bツリーを設計するときは、その順序を選択する必要があります。</font><font style="vertical-align: inherit;">1つのノードに保存できる値の数と、ノードが持つことができる子の数を示します。</font><font style="vertical-align: inherit;">このパラメーターを操作することで、ツリーの高さ、ノードのバイナリサイズなどを操作できます</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。HIBPでは、</font></font><code>555278657</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッシュを使用します。</font><font style="vertical-align: inherit;">高さ3のツリーが必要だとします（そのため、ハッシュの存在を確認するために必要な読み取り操作は3つだけです）。</font><font style="vertical-align: inherit;">Mの値を見つける必要があります</font></font><code>logM(555278657) &lt; 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私は1024を選択しました。これは可能な最小値ではありませんが、より多くのハッシュを挿入して木の高さを維持することは可能です。</font></font><br>
<br>
<a name="12"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出力ファイル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HIBPソースファイルのサイズは22.8 GBです。</font><font style="vertical-align: inherit;">Bツリーの出力ファイルは12.4 GBです。</font><font style="vertical-align: inherit;">私のマシン（Intel Core i7-6700、3.4 GHz、16 GB RAM）、ハードディスク（SSDではない）で作成するのに約11分かかります。</font></font><br>
<br>
<a name="13"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベンチマーク</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bツリーオプションはかなり良い結果を示します。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">| </font><font style="vertical-align: inherit;">| </font><font style="vertical-align: inherit;">時間[μs] | </font><font style="vertical-align: inherit;">％|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| -----------------：| ------------：| ------------：|</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">おこん| </font><font style="vertical-align: inherit;">49 | </font><font style="vertical-align: inherit;">100 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">grep '^ハッシュ' | </font><font style="vertical-align: inherit;">135'350'000 | </font><font style="vertical-align: inherit;">276'224'489 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">grep | </font><font style="vertical-align: inherit;">135'480'000 | </font><font style="vertical-align: inherit;">276'489'795 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| </font><font style="vertical-align: inherit;">C ++ 1行ずつ| </font><font style="vertical-align: inherit;">135'720'201 | </font><font style="vertical-align: inherit;">276'980'002 |</font></font></pre><br>
<a name="14"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">okon-ライブラリとCLI</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が言ったように、私は自分の作品を世界と共有したいと思いました。 HIBPデータベースを処理し、ハッシュをすばやく検索するためのライブラリとコマンドラインインターフェイスを実装しました。検索は非常に高速であるため、たとえば、パスワードマネージャーに統合して、キーが押されるたびにユーザーにフィードバックを提供できます。可能な用途はたくさんあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライブラリはCインターフェイスを備えているため、ほとんどどこでも使用できます。 CLIはCLIです。ビルドして実行するだけです（：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私のリポジトリにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
免責事項：okonは、作成されたBツリーに値を挿入するためのインターフェースをまだ提供していません。</font><font style="vertical-align: inherit;">HIBPファイルの処理、Bツリーの作成、ファイル内での検索のみが可能です。</font><font style="vertical-align: inherit;">これらの関数は非常にうまく機能するので、コードを共有して、挿入やその他の可能な関数の作業を続けることにしました。</font></font><br>
<br>
<a name="15"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンクとディスカッション</font></font></h1><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トライ構造</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bツリー</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ウェブサイトは私が犯された</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードリポジトリ</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r / cpp</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r /セキュリティ</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッカーニュース</font></font></a></li>
</ul><br>
<a name="16"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読んでくれてありがとう</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（：</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja490906/index.html">Yandexは独立したAura-aura.topのベータ版を公開しました。トップですか？</a></li>
<li><a href="../ja490908/index.html">ゾーンデータストレージ</a></li>
<li><a href="../ja490912/index.html">Sportmasterでのキャッシングシステムの選択方法。パート1</a></li>
<li><a href="../ja490916/index.html">大規模プロジェクトでの外部チームとの相互作用の問題</a></li>
<li><a href="../ja490918/index.html">Andrei Zaretsky、Alexander Trukhanov（続き）：「私たちは名前を持っていませんでしたが、傲慢がありました」</a></li>
<li><a href="../ja490924/index.html">Windows PowerShellとは何で、何を食べますか？パート2：プログラミング言語の概要</a></li>
<li><a href="../ja490926/index.html">初心者向けのユニティボール軌道2d</a></li>
<li><a href="../ja490932/index.html">[予報] Motornet-ロボット車両のデータ交換ネットワーク</a></li>
<li><a href="../ja490936/index.html">iOSでMLを作成する</a></li>
<li><a href="../ja490938/index.html">一度に数千ものログファイルを書き込む</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>