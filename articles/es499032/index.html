<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò¥ ü§© ‚úåüèø C√≥mo usar Prometheus para detectar anomal√≠as en GitLab üö£üèæ ‚ôäÔ∏è üíë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una de las caracter√≠sticas b√°sicas del lenguaje de consulta Prometheus es la agregaci√≥n en tiempo real de series de tiempo . Tambi√©n puede usar el len...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C√≥mo usar Prometheus para detectar anomal√≠as en GitLab</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una de las caracter√≠sticas b√°sicas del lenguaje de consulta Prometheus es </font><font style="vertical-align: inherit;">la </font><font style="vertical-align: inherit;">agregaci√≥n en </font><font style="vertical-align: inherit;">tiempo real </font><font style="vertical-align: inherit;">de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">series</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">tiempo</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tambi√©n puede usar el lenguaje de consulta Prometheus para detectar anomal√≠as en datos de series temporales.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El equipo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traducido </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">un art√≠culo del ingeniero del equipo de infraestructura de GitLab</font></a><font style="vertical-align: inherit;"> , donde encontrar√° ejemplos de c√≥digo que puede probar en sus sistemas.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPara qu√© sirve la detecci√≥n de anomal√≠as?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existen cuatro razones principales que determinan la importancia de la detecci√≥n de anomal√≠as para GitLab:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagn√≥stico de incidentes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : podemos detectar qu√© servicios han ido m√°s all√° de su alcance normal al reducir el tiempo de detecci√≥n de incidentes (MTTD) y, en consecuencia, ofrecer una soluci√≥n m√°s r√°pida al problema.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecci√≥n de degradaci√≥n del rendimiento</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : por ejemplo, si se introduce una regresi√≥n en un servicio que hace que acceda a otro servicio con demasiada frecuencia, podemos detectar y solucionar este problema r√°pidamente.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecci√≥n y eliminaci√≥n del abuso</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : GitLab proporciona mecanismos de entrega e integraci√≥n ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) y alojamiento (p√°ginas de GitLab) y un n√∫mero limitado de usuarios que pueden usar estos mecanismos.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seguridad</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la detecci√≥n de anomal√≠as es importante para detectar tendencias inusuales en la serie temporal de GitLab.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por estas y otras razones, el autor del art√≠culo decidi√≥ averiguar c√≥mo configurar la definici√≥n de anomal√≠as en la serie temporal de GitLab utilizando consultas y reglas de Prometheus.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øCu√°l es el nivel de agregaci√≥n correcto?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, las series de tiempo deben estar correctamente agregadas. </font><font style="vertical-align: inherit;">En el siguiente ejemplo, utilizamos el contador est√°ndar http_requests_total para recuperar datos, aunque muchas otras m√©tricas tambi√©n lo har√≠an.</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta m√©trica de prueba tiene varios par√°metros: m√©todo, controlador, c√≥digo de estado (status_code), entorno, adem√°s de los par√°metros agregados por Prometheus, por ejemplo, trabajo e instancia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora debe elegir el nivel correcto de agregaci√≥n de datos. </font><font style="vertical-align: inherit;">Demasiado, muy poco: todo esto es importante para detectar anomal√≠as. </font><font style="vertical-align: inherit;">Si los datos est√°n demasiado agregados, hay dos problemas potenciales:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede omitir la anomal√≠a porque la agregaci√≥n oculta los problemas que ocurren en subconjuntos de sus datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si encuentra una anomal√≠a, es dif√≠cil relacionarla con una parte separada de su sistema sin un esfuerzo adicional.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si los datos no se agregan lo suficiente, esto puede conducir a un aumento en el n√∫mero de falsos positivos, as√≠ como a una interpretaci√≥n incorrecta de datos v√°lidos como err√≥neos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n nuestra experiencia, el nivel de agregaci√≥n m√°s correcto es el nivel de servicio, es decir, incluimos la etiqueta de trabajo (trabajo) y medio ambiente (medio ambiente), y descartamos todas las dem√°s etiquetas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La agregaci√≥n, que discutiremos a lo largo del art√≠culo, incluye: trabajo - http_request, agregaci√≥n - cinco minutos, que se calcula sobre la base del trabajo y el entorno en cinco minutos.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Del ejemplo anterior, est√° claro que de la serie http_requests_total se seleccionan subconjuntos en el contexto del trabajo y el entorno, entonces su n√∫mero se considera durante cinco minutos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando Z-score para detectar anomal√≠as</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los principios b√°sicos de las estad√≠sticas se pueden aplicar para detectar anomal√≠as. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si conoce la media y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la desviaci√≥n est√°ndar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la serie Prometheus, puede usar cualquier muestra de la serie para calcular la puntuaci√≥n z.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una puntuaci√≥n Z es una medida de la extensi√≥n relativa del valor observado o medido, que muestra cu√°ntas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desviaciones est√°ndar es</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> su extensi√≥n en relaci√≥n con el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor promedio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, el puntaje z = 0 significa que el puntaje z es id√©ntico al valor promedio en el conjunto de datos con la distribuci√≥n est√°ndar, y el puntaje z = 1 significa que la desviaci√≥n est√°ndar = 1.0 del promedio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponemos que los datos b√°sicos tienen una distribuci√≥n normal, lo que significa que el 99.7% de las muestras tienen un puntaje z de 0 a 3. Cuanto m√°s lejos est√© el puntaje z de cero, es menos probable que exista.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aplicamos esta propiedad para detectar anomal√≠as en la serie de datos de Prometheus:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculamos la media y la desviaci√≥n est√°ndar de la m√©trica utilizando datos con un gran tama√±o de muestra. </font><font style="vertical-align: inherit;">Para este ejemplo, usamos datos semanales. </font><font style="vertical-align: inherit;">Si suponemos que los registros se eval√∫an una vez por minuto, en una semana tendremos un poco m√°s de 10,000 muestras.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podemos calcular el puntaje z para la consulta de Prometheus tan pronto como obtengamos la media y la desviaci√≥n est√°ndar para la agregaci√≥n.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con base en los principios estad√≠sticos de las distribuciones normales, suponga que cualquier valor fuera del rango de +3 a -3 ser√° una anomal√≠a. </font><font style="vertical-align: inherit;">En consecuencia, podemos crear una advertencia sobre tales anomal√≠as. </font><font style="vertical-align: inherit;">Por ejemplo, recibiremos una alerta cuando nuestra agregaci√≥n vaya m√°s all√° de este rango durante m√°s de cinco minutos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√°fico del n√∫mero de solicitudes por segundo al servicio de p√°ginas de GitLab durante 48 horas. </font><font style="vertical-align: inherit;">La puntuaci√≥n Z en el rango de +3 a -3 se resalta en verde. La</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
puntuaci√≥n Z puede ser dif√≠cil de interpretar en los gr√°ficos, ya que este valor no tiene una unidad de medida. </font><font style="vertical-align: inherit;">Pero las anomal√≠as en este gr√°fico son muy simples de determinar. </font><font style="vertical-align: inherit;">Todo lo que vaya m√°s all√° de la zona verde, que muestra un corredor de valores con un puntaje z de -3 a +3, ser√° un valor an√≥malo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√© hacer si la distribuci√≥n de datos no es normal</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponemos que la distribuci√≥n de datos es normal. </font><font style="vertical-align: inherit;">De lo contrario, nuestro puntaje z ser√° falso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchos trucos estad√≠sticos para determinar la normalidad de la distribuci√≥n de datos, pero la mejor manera es verificar que su puntaje z de datos se encuentre en el rango de -4.0 a +4.0. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dos consultas de Prometheus que muestran puntuaciones z m√≠nimas y m√°ximas:</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si sus resultados est√°n en el rango de -20 a +20, esto significa que se han utilizado demasiados datos y los resultados est√°n distorsionados. </font><font style="vertical-align: inherit;">Recuerde tambi√©n que debe trabajar con filas agregadas. </font><font style="vertical-align: inherit;">Las m√©tricas que no tienen una distribuci√≥n normal incluyen par√°metros como la tasa de error, el retraso, la longitud de la cola, etc. </font><font style="vertical-align: inherit;">Pero muchas de estas m√©tricas funcionar√°n mejor con umbrales de alerta fijos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecci√≥n estad√≠stica de anomal√≠as de estacionalidad</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aunque el c√°lculo de las puntuaciones z funciona bien con la distribuci√≥n normal de los datos de series temporales, existe un segundo m√©todo que puede proporcionar resultados de detecci√≥n de anomal√≠as a√∫n m√°s precisos. </font><font style="vertical-align: inherit;">Este es el uso de la estacionalidad estad√≠stica.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La estacionalidad es una caracter√≠stica de una m√©trica de serie temporal cuando esta m√©trica sufre cambios regulares y predecibles que se repiten en cada ciclo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√°fico de solicitudes por segundo (RPS) de lunes a domingo durante cuatro semanas consecutivas El</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
gr√°fico anterior ilustra el RPS (n√∫mero de solicitudes por segundo) durante siete d√≠as, de lunes a domingo, durante cuatro semanas consecutivas. </font><font style="vertical-align: inherit;">Este rango de siete d√≠as se llama "desplazamiento", es decir, el patr√≥n que se utilizar√° para la medici√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada semana en la tabla hay un color diferente. </font><font style="vertical-align: inherit;">La estacionalidad de los datos est√° indicada por la secuencia en las tendencias indicadas en el gr√°fico: todos los lunes por la ma√±ana observamos un aumento similar en RPS, y en las noches del viernes siempre observamos una disminuci√≥n en RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando la estacionalidad en nuestros datos de series de tiempo, podemos predecir con mayor precisi√≥n la aparici√≥n de anomal√≠as y su detecci√≥n.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo usar la estacionalidad</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometeo utiliza varios mecanismos estad√≠sticos diferentes para calcular la estacionalidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, hacemos un c√°lculo, agregando una tendencia de crecimiento para la semana a los resultados de la semana anterior. La tendencia de crecimiento se calcula de la siguiente manera: reste el promedio m√≥vil de la √∫ltima semana del promedio m√≥vil de la semana pasada.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La primera iteraci√≥n resulta ser algo "estrecha": utilizamos la ventana de cinco minutos de esta semana y la semana anterior para obtener nuestros pron√≥sticos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la segunda iteraci√≥n, ampliamos nuestra cobertura tomando el promedio del per√≠odo de cuatro horas de la semana anterior y compar√°ndolo con la semana actual.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, si intentamos predecir el valor de la m√©trica a las ocho de la ma√±ana del lunes, en lugar de la misma ventana de cinco minutos la semana anterior, tomamos el valor promedio de la m√©trica de seis a diez de la ma√±ana del lunes anterior.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La solicitud indicaba 166 horas, que son dos horas menos que una semana completa (7 * 24 = 168), ya que queremos usar un per√≠odo de cuatro horas en funci√≥n de la hora actual, por lo que necesitamos que la compensaci√≥n sea dos horas menos que una semana completa.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RPS real (amarillo) y predicho (azul) en dos semanas</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Una comparaci√≥n del RPS real con nuestro pron√≥stico muestra que nuestros c√°lculos fueron bastante precisos. Sin embargo, este m√©todo tiene un inconveniente. </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, el 1 de mayo, GitLab se us√≥ menos de lo habitual los mi√©rcoles, ya que este d√≠a era un d√≠a libre. Dado que la tendencia de crecimiento estimada depende de c√≥mo se utiliz√≥ el sistema en la semana anterior, nuestras previsiones para la pr√≥xima semana, es decir, el mi√©rcoles 8 de mayo, dieron un RPS m√°s bajo que en realidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este error se puede corregir haciendo tres pron√≥sticos durante tres semanas consecutivas antes del mi√©rcoles 1 de mayo, es decir, los tres mi√©rcoles anteriores. La solicitud sigue siendo la misma, pero se ajusta el desplazamiento.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hay tres pron√≥sticos en el gr√°fico para tres semanas antes del 8 de mayo, en comparaci√≥n con el RPS real para el mi√©rcoles 8 de mayo. Puede ver que los dos pron√≥sticos son muy precisos, pero el pron√≥stico para la semana del 1 de mayo sigue siendo inexacto.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Adem√°s, no necesitamos tres pron√≥sticos, necesitamos uno. El valor promedio no es una opci√≥n, ya que ser√° borroso por nuestros datos distorsionados de RPS del 1 de mayo. En cambio, necesitas calcular la mediana. Prometeo no tiene una consulta mediana, pero podemos usar la agregaci√≥n cuantil en lugar de la mediana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El √∫nico problema es que estamos tratando de incluir tres series en la agregaci√≥n, y estas tres series son en realidad la misma serie en tres semanas. En otras palabras, tienen las mismas etiquetas, por lo que es dif√≠cil juntarlas.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para evitar confusiones, creamos una etiqueta llamada desplazamiento y utilizamos la funci√≥n de reemplazo de etiquetas para agregar un desplazamiento a cada una de las tres semanas. </font><font style="vertical-align: inherit;">Luego, en la agregaci√≥n cuantil, descartamos estas etiquetas, y esto nos da un promedio de tres.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w ‚Äî job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora nuestro pron√≥stico con una mediana de tres agregaciones se ha vuelto m√°s preciso.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pron√≥stico medio versus RPS real</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo descubrir que nuestro pron√≥stico es realmente preciso</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificar la precisi√≥n del pron√≥stico, podemos volver al puntaje z. </font><font style="vertical-align: inherit;">Se utiliza para medir la discrepancia de la muestra con su pron√≥stico en desviaciones est√°ndar. </font><font style="vertical-align: inherit;">Cuanto mayor sea la desviaci√≥n est√°ndar del pron√≥stico, mayor ser√° la probabilidad de que un valor particular sea un valor at√≠pico.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El rango de desviaci√≥n proyectado es de +1.5 a -1.5</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Puede cambiar nuestro gr√°fico de Grafana para usar un pron√≥stico estacional, en lugar de un promedio m√≥vil semanal. </font><font style="vertical-align: inherit;">El rango de valores normales para una hora espec√≠fica del d√≠a est√° sombreado en verde. </font><font style="vertical-align: inherit;">Todo lo que va m√°s all√° de la zona verde se considera un caso at√≠pico. </font><font style="vertical-align: inherit;">En este caso, el valor at√≠pico ocurri√≥ el domingo por la tarde, cuando nuestro proveedor de la nube tuvo algunos problemas de red. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es una buena pr√°ctica utilizar un puntaje z de ¬± 2 para los pron√≥sticos estacionales.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo configurar alertas con Prometheus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea configurar una alerta para eventos anormales, puede aplicar la regla bastante simple de Prometeo, que verifica si el puntaje z de un indicador est√° en el rango entre +2 y -2.</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En GitLab, utilizamos una regla de enrutamiento personalizada que env√≠a una alerta a trav√©s de Slack cuando detecta cualquier anomal√≠a, pero no se comunica con nuestro equipo de soporte.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo detectar anomal√≠as en GitLab usando Prometheus</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus puede usarse para detectar algunas anormalidades.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La agregaci√≥n adecuada es la clave para encontrar anomal√≠as.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La puntuaci√≥n Z es efectiva si sus datos tienen una distribuci√≥n normal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La estacionalidad estad√≠stica es un poderoso mecanismo para detectar anomal√≠as.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traducido con el soporte de </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sigue siendo √∫til</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√©todos de almacenamiento en cach√© simples en GitLab CI: una gu√≠a de im√°genes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Herramientas GitLab CE listas para usar y personalizadas en el mercado de MCS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuestro canal de Telegram sobre transformaci√≥n digital</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es499014/index.html">23 preguntas dif√≠ciles para entrevistas de JavaScript</a></li>
<li><a href="../es499016/index.html">Integraci√≥n con ESIA para .Net: m√°s f√°cil de lo que parece</a></li>
<li><a href="../es499018/index.html">6 aplicaciones de deportes en casa</a></li>
<li><a href="../es499020/index.html">Un estudio de un comportamiento vago.</a></li>
<li><a href="../es499030/index.html">Monitoreo del rendimiento de MySQL para Grafana en isic en 20 minutos</a></li>
<li><a href="../es499034/index.html">¬øC√≥mo implementar una refactorizaci√≥n peligrosa para pinchar con un mill√≥n de usuarios?</a></li>
<li><a href="../es499036/index.html">Trabajo del proveedor: una selecci√≥n de materiales sobre protocolos, TI e infraestructura de red</a></li>
<li><a href="../es499038/index.html">Mi experiencia usando un monitor vertical</a></li>
<li><a href="../es499040/index.html">Lea el fin de semana: una selecci√≥n de materiales sobre la historia del DNS, la regulaci√≥n de TI y el hardware 1cloud.ru</a></li>
<li><a href="../es499044/index.html">Noticias del mundo de OpenStreetMap No. 508 (04/07/2020/13/04/2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>