<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧘 🚶🏽 🗃️ 10分でメタフローを学ぶ 🌀 👞 🤢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Metaflowは、Netflixで作成され、データサイエンスの分野に焦点を当てたPythonフレームワークです。つまり、データの操作を目的としたプロジェクトを作成し、そのようなプロジェクトを管理するように設計されています。最近、同社はそれをオープンソースのカテゴリーに移した。Metaflowフレー...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>10分でメタフローを学ぶ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/482462/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metaflowは、Netflixで作成され、データサイエンスの分野に焦点を当てたPythonフレームワークです。</font><font style="vertical-align: inherit;">つまり、データの操作を目的としたプロジェクトを作成し、そのようなプロジェクトを管理するように設計されています。</font><font style="vertical-align: inherit;">最近、同社はそれをオープンソースのカテゴリーに移した。</font><font style="vertical-align: inherit;">Metaflowフレームワークは、過去2年間にNetflix内で広く使用されてきました。</font><font style="vertical-align: inherit;">特に、彼は生産プロジェクトの完了に必要な時間を大幅に削減することを許可しました。</font><font style="vertical-align: inherit;">
今日公開している資料は、メタフローの短いガイドです。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/yd/2j/7p/yd2j7p_dpzkyrjeef9us6a7pgs4.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メタフローとは何ですか？</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、NetflixでのMetaflowフレームワークの実装を示すグラフです。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6bd/bb8/297/6bdbb82972a098b8fd241f42d7f55b51.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netflixでのメタフローの実装</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
2018年11月、このフレームワークは同社の134のプロジェクトで使用されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メタフローは、データサイエンスワークフローを作成および実行するためのフレームワークです。</font><font style="vertical-align: inherit;">次の機能を備えています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンピューティングリソース管理。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナ化されたタスクの起動。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外部依存関係の管理。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バージョン管理、タスクの再実行、中断されたタスクの実行の継続。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jupyter Notebook環境で使用できるタスクの結果を調べるためのクライアントAPI。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカル（ラップトップなど）およびリモート（クラウド内）のタスク実行のサポート。</font><font style="vertical-align: inherit;">これらのモードを切り替える機能。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーvtuulos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メタフローがコード、データ、依存関係のスナップショット（スナップショット）を自動的に作成できると</font><font style="vertical-align: inherit;">Ycombinatorに</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">書い</font></a><font style="vertical-align: inherit;">ています。これらすべては、ローカルファイルシステムもサポートされていますが、コンテンツによってアドレス指定されるリポジトリでホストされます。これにより、停止したタスクの実行を継続し、以前に取得した結果を再現し、Jupyter Notebookなどでタスクに関連するすべてを調べることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に、メタフローはデータサイエンティストの生産性を向上させることを目的としています。これは、フレームワークにより、関連するタスクを解くことによって邪魔されることなく、データの操作に専念できるという事実により行われます。さらに、メタフローは、本番環境でのメタフローに基づくプロジェクトの撤回を加速します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/311/176/d1631117682028c779664c90bef2a885.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼の直接の責任に関連するデータサイエンティストのニーズと、計算が実行されるインフラストラクチャに関連する補助タスクのソリューション</font></font></font></i><br>
 <br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metaflowを使用したワークフローシナリオ</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metaflowを使用して整理できるいくつかのワークフローシナリオを次に示します。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コラボレーション </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あるデータサイエンティストは、別のデータサイエンティストがエラーの原因を見つけるのを助けたいと考えています。</font><font style="vertical-align: inherit;">同時に、アシスタントは、クラッシュしたタスクが機能する環境全体をコンピューターにダウンロードしたいと考えています。</font></font></li>
<li><b>      ,    .</b>      (   ).   (  ).    ,        ,      (  ).</li>
<li><b>  .</b>        ( —      ,      ),   ,     ( —   ),    .</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクの完了後に取得したメタデータの検査。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3人のデータサイエンティストが同じモデルのハイパーパラメータの選択に従事し、このモデルの精度を向上させようとしています。</font><font style="vertical-align: inherit;">その後、モデルをトレーニングするためのタスクの結果を分析し、最適であることが示されているハイパーパラメーターのセットを選択する必要があります。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じパッケージの複数のバージョンを使用する。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトでは、たとえばsklearnライブラリなど、さまざまなバージョンを使用する必要があります。</font><font style="vertical-align: inherit;">前処理中にバージョン0.20が必要であり、モデリング中にバージョン0.22が必要です。</font></font></li>
</ul><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般的なメタフローワークフロー</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
概念的およびプログラミングの観点から、典型的なメタフローワークフローを検討します。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MetaMetaflowワークフローの概念図</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
概念的な観点から見ると、メタフローワークフロー（タスクチェーン）は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有向非循環グラフ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（DAG）で</font><font style="vertical-align: inherit;">表され</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以下の図は、このアイデアをよりよく理解するのに役立ちます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/584/53d/52e/58453d52e9dfbd50dcc5b974ffae11e1.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">線形非循環グラフ</font></font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d7/a8d/810/3d7a8d81017d4112913a5c081c70b9a8.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「並列」パスを持つ非循環グラフグラフの</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
各ノードは、ワークフローのデータ処理ステップを表します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクチェーンのすべてのステップで、Metaflowは特別な変更を加えずに通常のPythonコードを実行します。</font><font style="vertical-align: inherit;">コードは、コードがその依存関係とともにパックされる個別のコンテナーで実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metaflowアーキテクチャの重要な側面は、プラグインを使用せずに、condaエコシステムからのほとんどすべての外部ライブラリを、それに基づくプロジェクトに実装できるという事実によって表されます。</font><font style="vertical-align: inherit;">これは、メタフローを他の同様の汎用ソリューションと区別します。</font><font style="vertical-align: inherit;">たとえば-Airflowから。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">programmingプログラミングに関するメタフローワークフロー</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各タスクチェーン（スレッド）は</font></font><code>Flow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次の最小要件を満たしている場合</font><font style="vertical-align: inherit;">、標準のPythonクラス（通常、そのようなクラスの名前に単語が含まれています）として表すことができ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスはMetaflowクラスの子孫です</font></font><code>FlowSpec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクチェーンのステップを表す各関数には、デコレータが適用されてい</font></font><code>@step</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各</font></font><code>@step</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">の終わりに、</font><font style="vertical-align: inherit;">それに続く同様の関数の表示がなければなりません。</font><font style="vertical-align: inherit;">これは、このタイプの設計で行うことができます</font></font><code>self.next(self.function_name_here)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスは関数</font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とを</font><font style="vertical-align: inherit;">実装します</font></font><code>end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3つのノードで構成される最小限のタスクチェーンの例を考えてみます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼女のスキームは次のようになります。</font></font><br>
<br>
<pre><code class="python hljs">start → process_message → end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが彼女のコードです：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> metaflow <span class="hljs-keyword">import</span> FlowSpec, step<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinearFlow</span>(<span class="hljs-params">FlowSpec</span>):</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"""
&nbsp;&nbsp;&nbsp;&nbsp; ,      Metaflow.
&nbsp;&nbsp;&nbsp;&nbsp;"""</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#  </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.message = <span class="hljs-string">'Thanks for reading.'</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.next(self.process_message)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">process_message</span>(<span class="hljs-params">self</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(<span class="hljs-string">'the message is: %s'</span> % self.message)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.next(self.end)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">end</span>(<span class="hljs-params">self</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(<span class="hljs-string">'the message is still: %s'</span> % self.message)<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;LinearFlow()</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metaflowインストール手順</font></font></font></h2><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍インストールと試運転</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metaflowを初めてインストールして起動するために実行する必要がある一連の手順は次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metaflowをインストールします（Python 3の使用を推奨）</font></font><code>pip3 install metaflow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上記のコードフラグメント（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ではGitHubにあります）をファイルに入れます</font></font><code>linear_flow.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このコードによって実装されたタスクチェーンのアーキテクチャを確認するには、コマンドを使用し</font></font><code>python3 linear_flow.py show</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリームを開始するには、コマンドを実行し</font></font><code>python3 linear_flow.py run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下に示すようなものを取得する必要があります。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/281/5af/ec5/2815afec51573d8a01db3cd8b4ae19e0.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功したメタフローヘルスチェック</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ここでは、いくつかのことに注意する必要があります。</font><font style="vertical-align: inherit;">メタフローフレームワークはローカルデータストレージを作成します</font></font><code>.metaflow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。そこでは、タスク実行に関連するすべてのメタデータと、タスク実行セッションに関連付けられたスナップショットが保存されます。クラウドデータストレージに関連するメタフロー設定を構成している場合、スナップショットはAWS S3バケットに保存され、タスクの起動に関連するメタデータはRDS（リレーショナルデータストア、リレーショナルデータストア）に基づいてメタデータサービスに送られます。後で、クライアントAPIを使用してこのメ​​タデータを探索する方法について説明します。重要ですが、注目に値するもう1つの些細なことは、異なるステップに付加されたプロセス識別子（pid、プロセスID）が異なることです。覚えておいてください-メタフローはタスクチェーンの各ステップを独立してコンテナー化し、独自の環境で各ステップを実行する（ステップ間でデータのみを渡す）と述べました。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">concondaのインストールと構成（依存関係を実装する場合）</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の手順に従ってcondaをインストールします。</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minicondaを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ダウンロード</font></a><font style="vertical-align: inherit;">してインストールします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">condaチャネルを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">し</font></a></font><code>conda config --add channels conda-forge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、タスクチェーンにcondaの依存関係を埋め込む準備ができました。</font><font style="vertical-align: inherit;">このプロセスの詳細については、以下で説明します。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現実的なワークフローの例</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記では、Metaflowをインストールする方法、およびシステムが動作可能であることを確認する方法について説明しました。</font><font style="vertical-align: inherit;">さらに、ワークフローアーキテクチャの基本について説明し、簡単な例を示しました。</font><font style="vertical-align: inherit;">ここでは、メタフローの概念の一部を明らかにしながら、より複雑な例を見ていきます。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍仕事</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の機能を実装するメタフローツールを使用してワークフローを作成します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSVムービーデータをPandasデータフレームに読み込みます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジャンルの四分位数の並列計算。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">計算結果を辞書に保存します。</font></font></li>
</ul><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍タスクチェーン</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスのスケルトンを以下に示します</font></font><code>GenreStatsFlow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">それを分析した後、あなたは私たちの問題を解決するためにここで実装されたアプローチの本質を理解するでしょう。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> metaflow <span class="hljs-keyword">import</span> FlowSpec, step, catch, retry, IncludeFile, Parameter<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenreStatsFlow</span>(<span class="hljs-params">FlowSpec</span>):</span>
&nbsp;&nbsp;<span class="hljs-string">"""
&nbsp;&nbsp;&nbsp;&nbsp;,  ,   .

&nbsp;&nbsp;&nbsp;&nbsp;     :
&nbsp;&nbsp;&nbsp;&nbsp;1)  CSV-   Pandas.
&nbsp;&nbsp;&nbsp;&nbsp;2)     .
&nbsp;&nbsp;&nbsp;&nbsp;3)     .
&nbsp;&nbsp;"""</span><font></font>
&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"""
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1)      Pandas.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2)    .
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3)        .
&nbsp;&nbsp;&nbsp;&nbsp;"""</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># <span class="hljs-doctag">TODO:</span>  CSV     </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;self.genres = []<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;self.next(self.compute_statistics, foreach=<span class="hljs-string">'genres'</span>) <span class="hljs-comment">#  1</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;@catch(var=<span class="hljs-string">'compute_failed'</span>) <span class="hljs-comment">#  2</span>
&nbsp;&nbsp;@retry(times=<span class="hljs-number">1</span>) <span class="hljs-comment">#  3</span><font></font>
&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compute_statistics</span>(<span class="hljs-params">self</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"""    .   ."""</span>
&nbsp;&nbsp;&nbsp;&nbsp;self.genre = self.input <span class="hljs-comment">#  4</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># <span class="hljs-doctag">TODO:</span>    </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;self.next(self.join)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">join</span>(<span class="hljs-params">self, inputs</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"""       ."""</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># <span class="hljs-doctag">TODO:</span>  </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;self.next(self.end)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">end</span>(<span class="hljs-params">self</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"""End the flow."""</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">pass</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
&nbsp;&nbsp;GenreStatsFlow()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例のいくつかの重要な部分を検討してください。</font><font style="vertical-align: inherit;">コードには、</font></font><code>#  n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下で参照する</font><font style="vertical-align: inherit;">種類のコメントが含まれ</font><font style="vertical-align: inherit;">ています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では</font></font><code> 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ステップで</font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、パラメータに注意を払います</font></font><code>foreach</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そのおかげ</font></font><code>compute_statistics</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、ループ内</font><font style="vertical-align: inherit;">のステップの並列コピーが</font></font><code>for each</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リストの各エントリに対して</font><font style="vertical-align: inherit;">実行さ</font><font style="vertical-align: inherit;">れます</font></font><code>genres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"></font><code> 2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デコレータはなり</font></font><code>@catch(var='compute_failed')</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップで発生した例外をキャッチ</font></font><code>compute_statistics</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、それを変数に書き込み</font></font><code>compute_failed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（それは次のステップで読み取ることができます）。</font></font></li>
<li> <code> 3</code>  <code>@retry(times=1)</code>   ,     .  , ,   ,   .</li>
<li>  <code> 4</code>,  <code>compute_statistics</code>,  <code>self.input</code>?   ,  <code>input</code> —   ,  Metaflow.   ,     <code>compute_statistics</code> (    ,  ).    Metaflow  ,      ,  ,    .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、同じ関数を並列に実行する例です- </font></font><code>compute_statistics</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ただし、必要に応じて、互いに関係のない完全に異なる機能を並行して起動できます。</font><font style="vertical-align: inherit;">これを行うには、のように</font></font><code> 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、に</font><font style="vertical-align: inherit;">表示されるものを変更する必要があります</font></font><code>self.next(self.func1, self.function2, self.function3)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">もちろん、このアプローチでは</font></font><code>join</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、さまざまな関数の結果を処理できる</font><font style="vertical-align: inherit;">ように、ステップを書き換える必要</font><font style="vertical-align: inherit;">があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のクラスのスケルトンを表す方法を次に示します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7af/b4b/d00/7afb4bd00f2cea2df0ebf9fff780b8d2.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジャンルスタッツフロークラスの視覚的表現</font></font></font></i><br>
 <br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dataデータファイルを読み取り、パラメータを転送する</font></font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">映画のCSVファイルを</font><font style="vertical-align: inherit;">ダウンロードし</font><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次に、ファイルパス</font></font><code>movie_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と値</font><font style="vertical-align: inherit;">をジョブチェーンに動的に転送する機能をサポートするプログラムをプログラムに装備する必要があります</font></font><code>max_genres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">外部引数のメカニズムは、これに役立ちます。</font><font style="vertical-align: inherit;">メタフローでは、ワークフロー開始コマンドで追加のフラグを使用して、プログラムに引数を渡すことができます。</font><font style="vertical-align: inherit;">たとえば、次のようになります</font></font><code>python3 tutorial_flow.py run --movie_data=path/to/movies.csv --max_genres=5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metaflowは、</font><font style="vertical-align: inherit;">ワークフローコードの入力を読み取る</font><font style="vertical-align: inherit;">ための開発者</font></font><code>IncludeFile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">オブジェクト</font></font><code>Parameter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を提供します。</font><font style="vertical-align: inherit;">オブジェクト</font></font><code>IncludeFile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>Parameter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラス変数を</font><font style="vertical-align: inherit;">割り当てることで引数を渡すようにアピールし</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">それは、私たちが何を読みたいか、ファイル、または通常の値に依存します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドラインから起動したときにプログラムに渡されたパラメーターを読み取るコードは次のようになります。</font></font><br>
<br>
<pre><code class="python hljs">&nbsp;&nbsp;&nbsp;&nbsp;movie_data = IncludeFile(<span class="hljs-string">"movie_data"</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=<span class="hljs-string">"The path to a movie metadata file."</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default = <span class="hljs-string">'movies.csv'</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;max_genres = Parameter(<span class="hljs-string">'max_genres'</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=<span class="hljs-string">"The max number of genres to return statistics for"</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default=<span class="hljs-number">5</span>)</code></pre><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conタスクチェーンにcondaを含める</font></font></font></h3><br>
<ul>
<li>     conda —     ,     conda.</li>
<li>   <code>GenreStatsFlow</code>  <code>@conda_base</code>,  Metaflow.   ,     python.      ,  ,   .   ,         .<br>
<br>
<pre><code class="plaintext hljs">def get_python_version():<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;"""<font></font>
&nbsp;&nbsp;&nbsp;&nbsp; ,    python,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;   .   &nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;  conda   <font></font>
&nbsp;&nbsp;&nbsp;&nbsp; python.<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;"""<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;import platform<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;versions = {'2' : '2.7.15',<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'3' : '3.7.4'}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;return versions[platform.python_version_tuple()[0]]<font></font>
<font></font>
#       python.<font></font>
@conda_base(python=get_python_version())<font></font>
class GenreStatsFlow(FlowSpec):</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これ</font></font><code>@conda</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、タスクチェーンの任意のステップに</font><font style="vertical-align: inherit;">デコレータ</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">追加できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">パラメータを介して渡される依存関係のあるオブジェクトが必要</font></font><code>libraries</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">メタフローは、ステップを開始する前に、指定された依存関係を持つコンテナーを準備するタスクを引き受けます。</font><font style="vertical-align: inherit;">Metaflowは各ステップを個別のコンテナーで起動するため、必要に応じて、異なるステップで異なるバージョンのパッケージを完全に安全に使用できます。</font></font><br>
 <br>
<pre><code class="python hljs">&nbsp;&nbsp;&nbsp;&nbsp;@conda(libraries={<span class="hljs-string">'pandas'</span> : <span class="hljs-string">'0.24.2'</span>})<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のコマンドを実行します</font></font><code>python3 tutorial_flow.py --environment=conda run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍ステップ実装開始</font></font></font></h3><br>
<pre><code class="python hljs"><span class="hljs-meta">@conda(libraries={'pandas' : '0.24.2'})</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"""
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1)      Pandas.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2)    .
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3)        .
&nbsp;&nbsp;&nbsp;&nbsp;"""</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">import</span> pandas
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#      Pandas.</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.dataframe = pandas.read_csv(StringIO(self.movie_data))<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   'genres'      . </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   .</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.genres = {genre <span class="hljs-keyword">for</span> genres \
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">in</span> self.dataframe[<span class="hljs-string">'genres'</span>] \
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span> genre <span class="hljs-keyword">in</span> genres.split(<span class="hljs-string">'|'</span>)}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.genres = list(self.genres)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#        .&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#  'foreach'     &nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#  </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.next(self.compute_statistics, foreach=<span class="hljs-string">'genres'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードのいくつかの機能を検討してください：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pandasインポート式は、ステップを説明する関数内にあることに注意してください。</font><font style="vertical-align: inherit;">実際、この依存関係はcondaによってこのステップの範囲でのみ導入されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ただし、ここで宣言された変数（</font></font><code>dataframe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><code>genres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）は、このステップの後に実行されるコードステップでも使用できます。</font><font style="vertical-align: inherit;">ここでのポイントは、メタフローはコード実行環境を分離するという原則に基づいて機能しますが、データがタスクチェーンのステップ間で自然に移動できるようにすることです。</font></font></li>
</ul><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the compute_statisticsステップの実装</font></font></font></h3><br>
<pre><code class="python hljs"><span class="hljs-meta">@catch(var='compute_failed')</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@retry<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@conda(libraries={<span class="hljs-string">'pandas'</span> : <span class="hljs-string">'0.25.3'</span>})<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compute_statistics</span>(<span class="hljs-params">self</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"""
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    .
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"""</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># 'input'.</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.genre = self.input<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(<span class="hljs-string">"Computing statistics for %s"</span> % self.genre)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#         , </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#        .</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector = self.dataframe[<span class="hljs-string">'genres'</span>].\<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apply(<span class="hljs-keyword">lambda</span> row: self.genre <span class="hljs-keyword">in</span> row)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.dataframe = self.dataframe[selector]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.dataframe = self.dataframe[[<span class="hljs-string">'movie_title'</span>, <span class="hljs-string">'genres'</span>, <span class="hljs-string">'gross'</span>]]<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     gross   .</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;points = [<span class="hljs-number">.25</span>, <span class="hljs-number">.5</span>, <span class="hljs-number">.75</span>]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.quartiles = self.dataframe[<span class="hljs-string">'gross'</span>].quantile(points).values<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#  ,    .</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.next(self.join)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このステップでは</font></font><code>dataframe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、前のステップで宣言された</font><font style="vertical-align: inherit;">変数</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">参照していることに注意してください</font></font><code>start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この変数を変更しています。</font><font style="vertical-align: inherit;">次のステップに進むとき、この方法は、新しく変更されたオブジェクトの使用を意味し、データを使用</font></font><code>dataframe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">して効果的な作業を整理することができます。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the結合ステップを実装する</font></font></font></h3><br>
<pre><code class="python hljs"><span class="hljs-meta">@conda(libraries={'pandas' : '0.25.3'})</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;@step<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">join</span>(<span class="hljs-params">self, inputs</span>):</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"""
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;       .
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"""</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inputs = inputs[<span class="hljs-number">0</span>:self.max_genres]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   ,    .</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.genre_stats = {inp.genre.lower(): \<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="hljs-string">'quartiles'</span>: inp.quartiles,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">'dataframe'</span>: inp.dataframe} \
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span> inp <span class="hljs-keyword">in</span> inputs}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.next(self.end)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、いくつかのポイントを強調しておきます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このステップでは、完全に異なるバージョンのパンダライブラリを使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配列の各要素</font></font><code>inputs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、以前に実行された</font><font style="vertical-align: inherit;">要素の</font><font style="vertical-align: inherit;">コピーを表します</font></font><code>compute_statistics</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これには、対応する関数実行の状態、つまりさまざまな変数の値が含まれます。</font><font style="vertical-align: inherit;">だから、それは</font></font><code>input[0].quartiles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジャンルの四分位数を含むことができ</font></font><code>comedy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そして</font></font><code>input[1].quartiles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ジャンルの四分位</font></font><code>sci-fi</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍下書き</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで確認した完全なプロジェクトコードは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルに記述されているワークフローがどのように機能するかを確認</font></font><code>tutorial_flow.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するには、次のコマンドを実行する必要があります。</font></font><br>
<br>
<pre><code class="python hljs">python3 tutorial_flow.py --environment=conda show</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコマンドを使用してワークフローを開始します。</font></font><br>
<br>
<pre><code class="python hljs">python3 tutorial_flow.py --environment=conda run --movie_data=path/to/movies.csv --max_genres=<span class="hljs-number">7</span></code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアントAPIを使用したワークフローの起動結果の調査</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データのスナップショットとワークフローの以前の起動のステータスを調べるために</font><font style="vertical-align: inherit;">、Metaflowが提供する</font><font style="vertical-align: inherit;">クライアント</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APIを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このAPIは、Jupyter Notebook環境で実行された実験の詳細を探索するのに理想的です。</font><font style="vertical-align: inherit;">最後に成功した実行のデータから取得し</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
た変数を出力する簡単な例を次に示し</font></font><code>genre_stats</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font><code>GenreStatsFlow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> metaflow <span class="hljs-keyword">import</span> Flow, get_metadata<font></font>
<font></font>
<span class="hljs-comment">#     </span>
print(<span class="hljs-string">"Using metadata provider: %s"</span> % get_metadata())<font></font>
<font></font>
<span class="hljs-comment">#     MovieStatsFlow.</span>
run = Flow(<span class="hljs-string">'GenreStatsFlow'</span>).latest_successful_run<font></font>
print(<span class="hljs-string">"Using analysis from '%s'"</span> % str(run))<font></font>
<font></font>
genre_stats = run.data.genre_stats<font></font>
print(genre_stats)</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドでワークフローを実行する</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常のコンピューターでワークフローを作成してテストした後は、作業を高速化するためにクラウドでコードを実行する必要が生じる可能性が高くなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、MetaflowはAWSとの統合のみをサポートしています。</font><font style="vertical-align: inherit;">次の画像では、Metaflowによって使用されるオンプレミスリソースとクラウドリソースのマッピングを確認できます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08a/acc/458/08aacc458fc3202ec08624422bef0cb4.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MetaflowとAWSの統合MetaflowをAWS</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
に接続するには、次の手順を完了する必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、Metaflowで使用できるリソースを作成して、ワンタイムAWSセットアップを実行する必要があります。</font><font style="vertical-align: inherit;">たとえば、ワークフローの結果を互いに示す作業チームのメンバーが同じリソースを使用できます。</font><font style="vertical-align: inherit;">ここで関連する手順を見つける</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こと</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ができます。</font><font style="vertical-align: inherit;">MetaflowにはCloudFormation設定テンプレートがあるため、設定は十分に高速です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次に、ローカルコンピューターでコマンドを実行し、</font></font><code>metaflow configure aws</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムの質問に対する回答を入力</font><font style="vertical-align: inherit;">する必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このデータにより、Metaflowはクラウドベースのデータウェアハウスを使用できるようになります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これで、クラウドでローカルワークフローを開始するには、ワークフロー開始コマンドにキーを追加するだけ</font></font><code>--with batch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">たとえば、次のようになります</font></font><code>python3 sample_flow.py run --with batch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ワークフローのハイブリッド起動を実行するには、つまり、一部の手順をローカルで実行し、一部をクラウドで実行するには、クラウドで</font></font><code>@batch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行する必要がある手順に</font><font style="vertical-align: inherit;">デコレーター</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">追加する</font><font style="vertical-align: inherit;">必要があります。</font><font style="vertical-align: inherit;">たとえば、次のようになります</font></font><code>@batch(cpu=1, memory=500)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、このフレームワークの利点と欠点の両方と見なすことができるMetaflowのいくつかの機能に注意したいと思います。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MetaflowはAWSと緊密に統合されています。</font><font style="vertical-align: inherit;">ただし、フレームワーク開発計画には、より多くのクラウドプロバイダーのサポートが含まれています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metaflowは、コマンドラインインターフェイスのみをサポートするツールです。</font><font style="vertical-align: inherit;">（Airflowなどの作業プロセスを整理するための他のユニバーサルフレームワークとは異なり）グラフィカルインターフェイスはありません。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読者の皆様！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metaflowを使用する予定はありますか？</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja482450/index.html">MVPは2019年に製品またはMVPでの私の経験に成長しました</a></li>
<li><a href="../ja482452/index.html">ブラジルのシステムは神話ではありません。ITでの使用方法</a></li>
<li><a href="../ja482456/index.html">FunCode、またはiOS開発者向けのコンテストの開催方法</a></li>
<li><a href="../ja482458/index.html">私が知らなかった5つのPython機能-無駄</a></li>
<li><a href="../ja482460/index.html">SQLハウツー：SQLで冷ややかなパターンを描く</a></li>
<li><a href="../ja482464/index.html">Pythonの* argsおよび** kwargsとは何ですか？</a></li>
<li><a href="../ja482466/index.html">Vue 3.0に備えるためにできる5つのこと</a></li>
<li><a href="../ja482468/index.html">フロントエンド開発者の生活を変えることができるVS Codeの5つの拡張機能とテーマ</a></li>
<li><a href="../ja482470/index.html">最もシンプルで安価な電話でのページの高速読み込み</a></li>
<li><a href="../ja482472/index.html">JavaScriptは何でできていますか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>