<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëØ ü•õ ‚ö†Ô∏è EF Core + Oracle: comment rendre les migrations idempotentes üëú üë©üèº‚Äçü§ù‚Äçüë®üèª ü§¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En r√®gle g√©n√©rale, le cadre EF Core est utilis√© conjointement avec MS SQL, un autre produit Microsoft. Cependant, ce n'est pas un dogme. Par exemple, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>EF Core + Oracle: comment rendre les migrations idempotentes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/494278/"><img src="https://habrastorage.org/webt/3a/lj/or/3aljorcjihhefstlxuybizl-3tg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, le cadre EF Core est utilis√© conjointement avec MS SQL, un autre produit Microsoft. </font><font style="vertical-align: inherit;">Cependant, ce n'est pas un dogme. </font><font style="vertical-align: inherit;">Par exemple, chez CUSTIS, nous √©crivons la logique m√©tier en C #, et nous utilisons Oracle pour g√©rer les bases de donn√©es. </font><font style="vertical-align: inherit;">EF Core a un merveilleux m√©canisme de migration, mais dans notre cas, ils ne sont pas idempotents. </font><font style="vertical-align: inherit;">Le fait est qu'Oracle et un certain nombre d'autres bases de donn√©es, telles que MySQL, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne prennent pas en charge le DDL transactionnel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cela signifie que si la migration se situe quelque part au milieu, elle ne peut pas √™tre annul√©e ou annul√©e. </font><font style="vertical-align: inherit;">Comment impl√©menter des migrations idempotentes vers EF Core sans MS SQL?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre entreprise dispose d'un outil assez puissant pour installer des correctifs sur une base de donn√©es Oracle, que nous utilisons dans un certain nombre de projets. </font><font style="vertical-align: inherit;">Il a √©t√© √©crit quand il n'y avait pas de migrations Liquibase, EF et autres outils ouverts. </font><font style="vertical-align: inherit;">Patcher vous permet de travailler avec des centaines de bases de donn√©es, de suivre l'historique de l'installation, d'afficher les journaux, de stocker les secrets et bien plus encore. </font><font style="vertical-align: inherit;">Les scripts de modification de la base de donn√©es sont √©crits sous forme de macros SQL ou m4. </font><font style="vertical-align: inherit;">Avec leur aide, vous pouvez, entre autres, modifier la structure: cr√©er des tableaux, des colonnes et d'autres objets. </font><font style="vertical-align: inherit;">De plus, les macros m4 sont idempotentes. </font><font style="vertical-align: inherit;">Cela signifie que si vous essayez de cr√©er, par exemple, la table, le script ne tombe pas, mais voit qu'il existe d√©j√† et ignore la cr√©ation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons qu'un script pour installer un correctif se compose de deux op√©rations:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ez la table A.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation du tableau B.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le script se bloque apr√®s la premi√®re op√©ration, la table A reste dans Oracle. La r√©application du correctif fonctionnera correctement: le script v√©rifiera que A existe d√©j√†, il passera donc imm√©diatement √† la deuxi√®me op√©ration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus des avantages, le patcher a toujours un inconv√©nient - l'outil est ferm√© et n'est utilis√© que dans CUSTIS. Les d√©veloppeurs doivent apprendre √† travailler avec lui, et en dehors de l'entreprise, une telle exp√©rience n'est pas tr√®s pr√©cieuse. De plus, le patcher ne prend pas en charge le mode de fonctionnement Code First, de sorte que tous les scripts de modification de la structure de la base de donn√©es doivent √™tre √©crits manuellement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulions essayer un m√©canisme pr√™t √† l'emploi pour installer des correctifs et avons choisi la migration. Fin 2019, un autre projet vient d'√™tre lanc√© pour le client, sur lequel nous avons d√©cid√© de tester une nouvelle approche. Le principal probl√®me de ce m√©canisme √©tait la non-id√©alit√© des migrations.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probl√®me</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans MS SQL, une cha√Æne d'instructions DDL ou de migration est effectu√©e comme une transaction compos√©e unique. </font><font style="vertical-align: inherit;">En cas d'interruption, l'op√©ration est compl√®tement annul√©e. </font><font style="vertical-align: inherit;">Oracle DDL n'est pas transactionnel, donc une baisse de la migration entra√Ænera un √©tat incoh√©rent de la base de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Revenons au patch, qui se compose de deux op√©rations: cr√©ation des tables A et B. Si le migrateur tombe apr√®s la premi√®re, Oracle restera dans la table A. Le red√©marrage ne fonctionnera pas - l'op√©rateur </font></font><code>CREATE TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'aimera pas que A existe d√©j√†. </font><font style="vertical-align: inherit;">Il ne r√©ussira pas non plus √† annuler la migration: EF Core √©crit dans la table syst√®me que la migration est termin√©e, uniquement √† la toute fin du processus. </font><font style="vertical-align: inherit;">Du point de vue d'EF Core, si la migration n'est pas encore termin√©e, il n'y a rien √† annuler.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©cision</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recherche d'une solution pr√™te √† l'emploi pour Oracle sur Internet n'a donn√© aucun r√©sultat. Tout ce que j'ai trouv√©, ce sont des articles sur la fa√ßon d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√©crire</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et d'&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">installer des</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> correctifs lorsque vous travaillez avec EF. Un peu plus tard, sur StackOverflow, j'ai eu l'id√©e de cr√©er mon </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMigrationsSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cette interface est charg√©e de g√©n√©rer du code SQL qui traite les op√©rations EF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le package </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oracle.EntityFrameworkCore</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comprenait OracleMigrationsSqlGenerator, impl√©mente IMigrationsSqlGenerator. Par exemple, si vous souhaitez ajouter une colonne, le code suivant sera g√©n√©r√©:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> MY_TABLE <span class="hljs-keyword">ADD</span> (MY_COLUMN <span class="hljs-built_in">DATE</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, le code est transmis √† d'autres classes pour s'ex√©cuter dans la base de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, j'ai essay√© de remplacer une paire d'op√©rations OracleMigrationsSqlGenerator. </font><font style="vertical-align: inherit;">La t√¢che s'est av√©r√©e tout √† fait r√©alisable et j'ai commenc√© √† √©crire un migrant idempotent. </font><font style="vertical-align: inherit;">C'est ainsi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu'est</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√© </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant l'op√©ration EF, notre migrateur v√©rifie si elle a d√©j√† √©t√© effectu√©e. </font><font style="vertical-align: inherit;">Par exemple, une colonne est ajout√©e comme ceci:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span>
    i <span class="hljs-built_in">NUMBER</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> i
    <span class="hljs-keyword">FROM</span> user_tab_columns
    <span class="hljs-keyword">WHERE</span> table_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_TABLE'</span>) <span class="hljs-keyword">AND</span> column_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_COLUMN'</span>);<font></font>
    IF I != 1 THEN<font></font>
        <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">IMMEDIATE</span> <span class="hljs-string">'ALTER TABLE MY_TABLE ADD (MY_COLUMN DATE)'</span>;  
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;       
<span class="hljs-keyword">END</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En utilisant</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilisation du package est tr√®s simple - il vous suffit de le remplacer </font></font><code>IMigrationsSqlGenerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le bon contexte:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnConfiguring</span>(<span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span>)</span><font></font>
    {<font></font>
        optionsBuilder.ReplaceService&lt;IMigrationsSqlGenerator, IdempotentSqlGenerator&gt;();<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les migrations sont form√©es et d√©finies par les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outils standard pour EF Core</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs">dotnet ef migrations <span class="hljs-keyword">add</span> v1<span class="hljs-number">.0</span><span class="hljs-number">.1</span>
dotnet ef database update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'approche g√©n√©rale d√©finie dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut √™tre impl√©ment√©e dans des g√©n√©rateurs √©crits pour MySQL, MariaDB, Teradata, AmazonAurora et d'autres bases de donn√©es dans lesquelles DDL n'est pas transactionnel.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©f√©rences</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le package est disponible sur NuGet </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources sur GitHub</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr494264/index.html">Cluster √† deux n≈ìuds - le diable en d√©tail</a></li>
<li><a href="../fr494266/index.html">√Ä propos d'Udalenka, du RDP non prot√©g√© et de l'augmentation du nombre de serveurs disponibles sur Internet</a></li>
<li><a href="../fr494270/index.html">Antiquit√©s: travail √† distance sur des appareils de 1998</a></li>
<li><a href="../fr494272/index.html">Cr√©ation d'un plan d'affaires de d√©marrage informatique: structure d√©taill√©e √©tape par √©tape</a></li>
<li><a href="../fr494274/index.html">Syst√®me d'autotest e-commerce</a></li>
<li><a href="../fr494286/index.html">Embox RTOS sur Raspberry Pi</a></li>
<li><a href="../fr494290/index.html">#YAMYWork. Une d√©cision qui peut √™tre juste</a></li>
<li><a href="../fr494292/index.html">Wrike: 5 ans avec OKR</a></li>
<li><a href="../fr494294/index.html">Impression 3D certifi√©e pour les industries p√©troli√®re et gazi√®re et marine</a></li>
<li><a href="../fr494296/index.html">Xiaomi Gateway (version europ√©enne - Lumi.gateway.mieu01) pirat√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>