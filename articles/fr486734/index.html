<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎯 📩 👌🏾 Architecture pure avec Typescript: DDD et architecture en couches ☪️ 🥠 🛅</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Récemment, j'ai accordé beaucoup d'attention à l'architecture et j'ai décidé de partager avec la communauté une traduction de l'article...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Architecture pure avec Typescript: DDD et architecture en couches</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486734/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font><font style="vertical-align: inherit;">Récemment, j'ai accordé beaucoup d'attention à l'architecture et j'ai décidé de partager avec la communauté une traduction de l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture propre avec Typescript: DDD, Oignon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">André Bazaglia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis plus de 6 ans de mon expérience professionnelle, j'ai eu l'opportunité de travailler dans des entreprises de technologie cool qui accordent beaucoup d'attention à la haute disponibilité et à la qualité du code. </font><font style="vertical-align: inherit;">J'ai dû faire face à des situations critiques lorsque des bogues ou même un deuxième temps d'arrêt du système étaient inacceptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le but de cet article n'est pas une couverture détaillée de sujets complexes sur DDD et l'architecture en couches, mais un exemple de la mise en œuvre de ces deux approches dans Typescript. </font><font style="vertical-align: inherit;">Le projet utilisé est basique et peut être affiné et étendu, par exemple, en utilisant l'approche </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CQRS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi DDD?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les produits logiciels créés doivent implémenter les exigences commerciales définies. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche simplifie le test de la couche de domaine, ce qui vous permet de vous assurer que toutes les exigences commerciales sont prises en compte et d'écrire du code résistant aux erreurs de longue durée. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DDD en combinaison avec une architecture en couches évite l'effet domino lorsque la modification du code à un endroit entraîne d'innombrables bugs à différents endroits.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi une architecture en couches?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche va bien avec DDD, car tout le système est construit autour d'un modèle de domaine, qui est le cercle central dans l'image ci-dessous. Les couches internes ne dépendent pas directement des couches externes et les utilisent par injection. De plus, nous bénéficions d'une excellente flexibilité, chaque couche a donc son propre domaine de responsabilité et les données entrantes sont validées par chaque couche en fonction de ses besoins. Et par conséquent, les couches internes reçoivent toujours des données valides des couches externes. Sans parler des tests: les tests unitaires deviennent plus faciles avec l'utilisation de simulations de dépendance basées sur des interfaces, ce qui vous permet de faire abstraction des parties externes du système, telles que les bases de données. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/at/ex/qsatexfqebsdg9n1gwlnga_vuuc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le cas de Typescript et Javascript, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inversion de contrôle (via Dependency Inversion)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">signifie l'incorporation (passage) de dépendances via des paramètres au lieu d'une importation explicite. </font><font style="vertical-align: inherit;">Dans l'exemple de code suivant, nous utiliserons la bibliothèque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inversify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui nous permet de décrire les dépendances à l'aide de décorateurs afin que les classes créées ultérieurement puissent avoir des conteneurs créés dynamiquement pour résoudre les dépendances.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour cette application simple ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons créer une application de panier d'achat simple qui peut gérer l'ajout de produits au panier. </font><font style="vertical-align: inherit;">Un panier peut avoir plusieurs règles commerciales, telles qu'une quantité minimale ou maximale pour chaque article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plongeons dans les profondeurs des couches d'application, commençons par la couche la plus interne et allons séquentiellement vers l'extérieur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Domaine</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La couche domaine, par définition, est l'habitat des règles métier. Il ne sait rien des couches externes, n'a aucune dépendance et peut être facilement testé. Même si vous modifiez l'intégralité de l'application, le domaine restera intact, car il ne contient que des règles métier disponibles pour comprendre leur objectif pour tous ceux qui lisent ce code. Cette couche doit être recouverte autant que possible de tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc une classe de base Entity, qui peut contenir une certaine logique commune à toutes les classes de domaine. Dans cet exemple, toute la logique courante consiste à générer un identifiant résistant aux collisions adapté à une mise à l'échelle horizontale, et tous les objets utiliseront cette approche.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> abstract <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entity</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<font></font>
  protected readonly _id: string<font></font>
  protected props: T<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(props: T, id?: string) {
    <span class="hljs-keyword">this</span>._id = id ? id : UniqueEntityID()
    <span class="hljs-keyword">this</span>.props = props<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// other common methods here...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir écrit la classe Entity, vous pouvez commencer à créer notre classe de domaine central qui étend la classe abstraite Entity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a rien de très compliqué dans cette classe, mais il y a des points intéressants auxquels vous devez faire attention. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Premièrement, le constructeur est privé, ce qui signifie que l'exécution de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new Cart ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> provoquera une erreur, ce dont nous avons besoin. Dans DDD, il est considéré comme une bonne pratique de conserver un objet de domaine toujours dans un état valide. Au lieu de créer directement un objet Cart vide, nous utilisons le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modèle Factory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui renvoie l'instance finie de la classe Cart. Pour garantir que la procédure de création a reçu tous les attributs requis, ils peuvent être validés. De même, les getters et setters sont utilisés pour interagir avec le domaine, pour cette raison même, l'état interne de la classe est stocké dans un objet </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">props</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> privé </font><font style="vertical-align: inherit;">. Les accesseurs fournissent un accès en lecture aux attributs qui devraient être publics. De même, les setters publics et autres méthodes vous permettent de changer de domaine avec une garantie constante de la validité de l'état de l'objet. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour résumer, nous pouvons souligner un point important: la logique du domaine doit se concentrer sur le comportement, et non sur les propriétés.</font></font></b><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cart</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Entity</span>&lt;<span class="hljs-title">ICartProps</span>&gt; </span>{<font></font>
  private <span class="hljs-keyword">constructor</span>({ id, ...data }: ICartProps) {
    <span class="hljs-keyword">super</span>(data, id)<font></font>
  }<font></font>
<font></font>
  public <span class="hljs-keyword">static</span> create(props: ICartProps): Cart {
    <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> Cart(props)
    <span class="hljs-keyword">return</span> instance<font></font>
  }<font></font>
<font></font>
  public unmarshal(): UnmarshalledCart {<font></font>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>.id,
      <span class="hljs-attr">products</span>: <span class="hljs-keyword">this</span>.products.map(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> ({
        <span class="hljs-attr">item</span>: product.item.unmarshal(),
        <span class="hljs-attr">quantity</span>: product.quantity<font></font>
      })),<font></font>
      <span class="hljs-attr">totalPrice</span>: <span class="hljs-keyword">this</span>.totalPrice<font></font>
    }<font></font>
  }<font></font>
<font></font>
  private <span class="hljs-keyword">static</span> validQuantity(quantity: number) {
    <span class="hljs-keyword">return</span> quantity &gt;= <span class="hljs-number">1</span> &amp;&amp; quantity &lt;= <span class="hljs-number">1000</span><font></font>
  }<font></font>
<font></font>
  private setProducts(products: CartItem[]) {<font></font>
    <span class="hljs-keyword">this</span>.props.products = products<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">get</span> <span class="hljs-title">id</span>(): <span class="hljs-title">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._id<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">get</span> <span class="hljs-title">products</span>(): <span class="hljs-title">CartItem</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.props.products<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">get</span> <span class="hljs-title">totalPrice</span>(): <span class="hljs-title">number</span> {
    <span class="hljs-keyword">const</span> cartSum = <span class="hljs-function">(<span class="hljs-params">acc: number, product: CartItem</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> acc + product.item.price * product.quantity<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.products.reduce(cartSum, <span class="hljs-number">0</span>)<font></font>
  }<font></font>
<font></font>
  public add(item: Item, <span class="hljs-attr">quantity</span>: number) {
    <span class="hljs-keyword">if</span> (!Cart.validQuantity(quantity)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidationError(
        <span class="hljs-string">'SKU needs to have a quantity between 1 and 1000'</span><font></font>
      )<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">const</span> index = <span class="hljs-keyword">this</span>.products.findIndex(
      <span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> product.item.sku === item.sku<font></font>
    )<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">const</span> product = {<font></font>
        ...this.products[index],<font></font>
        <span class="hljs-attr">quantity</span>: <span class="hljs-keyword">this</span>.products[index].quantity + quantity<font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">if</span> (!Cart.validQuantity(product.quantity)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidationError(<span class="hljs-string">'SKU exceeded allowed quantity'</span>)<font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">const</span> products = [<font></font>
        ...this.products.slice(<span class="hljs-number">0</span>, index),<font></font>
        product,<font></font>
        ...this.products.slice(index + <span class="hljs-number">1</span>)<font></font>
      ]<font></font>
<font></font>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.setProducts(products)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">const</span> products = [...this.products, { item, quantity }]
    <span class="hljs-keyword">this</span>.setProducts(products)<font></font>
  }<font></font>
<font></font>
  public remove(itemId: string) {<font></font>
    <span class="hljs-keyword">const</span> products = <span class="hljs-keyword">this</span>.products.filter(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> product.item.id !== itemId)
    <span class="hljs-keyword">this</span>.setProducts(products)
    <span class="hljs-keyword">this</span>.emitCartMutation()<font></font>
  }<font></font>
<font></font>
  public empty() {<font></font>
    <span class="hljs-keyword">this</span>.setProducts([])<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que notre objet Cart puisse être utilisé par l'application à l'aide de méthodes de domaine, dans certains cas, nous pouvons avoir besoin de le «déployer» dans un objet propre. </font><font style="vertical-align: inherit;">Par exemple, pour enregistrer dans la base de données ou envoyer au client en tant qu'objet JSON. </font><font style="vertical-align: inherit;">Cela peut être implémenté à l'aide de la méthode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unmarshal ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour augmenter la flexibilité de l'architecture, la couche de domaine peut également devenir une source d'événements de domaine. </font><font style="vertical-align: inherit;">Ici, l'approche </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Sourcing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut être appliquée </font><font style="vertical-align: inherit;">, avec la création d'événements lorsque les entités de domaine changent.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts utilisateur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous utiliserons des méthodes de domaine et des objets implémentés à partir du niveau d'infrastructure pour stocker des données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons la bibliothèque </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inversify</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour implémenter l'approche Inversion of Management, qui injecte le référentiel de la couche infrastructure dans ce scénario, nous offrant la possibilité de manipuler le panier à l'aide de méthodes de domaine et d'enregistrer les modifications dans la base de données par la suite.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { inject, injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">'inversify'</span><font></font>
<font></font>
@injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartService</span> </span>{<font></font>
  @inject(TYPES.CartRepository) private repository: CartRepository<font></font>
<font></font>
  private <span class="hljs-keyword">async</span> _getCart(id: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> cart = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.repository.getById(id)
      <span class="hljs-keyword">return</span> cart<font></font>
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">const</span> emptyCart = Cart.create({ id, <span class="hljs-attr">products</span>: [] })
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repository.create(emptyCart)<font></font>
    }<font></font>
  }<font></font>
<font></font>
  public getById(id: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repository.getById(id)<font></font>
  }<font></font>
<font></font>
  public <span class="hljs-keyword">async</span> add(cartId: string, <span class="hljs-attr">item</span>: Item, <span class="hljs-attr">sku</span>: number): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> cart = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._getCart(cartId)<font></font>
    cart.add(item, sku)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repository.update(cart)<font></font>
  }<font></font>
<font></font>
  public <span class="hljs-keyword">async</span> remove(cartId: string, <span class="hljs-attr">itemId</span>: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> cart = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._getCart(cartId)<font></font>
    cart.remove(itemId)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.repository.update(cart)<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette couche est responsable du fonctionnement de l'application. </font><font style="vertical-align: inherit;">Les modifications de code apportées à cette couche n'affectent pas les entités de domaine ou les dépendances externes comme une base de données.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastructure</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré toute l'évidence, la couche infrastructure interagit avec des systèmes externes, tels qu'une base de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour enregistrer des données dans la base de données, j'utilise les approches Data mapper et Repository. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mappeur peut obtenir les données source de la base de données et les convertir en l'objet de domaine correspondant:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { Cart, CartItem } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/domain/cart'</span><font></font>
<font></font>
<span class="hljs-keyword">const</span> getProducts = <span class="hljs-function">(<span class="hljs-params">products: CartItem[]</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> products.map(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> ({
    <span class="hljs-attr">item</span>: product.item,
    <span class="hljs-attr">quantity</span>: product.quantity<font></font>
  }))<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartMapper</span> </span>{<font></font>
  public <span class="hljs-keyword">static</span> toDomain(raw: any): Cart {
    <span class="hljs-keyword">return</span> Cart.create({
      <span class="hljs-attr">id</span>: raw.id,
      <span class="hljs-attr">couponCode</span>: raw.couponCode,
      <span class="hljs-attr">products</span>: getProducts(raw.products || [])<font></font>
    })<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le référentiel lui-même peut dépendre de la bibliothèque cliente d'une base de données particulière. </font><font style="vertical-align: inherit;">Par exemple, à partir du stockage en RAM, et utilisez ces méthodes pour gérer les données:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { injectable, inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'inversify'</span>
<span class="hljs-keyword">import</span> { Cart } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/domain/cart'</span>
<span class="hljs-keyword">import</span> { CartMapper } <span class="hljs-keyword">from</span> <span class="hljs-string">'../mappers/cart'</span><font></font>
<font></font>
interface ICartRepository {<font></font>
  getById(id: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt;<font></font>
  create(cart: Cart): <span class="hljs-built_in">Promise</span>&lt;Cart&gt;<font></font>
  update(cart: Cart): <span class="hljs-built_in">Promise</span>&lt;Cart&gt;<font></font>
}<font></font>
<font></font>
@injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartRepository</span> <span class="hljs-title">implements</span> <span class="hljs-title">ICartRepository</span> </span>{<font></font>
  @inject(TYPES.Database) private _database: MemoryData<font></font>
<font></font>
  <span class="hljs-keyword">async</span> getById(id: string): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> cart = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._database.cart.getById(id)
    <span class="hljs-keyword">if</span> (!cart) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ResourceNotFound(<span class="hljs-string">'Cart'</span>, { id })<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> CartMapper.toDomain(cart)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> create(cart: Cart): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> dtoCart = cart.unmarshal()
    <span class="hljs-keyword">const</span> inserted = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._database.cart.insert(dtoCart)
    <span class="hljs-keyword">return</span> CartMapper.toDomain(inserted)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">async</span> update(cart: Cart): <span class="hljs-built_in">Promise</span>&lt;Cart&gt; {
    <span class="hljs-keyword">const</span> dtoCart = cart.unmarshal()
    <span class="hljs-keyword">const</span> updated = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>._database.cart.update(cart.id, dtoCart)
    <span class="hljs-keyword">return</span> CartMapper.toDomain(updated)<font></font>
  }<font></font>
}</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a beaucoup de place pour des améliorations et des améliorations. </font><font style="vertical-align: inherit;">Le code a été créé pour cette démonstration visuelle, et la première amélioration de l'architecture en couches pourrait être l'annonce de l'interface du référentiel dans la couche domaine et son implémentation dans la couche infrastructure, dont nous pourrons discuter la prochaine fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code source est disponible sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486714/index.html">API Instagram au minimum</a></li>
<li><a href="../fr486716/index.html">Ce que fait l'API gratuite de Moscow Exchange sur Google Sheets</a></li>
<li><a href="../fr486722/index.html">Test de sécurité statique avec des outils open source</a></li>
<li><a href="../fr486726/index.html">Diagnostic des connexions réseau sur un routeur EDGE virtuel</a></li>
<li><a href="../fr486728/index.html">Autorité allemande de protection des données: la télémétrie dans Windows 10 1909 Enterprise peut être complètement désactivée</a></li>
<li><a href="../fr486736/index.html">Comment augmenter la vitesse de décodage d'un flux vidéo dans FFmpeg</a></li>
<li><a href="../fr486738/index.html">Conventions de style de code PHP</a></li>
<li><a href="../fr486740/index.html">Écriture d'une API dans Rust à l'aide de macros procédurales</a></li>
<li><a href="../fr486742/index.html">Entretien avec Anatoly Wasserman sur l'avenir</a></li>
<li><a href="../fr486744/index.html">Un correcteur de posture intelligent fabriqué au pays a été mis en vente. Nous avons regardé le nouveau produit - IBACK</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>