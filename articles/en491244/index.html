<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí° ü§Ωüèª üçú Ableton is not needed: connect Ableton Push 2 to VCV Rack ‚õ∑Ô∏è üñ≤Ô∏è üë®‚Äçüë©‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The creation of music, lately, goes much the same way as a photograph 10 years ago: each one has its own DSLR and instagram account. The music industr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Ableton is not needed: connect Ableton Push 2 to VCV Rack</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491244/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/qk/vm/8j/qkvm8jnnid3kb_8kybxztptlbfu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The creation of music, lately, goes much the same way as a photograph 10 years ago: each one has its own DSLR and instagram account. The music industry is very happy about this, because such an interest brings a lot of money. Every day new VST plugins and analog devices appear, the number of thematic courses is growing rapidly, blogs dedicated to music production are on the top youtube. Against this background, open-source projects look very interesting, allowing anyone who wants to try themselves as a producer without spending a ton of money on this. One such project is VCV Rack, which aims to make the most expensive class of musical instruments - analog modular synthesizers - accessible to everyone. Recently, when I got the idea for a track,and at hand there was only a linux laptop, I wanted to make the whole track in VCV. And along the way, there was a desire to control the synthesizers using the midi controller in a way that using the available modules did not work. In the end, I decided to write a plugin to connect Ableton Push 2 to VCV Rack. We will talk about what came of it, and how to write our own modules for VCV in this article.</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quick reference</font></font></b><div class="spoiler_text">VCV Rack ‚Äî open source ,   .  VCV  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">  </a>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    </a>.<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/videoseries" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
Ableton Push 2 ‚Äî    midi-  Ableton,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"> DAW</a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">API    </a>.<br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0CdMvkBOUgs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VCV Rack API</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each module in VCV consists of two parts - audio and graphic. </font><font style="vertical-align: inherit;">The audio part inherits from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">, called for each sample, that is, with a sampling frequency. </font><font style="vertical-align: inherit;">By the way, the sampling frequency in VCV can vary from standard 44.1 kHz to as much as 768 kHz, which allows more accurately emulating modular synthesizers in the presence of sufficient computing power. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objects of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ModuleWidget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> type are responsible for the graphics </font><font style="vertical-align: inherit;">, which inherit the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">draw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method from the base structure </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">VCV uses the nanovg vector graphics library. </font><font style="vertical-align: inherit;">Drawing inside the </font><i><font style="vertical-align: inherit;">draw</font></i><font style="vertical-align: inherit;"> method</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it can occur both inside the module boundaries (the excess is cut off by the engine), and for example in the framebuffer, which we still use. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So what does it take to write your module for VCV?</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setting up the environment and installing the Rack SDK</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first step is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">well described</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the documentation and does not cause any difficulties (at least under linux), so we will not dwell on it.</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generate a plugin template</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a helper.py script for this in the Rack SDK. </font><font style="vertical-align: inherit;">He needs to say createplugin, and then specify the name of the plugin and, optionally, information about it.</font></font><br>
<br>
<pre><code class="bash hljs">&lt;Rack SDK folder&gt;/helper.py createplugin MyPlugin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the plugin template is created, it can be compiled and installed with the command</font></font><br>
<br>
<pre><code class="bash hljs">RACK_DIR=&lt;Rack SDK folder&gt; make install</code></pre><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Draw the frontend of the module</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each plugin can contain several modules, and for each of the modules you need to draw a main panel. For this, VCV documentation offers us to use Inkscape or any other vector editor. Since the modules in VCV are mounted on a virtual Eurorack-stand, their height is always 128.5 mm and the width should be a multiple of 5.08 mm. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basic interface elements, such as CV / Gate sockets, buttons and light bulbs can be marked in vector form. To do this, draw in their place circles of the corresponding colors ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">more details here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), so that </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">helper.py</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> then </font><i><font style="vertical-align: inherit;">generates</font></i><font style="vertical-align: inherit;"> code for this markup. Personally, it seemed to me that this is not a very convenient feature and it is easier to place elements directly from the code. When the picture and layout are ready, you need to run </font><i><font style="vertical-align: inherit;">helper.py</font></i><font style="vertical-align: inherit;"> again</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to create a module template and associate it with the front panel.</font></font><br>
<br>
<pre><code class="bash hljs">helper.py createmodule MyModule res/MyModule.svg src/MyModule.cpp</code></pre><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We connect buttons and twists</font></font></b></h2><br>
<img src="https://habrastorage.org/webt/oz/wq/z_/ozwqz_ss4sqqdci_q7dxbarbfve.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apart from the display, Ableton Push 2 is seen by the computer as a regular USB-MIDI device, which makes it easy to establish a connection between it and VCV Rack. </font><font style="vertical-align: inherit;">To do this, create an input midi queue and an output midi port inside the class of the module.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialization code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">AbletonPush2</span> :</span> Module {<font></font>
    midi::Output midiOutput;<font></font>
    midi::InputQueue midiInput;<font></font>
<font></font>
    <span class="hljs-keyword">bool</span> inputConnected;
    <span class="hljs-keyword">bool</span> outputConnected;<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to find Ableton Push among connected midi devices and connect to it. </font><font style="vertical-align: inherit;">Since the module is designed to work exclusively with Ableton Push, we do not need to burden the user with a choice of device and you can simply find it by name.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controller Connection Code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">connectPush</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">auto</span> in_devs = midiInput.getDeviceIds();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; in_devs.size(); i++){
        <span class="hljs-keyword">if</span> (midiInput.getDeviceName(in_devs[i]).find(<span class="hljs-string">"Ableton"</span>) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos) {<font></font>
            midiInput.setDeviceId(in_devs[i]);<font></font>
            inputConnected = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
		<font></font>
    <span class="hljs-keyword">auto</span> out_devs = midiOutput.getDeviceIds();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; out_devs.size(); i++){
        <span class="hljs-keyword">if</span> (midiOutput.getDeviceName(out_devs[i]).find(<span class="hljs-string">"Ableton"</span>) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos) {<font></font>
            midiOutput.setDeviceId(out_devs[i]);<font></font>
            outputConnected = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">you can periodically check whether the controller is connected and ask the midi queue if any messages have arrived. </font><font style="vertical-align: inherit;">Here it is worth mentioning what and how is generally encoded in the midi standard. </font><font style="vertical-align: inherit;">In fact, there are two main types of messages, these are Note ON / OFF, transmitting the note number and pressing force, and CC - Command Control, transmitting the numerical value of some variable parameter. </font><font style="vertical-align: inherit;">More information about midi can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIDI Queue Polling Code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ProcessArgs &amp;args)</span> <span class="hljs-keyword">override</span> </span>{
    <span class="hljs-keyword">if</span> (sampleCounter &gt; args.sampleRate / updateFrequency) {<font></font>
<font></font>
        <span class="hljs-keyword">if</span> ((!inputConnected) &amp;&amp; (!outputConnected)) {<font></font>
            connectPush();<font></font>
        }<font></font>
<font></font>
	midi::Message msg;<font></font>
	<span class="hljs-keyword">while</span> (midiInput.shift(&amp;msg)) {<font></font>
	    processMidi(msg);<font></font>
	}<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I want to teach the controller pads to glow in different colors, so that it is more convenient to navigate them. To do this, we will need to send him the appropriate midi command. Consider, for example, pad number 36 (this is the lowest left pad). If you click on it, the controller will send the command 0x90 (note on), followed by the note number (36) and a number from 0 to 127, which means the strength of the press. And when, on the contrary, the computer sends the same command 0x90 and the same note number 36 to the controller, then the third number will indicate the color with which the lower left pad should glow. The numbers of the buttons and pads are shown in the figure above. Push has quite a few possibilities for working with color, palettes, animation, and other backlighting parameters. I did not go into details and simply brought all the possible colors of the default palette to the pads and chose the ones I liked.But in the general case, the conversion of midi commands to PWM values ‚Äã‚Äãon LEDs, according to the documentation, looks like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8o/at/zq/8oatzqvwy_gwqvgu4cmjgjpbknm.png"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backlight Control Code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lightOn</span><span class="hljs-params">(<span class="hljs-keyword">int</span> note, <span class="hljs-keyword">int</span> color)</span></span>{<font></font>
    midi::Message msg;<font></font>
    msg.setNote(note);<font></font>
    msg.setValue(color);<font></font>
    msg.setChannel(<span class="hljs-number">1</span>);<font></font>
    msg.setStatus(<span class="hljs-number">0x9</span>);<font></font>
    midiOutput.sendMessage(msg);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">lightOff</span><span class="hljs-params">(<span class="hljs-keyword">int</span> note)</span></span>{<font></font>
    midi::Message msg;<font></font>
    msg.setNote(note);<font></font>
    msg.setValue(<span class="hljs-number">0</span>);<font></font>
    msg.setChannel(<span class="hljs-number">1</span>);<font></font>
    msg.setStatus(<span class="hljs-number">0x8</span>);<font></font>
    midiOutput.sendMessage(msg);<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We connect the display</font></font></b></h2><br>
<img src="https://habrastorage.org/webt/os/yl/kv/osylkvou5ba8_aoa3rwhst94uiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To connect the display you have to work with USB. </font><font style="vertical-align: inherit;">The controller itself does not know how to draw anything and does not know anything about graphics. </font><font style="vertical-align: inherit;">All he wants is to send a frame of 160x960 pixels in size at least every 2 seconds. </font><font style="vertical-align: inherit;">All rendering takes place on the side of the computer. </font><font style="vertical-align: inherit;">To start, connect and open the USB device, as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">described in the documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Display Connection Code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _MSC_VER</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> _WIN32</span><font></font>
<font></font>
<span class="hljs-comment">// see following link for a discussion of the</span>
<span class="hljs-comment">// warning suppression:</span>
<span class="hljs-comment">// http://sourceforge.net/mailarchive/forum.php?</span>
<span class="hljs-comment">// thread_name=50F6011C.2020000%40akeo.ie&amp;forum_name=libusbx-devel</span><font></font>
<font></font>
<span class="hljs-comment">// Disable: warning C4200: nonstandard extension used:</span>
<span class="hljs-comment">// zero-sized array in struct/union</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> <span class="hljs-meta-keyword">warning</span>(disable:4200)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __linux__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;libusb-1.0/libusb.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"libusb.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ABLETON_VENDOR_ID 0x2982</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PUSH2_PRODUCT_ID  0x1967</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> libusb_device_handle* <span class="hljs-title">open_push2_device</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> result;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> ((result = libusb_init(<span class="hljs-literal">NULL</span>)) &lt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error: [%d] could not initilialize usblib\n"</span>, result);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
<font></font>
  libusb_set_debug(<span class="hljs-literal">NULL</span>, LIBUSB_LOG_LEVEL_ERROR);<font></font>
<font></font>
  libusb_device** devices;<font></font>
  <span class="hljs-keyword">ssize_t</span> count;<font></font>
  count = libusb_get_device_list(<span class="hljs-literal">NULL</span>, &amp;devices);
  <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"error: [%ld] could not get usb device list\n"</span>, count);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<font></font>
  }<font></font>
<font></font>
  libusb_device* device;<font></font>
  libusb_device_handle* device_handle = <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
  <span class="hljs-keyword">char</span> ErrorMsg[<span class="hljs-number">128</span>];<font></font>
<font></font>
  <span class="hljs-comment">// set message in case we get to the end of the list w/o finding a device</span>
  <span class="hljs-built_in">sprintf</span>(ErrorMsg, <span class="hljs-string">"error: Ableton Push 2 device not found\n"</span>);<font></font>
<font></font>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; (device = devices[i]) != <span class="hljs-literal">NULL</span>; i++)<font></font>
  {<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">libusb_device_descriptor</span> <span class="hljs-title">descriptor</span>;</span>
    <span class="hljs-keyword">if</span> ((result = libusb_get_device_descriptor(device, &amp;descriptor)) &lt; <span class="hljs-number">0</span>)<font></font>
    {<font></font>
      <span class="hljs-built_in">sprintf</span>(ErrorMsg,
        <span class="hljs-string">"error: [%d] could not get usb device descriptor\n"</span>, result);
      <span class="hljs-keyword">continue</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (descriptor.bDeviceClass == LIBUSB_CLASS_PER_INTERFACE<font></font>
      &amp;&amp; descriptor.idVendor == ABLETON_VENDOR_ID<font></font>
      &amp;&amp; descriptor.idProduct == PUSH2_PRODUCT_ID)<font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> ((result = libusb_open(device, &amp;device_handle)) &lt; <span class="hljs-number">0</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">sprintf</span>(ErrorMsg,
          <span class="hljs-string">"error: [%d] could not open Ableton Push 2 device\n"</span>, result);<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((result = libusb_claim_interface(device_handle, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)<font></font>
      {<font></font>
        <span class="hljs-built_in">sprintf</span>(ErrorMsg,
          <span class="hljs-string">"error: [%d] could not claim interface 0 of Push 2 device\n"</span>, result);<font></font>
        libusb_close(device_handle);<font></font>
        device_handle = <span class="hljs-literal">NULL</span>;<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span><font></font>
      {<font></font>
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// successfully opened</span><font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (device_handle == <span class="hljs-literal">NULL</span>)<font></font>
  {<font></font>
    <span class="hljs-built_in">printf</span>(ErrorMsg);<font></font>
  }<font></font>
<font></font>
  libusb_free_device_list(devices, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> device_handle;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close_push2_device</span><span class="hljs-params">(libusb_device_handle* device_handle)</span>
</span>{<font></font>
  libusb_release_interface(device_handle, <span class="hljs-number">0</span>);<font></font>
  libusb_close(device_handle);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To transmit a frame, you must first send a 16-byte header, and then 160 lines of 960 16-bit numbers each. </font><font style="vertical-align: inherit;">At the same time, according to the documentation, strings should not be transmitted in 1920 bytes, but in packets of 2048 bytes, supplemented with zeros.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frame Transfer Code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Push2Display</span> :</span> FramebufferWidget {<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> frame_header[<span class="hljs-number">16</span>] = {
          <span class="hljs-number">0xFF</span>, <span class="hljs-number">0xCC</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0x88</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,
          <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span> <font></font>
    };<font></font>
<font></font>
    libusb_device_handle* device_handle;<font></font>
<font></font>
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>* image;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendDisplay</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> * image)</span> </span>{
        <span class="hljs-keyword">int</span> actual_length;<font></font>
     <font></font>
        libusb_bulk_transfer(device_handle, PUSH2_BULK_EP_OUT, frame_header, <span class="hljs-keyword">sizeof</span>(frame_header), &amp;actual_length, TRANSFER_TIMEOUT);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">160</span>; i++)<font></font>
            libusb_bulk_transfer(device_handle, PUSH2_BULK_EP_OUT, &amp;image[(<span class="hljs-number">159</span> - i)*<span class="hljs-number">1920</span>], <span class="hljs-number">2048</span>, &amp;actual_length, TRANSFER_TIMEOUT);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it remains only to draw and write a frame to the buffer. </font><font style="vertical-align: inherit;">To do this, use the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FramebufferWidget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">that implements the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">drawFramebuffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">VCV Rack out of the box uses the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nanovg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">, so it's pretty easy to write graphics here. </font><font style="vertical-align: inherit;">We learn the current graphic context from the global variable APP and save its state. </font><font style="vertical-align: inherit;">Next, create an empty 160x960 frame and draw it with the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">draw</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">After that, copy the framebuffer to the array that will be sent via USB, and return the state of the context. </font><font style="vertical-align: inherit;">At the end, set the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dirty</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> flag </font><font style="vertical-align: inherit;">so that at the next iteration of the rendering, the VCV engine does not forget to update our widget.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Frame Rendering Code</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">drawFramebuffer</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{<font></font>
<font></font>
    NVGcontext* vg = APP-&gt;window-&gt;vg;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (display_connected) {<font></font>
        nvgSave(vg);<font></font>
	glViewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">960</span>, <span class="hljs-number">160</span>);<font></font>
        glClearColor(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<font></font>
        glClear(GL_COLOR_BUFFER_BIT|GL_STENCIL_BUFFER_BIT);<font></font>
<font></font>
	nvgBeginFrame(vg, <span class="hljs-number">960</span>,  <span class="hljs-number">160</span>, <span class="hljs-number">1</span>);<font></font>
        draw(vg);<font></font>
        nvgEndFrame(vg);<font></font>
<font></font>
        glReadPixels(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">960</span>, <span class="hljs-number">160</span>, GL_RGB, GL_UNSIGNED_SHORT_5_6_5, image); <font></font>
<font></font>
        <span class="hljs-comment">//  XOR   ,  </span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">80</span>*<span class="hljs-number">960</span>; i ++){<font></font>
            image[i * <span class="hljs-number">4</span>] ^= <span class="hljs-number">0xE7</span>;<font></font>
	    image[i * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>] ^= <span class="hljs-number">0xF3</span>;<font></font>
            image[i * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>] ^= <span class="hljs-number">0xE7</span>;<font></font>
	    image[i * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>] ^= <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
	    	<font></font>
	sendDisplay(image);<font></font>
<font></font>
	nvgRestore(vg);<font></font>
    }<font></font>
<font></font>
    dirty = <span class="hljs-literal">true</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logic of interaction and mapping of parameters</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For my task, I wanted to be able to switch patterns recorded in sequencers, and at the same time control a certain set of parameters, my own for each group of patterns. </font><font style="vertical-align: inherit;">By mapping, I understand the binding of the parameter of one module with the parameter of another module or midi controller. </font><font style="vertical-align: inherit;">I found very little information on how to make mapping beautifully, so I took most of the code that implements it from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MIDI Map</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> module built into VCV </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In short, for each bunch of parameters a special </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ParamHandle</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> object is </font><i><font style="vertical-align: inherit;">created there</font></i><font style="vertical-align: inherit;"> , which </font><font style="vertical-align: inherit;">tells the engine </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">through crutches</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> what is connected with what.</font></font><br>
<br>
<h2><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></b></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is a module I got in the end. </font><font style="vertical-align: inherit;">In addition to the standard conversion of midi to CV, it allows you to group pads, assign colors to them, and associate arbitrary module parameters with Push encoders, displaying their names and values ‚Äã‚Äãon the controller display. </font><font style="vertical-align: inherit;">In the video below you can see his overview, and in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this video you</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can see in action.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/OhdxXv6uHF0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full code is available </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We managed to test it only under Linux (Ubuntu 18.04), on MacOS the display did not connect due to the specifics of libusb and there were strange delays in the midi interface. </font><font style="vertical-align: inherit;">Despite this, VCV Rack left a very good impression both as a framework and as a modular DAW, I hope that VCV will continue to develop, and this article will help someone else write their own modules for it.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491232/index.html">RPA + Machine Learning = Intelligent Automation</a></li>
<li><a href="../en491234/index.html">Three Tricks for Working with SOLIDWORKS for Modeling Parts for 3D Printing</a></li>
<li><a href="../en491236/index.html">Async programming in .NET: best practices</a></li>
<li><a href="../en491238/index.html">Genetic Code Analysis II</a></li>
<li><a href="../en491240/index.html">The road to the clouds: yesterday and today Adobe</a></li>
<li><a href="../en491246/index.html">DEFCON Conference 27. Your car is my car. Part 2</a></li>
<li><a href="../en491250/index.html">LED lamps Gauss Basic</a></li>
<li><a href="../en491252/index.html">5 little-known features of JSON.stringify ()</a></li>
<li><a href="../en491256/index.html">Development of the module on iMX8 from NXP. Features of DDR trace transfer</a></li>
<li><a href="../en491258/index.html">IT girls, where are you from? Let's build a map</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>