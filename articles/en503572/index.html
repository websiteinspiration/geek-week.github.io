<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜï üë©‚Äçüë©‚Äçüëß‚Äçüë¶ ‚õ∞Ô∏è Udalenka. another self-isolation VPN deployment story üêú üíÖüèº üè∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Another story about how it was necessary to quickly deploy remote access for a small company that went into self-isolation, but could not afford not t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Udalenka. another self-isolation VPN deployment story</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503572/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another story about how it was necessary to quickly deploy remote access for a small company that went into self-isolation, but could not afford not to work further.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Like many others, the company that asked me to help organize remote access realized that they would have to leave for self-isolation just a few days before the president announced these measures. </font><font style="vertical-align: inherit;">It was necessary to act quickly.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have experience suddenly transferring employees to work remotely on RDP servers. This is a shock, all the usual processes break down, the effectiveness of employee interaction decreases for a while, and some processes completely stop. It takes time for all processes to work again. In general, the option to transfer everyone to an RDP server in a short time, given that the familiar work environment of employees is changing, is not suitable. Therefore, it was decided to provide access directly to the computers of employees. In this case, the usual working environment remains with the employee; practically nothing changes or breaks in him.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the company, along with traditional user profiles, such as businessmen, sellers, accounting, etc., there are designers. It was necessary to make sure that designers could work through RDP in graphic applications. You also need to remember to allow remote access for employees on all PCs and set up an energy-saving scheme so that computers do not fall asleep at night. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To verify that designers can comfortably work remotely, a test OpenVPN was deployed, then several designers connected to their PCs and checked the operation of their applications. Remote access and an energy-saving scheme are allowed through group policies.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order not to run into the VPN server performance, to be able to expand access capacities and perform server maintenance without stopping this access, it was decided to deploy a cluster of several OpenVPN nodes, access to which HaProxy will distribute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Scheme:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/fz/ji/bn/fzjibnejcha28mbxb-sjrqojxmm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will authorize users in the Active Directory domain. To do this, create a group in the domain, for convenience, I called it COVID-19. In this group you need to add users who will be granted remote access. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For authorization through AD in OpenVPN, you must connect the module designed for this. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I didn‚Äôt work with openvpn-auth-ldap, there was no time to figure it out, so I used the script </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from this repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It connects easily, just place it in the openvpn directory, add a line to openvpn.conf and specify the search parameters for the AD user. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to write a minimum instruction for self-installation of the OpenVPN client and connection profile and send them to users.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, within a few days, company employees were able to quickly switch to self-isolation mode and continue to work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not give a detailed analysis of the server settings. Who wants to see and even deploy a cluster, I posted on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> playbook for ansible, which deploys HaProxy and OpenVPN on three servers. Attention! I used FreeBSD, playbooks are written for this OS.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So that admins can see who is currently connected and to which server, he wrote a script that polls the server by crown and generates a simple html page. Information about employees is taken from the internal resource wiki, you can remove this block from the script, leaving just AD accounts or replace it with information about employees from AD, if such information is available there. The script is located in the misc folder, in the repository the link to which I gave above. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During operation, an unpleasant bug was detected in Windows 10 1903. When working remotely through RDP, 10 broke the connection and then it was impossible to connect to it. The bug will be cured by patch KV4522355</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the whole story. </font><font style="vertical-align: inherit;">Its purpose, perhaps belatedly, is to provide an example of how you can quickly deploy remote access at minimal cost. </font><font style="vertical-align: inherit;">The implementation is suitable for both small and medium enterprises, with the ability to increase the number of remote connections. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for the attention.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503556/index.html">Everything you need to know about std :: any</a></li>
<li><a href="../en503560/index.html">Learning Scala: Part 1 - The Snake Game</a></li>
<li><a href="../en503562/index.html">The digest of interesting materials for the mobile developer # 345 (May 18 - 24)</a></li>
<li><a href="../en503566/index.html">Is it possible to use Linux Desktop in a Windows infrastructure?</a></li>
<li><a href="../en503570/index.html">Xiaomi Gateway 2 can not be soldered</a></li>
<li><a href="../en503574/index.html">Analysis of the contents of QR codes in documents of the electronic government of the Republic of Kazakhstan in the frontend</a></li>
<li><a href="../en503576/index.html">"Passed by": topics that you forgot to discuss on Russian-speaking sites about startups and technologies</a></li>
<li><a href="../en503578/index.html">Good programmers copy, great programmers steal</a></li>
<li><a href="../en503580/index.html">What is Big Data?</a></li>
<li><a href="../en503588/index.html">Bill Gates: What You Need to Know About COVID-19 Vaccine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>