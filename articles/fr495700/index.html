<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤷 👩‍🚀 🧑🏼 Doom Boy ESP32 👩‍🔧 ✍🏼 👋🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Préfixe Doom pour ESP32 bricolage sur le pilote MCP23017 pour les boutons d'UncleRus
 
 
 
 En prévision des heures Doom , le conseil d'administration...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Doom Boy ESP32</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495700/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Préfixe Doom pour ESP32 bricolage sur le pilote MCP23017 pour les boutons d'UncleRus</font></font><br>
<br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/e_/br/13/e_br13t_nva7dv5lrbr8b9-8rpo.jpeg"></div><br>
<div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/it/_4/wj/it_4wjuhc9m8api63gzolghcwlq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En prévision des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heures Doom</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le conseil d'administration d'un projet de longue date est venu. </font><font style="vertical-align: inherit;">Les MCP23017 et CS4344 externes et bien d'autres choses sont divorcées sur la carte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les boutons, l'expandeur de port MCP23017 connecté via I2C est utilisé. </font><font style="vertical-align: inherit;">Pour lui, il y a un chauffeur que vous pouvez obtenir chez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UncleRus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une tentative a été effectuée pour lancer un ADC externe CS4344.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doom par Espressif</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir téléchargé le port, Doom a dû bricoler un peu pour le récupérer. </font><font style="vertical-align: inherit;">En fin de compte, tout s'est réuni et a inondé ESP32 mais ... J'ai attrapé un crash au début. </font><font style="vertical-align: inherit;">Sur la question githab du projet, j'ai vu une discussion similaire sur le problème: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vy/cp/kj/vycpkjmc1qkwolkxdlxsvcutgqu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
l'auteur du port a suggéré de faire</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous devrez probablement utiliser l'option malloc () et réserver de la mémoire pour DMA. </font><font style="vertical-align: inherit;">Je vais voir si je peux obtenir cette compilation sur master et mettre à jour le sdkconfig quand j'aurai le temps.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En général, j'ai «sans réfléchir à deux fois» remplacé toutes les fonctions d'allocation de mémoire portées par malloc (). La </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
démo a commencé. </font><font style="vertical-align: inherit;">Devant moi se connectait des boutons</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extendeur GPIO MCP23017</font></font></h3><br>
<img src="https://habrastorage.org/webt/a8/e0/zx/a8e0zxgbcoljjm4vgecqqft5pxm.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MCP23017</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Avec de grands plans pour étendre la fonctionnalité via les ports du contrôleur, j'ai décidé d'économiser un peu sur les ports d'entrée / sortie du microcontrôleur lui-même en installant MCP23017. </font><font style="vertical-align: inherit;">Il s'agit d'un simple expandeur avec accès aux signaux d'entrée / sortie via l'interface I2C. </font><font style="vertical-align: inherit;">Je n'ai pas inventé le pilote, mais je l'ai simplement pris à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UncleRus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cinq boutons utilisent le joystick pour naviguer. </font><font style="vertical-align: inherit;">Quelques boutons sur la prise de vue et la sélection du menu. </font><font style="vertical-align: inherit;">En fait, cela ne suffit pas, il faut encore ouvrir les portes et se déplacer à gauche et à droite sans tourner, c'est-à-dire comme un crabe. </font><font style="vertical-align: inherit;">Les résultats sont tirés à l'intérieur du MCP23017 vers VDD. </font><font style="vertical-align: inherit;">Le contact se ferme à la terre. </font><font style="vertical-align: inherit;">C'est très cool qu'il y ait des résistances de pull-up à l'intérieur du microcircuit. </font><font style="vertical-align: inherit;">On pourrait encore être confondu avec des interruptions du MCP23017. </font><font style="vertical-align: inherit;">Il a deux broches pour chaque port, INTA et INTB, mais en quelque sorte une autre fois.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liste complète des équipes</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> JsKeyMap keymap[]={<font></font>
	{<span class="hljs-number">0x10</span>, &amp;key_up},<font></font>
	{<span class="hljs-number">0x40</span>, &amp;key_down},<font></font>
	{<span class="hljs-number">0x80</span>, &amp;key_left},<font></font>
	{<span class="hljs-number">0x20</span>, &amp;key_right},<font></font>
	<font></font>
	{<span class="hljs-number">0x4000</span>, &amp;key_use},				<span class="hljs-comment">//cross</span>
	{<span class="hljs-number">0x2000</span>, &amp;key_fire},			<span class="hljs-comment">//circle</span>
	{<span class="hljs-number">0x2000</span>, &amp;key_menu_enter},		<span class="hljs-comment">//circle</span>
	{<span class="hljs-number">0x8000</span>, &amp;key_pause},			<span class="hljs-comment">//square</span>
	{<span class="hljs-number">0x1000</span>, &amp;key_weapontoggle},	<span class="hljs-comment">//triangle</span><font></font>
<font></font>
	{<span class="hljs-number">0x8</span>, &amp;key_escape},				<span class="hljs-comment">//start</span>
	{<span class="hljs-number">0x1</span>, &amp;key_map},				<span class="hljs-comment">//select</span><font></font>
	<font></font>
	{<span class="hljs-number">0x400</span>, &amp;key_strafeleft},		<span class="hljs-comment">//L1</span>
	{<span class="hljs-number">0x100</span>, &amp;key_speed},			<span class="hljs-comment">//L2</span>
	{<span class="hljs-number">0x800</span>, &amp;key_straferight},		<span class="hljs-comment">//R1</span>
	{<span class="hljs-number">0x200</span>, &amp;key_strafe},			<span class="hljs-comment">//R2</span><font></font>
<font></font>
	{<span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>},<font></font>
};</code></pre><br>
</div>
                    </div><br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> était plus facile de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">couper le traitement des boutons</font></a><font style="vertical-align: inherit;"> que je ne le pensais. </font><font style="vertical-align: inherit;">J'ai abaissé la fréquence de I2C pour améliorer la stabilité. </font><font style="vertical-align: inherit;">En tout cas, le 1MHz déclaré n'a pas fonctionné. </font><font style="vertical-align: inherit;">La fréquence de 100 kHz était suffisante pour interroger dans un cycle avec un retard de 20 ms.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CMake</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai perdu beaucoup de temps à ajouter CMakeList.txt pour les composants. </font><font style="vertical-align: inherit;">Quelque chose n'a pas fonctionné avec make. </font><font style="vertical-align: inherit;">Et je voulais prendre un SDK plus frais. </font><font style="vertical-align: inherit;">Le port d'origine n'allait même pas à 3.2.x. </font><font style="vertical-align: inherit;">A pris esp-idf-v3.3.1 cela fonctionnera probablement sur esp-idf-4.0</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Son via le DAC</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, il y a une autre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fourchette</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il dispose d'une carte SD connectée et d'un son via le DAC intégré. Le port d'origine d'Espressif vous permet de charger un fichier wad uniquement dans la mémoire Flash interne des programmes, puis vous devez utiliser un fichier coupé dans lequel il n'y a pas de son! </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le schéma ici.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
L'idée de connecter un DAC externe au lieu du DAC intégré m'a captivé. Au moins le sou de Cirrus Logic. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ni/wl/cw/niwlcwgsprqestpufw2qfwjousq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai installé le DAC sur CS4344, puis j'ai été déçu. Le son a fonctionné avec des interruptions. Quand j'ai vu le fichier </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">i_sound.c</font></a><font style="vertical-align: inherit;"> dans mon projet</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai remarqué qu'un fichier dma.h n'est pas utilisé. Comme s'il y avait un lien avec lui, et lui-même l'est, mais tout est commenté. Peut-être que j'ai regardé inattentivement? Mais je pense que l'auteur a également remarqué que quelque chose n'allait pas avec le son et a essayé de l'éliminer. Peut-être éliminé et n'a pas posté le dernier commit. Ou peut-être que tout fonctionne comme il se doit sur le DAC interne. Cependant, vous pouvez négliger les interruptions de distorsion pour diffuser le son via le DAC intégré et vers un petit haut-parleur. J'ai joué avec le bitrate et le changement de code global. Cela n'a rien apporté. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et oui, concernant la connexion de la SD-CARD. Initialement, je l'ai suspendu en parallèle avec l'affichage sur le bus SPI, en séparant séparément le signal de sélection de la puce CS. L'idée a échoué. En ventilant la question </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge du partage de bus SD-SPI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est arrivé à la conclusion que toutes les cartes SD ne sont pas identiques ou que mes mains ne sont pas aussi droites. </font><font style="vertical-align: inherit;">J'ai dû le dessouder via l'adaptateur à la carte au lieu du microphone. </font><font style="vertical-align: inherit;">Il a été enroulé sans tractions par des résistances externes au VDD.</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résistances internes gérées</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><font></font>
    gpio_set_pull_mode(PIN_NUM_MOSI, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_MISO, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_CLK, GPIO_PULLUP_ONLY);<font></font>
    gpio_set_pull_mode(PIN_NUM_CS, GPIO_PULLUP_ONLY);</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce sujet, j'ai quitté cette leçon et publié le code source sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il faudrait faire une autre édition de la carte de circuit imprimé. </font><font style="vertical-align: inherit;">Celui-ci n'est pas bon!</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/TFE2ri2Zgu4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas de son sur la vidéo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et j'avais aussi un contact par joystick pour tourner quand je soudais. </font><font style="vertical-align: inherit;">En général, la première crêpe </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD </font><font style="vertical-align: inherit;">est grumeleuse </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
j'ai réussi à établir un son. </font><font style="vertical-align: inherit;">Les secousses sont présentes, mais pas critiques. </font><font style="vertical-align: inherit;">Modifications du code: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
spi_lcd.c </font></font><br>
<code>dmamem[x]=heap_caps_malloc(MEM_PER_TRANS*2, MALLOC_CAP_DMA);</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
i_sound.c</font></font><br>
<code>void IRAM_ATTR updateTask(void *arg)<br>
{<br>
 // size_t bytesWritten;<br>
 while(1)<br>
 {<br>
 I_UpdateSound();<br>
 i2s_write(I2S_NUM_0, mixbuffer, SAMPLECOUNT*SAMPLESIZE, &amp;bytesWritten, portMAX_DELAY);<br>
 }<br>
}</code><br>
<br>
<code>.dma_buf_count = 2,<br>
 .dma_buf_len = 512,</code><br>
<br>
<code>xTaskCreatePinnedToCore(&amp;updateTask, "updateTask", 1000, NULL, 7, NULL, 0);</code></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495690/index.html">Concepts de l'API Web Audio</a></li>
<li><a href="../fr495692/index.html">DIY et Open Source pour aider les médecins</a></li>
<li><a href="../fr495694/index.html">Service de référence d'applications mobiles</a></li>
<li><a href="../fr495696/index.html">Comment Prince of Persia Creator dépasse les limites de mémoire d'Apple II</a></li>
<li><a href="../fr495698/index.html">L'architecture client-serveur en images</a></li>
<li><a href="../fr495702/index.html">Nous étudions le moteur VoIP Mediastreamer2. Partie 1</a></li>
<li><a href="../fr495704/index.html">Surveillance de l'équipement réseau via SNMPv3 dans Zabbix</a></li>
<li><a href="../fr495706/index.html">Nouvelles du monde d'OpenStreetMap n ° 505 (03.17.2020-23.03.2020)</a></li>
<li><a href="../fr495708/index.html">Serveur VPN d'urgence Openconnect avec autorisation à deux facteurs sur Centos 8</a></li>
<li><a href="../fr495712/index.html">Nous fixons des objectifs de développement (dans une entreprise sanglante et pas seulement)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>