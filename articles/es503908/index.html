<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüè´ üïê ü•• Llamar a bibliotecas compartidas desde Similink ‚ÜôÔ∏è üë®üèø‚Äçüè≠ üëÉüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! 
 Le presento la traducci√≥n de un art√≠culo de mi colega Mikhail sobre m√©todos para invocar bibliotecas compartidas en Simulink. ¬øPor qu√© fu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Llamar a bibliotecas compartidas desde Similink</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503908/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le presento la traducci√≥n de un art√≠culo de mi colega Mikhail sobre m√©todos para invocar bibliotecas compartidas en Simulink. ¬øPor qu√© fue creado en absoluto? El hecho es que muchas compa√±√≠as ya tienen muchos modelos heredados que nos gustar√≠a reutilizar y a menudo nos hacen preguntas: ‚Äú¬øC√≥mo puedo integrar el legado en Simulink? ¬øY si mi legado tiene la forma de una DLL? Por lo tanto, el art√≠culo original fue escrito. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debajo del gato, se discuten varias formas de llamar a las bibliotecas compartidas en Simulink. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los cambios en el c√≥digo se hicieron con el permiso de Mikhail y se hicieron para no sobrecargar el art√≠culo.</font></font><br>
<br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este art√≠culo muestra c√≥mo usar funciones de bibliotecas compartidas en modelos Simulink. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Digamos que necesitamos incrustar la biblioteca exlib en Simulink. </font><font style="vertical-align: inherit;">Su c√≥digo est√° contenido en las fuentes de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esta es una biblioteca muy simple que contiene tres funciones: </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_init (void)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : abre un archivo para escribir. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_print (datos flotantes)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : escribe datos en un archivo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_term (void)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : cierra el archivo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asamblea de biblioteca</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, compila la biblioteca. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este paso no es necesario si la biblioteca est√° precompilada y se entrega como un archivo binario. En este caso, puede ir inmediatamente al paso 3, pero recuerde que para trabajar con la biblioteca necesita obtener el archivo .dll (o .so para Linux) y el archivo de encabezado correspondiente (.h) del proveedor de la biblioteca. Para Windows, tambi√©n necesitar√° un archivo .lib, que no es una biblioteca est√°tica, sino la llamada biblioteca de importaci√≥n. Esta biblioteca de importaci√≥n es necesaria para la vinculaci√≥n impl√≠cita. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, utilizaremos el comando MATLAB mex, que llama al compilador de host activo actual para compilar la biblioteca compartida (exlib.dll en Windows y exlib.so en Linux). Es importante asegurarse de que el comando se haya ejecutado primero.</font></font><br>
<pre><code class="matlab hljs">mex -setup
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para seleccionar un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compilador compatible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora use mex para compilar la biblioteca:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo para construir una biblioteca</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">mingw = strfind(mex.getCompilerConfigurations(<span class="hljs-string">'C'</span>,<span class="hljs-string">'Selected'</span>).Name,<span class="hljs-string">'MinGW64 Compiler'</span>);
<span class="hljs-keyword">if</span> isunix
    <span class="hljs-comment">% GCC</span>
    mex(<span class="hljs-string">'LDEXT=.so'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">elseif</span> mingw
    <span class="hljs-comment">% MinGW builds static shared library, so dll and lib files are the same</span>
    <span class="hljs-comment">% loadlibrary uses the dll file, while legacy code tool looks for the lib file</span>
    mex(<span class="hljs-string">'LDEXT=.lib'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);<font></font>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">else</span>
    <span class="hljs-comment">% Visual</span>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'CMDLINE300="del exlib.exp exlib.dll.manifest"'</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
</div>
                    </div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprobando la biblioteca compilada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de la compilaci√≥n, debe asegurarse de que la biblioteca resultante se pueda cargar y usar en MATLAB:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo para revisar la biblioteca</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-comment">% Load the library</span>
[~,~] = loadlibrary([<span class="hljs-string">'exlib'</span>,system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>)],<span class="hljs-string">'exlib.h'</span>);
<span class="hljs-comment">% Display functions available in the library</span>
libfunctionsview(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Initialize</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_init'</span>);
<span class="hljs-comment">% Step</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">i</span> = <span class="hljs-number">1</span>:<span class="hljs-number">10</span>
    calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_print'</span>,single(<span class="hljs-built_in">i</span>));
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Terminate</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-comment">% Unload the library</span>
unloadlibrary(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Show contents of generated file</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que nos hemos asegurado de que todo funcione, ¬°comencemos con Simulink!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocar una biblioteca compartida utilizando funciones S</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las funciones S le permiten usar el c√≥digo C en Simulink. </font><font style="vertical-align: inherit;">Este enfoque permite al usuario desarrollar cualquier c√≥digo C necesario para cargar la biblioteca y llamar a sus funciones. </font><font style="vertical-align: inherit;">Luego, este c√≥digo se compila en un archivo binario reconocido por Simulink y vinculado a una biblioteca compartida. </font><font style="vertical-align: inherit;">Este binario se llama funci√≥n S. </font><font style="vertical-align: inherit;">Simulink tiene un bloque para llamar a esta funci√≥n S. </font><font style="vertical-align: inherit;">Existen varios enfoques para crear funciones S en Simulink.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usar la herramienta de c√≥digo heredado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer enfoque es usar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy Code Tool</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , una herramienta que lo ayuda a crear autom√°ticamente funciones S de acuerdo con las especificaciones creadas con MATLAB. </font><font style="vertical-align: inherit;">En este ejemplo, la funci√≥n S est√° vinculada a la biblioteca de importaci√≥n (en Windows necesitamos el archivo * .lib correspondiente) y se llama a las funciones de la biblioteca. </font><font style="vertical-align: inherit;">Este enfoque se llama vinculaci√≥n impl√≠cita. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, debe inicializar la estructura de la herramienta de c√≥digo heredado</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo para inicializar la estructura de la herramienta de c√≥digo heredado</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">specs = legacy_code(<span class="hljs-string">'initialize'</span>);
<span class="hljs-comment">% Prototype for the initialization function</span>
specs.StartFcnSpec = <span class="hljs-string">'exlib_init()'</span>;
<span class="hljs-comment">% Prototype for the step function</span>
specs.OutputFcnSpec = <span class="hljs-string">'exlib_print(single u1)'</span>;
<span class="hljs-comment">% Prototype for the terminate function</span>
specs.TerminateFcnSpec = <span class="hljs-string">'exlib_term()'</span>;
<span class="hljs-comment">% Shared library to link with (.so on Linux and .dll on Windows)</span>
specs.HostLibFiles = {[<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]};
<span class="hljs-comment">% We must supply header file when linking with shared library, otherwise</span>
<span class="hljs-comment">% compiler might make wrong assumptions about function's prototype.</span>
specs.HeaderFiles = {<span class="hljs-string">'exlib.h'</span>};<font></font>
specs.SFunctionName = <span class="hljs-string">'sfun_exlib'</span>;
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cree una funci√≥n S, comp√≠lela y enl√°cela:</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'generate_for_sim'</span>,specs);<font></font>
### Start Compiling sfun_exlib<font></font>
    mex(<span class="hljs-string">'sfun_exlib.c'</span>, <span class="hljs-string">'-I/tmp/simulink_shrlib_fex'</span>, <span class="hljs-string">'/tmp/simulink_shrlib_fex/exlib.so'</span>)<font></font>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.<font></font>
### Finish Compiling sfun_exlib<font></font>
### Exit<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, cree el bloque Simulink:</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'slblock_generate'</span>,specs);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute la simulaci√≥n:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test'</span>);<font></font>
snapnow;<font></font>
sim(<span class="hljs-string">'simlib_test'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribir funciones S manualmente</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo enfoque es escribir sus propias funciones S para cargar una biblioteca compartida y llamar a funciones desde esta biblioteca. </font><font style="vertical-align: inherit;">Este enfoque utilizar√° enlaces expl√≠citos, tambi√©n llamados enlaces de tiempo de ejecuci√≥n. </font><font style="vertical-align: inherit;">La soluci√≥n m√°s f√°cil es adaptar la funci√≥n S que se gener√≥ autom√°ticamente anteriormente con la herramienta Legacy Code Tool. </font><font style="vertical-align: inherit;">En este ejemplo, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">modifican las</font></i><font style="vertical-align: inherit;"> funciones </font><i><font style="vertical-align: inherit;">mdlStart</font></i><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlOutputs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlTerminate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ven estas funciones despu√©s de la modificaci√≥n:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver c√≥digo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlStart</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Load the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_init_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    dllHandle = dlopen(<span class="hljs-string">"./exlib.so"</span>,RTLD_LAZY);<font></font>
    exlib_init_ptr = dlsym(dllHandle, <span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_init_type exlib_init_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    dllHandle = LoadLibrary(<span class="hljs-string">"exlib.dll"</span>);<font></font>
    exlib_init_ptr = (exlib_init_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  exlib_init_ptr();<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlOutputs</span><span class="hljs-params">(SimStruct *S, int_T tid)</span>
</span>{<font></font>
  real32_T *u1 = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_print_ptr)(<span class="hljs-keyword">float</span>);<font></font>
    exlib_print_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_print_type exlib_print_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_print_ptr = (exlib_print_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  <span class="hljs-comment">/*
   * Get access to Parameter/Input/Output/DWork/size information
   */</span>
  u1 = (real32_T *) ssGetInputPortSignal(S, <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">/*
   * Call the function from library
   */</span><font></font>
  exlib_print_ptr( *u1);<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlTerminate</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Unload the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_term_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    exlib_term_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    dlclose(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_term_type exlib_term_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_term_ptr = (exlib_term_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    FreeLibrary(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compile la funci√≥n S resultante:</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>,<span class="hljs-string">'-ldl'</span>);
<span class="hljs-keyword">else</span>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ejecuta la simulaci√≥n:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_dyn'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_dyn'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando S-Function Builder</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otro enfoque es usar el bloque </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S-Function Builder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esta es una unidad especial que puede verse como un cruce entre la herramienta de c√≥digo heredado y las funciones S escritas a mano en t√©rminos de complejidad. </font><font style="vertical-align: inherit;">S-Function Builder proporciona una interfaz gr√°fica que describe las caracter√≠sticas de su funci√≥n S, y la funci√≥n S se crea autom√°ticamente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existen algunas limitaciones de rendimiento y problemas con el uso de S-Function Builder. </font><font style="vertical-align: inherit;">Actualmente, esto se considera un enfoque obsoleto para crear funciones S. </font><font style="vertical-align: inherit;">Se recomienda utilizar el bloque de funci√≥n C, que apareci√≥ en el lanzamiento de R2020a y se analiza m√°s adelante.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocar una biblioteca compartida utilizando la funci√≥n MATLAB </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El bloque de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciones MATLAB le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite usar el lenguaje MATLAB para describir un algoritmo personalizado en Simulink. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para llamar a la biblioteca compartida desde la funci√≥n MATLAB, use la funci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que solo se puede usar en el cuerpo de la funci√≥n MATLAB (y no en MATLAB). </font><font style="vertical-align: inherit;">Coder.ceval no requiere MATLAB Coder para funcionar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√≥digo para el bloque de funciones MATLAB que llama a la biblioteca compartida:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver c√≥digo</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fcn</span><span class="hljs-params">(u)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Keep track of initialization and runtime count</span>
<span class="hljs-keyword">persistent</span> runTimeCnt<font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly (current directory in this case)</span>
coder.extrinsic(<span class="hljs-string">'pwd'</span>,<span class="hljs-string">'system_dependent'</span>);<font></font>
libpath = coder.const(pwd);<font></font>
<span class="hljs-comment">% Shared library to link with</span>
libname = coder.const([<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]);
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(<span class="hljs-string">'exlib.h'</span>);<font></font>
<font></font>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isempty</span>(runTimeCnt)
    <span class="hljs-comment">% Initialize</span>
    coder.ceval(<span class="hljs-string">'exlib_init'</span>);<font></font>
    runTimeCnt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Step</span>
coder.ceval(<span class="hljs-string">'exlib_print'</span>,single(u));<font></font>
runTimeCnt = runTimeCnt+<span class="hljs-number">1</span>;
<span class="hljs-comment">% Terminate on the 10th step</span>
<span class="hljs-keyword">if</span> (runTimeCnt == <span class="hljs-number">11</span>)<font></font>
    coder.ceval(<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-keyword">end</span>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este enfoque tiene un inconveniente: la falta de una buena forma de llamar a la funci√≥n de finalizaci√≥n al final de la simulaci√≥n (en comparaci√≥n con el bloque del sistema MATLAB). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede definir la funci√≥n de finalizaci√≥n para el modelo estableciendo exlib_term (); en la configuraci√≥n del modelo en la categor√≠a </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Objetivo de simulaci√≥n -&gt; C√≥digo personalizado -&gt; Terminar funci√≥n</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NOTA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si el par√°metro "Importar c√≥digo personalizado" est√° configurado en la configuraci√≥n del modelo, debe especificar todas las dependencias de c√≥digo en el panel "Simulaci√≥n de destino" (en lugar de usar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Si este par√°metro no est√° configurado, puede combinar la configuraci√≥n de Simulation Target, coder.cinclude y coder.updateBuildInfo.</font></font><br>
</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Otra forma es mantener dependencias usando</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y llame a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por convenci√≥n, como se demostr√≥ en el ejemplo anterior. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute la simulaci√≥n:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mlf'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mlf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocar una biblioteca compartida desde Stateflow </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea utilizar las funciones de la biblioteca compartida en los diagramas de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stateflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , estas funciones deben llamarse directamente desde Stateflow. La documentaci√≥n de Stateflow tiene ejemplos que muestran c√≥mo hacer esto. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Llamar a una funci√≥n externa en Stateflow es muy simple: debe especificar el nombre de la funci√≥n en el diagrama de Stateflow: </font></font><br>
<img src="https://habrastorage.org/webt/_f/3m/z7/_f3mz7djr11eebq8egiisjpk9ru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
adem√°s, debe configurar los par√°metros del modelo para que Stateflow sepa d√≥nde buscar estas funciones externas. En la configuraci√≥n de </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; C√≥digo personalizado -&gt; Bibliotecas,</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe ingresar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.lib (o exlib.so en Linux)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Custom Code -&gt; Header File,</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe ingresar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Tambi√©n es importante no olvidar especificar la funci√≥n de finalizaci√≥n. A</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Objetivo de simulaci√≥n -&gt; C√≥digo personalizado -&gt; La funci√≥n Terminar</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe especificar</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exlib_term (); </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute la simulaci√≥n:</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_sf'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_sf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que la informaci√≥n contenida en esta secci√≥n se aplica a los diagramas de Stateflow que utilizan </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el lenguaje de acci√≥n C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si el diagrama de Stateflow usa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el lenguaje de acci√≥n MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , entonces </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se requiere coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , como es el caso con la funci√≥n MATLAB.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocar una biblioteca compartida utilizando el bloque del sistema MATLAB </font></font></h2> <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El bloque del sistema MATLAB le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite usar objetos del sistema en Simulink. </font><font style="vertical-align: inherit;">Se puede encontrar m√°s informaci√≥n sobre este bloque en la documentaci√≥n. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El soporte para objetos del sistema apareci√≥ en Simulink en el lanzamiento de R2013b. </font><font style="vertical-align: inherit;">Muchas personas usan objetos del sistema porque facilitan la definici√≥n de las funciones de inicializaci√≥n, simulaci√≥n y finalizaci√≥n. </font><font style="vertical-align: inherit;">Adem√°s, los objetos del sistema pueden usar el c√≥digo MATLAB auxiliar para estas funciones, por ejemplo, para los datos de procesamiento previo y posterior de una funci√≥n de paso, todo sin escribir el c√≥digo C. As√≠ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
es como se ve el objeto del sistema utilizado en el bloque del sistema MATLAB:</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de objeto del sistema</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-keyword">classdef</span> exlib &lt; matlab.System
    <span class="hljs-comment">% Call exlib shared library</span>
    <span class="hljs-comment">%</span>
    <span class="hljs-comment">% This example shows how to call shared library from Simulink using</span>
    <span class="hljs-comment">% MATLAB System block.</span>
    <span class="hljs-keyword">properties</span> (Nontunable,Access=private)<font></font>
        libName = exlib.getLibName;<font></font>
        libPath = pwd;<font></font>
        libHeader = <span class="hljs-string">'exlib.h'</span>;
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Static)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">libName</span> = <span class="hljs-title">getLibName</span></span>
            <span class="hljs-keyword">if</span> isunix<font></font>
                libName = <span class="hljs-string">'exlib.so'</span>;
            <span class="hljs-keyword">else</span>
                libName = <span class="hljs-string">'exlib.lib'</span>;
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Access=protected)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupImpl</span><span class="hljs-params">(obj, ~)</span></span>
            <span class="hljs-comment">% Initialize.</span>
            coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,obj.libName,obj.libPath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
            coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,obj.libPath);<font></font>
            coder.cinclude(obj.libHeader);<font></font>
            coder.ceval(<span class="hljs-string">'exlib_init'</span>);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stepImpl</span><span class="hljs-params">(~, u)</span></span>
            <span class="hljs-comment">% Step.</span>
            coder.ceval(<span class="hljs-string">'exlib_print'</span>,u);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">releaseImpl</span><span class="hljs-params">(~)</span></span>
            <span class="hljs-comment">% Terminate.</span>
            coder.ceval(<span class="hljs-string">'exlib_term'</span>);
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute la simulaci√≥n:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mls'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mls'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamar a bibliotecas compartidas usando el bloque de llamadas C </font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El bloque </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Caller le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite llamar a funciones C directamente desde Simulink. Se puede encontrar m√°s informaci√≥n sobre este bloque en la documentaci√≥n. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es un enfoque relativamente nuevo que apareci√≥ por primera vez en MATLAB R2018b. Su objetivo principal es hacer que las llamadas a funciones y las bibliotecas C en Simulink sean extremadamente simples. Pero tiene limitaciones, sobre las que puede leer en la documentaci√≥n de este bloque. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib se</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> haya agregado a </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Libraries</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation Target -&gt; Header</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la configuraci√≥n del modelo, simplemente haga clic en el bot√≥n "Actualizar c√≥digo personalizado" en el bloque C Caller, para ver todas las funciones contenidas en la biblioteca.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de seleccionar la funci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_print</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el cuadro de di√°logo de especificaci√≥n de puerto se completa autom√°ticamente: </font></font><br>
<img src="https://habrastorage.org/webt/4s/sz/bd/4sszbddxgbpffb3urxzbw2dv-ua.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y nuevamente, debe agregar las llamadas </font><font style="vertical-align: inherit;">a la </font><font style="vertical-align: inherit;">funci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al Objetivo de simulaci√≥n. </font><font style="vertical-align: inherit;">Tambi√©n puede agregar un par de otros bloques de C Caller para llamar directamente a las funciones de inicializaci√≥n y finalizaci√≥n. </font><font style="vertical-align: inherit;">Estos bloques C Caller deben colocarse en los subsistemas Initialize Function y Terminate Function. </font><font style="vertical-align: inherit;">Tambi√©n puede considerar el siguiente ejemplo de Stateflow: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programar subsistemas para ejecutar en momentos espec√≠ficos</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ejecute la simulaci√≥n:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ccaller'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocaci√≥n de bibliotecas compartidas utilizando el bloque de funci√≥n C</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La √∫ltima adici√≥n a la integraci√≥n de c√≥digo externo en Simulink es el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Funci√≥n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bloque </font><font style="vertical-align: inherit;">. √âl apareci√≥ en el R2020a. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se asemeja al bloque C Caller en t√©rminos de facilidad de uso, pero le permite crear un contenedor C alrededor de las funciones importadas (por lo tanto, este bloque se asemeja a S-Function Builder). Pero, lo m√°s probable, el escenario principal para usar el bloque de funci√≥n C no es llamar a funciones C existentes, sino escribir peque√±os fragmentos de c√≥digo C, si dicho c√≥digo es necesario en la aplicaci√≥n. Por ejemplo, es posible que necesite acceso a los registros de hardware o las funciones integradas del compilador. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No olvide agregar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a la configuraci√≥n </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Simulaci√≥n de destino -&gt; Bibliotecas"</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#include "exlib.h"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la configuraci√≥n </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Objetivo de simulaci√≥n -&gt; Archivo de encabezado"</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la configuraci√≥n del modelo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, en la configuraci√≥n del bloque de funci√≥n C, debe agregar un car√°cter para los datos de entrada con el tipo de datos √∫nico y especificar el c√≥digo de salida, inicio y finalizaci√≥n:</font></font><br>
<img src="https://habrastorage.org/webt/pm/ek/uz/pmekuz8kkzafgxf8ky1v8coqqla.png"><br>
<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_cfunction'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invocaci√≥n de bibliotecas compartidas generadas con el codificador incorporado </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno de los escenarios para usar Embedded Coder es la generaci√≥n autom√°tica de c√≥digo C a partir del modelo Simulink y el empaquetado de este c√≥digo en una biblioteca compartida. La documentaci√≥n tambi√©n tiene un ejemplo que muestra c√≥mo generar autom√°ticamente una biblioteca compartida y llamarla desde una aplicaci√≥n externa escrita en C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga </font><font style="vertical-align: inherit;">en </font><font style="vertical-align: inherit;">cuenta que si solo necesita ejecutar el algoritmo o parte del algoritmo como c√≥digo C en el mismo modelo Simulink, entonces es mejor usar Funciones S de Simulink Coder o simulaci√≥n de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">software en el bucle</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sin embargo, si la biblioteca compartida generada por Embedded Coder se usa para el modelado seminatural, puede ser necesario integrar la misma biblioteca en el modelo m√°s grande utilizado por otros desarrolladores y as√≠ proteger su propiedad intelectual. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabajar con una biblioteca compartida generada por Embedded Coder no es diferente de trabajar con una biblioteca compartida, que se utiliz√≥ en el art√≠culo. </font><font style="vertical-align: inherit;">Considere un modelo simple que tiene dos entradas y una salida:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/wt/vo/wu/wtvowu3jc24ttsqd1qfgok9jxpc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de ensamblar el modelo, obtenemos un archivo .dll (.so en Linux), un archivo .lib (una biblioteca de importaci√≥n para .dll) y un archivo .exp (un archivo de exportaci√≥n para comunicarse con .dll).</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ert'</span>,<span class="hljs-string">'CustomHeaderCode'</span>,<span class="hljs-string">'#include &lt;stddef.h&gt;'</span>);
<span class="hljs-keyword">end</span>
rtwbuild(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
### Starting build procedure <span class="hljs-keyword">for</span>: simlib_test_ert<font></font>
### Successful completion of build procedure <span class="hljs-keyword">for</span>: simlib_test_ert</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La biblioteca compartida generada exporta los siguientes caracteres:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function">ex_init
<span class="hljs-keyword">double</span> <span class="hljs-title">ex_step</span><span class="hljs-params">(<span class="hljs-keyword">double</span>, <span class="hljs-keyword">double</span>)</span>
simlib_test_ert_terminate</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De manera predeterminada, las entradas y salidas se exportan como caracteres globales, y las funciones de inicializaci√≥n, paso y finalizaci√≥n siguen la convenci√≥n de nomenclatura del modelo. </font><font style="vertical-align: inherit;">Si es necesario, puede configurar prototipos de funciones, nombres de s√≠mbolos y m√°s (una discusi√≥n sobre estas configuraciones est√° m√°s all√° del alcance de este art√≠culo). </font><font style="vertical-align: inherit;">En este modelo, el prototipo de la funci√≥n de paso del modelo se define como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Out1 = ex_step (In1, In2)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para llamar a estas funciones, debe usar uno de los m√©todos enumerados anteriormente. </font><font style="vertical-align: inherit;">Por ejemplo, puede usar la funci√≥n MATLAB (por simplicidad solo llamamos a la funci√≥n de paso):</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver c√≥digo</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">y</span> = <span class="hljs-title">fcn</span><span class="hljs-params">(u1, u2)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly</span>
coder.extrinsic(<span class="hljs-string">'RTW.getBuildDir'</span>,<span class="hljs-string">'fullfile'</span>);<font></font>
buildDir = coder.const(RTW.getBuildDir(<span class="hljs-string">'simlib_test_ert'</span>));<font></font>
libpath = coder.const(buildDir.CodeGenFolder);<font></font>
incpath = coder.const(fullfile(buildDir.BuildDirectory,<span class="hljs-string">'simlib_test_ert.h'</span>));
<span class="hljs-comment">% Shared library to link with</span>
<span class="hljs-keyword">if</span> isunix<font></font>
    ext = <span class="hljs-string">'.so'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert'</span>,ext];
<span class="hljs-keyword">else</span>
    ext = <span class="hljs-string">'.lib'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert_'</span>,computer(<span class="hljs-string">'arch'</span>),ext];
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(incpath);<font></font>
<font></font>
<span class="hljs-comment">% Initialize output</span>
y = <span class="hljs-number">0</span>;
<span class="hljs-comment">% Step</span>
y = coder.ceval(<span class="hljs-string">'ex_step'</span>,u1,u2);</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute la simulaci√≥n y observe sus resultados:</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/ga/qw/vt/gaqwvt2gg4g87wrtxufr78pezxa.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recomendaciones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este art√≠culo describe varios enfoques para invocar bibliotecas compartidas de modelos Simulink. </font><font style="vertical-align: inherit;">Se consideraron enlaces impl√≠citos y expl√≠citos. </font><font style="vertical-align: inherit;">Todos los m√©todos tienen sus pros y sus contras, y su idoneidad depende del flujo de trabajo espec√≠fico, los requisitos y los objetivos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El </font><font style="vertical-align: inherit;">enfoque de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy Code Tool</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona mejor cuando se implementa un enlace impl√≠cito con una biblioteca compartida, porque en este caso solo podemos llamar funciones directamente desde la biblioteca, y el enlazador se encargar√° del resto. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El bloque del sistema MATLAB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es otro enfoque que proporciona los siguientes beneficios:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excelente cumplimiento del paradigma de las funciones de inicializaci√≥n, paso y finalizaci√≥n, lo que le permite mantener todas estas funciones dentro del bloque en s√≠, y no en la escala del modelo.</font></font><br>
</li>
<li>       <br>
</li>
<li>    MATLAB     MATLAB<br>
</li>
<li> MATLAB System           (,    S-)<br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La desventaja de usar el bloque de funciones MATLAB es que su uso puede generar una sobrecarga adicional durante la generaci√≥n del c√≥digo. Por lo tanto, las herramientas Legacy Code Tool y S todav√≠a se prefieren para generar c√≥digo de producci√≥n. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una funci√≥n S escrita a mano es la m√°s adecuada para implementar un enlace expl√≠cito a una biblioteca compartida. En este caso, debe usar funciones como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary / dlopen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetProcAddress / dlsym</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeLibrary / dlclose</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para poder llamar a funciones. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El bloque C Caller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> introducido en R2018b es, con mucho, la forma m√°s f√°cil de llamar a funciones C, pero tiene sus limitaciones. Lo mismo puede decirse del bloque de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funci√≥n C.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que es la √∫ltima incorporaci√≥n al R2020a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descargue fuentes y modelos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es503894/index.html">Anuncio de la reuni√≥n en l√≠nea NskTechTalks # 12: ¬ød√≥nde puede crecer el desarrollador front-end y qu√© pasa si no sale nada?</a></li>
<li><a href="../es503898/index.html">Un d√≠a de front-end remoto</a></li>
<li><a href="../es503902/index.html">C√≥mo hacer que los vecinos trabajen en su proyecto, o InnerSource para un banco</a></li>
<li><a href="../es503904/index.html">El mundo yn mundos, o las matem√°ticas para las humanidades.</a></li>
<li><a href="../es503906/index.html">LabVIEW NXG - Tipos de datos simples y coerci√≥n de tipos</a></li>
<li><a href="../es503910/index.html">Experimentos en personas que han ido a "udalenka"</a></li>
<li><a href="../es503916/index.html">Aprender a comerciar en el intercambio. Primera parte: configurar un entorno de prueba</a></li>
<li><a href="../es503918/index.html">Gesti√≥n de paquetes con m√≥dulos Go: una gu√≠a pragm√°tica</a></li>
<li><a href="../es503920/index.html">C√≥mo probamos los sistemas de micr√≥fonos en STM32: la experiencia de los desarrolladores de dispositivos Yandex</a></li>
<li><a href="../es503922/index.html">¬øPor qu√© la UE erradica las paredes de las galletas?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>