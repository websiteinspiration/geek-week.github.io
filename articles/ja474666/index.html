<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•¢ ğŸ¦† ğŸšµğŸ¿ Rustã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›¸ãç›´ã•ãªã„æ–¹æ³• ğŸ“‚ ğŸ¤« ğŸ‘ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Borrow-Checkerã®ç—›ã¿ã®ã—ãã„å€¤ã‚’è¶…ãˆã¦ã€RustãŒä»–ã®è¨€èªã§ã¯æƒ³åƒã‚‚ã§ããªã„ï¼ˆæ™‚ã«ã¯å±é™ºãªï¼‰ã“ã¨ã‚’è¨±å¯ã—ã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ã„ãŸã‚‰ã€ã™ãã«åŒã˜ã‚ˆã†ã«ã™ã¹ã¦ã‚’Rustã«æ›¸ãæ›ãˆãŸã„ã¨ã„ã†æ¬²æ±‚ãŒãŸã¾ã‚‰ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚æœ€è‰¯ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã“ã‚Œã¯å¹³å‡¡ãªéç”Ÿç”£çš„ã§ã™ãŒï¼ˆã„ãã¤ã‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯æ„å‘³...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Rustã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›¸ãç›´ã•ãªã„æ–¹æ³•</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474666/"><p><img align="right" width="320" src="https://habrastorage.org/webt/dr/uk/dk/drukdkvyoebpgesff5zb_o1zplm.png"><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Borrow-Checkerã®</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç—›ã¿ã®ã—ãã„å€¤ã‚’è¶…ãˆ</font><font style="vertical-align: inherit;">ã¦ã€RustãŒä»–ã®è¨€èªã§ã¯æƒ³åƒã‚‚ã§ããªã„ï¼ˆæ™‚ã«ã¯å±é™ºãªï¼‰ã“ã¨ã‚’è¨±å¯ã—ã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ã„</font><font style="vertical-align: inherit;">ãŸã‚‰ã€ã™ãã«</font><font style="vertical-align: inherit;">åŒã˜ã‚ˆã†ã«</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã™ã¹ã¦ã‚’Rust</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã«</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">æ›¸ãæ›ãˆ</font></a><font style="vertical-align: inherit;">ãŸã„ã¨ã„ã†æ¬²æ±‚ãŒãŸã¾ã‚‰ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æœ€è‰¯ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã“ã‚Œã¯å¹³å‡¡ãªéç”Ÿç”£çš„ã§ã™ãŒï¼ˆã„ãã¤ã‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯æ„å‘³ã®ãªã„ç„¡é§„é£ã„ã®åŠªåŠ›ï¼‰ã€æœ€æ‚ªã®å ´åˆã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã®ä½ä¸‹ã«ã¤ãªãŒã‚Šã¾ã™ï¼ˆçµå±€ã®ã¨ã“ã‚ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹åˆ†é‡ã§ã€å…ƒã®ä½œè€…ã‚ˆã‚Šã‚‚çµŒé¨“ãŒè±Šå¯Œã ã¨æ€ã†ã®ã¯ãªãœã§ã™ã‹ï¼Ÿï¼‰</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚³ãƒ¼ãƒ‰ã‚’å†åˆ©ç”¨ã—ã¦ã€å…ƒã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å®‰å…¨ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æä¾›ã™ã‚‹ã»ã†ãŒã¯ã‚‹ã‹ã«ä¾¿åˆ©ã§ã™ã€‚</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¹ãƒ†ãƒƒãƒ—</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chmlib-SYSã‚’ç½®ã</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ã‚¹ãƒˆã§å®‰å…¨ãªãƒ©ãƒƒãƒ‘ãƒ¼ã®æ›¸ãè¾¼ã¿</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€ƒâ€ƒâ€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åå‰ã§æ¤œç´¢è¦ç´ ã‚’</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€ƒâ€ƒâ€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚£ãƒ«ã‚¿ã«ã‚ˆã£ã¦ãƒã‚¤ãƒ‘ã‚¹è¦ç´ </font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€ƒâ€ƒâ€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚€</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹ã®è¿½åŠ </font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€ƒâ€ƒâ€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CHMãƒ•ã‚¡ã‚¤ãƒ«ã®ç›®æ¬¡</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€ƒâ€ƒâ€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ã‚£ã‚¹ã‚¯ã«CHMãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹æ¢±</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
â€¢ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¬¡ã¯ä½•ã‚’ï¼Ÿ</font></font></a></p><br>
<blockquote>     .        CHM-,       .  â€”  .<br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> <strong>chmlib</strong>   crates.io</a>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> GitHub</a>.          ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.</blockquote><br>
<h2 id="pervye-shagi"> </h2><br>
<p>     ,      .</p><br>
<blockquote>    ,   ,    ,   .  ,        .<br>
<br>
<strong>   !</strong></blockquote><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">CHMLib</a>,       <em>Microsoft Compiled HTML Help</em> (<code>.chm</code>).</p><br>
<p>       CHMLib   git-:</p><br>
<pre><code class="plaintext hljs">$ git init chmlib &amp;&amp; cd chmlib<font></font>
  Initialized empty Git repository in /home/michael/Documents/chmlib/.git/<font></font>
$ touch README.md Cargo.toml<font></font>
$ cargo new --lib chmlib<font></font>
  Created library `chmlib` package<font></font>
$ cargo new --lib chmlib-sys<font></font>
  Created library `chmlib-sys` package<font></font>
$ cat Cargo.toml<font></font>
  [workspace]<font></font>
  members = ["chmlib", "chmlib-sys"]<font></font>
$ git submodule add git@github.com:jedwing/CHMLib.git vendor/CHMLib<font></font>
  Cloning into '/home/michael/Documents/chmlib/vendor/CHMLib'...<font></font>
  remote: Enumerating objects: 99, done.<font></font>
  remote: Total 99 (delta 0), reused 0 (delta 0), pack-reused 99<font></font>
  Receiving objects: 100% (99/99), 375.51 KiB | 430.00 KiB/s, done.<font></font>
  Resolving deltas: 100% (45/45), done.</code></pre><br>
<p>  ,   ,   <code>tree</code>:</p><br>
<pre><code class="plaintext hljs">$ tree vendor/CHMLib<font></font>
vendor/CHMLib<font></font>
â”œâ”€â”€ acinclude.m4<font></font>
â”œâ”€â”€ AUTHORS<font></font>
â”œâ”€â”€ ChangeLog<font></font>
â”œâ”€â”€ ChmLib-ce.zip<font></font>
â”œâ”€â”€ ChmLib-ds6.zip<font></font>
â”œâ”€â”€ configure.in<font></font>
â”œâ”€â”€ contrib<font></font>
â”‚   â””â”€â”€ mozilla_helper.sh<font></font>
â”œâ”€â”€ COPYING<font></font>
â”œâ”€â”€ Makefile.am<font></font>
â”œâ”€â”€ NEWS<font></font>
â”œâ”€â”€ NOTES<font></font>
â”œâ”€â”€ README<font></font>
â””â”€â”€ src<font></font>
    â”œâ”€â”€ chm_http.c<font></font>
    â”œâ”€â”€ chm_lib.c<font></font>
    â”œâ”€â”€ chm_lib.h<font></font>
    â”œâ”€â”€ enum_chmLib.c<font></font>
    â”œâ”€â”€ enumdir_chmLib.c<font></font>
    â”œâ”€â”€ extract_chmLib.c<font></font>
    â”œâ”€â”€ lzx.c<font></font>
    â”œâ”€â”€ lzx.h<font></font>
    â”œâ”€â”€ Makefile.am<font></font>
    â”œâ”€â”€ Makefile.simple<font></font>
    â””â”€â”€ test_chmLib.c<font></font>
<font></font>
2 directories, 23 files</code></pre><br>
<p>,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">GNU Autotools</a>  .  ,      chmlib (  )   Autotools.</p><br>
<blockquote>     Â«Â» ,     ,    .</blockquote><p> lzx.h  lzx.c     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">LZX</a>.      -  liblzx,       , , ,      .</p><br>
<p>enum_chmLib.c, enumdir_chmLib.c, extract_chmLib.c, ,     chm_enumerate(), chm_enumerate_dir(), chm_retrieve_object().  ...</p><br>
<p>  test_chmLib.c    ,        CHM-  .</p><br>
<p>chm_http.c   HTTP-,  CHM-  .  , ,   .</p><br>
<p>    ,    vendor/CHMLib/src.   ?</p><br>
<p> ,   ,     .</p><br>
<pre><code class="plaintext hljs">$ clang chm_lib.c enum_chmLib.c -o enum_chmLib<font></font>
  /usr/bin/ld: /tmp/chm_lib-537dfe.o: in function `chm_close':<font></font>
  chm_lib.c:(.text+0x8fa): undefined reference to `LZXteardown'<font></font>
  /usr/bin/ld: /tmp/chm_lib-537dfe.o: in function `_chm_decompress_region':<font></font>
  chm_lib.c:(.text+0x18ca): undefined reference to `LZXinit'<font></font>
  /usr/bin/ld: /tmp/chm_lib-537dfe.o: in function `_chm_decompress_block':<font></font>
  chm_lib.c:(.text+0x2900): undefined reference to `LZXreset'<font></font>
  /usr/bin/ld: chm_lib.c:(.text+0x2a4b): undefined reference to `LZXdecompress'<font></font>
  /usr/bin/ld: chm_lib.c:(.text+0x2abe): undefined reference to `LZXreset'<font></font>
  /usr/bin/ld: chm_lib.c:(.text+0x2bf4): undefined reference to `LZXdecompress'<font></font>
  clang: error: linker command failed with exit code 1 (use -v to see invocation)</code></pre><br>
<p>,   LZX   ...</p><br>
<pre><code class="plaintext hljs">$ clang chm_lib.c enum_chmLib.c lzx.c -o enum_chmLib</code></pre><br>
<p>--â€¦  ?</p><br>
<p>    ,     :</p><br>
<pre><code class="plaintext hljs">$ curl http://www.innovasys.com/static/hs/samples/topics.classic.chm.zip \<font></font>
           -o topics.classic.chm.zip<font></font>
$ unzip topics.classic.chm.zip<font></font>
Archive:  topics.classic.chm.zip<font></font>
  inflating: output/compiled/topics.classic.chm<font></font>
$ file output/compiled/topics.classic.chm<font></font>
output/compiled/topics.classic.chm: MS Windows HtmlHelp Data</code></pre><br>
<p>,     enum_chmLib:</p><br>
<pre><code class="plaintext hljs">$ ./enum_chmLib output/compiled/topics.classic.chm<font></font>
output/compiled/topics.classic.chm:<font></font>
 spc    start   length   type           name<font></font>
 ===    =====   ======   ====           ====<font></font>
   0        0        0   normal dir     /<font></font>
   1  5125797     4096   special file       /#IDXHDR<font></font>
   ...<font></font>
   1  4944434    11234   normal file        /BrowserView.html<font></font>
   ...<font></font>
   0        0        0   normal dir     /flash/<font></font>
   1   532689      727   normal file        /flash/expressinstall.swf<font></font>
   0        0        0   normal dir     /Images/Commands/RealWorld/<font></font>
   1    24363     1254   normal file        /Images/Commands/RealWorld/BrowserBack.bmp<font></font>
   ...<font></font>
   1    35672     1021   normal file        /Images/Employees24.gif<font></font>
   ...<font></font>
   1  3630715   200143   normal file        /template/packages/jquery-mobile/script/<font></font>
                                             jquery.mobile-1.4.5.min.js<font></font>
   ...<font></font>
   0      134     1296   meta file      ::DataSpace/Storage/MSCompressed/Transform/<font></font>
                                          {7FC28940-9D31-11D0-9B27-00A0C91E9C7C}/<font></font>
                                          InstanceData/ResetTable</code></pre><br>
<p>, <em> </em> jQuery Â¯\_(ãƒ„)_/Â¯</p><br>
<h2 id="sobiraem-chmlib-sys"> chmlib-sys</h2><br>
<p>   ,   CHMLib   <strong>chmlib-sys</strong>,      ,    ,      .</p><br>
<p>      <code>build.rs</code>.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> <strong>cc</strong></a>        ,      .</p><br>
<blockquote> ,         cc,     .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    </a>.</blockquote><p>  <strong>cc</strong>    chmlib-sys:</p><br>
<pre><code class="plaintext hljs">$ cd chmlib-sys<font></font>
$ cargo add --build cc<font></font>
    Updating 'https://github.com/rust-lang/crates.io-index' index<font></font>
      Adding cc v1.0.46 to build-dependencies</code></pre><br>
<p>  <code>build.rs</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib-sys/build.rs</span><font></font>
<font></font>
<span class="hljs-keyword">use</span> cc::Build;
<span class="hljs-keyword">use</span> std::{env, path::PathBuf};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> project_dir = PathBuf::from(env::var(<span class="hljs-string">"CARGO_MANIFEST_DIR"</span>).unwrap())<font></font>
        .canonicalize()<font></font>
        .unwrap();<font></font>
    <span class="hljs-keyword">let</span> root_dir = project_dir.parent().unwrap();
    <span class="hljs-keyword">let</span> src = root_dir.join(<span class="hljs-string">"vendor"</span>).join(<span class="hljs-string">"CHMLib"</span>).join(<span class="hljs-string">"src"</span>);<font></font>
<font></font>
    Build::new()<font></font>
        .file(src.join(<span class="hljs-string">"chm_lib.c"</span>))<font></font>
        .file(src.join(<span class="hljs-string">"lzx.c"</span>))<font></font>
        .include(&amp;src)<font></font>
        .warnings(<span class="hljs-literal">false</span>)<font></font>
        .compile(<span class="hljs-string">"chmlib"</span>);<font></font>
}</code></pre><br>
<p>   Cargo  ,  chmlib-sys    chmlib.  Cargo  ,         ,     .               .</p><br>
<pre><code class="diff hljs"><span class="hljs-comment">--- a/chmlib-sys/Cargo.toml</span>
<span class="hljs-comment">+++ b/chmlib-sys/Cargo.toml</span><font></font>
@@ -3,7 +3,13 @@ name = "chmlib-sys"<font></font>
 version = "0.1.0"<font></font>
 authors = ["Michael Bryan &lt;michaelfbryan@gmail.com&gt;"]<font></font>
 edition = "2018"<font></font>
 description = "Raw bindings to the CHMLib C library"<font></font>
 license = "LGPL"<font></font>
 repository = "https://github.com/Michael-F-Bryan/chmlib"<font></font>
<span class="hljs-addition">+links = "chmlib"</span>
<span class="hljs-addition">+build = "build.rs"</span><font></font>
<font></font>
 [dependencies]<font></font>
<font></font>
 [build-dependencies]<font></font>
 cc = { version = "1.0" }</code></pre><br>
<p>     ,   chmlib,       .</p><br>
<p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">bindgen</a>.        ,       FFI-  .</p><br>
<pre><code class="plaintext hljs">$ cargo install bindgen<font></font>
$ bindgen ../vendor/CHMLib/src/chm_lib.h \<font></font>
    -o src/lib.rs \<font></font>
    --raw-line '#![allow(non_snake_case, non_camel_case_types)]'<font></font>
$ head src/lib.rs<font></font>
  /* automatically generated by rust-bindgen */<font></font>
<font></font>
  #![allow(non_snake_case, non_camel_case_types)]<font></font>
<font></font>
  pub const CHM_UNCOMPRESSED: u32 = 0;<font></font>
  pub const CHM_COMPRESSED: u32 = 1;<font></font>
  pub const CHM_MAX_PATHLEN: u32 = 512;<font></font>
  pub const CHM_PARAM_MAX_BLOCKS_CACHED: u32 = 0;<font></font>
  pub const CHM_RESOLVE_SUCCESS: u32 = 0;<font></font>
  pub const CHM_RESOLVE_FAILURE: u32 = 1;<font></font>
$ tail src/lib.rs<font></font>
  extern "C" {<font></font>
      pub fn chm_enumerate_dir(<font></font>
          h: *mut chmFile,<font></font>
          prefix: *const ::std::os::raw::c_char,<font></font>
          what: ::std::os::raw::c_int,<font></font>
          e: CHM_ENUMERATOR,<font></font>
          context: *mut ::std::os::raw::c_void,<font></font>
      ) -&gt; ::std::os::raw::c_int;<font></font>
  }</code></pre><br>
<blockquote>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  Bindgen</a>,    -    .</blockquote><p>      smoke-,  ,               .</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib-sys/tests/smoke_test.rs</span><font></font>
<font></font>
<span class="hljs-comment">//    Path  char*     .</span>
<span class="hljs-comment">//  , OsStr ( Path)  Windows  [u16]  ,</span>
<span class="hljs-comment">//        char*.</span>
<span class="hljs-meta">#![cfg(unix)]</span><font></font>
<font></font>
<span class="hljs-keyword">use</span> std::{ffi::CString, os::unix::ffi::OsStrExt, path::Path};<font></font>
<font></font>
<span class="hljs-meta">#[test]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">open_example_file</span></span>() {
    <span class="hljs-keyword">let</span> project_dir = Path::new(<span class="hljs-built_in">env!</span>(<span class="hljs-string">"CARGO_MANIFEST_DIR"</span>));
    <span class="hljs-keyword">let</span> sample_chm = project_dir.parent().unwrap().join(<span class="hljs-string">"topics.classic.chm"</span>);
    <span class="hljs-keyword">let</span> c_str = CString::new(sample_chm.as_os_str().as_bytes()).unwrap();<font></font>
<font></font>
    <span class="hljs-keyword">unsafe</span> {
        <span class="hljs-keyword">let</span> handle = chmlib_sys::chm_open(c_str.as_ptr());
        <span class="hljs-built_in">assert!</span>(!handle.is_null());<font></font>
        chmlib_sys::chm_close(handle);<font></font>
    }<font></font>
}</code></pre><br>
<p><code>cargo test</code> ,     :</p><br>
<pre><code class="plaintext hljs">$ cargo test<font></font>
    Finished test [unoptimized + debuginfo] target(s) in 0.03s<font></font>
     Running ~/chmlib/target/debug/deps/chmlib_sys-2ffd7b11a9fd8437<font></font>
<font></font>
running 1 test<font></font>
test bindgen_test_layout_chmUnitInfo ... ok<font></font>
<font></font>
test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out<font></font>
<font></font>
     Running ~/chmlib/target/debug/deps/smoke_test-f7be9810412559dc<font></font>
<font></font>
running 1 test<font></font>
test open_example_file ... ok<font></font>
<font></font>
test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out<font></font>
<font></font>
   Doc-tests chmlib-sys<font></font>
<font></font>
running 0 tests<font></font>
<font></font>
test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out</code></pre><br>
<h2 id="pishem-bezopasnuyu-obyortku-na-rust">    Rust</h2><br>
<p><em>--</em>     CHMLib  ,     <strong>unsafe</strong>.      ,     crates.io        .</p><br>
<p>   API chmlib-sys   <code>cargo doc --open</code>,      ,   <strong><code>*mut ChmFile</code></strong>   .      .</p><br>
<div class="spoiler"><b class="spoiler_title">  CHMLib</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">/* $Id: chm_lib.h,v 1.10 2002/10/09 01:16:33 jedwin Exp $ */</span>
<span class="hljs-comment">/***************************************************************************
 *             chm_lib.h - CHM archive manipulation routines               *
 *                           -------------------                           *
 *                                                                         *
 *  author:     Jed Wing &lt;jedwin@ugcs.caltech.edu&gt;                         *
 *  version:    0.3                                                        *
 *  notes:      These routines are meant for the manipulation of microsoft *
 *              .chm (compiled html help) files, but may likely be used    *
 *              for the manipulation of any ITSS archive, if ever ITSS     *
 *              archives are used for any other purpose.                   *
 *                                                                         *
 *              Note also that the section names are statically handled.   *
 *              To be entirely correct, the section names should be read   *
 *              from the section names meta-file, and then the various     *
 *              content sections and the "transforms" to apply to the data *
 *              they contain should be inferred from the section name and  *
 *              the meta-files referenced using that name; however, all of *
 *              the files I've been able to get my hands on appear to have *
 *              only two sections: Uncompressed and MSCompressed.          *
 *              Additionally, the ITSS.DLL file included with Windows does *
 *              not appear to handle any different transforms than the     *
 *              simple LZX-transform.  Furthermore, the list of transforms *
 *              to apply is broken, in that only half the required space   *
 *              is allocated for the list.  (It appears as though the      *
 *              space is allocated for ASCII strings, but the strings are  *
 *              written as unicode.  As a result, only the first half of   *
 *              the string appears.)  So this is probably not too big of   *
 *              a deal, at least until CHM v4 (MS .lit files), which also  *
 *              incorporate encryption, of some description.               *
 ***************************************************************************/</span><font></font>
<font></font>
<span class="hljs-comment">/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU Lesser General Public License as        *
 *   published by the Free Software Foundation; either version 2.1 of the  *
 *   License, or (at your option) any later version.                       *
 *                                                                         *
 ***************************************************************************/</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> INCLUDED_CHMLIB_H</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INCLUDED_CHMLIB_H</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __cplusplus</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> {
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-comment">/* RWE 6/12/1002 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> PPC_BSTR</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;wtypes.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> WIN32</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __MINGW32__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __int64 long long</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> __int64 LONGUINT64;
<span class="hljs-keyword">typedef</span> __int64          LONGINT64;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span> LONGUINT64;
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">long</span> <span class="hljs-keyword">long</span>          LONGINT64;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-comment">/* the two available spaces in a CHM file                      */</span>
<span class="hljs-comment">/* N.B.: The format supports arbitrarily many spaces, but only */</span>
<span class="hljs-comment">/*       two appear to be used at present.                     */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_UNCOMPRESSED (0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_COMPRESSED   (1)</span><font></font>
<font></font>
<span class="hljs-comment">/* structure representing an ITS (CHM) file stream             */</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">chmFile</span>;</span><font></font>
<font></font>
<span class="hljs-comment">/* structure representing an element from an ITS file stream   */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_MAX_PATHLEN  (512)</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">chmUnitInfo</span>
{</span><font></font>
    LONGUINT64         start;<font></font>
    LONGUINT64         length;<font></font>
    <span class="hljs-keyword">int</span>                space;
    <span class="hljs-keyword">int</span>                flags;
    <span class="hljs-keyword">char</span>               path[CHM_MAX_PATHLEN+<span class="hljs-number">1</span>];<font></font>
};<font></font>
<font></font>
<span class="hljs-comment">/* open an ITS archive */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> PPC_BSTR</span>
<span class="hljs-comment">/* RWE 6/12/2003 */</span>
<span class="hljs-function">struct chmFile* <span class="hljs-title">chm_open</span><span class="hljs-params">(BSTR filename)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-function">struct chmFile* <span class="hljs-title">chm_open</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *filename)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-comment">/* close an ITS archive */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">chm_close</span><span class="hljs-params">(struct chmFile *h)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/* methods for ssetting tuning parameters for particular file */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_PARAM_MAX_BLOCKS_CACHED 0</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">chm_set_param</span><span class="hljs-params">(struct chmFile *h,
                   <span class="hljs-keyword">int</span> paramType,
                   <span class="hljs-keyword">int</span> paramVal)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/* resolve a particular object from the archive */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_RESOLVE_SUCCESS (0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_RESOLVE_FAILURE (1)</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">chm_resolve_object</span><span class="hljs-params">(struct chmFile *h,
                       <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *objPath,
                       struct chmUnitInfo *ui)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/* retrieve part of an object from the archive */</span>
<span class="hljs-function">LONGINT64 <span class="hljs-title">chm_retrieve_object</span><span class="hljs-params">(struct chmFile *h,
                              struct chmUnitInfo *ui,
                              <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *buf,
                              LONGUINT64 addr,
                              LONGINT64 len)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">/* enumerate the objects in the .chm archive */</span>
<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">int</span> <span class="hljs-params">(*CHM_ENUMERATOR)</span><span class="hljs-params">(struct chmFile *h,
                              struct chmUnitInfo *ui,
                              <span class="hljs-keyword">void</span> *context)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATE_NORMAL    (1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATE_META      (2)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATE_SPECIAL   (4)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATE_FILES     (8)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATE_DIRS      (16)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATE_ALL       (31)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATOR_FAILURE  (0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATOR_CONTINUE (1)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHM_ENUMERATOR_SUCCESS  (2)</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">chm_enumerate</span><span class="hljs-params">(struct chmFile *h,
                  <span class="hljs-keyword">int</span> what,
                  CHM_ENUMERATOR e,
                  <span class="hljs-keyword">void</span> *context)</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">chm_enumerate_dir</span><span class="hljs-params">(struct chmFile *h,
                      <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *prefix,
                      <span class="hljs-keyword">int</span> what,
                      CHM_ENUMERATOR e,
                      <span class="hljs-keyword">void</span> *context)</span></span>;<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __cplusplus</span><font></font>
}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* INCLUDED_CHMLIB_H */</span></span></code></pre></div></div><br>
<p>   ,     chm_open(),    â€” chm_close().</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">chm_open</span></span>(filename: *<span class="hljs-keyword">const</span> c_char) -&gt; *<span class="hljs-keyword">mut</span> chmFile;
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">chm_close</span></span>(h: *<span class="hljs-keyword">mut</span> chmFile);</code></pre><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> <strong>thiserror</strong></a>,    <code>std::error::Error</code>.</p><br>
<pre><code class="plaintext hljs">$ cd chmlib<font></font>
$ cargo add thiserror</code></pre><br>
<p>  ,   <code>std::path::Path</code>  <code>*const c_char</code>.  ,   -   - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-keyword">use</span> thiserror::Error;
<span class="hljs-keyword">use</span> std::{ffi::CString, path::Path};<font></font>
<font></font>
<span class="hljs-meta">#[cfg(unix)]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">path_to_cstring</span></span>(path: &amp;Path) -&gt; <span class="hljs-built_in">Result</span>&lt;CString, InvalidPath&gt; {
    <span class="hljs-keyword">use</span> std::os::unix::ffi::OsStrExt;
    <span class="hljs-keyword">let</span> bytes = path.as_os_str().as_bytes();<font></font>
    CString::new(bytes).map_err(|_| InvalidPath)<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">#[cfg(not(unix))]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">path_to_cstring</span></span>(path: &amp;Path) -&gt; <span class="hljs-built_in">Result</span>&lt;CString, InvalidPath&gt; {
    <span class="hljs-comment">//  ,  Windows CHMLib  CreateFileA(),  </span>
    <span class="hljs-comment">//       ASCII.   ...  </span>
    <span class="hljs-comment">// ,          ?</span>
    <span class="hljs-keyword">let</span> rust_str = path.as_os_str().as_str().ok_or(InvalidPath)?;<font></font>
    CString::new(rust_str).map_err(|_| InvalidPath)<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">#[derive(Error, Debug, Copy, Clone, PartialEq)]</span>
<span class="hljs-meta">#[error(<span class="hljs-meta-string">"Invalid Path"</span>)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">InvalidPath</span></span>;</code></pre><br>
<p>   <strong>ChmFile</strong>.      chmlib_sys::chmFile.  chm_open()   ,         - - .</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-keyword">use</span> std::{ffi::CString, path::Path, ptr::NonNull};<font></font>
<font></font>
<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ChmFile</span></span> {<font></font>
    raw: NonNull&lt;chmlib_sys::chmFile&gt;,<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">impl</span> ChmFile {
    <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">open</span></span>&lt;P: <span class="hljs-built_in">AsRef</span>&lt;Path&gt;&gt;(path: P) -&gt; <span class="hljs-built_in">Result</span>&lt;ChmFile, OpenError&gt; {
        <span class="hljs-keyword">let</span> c_path = path_to_cstring(path.as_ref())?;<font></font>
<font></font>
        <span class="hljs-comment">// ,   c_path </span>
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-keyword">let</span> raw = chmlib_sys::chm_open(c_path.as_ptr());<font></font>
<font></font>
            <span class="hljs-keyword">match</span> NonNull::new(raw) {
                <span class="hljs-literal">Some</span>(raw) =&gt; <span class="hljs-literal">Ok</span>(ChmFile { raw }),
                <span class="hljs-literal">None</span> =&gt; <span class="hljs-literal">Err</span>(OpenError::Other),<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">impl</span> <span class="hljs-built_in">Drop</span> <span class="hljs-keyword">for</span> ChmFile {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">drop</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">unsafe</span> {<font></font>
            chmlib_sys::chm_close(<span class="hljs-keyword">self</span>.raw.as_ptr());<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/// The error returned when we are unable to open a [`ChmFile`].</span>
<span class="hljs-meta">#[derive(Error, Debug, Copy, Clone, PartialEq)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">OpenError</span></span> {
    <span class="hljs-meta">#[error(<span class="hljs-meta-string">"Invalid path"</span>)]</span>
    InvalidPath(<span class="hljs-meta">#[from]</span> InvalidPath),
    <span class="hljs-meta">#[error(<span class="hljs-meta-string">"Unable to open the ChmFile"</span>)]</span><font></font>
    Other,<font></font>
}</code></pre><br>
<p>     ,     <strong>Valgrind</strong>.   ChmFile     .</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-meta">#[test]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">open_valid_chm_file</span></span>() {
    <span class="hljs-keyword">let</span> sample = sample_path();<font></font>
<font></font>
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">let</span> chm_file = ChmFile::open(&amp;sample).unwrap();
    <span class="hljs-comment">//     </span>
    <span class="hljs-built_in">drop</span>(chm_file);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">sample_path</span></span>() -&gt; PathBuf {
    <span class="hljs-keyword">let</span> project_dir = Path::new(<span class="hljs-built_in">env!</span>(<span class="hljs-string">"CARGO_MANIFEST_DIR"</span>));
    <span class="hljs-keyword">let</span> sample = project_dir.parent().unwrap().join(<span class="hljs-string">"topics.classic.chm"</span>);
    <span class="hljs-built_in">assert!</span>(sample.exists());<font></font>
<font></font>
    sample<font></font>
}</code></pre><br>
<p>Valgrind ,     :</p><br>
<pre><code class="plaintext hljs">$ valgrind ../target/debug/deps/chmlib-8d8c740d578324 open_valid_chm_file<font></font>
==8953== Memcheck, a memory error detector<font></font>
==8953== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.<font></font>
==8953== Using Valgrind-3.14.0 and LibVEX; rerun with -h for copyright info<font></font>
==8953== Command: ~/chmlib/target/debug/deps/chmlib-8d8c740d578324 open_valid_chm_file<font></font>
==8953==<font></font>
<font></font>
running 1 test<font></font>
test tests::open_valid_chm_file ... ok<font></font>
<font></font>
test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out<font></font>
<font></font>
==8953==<font></font>
==8953== HEAP SUMMARY:<font></font>
==8953==     in use at exit: 0 bytes in 0 blocks<font></font>
==8953==   total heap usage: 249 allocs, 249 frees, 43,273 bytes allocated<font></font>
==8953==<font></font>
==8953== All heap blocks were freed -- no leaks are possible<font></font>
==8953==<font></font>
==8953== For counts of detected and suppressed errors, rerun with: -v<font></font>
==8953== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)</code></pre><br>
<h3 id="poisk-elementov-po-imeni">   </h3><br>
<p>   chm_resolve_object():</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> CHM_RESOLVE_SUCCESS: <span class="hljs-built_in">u32</span> = <span class="hljs-number">0</span>;
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">const</span> CHM_RESOLVE_FAILURE: <span class="hljs-built_in">u32</span> = <span class="hljs-number">1</span>;
<span class="hljs-comment">/* resolve a particular object from the archive */</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">chm_resolve_object</span></span>(<font></font>
    h: *<span class="hljs-keyword">mut</span> chmFile,<font></font>
    objPath: *<span class="hljs-keyword">const</span> c_char,<font></font>
    ui: *<span class="hljs-keyword">mut</span> chmUnitInfo<font></font>
) -&gt; c_int;</code></pre><br>
<p>   ,  chm_resolve_object()   ,     ,            <strong>chmUnitInfo</strong>.</p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>std::mem::MaybeUninit</code></a>        out- <strong>ui</strong>.</p><br>
<p>    UnitInfo  â€”  Rust- C- chmUnitInfo.   ,   -   ChmFile.</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-keyword">impl</span> ChmFile {<font></font>
    ...<font></font>
<font></font>
    <span class="hljs-comment">/// Find a particular object in the archive.</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">find</span></span>&lt;P: <span class="hljs-built_in">AsRef</span>&lt;Path&gt;&gt;(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, path: P) -&gt; <span class="hljs-built_in">Option</span>&lt;UnitInfo&gt; {
        <span class="hljs-keyword">let</span> path = path_to_cstring(path.as_ref()).ok()?;<font></font>
<font></font>
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-comment">//   chmUnitInfo  </span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> resolved = MaybeUninit::&lt;chmlib_sys::chmUnitInfo&gt;::uninit();<font></font>
<font></font>
            <span class="hljs-comment">//  - </span>
            <span class="hljs-keyword">let</span> ret = chmlib_sys::chm_resolve_object(
                <span class="hljs-keyword">self</span>.raw.as_ptr(),<font></font>
                path.as_ptr(),<font></font>
                resolved.as_mut_ptr(),<font></font>
            );<font></font>
<font></font>
            <span class="hljs-keyword">if</span> ret == chmlib_sys::CHM_RESOLVE_SUCCESS {
                <span class="hljs-comment">//    "resolved"  </span>
                <span class="hljs-literal">Some</span>(UnitInfo::from_raw(resolved.assume_init()))<font></font>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-literal">None</span><font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">UnitInfo</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">impl</span> UnitInfo {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">from_raw</span></span>(ui: chmlib_sys::chmUnitInfo) -&gt; UnitInfo { UnitInfo }<font></font>
}</code></pre><br>
<blockquote>,  ChmFile::find()  <strong><code>&amp;mut self</code></strong>,         .   ,       fseek()    ,        .</blockquote><p> ChmFile::find()   ,    :</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-meta">#[test]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">find_an_item_in_the_sample</span></span>() {
    <span class="hljs-keyword">let</span> sample = sample_path();
    <span class="hljs-keyword">let</span> chm = ChmFile::open(&amp;sample).unwrap();<font></font>
<font></font>
    <span class="hljs-built_in">assert!</span>(chm.find(<span class="hljs-string">"/BrowserView.html"</span>).is_some());
    <span class="hljs-built_in">assert!</span>(chm.find(<span class="hljs-string">"doesn't exist.txt"</span>).is_none());<font></font>
}</code></pre><br>
<h3 id="obhod-elementov-po-filtru">   </h3><br>
<p>CHMLib  API    CHM-     .</p><br>
<p>   bitflags      :</p><br>
<pre><code class="plaintext hljs">$ cargo add bitflags<font></font>
    Updating 'https://github.com/rust-lang/crates.io-index' index<font></font>
      Adding bitflags v1.2.1 to dependencies</code></pre><br>
<p>   <strong>Filter</strong>     chm_lib.h:</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
bitflags::<span class="hljs-built_in">bitflags!</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Filter</span></span>: c_int {
        <span class="hljs-comment">/// A normal file.</span>
        <span class="hljs-keyword">const</span> NORMAL = chmlib_sys::CHM_ENUMERATE_NORMAL <span class="hljs-keyword">as</span> c_int;
        <span class="hljs-comment">/// A meta file (typically used by the CHM system).</span>
        <span class="hljs-keyword">const</span> META = chmlib_sys::CHM_ENUMERATE_META <span class="hljs-keyword">as</span> c_int;
        <span class="hljs-comment">/// A special file (starts with `#` or `$`).</span>
        <span class="hljs-keyword">const</span> SPECIAL = chmlib_sys::CHM_ENUMERATE_SPECIAL <span class="hljs-keyword">as</span> c_int;
        <span class="hljs-comment">/// It's a file.</span>
        <span class="hljs-keyword">const</span> FILES = chmlib_sys::CHM_ENUMERATE_FILES <span class="hljs-keyword">as</span> c_int;
        <span class="hljs-comment">/// It's a directory.</span>
        <span class="hljs-keyword">const</span> DIRS = chmlib_sys::CHM_ENUMERATE_DIRS <span class="hljs-keyword">as</span> c_int;<font></font>
    }<font></font>
}</code></pre><br>
<p>   <code>extern "C"</code>-   ,          :</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">function_wrapper</span></span>&lt;F&gt;(<font></font>
    file: *<span class="hljs-keyword">mut</span> chmlib_sys::chmFile,<font></font>
    unit: *<span class="hljs-keyword">mut</span> chmlib_sys::chmUnitInfo,<font></font>
    state: *<span class="hljs-keyword">mut</span> c_void,<font></font>
) -&gt; c_int<font></font>
<span class="hljs-keyword">where</span>
    F: <span class="hljs-built_in">FnMut</span>(&amp;<span class="hljs-keyword">mut</span> ChmFile, UnitInfo) -&gt; Continuation,<font></font>
{<font></font>
    <span class="hljs-comment">//      FFI-</span>
    <span class="hljs-keyword">let</span> result = panic::catch_unwind(|| {
        <span class="hljs-comment">//   ManuallyDrop    `&amp;mut ChmFile`</span>
        <span class="hljs-comment">//        ( double-free).</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> file = ManuallyDrop::new(ChmFile {<font></font>
            raw: NonNull::new_unchecked(file),<font></font>
        });<font></font>
        <span class="hljs-keyword">let</span> unit = UnitInfo::from_raw(unit.read());
        <span class="hljs-comment">//  state     </span>
        <span class="hljs-keyword">let</span> closure = &amp;<span class="hljs-keyword">mut</span> *(state <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> F);<font></font>
        closure(&amp;<span class="hljs-keyword">mut</span> file, unit)<font></font>
    });<font></font>
<font></font>
    <span class="hljs-keyword">match</span> result {
        <span class="hljs-literal">Ok</span>(Continuation::Continue) =&gt; {<font></font>
            chmlib_sys::CHM_ENUMERATOR_CONTINUE <span class="hljs-keyword">as</span> c_int<font></font>
        },<font></font>
        <span class="hljs-literal">Ok</span>(Continuation::Stop) =&gt; chmlib_sys::CHM_ENUMERATOR_SUCCESS <span class="hljs-keyword">as</span> c_int,
        <span class="hljs-literal">Err</span>(_) =&gt; chmlib_sys::CHM_ENUMERATOR_FAILURE <span class="hljs-keyword">as</span> c_int,<font></font>
    }<font></font>
}</code></pre><br>
<blockquote><code>function_wrapper</code>   unsafe-,    :<br>
<br>
<ul>
<li> <code>state</code> <strong></strong>     F.</li>
<li>  ,  ,   .         ,        â€”   .       <code>std::panic::catch_unwind()</code>.</li>
<li>  chmlib_sys::chmFile,   function_wrapper,     ChmFile.     ,      chmlib_sys::chmFile,     .</li>
<li>   <code>&amp;mut ChmFile</code>,         ,   . ,      ChmFile,  chmlib_sys::chmFile    .      <code>std::mem::ManuallyDrop</code>.</li>
</ul><br>
</blockquote><p>  function_wrapper    <code>ChmFile::for_each()</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-keyword">impl</span> ChmFile {<font></font>
    ...<font></font>
<font></font>
    <span class="hljs-comment">/// Inspect each item within the [`ChmFile`].</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">for_each</span></span>&lt;F&gt;(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, filter: Filter, <span class="hljs-keyword">mut</span> cb: F)
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-built_in">FnMut</span>(&amp;<span class="hljs-keyword">mut</span> ChmFile, UnitInfo) -&gt; Continuation,<font></font>
    {<font></font>
        <span class="hljs-keyword">unsafe</span> {<font></font>
            chmlib_sys::chm_enumerate(<font></font>
                <span class="hljs-keyword">self</span>.raw.as_ptr(),<font></font>
                filter.bits(),<font></font>
                <span class="hljs-literal">Some</span>(function_wrapper::&lt;F&gt;),<font></font>
                &amp;<span class="hljs-keyword">mut</span> cb <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _ <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> c_void,<font></font>
            );<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/// Inspect each item within the [`ChmFile`] inside a specified directory.</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">for_each_item_in_dir</span></span>&lt;F, P&gt;(<font></font>
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>,<font></font>
        filter: Filter,<font></font>
        prefix: P,<font></font>
        <span class="hljs-keyword">mut</span> cb: F,<font></font>
    ) <span class="hljs-keyword">where</span>
        P: <span class="hljs-built_in">AsRef</span>&lt;Path&gt;,<font></font>
        F: <span class="hljs-built_in">FnMut</span>(&amp;<span class="hljs-keyword">mut</span> ChmFile, UnitInfo) -&gt; Continuation,<font></font>
    {<font></font>
        <span class="hljs-keyword">let</span> path = <span class="hljs-keyword">match</span> path_to_cstring(prefix.as_ref()) {
            <span class="hljs-literal">Ok</span>(p) =&gt; p,
            <span class="hljs-literal">Err</span>(_) =&gt; <span class="hljs-keyword">return</span>,<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">unsafe</span> {<font></font>
            chmlib_sys::chm_enumerate_dir(<font></font>
                <span class="hljs-keyword">self</span>.raw.as_ptr(),<font></font>
                path.as_ptr(),<font></font>
                filter.bits(),<font></font>
                <span class="hljs-literal">Some</span>(function_wrapper::&lt;F&gt;),<font></font>
                &amp;<span class="hljs-keyword">mut</span> cb <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _ <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> c_void,<font></font>
            );<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
<blockquote>   ,   F     function_wrapper.    ,     Rust  FFI     .</blockquote><br>
<h3 id="chtenie-soderzhimogo-faylov">  </h3><br>
<p> ,   ,        chm_retrieve_object().</p><br>
<p>   .      std::io::Read,      .</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-keyword">impl</span> ChmFile {<font></font>
    ...<font></font>
<font></font>
    <span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">read</span></span>(<font></font>
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>,<font></font>
        unit: &amp;UnitInfo,<font></font>
        offset: <span class="hljs-built_in">u64</span>,<font></font>
        buffer: &amp;<span class="hljs-keyword">mut</span> [<span class="hljs-built_in">u8</span>],<font></font>
    ) -&gt; <span class="hljs-built_in">Result</span>&lt;<span class="hljs-built_in">usize</span>, ReadError&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> unit = unit.<span class="hljs-number">0</span>.clone();<font></font>
<font></font>
        <span class="hljs-keyword">let</span> bytes_written = <span class="hljs-keyword">unsafe</span> {<font></font>
            chmlib_sys::chm_retrieve_object(<font></font>
                <span class="hljs-keyword">self</span>.raw.as_ptr(),<font></font>
                &amp;<span class="hljs-keyword">mut</span> unit,<font></font>
                buffer.as_mut_ptr(),<font></font>
                offset,<font></font>
                buffer.len() <span class="hljs-keyword">as</span> _,<font></font>
            )<font></font>
        };<font></font>
<font></font>
        <span class="hljs-keyword">if</span> bytes_written &gt;= <span class="hljs-number">0</span> {
            <span class="hljs-literal">Ok</span>(bytes_written <span class="hljs-keyword">as</span> <span class="hljs-built_in">usize</span>)<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-literal">Err</span>(ReadError)<font></font>
        }<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-meta">#[derive(Error, Debug, Copy, Clone, PartialEq)]</span>
<span class="hljs-meta">#[error(<span class="hljs-meta-string">"The read failed"</span>)]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ReadError</span></span>;</code></pre><br>
<p>,         ,  Â«  Â»,     , chm_retrieve_object()    :</p><br>
<ul>
<li> 0,     ;</li>
<li> 0   :      ;</li>
<li> âˆ’1      (  errno);</li>
<li> âˆ’1   ,     , ,        malloc().</li>
</ul><br>
<p> ChmFile::read()       :</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/src/lib.rs</span><font></font>
<font></font>
<span class="hljs-meta">#[test]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">read_an_item</span></span>() {
    <span class="hljs-keyword">let</span> sample = sample_path();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> chm = ChmFile::open(&amp;sample).unwrap();
    <span class="hljs-keyword">let</span> filename = <span class="hljs-string">"/template/packages/core-web/css/index.responsive.css"</span>;<font></font>
<font></font>
    <span class="hljs-comment">//       </span>
    <span class="hljs-keyword">let</span> item = chm.find(filename).unwrap();<font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> buffer = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; item.length() <span class="hljs-keyword">as</span> <span class="hljs-built_in">usize</span>];
    <span class="hljs-keyword">let</span> bytes_written = chm.read(&amp;item, <span class="hljs-number">0</span>, &amp;<span class="hljs-keyword">mut</span> buffer).unwrap();<font></font>
<font></font>
    <span class="hljs-comment">//     </span>
    <span class="hljs-built_in">assert_eq!</span>(bytes_written, item.length() <span class="hljs-keyword">as</span> <span class="hljs-built_in">usize</span>);<font></font>
<font></font>
    <span class="hljs-comment">// ...  ,   </span>
    <span class="hljs-keyword">let</span> got = <span class="hljs-built_in">String</span>::from_utf8(buffer).unwrap();
    <span class="hljs-built_in">assert!</span>(got.starts_with(
        <span class="hljs-string">"html, body, div#i-index-container, div#i-index-body"</span><font></font>
    ));<font></font>
}</code></pre><br>
<h2 id="dobavlyaem-primery"> </h2><br>
<p>    API  CHMLib       ,    . ,           .        â€”  ,    Rust  Go       ( ,  <em>rustdoc</em>  <em>godoc</em>     ).</p><br>
<p> ,  CHMLib    ,        .</p><br>
<p>      , ,         .</p><br>
<h3 id="oglavlenie-chm-fayla"> CHM-</h3><br>
<p>   CHM-         .</p><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">/* $Id: enum_chmLib.c,v 1.7 2002/10/09 12:38:12 jedwin Exp $ */</span>
<span class="hljs-comment">/***************************************************************************
 *          enum_chmLib.c - CHM archive test driver                        *
 *                           -------------------                           *
 *                                                                         *
 *  author:     Jed Wing &lt;jedwin@ugcs.caltech.edu&gt;                         *
 *  notes:      This is a quick-and-dirty test driver for the chm lib      *
 *              routines.  The program takes as its input the paths to one *
 *              or more .chm files.  It attempts to open each .chm file in *
 *              turn, and display a listing of all of the files in the     *
 *              archive.                                                   *
 *                                                                         *
 *              It is not included as a particularly useful program, but   *
 *              rather as a sort of "simplest possible" example of how to  *
 *              use the enumerate portion of the API.                      *
 ***************************************************************************/</span><font></font>
<font></font>
<span class="hljs-comment">/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU Lesser General Public License as        *
 *   published by the Free Software Foundation; either version 2.1 of the  *
 *   License, or (at your option) any later version.                       *
 *                                                                         *
 ***************************************************************************/</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"chm_lib.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">/*
 * callback function for enumerate API
 */</span>
<span class="hljs-keyword">int</span> _print_ui(struct chmFile *h,<font></font>
              struct chmUnitInfo *ui,<font></font>
              <span class="hljs-keyword">void</span> *context)<font></font>
{<font></font>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> szBuf[<span class="hljs-number">128</span>];
    <span class="hljs-built_in">memset</span>(szBuf, <span class="hljs-number">0</span>, <span class="hljs-number">128</span>);
    <span class="hljs-keyword">if</span>(ui-&gt;flags &amp; CHM_ENUMERATE_NORMAL)
        <span class="hljs-built_in">strcpy</span>(szBuf, <span class="hljs-string">"normal "</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ui-&gt;flags &amp; CHM_ENUMERATE_SPECIAL)
        <span class="hljs-built_in">strcpy</span>(szBuf, <span class="hljs-string">"special "</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ui-&gt;flags &amp; CHM_ENUMERATE_META)
        <span class="hljs-built_in">strcpy</span>(szBuf, <span class="hljs-string">"meta "</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(ui-&gt;flags &amp; CHM_ENUMERATE_DIRS)
        <span class="hljs-built_in">strcat</span>(szBuf, <span class="hljs-string">"dir"</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ui-&gt;flags &amp; CHM_ENUMERATE_FILES)
        <span class="hljs-built_in">strcat</span>(szBuf, <span class="hljs-string">"file"</span>);<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"   %1d %8d %8d   %s\t\t%s\n"</span>,<font></font>
           (<span class="hljs-keyword">int</span>)ui-&gt;space,<font></font>
           (<span class="hljs-keyword">int</span>)ui-&gt;start,<font></font>
           (<span class="hljs-keyword">int</span>)ui-&gt;length,<font></font>
           szBuf,<font></font>
           ui-&gt;path);<font></font>
    <span class="hljs-keyword">return</span> CHM_ENUMERATOR_CONTINUE;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> c, <span class="hljs-keyword">char</span> **v)</span>
</span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">chmFile</span> *<span class="hljs-title">h</span>;</span>
    <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">1</span>; i&lt;c; i++)<font></font>
    {<font></font>
        h = chm_open(v[i]);<font></font>
        <span class="hljs-keyword">if</span> (h == <span class="hljs-literal">NULL</span>)<font></font>
        {<font></font>
            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"failed to open %s\n"</span>, v[i]);
            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s:\n"</span>, v[i]);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">" spc    start   length   type\t\t\tname\n"</span>);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">" ===    =====   ======   ====\t\t\t====\n"</span>);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (! chm_enumerate(h,<font></font>
                            CHM_ENUMERATE_ALL,<font></font>
                            _print_ui,<font></font>
                            <span class="hljs-literal">NULL</span>))
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"   *** ERROR ***\n"</span>);<font></font>
<font></font>
        chm_close(h);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre></div></div><br>
<p> _print_ui()    Rust.         UnitInfo  ,      ,     .</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/examples/enumerate-items.rs</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">describe_item</span></span>(item: UnitInfo) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> description = <span class="hljs-built_in">String</span>::new();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> item.is_normal() {<font></font>
        description.push_str(<span class="hljs-string">"normal "</span>);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> item.is_special() {<font></font>
        description.push_str(<span class="hljs-string">"special "</span>);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> item.is_meta() {<font></font>
        description.push_str(<span class="hljs-string">"meta "</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> item.is_dir() {<font></font>
        description.push_str(<span class="hljs-string">"dir"</span>);<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> item.is_file() {<font></font>
        description.push_str(<span class="hljs-string">"file"</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">println!</span>(
        <span class="hljs-string">"   {} {:8} {:8}   {}\t\t{}"</span>,<font></font>
        item.space(),<font></font>
        item.start(),<font></font>
        item.length(),<font></font>
        description,<font></font>
        item.path().unwrap_or(Path::new(<span class="hljs-string">""</span>)).display()<font></font>
    );<font></font>
}</code></pre><br>
<p> main()       ,  ,   describe_item()  ChmFile::for_each().</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/examples/enumerate-items.rs</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> filename = env::args()<font></font>
        .nth(<span class="hljs-number">1</span>)<font></font>
        .unwrap_or_else(|| <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"Usage: enumerate-items &lt;filename&gt;"</span>));<font></font>
<font></font>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> file = ChmFile::open(&amp;filename).expect(<span class="hljs-string">"Unable to open the file"</span>);<font></font>
<font></font>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}:"</span>, filename);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">" spc    start   length   type\t\t\tname"</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">" ===    =====   ======   ====\t\t\t===="</span>);<font></font>
<font></font>
    file.for_each(Filter::all(), |_file, item| {<font></font>
        describe_item(item);<font></font>
        Continuation::Continue<font></font>
    });<font></font>
}</code></pre><br>
<p>         :</p><br>
<pre><code class="plaintext hljs">$ cargo run --example enumerate-items topics.classic.chm &gt; rust-example.txt<font></font>
$ cd vendor/CHMLib/src<font></font>
$ clang chm_lib.c enum_chmLib.c lzx.c -o enum_chmLib<font></font>
$ cd ../../..<font></font>
$ ./vendor/CHMLib/src/enum_chmLib topics.classic.chm &gt; c-example.txt<font></font>
$ diff -u rust-example.txt c-example.txt<font></font>
$ echo $?<font></font>
0</code></pre><br>
<p>diff ,   ,   ,     ,    .    -   ,     diff.</p><br>
<pre><code class="diff hljs">diff --git a/chmlib/examples/enumerate-items.rs b/chmlib/examples/enumerate-items.rs<font></font>
index e68fa58..ef855ac 100644<font></font>
<span class="hljs-comment">--- a/chmlib/examples/enumerate-items.rs</span>
<span class="hljs-comment">+++ b/chmlib/examples/enumerate-items.rs</span><font></font>
@@ -36,6 +36,10 @@ fn describe_item(item: UnitInfo) {<font></font>
         description.push_str("file");<font></font>
     }<font></font>
<font></font>
<span class="hljs-addition">+    if item.length() % 7 == 0 {</span>
<span class="hljs-addition">+        description.push_str(" :)");</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+</span><font></font>
     println!(<font></font>
         "   {} {:8} {:8}   {}\t\t{}",<font></font>
         item.space(),</code></pre><br>
<p>    :</p><br>
<pre><code class="diff hljs">$ cargo run --example enumerate-items topics.classic.chm &gt; rust-example.txt<font></font>
$ diff -u rust-example.txt c-example.txt<font></font>
<span class="hljs-comment">--- rust-example.txt    2019-10-20 16:51:53.933560892 +0800</span>
<span class="hljs-comment">+++ c-example.txt       2019-10-20 16:40:42.007053966 +0800</span>
<span class="hljs-meta">@@ -1,9 +1,9 @@</span><font></font>
 topics.classic.chm:<font></font>
  spc    start   length   type            name<font></font>
  <span class="hljs-comment">===    =====   ======   ====            ====</span>
<span class="hljs-deletion">-   0        0        0   normal dir :)       /</span>
<span class="hljs-addition">+   0        0        0   normal dir          /</span><font></font>
    1  5125797     4096   special file        /#IDXHDR<font></font>
<span class="hljs-deletion">-   0        0        0   special file :)     /#ITBITS</span>
<span class="hljs-addition">+   0        0        0   special file        /#ITBITS</span><font></font>
    1  5104520      148   special file        /#IVB<font></font>
    1  5132009     1227   special file        /#STRINGS<font></font>
    0     1430     4283   special file        /#SYSTEM<font></font>
<span class="hljs-meta">@@ -13,9 +13,9 @@</span>
...</code></pre><br>
<p>!</p><br>
<h3 id="raspakovka-chm-fayla-na-disk"> CHM-  </h3><br>
<p> ,     CHMLib,   Â«Â»   .</p><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment">/* $Id: extract_chmLib.c,v 1.4 2002/10/10 03:24:51 jedwin Exp $ */</span>
<span class="hljs-comment">/***************************************************************************
 *          extract_chmLib.c - CHM archive extractor                       *
 *                           -------------------                           *
 *                                                                         *
 *  author:     Jed Wing &lt;jedwin@ugcs.caltech.edu&gt;                         *
 *  notes:      This is a quick-and-dirty chm archive extractor.           *
 ***************************************************************************/</span><font></font>
<font></font>
<span class="hljs-comment">/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU Lesser General Public License as        *
 *   published by the Free Software Foundation; either version 2.1 of the  *
 *   License, or (at your option) any later version.                       *
 *                                                                         *
 ***************************************************************************/</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"chm_lib.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> WIN32</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;direct.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> mkdir(X, Y) _mkdir(X)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> snprintf _snprintf</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">extract_context</span>
{</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *base_path;<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">dir_exists</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *path)</span>
</span>{
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> WIN32</span>
        <span class="hljs-comment">/* why doesn't this work?!? */</span><font></font>
        HANDLE hFile;<font></font>
<font></font>
        hFile = CreateFileA(path,<font></font>
                        FILE_LIST_DIRECTORY,<font></font>
                        <span class="hljs-number">0</span>,
                        <span class="hljs-literal">NULL</span>,<font></font>
                        OPEN_EXISTING,<font></font>
                        FILE_ATTRIBUTE_NORMAL,<font></font>
                        <span class="hljs-literal">NULL</span>);
        <span class="hljs-keyword">if</span> (hFile != INVALID_HANDLE_VALUE)<font></font>
        {<font></font>
        CloseHandle(hFile);<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">statbuf</span>;</span>
        <span class="hljs-keyword">if</span> (stat(path, &amp;statbuf) != <span class="hljs-number">-1</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rmkdir</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *path)</span>
</span>{
    <span class="hljs-comment">/*
     * strip off trailing components unless we can stat the directory, or we
     * have run out of components
     */</span><font></font>
<font></font>
    <span class="hljs-keyword">char</span> *i = <span class="hljs-built_in">strrchr</span>(path, <span class="hljs-string">'/'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(path[<span class="hljs-number">0</span>] == <span class="hljs-string">'\0'</span>  ||  dir_exists(path))
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (i != <span class="hljs-literal">NULL</span>)<font></font>
    {<font></font>
        *i = <span class="hljs-string">'\0'</span>;<font></font>
        rmkdir(path);<font></font>
        *i = <span class="hljs-string">'/'</span>;<font></font>
        mkdir(path, <span class="hljs-number">0777</span>);<font></font>
    }<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> WIN32</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    <span class="hljs-keyword">if</span> (dir_exists(path))
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*
 * callback function for enumerate API
 */</span>
<span class="hljs-keyword">int</span> _extract_callback(struct chmFile *h,<font></font>
              struct chmUnitInfo *ui,<font></font>
              <span class="hljs-keyword">void</span> *context)<font></font>
{<font></font>
    LONGUINT64 ui_path_len;<font></font>
    <span class="hljs-keyword">char</span> buffer[<span class="hljs-number">32768</span>];
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">extract_context</span> *<span class="hljs-title">ctx</span> = (<span class="hljs-title">struct</span> <span class="hljs-title">extract_context</span> *)<span class="hljs-title">context</span>;</span>
    <span class="hljs-keyword">char</span> *i;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (ui-&gt;path[<span class="hljs-number">0</span>] != <span class="hljs-string">'/'</span>)
        <span class="hljs-keyword">return</span> CHM_ENUMERATOR_CONTINUE;<font></font>
<font></font>
    <span class="hljs-comment">/* quick hack for security hole mentioned by Sven Tantau */</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(ui-&gt;path, <span class="hljs-string">"/../"</span>) != <span class="hljs-literal">NULL</span>)<font></font>
    {<font></font>
        <span class="hljs-comment">/* fprintf(stderr, "Not extracting %s (dangerous path)\n", ui-&gt;path); */</span>
        <span class="hljs-keyword">return</span> CHM_ENUMERATOR_CONTINUE;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">snprintf</span>(buffer, <span class="hljs-keyword">sizeof</span>(buffer), <span class="hljs-string">"%s%s"</span>, ctx-&gt;base_path, ui-&gt;path) &gt; <span class="hljs-number">1024</span>)
        <span class="hljs-keyword">return</span> CHM_ENUMERATOR_FAILURE;<font></font>
<font></font>
    <span class="hljs-comment">/* Get the length of the path */</span>
    ui_path_len = <span class="hljs-built_in">strlen</span>(ui-&gt;path)<span class="hljs-number">-1</span>;<font></font>
<font></font>
    <span class="hljs-comment">/* Distinguish between files and dirs */</span>
    <span class="hljs-keyword">if</span> (ui-&gt;path[ui_path_len] != <span class="hljs-string">'/'</span> )<font></font>
    {<font></font>
        FILE *fout;<font></font>
        LONGINT64 len, remain=ui-&gt;length;<font></font>
        LONGUINT64 offset = <span class="hljs-number">0</span>;<font></font>
<font></font>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"--&gt; %s\n"</span>, ui-&gt;path);
        <span class="hljs-keyword">if</span> ((fout = fopen(buffer, <span class="hljs-string">"wb"</span>)) == <span class="hljs-literal">NULL</span>)<font></font>
    {<font></font>
        <span class="hljs-comment">/* make sure that it isn't just a missing directory before we abort */</span>
        <span class="hljs-keyword">char</span> newbuf[<span class="hljs-number">32768</span>];
        <span class="hljs-built_in">strcpy</span>(newbuf, buffer);<font></font>
        i = <span class="hljs-built_in">strrchr</span>(newbuf, <span class="hljs-string">'/'</span>);<font></font>
        *i = <span class="hljs-string">'\0'</span>;<font></font>
        rmkdir(newbuf);<font></font>
        <span class="hljs-keyword">if</span> ((fout = fopen(buffer, <span class="hljs-string">"wb"</span>)) == <span class="hljs-literal">NULL</span>)
              <span class="hljs-keyword">return</span> CHM_ENUMERATOR_FAILURE;<font></font>
    }<font></font>
<font></font>
        <span class="hljs-keyword">while</span> (remain != <span class="hljs-number">0</span>)<font></font>
        {<font></font>
            len = chm_retrieve_object(h, ui, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *)buffer, offset, <span class="hljs-number">32768</span>);
            <span class="hljs-keyword">if</span> (len &gt; <span class="hljs-number">0</span>)<font></font>
            {<font></font>
                fwrite(buffer, <span class="hljs-number">1</span>, (<span class="hljs-keyword">size_t</span>)len, fout);<font></font>
                offset += len;<font></font>
                remain -= len;<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span><font></font>
            {<font></font>
                <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"incomplete file: %s\n"</span>, ui-&gt;path);
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        fclose(fout);<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (rmkdir(buffer) == <span class="hljs-number">-1</span>)
            <span class="hljs-keyword">return</span> CHM_ENUMERATOR_FAILURE;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> CHM_ENUMERATOR_CONTINUE;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> c, <span class="hljs-keyword">char</span> **v)</span>
</span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">chmFile</span> *<span class="hljs-title">h</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">extract_context</span> <span class="hljs-title">ec</span>;</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">3</span>)<font></font>
    {<font></font>
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"usage: %s &lt;chmfile&gt; &lt;outdir&gt;\n"</span>, v[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    h = chm_open(v[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">if</span> (h == <span class="hljs-literal">NULL</span>)<font></font>
    {<font></font>
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"failed to open %s\n"</span>, v[<span class="hljs-number">1</span>]);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s:\n"</span>, v[<span class="hljs-number">1</span>]);<font></font>
    ec.base_path = v[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">if</span> (! chm_enumerate(h,<font></font>
                        CHM_ENUMERATE_ALL,<font></font>
                        _extract_callback,<font></font>
                        (<span class="hljs-keyword">void</span> *)&amp;ec))
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"   *** ERROR ***\n"</span>);<font></font>
<font></font>
    chm_close(h);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre></div></div><br>
<p>              . ,     .</p><br>
<p>    extract().    ,              .</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/examples/extract.rs</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">extract</span></span>(<font></font>
    root_dir: &amp;Path,<font></font>
    file: &amp;<span class="hljs-keyword">mut</span> ChmFile,<font></font>
    item: &amp;UnitInfo,<font></font>
) -&gt; <span class="hljs-built_in">Result</span>&lt;(), <span class="hljs-built_in">Box</span>&lt;<span class="hljs-keyword">dyn</span> Error&gt;&gt; {
    <span class="hljs-keyword">if</span> !item.is_file() || !item.is_normal() {
        <span class="hljs-comment">//     </span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(());<font></font>
    }<font></font>
    <span class="hljs-keyword">let</span> path = <span class="hljs-keyword">match</span> item.path() {
        <span class="hljs-literal">Some</span>(p) =&gt; p,
        <span class="hljs-comment">//     ,  </span>
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">Ok</span>(()),<font></font>
    };<font></font>
<font></font>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> dest = root_dir.to_path_buf();
    <span class="hljs-comment">// :  CHM       (  "/"),</span>
    <span class="hljs-comment">//     root_dir     "/".</span>
    dest.extend(path.components().skip(<span class="hljs-number">1</span>));<font></font>
<font></font>
    <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(parent) = dest.parent() {<font></font>
        fs::create_dir_all(parent)?;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> f = File::create(dest)?;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> start_offset = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// CHMLib      &amp;[u8]    (,</span>
    <span class="hljs-comment">//      ),      </span>
    <span class="hljs-comment">//     </span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> buffer = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0</span>; <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>];<font></font>
<font></font>
    <span class="hljs-keyword">loop</span> {
        <span class="hljs-keyword">let</span> bytes_read = file.read(item, start_offset, &amp;<span class="hljs-keyword">mut</span> buffer)?;
        <span class="hljs-keyword">if</span> bytes_read == <span class="hljs-number">0</span> {
            <span class="hljs-comment">//    </span>
            <span class="hljs-keyword">break</span>;<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//     </span>
            start_offset += bytes_read <span class="hljs-keyword">as</span> <span class="hljs-built_in">u64</span>;<font></font>
            f.write_all(&amp;buffer)?;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-literal">Ok</span>(())<font></font>
}</code></pre><br>
<p> main()  ,  extract(),         .</p><br>
<pre><code class="rust hljs"><span class="hljs-comment">// chmlib/examples/extract.rs</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> args: <span class="hljs-built_in">Vec</span>&lt;_&gt; = env::args().skip(<span class="hljs-number">1</span>).collect();
    <span class="hljs-keyword">if</span> args.len() != <span class="hljs-number">2</span> || args.iter().any(|arg| arg.contains(<span class="hljs-string">"-h"</span>)) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Usage: extract &lt;chm-file&gt; &lt;out-dir&gt;"</span>);
        <span class="hljs-keyword">return</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> file = ChmFile::open(&amp;args[<span class="hljs-number">0</span>]).expect(<span class="hljs-string">"Unable to open the file"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">let</span> out_dir = PathBuf::from(&amp;args[<span class="hljs-number">1</span>]);<font></font>
<font></font>
    file.for_each(Filter::all(), |file, item| {<font></font>
        <span class="hljs-keyword">match</span> extract(&amp;out_dir, file, &amp;item) {
            <span class="hljs-literal">Ok</span>(_) =&gt; Continuation::Continue,
            <span class="hljs-literal">Err</span>(e) =&gt; {<font></font>
                eprintln!(<span class="hljs-string">"Error: {}"</span>, e);<font></font>
                Continuation::Stop<font></font>
            },<font></font>
        }<font></font>
    });<font></font>
}</code></pre><br>
<p>     CHM-    HTML-,      -.</p><br>
<pre><code class="plaintext hljs">$ cargo run --example extract -- ./topics.classic.chm ./extracted<font></font>
$ tree ./extracted<font></font>
./extracted<font></font>
â”œâ”€â”€ default.html<font></font>
â”œâ”€â”€ BrowserForward.html<font></font>
...<font></font>
â”œâ”€â”€ Images<font></font>
â”‚   â”œâ”€â”€ Commands<font></font>
â”‚   â”‚   â””â”€â”€ RealWorld<font></font>
â”‚   â”‚       â”œâ”€â”€ BrowserBack.bmp<font></font>
...<font></font>
â”œâ”€â”€ script<font></font>
â”‚   â”œâ”€â”€ _community<font></font>
â”‚   â”‚   â””â”€â”€ disqus.js<font></font>
â”‚   â”œâ”€â”€ hs-common.js<font></font>
...<font></font>
â””â”€â”€ userinterface.html<font></font>
$ firefox topics.classic/default.html<font></font>
( default.html  Firefox)</code></pre><br>
<p> JavaScript   ( -    Microsoft Help),   ,     .</p><br>
<h2 id="chto-dalshe"> ?</h2><br>
<p> chmlib    ,    ,     crates.io.</p><br>
<p>       :</p><br>
<ul>
<li>   ChmFile::for_each()  ChmFile::for_each_item_in_dir() ,          ,     .</li>
<li>  ,          ChmFile       <code>Continuation::Continue</code>   . ,     <code>F: FnMut(&amp;mut ChmFile, UnitInfo) -&gt; C</code>  <code>C: Into&lt;Continuation&gt;</code>,    <code>impl From&lt;()&gt; for Continuation</code>.</li>
<li>     (,     extract())      ChmFile::for_each()   .         <code>impl&lt;E&gt; From&lt;Result&lt;(), E&gt;&gt; for Continuation where E: Error + 'static</code>.</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€å‰ã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã‚’ä¸€æ™‚ãƒãƒƒãƒ•ã‚¡ã«æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã¯ã€ã©ã†ã„ã†ã‚ã‘ã‹ã€ã‚ã¾ã‚Šè‰¯ãã‚ã‚Šã¾ã›ã‚“</font></font><code>std::fs::File</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ãƒ«ãƒ¼ãƒ—å†…ã§ChmFile :: readï¼ˆï¼‰ã‚’å‘¼ã³å‡ºã—ã€çµæœã‚’someã«è»¢é€ã™ã‚‹æœ€é©åŒ–ã•ã‚ŒãŸé–¢æ•°ã‚’è¿½åŠ ã™ã‚‹ã¨ã‚ˆã‚Šä¾¿åˆ©</font></font><code>std::io::Writer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã™ã€‚</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja474654/index.html">ç°¡å˜ãªè¨€è‘‰ã§SSHãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ã€‚</a></li>
<li><a href="../ja474656/index.html">Reversim MIPSã¨Golang-ãƒªãƒãƒ¼ã‚¹ã®åŸºæœ¬ã€‚r0ot-miã§é€†è»¢ã™ã‚‹ãŸã‚ã®å•é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚ãƒ‘ãƒ¼ãƒˆ2</a></li>
<li><a href="../ja474658/index.html">æ‰‹é¦–ã®ç—›ã¿ã¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒã‚¦ã‚¹</a></li>
<li><a href="../ja474662/index.html">ãƒ™ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆï¼šé–‹ç™ºè€…å‘ã‘ã®é–‹ç™º-è‹±èªå­¦ç¿’ç”¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </a></li>
<li><a href="../ja474664/index.html">æ³¨æ„ã‚’é«˜ã‚ã‚‹ãŸã‚ã«ã€ç§ãŸã¡ã®è„³ã¯é›†ä¸­åŠ›ã‚’é«˜ã‚ã¾ã›ã‚“ãŒã€æƒ…å ±ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™</a></li>
<li><a href="../ja474668/index.html">é™çš„ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ãŠã‚ˆã³GitHubãƒšãƒ¼ã‚¸ä¸Šã®ã‚µã‚¤ãƒˆã®CI / CDã¨ã—ã¦ã®GitHubã‚¢ã‚¯ã‚·ãƒ§ãƒ³</a></li>
<li><a href="../ja474672/index.html">Reactã€JSXã€Webãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãªã—ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§ã®ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå‹•çš„ã‚’å«ã‚€ï¼‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a></li>
<li><a href="../ja474674/index.html">ãƒã‚·ãƒ³ãƒ“ã‚¸ãƒ§ãƒ³ã¨åŒ»å­¦</a></li>
<li><a href="../ja474676/index.html">GLES3ãŠã‚ˆã³WebGL2ã§ã®GPUä¸Šã®æ•°åä¸‡ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç²’å­ã®ç›¸äº’ä½œç”¨ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </a></li>
<li><a href="../ja474678/index.html">Khronos GroupãŒVulkanã®ä¾‹ã‚’ä½¿ç”¨ã—ã¦çµ±åˆãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>