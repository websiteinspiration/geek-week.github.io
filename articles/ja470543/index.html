<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑‍🤝‍🧑 👨‍🔬 ▫️ インフラ管理をTerraformにどのように導入し、生活を始めたか 🛂 ✍🏿 🧣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="4つのAmazonアカウント、9つのVPC、30の最も強力な開発環境、ステージ、リグレッションがあり、すべての色と色合いのEC2インスタンスが合計1000以上ありました。ビジネス向けのクラウドソリューションの収集を始めてから、趣味で最後までやり、これをすべて自動化する方法を考えなければなりません。
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>インフラ管理をTerraformにどのように導入し、生活を始めたか</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dins/blog/470543/"><img src="https://habrastorage.org/webt/os/gu/yk/osguyk_s9ckyitafq3rayiqhxw0.png" alt="画像"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4つのAmazonアカウント、9つのVPC、30の最も強力な開発環境、ステージ、リグレッションがあり、すべての色と色合いのEC2インスタンスが合計1000以上ありました。ビジネス向けのクラウドソリューションの収集を始めてから、趣味で最後までやり、これをすべて自動化する方法を考えなければなりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こんにちは！私はキリルカザリンと申します。DINSのエンジニアです。クラウドベースのビジネスコミュニケーションソリューションを開発しています。私たちの仕事では、インフラストラクチャを柔軟に管理するTerraformを積極的に使用しています。私の経験をこのソリューションと共有します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事が長いので、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポップコーン</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ティーを買いに行ってください！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてもう1つのニュアンス-記事はバージョン0.11に基づいて作成され、新鮮な0.12で大幅に変更されましたが、主なプラクティスとヒントはまだ関連しています。</font><font style="vertical-align: inherit;">0.11から0.12への移行の問題は別の記事に値します！</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraformとは</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、2014年に登場した人気のHashicorpツールです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このユーティリティを使用すると</font><font style="vertical-align: inherit;">、非常にフレンドリーで読みやすい宣言型言語の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラダイム</font><i><font style="vertical-align: inherit;">として、</font></i><font style="vertical-align: inherit;">インフラストラクチャでクラウドインフラストラクチャを管理できます</font><font style="vertical-align: inherit;">。そのアプリケーションは、インフラストラクチャ管理のための単一タイプのリソースとコードプラクティスのアプリケーションを提供します。これらは、長い間開発者コミュニティによって開発されてきました。 Terraformはすべての最新のクラウドプラットフォームをサポートしており、インフラストラクチャを安全かつ予測可能な形で変更できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
起動すると、Terraformはコードを読み取り、クラウドサービスプロバイダーが提供するプラグインを使用して、必要なAPI呼び出しを行うことにより、インフラストラクチャを上記の状態にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのプロジェクトは完全にアマゾンにあり、AWSサービスに基づいて展開されているので、私はこの形でTerraformのアプリケーションについて書いています。</font><font style="vertical-align: inherit;">それとは別に、Amazonだけでなく利用できることも覚えておきます。</font><font style="vertical-align: inherit;">APIを持つすべてのものを管理できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、VPC設定、IAMポリシー、ロールを管理します。</font><font style="vertical-align: inherit;">ルーティングテーブル、証明書、ネットワークACLを管理します。</font><font style="vertical-align: inherit;">私たちは、Webアプリケーションファイアウォール、S3-bucket、SQS-queuesの設定を管理します-サービスがAmazonで使用できるすべてのもの。</font><font style="vertical-align: inherit;">Terraformがインフラストラクチャの観点から説明できなかった機能をAmazonでまだ満たしていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
かなり大きなインフラストラクチャであり、手でサポートするのは簡単です。</font><font style="vertical-align: inherit;">しかし、Terraformを使用すると、便利でシンプルです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraformの素材</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロバイダー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、サービスのAPIを操作するためのプラグインです。</font><font style="vertical-align: inherit;">私はそれらを</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100以上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に数えました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その中には、Amazon、Google、DigitalOcean、VMware Vsphere、Dockerのプロバイダーがあります。</font><font style="vertical-align: inherit;">この公式リストで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Cisco ASAのルールを管理</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できるプロバイダーを見つけました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特に、以下を制御できます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grafanaの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダッシュボード、データソース、アラート</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上のプロジェクト</font><font style="vertical-align: inherit;">。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQLの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベース、ユーザー、権限</font><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これらは公式のプロバイダーにすぎず、さらに多くの非公式のプロバイダーがあります。実験中に、公式リストプロバイダーに含まれていないサードパーティのGitHubに出くわしました。これ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">により、GoDaddyのDNS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proxmoxリソースを操作できるようになりました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのTerraformプロジェクト内で、さまざまなプロバイダーを使用できます。したがって、さまざまなサービスプロバイダーまたはテクノロジーのリソースを使用できます。たとえば、GoDaddyの外部DNSを使用してAWSでインフラストラクチャを管理できます。そして明日、あなたの会社はDOまたはAzureでホストされているスタートアップを購入しました。そして、AWSに移行するかどうかを決定する間、同じツールでこれをサポートすることもできます！</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソース。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらは、Terraformを使用して作成できるクラウドエンティティです。</font><font style="vertical-align: inherit;">それらのリスト、構文、およびプロパティは、実際には使用されているプロバイダーによって、使用されているプロバイダーによって異なります。</font><font style="vertical-align: inherit;">または雲だけではありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュール </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらは、Terraformを使用して構成をテンプレート化できるエンティティです。</font><font style="vertical-align: inherit;">したがって、テンプレートを使用すると、コードを小さくして再利用できます。</font><font style="vertical-align: inherit;">まあ、彼らは彼と一緒に快適に働くのに役立ちます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraformを選んだ理由</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たち自身で、5つの主な理由を特定しました。</font><font style="vertical-align: inherit;">おそらくあなたの観点からすると、それらのすべてが重要であるとは限りません：</font></font><br>
<br>
<ul>
<li><b>Terraform —  <s>loud Agnostic</s> multiple cloud support  (     )</b>.     , : —   ,           : "<i>,    — -      Amazon.    - ,        Google Cloud.   Azure — ,  </i>".  ,      ,       -  .</li>
<li><b> </b>. Terraform —  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.      16  ,     . <br>
<br>
        ,           .       ,    ,     ,      .    ,  «, ,           ». : «,  - , ,   ,   work-around».   .</li>
<li><b></b>. Terraform       .     ,  ,        ,        .      GitLab CI.</li>
<li><b>  </b>. Terraform       . <br>
<br>
,    Terraform   .    -   Amazon,  Security Group,  —    ,  .   — !  ,          ,       ,           Security Group  .<br>
<br>
    ,  ,       ,         . ,    Terraform,         ,      .<br>
<br>
 Terraform   ,       API  ,       : «     ,     ,    ?»     , ,    . , ,    ,   ,      ,     —   ,    .   ,    .  ,    ,   ,  ,    .</li>
<li>     — <b> </b>,    ,  counts.      .     . </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、簡単に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">言えば</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Terraformには</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">組み込み関数のかなり大きなリストがあります</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これらの関数を使用すると、宣言型言語にも関わらず、プログラムではなくロジックを実装できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、一部の自動計算、行の分割、小文字と大文字へのキャスト、この行からの文字の削除。</font><font style="vertical-align: inherit;">かなり積極的に利用しています。</font><font style="vertical-align: inherit;">特に、後で別の環境で再利用されるモジュールを作成する場合に、作業がはるかに簡単になります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TerraformとCloudFormation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットでは、TerraformはCloudFormationと比較されることがよくあります。</font><font style="vertical-align: inherit;">それを選択するときにこの質問もしました。</font><font style="vertical-align: inherit;">そして、これが私たちの比較の結果です。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">比較</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テラフォーム</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラウドフォーメーション</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のクラウドのサポート</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまなプロバイダーを使用することにより、プラグインはあらゆる大規模なクラウドプロバイダーと連携できます。</font></font><br>
</td>
<td>   Amazon.</td>
</tr>
<tr>
<td> </td>
<td>    <br>
   TF,   ,   , TF        <br>
</td>
<td>  <br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 2018 </a>.<br>
</td>
</tr>
<tr>
<td></td>
<td>   (<br>
   ).</td>
<td> .</td>
</tr>
<tr>
<td><br>
</td>
<td>     ,  <br>
   (   ),   ,<br>
 S3  - .<br>
<br>
   ,   tfstate Terraform       JSON-  .       ,  —        ,     .  , ,   ,     -   .<br>
</td>
<td>   -  AWS</td>
</tr>
<tr>
<td> </td>
<td>Terraform    .        .    ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Terraforming</a>.<br>
     Amazon,            . <br>
 -,  ,        .        . Terraform ,       —     .<br>
</td>
<td>CloudFormation   . <br>
  -     ,         CloudFormation,    .  ,  .</td>
</tr>
</tbody></table></div><br>
<h3>    Terraform</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的に言って、始めるのはとても簡単です。</font><font style="vertical-align: inherit;">最初のステップを簡単に説明します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず最初に、Gitリポジトリを作成し、すぐにすべての変更、実験、一般的にすべてのものをそこに格納し始めます。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタートガイド</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をお読み</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ください</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">それは小さく、気取らない、かなり詳細であり、このユーティリティを使い始める方法をよく説明しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかのデモ、作業コードを書いてください。</font><font style="vertical-align: inherit;">ある種の例をコピーして、後でそれを試すこともできます。</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraformでの実践</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースコード</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のプロジェクトを開始し、すべてを1つの大きなmain.tfファイルに保存しました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これが典型的な例です</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（私はGitHubから最初に得たものを正直に取り上げました）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
間違いはありませんが、コードベースのサイズは時間とともに大きくなる傾向があります。リソース間の依存関係も拡大しています。しばらくすると、ファイルは巨大で複雑になり、判読できなくなり、保守が不十分になります。1か所で不注意に変更すると、問題が発生する可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が最初にお勧めすることは、いわゆるコアリポジトリ、つまりプロジェクトのコア状態、つまり環境を強調することです。</font><font style="vertical-align: inherit;">Terraformを使用してインフラストラクチャの作成またはインポートを開始するとすぐに、デプロイされて構成された後はほとんど変更されないエンティティーがあることにすぐに気付くでしょう。</font><font style="vertical-align: inherit;">たとえば、これらはVPC設定、またはVPC自体です。</font><font style="vertical-align: inherit;">これらは、SSHアクセスなどの基本的な一般的なセキュリティグループです。かなり大きなリストを作成できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頻繁に変更するサービスと同じリポジトリにこれを保持しても意味がありません。</font><font style="vertical-align: inherit;">それらを別のリポジトリーで選択し、リモート状態などのTerraform機能を介してドッキングします。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">直接作業することが多いプロジェクトのその部分のコードベースを削減します。</font></font></li>
<li>   tfstate-,            ,           .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トリックは何ですか？</font><font style="vertical-align: inherit;">Terraformが計画を立てるとき、つまり、変更する必要があるものを計算し、計算し、適用します-この状態を完全に再カウントし、コードをチェックし、AWSのステータスをチェックします。</font><font style="vertical-align: inherit;">州が大きいほど、計画は長くなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実稼働環境全体の計画を作成するのに20分かかったとき、私たちはこのプラクティスに来ました。</font><font style="vertical-align: inherit;">頻繁に変更される可能性のないすべてのものを個別のコアに組み込んだため、計画を作成する時間を半分に短縮しました。</font><font style="vertical-align: inherit;">コアと非コアだけでなく、サブシステムによっても分割され、通常は一緒に変更されるため、さらに削減する方法を考えています。</font><font style="vertical-align: inherit;">したがって、たとえば、10分を3に変更します。しかし、このようなソリューションの実装はまだ進行中です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードが少ない-読みやすい</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小さなコードの方が理解しやすく、作業しやすいです。大規模なチームとさまざまなレベルの経験を持つ人々がいる場合は、ほとんど変更しないが、グローバルに別のカブに取り出し、より狭いアクセスを許可します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チームにジュニアがいて、VPC設定を説明するグローバルリポジトリへのアクセス権を彼らに与えないとします。これにより、エラーを防ぐことができます。エンジニアがインスタンスの記述を間違え、何かが間違って作成された場合-それは怖くないです。そして、彼がすべてのマシンにインストールされているオプションに間違いを犯したり、中断したり、サブネットの設定で何かを行ったりすると、ルーティングはさらに困難になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コアリポジトリの選択は、いくつかのステップで行われます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージ1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。別のリポジトリを作成します。すべてのコードを個別に格納し、この出力を使用してサードパーティのリポジトリで再利用する必要があるエンティティを記述します。 AWSサブネットリソースを作成し、そこにリソースが配置されている場所、アベイラビリティーゾーン、アドレススペースを記述したとします。</font></font><br>
<br>
<pre><code class="go hljs">resource <span class="hljs-string">"aws_subnet"</span> <span class="hljs-string">"lab_pub1a"</span> {<font></font>
 vpc_id            = <span class="hljs-string">"${aws_vpc.lab.id}"</span>
 cidr_block        = <span class="hljs-string">"10.10.10.0/24"</span>
 Availability_zone = <span class="hljs-string">"us-east-1a"</span><font></font>
 ...<font></font>
}<font></font>
output <span class="hljs-string">"sn_lab_pub1a-id"</span> {<font></font>
 value = <span class="hljs-string">"${aws_subnet.lab_pub1a.id}"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、このオブジェクトのIDを出力に送信するとします。必要なパラメータごとに出力を行うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでの秘訣は何ですか？値を記述すると、Terraformはそれをtfstateコアに個別に保存します。そして、あなたが彼に目を向けると、彼は同期する必要はありません。彼はこの状態からこの問題をすぐにあなたに与えることができます。さらに、コアではないリポジトリでは、リモート状態とのそのような接続を記述します。リモート状態などがある場合、それはS3バケットなどにあり、キーとリージョンにあります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージ2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。非コアプロジェクトでは、出力を通じてエクスポートされたパラメーターを参照できるように、コアプロジェクトの状態へのリンクを作成します。</font></font><br>
<br>
<pre><code class="go hljs">data <span class="hljs-string">"terraform_remote_state"</span> <span class="hljs-string">"lab_core"</span> {<font></font>
 backend = <span class="hljs-string">"s3"</span><font></font>
 config {<font></font>
   bucket  = <span class="hljs-string">"lab-core-terraform-state"</span>
   key     = <span class="hljs-string">"terraform.tfstate"</span>
   region  = <span class="hljs-string">"us-east-1"</span><font></font>
 }<font></font>
}<font></font>
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージ3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">入門！</font><font style="vertical-align: inherit;">特定のサブネットのインスタンスに新しいネットワークインターフェースをデプロイする必要がある場合、私は言います。ここにデータリモート状態があります。その中にこの状態の名前を見つけ、その中にこのパラメーターを見つけます。これは実際、この名前と一致します。</font></font><br>
<br>
<pre><code class="go hljs">resource <span class="hljs-string">"aws_network_interface"</span> <span class="hljs-string">"fwl01"</span> {<font></font>
  ...   <font></font>
  subnet_id = <span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1a-id}"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非コアリポジトリで変更の計画を作成すると、Terraformのこの値は定数になります。</font><font style="vertical-align: inherit;">変更したい場合は、もちろんコアのリポジトリで行う必要があります。</font><font style="vertical-align: inherit;">しかし、これはめったに変更されないので、それほど気になりません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュール</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モジュールは、1つ以上の関連リソースで構成される自己完結型の構成であることを思い出してください。</font><font style="vertical-align: inherit;">それはグループとして管理され</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。モジュールは、そのような1つのリソースを作成することはめったにないため、非常に便利なものです。真空では、通常、それは何かと論理的に接続されます。</font></font><br>
<br>
<pre><code class="go hljs">module <span class="hljs-string">"AAA"</span> {<font></font>
  source = <span class="hljs-string">"..."</span>
  count = <span class="hljs-string">"3"</span>
  count_offset = <span class="hljs-string">"0"</span>
  host_name_prefix = <span class="hljs-string">"XXX-YYY-AAA"</span>
  ami_id = <span class="hljs-string">"${data.terraform_remote_state.lab_core.ami-base-ami_XXXX-id}"</span>
  subnet_ids = [<span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1a-id}"</span>,
                <span class="hljs-string">"${data.terraform_remote_state.lab_core.sn_lab_pub1b-id}"</span>]<font></font>
  instance_type = <span class="hljs-string">"t2.large"</span>
  sgs_ids = [ <span class="hljs-string">"${data.terraform_remote_state.lab_core.sg_ssh_lab-id}"</span>,
              <span class="hljs-string">"${aws_security_group.XXX_lab.id}"</span> ]<font></font>
  boot_device = {volume_size = <span class="hljs-string">"50"</span> volume_type = <span class="hljs-string">"gp2"</span>}<font></font>
  root_device = {device_name = <span class="hljs-string">"/dev/sdb"</span> volume_size = <span class="hljs-string">"50"</span> volume_type = <span class="hljs-string">"gp2"</span> encrypted = <span class="hljs-string">"true"</span>}<font></font>
  tags = <span class="hljs-string">"${var.gas_tags}"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、新しいEC2インスタンスをデプロイするときは、ネットワークインターフェイスとアタッチメントを作成し、そのインスタンスにElastic IPアドレスを作成したり、route-53レコードを作成したりします。</font><font style="vertical-align: inherit;">つまり、少なくとも4つのエンティティを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
毎回、4つのコードでそれらを記述するのは不便です。</font><font style="vertical-align: inherit;">さらに、それらはかなり典型的です。</font><font style="vertical-align: inherit;">それは頼む-テンプレートを作成し、次にこのテンプレートを参照し、それにパラメータを渡します：ある名前、どのグリッドに押し込むか、どのセキュリティグループに掛けるか。</font><font style="vertical-align: inherit;">とても快適です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraformにはカウント機能があり、これにより状態をさらに減らすことができます。 1つのコードでインスタンスの大きなバンドルを記述できます。同じタイプのマシンを20台デプロイする必要があるとしましょう。テンプレートからでも20個のコードは記述せず、1個のコードを記述します。カウントとその中の数を示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、テンプレートを参照するモジュールがいくつかあります。特定のパラメーターのみを渡します。IDサブネット。展開するAMI。インスタンスのタイプ。セキュリティグループの設定。他に何でも、そして私にこれらのことの何をすべきかを示します。すばらしい、それらを取り、それらを好転させた！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明日、開発者が私のところに来てこう言います：「聞いてください、私たちは負荷を実験したいので、もう2つ教えてください。」必要な作業：1桁を5に変更します。コードの量はまったく同じです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
従来、モジュールは、リソースとインフラストラクチャの2つのタイプに分けることができます。</font><font style="vertical-align: inherit;">コードの観点から見ると、違いはありません。これらは、オペレーター自体によって導入されたより高いレベルの概念である可能性が高いです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リソースモジュールは、標準化およびパラメーター化された、論理的に関連するリソースのコレクションを提供します。</font><font style="vertical-align: inherit;">上記の例は、典型的なリソースモジュールです。</font><font style="vertical-align: inherit;">それらを使用する方法：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sourceディレクティブを通じて、モジュールへのパス（構成のソース）を示します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちはバージョンを示します-はい、そして「最新かつ最高」の原則での運用はここでは最良の選択肢ではありません。</font><font style="vertical-align: inherit;">プロジェクトに毎回最新バージョンのライブラリを含めませんか？</font><font style="vertical-align: inherit;">しかし、それについては後で詳しく説明します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引数を渡します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モジュールのバージョンに関連付けられており、最後のバージョンのみを使用します-インフラストラクチャをバージョン管理する必要があります（リソースはバージョン管理できませんが、コードはバージョン管理できます）。リソースは削除または再作成して作成できます。すべて！また、インフラストラクチャの各部分を作成したバージョンを明確に知る必要もあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インフラストラクチャモジュールは非常に単純です。これらはリソースで構成され、会社の標準（タグ、標準値のリスト、受け入れられたデフォルトなど）が含まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのプロジェクトと経験については、非常に厳密なバージョン管理とレビューのプロセスで可能なすべてのことを、リソースモジュールの使用に長くしっかりと切り替えてきました。そして今、ラボとステージングのレベルでインフラストラクチャモジュールの実践を積極的に紹介しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モジュールの使用に関する推奨事項</font></font><br>
<br>
<ol>
<li>   ,    —  .      .            . ,          —           .</li>
<li>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Terraform Registry</a>      .</li>
<li>    —    .       ,      .</li>
<li> input   output    .  ,     .  .</li>
<li>    —      .     .</li>
<li>    —      .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モジュール内でプロバイダーの説明を使用しないでください。接続資格情報は、ユーザーごとに異なる方法で構成および適用できるためです。</font><font style="vertical-align: inherit;">誰かがこれに環境変数を使用し、誰かがそれらのパスを含むファイルにキーとシークレットを保存する必要があります。</font><font style="vertical-align: inherit;">これはより高いレベルで示される必要があります。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルプロビジョナーを注意深く使用してください。</font><font style="vertical-align: inherit;">Terraformが実行されているマシン上でローカルに実行されますが、ユーザーごとに実行環境が異なる場合があります。</font><font style="vertical-align: inherit;">CIに埋め込むまで、さまざまなアーティファクトに遭遇する可能性があります。たとえば、ローカルexecやansibleの実行などです。</font><font style="vertical-align: inherit;">そして、誰かが別のディストリビューション、別のシェル、別のバージョンのansible、あるいはWindowsさえ持っています。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
良いモジュールの兆候（これは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もう少し詳細です</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：</font></font><br>
<br>
<ul>
<li>      .        —   .</li>
<li>      (  AWS).</li>
<li>    ,    defaults.    EC2            m5d.24xlarge,    -   t2  t3 .</li>
<li> «» — ,  ,   ,    .</li>
<li>      ,    .     ,    .</li>
</ul><br>
<h4></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タグは重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タグ付けは請求です。</font><font style="vertical-align: inherit;">AWSには、インフラストラクチャに費やす金額を確認できるツールがあります。</font><font style="vertical-align: inherit;">そして私たちの経営陣は本当に彼らがそれを決定論的に見ることができるツールを望んでいました。</font><font style="vertical-align: inherit;">たとえば、そのようなコンポーネントが消費する金額、またはそのようなサブシステム、そのようなチーム、そのような環境</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3q/mn/9e/3qmn9ej1ao0cmn8irggvgl8ztj4.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、タグ付けは、システムのドキュメントです。</font><font style="vertical-align: inherit;">それを使用すると、検索を簡素化します。</font><font style="vertical-align: inherit;">これらのタグが画面にきれいに表示されるAWSコンソールだけでも、このインスタンスまたはそのタイプのインスタンスが何を指しているのかを理解しやすくなります。</font><font style="vertical-align: inherit;">新しい同僚が来た場合、「ほら、これだ-ここだ」と表示することでこれを説明する方が簡単です。</font><font style="vertical-align: inherit;">次のようにタグの作成を開始しました。リソースのタイプごとにタグの配列を作成しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例：</font></font><br>
<br>
<pre><code class="go hljs">variable <span class="hljs-string">"XXX_tags"</span> {<font></font>
 description = <span class="hljs-string">"The set of XXX tags."</span>
 <span class="hljs-keyword">type</span> = <span class="hljs-string">"map"</span>
 <span class="hljs-keyword">default</span> = {
             <span class="hljs-string">"TerminationDate"</span> = <span class="hljs-string">"03.23.2018"</span>,
             <span class="hljs-string">"Environment"</span> = <span class="hljs-string">"env_name_here"</span>,
             <span class="hljs-string">"Department"</span> = <span class="hljs-string">"dev"</span>,
             <span class="hljs-string">"Subsystem"</span> = <span class="hljs-string">"subsystem_name"</span>,
             <span class="hljs-string">"Component"</span> = <span class="hljs-string">"XXX"</span>,
             <span class="hljs-string">"Type"</span> = <span class="hljs-string">"application"</span>,
             <span class="hljs-string">"Team"</span> = <span class="hljs-string">"team_name"</span><font></font>
           }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たまたま私たちの会社では複数のチームがAWSを使用していて、必要なタグのリストがいくつかあります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チーム-どのチームがいくつのリソースを使用するか。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部門-部門に似ています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">環境-リソースは「環境」で打ち負かされますが、たとえば、プロジェクトなどで置き換えることができます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブシステム-コンポーネントが属するサブシステム。</font><font style="vertical-align: inherit;">コンポーネントは1つのサブシステムに属することができます。</font><font style="vertical-align: inherit;">たとえば、このサブシステムとそのエンティティが消費し始めた量を確認します。</font><font style="vertical-align: inherit;">たとえば、前の月に突然、それは大幅に成長しました。</font><font style="vertical-align: inherit;">開発者のところに行き、次のように言う必要があります。</font><font style="vertical-align: inherit;">予算はすでに互いに近いので、どういうわけかロジックを最適化しましょう。」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイプ-コンポーネントのタイプ：バランサー、ストレージ、アプリケーション、またはデータベース。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンポーネント-コンポーネント自体、内部表記での名前。</font></font></li>
<li>Termination date —      ,   .     ,  “Permanent”.   ,     ,           -,    -,        .   ,     .         , -  ,    AWS Command Line Interface,        .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今-タグを付ける方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各コンポーネントに対して独自のタグマップを実行することを決定しました。ここでは、指定されたすべてのタグを一覧表示します。いつ終了するか、何を参照するかです。彼らはすぐにそれが不便であることに気づきました。コードベースが拡大しているため、30以上のコンポーネントがあり、そのようなコードの30個の断片は不便です。何かを変更する必要がある場合は、実行して変更します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
うまくタグ付けするには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Locals</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンティティを使用します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="go hljs"><font></font>
locals {<font></font>
 common_tags = {<span class="hljs-string">"TerminationDate"</span> = <span class="hljs-string">"XX.XX.XXXX"</span>,
                  <span class="hljs-string">"Environment"</span> = <span class="hljs-string">"env_name"</span>,
                  <span class="hljs-string">"Department"</span> = <span class="hljs-string">"dev"</span>,
                  <span class="hljs-string">"Team"</span> = <span class="hljs-string">"team_name"</span>}<font></font>
 subsystem_1_tags = <span class="hljs-string">"${merge(local.common_tags,
                        map("</span>Subsystem<span class="hljs-string">", "</span>subsystem_1_name<span class="hljs-string">"))}"</span>
 subsystem_2_tags = <span class="hljs-string">"${merge(local.common_tags,
                        map("</span>Subsystem<span class="hljs-string">", "</span>subsystem_2_name<span class="hljs-string">"))}"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その中にサブセットをリストし、それらを互いに使用することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、このような構造にいくつかの一般的なタグを削除してから、サブシステムごとに特定のタグを削除しました。</font><font style="vertical-align: inherit;">「このブロックを取得して、たとえば、サブシステム1を追加します。サブシステム2の場合、サブシステム2を追加します」と言います。</font><font style="vertical-align: inherit;">「タグは、一般的なタグを取り、タイプ、アプリケーション、名前、コンポーネント、およびそれらが誰であるかを追加してください。」</font><font style="vertical-align: inherit;">突然必要になった場合、それは非常に短時間で、明確かつ集中的な変更になります。</font></font><br>
<br>
<pre><code class="go hljs">
module <span class="hljs-string">"ZZZ02"</span> {<font></font>
   count         = <span class="hljs-number">1</span>
   count_offset  = <span class="hljs-number">1</span>
   name          = <span class="hljs-string">"XXX-YYY-ZZZ"</span><font></font>
   ...<font></font>
   tags          = <span class="hljs-string">"${merge(local.core_tags, map("</span>Type<span class="hljs-string">", "</span>application<span class="hljs-string">",
                                                 "</span>Component<span class="hljs-string">", "</span>XXX<span class="hljs-string">"))}"</span><font></font>
}<font></font>
<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/ka/sq/4o/kasq4ocxxl3hht59z9p6o5bzjfs.png" alt="画像"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バージョン管理</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テンプレートモジュールを使用する場合は、どこかに保存する必要があります。最も可能性の高い誰もが始める最も簡単な方法は、ローカルストレージです。同じディレクトリ内、たとえば、ある種のサービスのテンプレートなどを記述したサブディレクトリのみ。これは良い方法ではありません。これは便利で、すばやく修正してすぐにテストできますが、後で再利用するのが難しく、制御するのが困難です</font></font><br>
<br>
<pre><code class="go hljs">module <span class="hljs-string">"ZZZ02"</span> {<font></font>
 source        = <span class="hljs-string">"./modules/srvroles/ZZZ"</span>
 name          = <span class="hljs-string">"XXX-YYY-ZZZ"</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者があなたのところにやって来て言ったとしましょう。</font><font style="vertical-align: inherit;">あなたはそれを書いて、彼らのプロジェクトのリポジトリにローカルモジュールの形で作りました。</font><font style="vertical-align: inherit;">展開済み-優れています。</font><font style="vertical-align: inherit;">彼らはテストして言った：</font><font style="vertical-align: inherit;">生産中。 " </font><font style="vertical-align: inherit;">ステージ、ストレステスト、生産に移行します。</font><font style="vertical-align: inherit;">毎回Ctrl-C、Ctrl-V; </font><font style="vertical-align: inherit;">Ctrl-C、Ctrl-V。</font><font style="vertical-align: inherit;">セールに着くまでに、同僚がそれを受け取り、実験室環境からコードをコピーし、別の場所に転送してそこで変更しました。</font><font style="vertical-align: inherit;">そして、すでに一貫性のない状態になります。</font><font style="vertical-align: inherit;">水平スケーリングを使用すると、私たちと同じくらい多くの実験室環境があるとき、それはただの願望です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、モジュールごとに個別のGitリポジトリを作成し、それを参照するのが良い方法です。</font><font style="vertical-align: inherit;">すべてを1か所で変更します-優れた、便利な、管理された。</font></font><br>
<br>
<pre><code class="go hljs">module <span class="hljs-string">"ZZZ"</span> {<font></font>
 source = <span class="hljs-string">"git::ssh://git@GIT_SERVER_FQDN/terraform/modules/general-vm/2-disks.git"</span>
 host_name_prefix = <span class="hljs-string">"XXX-YYY-ZZZ"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
質問を予想して、コードはどのようにして本番環境に到達しますか。このために、準備およびテストされたモジュールを再利用する別のプロジェクトが作成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すばらしい、一元的に変更されるコードのソースが1つあります。明日の朝、本番環境にデプロイすることにしました。私は計画を立て、それをテストしました-素晴らしい、行きましょう。この時点で、私の意図はもっぱら善意によって導かれ、このモジュールに追加された何かを行って最適化しました。そして、これらの変更により下位互換性が失われることもありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、彼は渡す必要のある必要なパラメーターを追加しました。そうしないと、モジュールがアセンブルされません。または、これらのパラメーターの名前を変更しました。私は午前中に来て、変更の時間を厳しく制限し、計画の作成を開始します。TerraformはGitから状態モジュールを取得し、計画の作成を開始して次のように言います。「できません。名前が足りません。名前を変更しました。」私は驚いています：「しかし、私はそれをしませんでした、それに対処する方法は？」そして、これがずっと前に作成されたリソースである場合、そのような変更の後、すべての環境を実行し、どういうわけか変更して1つの外観に導く必要があります。快適ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、Gitタグを使用して修正できます。私たちは</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">SemVer表記</font></a><font style="vertical-align: inherit;">を使用することを自分で決めました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、単純なルールを開発しました。モジュールの構成が特定の安定した状態、つまりそれを使用できるようになったらすぐに、このコミットにタグを付けます。</font><font style="vertical-align: inherit;">変更を加えても下位互換性が損なわれない場合は、タグのマイナー番号を変更し、変更があった場合はメジャー番号を変更します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、送信元アドレスで、特定のタグに添付し、少なくとも以前に持っていたものを提供すれば、常に収集されます。</font><font style="vertical-align: inherit;">モジュールのバージョンを先に進めましょう。ただし、適切なときに来て、本当に必要なときに変更します。</font><font style="vertical-align: inherit;">その前に機能していたものは、少なくとも壊れることはありません。</font><font style="vertical-align: inherit;">快適です。</font><font style="vertical-align: inherit;">これは、GitLabでの表示です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qb/vc/yh/qbvcyhrhgdblv8ewvwlr1gkxsmc.png" alt="画像"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分岐</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分岐の使用は、もう1つの重要なプラクティスです。</font><font style="vertical-align: inherit;">私たちは、マスターからのみ変更を行うべきであるというルールを独自に開発しました。</font><font style="vertical-align: inherit;">ただし、変更を加えてテストしたい場合は、別のブランチを作成し、それを試してみて、実験を行い、計画を立てて、状況を確認してください。</font><font style="vertical-align: inherit;">そして、merge-requestを実行し、同僚にコードを見て手伝ってもらいます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ty/vf/je/tyvfjel4g_uhzcrf7ifnkdxd230.png" alt="画像"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tfstateを格納する場所</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
状態をローカルに保存しないでください。状態をGitに保存しないでください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マスター以外のブランチを展開するときに、状態が保存されているtfstateを取得したときに、私たちはこれに火傷を負いました-その後、マージによってオンにし、誰かが自分のものを追加すると、マージの競合が発生します。または、それらなしで判明することもありますが、一貫性のない状態です。「彼はすでに持っているので、まだ持っていない」ので、それをすべて修正するのは不愉快な習慣です。したがって、バージョン管理された安全な場所に保管することを決定しましたが、Gitの外部にあります。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">S3</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
はこれに完全に適合し</font><font style="vertical-align: inherit;">ます。利用可能で、HAがあります。私が</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">4ナインを正確</font></a><font style="vertical-align: inherit;">に覚えている限り</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、おそらく5</font></a></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。そのままでバージョン管理ができるので、tfstateを壊しても、いつでもロールバックできます。そして、それはDynamoDBとの組み合わせで非常に重要なことも提供します。これは、私の意見では、バージョン0.8以降、このTerraformを習得したものです。 DynamoDBには、Terraformが状態をブロックしていることを記録する銘板があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、変更を加えたいとします。私は計画の作成または適用を開始します。TerraformはDynamoDBに行き、この状態がブロックされているという情報がこのプレートに作成されると言います。ユーザー、コンピューター、時間。現時点では、リモートで作業している、または私からいくつかのテーブルを使用しているが、作業に集中していて、自分のやっていることが分からない同僚も、何かを変更する必要があると判断しました。彼は計画を立てますが、それを少し後で開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraformはダイナミクスに入り、見る-ロック、中断、ユーザーに「申し訳ありませんが、tfstateは何かによってブロックされています。」</font><font style="vertical-align: inherit;">同僚は私が今働いていることを知っているので、私に近づいて言うことができます。「聞いてください。私にはもっと重要なチェンジャーがいるので、教えてください。」</font><font style="vertical-align: inherit;">私は言う：「良い」、私は計画をキャンセルし、ブロックを削除します。Ctrl-Cを中断せずに、正しく実行すると、ブロックは自動的に削除されます。</font><font style="vertical-align: inherit;">同僚が行って行います。</font><font style="vertical-align: inherit;">したがって、私たちは、あなたたち2人が何かを変えている状況に対して自分自身に保険をかけます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マージリクエスト</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gitではブランチを使用します。マージ要求を同僚に割り当てます。さらに、Gitlabでは、マージ要求や一部のプールなど、連携するために使用できるほとんどすべてのツールを使用します。コードのディスカッション、そのレビュー、進行中または問題の設定、その他のようなものです。それは非常に便利です、それは仕事に役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、この場合、ロールバックも簡単です。前のコミットに戻ることができます。たとえば、ウィザードからの変更を適用するだけではなく、安定したブランチに切り替えることもできます。</font><font style="vertical-align: inherit;">たとえば、機能ブランチを作成し、最初に機能ブランチから変更を行うことにしました。</font><font style="vertical-align: inherit;">そして、すべてがうまくいった後、マスターに変更を加えます。</font><font style="vertical-align: inherit;">あなたはブランチに変更を適用し、何かがおかしいことに気づき、マスターに切り替えました-変更はありません、彼らは適用すると言った-彼は戻った。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パイプライン</font></font></h4><br>
<img src="https://habrastorage.org/webt/qx/g1/ex/qxg1exw6vesornrgdhc7ynmjg80.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更を適用するには、CIプロセスを使用する必要があると判断しました。</font><font style="vertical-align: inherit;">これを行うには、Gitlab CIに基づいて、変更の適用を自動化するパイプラインを記述します。</font><font style="vertical-align: inherit;">これまでのところ、2つのタイプがあります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マスターブランチのパイプライン（マスターパイプライン）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他のすべてのブランチのパイプライン（ブランチパイプライン）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パイプラインブランチは何をしますか？自動コード検証を開始します（たとえば、タイプミスを間違えてチェックしています）。そして、それは計画の構築を開始します。そして、マージ要求を監視する同僚は、作成されたプランをすぐに開いて、コードだけでなく、追加したものも見ることができます。また、インフラストラクチャにどのように影響するかについても説明します。それは明確で便利です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vt/0_/hq/vt0_hqcdpurvppbglcxwgwtqiyi.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ウィザードで、もう1つのステップがここに追加されます。</font><font style="vertical-align: inherit;">違いは、プランが生成されるだけでなく、アーティファクトとしても保存されることです。</font><font style="vertical-align: inherit;">Terraformのもう1つの非常に便利な機能は、プランをファイルとして保存して適用できることです。</font><font style="vertical-align: inherit;">あなたがマージリクエストをしてそれを取っておいたとしましょう。</font><font style="vertical-align: inherit;">1か月後、彼らは彼を覚えていて、戻ることにしました。</font><font style="vertical-align: inherit;">あなたのコードはすでにはるかに進んでいます。</font><font style="vertical-align: inherit;">計画の成果物を保持しているため、その時点で必要なものに適用できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/67/9z/ub/679zubdsyvuldaiwzcpimtbvjmu.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの場合、このアーティファクトは次のステップに転送され、手作業で行われます。</font><font style="vertical-align: inherit;">つまり、変更点を一元的に適用できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraformの短所</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Terraformにはかなり多くの組み込み関数があるにもかかわらず、それらのすべてが私たちが考えているほど優れているわけではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「要素」など、不快な機能が含まれています。状況によっては、経験が不足しているため、その動作が期待どおりにならない場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、モジュールを使用すると、モジュールにカウントが渡されます—デプロイするインスタンスの数、たとえば、アベイラビリティーゾーンごとに分類されたサブネットのリストが送信されます。転送、適用、カウントの増加、まだ適用。そして、サブネットの増加したリストをそれに転送することにしました。グリッドを取得し、もう1つAZを使用することにしました。リストの2番目の部分が変更され、countが要素を介してこのリストにマップされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この前に4つのAZと5つのインスタンスがあり、次に別のAZを追加したとしましょう。最初の4つは残りますが、すでに順調です。そして、約5番目に彼は言うでしょう：「そして今、私はそれを再現します。」そして、あなたはしたくなかったのです！あなたは新しいものだけが来て欲しいです。このようなバグは、Terraformがリストを処理する性質に起因しています。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">三項演算子。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条件は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">三項演算子に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すぎません</font><font style="vertical-align: inherit;">。私たちは本当に条件が不足しています。それでも、もっと馴染みのあるIfとElseが欲しいです。彼らがそうでないのは残念です-多分彼らは乗車するでしょう。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チームワークの課題</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。大規模なチーム、または大規模なプロジェクトがあり、多数の環境、またはその両方に対応している場合、Terraformは、CIを使用せずに使用するのが難しくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CIがない場合、ローカル環境からコンピューターに変更を加えます。私たちの経験では、これはあなたが自分でブランチを作成し、それを開始し、それを実験し、マージを行うのを忘れ、変更をプッシュするのを忘れたという事実につながります。それは痛い。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、あなたとあなたの同僚は、マシン上で同じバージョンを持っていました。次に、私の同僚が1つにバージョンを更新しました。翌日、変更を加え始めると、Terraformはチェックに行き、tfstateで必要なTerraformのバージョンの方が高いことを確認し、「いいえ、できません。更新してください」と言います。変更を行うための小さなウィンドウがある場合、最初にユーティリティを更新する必要があることを確認するのは簡単ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CIがある場合、たとえば、パイプラインコンテナー内に単一のエンティティが存在します。このようなバージョンがユーティリティ内を移動することがないようにしてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に、破損したコードまたは未使用のコードがウィザードに蓄積されることがあります。環境全体の計画が立てられるまで、自分の場所から怠惰になってしまうたびに。変更したものだけを対象にして、ターゲットオプションからアプリケーションを構築するようになります。たとえば、いくつかのインスタンスを追加して、「Terraform apply target instance」またはセキュリティグループと言いました。しかし、この場合、何かが故障した場合（たとえば、一部の構成が古くなっている場合）は、完全な計画を作成するときにそれが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを最新の状態にするには、多くの労力と時間を費やす必要があります。</font><font style="vertical-align: inherit;">これを持ち出す必要はありません。</font><font style="vertical-align: inherit;">CIがある場合、その中にはTerraformが計画を完全に構築すると強制的に言うだけで、変更をプッシュします。</font><font style="vertical-align: inherit;">そして彼に彼の計画を立てさせなさい、あなたは行って他のことをする。</font><font style="vertical-align: inherit;">彼はそれを作り、あなたはそれを見、あなたはそれをアーティファクトの形で手に入れ、そしてあなたはそれを適用しに行きました。</font><font style="vertical-align: inherit;">それは規律です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraformは特効薬ではありません</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼があなたに許可しないこと：</font></font><br>
<br>
<ul>
<li>Terraform       ,      .  , ,  .    ,        ,   ,   .       ,    ,  ,         .<br>
<br>
 ,      —       Tfstate,       ,        .         .   «   ,    » —  .<br>
<br>
                , -,  ,  - —   .      ,          .     ,               —    .</li>
<li>Terraform    ,      .  Terraform    . ?           ,    .     . ,   ,    AZ    - -. ,   North Virginia,     6  .          .    ,   ,  : «,   ».       — .   —      ,  , Terraform     .</li>
<li>Terraform        . ,    — 200 ,    198 ,    5.    .       ,         API . .</li>
<li>    ,      . ,    S3 bucket.     ,              —  ,     - .         Terraform –    ,   ,   : «,  -   ».     .      -  ,      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いずれにしても、Terraformは現在最高です。</font><font style="vertical-align: inherit;">そして、私たちはそれを使い続け、それは私たちに大いに役立ちます。</font></font><br></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja470529/index.html">レガシープロジェクトをGraphQLに変換する方法</a></li>
<li><a href="../ja470531/index.html">神経生理学者は、Neuralinkプロジェクトについて話し合い、「指で」の脳の働きについて話します</a></li>
<li><a href="../ja470535/index.html">Pythonを使用して棒グラフを作成する方法</a></li>
<li><a href="../ja470537/index.html">React on Mobx @ Quantmart / Mobx-form-validation-kitの新しい検証パッケージ</a></li>
<li><a href="../ja470541/index.html">ブラウザでのNeo4jの操作の基本</a></li>
<li><a href="../ja470547/index.html">Celery taskcls：新しいデコレーター、新機能</a></li>
<li><a href="../ja470549/index.html">TSMCは、さらに何十年もムーアの法則に従うことができることを望んでいます</a></li>
<li><a href="../ja470553/index.html">オイラー-ポアソン積分。計算方法の詳細</a></li>
<li><a href="../ja470555/index.html">ジョーカー2019レビュー：惑星パレード、または私たちを待つもの</a></li>
<li><a href="../ja470557/index.html">光制御：メタマテリアルに基づく新しいタイプの光学要素</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>