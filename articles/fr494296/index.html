<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë®üèº ü§µ üö´ Xiaomi Gateway (version europ√©enne - Lumi.gateway.mieu01) pirat√© üè∏ üÖæÔ∏è üßíüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Xiaomi Zigbee Gateway Hack
 
 Dans cet article, je veux partager avec vous mes meilleures pratiques et succ√®s dans l'analyse de la passerelle Xiaomi (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Xiaomi Gateway (version europ√©enne - Lumi.gateway.mieu01) pirat√©</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494296/"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xiaomi Zigbee Gateway Hack</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Dans cet article, je veux partager avec vous mes meilleures pratiques et succ√®s dans l'analyse de la passerelle Xiaomi (Version avec prise euro avec I take.ru). </font><font style="vertical-align: inherit;">Je vais vous dire comment y installer un logiciel alternatif, comment restaurer une passerelle avec un logiciel effac√© et m√™me r√©activer une passerelle avec un u-boot effac√©. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--------- BEAUCOUP DE PHOTOS -------------</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/aa/to/qs/aatoqssn86dgak8fgyoirmaiyae.png"><br>
<a name="habracut"></a><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, je vais vous dire comment vous connecter √† la carte passerelle et obtenir la racine. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, quelques d√©tails sur la passerelle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article d√©crit la version de la passerelle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bas√©e</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le processeur </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">imx6ull</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelques sp√©cifications techniques de la carte:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wifi RTL8723BS - le pilote de celui-ci pour une raison quelconque est charg√© s√©par√©ment.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU IMX6ULL</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM 256 Mo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM 256 Mo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Module ZIgbee bas√© sur JN5169.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la carte, les pi√®ces de service, P2 et P4 sont affich√©es. Id√©alement, ils sont fabriqu√©s sous les pogopins, mais ils sont plus faciles √† souder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
P2 est Wart 0 du processeur o√π toutes les informations de service sont affich√©es, le journal de d√©marrage uboot et la gestion du syst√®me, vous pouvez utiliser n'importe quel adaptateur usb-uart. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
P4 - USB OTG, qui est utilis√© pour t√©l√©charger le firmware sur nand. (En tant qu'OTG √† part enti√®re, jusqu'√† la fin, je ne pouvais pas le d√©marrer, une fois connect√©, l'appareil est d√©tect√©, mais apparemment quelque chose d'autre manque). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/zf/wn/iazfwn64giouka5exv5urahv-1w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La carte adaptateur usb chinoise est parfaitement adapt√©e aux surnoms P4. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/na/ty/7a/naty7aswx3muah3ityxjrswxq_s.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que tout est soud√© et connect√©, vous devez d'abord vous rooter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je l'ai fait selon cette instruction </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(lien vers le manuel),</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mais avec une petite clarification apr√®s le point 5, vous devez taper la commande de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©marrage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinon, le syst√®me est assis et attend une commande, les instructions ont probablement √©t√© √©crites dans l'espoir que tout le monde comprend Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour une raison quelconque, le serveur SSH ne s'est pas allum√© conform√©ment aux instructions et n'a √©t√© activ√© qu'en lan√ßant manuellement la commande pour d√©marrer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/init.d/dropbear start.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
L'√©tape suivante, apr√®s avoir re√ßu la racine, j'ai copi√© le contenu du syst√®me √† l'aide de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinScp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (nous s√©lectionnons le mode SCP lors de la cr√©ation de la connexion). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus loin, vous devez sauvegarder le syst√®me complet, au cas o√π les exp√©riences conduiraient √† de tristes cons√©quences (comme moi, mais je n'ai pas fait de sauvegarde). La </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
m√©moire flash de la passerelle est divis√©e en 4 sections. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lx/kb/qs/lxkbqs0mfj1ggqsaz5hftqbyzpw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est av√©r√© qu'il n'y avait pas non plus beaucoup d'espace libre, alors qu'en m√©moire, il y avait beaucoup de fichiers en double diff√©rents.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ci/sl/5m/cisl5mcfvpafxdna0tzjs2w7iko.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir jou√© pendant quelques heures, j'ai chang√© quelque chose dans le logiciel et la passerelle a cess√© de se charger :) </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voyons maintenant comment faire revivre ce morceau de fer et en remplir quoi que ce soit. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'effectuez des actions que si vous avez une brique!</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Le processeur Imx6ULL contient toutes les informations sous une forme ouverte, toutes les cartes de donn√©es et les manuels de r√©f√©rence sont disponibles sur le site Web du fabricant apr√®s l'enregistrement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
U-boot me chargeait toujours ... Mais pendant que j'essayais de r√©cup√©rer, j'ai accidentellement copi√© une commande suppl√©mentaire et effac√© compl√®tement le nand. Et il s'est av√©r√© que u-boot √©tait √† Nanda. Et il a eu une brique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le processeur prend en charge diff√©rents modes de d√©marrage. Dans le manuel de r√©f√©rence, ils sont tous d√©crits.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nu/dq/qb/nudqqbeastlqyzr8ttgb4cpahti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cartes de d√©veloppement ont g√©n√©ralement des commutateurs, mais il n'y a rien de tel. La fiche technique d√©crit de quel type de processeur il s'agit. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/ca/nx/xbcanxw13rmesy3gosochuueqio.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis les Chinois ont fait un tr√®s beau cadeau aussi. Ils les ont amen√©s √† un endroit tr√®s pratique et les ont presque sign√©s) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la carte √† c√¥t√© du processeur, deux r√©sistances sont soud√©es, l√† o√π les broches du mode de d√©marrage s'ins√®rent. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/mq/ak/vjmqakv9dquslukw8leus3myyra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces deux r√©sistances ne sont que des commutateurs de modes de d√©marrage, par d√©faut, il est d√©fini sur nand, mais en d√©pla√ßant chacune d'elles sur le c√¥t√©, nous obtenons le mode de d√©marrage s√©rie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai transf√©r√© ma passerelle en mode de d√©marrage s√©rie, d'une certaine mani√®re, ce mode est plus pratique pour tester divers micrologiciels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour t√©l√©charger le firmware, un utilitaire propri√©taire de NXP mfgtools est utilis√©. La seule chose √† faire est de pr√©parer un profil pour le processeur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
T√©l√©charger </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mfgtools</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. L'archive est d√©j√† une version pr√©par√©e avec tous les param√®tres n√©cessaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous connectons la passerelle via USB. En mode d'amor√ßage s√©rie, la passerelle essaiera de t√©l√©charger le firmware via l'interface USB et un nouveau p√©riph√©rique HID appara√Ætra sur l'ordinateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mfgtools, √† son tour, vous informera qu'il voit un nouvel appareil. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/dc/hg/xbdchgif-86a8uy3htahr8_xey4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, l'ordinateur ne le voit pas, avec quoi il est connect√©, je ne peux pas le dire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que l'utilitaire l'a vu, cliquez sur D√©marrer et le processus de t√©l√©chargement du micrologiciel commencera. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'utilitaire formatera le nand, inondera les nouveaux ubut, kernel, dtb et rootfs. Les rootfs dans l'archive ont √©t√© compil√©s par un ami Aleksandr Faronov, il a mont√© une compilation Linux propre sur Yocto. Les sections U-boot, Kernel, DTB ont √©t√© retir√©es du firmware natif de la passerelle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet assemblage Linux, seul un syst√®me propre d√©marrera, il n'y aura rien de plus (</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigby ne fonctionne pas encore non plus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que l'utilitaire fonctionne dans mon cas, la passerelle ne fait rien et se charge √©galement, car, comme nous le rappelons, le processeur en mode de d√©marrage s√©rie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, il doit recevoir une image U-boot amor√ßable. </font><font style="vertical-align: inherit;">Dans l'archive avec mfgtools, il y a un utilitaire suppl√©mentaire uuu qui effectue le chargement U-boot dans le Ram de la carte, allons dans le dossier qui le contient. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous fermons mfgtools et reconnectons la passerelle avec une nouvelle, le p√©riph√©rique HID doit √™tre d√©tect√© √† nouveau, apr√®s quoi nous ex√©cutons la commande.</font></font><br>
<br>
<pre><code class="plaintext hljs">uuu u-boot-small.imx</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La carte commencera √† se charger, mais comme elle n'a pas d'env, elle se l√®vera apr√®s le chargement de U-boot. </font><font style="vertical-align: inherit;">Dans la console de passerelle, nous ex√©cutons deux commandes, nous enregistrons ENV pour le chargement.</font></font><br>
<br>
<pre><code class="plaintext hljs">setenv bootargs 'console=ttymxc0,115200 ubi.mtd=3 root=ubi0:rootfs rootfstype=ubifs cma=96M mtdparts=gpmi-nand:3m(boot),7m(kernel),1m(dtb),-(rootfs)'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et d√©marrez le d√©marrage de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©marrage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la passerelle commence le chargement √† partir de nanda et du firmware que nous avons t√©l√©charg√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9v/oi/n5/9voin5jgztxajypsqjkol1ki-p0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l‚Äôensemble, c‚Äôest tout. </font><font style="vertical-align: inherit;">Dans mfgtools, dans le dossier \ Profiles \ Linux \ OS Firmware \ files, tous les fichiers du micrologiciel sont localis√©s, en remplacement desquels vous pouvez charger n'importe quel syst√®me compatible. </font><font style="vertical-align: inherit;">J'ai essay√© de t√©l√©charger openwrt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wf/qy/ye/wfqyyekyy177yvbh0uczs_aryoq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le syst√®me est en cours de chargement, mais je n'ai toujours pas compris comment glisser le bon noyau et o√π l'obtenir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re que gr√¢ce √† des efforts conjoints, nous parviendrons toujours √† la conclusion logique de cette passerelle) </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sauvegarde des r√©pertoires de la passerelle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T√©l√©gramme pour discussion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr494278/index.html">EF Core + Oracle: comment rendre les migrations idempotentes</a></li>
<li><a href="../fr494286/index.html">Embox RTOS sur Raspberry Pi</a></li>
<li><a href="../fr494290/index.html">#YAMYWork. Une d√©cision qui peut √™tre juste</a></li>
<li><a href="../fr494292/index.html">Wrike: 5 ans avec OKR</a></li>
<li><a href="../fr494294/index.html">Impression 3D certifi√©e pour les industries p√©troli√®re et gazi√®re et marine</a></li>
<li><a href="../fr494298/index.html">Envoy√© pour les petits</a></li>
<li><a href="../fr494300/index.html">D√©l√©gation de la gestion de session RDP</a></li>
<li><a href="../fr494302/index.html">Objectifs du jour comme outil de gestion d'√©quipe</a></li>
<li><a href="../fr494304/index.html">30 conseils UX en r√©alit√© augment√©e</a></li>
<li><a href="../fr494308/index.html">Ce qui vous attend dans Space 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>