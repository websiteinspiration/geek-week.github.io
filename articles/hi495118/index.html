<!doctype html>
<html class="no-js" lang="hi">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯСйЁЯП╛тАНЁЯПн ЁЯЦХЁЯП╝ ЁЯСйЁЯП╛тАНЁЯТ╗ рдбреЗрдореЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдбреЙрдХреНрдЯреНрд░рд┐рди ODM рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛рдПрдВ ЁЯзФ ЁЯСп тЦля╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдореИрдВ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рдЫреЛрдЯреЗ PHP рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ Doctrine ODM рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдиреЗ рдЕрдиреБрднрд╡ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ рдЬрд┐рд╕рдореЗрдВ рдореБрдЦреНрдп рдХреЛрдб рдЖрдзрд╛рд░ рдбреЗрдореЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>рдбреЗрдореЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдбреЙрдХреНрдЯреНрд░рд┐рди ODM рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛рдПрдВ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495118/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореИрдВ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рдЫреЛрдЯреЗ PHP рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ Doctrine ODM рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдиреЗ рдЕрдиреБрднрд╡ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ рдЬрд┐рд╕рдореЗрдВ рдореБрдЦреНрдп рдХреЛрдб рдЖрдзрд╛рд░ рдбреЗрдореЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИред </font><font style="vertical-align: inherit;">рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рд╣рдо рдХреИрд╕реЗ Yct2 рдХреЛ Doctrine ODM рдЙрдкрд╡рд╛рд╕ рдХрд┐рдпрд╛ред </font><font style="vertical-align: inherit;">рдореИрдВ рдЖрдкрдХреЛ рддреБрд░рдВрдд рдЪреЗрддрд╛рд╡рдиреА рджреЗрддрд╛ рд╣реВрдВ - рдХрд╣рд╛рдиреА рдмрд╣реБрдд рдердХрд╛рдК рд╣реЛрдЧреА рдФрд░ рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛ рдХреЗрд╡рд▓ рдЙрди рд▓реЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рджрд┐рд▓рдЪрд╕реНрдк рд╣реЛрдЧреА рдЬреЛ рдбреЗрдореЙрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдореЗрдВ рдбреЙрдХреНрдЯреНрд░рд┐рди ODM рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддреЗ рд╕рдордп рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕рдорд╕реНрдпрд╛рдУрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░ рдЪреБрдХреЗ рд╣реИрдВред</font></font></p><a name="habracut"></a><br>
<h3 id="kuda-budem-prikruchivat"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдХрд╣рд╛рдБ рдлрдБрд╕реЗрдВрдЧреЗ</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рдЧрднрдЧ 6 рд╕рд╛рд▓ рдкрд╣рд▓реЗ, рдЙрдиреНрд╣реЛрдВрдиреЗ рдореБрдЭреЗ рдХрд╛рд░реНрдп рд╕реМрдВрдкрд╛: рдПрдХ рдореЛрдиреЛрд▓рд┐рде </font></font><code>Yii1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реЗ рдХреЛрдб рдХреЗ </font><font style="vertical-align: inherit;">рдПрдХ </font><font style="vertical-align: inherit;">рдЯреБрдХрдбрд╝реЗ рдХреЛ рдПрдХ рдЕрд▓рдЧ рд╕реЗрд╡рд╛ рдореЗрдВ </font><font style="vertical-align: inherit;">рдХрд╛рдЯрдиреЗ рдХреЗ рд▓рд┐рдП </font><font style="vertical-align: inherit;">ред рддреБрд░рдВрдд рдкреВрд░рд╛ рдХрд┐рдпрд╛ рд╣реБрдЖ рдХрд╛рдоред рдлреНрд░реЗрдорд╡рд░реНрдХ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдирд╣реАрдВ рдЪреБрдирд╛, рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ </font></font><code>Yii</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореБрдЭреЗ рдХреБрдЫ рднреА рдкрддрд╛ рдирд╣реАрдВ рд╣реИ, рдФрд░ рдлрд┐рд░ рдЙрдиреНрд╣реЛрдВрдиреЗ рдПрдХ рдЖрд╕рдиреНрди рд░рд┐рд▓реАрдЬ рдХреА рдШреЛрд╖рдгрд╛ рдХреА </font></font><code>Yii2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рдЬреЛ рдЙрд╕ рд╕рдордп рдмрд╣реБрдд рд╣реА рд╕реНрдЯрд╛рдЗрд▓рд┐рд╢ / рдлреИрд╢рдиреЗрдмрд▓ / рдпреБрд╡рд╛ рд▓рдЧ рд░рд╣рд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЗрд╕ рдврд╛рдВрдЪреЗ рдХреЗ рдкрд╣рд▓реЗ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рдЬреНрдЮрд╛рди рдиреЗ рджреВрд╕рд░реЗ рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реАрдорд╛ рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреАред MongoDB рднреА рдлреИрд╢рдиреЗрдмрд▓ рдерд╛, рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╣рдо рдкрд╣рд▓реЗ рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рдереЗ рдФрд░ </font></font><code>Yii1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рдЕрд▓рдЧ рд╡рд┐рд╕реНрддрд╛рд░ рдХреЗ рд╕рд╛рде </font><font style="vertical-align: inherit;">рдХрд╛рдо рдХрд┐рдпрд╛ </font></font><code>Yii2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдерд╛ </font><font style="vertical-align: inherit;">, рд▓реЗрдХрд┐рди </font><font style="vertical-align: inherit;">рдЗрд╕реЗ рдмреЙрдХреНрд╕ рд╕реЗ рдмрд╛рд╣рд░ рдХрд╛ рд╕рдорд░реНрдерди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкреНрд░рд╛рд░рдВрдн рдореЗрдВ, рдорд╛рдЗрдХреНрд░реЛрд╕реЗрд╡рд░ рдХрд╛рдлреА рд╕рд░рд▓ рдерд╛: рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рд╕реЗ рдлрд╛рдЗрд▓реЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдФрд░ рдЙрдиреНрд╣реЗрдВ рд▓рдЧрд╛рддрд╛рд░ рднрдВрдбрд╛рд░рдг рдореЗрдВ рд░рдЦрдирд╛ рдЖрд╡рд╢реНрдпрдХ рдерд╛, рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдЗрди рдлрд╛рдЗрд▓реЛрдВ рдХрд╛ рд░рд┐рдХреЙрд░реНрдб рд░рдЦреЗрдВ, рдЗрди рдлрд╛рдЗрд▓реЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдЬрд╛рд░реА рдХрд░реЗрдВ рдФрд░ рдПрдкреАрдЖрдИ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рдЬрд╡рд╛рдм рдореЗрдВ рдЙрдиреНрд╣реЗрдВ рд▓рд┐рдВрдХ рдХрд░реЗрдВред </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдордп рдХреЗ рд╕рд╛рде, рдпрд╣ рд╕реВрдХреНрд╖реНрдо рд╕реЗрд╡рд╛ рдмрдврд╝рдиреЗ рд▓рдЧреА: рд╡реАрдбрд┐рдпреЛ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг, рд╡рд╛рдпрд░рд╕ рдХреА рдЬрд╛рдБрдЪ, рд╡рд┐рднрд┐рдиреНрди рдХреНрд╖реЗрддреНрд░реЛрдВ рдореЗрдВ рд╡рд┐рддрд░рд┐рдд рднрдВрдбрд╛рд░рдг (рдПрдХ рд▓рд╛ рд╕реАрдбреАрдПрди) рджрд┐рдЦрд╛рдИ рджрд┐рдпрд╛ред </font><font style="vertical-align: inherit;">рд╕рдордп рдЬрд▓реНрджреА рд╕реЗ рдЧреБрдЬрд░ рдЧрдпрд╛, рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕рдХреНрд░рд┐рдп рд░реВрдк рд╕реЗ рд╡рд┐рдХрд╕рд┐рдд рд╣реБрдИ рдФрд░ рдпрд╣рд╛рдВ рддрдХ тАЛтАЛрдХрд┐ рд░рд┐рдлреИрдХреНрдЯрд┐рдВрдЧ рднреА рд╣реБрдИ, рд▓реЗрдХрд┐рди рдХреБрдЫ рдмрд┐рдВрджреБрдУрдВ рдкрд░, рдирдП рд░реБрдЭрд╛рдиреЛрдВ рдФрд░ рдкреЗрд╢реЗрд╡рд░ рд╡рд┐рдХрд╛рд╕ рдХреЗ рдХрд╛рд░рдг рднреА, рдЗрд╕ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рддреЗ рд╕рдордп рдХреБрдЫ рдЕрд╕реБрд╡рд┐рдзрд╛ рдХрд╛ рдПрд╣рд╕рд╛рд╕ рд╣реБрдЖред </font><font style="vertical-align: inherit;">рдЗрд╕ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдкрд░ рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рдХрдо рдФрд░ рдХрдо рд╣реЛрддреА рдЧрдИ рдФрд░ рдореИрдВрдиреЗ рдЧрдВрднреАрд░рддрд╛ рд╕реЗ рд╕реЛрдЪрд╛ред</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрд╕реБрд╡рд┐рдзрд╛ рдХреЗ рдХрд╛рд░рдгреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдВрдмреЗрдбреЗрдб рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЗ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╕рд╛рде рдЖрд╕рд╛рдиреА рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрдерддрд╛ рдереА </font><font style="vertical-align: inherit;">ред рдЕрд╕реБрд╡рд┐рдзрд╛ рдпрд╣ рдереА рдХрд┐ рдореБрдЭреЗ рджреЗрд╢реА </font></font><code>PHP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рд░рдгрд┐рдпреЛрдВ </font><font style="vertical-align: inherit;">рд╕реЗ рдирд┐рдкрдЯрдирд╛ рдерд╛ </font><font style="vertical-align: inherit;">ред рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдЗрд╕рд╕реЗ рд╕рдорд╕реНрдпрд╛рдПрдВ рдирд╣реАрдВ рд╣реБрдИрдВ, рд▓реЗрдХрд┐рди рдЬреИрд╕реЗ-рдЬреИрд╕реЗ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдмрдврд╝рддреА рдЧрдИ, рдпреЗ рд╕рд░рдгрд┐рдпрд╛рдВ рд╣рд░ рдЬрдЧрд╣ рджрд┐рдЦрд╛рдИ рджреЗрдиреЗ рд▓рдЧреАрдВ, рд╡реЗ рдЕрдзрд┐рдХ рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛ рдЧрдИрдВ, рдФрд░ рдкреБрд░рд╛рдиреЗ рдХреЛрдб рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬреНрдЮрд╛рди рднреВрд▓ рдЧрдпрд╛ рдФрд░ рд╣рд░ рдЪреАрдЬ рдХреА рд╕рдордЭ рдмрд┐рдЧрдбрд╝ рдЧрдИред рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рдореИрдВ рд╕реБрдВрджрд░ рд╡рд╕реНрддреБрдУрдВ рдХреЛ рд░рдЦрдирд╛ рдЪрд╛рд╣рддрд╛ рдерд╛, рди рдХрд┐ рдЙрди рдХреНрд╖реЗрддреНрд░реЛрдВ рдХрд╛ рдПрдХ рд╕рдордЭрджрд╛рд░ рд╕реЗрдЯ рдЬрд┐рдирдХреЗ рд╕реВрдЪрдХрд╛рдВрдХ рдХреЛ рд▓рдЧрд╛рддрд╛рд░ рдпрд╛рдж рд░рдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред рдореИрдВ рдЗрд╕ рддрдереНрдп рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реВрдВ рдХрд┐ рдЗрд╕ рддрд░рд╣ рдХреЗ рдХреЛрдб рдмрд╣реБрдд рдЦрд░рд╛рдм рддрд░реАрдХреЗ рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реБрдП рд╣реИрдВред</font></font></p><br>
<p>   <code>PHP</code>  7-            ,     .   <code>ActiveRecord</code> <code>Yii2</code>    тАФ     ""  ,  ,  phpdoc.         <code>MongoDB</code>,             -           , -   <code>{user_id : '12'}</code></p><br>
<p>   ,         .  -      ,  Yii2 . , ,       ,    ,    ,      .</p><br>
<h3 id="perehod-na-drugoy-freymvork">   </h3><br>
<p>              ,   ,         <code>MongoDB</code>.<br>
     <code>Symfony</code>      <code>Doctrine ORM</code>,      <code>Doctrine ODM</code> тАФ  <code>ORM</code>   <code>MongoDB</code>.</p><br>
<p>      Yii2  Symfony  ,           ,        :<br>
- тАФ    ,   ,            .<br>
- тАФ      <code>ActiveRecord</code>  " "   <code>Yii2</code></p><br>
<p>     ,    <code>ActiveRecord</code>   <code>Doctrine ODM</code>,         .           ,        ORM  . </p><br>
<p>    .        Doctrine  <code>DocumentManager</code> ( EntityManager   Doctrine ORM).      " ".</p><br>
<p>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">Dependency Injection Container</a>    <code>Yii2</code>    ,             .</p><br>
<p> <code>Yii2</code>      <code>DataProvider'a</code>.     -,             CRUD-   .   "  "      .           ,    <code>Yii2</code>.      ,     ,    тАФ ,       .</p><br>
<p>   ,  Doctrine    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">UnitOfWork</a>               ,          . </p><br>
<h3 id="ispolzuem-globalnyy-menedzher-dokumentov">   </h3><br>
<p>        ,    :   DI-          ,        .        - ,   Symfony    . </p><br>
<p>      ,        :</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">while</span> (!<span class="hljs-keyword">$this</span>-&gt;isShuttingDown()) {
    <span class="hljs-comment">//  Task,  ,     </span>
    <span class="hljs-comment">//  MANAGED    ,</span>
    <span class="hljs-comment">//     </span>
    $task = <span class="hljs-keyword">$this</span>-&gt;taskProvider-&gt;getNextTask();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">//   -  , ,  </span>
        <span class="hljs-keyword">$this</span>-&gt;someService-&gt;runTask($task);<font></font>
    } <span class="hljs-keyword">catch</span> (SomeException $e) {
        <span class="hljs-comment">//    :       </span>
        <span class="hljs-comment">//     MANAGED,      </span>
        <span class="hljs-comment">//       -     </span>
        <span class="hljs-keyword">$this</span>-&gt;switchTaskToError($task, $e);<font></font>
    }<font></font>
}</code></pre><br>
<p>,         -     dirty (    flush()          ),      ,               ,           .</p><br>
<p>  тАФ    <code>clear()</code>     ""     .   ,    ,             .        <code>clear()</code>      ,        ,    ,   <code>$this-&gt;someService-&gt;runTask($task);</code></p><br>
<h3 id="otkaz-ot-globalnogo-menedzhera-dokumentov">    </h3><br>
<p>   ,            (    ,     тАФ ),      .          .   ,     ,         .        ,               ,     .           . </p><br>
<p>     :</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">while</span> (!<span class="hljs-keyword">$this</span>-&gt;isShuttingDown()) {
    <span class="hljs-comment">//  ,  , </span>
    <span class="hljs-comment">//   -  ,   </span>
    <span class="hljs-comment">//    detached,      , </span>
    <span class="hljs-comment">//      </span>
    $task = <span class="hljs-keyword">$this</span>-&gt;taskProvider-&gt;getNextTask();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">//   -     </span>
        <span class="hljs-keyword">$this</span>-&gt;someService-&gt;runTask($task);<font></font>
    } <span class="hljs-keyword">catch</span> (SomeException $e) {
        <span class="hljs-comment">//    ,  -   </span>
        <span class="hljs-keyword">$this</span>-&gt;switchTaskToError($task, $e);<font></font>
    }<font></font>
}</code></pre><br>
<p> <code>taskProvider</code>  <code>someService</code>     ,    . </p><br>
<p>       <code>merge</code>.  <code>runTask()</code>    :</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runTask</span>(<span class="hljs-params">Task $task</span>) </span>{<font></font>
    $dm = $thic-&gt;dmFactory-&gt;createDocumentManager();<font></font>
    $task = $dm-&gt;merge($task);<font></font>
    ....<font></font>
    $task-&gt;setStatus(Task::STATUS_OK);<font></font>
    $dm-&gt;flush();<font></font>
}</code></pre><br>
<p>  <code>switchTaskToError()</code> : </p><br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">switchTaskToError</span>(<span class="hljs-params">Task $task, <span class="hljs-built_in">Throwable</span> $</span>) </span>{<font></font>
    $dm = <span class="hljs-keyword">$this</span>-&gt;dmFactory-&gt;createDocumentManager();<font></font>
    $task = $dm-&gt;merge($task);<font></font>
    $task-&gt;setStatus(Task::STATUS_ERROR);<font></font>
    $task-&gt;setError($e-&gt;getMessage());<font></font>
    $dm-&gt;flush();<font></font>
}</code></pre><br>
<p>   ,    <code>$dm</code>             .</p><br>
<p>       ,      ,    -    .  ,    :</p><br>
<pre><code class="php hljs">$tasks = <span class="hljs-keyword">$this</span>-&gt;taskProvider-&gt;getProblemTasks();<font></font>
$dm = $thic-&gt;dmFactory-&gt;createDocumentManager();<font></font>
<span class="hljs-keyword">foreach</span> ($tasks <span class="hljs-keyword">as</span> $task) {<font></font>
     $task = $dm-&gt;merge($task);<font></font>
     $task-&gt;setState(..);<font></font>
}<font></font>
$dm-&gt;flush();</code></pre><br>
<p>  <code>getProblemTasks</code>    ,        ,        ""    ,    <code>Task</code>   <code>merge()</code>.  ,  <code>merge()</code>     тАФ ..      ,       . </p><br>
<p>   ,        ,       :</p><br>
<pre><code class="php hljs">$dm = $thic-&gt;dmFactory-&gt;createDocumentManager();<font></font>
$tasks = <span class="hljs-keyword">$this</span>-&gt;taskProvider-&gt;getProblemTasks($dm);
<span class="hljs-keyword">foreach</span> ($tasks <span class="hljs-keyword">as</span> $task) {<font></font>
     $task-&gt;setState(..);<font></font>
}<font></font>
$dm-&gt;flush();</code></pre><br>
<p>          .</p><br>
<h3 id="kak-eto-sdelano-v-jpa-i-prichem-on-tut-voobsche">    JPA     </h3><br>
<p>    ,  Doctrine    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">JPA</a>:    ,   <code>UnitOfWork</code>,     (managed, detached  ..).   JPA   ,     , .   ,        тАФ .            (Spring Framework          ).     JPA  , , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"></a>. </p><br>
<p>  ,       ,   .    -      ,    ,    -    (?      ),           (<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"> </a>).      ,      ,             .</p><br>
<p>    ,       hibernate   Doctrine.</p><br>
<h3 id="sessii-v-doctrine-odm">  Doctrine ODM</h3><br>
<p>           " doctrine"     ,  -     http    ,     ,   ,   .</p><br>
<p>,            .      ,     .                  .       ,    :</p><br>
<pre><code class="php hljs">$session = <span class="hljs-keyword">$this</span>-&gt;sessionManager-&gt;createNewSession();
<span class="hljs-keyword">try</span> {<font></font>
    $dm= $session-&gt;getDocumentManager();<font></font>
    $tasks = <span class="hljs-keyword">$this</span>-&gt;taskProvider-&gt;getProblemTasks();
    <span class="hljs-keyword">foreach</span> ($tasks <span class="hljs-keyword">as</span> $task) {<font></font>
        $task-&gt;setState(..);<font></font>
    }<font></font>
    $dm-&gt;flush();<font></font>
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">$this</span>-&gt;sessionManager-&gt;close($session);<font></font>
}</code></pre><br>
<p>  <code>getProblemTasks</code></p><br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getProblemTasks</span>(<span class="hljs-params"></span>): <span class="hljs-title">array</span>
</span>{<font></font>
    $repo = <span class="hljs-keyword">$this</span>-&gt;sessionManager<font></font>
                      -&gt;getCurrentSession()<font></font>
                      -&gt;getDocumentManager()<font></font>
                      -&gt;getRepository(Task::class);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $repo-&gt;findBy([<span class="hljs-string">'status'</span> =&gt; Task::STATUS_ERROR]);<font></font>
}</code></pre><br>
<p> ,     ,   ,          ,            . </p><br>
<p>            :</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">switchTaskToError</span>(<span class="hljs-params">Task $task, <span class="hljs-built_in">Throwable</span> $</span>) </span>{
    <span class="hljs-comment">//   ,  ,    </span>
    $session <span class="hljs-keyword">$this</span>-&gt;sessionManager-&gt;createNewSession();<font></font>
    $dm = $session-&gt;getDocumentManager();<font></font>
    <span class="hljs-keyword">try</span> {<font></font>
        $task = $dm-&gt;merge($task);<font></font>
        $task-&gt;setStatus(Task::STATUS_ERROR);<font></font>
        $task-&gt;setError($e-&gt;getMessage());<font></font>
        $dm-&gt;flush();<font></font>
    <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">$this</span>-&gt;sessionManager-&gt;close($session);<font></font>
    }<font></font>
}</code></pre><br>
<p>   ,      ,   ,         <code>wrap</code>,       ,    .</p><br>
<p>  ,     3   <code>SessionManager</code></p><br>
<p><code>createNewSession</code> тАФ   ,  ""   .<br>
<code>getCurrentSession</code> тАФ          .<br>
<code>close</code> тАФ  </p><br>
<p>    ,         (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">php-ds</a>).</p><br>
<p>  :<br>
<code>createNewSession</code> тАФ   ,      .<br>
<code>getCurrentSession</code> тАФ     ,  ,  .<br>
<code>close</code> тАФ    .</p><br>
<p>      ,        ,          ,     .</p><br>
<p>    <code>wrap</code>,       ,        :</p><br>
<pre><code class="php hljs"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">switchTaskToError</span>(<span class="hljs-params">Task $task, <span class="hljs-built_in">Throwable</span> $</span>) </span>{
    <span class="hljs-keyword">$this</span>-&gt;sessionManager-&gt;wrapBySession(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">DocumentManager $dm</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$task, $e</span>) </span>{<font></font>
        $task = $dm-&gt;merge($task);<font></font>
        $task-&gt;setStatus(Task::STATUS_ERROR);<font></font>
        $task-&gt;setError($e-&gt;getMessage());<font></font>
        $dm-&gt;flush();<font></font>
    });<font></font>
}</code></pre><br>
<h3 id="podytozhivaya"></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рд╛рдорд╛рдиреНрдп рддреМрд░ рдкрд░, рд╕рддреНрд░ рддрдВрддреНрд░ рдХрд╛рдлреА рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдирд┐рдХрд▓рд╛ред </font><font style="vertical-align: inherit;">рдХрдо рд╕реЗ рдХрдо рдЙрд╕рдиреЗ рд╣рдорд╛рд░реА рд╕рднреА рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рд╣рд▓ рдХрд┐рдпрд╛ред </font><font style="vertical-align: inherit;">рдмреЗрд╢рдХ, рдПрдХ рдШреЛрд╖рдгрд╛рддреНрдордХ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рддреНрд░реЛрдВ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рдирд╛ рднреА рдЕрдЪреНрдЫрд╛ рд╣реЛрдЧрд╛, рдЬреИрд╕рд╛ рдХрд┐ рд╕реНрдкреНрд░рд┐рдВрдЧ рдлреНрд░реЗрдорд╡рд░реНрдХ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдПред </font><font style="vertical-align: inherit;">рдпрд╣ рдЕрддрд┐рд░реЗрдХ рдХреЛрдб рдХреЗ рд░реВрдк рдореЗрдВ рдУрд╡рд░рд╣реЗрдб рдХреЛ рдХрд╛рдлреА рдХрдо рдХрд░ рджреЗрдЧрд╛, рд▓реЗрдХрд┐рди рдлрд┐рд▓рд╣рд╛рд▓ рдореИрдВ рдХрд▓реНрдкрдирд╛ рднреА рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ рдХрд┐ рдпрд╣ PHP рдореЗрдВ рдХреИрд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi495108/index.html">рдХрд┐рд╕реА рдХрд░реНрдордЪрд╛рд░реА рдХреЛ рд░рдЦрдиреЗ, рдмрдврд╝рд╛рдиреЗ рдФрд░ рдЖрдЧ рд▓рдЧрд╛рдиреЗ рдореЗрдВ рдХрд┐рддрдирд╛ рдЦрд░реНрдЪ рд╣реЛрддрд╛ рд╣реИред рдПрдЬрдЪрд░ рд░реЗрдбрдордбреНрд░рд╛рдмреЛрдЯ рдХреИрд▓рдХреБрд▓реЗрдЯрд░</a></li>
<li><a href="../hi495110/index.html">рдкреБрд╢реНрдХрд┐рди рдХреА рд╣реБрдХреБрдо рдХреА рд░рд╛рдиреА рдореЗрдВ рдХреНрдпрд╛ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рд╡реЗ рдХреНрдпрд╛ рдЦреЗрд▓рддреЗ рд╣реИрдВ?</a></li>
<li><a href="../hi495112/index.html">рд╕рд╛рдордЧреНрд░реА-рдЖрдзрд╛рд░рд┐рдд рдЯреИрдЧрд┐рдВрдЧ рдореЗрдВ рд╣рд░реНрдл рдХрд▓реЗрдХреНрдЯрд░: рдХреНрдпреЛрдВ рдФрд░ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ?</a></li>
<li><a href="../hi495114/index.html">рдЖрддреНрдо-рдЕрд▓рдЧрд╛рд╡: рдпрджрд┐ рдЖрдк рдЯрд╣рд▓рдиреЗ рдЬрд╛рддреЗ рд╣реИрдВ рддреЛ рдХреЛрд░реЛрдирд╛рд╡рд╛рдпрд░рд╕ рд╣реЛрдиреЗ рдХреА рдХрд┐рддрдиреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ</a></li>
<li><a href="../hi495116/index.html">рдиреИрдиреЛ рд╕реЗ рдореИрдХреНрд░реЛ рддрдХ рд╕рдм рдХреБрдЫ рдХреИрд╕реЗ рдЫрд┐рдкрд╛рдПрдВ: рд╡реИрдЬреНрдЮрд╛рдирд┐рдХреЛрдВ рдиреЗ "рдЕрджрд░реНрд╢рди рдХреЗ рд╕рд┐рджреНрдзрд╛рдВрдд" рдХреЗ рд╕рд╛рдорд╛рдиреНрдп рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ рдХреЛ рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ рд╣реИ</a></li>
<li><a href="../hi495120/index.html">рдпрд╣ OpenBSD рд╕реБрд░рдХреНрд╖рд╛ рдкрд░ рдкреБрдирд░реНрд╡рд┐рдЪрд╛рд░ рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИ</a></li>
<li><a href="../hi495124/index.html">рдореИрдХрдмреБрдХ рдЪреЛрд░реА рдХреИрд╕реЗ рдХрд░реЗрдВ</a></li>
<li><a href="../hi495128/index.html">рдХреНрдпрд╛ рдПрдХ рдорд╛рдирд╡ рдЪреЗрд╣рд░рд╛ рд╡реАрдкреАрдПрди рдореМрдЬреВрдж рд╣реИ?</a></li>
<li><a href="../hi495130/index.html">рд╕реНрдХрд╛рд▓рд╛ рдореЗрдВ рдЫрдВрдЯрдиреА - рдмрд┐рд▓реНрд▓рд┐рдпреЛрдВ рдкрд░ рдПрдХ рдЙрджрд╛рд╣рд░рдг</a></li>
<li><a href="../hi495138/index.html">рдХреЛрд░реЛрдиреЛрд╡рд╛рдпрд░рд╕ рдХреЗ рдмрд╛рдж рд╕рдорд╛рдЬ рдФрд░ рддрдХрдиреАрдХ рдХреИрд╕реЗ рдмрджрд▓реЗрдВрдЧреЗред рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рд░рд╛рдп</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>