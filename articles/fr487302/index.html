<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🔧 🤲🏻 🤙🏻 Surveillance des erreurs et des événements dans le journal PostgreSQL (grok_exporter) 🌆 🧞 👵🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, collègues et habretchiki! Aujourd'hui, je voudrais partager avec vous une petite note sur la façon dont vous pouvez organiser la surveillance...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Surveillance des erreurs et des événements dans le journal PostgreSQL (grok_exporter)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487302/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, collègues et habretchiki! </font><font style="vertical-align: inherit;">Aujourd'hui, je voudrais partager avec vous une petite note sur la façon dont vous pouvez organiser la surveillance opérationnelle des erreurs et des événements qui apparaissent dans le journal PostgreSQL en utilisant Prometheus et l'exportateur de métriques grok_exporter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je dois dire tout de suite qu'il s'agit bien sûr d'un cas particulier d'utilisation de cet exportateur. </font><font style="vertical-align: inherit;">Alors pourquoi est-il nécessaire et qui pourrait être intéressé?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qui en a besoin?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si Prometheus est déjà présent dans votre infrastructure et que la création d'une infrastructure distincte pour la collecte et l'analyse des journaux, tels que ELK ou Greylog, est coûteuse et peu pratique (s'il n'y a pas de Prometheus, ce n'est pas un problème, c'est facile et rapide à installer). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'outil sera utile non seulement pour les administrateurs de base de données, mais aussi pour les administrateurs d'application, en général, pour tous ceux qui travaillent d'une manière ou d'une autre avec les journaux d'application. </font><font style="vertical-align: inherit;">Il vous permet d'obtenir rapidement des informations sur le comportement des indépendants et d'avoir un certain point de référence pour une analyse plus approfondie de la situation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À quoi tout cela sert-il?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La surveillance des journaux vous permettra d'avoir une image plus complète et de répondre plus rapidement aux problèmes émergents, qu'il s'agisse de tentatives d'autorisation (y compris infructueuses), de diverses erreurs ou d'événements spécifiques. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y a une bonne liste ici, formée par catégories d'événements (voir la section Log Event Categories), elle peut être utilisée pour créer des règles dans Prometheus.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exportateur de métriques </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter vous</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permet de lire les données non structurées de la source, de les convertir en données structurées, conformément aux règles, et de les renvoyer sous forme de métriques dans un format que Prometheus comprend. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exportateur a été créé à l'image d'un plug-in dans ELK </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugins-filters-grok</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui vous permet d'utiliser un ensemble de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modèles</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">plugins-filters-grok</font></a><font style="vertical-align: inherit;"> tels quels.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'installation est simple et directe. </font><font style="vertical-align: inherit;">Pour ce faire, il suffit de suivre le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lien</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de télécharger la version que vous aimez (et oui, ce sont toutes des versions préliminaires, et les dernières versions sont encore au stade de la version candidate) et décompressez l'archive résultante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, nous obtenons l'ensemble suivant:</font></font><br>
<br>
<pre><code class="plaintext hljs">grok_exporter-1.0.0.RC3.linux-amd64<font></font>
├── patterns<font></font>
│&nbsp;&nbsp; ├── ruby<font></font>
│&nbsp;&nbsp; ├── redis<font></font>
│&nbsp;&nbsp; ├── rails<font></font>
│&nbsp;&nbsp; ├── postgresql<font></font>
│&nbsp;&nbsp; ├── nagios<font></font>
│&nbsp;&nbsp; ├── mongodb<font></font>
│&nbsp;&nbsp; ├── mcollective-patterns<font></font>
│&nbsp;&nbsp; ├── mcollective<font></font>
│&nbsp;&nbsp; ├── linux-syslog<font></font>
│&nbsp;&nbsp; ├── junos<font></font>
│&nbsp;&nbsp; ├── java<font></font>
│&nbsp;&nbsp; ├── haproxy<font></font>
│&nbsp;&nbsp; ├── grok-patterns<font></font>
│&nbsp;&nbsp; ├── firewalls<font></font>
│&nbsp;&nbsp; ├── exim<font></font>
│&nbsp;&nbsp; ├── bro<font></font>
│&nbsp;&nbsp; ├── bacula<font></font>
│&nbsp;&nbsp; └── aws<font></font>
├── grok_exporter<font></font>
└── example<font></font>
    ├── exim-rejected-RCPT-examples.log<font></font>
    ├── config.yml<font></font>
    └── config_logstash_http_input_ipv6.yml<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
où:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - exécutable d'exportateur</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">motifs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - contient un ensemble de motifs</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemple</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - contient un ensemble de données de test et un exemple de fichier de configuration</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour démarrer l'exportateur, exécutez simplement le fichier exécutable. </font><font style="vertical-align: inherit;">Le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuration </font><b><font style="vertical-align: inherit;">config.yml</font></b><font style="vertical-align: inherit;"> est recherché dans le répertoire à partir duquel l'application est lancée ou son emplacement est spécifié par l'option </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-config</font></font></b></p><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation et préparation au travail</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></h3><br>
<p>,      PostgreSQL.  :</p><br>
<ol>
<li>     grok_exporter    .    ,   pg_reload_conf. <br>
<br>
<ul>
<li> <pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_directory <span class="hljs-keyword">to</span> <span class="hljs-string">'/var/log/postgresql'</span>; </code></pre></li>
<li> <pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_file_mode <span class="hljs-keyword">to</span> <span class="hljs-string">'0644'</span>;</code></pre> </li>
</ul></li>
<li> log_line_prefix,  .      ,    .  : <br>
<br>
<pre><code class="sql hljs"> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_line_prefix <span class="hljs-keyword">to</span> <span class="hljs-string">'%t datname:%d,client:%h,app:%a,usename:%u,session:%c '</span>;</code></pre></li>
</ol><br>
<h3>grok_exporter</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éditerons le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> modèle </font><b><font style="vertical-align: inherit;">patterns / postgresql</font></b><font style="vertical-align: inherit;"> conformément au format de notre fichier journal et ajouterons des constructions auxiliaires. </font><font style="vertical-align: inherit;">Je souligne une fois de plus que la syntaxe des modèles est entièrement cohérente avec celle utilisée dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugins-filters-grok</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , par conséquent, pour tous les problèmes liés à la syntaxe, vous pouvez et devez consulter sa documentation. </font><font style="vertical-align: inherit;">Alors, apportons notre modèle pour PostgreSQL au formulaire (le fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patterns / grok-patterns</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contient déjà un grand ensemble de modèles de base):</font></font><br>
<br>
<pre><code class="plaintext hljs">#     - postgresql<font></font>
PG_TIMESTAMP %{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND} [A-Z]{3,4}<font></font>
<font></font>
#    <font></font>
PG_ERROR_PATTERN (ERROR|WARNING|FATAL|PANIC)<font></font>
<font></font>
# log_line_prefix   - PostgreSQL<font></font>
PG_PREFIX %{PG_TIMESTAMP} datname:(%{DATA:datname})?,client:(%{DATA:client_host})?,app:(%{DATA:app_name})?,usename:(%{USER:usename})?,session:(%{DATA:session})?<font></font>
<font></font>
#    log_level     <font></font>
PG_ERROR_LEVEL %{PG_ERROR_PATTERN:log_level}:<font></font>
<font></font>
#    <font></font>
PG_EVENT_AUTH LOG:  connection authorized:<font></font>
<font></font>
#      SIGHUP,   <font></font>
PG_EVENT_RELOAD LOG:  received SIGHUP, reloading configuration files<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La conception </font></font><code>()?</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet d'indiquer que la valeur est facultative.</font></font></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici, avec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> suffisamment d'exemples, avec des exemples, le processus de création d'un fichier de configuration est décrit. </font><font style="vertical-align: inherit;">Ci-dessous, seul ce qui sera utilisé est indiqué.</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une brève description du fichier de configuration (à partir de la documentation)</font></font></b>
                        <div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le fichier de configuration est un fichier au format YAML et est divisé en sections:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">global</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - paramètres globaux</font></font><br>
<ul>
<li><b>config_version</b> —   .    grok_exporter,   ≥ 1.0.0.RC3,   3<br>
 <b>retention_check_interval</b> —    .    ,   .<br>
</li>
</ul><br>
</li>
<li><b>input</b> —         .<br>
<br>
<ul>
<li><b>type</b> —   .  : file, stdin, webhook.   ,    <b>file</b>;</li>
<li><b>path|paths</b> — c      -(-).   ;</li>
<li><b>readall</b> — ,       .<br>
  <b>true</b> —     ,     .       Prometheus . <br>
  <b>false</b> —      ,        grok_exporter;</li>
<li><b>fail_on_missing_logfile</b> —       -.  <b>true</b> —    ,    ;</li>
</ul></li>
<li><b>imports</b> — ,   ,          .    2,    ,   <b>grok</b>.<br>
<br>
<ul>
<li><b>type</b> —     <b>grok_patterns</b> ()  metrics ();</li>
<li><b>file|dir</b> —  .          , .</li>
</ul><br>
</li>
<li><b>grok_patterns</b> — ,         .</li>
<li><b>metrics</b> —    .   — counter, gauge, histogram, or summary.</li>
<li><b>server</b> —    <br>
<br>
<pre><code class="plaintext hljs">  protocol: https<font></font>
  host: localhost<font></font>
  port: 9144<font></font>
  path: /metrics<font></font>
  cert: /path/to/cert<font></font>
  key: /path/to/key<font></font>
</code></pre><br>
 </li>
</ol><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la syntaxe de la 3ème version du fichier de configuration, il est devenu possible d'importer des métriques à partir de fichiers individuels, cela vous permettra de regrouper les métriques par objectif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, créez le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuration de base </font><b><font style="vertical-align: inherit;">config.yml</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dans ce document, nous: définissons le chemin d'accès aux fichiers journaux de PostgreSQL par masque; </font><font style="vertical-align: inherit;">importer des modèles à partir du répertoire des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modèles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et des métriques à partir du répertoire </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metrics.d</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; </font><font style="vertical-align: inherit;">nous indiquons par quel protocole et sur quel port il est nécessaire de demander des métriques.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config.yml</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">  config_version: 3<font></font>
  retention_check_interval: 10s<font></font>
input:<font></font>
  type: file<font></font>
  path: /var/log/postgresql/postgresql-*.log<font></font>
  readall: false<font></font>
imports:<font></font>
- type: grok_patterns<font></font>
  dir: ./patterns<font></font>
- type: metrics<font></font>
  dir: ./metrics.d<font></font>
server:<font></font>
  protocol: http<font></font>
  port: 9144<font></font>
</code></pre><br>
</div>
                    </div><br>
<p>,   <b>metrics.d</b>      <b>postgresql.yml</b>,       .<br>
<br>
 ,       , ..       (  retention, - 2  30 )    ,    .        <b>retention_check_interval</b>.<br>
<br>
 ,  :<br>
<br>
</p><ul>
<li>       ,        ;</li>
<li>     —   GAUGE  COUNTER,   . ..     GAUGE,         ;</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si cumulatif est défini sur true, les valeurs des métriques avec le même ensemble d'étiquettes seront additionnées, ce qui correspond au comportement attendu. </font><font style="vertical-align: inherit;">Une situation inattendue peut survenir lorsque, à la deuxième demande, vous pouvez obtenir la somme des valeurs de la demande plus la valeur précédente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si cumulatif est défini sur false, s'il existe des métriques avec le même ensemble d'étiquettes, seule la dernière valeur sera affichée;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est avéré que beaucoup de lettres, déroutantes et incompréhensibles par endroits, mais je vais essayer de le révéler dans les exemples ci-dessous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et donc, nous avons un fichier de configuration qui peut retourner quatre mesures, trois compteurs et une valeur arbitraire. </font><font style="vertical-align: inherit;">En fait, les trois premiers considèrent le nombre de correspondances du champ de modèle de correspondance avec les chaînes reçues de la source, le quatrième - affiche la somme des valeurs.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.yaml</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">#  - <font></font>
- type:   counter<font></font>
  name:   pg_grok_error_count<font></font>
  help:   Count of line error<font></font>
  match:  '%{PG_PREFIX} %{PG_ERROR_LEVEL}  %{GREEDYDATA:message}'<font></font>
  labels:<font></font>
    log_level:   '{{.log_level}}'<font></font>
    usename:     '{{.usename}}'<font></font>
    datname:     '{{.datname}}'<font></font>
    app_name:    '{{.app_name}}'<font></font>
    client_host: '{{.client_host}}'<font></font>
    message:     '{{.message}}'<font></font>
<font></font>
#   <font></font>
- type:   counter<font></font>
  name:   pg_grok_auth_succes_count<font></font>
  help:   Count of connections authorized<font></font>
  match:  '%{PG_PREFIX} %{PG_EVENT_AUTH}'<font></font>
  labels:<font></font>
    usename:     '{{.usename}}'<font></font>
    datname:     '{{.datname}}'<font></font>
    app_name:    '{{.app_name}}'<font></font>
    client_host: '{{.client_host}}'<font></font>
<font></font>
#   <font></font>
- type:   counter<font></font>
  name:   pg_grok_reload_conf_count<font></font>
  help:   Count of call pg_reload_conf<font></font>
  match:  '%{PG_PREFIX} %{PG_EVENT_RELOAD}'<font></font>
  labels:<font></font>
    session:     '{{.session}}'<font></font>
<font></font>
#   <font></font>
- type:       gauge<font></font>
  name:       pg_grok_tpm_file_size_bytes<font></font>
  help:       Size of tmp file created by time<font></font>
  match:      '%{PG_PREFIX} %{PG_EVENT_TMP_FILE}'<font></font>
  value:      '{{.size}}'<font></font>
  cumulative: true<font></font>
  retention:  5s<font></font>
  labels:<font></font>
    static:     'temp_file'<font></font>
</code></pre><br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entraine toi</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_error_count</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La métrique compte le nombre d'événements ERREUR, AVERTISSEMENT, FATAL et PANIQUE, selon le modèle. </font><font style="vertical-align: inherit;">Il peut être utile pour la surveillance et l'alerte en cas d'urgence. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez configurer une alerte dans les cas suivants: tentatives d'autorisation infructueuse, dépassement du seuil du nombre d'erreurs par unité de temps, ou lorsque la base de données est dans un état de récupération après un échec, et bien plus encore ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">catégories d'événements de journal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, nous allons configurer une alerte en cas d'échec des tentatives d'autorisation. </font><font style="vertical-align: inherit;">Un exemple d'une tentative de connexion infructueuse dans le fichier journal de PostgreSQL ressemble à ceci:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-20 23:34:53 AEST datname:test,client:127.0.0.1,app:[unknown],usename:test_user,session:5e9da4fd.733 FATAL:  password authentication failed for user "test_user"<font></font>
2020-04-20 23:34:53 AEST datname:test,client:127.0.0.1,app:[unknown],usename:test_user,session:5e9da4fd.733 DETAIL:  Password does not match for user "test_user".<font></font>
        Connection matched pg_hba.conf line 86: "host    all             all             127.0.0.1/32            md5"<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la sortie de grok_exporter, les tentatives d'authentification échouées peuvent être identifiées par l'étiquette de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">message</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contenant l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">authentification par mot de passe de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la sous-chaîne a </font><b><font style="vertical-align: inherit;">échoué pour ...</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
</p><pre><code class="plaintext hljs">pg_grok_error_count{app_name="[unknown]",client_host="127.0.0.1",datname="postgres",log_level="FATAL",message="password authentication failed for user "postgres"", usename="postgres"} 15<font></font>
pg_grok_error_count{app_name="[unknown]",client_host="127.0.0.1",datname="test",log_level="FATAL",message="password authentication failed for user \"test_user\"",usename="test_user"} 5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les données obtenues aideront à formuler une règle pour Prométhée. </font><font style="vertical-align: inherit;">La sensibilité peut être ajustée en fonction de vos propres réalités.</font></font><br>
<br>
<pre><code class="plaintext hljs">groups:<font></font>
- name: AuthAlert<font></font>
  rules:<font></font>
  - alert: AuthFail<font></font>
    expr: sum(rate(pg_grok_error_count{message=~"password authentication failed for user.*"}[1m])) by (instance) &gt; 0.1<font></font>
    for: 30s<font></font>
    labels:<font></font>
      severity: warning<font></font>
    annotations:<font></font>
      summary: Too many fail authorization for {{ $labels.instance }}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_reload_conf_count</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De même, vous pouvez suivre l'exécution de la commande pg_reload_conf. </font><font style="vertical-align: inherit;">De plus, il convient de prêter attention à la liste des libellés, ou plutôt, au fait qu'un seul libellé de session est utilisé. </font><font style="vertical-align: inherit;">Cela est dû au fait que l'événement est créé dans le cadre du processus serveur et non de la session utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le fichier journal de PostgreSQL, cet événement ressemble à ceci:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-21 01:20:26 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  received SIGHUP, reloading configuration files
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceux. </font><font style="vertical-align: inherit;">on peut voir que les étiquettes utilisées dans l'exemple précédent sont vides. </font><font style="vertical-align: inherit;">Dans ce cas, nous utiliserons l'identifiant de session pour l'identification, et il ne changera pas tant que l'instance de PostgreSQL n'aura pas été arrêtée ou redémarrée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une situation similaire sera pour d'autres cas similaires, par exemple, l'arrêt d'une instance:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-21 01:32:52 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  received fast shutdown request<font></font>
2020-04-21 01:32:53 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  database system is shut down<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la sortie de grok_exporter, nous obtenons:</font></font><br>
<br>
<pre><code class="plaintext hljs"># HELP pg_grok_reload_conf_count Count of call pg_reload_conf<font></font>
# TYPE pg_grok_reload_conf_count counter<font></font>
pg_grok_reload_conf_count{session="5e9d9371.564"} 5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La règle de notification, cela ne sert à rien de l’évoquer, elle sera similaire à celle évoquée plus haut.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_tpm_file_size_bytes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faites immédiatement une réserve que cet exemple soit de la catégorie des «chevaux sphériques dans le vide» et soit donné dans une plus large mesure afin de montrer comment vous pouvez changer le comportement des métriques. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le comportement des </font><font style="vertical-align: inherit;">mesures </font><font style="vertical-align: inherit;">de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jauge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut être influencé par la modification des paramètres de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rétention</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cumulatifs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En effet, contrairement à un compteur classique, qui considère le nombre de lignes correspondant au modèle de correspondance, la jauge vous permet d'opérer sur les données du fichier journal. Il s'avère que nous pouvons l'accumuler en augmentant ou en diminuant de la valeur obtenue, ou l'utiliser comme une valeur changeant arbitrairement. Ainsi, dans le premier cas, nous nous intéresserons à l'ampleur de l'incrément, dans le second - la valeur en soi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons quelques exemples:</font></font><br>
<br>
<ol>
<li>    ,     (<b>cumulative: true</b>).      ,    ,     .     ,  <b>retention_check_interval + retention &lt;= scrape_interval</b> —        Prometheus.<br>
<br>
        - PostgreSQL  :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 02:51:15 AEST datname:,client:,app:,usename:,session:5e9dd2f3.1278 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4728.0", size 46931968<font></font>
2020-04-21 02:51:15 AEST datname:,client:,app:,usename:,session:5e9dd2f3.1279 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4729.0", size 46276608<font></font>
2020-04-21 02:51:15 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.14", size 47194112<font></font>
</code></pre><br>
,      :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.40402688e+08
</code></pre><br>
               .<br>
<br>
,       :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.1911168e+07
</code></pre><br>
     :      ,    .</li>
<li><p> ,       ,       (<b>retention</b>)    (<b>cumulative: true</b>)<br>
    ,  - PostgreSQL :</p><br>
<pre><code class="plaintext hljs">2020-04-21 03:03:40 AEST datname:,client:,app:,usename:,session:5e9dd5dc.12c6 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4806.0", size 46260224<font></font>
2020-04-21 03:03:40 AEST datname:,client:,app:,usename:,session:5e9dd5dc.12c5 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4805.0", size 46833664<font></font>
2020-04-21 03:03:40 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.15", size 47316992<font></font>
</code></pre><br>
   :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.40402688e+08
</code></pre><br>
   ,  . :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 03:10:40 AEST datname:,client:,app:,usename:,session:5e9dd76e.1325 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4901.0", size 46776320<font></font>
2020-04-21 03:10:40 AEST datname:,client:,app:,usename:,session:5e9dd76e.1324 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4900.0", size 45768704<font></font>
2020-04-21 03:10:40 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.18", size 47841280<font></font>
</code></pre><br>
    :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 2.80772608e+08
</code></pre><br>
          ,     .       ,    .</li>
<li>     ,   <b>cumulative</b>  <b>false</b>    ,  .<br>
<br>
  :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 03:41:04 AEST datname:,client:,app:,usename:,session:5e9ddea4.1393 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp5011.0", size 11763712<font></font>
2020-04-21 03:41:04 AEST datname:,client:,app:,usename:,session:5e9ddea4.1392 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp5010.0", size 11501568<font></font>
2020-04-21 03:41:04 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.19", size 11911168<font></font>
</code></pre><br>
 :<br>
<br>
<pre><code class="plaintext hljs"># HELP pg_grok_tpm_file_size_bytes Size of tmp file created by time<font></font>
# TYPE pg_grok_tpm_file_size_bytes gauge<font></font>
pg_grok_tpm_file_size_bytes{static="temp_file"} 1.1911168e+07<font></font>
</code></pre><br>
 ,       .  ,            .</li>
</ol><br>
<h1></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sans aucun doute grok_exporter est le bon outil pour surveiller les applications. </font><font style="vertical-align: inherit;">Il permet de se pencher sur les "difficiles d'accès", pour les systèmes de surveillance, les lieux et d'enrichir la surveillance avec des métriques (de contrôle) supplémentaires, tout en restant assez simple, fonctionnel et léger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même temps, il sera également utile pour les développeurs, car il donne au moins un accès indirect aux journaux d'application via un système de surveillance. </font><font style="vertical-align: inherit;">Où vous pouvez corréler les métriques de différentes sources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre point positif est que le projet se développe et acquiert de nouvelles fonctionnalités. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En retour, j'espère que cette courte note sera utile, y compris pour le projet lui-même. </font><font style="vertical-align: inherit;">Plus d'étoiles, plus de travail amusant! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci à tous!</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr487302/">https://habr.com/ru/post/fr487302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr487288/index.html">Comment Atari a défié Apple dans le domaine du PC domestique des années 1980</a></li>
<li><a href="../fr487290/index.html">Samsung bloque à distance sa Smart TV «grise» en Russie. UPD - Déclaration de Samsung</a></li>
<li><a href="../fr487294/index.html">Playwright - Microsoft Playwright et nouvel outil de test</a></li>
<li><a href="../fr487296/index.html">Expérience dans la création d'une application Web avec Pony ORM</a></li>
<li><a href="../fr487298/index.html">L'impact d'Ethernet sur la technologie réseau en 2020</a></li>
<li><a href="../fr487308/index.html">Enregistrements Java (JEP 359)</a></li>
<li><a href="../fr487310/index.html">Comment calculer le modèle financier d'un programme de fidélité</a></li>
<li><a href="../fr487314/index.html">Le fardeau des cols blancs (sur la discrimination en informatique)</a></li>
<li><a href="../fr487318/index.html">Introduction à l'authentification mutuelle des services en Java avec TLS / SSL</a></li>
<li><a href="../fr487322/index.html">Visualisation de la science: illustrations et infographies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>