<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéª üßÄ ü§£ Bitrix Do-it-yourself audit üèª üí¢ üîû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. 
 
 When I was looking for information about logging (audit of events) in Bitrix, there wasn‚Äôt anything on Habr, but there were someth...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bitrix Do-it-yourself audit</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491826/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When I was looking for information about logging (audit of events) in Bitrix, there wasn‚Äôt anything on Habr, but there were something else in the rest, but who will find it there? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To replenish the knowledge base, I decided to write this article: share my experience and warn about a possible rake.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulation of the problem</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My task was to develop the simplest accounting system for advertising structures, under the terms of the state contract, the system should work on the basis of Bitrix (version 15). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was possible to bike everything on the side of Bitrix, but I decided that it would be too dishonest in relation to the customer, the functionality of Bitrix was used to the maximum:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user authentication</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data storage system (EAV)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data editor</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audit event handlers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">role model for authorizing user actions</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user management</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work with directories</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article is mainly about audit events, I will also talk a bit about authorization and adding custom bookmarks to the info block record card.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audit Events</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the developed system, work with data is carried out through the API (adding a new object to the map and changing its coordinates), other parameters of the object are edited through the Bitrix editor, since the API does not process all data change requests, so the audit only in the API would not be complete, which means we need an audit on the side of Bitrix. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs not that I didn‚Äôt know what audit is, but I don‚Äôt have to write it often. Usually this is solved by writing the old version of the row (old data) into a separate table, and the implementation is performed entirely on the DBMS side. Moreover, we simultaneously have a state before the changes and a state after the changes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To write an audit on DBMS triggers, or to write an audit on Bitrix events, the difference is not big. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Events for processing are registered in the script "</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bitrix / php_interface / init.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", if there is no file, then you need to create it:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">use</span> <span class="hljs-title">Topliner</span>\<span class="hljs-title">Scheme</span>\<span class="hljs-title">Logger</span>;
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">require_once</span>($_SERVER[<span class="hljs-string">'DOCUMENT_ROOT'</span>] . <span class="hljs-string">'/vendor/autoload.php'</span>);
<span class="hljs-comment">//        </span>
<span class="hljs-keyword">if</span> (!defined(<span class="hljs-string">'IBLOCK_MODULE'</span>)) {<font></font>
    define(<span class="hljs-string">'IBLOCK_MODULE'</span>, <span class="hljs-string">'iblock'</span>);<font></font>
}<font></font>
<span class="hljs-comment">//    </span>
AddEventHandler(IBLOCK_MODULE, <span class="hljs-string">'OnIBlockElementAdd'</span>,
    <span class="hljs-keyword">Array</span>(Logger::class, <span class="hljs-string">'OnAdd'</span>));
<span class="hljs-comment">//     ,  -    ,              ,   </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is an example of one handler, in my implementation there are several of them, the code can be viewed in the repository, the link will be at the end of the article. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The signature of the method for processing the event for each event has its own, which </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> specifically </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">look at in the Bitrix documentation</font></a><font style="vertical-align: inherit;"> or debut and look at the sources (more clearly, all events and moments of calling handlers can also be seen in the sources during debugging). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here we are faced with the fact that when working with a DBMS, we have both current (old) data and the data that will be recorded (new), and when working with Bitrix, we have either old data or new data, but not when there will be no old and new at the same time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another problem is that there are several events before changing the data, and I could not understand the difference between them, the same story is about the triggering of several events after changing the data, eyes are staring from the wealth of choice, in fact it is just an illusion of choice.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my humble opinion about Bitrix</font></font></b><div class="spoiler_text"><blockquote>       ,      ,    _  ,     (       Delphi        PHP),     .<br>
<br>
           depricated       ¬´¬ª,       .<br>
<br>
  ¬´ ¬ª       ( )  ¬´¬ª (, , )  ,              .                ,         ¬´¬ª  .<br>
<br>
             ,      :)<br>
<br>
            ,            ,       ,                  ,   ,       ,     ,   ?   .<br>
</blockquote><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using global state</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To save and pass state between event handlers, you have to have global variables. </font><font style="vertical-align: inherit;">Global variables are something that cannot be refactored, so I use the static properties of the class:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span>
</span>{
    <span class="hljs-keyword">const</span> CHANGE = <span class="hljs-string">'change'</span>;
    <span class="hljs-keyword">const</span> REMOVE = <span class="hljs-string">'remove'</span>;
    <span class="hljs-keyword">const</span> CREATE = <span class="hljs-string">'create'</span>;
    <span class="hljs-keyword">const</span> UNDEFINED = <span class="hljs-string">'undefined'</span>;<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> $operation = <span class="hljs-built_in">self</span>::UNDEFINED;<font></font>
<font></font>
    <span class="hljs-keyword">const</span> NO_VALUE = [];<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> $fields = <span class="hljs-built_in">self</span>::NO_VALUE;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> $properties = <span class="hljs-built_in">self</span>::NO_VALUE;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> $names = <span class="hljs-built_in">self</span>::NO_VALUE;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here you need to make an explanation about the use of "fields" and "properties". Fields are the parameters that each infoblock record has (identifier, name, infoblock ‚Äúparent‚Äù), properties are parameters specific to records of a particular type of infoblock, in the EAV model, these are attributes and their values. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚ÄúNames‚Äù are the names of attributes, in one event we have identifiers of attributes and names, in another event we have only identifiers, and for a beautiful record in the journal we need to save the names (we can of course subtract the identifier, but for some reason you don‚Äôt want to).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Operation" is the current operation, for working with "fields" Bitrix gives specific events, when working with "properties" (functions "SetPropertyValues" and "SetPropertyValuesEx"), there is no event with the type of operation, there is an event before and after the call, but it does not It is known what operation is performed (add / update / delete), therefore the operation also needs to be transferred from the handler to the handler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maybe I didn‚Äôt figure it out, and in Bitrix you can simultaneously see the values ‚Äã‚Äãas it was and how it will be, or maybe it was necessary to separately record the state before and the state after, but for some reason I decided that the log entry should be in the format ‚Äúproperty % name% was% value before the change% =&gt; it became% value after% ‚Äùand therefore there are a lot of problems with maintaining the global state.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Determining if changes are required</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oddly enough, but our handler will be called to change any record of any information block. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, in the handler we need to understand the record of which information block we received in the parameters. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The infoblock of a record is characterized by two values: the infoblock itself ('IBLOCK_ID') and its section ('IBLOCK_SECTION_ID'), and the section identifier sometimes lies in the array of values ‚Äã‚Äãwith the index 'IBLOCK_SECTION_ID', and sometimes 'IBLOCK_SECTION', so I read the section identifier by both keys with priority for 'IBLOCK_SECTION'. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, in some situations, the section identifier cannot be determined in principle, therefore, the check for the need to add an entry to the audit log has to be done only on the basis of the information block identifier.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After determining the information block and section, we decide on the need to register the event in the journal.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saving state before changes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each infoblock entry consists of two parts, one part is ‚Äúfields‚Äù, and these parameters are changed by methods:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: Add () </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: Update () </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: Delete ()</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The other part is the ‚Äúproperties‚Äù methods:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: SetPropertyValues ‚Äã‚Äã()</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIBlockElement :: SetPropertyValuesEx ()</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I don‚Äôt remember why, but it's better to refrain from using CIBlockElement :: SetPropertyValuesEx () in my code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each part of the data in its event handler is separate from the other, therefore, by clicking the "Save" button, two entries in the audit log can be created. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The signatures of the events for ‚Äúfields‚Äù and ‚Äúproperties‚Äù are different, in the part with processing ‚Äúfields‚Äù we save the current state for fields and set the value to operation, in the part with processing ‚Äúproperties‚Äù we save properties and their names. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We do this of course in the "before" handler.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change Registration</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the "after" handler, we write to the log. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When compiling a list of differences in records, there is a problem with attributes that can take multiple values. </font><font style="vertical-align: inherit;">The format of recording their state ‚Äúbefore‚Äù and state ‚Äúafter‚Äù differs so much that one cannot deduce the other, so when determining whether to register changes, you will always conclude that registration is necessary. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The source code of the audit in the repository in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / Topliner / Scheme / Logger.php file</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding a custom tab to the infoblock card (in the Bitrix classifier)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To add a card, an approach similar to auditing is used - we add a handler:</font></font><br>
<br>
<pre><code class="php hljs">AddEventHandler(<span class="hljs-string">'main'</span>, <span class="hljs-string">'OnAdminIBlockElementEdit'</span>,
    <span class="hljs-keyword">Array</span>(PermitTab::class, <span class="hljs-string">'OnInit'</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the 'OnInit' method, we define the other methods for working with the tab in the Bitrix editor:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PermitTab</span>
</span>{
    <span class="hljs-keyword">const</span> LINKS = <span class="hljs-string">'links'</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">OnInit</span>(<span class="hljs-params">$arArgs</span>)
    </span>{<font></font>
        $permits = BitrixScheme::getPermits();<font></font>
        $pubPermits = BitrixScheme::getPublishedPermits();<font></font>
        $blockId = (<span class="hljs-keyword">int</span>)$arArgs[<span class="hljs-string">'IBLOCK'</span>][<span class="hljs-string">'ID'</span>];<font></font>
        $letShow = $blockId === $permits-&gt;getBlock()<font></font>
            || $blockId === $pubPermits-&gt;getBlock();<font></font>
        $result = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> ($letShow) {<font></font>
            $result = [<font></font>
                <span class="hljs-string">'TABSET'</span> =&gt; <span class="hljs-string">'LinksToConstructs'</span>,
                <span class="hljs-string">'GetTabs'</span> =&gt; [<span class="hljs-built_in">static</span>::class, <span class="hljs-string">'GetTabs'</span>],
                <span class="hljs-string">'ShowTab'</span> =&gt; [<span class="hljs-built_in">static</span>::class, <span class="hljs-string">'ShowTab'</span>],
                <span class="hljs-string">'Action'</span> =&gt; [<span class="hljs-built_in">static</span>::class, <span class="hljs-string">'Action'</span>],
                <span class="hljs-string">'Check'</span> =&gt; [<span class="hljs-built_in">static</span>::class, <span class="hljs-string">'Check'</span>],<font></font>
            ];<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> $result;<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, of course, we check that for this information block we need to show our user tab, if necessary, we set methods. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is nothing special to tell here, see the sources in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">src / Topliner / Scheme / PermitTab.php repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , read the documentation.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Role model for authorizing user actions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bitrix‚Äôs methods for authorization work with a linear rights scale, that is, a scenario where one can have the first and second, but not the third, and the other can be the second and third, but not the first, you can‚Äôt implement Bitrix directly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For such tricky scenarios in Bitrix, there is simply a check of some permission, and in the code when performing the operation, you see if the user has permission or not, and you allow the first and second roles of one role and the second and third ones of the role.</font></font><br>
<br>
<pre><code class="php hljs">        $constSec = BitrixScheme::getConstructs();<font></font>
        $isAllow = CIBlockSectionRights::UserHasRightTo(<font></font>
            $constSec-&gt;getBlock(), $constSec-&gt;getSection(),<font></font>
            BitrixPermission::ELEMENT_ADD, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (!$isAllow) {<font></font>
            $output[<span class="hljs-string">'message'</span>] = <span class="hljs-string">'Forbidden, not enough permission;'</span>;<font></font>
        }<font></font>
</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ constSec-&gt; getBlock () - information block identifier</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ constSec-&gt; getSection () - section identifier</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BitrixPermission :: ELEMENT_ADD - permission code</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the classifier (information block directory) in the necessary information blocks and sections, you assign the appropriate rights to the roles. </font><font style="vertical-align: inherit;">Distribute roles to users and everything will be under your control.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Authentication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you need user authentication for some pages, just add:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
define(<span class="hljs-string">"NEED_AUTH"</span>, <span class="hljs-literal">true</span>);
<span class="hljs-keyword">require</span>($_SERVER[<span class="hljs-string">"DOCUMENT_ROOT"</span>] . <span class="hljs-string">"/bitrix/header.php"</span>);
<span class="hljs-meta">?&gt;</span><font></font>
<font></font>
<span class="hljs-comment">//      </span><font></font>
<font></font>
<span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">require</span>($_SERVER[<span class="hljs-string">"DOCUMENT_ROOT"</span>] . <span class="hljs-string">"/bitrix/footer.php"</span>);
<span class="hljs-meta">?&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When loading such a page, Bitrix will give out a login form if the user has not logged in yet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you just need to connect Bitrix in some kind of script, then:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">require_once</span>($_SERVER[<span class="hljs-string">'DOCUMENT_ROOT'</span>]<font></font>
    . <span class="hljs-string">'/bitrix/modules/main/include/prolog_before.php'</span>);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work with directories</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ‚Äúnew‚Äù (as of November 2019) directories in Bitrix are called ‚ÄúHighloadBlock‚Äù, working with them is a little bit non-standard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each Hyload block can be stored in a separate table, therefore, to access the directory, each time you need to determine the name of the table to read. </font><font style="vertical-align: inherit;">In order not to constantly do this, in Bitrix you need to create an instance of a class for accessing data. </font><font style="vertical-align: inherit;">An instance is created in two lines:</font></font><br>
<br>
<pre><code class="php hljs">CModule::IncludeModule(<span class="hljs-string">'highloadblock'</span>);<font></font>
$entity = HighloadBlockTable::compileEntity(<span class="hljs-string">'ConstructionTypes'</span>);<font></font>
$reference = $entity-&gt;getDataClass();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where 'ConstructionTypes' is the reference code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">order</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> not to constantly write these two lines, you can write a class that will create reference instances for us ( </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">src / Topliner / Bitrix / BitrixReference.php</font></a><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we work with the instance as with the usual Bitrix ORM class (D7):</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-comment">/* <span class="hljs-doctag">@var</span> $reference DataManager */</span>
$data = $reference::getList(<span class="hljs-keyword">array</span>(
    <span class="hljs-string">'select'</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">'UF_NAME'</span>, <span class="hljs-string">'UF_XML_ID'</span>),
    <span class="hljs-string">'filter'</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-string">'UF_TYPE_ID'</span> =&gt; <span class="hljs-number">0</span>)<font></font>
    ));<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (carefully, a lot of copy-paste) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for your attention.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491812/index.html">IntelliJ IDEA Tips & Tricks: 2. Dependency Analysis</a></li>
<li><a href="../en491814/index.html">Network diagram as code</a></li>
<li><a href="../en491816/index.html">[Forecast] Transport of the future: long-term horizon</a></li>
<li><a href="../en491818/index.html">The Basics of Reliable Data Transfer</a></li>
<li><a href="../en491824/index.html">Love all people - the best reports with TeamLeadConf in 5 minutes</a></li>
<li><a href="../en491828/index.html">DataMatrix or how to label shoes correctly</a></li>
<li><a href="../en491832/index.html">8 pluses of Flutter in comparison with React Native</a></li>
<li><a href="../en491838/index.html">MIPT launches an open online course on sports programming</a></li>
<li><a href="../en491840/index.html">Visualization of the work of service workers</a></li>
<li><a href="../en491844/index.html">Auto test coverage visualization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>