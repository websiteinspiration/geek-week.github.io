<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æüèΩ üë©üèª‚Äçüöí üå¶Ô∏è Cientos de miles de rutas por segundo por n√∫cleo. Experiencia Yandex.Routing üöü üë®‚Äçüë®‚Äçüëß ü§¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace un par de semanas, Danya Tararukhin le cont√≥ a Habr√© c√≥mo apareci√≥ nuestro servicio, Yandex.Routing, y c√≥mo ayuda a las empresas con la log√≠stica...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cientos de miles de rutas por segundo por n√∫cleo. Experiencia Yandex.Routing</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/496818/"><img src="https://habrastorage.org/webt/it/we/vn/itwevn4ivk3h4pncvonx-mh4w70.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace un par de semanas, Danya Tararukhin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le cont√≥</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a Habr√© c√≥mo apareci√≥ nuestro servicio, Yandex.Routing, y c√≥mo ayuda a las empresas con la log√≠stica. </font><font style="vertical-align: inherit;">Al crear la plataforma, resolvimos varios problemas interesantes, uno de los cuales est√° dedicado a la publicaci√≥n de hoy. </font><font style="vertical-align: inherit;">Quiero hablar sobre la planificaci√≥n de rutas en s√≠ y los recursos necesarios para esto.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encontrar la mejor ruta entre m√∫ltiples puntos es un cl√°sico problema de optimizaci√≥n discreta. </font><font style="vertical-align: inherit;">Para resolverlo, debe conocer las distancias y los tiempos de viaje entre todos los puntos. </font><font style="vertical-align: inherit;">Es decir, conocer la matriz de distancias y tiempos. </font><font style="vertical-align: inherit;">Hace dos a√±os, un c√°lculo de matriz largo era un problema muy cr√≠tico para nosotros y bloqueaba el desarrollo. </font><font style="vertical-align: inherit;">La b√∫squeda de la soluci√≥n √≥ptima con la matriz conocida tom√≥ 10 minutos, pero el c√°lculo de todas las celdas de la matriz para tareas grandes (para varios miles de pedidos) tom√≥ horas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver el problema con cinco mil pedidos, debe conocer las distancias y los tiempos de viaje entre todos los puntos. Estas son dos matrices de n√∫meros con una dimensi√≥n de 5000x5000. Planificamos rutas de mensajer√≠a para todo el d√≠a, y por la ma√±ana el servicio de mensajer√≠a llegar√° de un punto a otro en una hora y por la noche, por otra. Por lo tanto, debe calcular la matriz de tiempos y distancias para cada hora del d√≠a. No todas las horas del d√≠a son √∫nicas, pero el tiempo de corcho (ma√±ana y tarde) debe cubrirse bien. Por lo tanto, llegamos a una configuraci√≥n con segmentos de trece horas. En total, necesitamos dos cubos (tiempos y distancias) cada uno de 13x5000x5000. Estos son 325 millones de rutas, calculadas de acuerdo con el gr√°fico real de carreteras, en el que 165 millones de bordes. El c√°lculo de una ruta en un algoritmo bien optimizado del equipo Yandex.Maps dura unos 10 ms, para un total de 900 horas de c√°lculos.Incluso en paralelo a 900 CPU, debe esperar 1 hora. No pudimos iniciar dicho servicio, necesit√°bamos un algoritmo m√°s adecuado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para leer m√°s, es √∫til conocer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el algoritmo de Dijkstra</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para encontrar la ruta m√°s corta en un gr√°fico. Se puede imaginar como una "ola" que emana del punto de inicio de la ruta y recorre todo el gr√°fico hasta que se alcanza el punto final. En este caso, el tiempo de ejecuci√≥n del algoritmo es proporcional a los bordes del gr√°fico, es decir, el √°rea cubierta por la ola: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cz/7s/em/cz7seml-ef9d058gdfhgkoe50_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
casi todos los candidatos para una entrevista en una entrevista conocen el primer paso para optimizar dicha tarea: puede comenzar la ola desde dos lados y finalizar la b√∫squeda cuando las olas se encuentran. El √°rea total de dos ondas de medio radio es menor que una grande.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2g/ch/2c/2gch2cvzqgbjwduk9_agsqhvrma.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El gr√°fico de ruta real est√° bastante estructurado, y esto se puede utilizar. Cuando est√© buscando la distancia m√°s corta entre Mosc√∫ y San Petersburgo, en Dijkstra cl√°sica, se ver√° obligado a extender la ola en un c√≠rculo y a clasificar por todas las calles y callejones de Mosc√∫, las ciudades y pueblos de la regi√≥n de Mosc√∫, las calles Tver y Novgorod. Esta es una gran cantidad de c√°lculos, pero puede prepararse con anticipaci√≥n y recordar las rutas √≥ptimas entre ciudades (tambi√©n conocidos como atajos) y no repetirlas en tiempo de ejecuci√≥n. Luego, para encontrar la ruta entre dos puntos en el Dijkstra jer√°rquico, debe calcular las distancias m√°s cortas al acceso directo deseado. Como los niveles jer√°rquicos pueden no ser dos, sino 5-6, reducen dr√°sticamente el tiempo de b√∫squeda.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El equipo del enrutador de tarjetas ha implementado tales optimizaciones durante bastante tiempo. Fueron ellos los que hicieron posible alcanzar 10 ms para encontrar una ruta entre dos puntos. :) Entonces, por ahora, no nos hemos acercado a resolver nuestro problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que el modo de b√∫squeda punto a punto ya est√° extremadamente optimizado, podemos optimizar el c√°lculo de la serie en la matriz. Una fila es la distancia desde un punto a todos los dem√°s. Mientras buscamos la distancia hasta el punto m√°s lejano, calculamos simult√°neamente las distancias a las m√°s cercanas. Por lo tanto, calcular la serie es equivalente a calcular la distancia al punto m√°s lejano. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jp/6i/qa/jp6iqadxummylqmj1suh0h2ppe8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observamos el momento de calcular la serie usando este algoritmo y recordamos que el c√°lculo secuencial de 5000 rutas tomar√≠a aproximadamente 5000 * 10 ms = 50 s:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jv/c_/v9/jvc_v98yos03l5xd5w57394s4dk.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El gr√°fico muestra el tiempo de c√°lculo de una fila en una matriz de distancia de tama√±o 1 * N para diferentes N (seg√∫n datos reales). Se puede ver que el c√°lculo de la fila de tama√±o 1 * 5000 de inter√©s para nosotros cabe en 1.3 segundos. Se ha agregado una l√≠nea de tendencia al gr√°fico, que muestra que el tiempo de c√°lculo est√° creciendo un poco m√°s lento que linealmente en N, el orden de N ** 0.74 ¬°</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ya no est√° mal! Con este algoritmo, podemos calcular nuestro cubo en 13 * 5000 * 1.3 s = 84 500 s = casi 24 horas. Es paralelo en filas f√°cilmente, y cuando se usan 50 CPU, las distancias se calculan en media hora. El orden de complejidad del algoritmo de c√°lculo del cubo es O (N ** 1.74):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9c/cr/xd/9ccrxdjoher2ks-ijoa7ur3rd2m.png"><br>
<i>    13   N*N    50 CPU (    13*N/50).      ,        5000 ,           .      10 000,   :      .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De esta forma, hace dos a√±os y medio, lanzamos la primera versi√≥n de nuestra API, que resuelve el problema de log√≠stica. Los clientes a menudo se quejaron de un largo tiempo de decisi√≥n, y son f√°ciles de entender: comenzaste una tarea para resolver, esperas 1 hora, obtienes una soluci√≥n y entiendes que olvidaste arreglar el turno con el conductor, lo corriges y todo comienza de nuevo. Los conductores comienzan a ponerse nerviosos porque corren el riesgo de entrar en la hora pico de la ma√±ana o incluso no tienen tiempo para entregar el pedido a tiempo. Era necesario hacer algo. No quer√≠amos "tirar" el problema con el hierro: nos est√°bamos preparando para cargas pesadas, habr√≠a requerido mucho hierro, y la compra de servidores no est√° sucediendo de inmediato. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un estudio de art√≠culos acad√©micos mostr√≥ que, resulta que hay algoritmos con complejidad lineal para esta tarea </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">*</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! (En el art√≠culo de referencia, hay una gran visi√≥n general de todo tipo de m√©todos modernos de aceleraci√≥n de Dijkstra, incluso para el caso de la matriz.) Calcular la matriz en tiempo lineal no cab√≠a en mi cabeza. Uno de nuestros desarrolladores se ofreci√≥ como voluntario para escribir un prototipo, y esto es lo que sucedi√≥: el </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ag/3o/lq/ag3olqspwhrjrvtodp699z6bl64.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiempo para calcular una matriz de tama√±o N * N en una CPU utilizando el algoritmo de "matriz r√°pida". La complejidad se obtiene del orden de O (N ** 1,1). Las N altas se eliminan de la l√≠nea de tendencia, ya que la generaci√≥n de la respuesta y su descarga a trav√©s de la red ya influyen m√°s en el tiempo.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°115 segundos por matriz de 5000x5000 usando un solo n√∫cleo y una dependencia casi lineal de N. Fiction se ha convertido en una realidad! La idea del algoritmo combina las dos ideas descritas anteriormente: Dijkstra para series y b√∫squeda jer√°rquica. Obviamente, comenzando a calcular la segunda fila, en alg√∫n momento volveremos a recorrer la misma √°rea del gr√°fico que acabamos de recorrer, calculando la fila anterior. Por lo tanto, memoricemos las distancias m√°s cortas a todos los destinos en los nodos del gr√°fico jer√°rquico. Cuando comenzamos a calcular la siguiente serie, luego de haber alcanzado dicho nodo, obtendremos de inmediato casi todas las distancias a otros puntos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/3y/os/ch3yosqi1h0od0dtee_tn_dsqem.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace un a√±o y medio, esto nos permiti√≥ ahorrar media hora de tiempo con </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log√≠stica y reducir significativamente la ingesta de hierro. </font><font style="vertical-align: inherit;">Anteriormente, para una solicitud grande, necesit√°bamos 50 n√∫cleos durante media hora, pero ahora, 13 n√∫cleos durante 2 minutos. </font><font style="vertical-align: inherit;">Esto es aproximadamente 200,000 rutas por segundo por n√∫cleo. </font><font style="vertical-align: inherit;">Ese raro caso cuando el nuevo algoritmo no solo cierra la clase de problemas, sino que expande nuestras ideas sobre lo posible.</font></font><br>
 <br>
<hr><sub><sup><a name="arxiv"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* Art√≠culo "Planificaci√≥n de rutas en redes de transporte", ver p√°rrafo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.7.2 "Rutas m√°s cortas por lotes"</font></font></a></sup></sub></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es496802/index.html">Simple Made Easy - Rich Hickey (con traducci√≥n al ruso)</a></li>
<li><a href="../es496804/index.html">Instalaci√≥n y configuraci√≥n de Docker en Windows Subsystem Linux (WSL)</a></li>
<li><a href="../es496810/index.html">An√°lisis financiero general en Python (Parte 3)</a></li>
<li><a href="../es496812/index.html">Zoom: ¬ønegligencia banal o espionaje selectivo?</a></li>
<li><a href="../es496816/index.html">¬øPuedes sentir al candidato, est√° vivo?</a></li>
<li><a href="../es496820/index.html">Las trampas de la terraforma</a></li>
<li><a href="../es496822/index.html">C√≥mo mueren las startups en los Estados Unidos debido al coronavirus</a></li>
<li><a href="../es496824/index.html">Tu ambiente de trabajo n√≥rdico</a></li>
<li><a href="../es496826/index.html">Millones de sprites a m√°s de 120 fps</a></li>
<li><a href="../es496828/index.html">¬øD√≥nde encontrar freelance que ser√° divertido? (Spoiler: no Upwork)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>