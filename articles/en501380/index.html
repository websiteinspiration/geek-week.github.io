<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👂🏻 🧓 💇 Data Build Tool or what is in common between a Data Warehouse and a Smoothie 👨‍👨‍👧 👉🏾 👨🏿‍⚕️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What are the principles of an ideal Data Warehouse? 
 
 Focus on business value and analytics in the absence of boilerplate code. Managing DWH as a co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Data Build Tool or what is in common between a Data Warehouse and a Smoothie</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501380/"><img src="https://habrastorage.org/webt/94/m4/yy/94m4yy6-3edqwrae5dja92zyiya.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What are the principles of an ideal Data Warehouse? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Focus on business value and analytics in the absence of boilerplate code. </font><font style="vertical-align: inherit;">Managing DWH as a codebase: versioning, review, automated testing, and CI. </font><font style="vertical-align: inherit;">Modularity, extensibility, open source and community. </font><font style="vertical-align: inherit;">Friendly user documentation and dependency visualization (Data Lineage). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More about all this and about the role of DBT in the Big Data &amp; Analytics ecosystem - welcome to cat.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In touch with Artemy Kozyr. </font><font style="vertical-align: inherit;">For over 5 years I have been working with data warehouses, building ETL / ELT, as well as data analytics and visualization. </font><font style="vertical-align: inherit;">I currently work at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wheely</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , teach at OTUS on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Engineer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> course </font><font style="vertical-align: inherit;">, and today I want to share with you an article that I wrote on the eve of the start of a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new course set</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Short review</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The DBT framework is all about the letter T in the acronym ELT (Extract - Transform - Load). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the advent of such productive and scalable analytical databases as BigQuery, Redshift, Snowflake, any sense to make transformations outside the Data Warehouse disappeared.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBT does not download data from sources, but provides tremendous opportunities to work with data that is already loaded into the Storage (in Internal or External Storage).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99f/db8/537/99fdb8537040978a7f704780435bdded.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main purpose of DBT is to take the code, compile it in SQL, execute the commands in the correct sequence in the Repository.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBT project structure</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The project consists of directories and files of only 2 types:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model (.sql) - unit of transformation expressed by a SELECT query</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration file (.yml) - parameters, settings, tests, documentation</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At a basic level, work is structured as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User prepares model code in any convenient IDE</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the CLI, models are launched, DBT compiles the model code in SQL</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compiled SQL code is executed in the Warehouse in the specified sequence (graph)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what the launch from the CLI might look like:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/893/fd8/a9c/893fd8a9c5ef3206e4568259b7ec1660.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything is SELECT</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a killer feature of the Data Build Tool framework. </font><font style="vertical-align: inherit;">In other words, DBT abstracts all the code related to the materialization of your queries in the Warehouse (variations from the CREATE, INSERT, UPDATE, DELETE ALTER, GRANT, ... commands). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any model involves writing one SELECT-query, which defines the resulting data set. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, the transformation logic can be multilevel and consolidate data from several other models. </font><font style="vertical-align: inherit;">An example of a model that will build a showcase of orders (f_orders):</font></font><br>
<br>
<pre><code class="sql hljs">{% <span class="hljs-keyword">set</span> payment_methods = [<span class="hljs-string">'credit_card'</span>, <span class="hljs-string">'coupon'</span>, <span class="hljs-string">'bank_transfer'</span>, <span class="hljs-string">'gift_card'</span>] %}<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">with</span> orders <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">ref</span>(<span class="hljs-string">'stg_orders'</span>) }}<font></font>
&nbsp;<font></font>
),<font></font>
&nbsp;<font></font>
order_payments <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">ref</span>(<span class="hljs-string">'order_payments'</span>) }}<font></font>
&nbsp;<font></font>
),<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.order_id,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.customer_id,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.order_date,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.status,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">for</span> payment_method <span class="hljs-keyword">in</span> payment_methods -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_payments.{{payment_method}}_amount,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% endfor -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_payments.total_amount <span class="hljs-keyword">as</span> amount
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">from</span> orders
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> order_payments <span class="hljs-keyword">using</span> (order_id)<font></font>
&nbsp;<font></font>
)<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">final</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What interesting things can we see here? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First: CTE (Common Table Expressions) are used to organize and understand code that contains many transformations and business logic </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. Second: Model code is a mixture of SQL and the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jinja</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> language </font><font style="vertical-align: inherit;">(templating language). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the example, the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> loop was used </font><font style="vertical-align: inherit;">to form the amount for each payment method specified in the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> expression </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ref</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">is </font><font style="vertical-align: inherit;">also used </font><font style="vertical-align: inherit;">- the ability to refer inside the code to other models:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At compile time, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ref</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be converted to a target pointer to a table or view in the Repository</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ref</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows you to build a graph of model dependencies</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jinja that</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adds almost unlimited possibilities to DBT. </font><font style="vertical-align: inherit;">The most commonly used ones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If / else statements - branching statements</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For loops - loops</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Variables - Variables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Macro - Create Macros</font></font></li>
</ul><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Materialization: Table, View, Incremental</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Materialization Strategy - an approach according to which the resulting set of model data will be stored in the Repository. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a basic consideration, this is:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table - physical table in the Storage</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View - view, virtual table in the Repository</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are more complex materialization strategies:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incremental - incremental loading (large fact tables); </font><font style="vertical-align: inherit;">new lines are added, modified ones are updated, deleted ones are cleared&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ephemeral - the model does not materialize directly, but participates as CTE in other models</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Any other strategies you can add yourself</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to materialization strategies, opportunities are opened up for optimization for specific Warehouses, for example:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snowflake</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Transient tables, Merge behavior, Table clustering, Copying grants, Secure views</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redshift</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Distkey, Sortkey (interleaved, compound), Late Binding Views</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BigQuery</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Table partitioning &amp; clustering, Merge behavior, KMS Encryption, Labels &amp; Tags</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spark</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : File format (parquet, csv, json, orc, delta), partition_by, clustered_by, buckets, incremental_strategy</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following Repositories are currently supported:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgres</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redshift</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bigquery</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snowflake</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Presto (partially)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spark (partially)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsoft SQL Server (community adapter)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's improve our model:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make its filling incremental (Incremental)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add segmentation and sort keys for Redshift</font></font></li>
</ul><br>
<pre><code class="sql hljs"><span class="hljs-comment">--  :&nbsp;</span>
<span class="hljs-comment">--  ,      (unique_key)</span>
<span class="hljs-comment">--   (dist),   (sort)</span><font></font>
{{<font></font>
&nbsp;&nbsp;config(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;materialized='incremental',<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unique_key='order_id',<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist="customer_id",<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort="order_date"<font></font>
&nbsp;&nbsp;&nbsp;)<font></font>
}}<font></font>
&nbsp;<font></font>
{% <span class="hljs-keyword">set</span> payment_methods = [<span class="hljs-string">'credit_card'</span>, <span class="hljs-string">'coupon'</span>, <span class="hljs-string">'bank_transfer'</span>, <span class="hljs-string">'gift_card'</span>] %}<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">with</span> orders <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">ref</span>(<span class="hljs-string">'stg_orders'</span>) }}
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">where</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">if</span> is_incremental() -%}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--        </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">and</span> order_date &gt;= (<span class="hljs-keyword">select</span> <span class="hljs-keyword">max</span>(order_date) <span class="hljs-keyword">from</span> {{ this }})<font></font>
&nbsp;&nbsp;&nbsp;{%- endif %}&nbsp;<font></font>
&nbsp;<font></font>
),<font></font>
&nbsp;<font></font>
order_payments <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">ref</span>(<span class="hljs-string">'order_payments'</span>) }}<font></font>
&nbsp;<font></font>
),<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.order_id,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.customer_id,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.order_date,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orders.status,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">for</span> payment_method <span class="hljs-keyword">in</span> payment_methods -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_payments.{{payment_method}}_amount,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% endfor -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_payments.total_amount <span class="hljs-keyword">as</span> amount
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">from</span> orders
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> order_payments <span class="hljs-keyword">using</span> (order_id)<font></font>
&nbsp;<font></font>
)<font></font>
&nbsp;<font></font>
<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-keyword">final</span>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model Dependency Graph</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He is a tree of dependencies. </font><font style="vertical-align: inherit;">He is a DAG (Directed Acyclic Graph - Directional Acyclic Graph). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBT builds a graph based on the configuration of all project models, or rather ref () links inside models to other models. </font><font style="vertical-align: inherit;">Having a graph allows you to do the following things:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Running models in the correct sequence</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parallelization of window dressing</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Running an arbitrary subgraph&nbsp;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Graph visualization example:</font></font><br>
<br>
<strong><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b5d/9f7/bc4/b5d9f7bc41fb5563b8337b04ee123e9a.png"></div></strong><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each node of the graph is a model, the edges of the graph are given by the expression ref.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Quality and Documentation</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the formation of the models themselves, DBT allows you to test a number of assertions about the resulting data set, such as:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not null</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unique</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reference Integrity - reference integrity (for example, customer_id in the orders table corresponds to id in the customers table)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matching Valid List</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can add your own tests (custom data tests), such as, for example,% deviation of revenue with indicators a day, a week, a month ago. </font><font style="vertical-align: inherit;">Any assumption formulated as an SQL query can be a test. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this way, unwanted deviations and errors in data can be caught in the storefront of the Storage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In terms of documentation, DBT provides mechanisms for adding, versioning, and distributing metadata and comments at the model level and even attributes.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is how adding tests and documentation at the configuration file level looks like:</font></font><br>
<br>
<pre><code class="ruby hljs">&nbsp;- <span class="hljs-symbol">name:</span> fct_orders
&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> This table has basic information about orders, as well as some derived facts based on payments
&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">columns:</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">name:</span> order_id
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">tests:</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- unique <span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- not_null <span class="hljs-comment">#    null</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> This is a unique identifier <span class="hljs-keyword">for</span> an order<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">name:</span> customer_id
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> Foreign key to the customers table
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">tests:</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- not_null<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">relationships:</span> <span class="hljs-comment">#   </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">to:</span> ref(<span class="hljs-string">'dim_customers'</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">field:</span> customer_id<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">name:</span> order_date
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> Date (UTC) that the order was placed<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">name:</span> status
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">description:</span> <span class="hljs-string">'{{ doc("orders_status") }}'</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">tests:</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-symbol">accepted_values:</span> <span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-symbol">values:</span> [<span class="hljs-string">'placed'</span>, <span class="hljs-string">'shipped'</span>, <span class="hljs-string">'completed'</span>, <span class="hljs-string">'return_pending'</span>, <span class="hljs-string">'returned'</span>]
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is how this documentation already looks on the generated website:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/854/8b6/27e/8548b627ea48caab60c524697984ef77.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Macros and Modules</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The purpose of DBT is not so much to become a set of SQL scripts, but to provide users with powerful and feature-rich tools for building their own transformations and distributing these modules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Macros are sets of constructs and expressions that can be called as functions within models. </font><font style="vertical-align: inherit;">Macros allow you to reuse SQL between models and projects in accordance with the DRY (Don't Repeat Yourself) engineering principle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Macro Example:</font></font><br>
<br>
<pre><code class="sql hljs">{% macro rename_category(column_name) %}<font></font>
case<font></font>
&nbsp;when {{ column_name }} ilike&nbsp; '%osx%' then 'osx'<font></font>
&nbsp;when {{ column_name }} ilike&nbsp; '%android%' then 'android'<font></font>
&nbsp;when {{ column_name }} ilike&nbsp; '%ios%' then 'ios'<font></font>
&nbsp;else 'other'<font></font>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> renamed_product<font></font>
{% endmacro %}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And its use:</font></font><br>
<br>
<pre><code class="sql hljs">{% <span class="hljs-keyword">set</span> column_name = <span class="hljs-string">'product'</span> %}
<span class="hljs-keyword">select</span><font></font>
&nbsp;product,<font></font>
&nbsp;{{ rename_category(column_name) }} <span class="hljs-comment">--  </span>
<span class="hljs-keyword">from</span> my_table
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBT comes with a package manager that allows users to publish and reuse individual modules and macros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means the ability to download and use libraries such as:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dbt_utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : working with Date / Time, Surrogate Keys, Schema tests, Pivot / Unpivot and others</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ready-made showcase templates for services such as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snowplow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stripe</font></font></a>&nbsp;</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Libraries for specific Data Warehouses, such as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redshift</font></font></a>&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logging</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - DBT </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Logging</font></a><font style="vertical-align: inherit;"> Module</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A complete list of packages is available at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dbt hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Even more features</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here I will describe several other interesting features and implementations that I and the team use to build a Data Warehouse in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wheely</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Separation of runtime environments DEV - TEST - PROD</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even within the same DWH cluster (within different schemes). </font><font style="vertical-align: inherit;">For example, using the following expression:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">with</span> <span class="hljs-keyword">source</span> <span class="hljs-keyword">as</span> (<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> {{ <span class="hljs-keyword">source</span>(<span class="hljs-string">'salesforce'</span>, <span class="hljs-string">'users'</span>) }}
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">where</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
&nbsp;&nbsp;&nbsp;{%- <span class="hljs-keyword">if</span> target.name <span class="hljs-keyword">in</span> [<span class="hljs-string">'dev'</span>, <span class="hljs-string">'test'</span>, <span class="hljs-string">'ci'</span>] -%}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">where</span> <span class="hljs-built_in">timestamp</span> &gt;= <span class="hljs-keyword">dateadd</span>(<span class="hljs-keyword">day</span>, <span class="hljs-number">-3</span>, <span class="hljs-keyword">current_date</span>)&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;{%- endif -%}<font></font>
&nbsp;<font></font>
)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This code literally says: for </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev, test, ci</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> environments </font><strong><font style="vertical-align: inherit;">,</font></strong><font style="vertical-align: inherit;"> take data only for the last 3 days and no more. </font><font style="vertical-align: inherit;">That is, running in these environments will be much faster and require less resources. </font><font style="vertical-align: inherit;">When launched on a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prod</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> environment, </font><font style="vertical-align: inherit;">the filter condition will be ignored.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alternate column encoding materialization</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redshift is a column DBMS that allows you to specify data compression algorithms for each individual column. </font><font style="vertical-align: inherit;">The choice of optimal algorithms can reduce the occupied disk space by 20-50%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redshift.compress_table</font></font></strong></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> macro </font><font style="vertical-align: inherit;">will execute the ANALYZE COMPRESSION command, create a new table with the recommended column coding algorithms indicated by the segmentation keys (dist_key) and sort_key (sort_key), transfer the data to it, and delete the old copy if necessary. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Macro Signature:</font></font><br>
<br>
<pre><code class="sql hljs">{{ compress_table(schema, table,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;drop_backup=False,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comprows=none|Integer,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort_style=none|compound|interleaved,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sort_keys=none|List&lt;String&gt;,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist_style=none|all|even,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dist_key=none|String) }}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logging Model Launches</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each execution of the model, you can hang hooks that will be executed before launch or immediately after the creation of the model:</font></font><br>
<br>
<pre><code class="ruby hljs">&nbsp;&nbsp;&nbsp;pre-<span class="hljs-symbol">hook:</span> <span class="hljs-string">"{{ logging.log_model_start_event() }}"</span>
&nbsp;&nbsp;&nbsp;post-<span class="hljs-symbol">hook:</span> <span class="hljs-string">"{{ logging.log_model_end_event() }}"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The logging module will allow you to record all the necessary metadata in a separate table, according to which you can subsequently audit and analyze problem areas (bottlenecks). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what the dashboard looks like on the lookup data in Looker:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d0b/0f4/d7c/d0b0f4d7c7074880fa7ad5d9de6fc196.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Storage Automation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you use any extensions of the functionality of the Storage used, such as UDF (User Defined Functions), then versioning these functions, access control, and automatically rolling out new releases is very convenient to implement in DBT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We use UDF in Python to calculate hash values, mail domain domains, and decode bitmask. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example macro that creates UDF on any runtime (dev, test, prod):</font></font><br>
<br>
<pre><code class="sql hljs">{% macro create_udf() -%}<font></font>
&nbsp;<font></font>
&nbsp;{% <span class="hljs-keyword">set</span> <span class="hljs-keyword">sql</span> %}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> {{ target.schema }}.f_sha256(mes <span class="hljs-string">"varchar"</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">RETURNS</span> <span class="hljs-built_in">varchar</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">LANGUAGE</span> plpythonu<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STABLE<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">AS</span> $$&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">import</span> hashlib
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> hashlib.sha256(mes).hexdigest()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$$<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<font></font>
&nbsp;{% endset %}<font></font>
&nbsp;&nbsp;<font></font>
&nbsp;{% <span class="hljs-keyword">set</span> <span class="hljs-keyword">table</span> = run_query(<span class="hljs-keyword">sql</span>) %}<font></font>
&nbsp;<font></font>
{%- endmacro %}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At Wheely, we use Amazon Redshift, which is based on PostgreSQL. </font><font style="vertical-align: inherit;">For Redshift, it is important to regularly collect statistics on tables and free up disk space - the ANALYZE and VACUUM commands, respectively. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, the commands from the redshift_maintenance macro are executed every night:</font></font><br>
<br>
<pre><code class="sql hljs">{% macro redshift_maintenance() %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> vacuumable_tables=run_query(vacuumable_tables_sql) %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">for</span> <span class="hljs-keyword">row</span> <span class="hljs-keyword">in</span> vacuumable_tables %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> message_prefix=loop.index ~ <span class="hljs-string">" of "</span> ~ loop.length %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{%- <span class="hljs-keyword">set</span> relation_to_vacuum = adapter.get_relation(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">database</span>=<span class="hljs-keyword">row</span>[<span class="hljs-string">'table_database'</span>],
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">schema</span>=<span class="hljs-keyword">row</span>[<span class="hljs-string">'table_schema'</span>],<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identifier=<span class="hljs-keyword">row</span>[<span class="hljs-string">'table_name'</span>]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) -%}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">do</span> run_query(<span class="hljs-string">"commit"</span>) %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">if</span> relation_to_vacuum %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> <span class="hljs-keyword">start</span>=modules.datetime.datetime.now() %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ dbt_utils.log_info(message_prefix ~ <span class="hljs-string">" Vacuuming "</span> ~ relation_to_vacuum) }}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">do</span> run_query(<span class="hljs-string">"VACUUM "</span> ~ relation_to_vacuum ~ <span class="hljs-string">" BOOST"</span>) %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ dbt_utils.log_info(message_prefix ~ <span class="hljs-string">" Analyzing "</span> ~ relation_to_vacuum) }}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">do</span> run_query(<span class="hljs-string">"ANALYZE "</span> ~ relation_to_vacuum) %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> <span class="hljs-keyword">end</span>=modules.datetime.datetime.now() %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">set</span> total_seconds = (<span class="hljs-keyword">end</span> - <span class="hljs-keyword">start</span>).total_seconds() | <span class="hljs-keyword">round</span>(<span class="hljs-number">2</span>)&nbsp; %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ dbt_utils.log_info(message_prefix ~ <span class="hljs-string">" Finished "</span> ~ relation_to_vacuum ~ <span class="hljs-string">" in "</span> ~ total_seconds ~ <span class="hljs-string">"s"</span>) }}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% <span class="hljs-keyword">else</span> %}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ dbt_utils.log_info(message_prefix ~ <span class="hljs-string">' Skipping relation "'</span> ~ row.values() | <span class="hljs-keyword">join</span> (<span class="hljs-string">'"."'</span>) ~ <span class="hljs-string">'" as it does not exist'</span>) }}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% endif %}<font></font>
&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;{% endfor %}<font></font>
&nbsp;<font></font>
{% endmacro %}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBT Cloud</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is possible to use DBT as a service (Managed Service). </font><font style="vertical-align: inherit;">In a set:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web IDE for developing projects and models</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Job configuration and schedule setting</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple and convenient access to logs</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web site with the documentation of your project</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CI (Continuous Integration) Connection</font></font></li>
</ul><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8cc/9bc/923/8cc9bc9236411e74d49472864f81fd06.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cooking and consuming DWH is just as enjoyable and beneficial as drinking smoothies. </font><font style="vertical-align: inherit;">DBT consists of Jinja, custom extensions (modules), compiler, engine (executor) and package manager. </font><font style="vertical-align: inherit;">Having collected these elements together you get a full-fledged working environment for your Data Warehouse. </font><font style="vertical-align: inherit;">There is hardly a better way to manage transformations within DWH today.</font></font><br>
<br>
<h1><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/869/0b7/b1e/8690b7b1e979e07c3afdd7cf2c839769.png"></div><br>
</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The beliefs followed by DBT developers are formulated as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code, not GUI, is the best abstraction for expressing complex analytic logic</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work with data should adapt the best practices of software development (Software Engineering)</font></font></li>
</ul><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Critical data infrastructure must be controlled by the user community as open source software</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not only analytics tools, but code will increasingly become part of the Open Source community.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These core beliefs have spawned a product that is used today by more than 850 companies, and they form the basis of many interesting extensions that will be created in the future. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For those who are interested, there is a video of an open lesson that I spent a few months ago as part of an open lesson in OTUS - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Build Tool for Amazon Redshift repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to DBT and Data Warehouses, as part of the Data Engineer course on the OTUS platform, my colleagues and I conduct classes on a number of other relevant and modern topics:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architectural Concepts for Big Data Applications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice with Spark and Spark Streaming</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learning methods and tools for loading data sources</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Building analytic showcases in DWH</font></font></li>
<li> NoSQL: HBase, Cassandra, ElasticSearch</li>
<li>    &nbsp;</li>
<li> :       </li>
</ul><br>
<h1>:</h1><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">DBT documentation — Introduction</a> —  </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">What, exactly, is dbt?</a> —      DBT&nbsp;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Data Build Tool   Amazon Redshift</a> — YouTube,    OTUS</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  Greenplum</a> —    15  2020</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  Data Engineering</a> — OTUS</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Building a Mature Analytics Workflow</a> —        </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">It’s time for open source analytics</a> —     Open Source</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Continuous Integration and Automated Build Testing with dbtCloud</a> —   CI   DBT</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Getting started with DBT tutorial</a> — ,     </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Jaffle shop — Github DBT Tutorial</a> — Github,   </li>
</ol><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  .</a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501368/index.html">Digital events in Moscow from May 11 to 17</a></li>
<li><a href="../en501370/index.html">Trello - an effective knowledge management system for a small IT team</a></li>
<li><a href="../en501374/index.html">Emulation Commodore 65</a></li>
<li><a href="../en501376/index.html">Agile teaches us the true meaning of Architecture</a></li>
<li><a href="../en501378/index.html">Navigating between views using @EnvironmentObject in SwiftUI</a></li>
<li><a href="../en501386/index.html">MNT Reform - Completely open notebook for paranoid</a></li>
<li><a href="../en501388/index.html">Is Agile possible for the whole company?</a></li>
<li><a href="../en501392/index.html">Responsive Font. Adapting text between layout and minimum values</a></li>
<li><a href="../en501394/index.html">About the translation of "theory" / "theoretically" without theory / theoretical</a></li>
<li><a href="../en501396/index.html">Interview with Sergey Zhuk - author of books and screencasts on ReactPHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>