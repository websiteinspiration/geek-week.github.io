<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ñ∂Ô∏è üßëüèø‚Äçü§ù‚Äçüßëüèº üë¶üèº DBLog - a common framework for Change Data Capture üëÉüèΩ üé≠ üñçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone! We offer you to read the translation of the article, which we prepared especially for students of the course "High Load Architect" .
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBLog - a common framework for Change Data Capture</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/494784/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone! </font><font style="vertical-align: inherit;">We offer you to read the translation of the article, which we prepared especially for students of the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"High Load Architect"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/0l/li/m7/0llim77k9jjhhp94nyd5qozgmxw.png"><br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tracking data changes (Change Data Capture, CDC) allows you to receive in real time the committed changes in the database and distribute them to various consumers [1] [2]. CDC is becoming increasingly popular when synchronization between heterogeneous data warehousing is required (for example, MySQL and ElasticSearch) and is an alternative to traditional methods such as dual-write and distributed transactions [3] [4].</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The source for the CDC, in databases such as MySQL and PostgreSQL, is the transaction log (transaction log). But since transaction logs are usually truncated, they may not contain the entire history of changes. Therefore, to obtain the full state of the source, we need dumps. We examined several open source CDC projects, often using the same libraries, database APIs, and protocols, and found a number of limitations in them that did not meet our requirements. For example, stopping the processing of log events until completion of the dump (full data snapshot), the inability to initiate dump dumping on demand or implementation, affecting write traffic due to the use of table locks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This led us to develop </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBLog.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a unified approach to processing logs and dumps. </font><font style="vertical-align: inherit;">To support it, a number of functions should be implemented in the DBMS, which are already in MySQL, PostgreSQL, MariaDB, and a number of other databases. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some of the features of DBLog:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log events are processed in the order they occur.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dumps can be made at any time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for all tables, for one table or for specific primary keys of a table.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log processing alternates with dump processing, dividing the dump into blocks. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, log processing can take place in parallel with dump processing. </font><font style="vertical-align: inherit;">If the process ends then it can be resumed after the last completed block without having to start all over again. </font><font style="vertical-align: inherit;">It also allows you to adjust the throughput when creating a dump and, if necessary, pause its creation.</font></font></li>
<li><b>   </b>,          .</li>
<li><b>   </b>: ,     API.</li>
<li><b>     </b>.    ,           .</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Earlier, we discussed </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), a platform for data enrichment and synchronization. The goal of Delta is to synchronize several data stores, where one of them is primary (for example, MySQL), and the other derivatives (for example, ElasticSearch). One of the key development requirements was a low delay in propagating changes from the source to the recipients, as well as a high availability of the event stream. These conditions apply regardless of whether all data warehouses are used by one team or if one team owns the data and the other consumes it. In an article on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), we also described use cases that go beyond data synchronization, such as event processing.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to synchronize data and process events, in addition to being able to track changes in real time, we need to fulfill the following requirements:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getting the full state</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Derived stores (such as ElasticSearch) should ultimately store the full state of the source. </font><font style="vertical-align: inherit;">We implement this through dumps of the original database.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start state recovery at any time. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead of considering the dump as a one-time operation only for primary initialization, we can do it at any time: for all tables, for one table or for specific primary keys. </font><font style="vertical-align: inherit;">This is very important for the recovery of consumers in cases of loss or damage to data.</font></font></li>
<li><b>    - </b>.          . ,        (,    ).              - .  ,  -        .</li>
<li><b>    </b>.                          .     API,     , ,  .        ,          ,  ,  .</li>
<li><b>   </b>.     Netflix   ,   Kafka, SQS, Kinesis,     Netflix,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Keystone</a>.   ,           (,    ),      (,    ).           .        API.</li>
<li><b>   </b>.  Netflix  ,    (MySQL, PostgreSQL)  AWS RDS.        .</li>
</ul><br>
<br>
<h3> </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We examined several existing open source solutions, including: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maxwell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SpinalTap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Yelp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL Streamer,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debezium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In terms of data collection, they all work in a similar way, using a transaction log. </font><font style="vertical-align: inherit;">For example, using the binlog replication protocol in MySQL or the replication slots in PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But when processing dumps, they have at least one of the following limitations:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stop processing log events while creating a dump</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">As a result, if the dump is large, then the processing of log events stops for a long period. </font><font style="vertical-align: inherit;">This will be a problem if consumers rely on small delays in propagating the changes.</font></font></li>
<li><b>     </b>.                .                (,   ElasticSearch)        .</li>
<li><b>      </b>.         .                    [5].          .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   </a>,         .         . ,  PostgreSQL RDS        .</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using specific database functions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We found that some solutions use additional database features that are not present on all systems. </font><font style="vertical-align: inherit;">For example, using the blackhole engine in MySQL or getting a consistent snapshot of dumps through replication slots in PostgreSQL. </font><font style="vertical-align: inherit;">This limits code reuse between different databases.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the end, we decided to take a different approach to working with dumps:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alternate log and dump events so that they can be executed together;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">start a dump at any time;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not use table locks</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not use specific database features.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBLog Framework</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog is a java framework for receiving dumps and changes in real time. Dumps are performed in parts so that they alternate with real-time events and do not delay their processing for a long period. Dumps can be made at any time through the API. This allows consumers to get the full state of the database at the initialization stage or later for disaster recovery. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When designing the framework, we thought about minimizing the impact on the database. Dumps can be paused and resumed as necessary. This works both for crash recovery and for stopping if the database has become a bottleneck. We also do not lock tables so as not to affect write operations.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog allows you to record events in various forms, including in another database or through the API. </font><font style="vertical-align: inherit;">To store the state associated with the processing of logs and dumps, as well as to select the master node, we use Zookeeper. </font><font style="vertical-align: inherit;">When creating DBLog, we implemented the ability to connect various plugins, allowing you to change the implementation as you like (for example, replace Zookeeper with something else). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we consider in more detail the processing of logs and dumps.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logs</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The framework requires the database to record events for each changed row in real time, while maintaining the order of commits. The source of these events is assumed to be the transaction log. The database sends them through a transport that DBLog can use. For this transport we use the term ‚Äúchange log‚Äù. An event can be of the following types: create, create, update, or delete. For each event, the following information must be provided: the sequence number in the log (log sequence number), the state of the column during the operation, and the scheme that was applied at the time the operation was performed.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each change is serialized into the DBLog event format and sent to writer, for its further transfer to the output. </font><font style="vertical-align: inherit;">Sending events to writer is a non-blocking operation, because writer runs in a separate thread and accumulates events in the internal buffer. </font><font style="vertical-align: inherit;">Buffered events are sent out in the order they were received. </font><font style="vertical-align: inherit;">The framework allows you to connect a custom formatter to serialize events into an arbitrary format. </font><font style="vertical-align: inherit;">Output is a simple interface that allows you to connect to any recipient, such as a stream, data warehouse, or even an API.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dumps</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dumps are necessary because transaction logs have a limited storage time, which prevents them from being used to restore the full original data set. Dumps are created in blocks (chunk) so that they can alternate with log events, allowing them to be processed simultaneously. For each selected line of the block, an event is generated and serialized in the same format as the log event. Thus, the consumer does not need to worry an event came from the log or dump. Both log events and dump events are sent to the output through the same writer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dumps can be scheduled at any time through the API for all tables, one table, or for specific primary keys of the table. A dump of the table is performed by blocks of a given size. You can also configure a delay in processing new blocks, allowing only log events at this time. The block size and delay allow you to balance the processing of log and dump events. Both settings can be changed at runtime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Blocks (chunk) are selected by sorting the table in ascending order of the primary key and selecting rows where the primary key is greater than the last primary key of the previous block. The database is required to execute this query efficiently, which is usually applicable to systems that implement a range scan on a range of primary keys.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/io/cc/kaioccujfq6yx3mcch7btisn-zo.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 1. Table breakdown with 4 columns c1-c4 and c1 as the primary key (pk). The primary key of an integer type, block size 3. Block 2 is selected by the condition c1&gt; 4.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Blocks must be taken in such a way as not to delay the processing of log events for a long period and save the change history so that the selected row with the old value could not overwrite the newer event.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to be able to select blocks sequentially, in the change log we create recognizable ‚Äúwatermarks‚Äù. </font><font style="vertical-align: inherit;">Watermarks are implemented through a table in the source database. </font><font style="vertical-align: inherit;">This table is stored in a special namespace so that there are no conflicts with the application tables. </font><font style="vertical-align: inherit;">Only one line with a UUID value is stored in it. </font><font style="vertical-align: inherit;">A watermark is created when this value changes to a specific UUID. </font><font style="vertical-align: inherit;">Updating the line leads to a change event, which we ultimately receive through the change log. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Watermarked dumps are created as follows:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We temporarily suspend the processing of log events.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generate a ‚Äúlow‚Äù watermark by updating the watermark table.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We start SELECT for the next block and save in memory the result indexed by the primary key.</font></font></li>
<li> ‚Äú‚Äù (high)  ,    .</li>
<li>    .         .</li>
<li>              ,     .</li>
<li>     ,     ,         .</li>
<li>   ,     1.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SELECT is supposed to return a state that represents a committed change up to a point in history. Or, equivalent to the following: SELECT is executed in a certain position of the change log, taking into account changes up to this point. Databases usually do not provide information about the execution time of a SELECT (with the exception of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main idea of ‚Äã‚Äãour approach is that in the change log we define a window that guarantees the preservation of the SELECT position in the block. The window is opened by writing the lower watermark, after which SELECT is executed, and the window is closed by writing the upper watermark. Since the exact position of the SELECT is unknown, all selected rows that conflict with the log events in this window are deleted. This ensures that there is no rewriting of the history in the change log. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this to work, SELECT must read the state of the table from the moment of the lower watermark or later (it is permissible to include the changes that were made after the lower watermark and before reading). In general, </font><b><font style="vertical-align: inherit;">SELECT</font></b><font style="vertical-align: inherit;"> is required to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">see changes made before it is executed.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We call it ‚Äúnon-stale reads‚Äù. In addition, since the upper watermark is written after, it is guaranteed that SELECT will be executed before it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figures 2a and 2b illustrate the block selection algorithm. As an example, we give a table with primary keys from k1 to k6. Each entry in the change log represents a create, update, or delete event for the primary key. Figure 2a shows the watermark generation and block selection (steps 1 to 4). Updating the watermark table in steps 2 and 4 creates two change events (magenta), which are ultimately received through the log. In Figure 2b, we focus on the lines of the current block that are removed from the result set with primary keys that appear between the watermarks (steps 5 to 7).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8w/3w/ej/8w3wej0evpfqtnpdkbozswm58yu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2a - Watermark algorithm for block selection (steps 1‚Äì4). </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/sg/i5/9s/sgi59s3d8zgf-f2eusi2itklqyu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2b - Watermark algorithm for selecting blocks (steps 5‚Äì7).</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Please note that between the lower and upper watermarks a large number of events can appear in the log if one or more transactions made many line changes. </font><font style="vertical-align: inherit;">For this reason, we do a short-term suspension of the processing of the log at stages 2‚Äì4 so as not to miss the watermarks. </font><font style="vertical-align: inherit;">Thus, the processing of log events can be resumed event by event, which ultimately allows you to detect watermarks without the need to cache log events of the log. </font><font style="vertical-align: inherit;">Log processing is suspended only for a short time, as steps 2‚Äì4 are expected to be quick: updating watermarks is a single write operation, and SELECT is performed with a restriction.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as the upper watermark is received in step 7, the non-conflicting lines of the block are transmitted to the output in the order they were received. </font><font style="vertical-align: inherit;">This is a non-blocking operation, because the writer runs in a separate thread, which allows you to quickly resume processing the log after step 7. After that, the processing of the log continues for events that occur after the upper watermark. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Figure 2c shows the recording order for the entire block using the same example as in figures 2a and 2b. </font><font style="vertical-align: inherit;">Events in the log that appear before the upper watermark are recorded first. </font><font style="vertical-align: inherit;">Then the remaining lines from the block result (magenta). </font><font style="vertical-align: inherit;">And finally, events that occur after the top watermark are recorded. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4y/er/et/4yeretd8vbgtxvbp7sm9ppdxe7m.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2c - The order of recording the output. </font><font style="vertical-align: inherit;">Strip alternation with dump.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supported Databases</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To use DBLog, the database must provide a change log as a linear history of committed changes with non-stale reads. These conditions are met by systems such as MySQL, PostgreSQL, MariaDB, etc., so the framework can be used in the same way with these databases. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So far, we have added support for MySQL and PostgreSQL. Each database uses its own libraries to receive log events, since each of them uses a proprietary protocol. For MySQL, we use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shyiko / mysql-binlog-connector</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which implements the binlog replication protocol. For PostgreSQL, there are replication slots with the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal2json</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plugin </font><font style="vertical-align: inherit;">. Changes are accepted through the streaming replication protocol, which is implemented by the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jdbc driver</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL </font><font style="vertical-align: inherit;">The schema definition for each captured change is different in MySQL and PostgreSQL. </font><font style="vertical-align: inherit;">In PostgreSQL, wal2json contains names, column types, and values. </font><font style="vertical-align: inherit;">For MySQL, schema changes should be tracked as binlog events. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dump processing was done using SQL and JDBC, requiring only the implementation of block selection and updating the watermark. </font><font style="vertical-align: inherit;">For MySQL and PostgreSQL, the same code is used, which can be used for other similar databases. </font><font style="vertical-align: inherit;">The dump processing itself is not dependent on SQL or JDBC and allows you to use databases that meet the requirements of DBLog, even if they use different standards. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wu/wg/nz/wuwgnzkxmagsrtt2_qnyp_yfiy8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 3 - High-level DBLog architecture.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">High availability</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog uses a single-node active-passive architecture. </font><font style="vertical-align: inherit;">One instance is active (leading), while the others are passive (standby). </font><font style="vertical-align: inherit;">To select the host, we use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zookeeper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A lease is used for the master node, which must be updated periodically to continue to be the master. </font><font style="vertical-align: inherit;">In case of termination of the renewal of the lease, the functions of the leader are transferred to another node. </font><font style="vertical-align: inherit;">Currently, we deploy one copy for each AZ (availability zone, usually we have 3 AZ), so if one AZ falls, then the copy in another AZ can continue processing with a minimum total downtime. </font><font style="vertical-align: inherit;">Backup instances can be located in different regions, although it is recommended that you work in the same region as the database host to provide low latency for capturing changes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use on Production</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog is the basis for the MySQL and PostgreSQL connectors used in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Since 2018, Delta has been used in production for synchronizing data warehouses and event processing in Netflix studio applications. </font><font style="vertical-align: inherit;">Delta connectors use their event serializer. </font><font style="vertical-align: inherit;">Netflix-specific streams such as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keystone</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are used as output </font><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5g/3j/fo/5g3jfo6pe8l-mpsqrngh6ylvtyc.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 4 - Delta Connector. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to Delta, DBLog is also used at Netflix to create connectors for other data movement platforms that have their own data formats.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stay with us</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DBLog has additional features that are not covered in this article, such as:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ability to get table schemas without using locks.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integration with schema storage. </font><font style="vertical-align: inherit;">For each event, the scheme is stored in the storage, the link to which is indicated in the event payload.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monotonic writes mode. </font><font style="vertical-align: inherit;">Ensuring that after saving the state of a particular row, its past state cannot be overwritten. </font><font style="vertical-align: inherit;">Thus, consumers receive state changes only in the forward direction, without moving back and forth in time.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We plan to open the DBLog source code in 2020 and include additional documentation in it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acknowledgments</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We would like to thank the following people for contributing to the development of DBLog: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Josh Snyder</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raghuram Onti Srinivasan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tharanga Gamaethige</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yun Wang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[1] Das, Shirshanka, et al. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúAll aboard the Databus !: Linkedin's scalable consistent change data capture platform.‚Äù </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Third ACM Symposium on Cloud Computing. </font><font style="vertical-align: inherit;">ACM, 2012 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[2] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúAbout Change Data Capture (SQL Server)‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Microsoft SQL docs, 2019 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[3] Kleppmann, Martin, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúUsing logs to build a solid data infrastructure (or: why dual writes are a bad idea)‚Äú</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Confluent, 2015 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[4] Kleppmann, Martin, Alastair R. Beresford, Boerge Svingen. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúOnline event processing.‚Äù </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Communications of the ACM 62.5 (2019): 43‚Äì49 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[5] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://debezium.io/documentation/reference/0.10/connectors/mysql.html#snapshots </font></font><br>
</a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn more about the course.</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494766/index.html">Near-future communications technology trends</a></li>
<li><a href="../en494772/index.html">How the fight against robotic calls is developing in the USA - on the measures of politicians and telecommunications companies</a></li>
<li><a href="../en494776/index.html">PostgreSQL Antipatterns: calculating conditions in SQL</a></li>
<li><a href="../en494780/index.html">Revelations and fears of an Amazon employee in the era of the coronavirus</a></li>
<li><a href="../en494782/index.html">Classify images on Android using TensorFlow Lite and Azure Custom Vision</a></li>
<li><a href="../en494786/index.html">MitM-like RTOS support in GDB</a></li>
<li><a href="../en494788/index.html">How email works</a></li>
<li><a href="../en494792/index.html">Yandex.Routing: how we plunged into logistics and decided to change the future</a></li>
<li><a href="../en494794/index.html">We have long arms</a></li>
<li><a href="../en494798/index.html">Snowden: pandemic will end, but surveillance of the population will remain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>