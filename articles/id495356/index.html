<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌋 🙌🏽 👗 Menerapkan Algoritma Konsensus RAFT untuk Penyimpanan KV Terdistribusi di Jawa 🖐🏾 📚 📏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo lagi. Beberapa hari yang lalu, pelatihan dimulai dalam kelompok baru pada kursus "Arsitek Perangkat Lunak" , dan hari ini kami ingin berbagi arti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Menerapkan Algoritma Konsensus RAFT untuk Penyimpanan KV Terdistribusi di Jawa</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/495356/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo lagi. Beberapa hari yang lalu, pelatihan dimulai dalam kelompok baru pada kursus </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Arsitek Perangkat Lunak"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dan hari ini kami ingin berbagi artikel yang ditulis oleh salah satu siswa kursus, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anton Pleshakov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (kepala pengembangan di Program Logistik dan salah satu pendiri di Clusterra).</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/pb/5h/qq/pb5hqqeunfv8gkvyvspmegwuj4w.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat ini, sistem microservice terdistribusi telah menjadi standar industri, dan tidak hanya di dunia usaha. Manfaat menggunakan sistem terdistribusi telah dijelaskan dan dibahas lebih dari satu kali. Keuntungan dari layanan microser telah lama diketahui oleh semua orang: teknologi untuk tugas, kompabilitas, skalabilitas, pengembangan skala, pengurangan TTM, dan sebagainya. Jelas bahwa pengembangan aplikasi terdistribusi menyediakan lebih banyak opsi untuk respons yang tepat waktu terhadap permintaan bisnis yang berkembang dan digitalisasi segala sesuatu di sekitarnya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penting juga untuk dicatat bahwa saat ini faktor yang sangat penting yang mempengaruhi pilihan strategi pengembangan yang mendukung layanan-mikro adalah ketersediaan semua jenis solusi infrastruktur siap pakai yang mengambil solusi masalah yang terkait dengan biaya tambahan pengoperasian sistem terdistribusi. Kita berbicara tentang sistem orkestrasi wadah, layanan mash, sarana penelusuran yang terdistribusi, pemantauan, penebangan dan sebagainya. Dapat dengan aman dinyatakan bahwa sebagian besar faktor yang sebelumnya disebutkan sebagai minus dari pendekatan layanan-mikro saat ini tidak memiliki pengaruh sebanyak beberapa tahun yang lalu.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berdasarkan realitas modern, sebagian besar pengembang mencari pada kesempatan pertama untuk beralih dari struktur monolitik ke struktur mikro. Salah satu langkah pertama yang dapat diambil tanpa menggunakan refactoring total dan dekomposisi serius adalah untuk mencapai sistem skalabilitas horizontal. Yaitu, untuk mengubah aplikasi monolitik Anda menjadi sebuah cluster, bahkan mungkin terdiri dari monolit yang sama, tetapi memungkinkan Anda untuk secara dinamis memvariasikan jumlahnya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika mencoba mencapai skalabilitas horizontal, pertanyaan tentang sinkronisasi data dalam sebuah cluster sangat cepat dan sangat akut muncul. Untungnya, semua DBMS modern mendukung replikasi data antara node dalam satu atau lain cara. Pengembang hanya perlu memilih DBMS untuk tugas tersebut dan memutuskan sifat sistem apa (sesuai dengan teorema CAP) yang ia butuhkan, CP atau AP, dan masalahnya telah teratasi. Dalam kasus ketika CP diperlukan dan persyaratan untuk konsistensi tinggi, salah satu metode untuk menyelesaikan masalah sinkronisasi data adalah dengan menggunakan cluster yang mendukung algoritma konsensus RAFT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algoritma yang agak baru ini (dikembangkan pada 2012) memberikan jaminan konsistensi yang tinggi dan sangat populer. Saya memutuskan untuk mencari tahu cara kerjanya, dan menulis implementasi saya dari repositori kunci-nilai yang konsisten di Java (Spring Boot).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apakah masuk akal untuk mengimplementasikan algoritma terdistribusi sendiri? Jelas bahwa Anda dapat mengambil implementasi yang sudah jadi dari algoritma terdistribusi, dan dengan tingkat probabilitas tertinggi implementasi ini akan lebih baik daripada "sepeda" buatan sendiri. Misalnya, Anda dapat menggunakan DBMS yang mempertahankan tingkat konsistensi yang diperlukan. Atau Anda bisa menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zookeeper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Atau Anda dapat menemukan kerangka kerja yang cocok untuk bahasa Anda. Untuk java, ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atomix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang dengan sempurna memecahkan masalah sinkronisasi data terdistribusi.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi di sisi lain. Jika Anda mengambil solusi turnkey, maka menggunakan aplikasi eksternal biasanya menambahkan titik kegagalan tambahan ke sistem Anda. Dan kerangka kerja bisa berlebihan atau sulit untuk dioperasikan dan dipelajari, atau mungkin tidak ada sama sekali untuk bahasa pemrograman Anda. Selain itu, implementasi independen dari algoritma konsensus adalah tugas rekayasa yang sangat menarik yang memperluas wawasan Anda dan memberi Anda pemahaman tentang bagaimana memecahkan masalah yang muncul ketika layanan berinteraksi dalam sebuah cluster menggunakan metode yang lebih optimal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena spesifikasi algoritme berisi serangkaian tindakan untuk menjaga integritas data, Anda dapat menggunakan pengetahuan yang diperoleh dan bahkan menggunakan algoritme secara keseluruhan. Bagian mana pun dari algoritma dapat bermanfaat dalam kehidupan nyata. Misalkan Anda memiliki satu set pekerja untuk mem-parsing file secara paralel. Pekerja adalah setara, tetapi Anda ingin menunjuk salah satu pekerja sebagai koordinator, dan ketika pekerja koordinator jatuh, tetapkan pekerja bebas lainnya sebagai koordinator. Bagian pertama dari algoritma RAFT, yang menjelaskan cara memilih pemimpin di antara node yang setara, akan membantu Anda dalam hal ini. Atau, misalnya, jika Anda hanya memiliki dua node dalam kaitannya dengan master-slave, Anda dapat menggunakan aturan replikasi yang dijelaskan dalam spesifikasi RAFT untuk mengatur pertukaran data dalam kasus yang lebih sederhana.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artikel ini pada dasarnya adalah panduan praktis tentang bagaimana menerapkan RAFT sendiri. </font><font style="vertical-align: inherit;">Algoritme itu sendiri dan aspek teoretis dari kerjanya tidak akan dipahami. </font><font style="vertical-align: inherit;">Anda dapat membaca deskripsi singkat di sini di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel luar biasa ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atau mempelajari spesifikasi lengkapnya di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Di sana Anda dapat menemukan visualisasi algoritma yang sangat jelas.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deskripsi Solusi Umum</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagian dari kode yang terkait langsung dengan implementasi algoritma dianalisis dalam artikel. </font><font style="vertical-align: inherit;">Di akhir artikel ada tautan ke repositori, tempat Anda dapat melihat seluruh kode.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tugasnya adalah sebagai berikut. </font><font style="vertical-align: inherit;">Kembangkan sistem terdistribusi yang memungkinkan Anda untuk menyimpan data dalam basis data nilai kunci. </font><font style="vertical-align: inherit;">Data dari setiap node harus konsisten, yaitu, jika data jatuh ke dalam basis data dari satu simpul dan sebagian besar dari node mengkonfirmasi bahwa mereka juga menerima data ini, maka cepat atau lambat data ini akan berada di basis data setiap node. </font><font style="vertical-align: inherit;">Ketika bagian dari cluster terputus dan ketika terhubung kembali, node yang berada di luar cluster harus mengejar ketinggalan dengan cluster utama dan menyinkronkan. </font><font style="vertical-align: inherit;">Setiap node menyediakan REST API untuk menulis dan membaca data basis data. </font><font style="vertical-align: inherit;">Sistem ini terdiri dari dua modul untuk dua jenis node: klien dan server. </font><font style="vertical-align: inherit;">Di bawah ini kami mempertimbangkan fitur-fitur dari implementasi server itu sendiri. </font><font style="vertical-align: inherit;">Kode klien ada di repositori. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Node server dapat beroperasi di tiga negara:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengikut (pengikut). </font><font style="vertical-align: inherit;">Menerima permintaan baca dari klien. </font><font style="vertical-align: inherit;">Mengambil detak jantung dari pemimpin</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calon (kandidat). </font><font style="vertical-align: inherit;">Menerima permintaan baca dari klien. </font><font style="vertical-align: inherit;">Mengirim permintaan suara ke node lain</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pemimpin </font><font style="vertical-align: inherit;">Menerima permintaan baca dan tulis. </font><font style="vertical-align: inherit;">Mengirim permintaan detak jantung ke node lain. </font><font style="vertical-align: inherit;">Mengirimkan menambahkan permintaan data ke node lain.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Periode "kepemimpinan" dari salah satu simpul disebut babak (term). </font><font style="vertical-align: inherit;">Seorang kandidat baru membuka babak baru.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penyimpanan data</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap node menyediakan akses ke repositori log operasi, di mana operasi untuk mengubah data direkam secara berurutan.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/operations/OperationsLog.java<br>
</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OperationsLog</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">append</span><span class="hljs-params">(Operation operation)</span></span>;
   <span class="hljs-function">Operation <span class="hljs-title">get</span><span class="hljs-params">(Integer index)</span></span>;
   <span class="hljs-function">List&lt;Operation&gt; <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
   <span class="hljs-function">Long <span class="hljs-title">getTerm</span><span class="hljs-params">(Integer index)</span></span>;
   <span class="hljs-function">Integer <span class="hljs-title">getLastIndex</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">Long <span class="hljs-title">getLastTerm</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">removeAllFromIndex</span><span class="hljs-params">(<span class="hljs-keyword">int</span> newOperationIndex)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap operasi, selain data dan tipe (masukkan, ubah, hapus), berisi jumlah putaran di mana ia dibuat. Selain itu, setiap operasi memiliki indeks yang meningkat secara berurutan. Adalah penting bahwa semua operasi dimasukkan ke dalam log pengikut dalam urutan yang sama di mana mereka dimasukkan ke dalam log pemimpin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap node memiliki akses ke database di mana data disimpan secara langsung.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/storage/Storage.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Storage</span> </span>{
   <span class="hljs-function">List&lt;Entry&gt; <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">String <span class="hljs-title">get</span><span class="hljs-params">(Long key)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(Long key, String val)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Long key, String val)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">(Long key)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam implementasi saat ini, solusi tertanam dalam memori digunakan baik untuk log dan untuk database (Daftar dan Peta kompetitif biasa). Jika perlu, Anda cukup mengimplementasikan antarmuka yang sesuai untuk mendukung jenis penyimpanan lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aplikasi operasi dari log ke database dilakukan oleh mesin status terdistribusi. Mesin negara adalah mekanisme yang bertanggung jawab untuk mengubah keadaan kluster, membatasi penggunaan perubahan yang salah (operasi yang tidak sesuai pesanan atau node terputus yang menganggap dirinya sebagai pemimpin). Agar perubahan dianggap valid dan agar dapat diterapkan ke database, mereka harus melewati serangkaian pemeriksaan dan memenuhi kriteria tertentu, yang persis seperti yang disediakan oleh mesin negara.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk seorang pemimpin, operasi diterapkan ke database jika sebagian besar node telah mengkonfirmasi fakta bahwa operasi direplikasi ke log mereka juga. </font><font style="vertical-align: inherit;">Untuk pengikut, operasi diterapkan ke basis data jika sinyal diterima dari pemimpin yang ia masuki ke dalam basis datanya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengatur waktu </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap node menyediakan pertukaran data dengan node lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dua jenis pertanyaan didukung:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memilih saat melakukan putaran pemungutan suara</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">append, alias detak jantung (jika tanpa data), untuk mereplikasi data log ke pengikut dan untuk mencegah dimulainya putaran suara baru.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fakta dari awal suatu peristiwa ditentukan oleh penghitung waktu. </font><font style="vertical-align: inherit;">Dua jenis timer diluncurkan pada node:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pilih. </font><font style="vertical-align: inherit;">Untuk memulai putaran pemungutan suara. </font><font style="vertical-align: inherit;">Setiap node memiliki intervalnya sendiri, setelah itu akan mencoba untuk memulai suara baru. </font><font style="vertical-align: inherit;">Hitungan mundur dimulai lagi ketika menerima detak jantung dari pemimpin.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">denyut jantung. </font><font style="vertical-align: inherit;">Untuk mengirim permintaan ke pengikut oleh pemimpin menambahkan. </font><font style="vertical-align: inherit;">Jika node tidak menerima detak jantung dan timer pemungutan suara telah kedaluwarsa, ia menjadi kandidat dan memulai pemilihan, meningkatkan jumlah putaran pemungutan suara dan mengirimkan permintaan pemungutan suara ke node lain. </font><font style="vertical-align: inherit;">Jika simpul mengumpulkan mayoritas suara, maka ia menjadi pemimpin dan mulai mengirimkan detak jantung.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keadaan node saat ini</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap node menyimpan data tentang keadaan saat ini.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/context/Context.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Context</span> </span>{
   <span class="hljs-function">Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//    </span>
   <span class="hljs-function">State <span class="hljs-title">getState</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//: , ,  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getVotedFor</span><span class="hljs-params">()</span></span>; 
               <span class="hljs-comment">//          </span>
   <span class="hljs-function">Long <span class="hljs-title">getCurrentTerm</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getCommitIndex</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//    </span>
   <span class="hljs-function">List&lt;Peer&gt; <span class="hljs-title">getPeers</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//      </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Node pemimpin juga menyimpan metadata untuk node yang digunakan untuk mereplikasi data.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/node/peers/Peer.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Peer</span> </span>{
   <span class="hljs-function">Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getNextIndex</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  ,    </span>
   <span class="hljs-function">Integer <span class="hljs-title">getMatchIndex</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//   </span>
   <span class="hljs-function">Boolean <span class="hljs-title">getVoteGranted</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//     </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metadata simpul diperbarui oleh pemimpin saat menerima tanggapan dari pengikut. </font><font style="vertical-align: inherit;">Mereka digunakan untuk menentukan oleh pemimpin operasi indeks berikutnya yang siap diterima oleh pengikut dan operasi mana yang telah ditambahkan ke log pengikut.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pemungutan suara</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kelas </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">ElectionService</font></a><font style="vertical-align: inherit;"> bertanggung jawab untuk memilih</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ElectionService</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processElection</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">AnswerVoteDTO <span class="hljs-title">vote</span><span class="hljs-params">(RequestVoteDTO requestVoteDTO)</span></span>;<font></font>
} </code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengirim permintaan untuk pemungutan suara </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika node adalah pengikut dan tidak menerima detak jantung untuk periode yang ditentukan untuk menunggu, maka ia meningkatkan putaran saat ini, menyatakan dirinya sebagai kandidat dan mulai mengirim permintaan suara ke node lain. </font><font style="vertical-align: inherit;">Jika dia berhasil mengumpulkan kuorum dan sebagian besar node memberikan suaranya, dia akan menjadi pemimpin baru. </font><font style="vertical-align: inherit;">Dalam istilah RAFT, kuorum lebih dari setengah dari semua simpul (51%). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita menganalisis metode </font></font><code>processElection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kelas </font></font><code>ElectionServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang dipanggil oleh penghitung waktu suara ketika suara berakhir dan mengirim node </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permintaan untuk memilih</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
 <br>
<pre><code class="java hljs"><span class="hljs-comment">//1</span><font></font>
context.setState(CANDIDATE); <font></font>
Long term = context.incCurrentTerm(); <font></font>
context.setVotedFor(context.getId()); <font></font>
<font></font>
List&lt;Integer&gt; peersIds = context.getPeers().stream().map(Peer::getId).collect(Collectors.toList());<font></font>
<span class="hljs-keyword">long</span> voteGrantedCount = <span class="hljs-number">1L</span>;
<span class="hljs-keyword">long</span> voteRevokedCount = <span class="hljs-number">0L</span>;<font></font>
<font></font>
<span class="hljs-comment">//2</span>
<span class="hljs-keyword">while</span> (checkCurrentElectionStatus(term)) {<font></font>
   List&lt;AnswerVoteDTO&gt; answers = getVoteFromAllPeers(term, peersIds);<font></font>
   peersIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
   <span class="hljs-keyword">for</span> (AnswerVoteDTO answer : answers) {
       <span class="hljs-comment">//3</span>
       <span class="hljs-keyword">if</span> (answer.getStatusCode().equals(OK)) {
           <span class="hljs-comment">//4</span>
           <span class="hljs-keyword">if</span> (answer.getTerm()&gt;context.getCurrentTerm()) {<font></font>
               context.setTermGreaterThenCurrent(answer.getTerm());<font></font>
               <span class="hljs-keyword">return</span>;<font></font>
           }<font></font>
           <span class="hljs-keyword">if</span> (answer.isVoteGranted()) {
               <span class="hljs-comment">//5 </span>
               context.getPeer(answer.getId()).setVoteGranted(<span class="hljs-keyword">true</span>);<font></font>
               voteGrantedCount++;<font></font>
           } <span class="hljs-keyword">else</span>
               <span class="hljs-comment">//6 </span><font></font>
               voteRevokedCount++;<font></font>
       } <span class="hljs-keyword">else</span> {<font></font>
          peersIds.add(answer.getId());<font></font>
       }<font></font>
   }<font></font>
  <span class="hljs-comment">//7</span>
  <span class="hljs-keyword">if</span> (voteGrantedCount &gt;= context.getQuorum()) {<font></font>
       winElection(term);<font></font>
       <span class="hljs-keyword">return</span>;<font></font>
   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (voteRevokedCount &gt;= context.getQuorum()) {<font></font>
       loseElection(term);<font></font>
       <span class="hljs-keyword">return</span>;<font></font>
   } </code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetapkan status "Calon". </font><font style="vertical-align: inherit;">Naikkan angka bulat dan pilih untuk diri kita sendiri.</font></font></li>
<li>  ,       (    ).  -  ,        ,           heartbeat                 .</li>
<li> -  ,    .    ,      ,     -. </li>
<li>       ,                            .     ,      heartbeat     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Node memilih kami! </font><font style="vertical-align: inherit;">Kami meningkatkan jumlah node yang memberikan suara untuk kami dan memperbaiki bahwa simpul ini memilih kami.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dipilih bukan untuk kita, kita juga percaya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika kuorum dikumpulkan dan simpul memenangkan pemilihan, kami menetapkan status "Pemimpin". </font><font style="vertical-align: inherit;">Kalau tidak, kita menjadi pengikut dan menunggu.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perlu juga dicatat bahwa ketika sebuah simpul menjadi pemimpin, Indeks Berikutnya diatur untuk setiap simpul dalam daftar node yang disimpan di pemimpin, yang sama dengan indeks terakhir dalam log pemimpin ditambah 1. Mulai dari indeks ini, pemimpin akan mencoba memperbarui log pengikut. </font><font style="vertical-align: inherit;">Bahkan, indeks yang disimpan oleh pemimpin ini mungkin tidak sesuai dengan indeks sebenarnya dari log pengikut dan nilai aktual hanya akan diperoleh saat bertukar data dengan pengikut dan akan disesuaikan. </font><font style="vertical-align: inherit;">Tetapi beberapa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">titik awal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diperlukan </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">winElection</span><span class="hljs-params">(Long term)</span> </span>{<font></font>
       context.setState(LEADER);<font></font>
       context.getPeers().forEach(peer -&gt;<font></font>
               peer.setNextIndex(operationsLog.getLastIndex()+<span class="hljs-number">1</span>)<font></font>
<font></font>
       );<font></font>
   }</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voting memproses permintaan </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat memilih, setiap node menerima </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permintaan dari formulir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> berikut </font><font style="vertical-align: inherit;">dari kandidat </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestVoteDTO</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long term; <span class="hljs-comment">//     </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer candidateId; <span class="hljs-comment">//  </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer lastLogIndex; <span class="hljs-comment">//     </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long lastLogTerm; <span class="hljs-comment">//       </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang mari kita lihat prosedur </font></font><code>vote</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kelas </font></font><code>ElectionServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, itu memproses permintaan suara dari kandidat dan mengembalikan keputusan mengenai pencalonannya untuk peran pemimpin.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/election/ElectionServiceImpl.java#L178 <br>
</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> AnswerVoteDTO <span class="hljs-title">vote</span><span class="hljs-params">(RequestVoteDTO dto)</span> </span>{<font></font>
   <font></font>
       <span class="hljs-keyword">boolean</span> termCheck;
       <span class="hljs-comment">//1</span>
       <span class="hljs-keyword">if</span> (dto.getTerm() &lt; context.getCurrentTerm())
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerVoteDTO(context.getId(),context.getCurrentTerm(),<span class="hljs-keyword">false</span>);
       <span class="hljs-keyword">else</span> <span class="hljs-comment">//2</span>
       <span class="hljs-keyword">if</span> (dto.getTerm().equals(context.getCurrentTerm())) {<font></font>
           termCheck = (context.getVotedFor() == <span class="hljs-keyword">null</span>||<font></font>
                          context.getVotedFor().equals(dto.getCandidateId()));<font></font>
       }<font></font>
       <span class="hljs-keyword">else</span>
       {   <span class="hljs-comment">//3</span>
           termCheck = <span class="hljs-keyword">true</span>;<font></font>
             context.setTermGreaterThenCurrent(dto.getTerm());<font></font>
       }<font></font>
<font></font>
       <span class="hljs-comment">//4  </span>
       <span class="hljs-keyword">boolean</span> logCheck = !((operationsLog.getLastTerm() &gt; dto.getLastLogTerm()) ||<font></font>
               ((operationsLog.getLastTerm().equals(dto.getLastLogTerm())) &amp;&amp;<font></font>
                       (operationsLog.getLastIndex() &gt; dto.getLastLogIndex())));<font></font>
<font></font>
<font></font>
       <span class="hljs-keyword">boolean</span> voteGranted = termCheck&amp;&amp;logCheck;<font></font>
<font></font>
       <span class="hljs-comment">//5</span>
       <span class="hljs-keyword">if</span> (voteGranted) {<font></font>
           context.setVotedFor(dto.getCandidateId());<font></font>
       }<font></font>
       <span class="hljs-comment">//6   </span>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerVoteDTO(context.getId(),context.getCurrentTerm(),voteGranted);<font></font>
   }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah menerima permintaan dari seorang kandidat, simpul melakukan dua pemeriksaan: memeriksa putaran kandidat dan panjang log-nya. </font><font style="vertical-align: inherit;">Jika ronde kandidat lebih tinggi dan log-nya lebih panjang atau sama, maka node memberikan simpulnya suara untuk kandidat</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika putaran simpul saat ini lebih besar daripada putaran kandidat, kami menolak, karena ini adalah permintaan dari beberapa simpul yang tertinggal, yang, tampaknya, berada di luar cluster untuk beberapa waktu dan memulai prosedur pemilihan karena tidak melihat pemimpin saat ini. </font></font></li>
<li>   ,   , ,           ,        ,     ,       ;       .              —    .</li>
<li>     ,     </li>
<li> .                   ,            ,  ,        ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan hasil positif, kami memperbaiki fakta bahwa simpul tersebut ikut serta dalam pemilihan dan memberikan suara untuk kandidat.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kirim hasilnya kembali ke kandidat</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tentunya, kondisinya bisa ditulis agak lebih pendek dan lebih elegan, tetapi saya meninggalkan opsi yang lebih "naif" agar tidak bingung sendiri dan tidak membingungkan siapa pun. </font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replikasi </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pemimpin penghitung waktu mengirimkan pengikut detak jantung ke semua node untuk mengatur ulang penghitung waktu pemilihan mereka. Karena pemimpin menyimpan dalam indeks metadata operasi terakhir dari semua pengikut, ia dapat mengevaluasi apakah mengirim operasi ke node diperlukan. Jika log operasi pemimpin menjadi lebih panjang dari log pengikut mana pun, maka ia, bersama dengan detak jantung, secara berurutan mengirimkan kepadanya operasi yang hilang. Sebut saja tambahkan permintaan. Jika sebagian besar node mengkonfirmasi penerimaan operasi baru, pemimpin menerapkan operasi ini ke database-nya dan meningkatkan indeks operasi yang diterapkan terakhir. Indeks ini juga dikirim ke pengikut bersama dengan permintaan detak jantung. Dan jika indeks pemimpin lebih tinggi dari indeks pengikut, maka pengikut juga menerapkan operasi ke database untuk menyamakan indeks. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jenis tambahan ini meminta pemimpin mengirim ke pengikut</font></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestAppendDTO</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long term; <span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer leaderId; <span class="hljs-comment">//   </span><font></font>
<font></font>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer prevLogIndex;<span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long prevLogTerm;<span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer leaderCommit;<span class="hljs-comment">//      </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Operation operation; <span class="hljs-comment">//</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada implementasi di mana operasi ditransfer dalam batch beberapa permintaan. </font><font style="vertical-align: inherit;">Dalam implementasi saat ini, hanya satu operasi yang dapat ditransmisikan per </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
permintaan. Kelas merespons pengiriman dan pemrosesan permintaan detak jantung-append:</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/replication/ReplicationService.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ReplicationService</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">appendRequest</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">AnswerAppendDTO <span class="hljs-title">append</span><span class="hljs-params">(RequestAppendDTO requestAppendDTO)</span></span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kirim permintaan perubahan data </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertimbangkan fragmen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">metode</font></a></font><code>sendAppendForOnePeer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kelas </font></font><code>ReplicationServiceImpl</code><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Metode ini bertanggung jawab untuk membuat permintaan kepada pengikut dan mengirimkannya</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> CompletableFuture&lt;AnswerAppendDTO&gt; <span class="hljs-title">sendAppendForOnePeer</span><span class="hljs-params">(Integer id)</span> </span>{
   <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
       <span class="hljs-keyword">try</span> {
           <span class="hljs-comment">//1</span><font></font>
           Peer peer = context.getPeer(id);<font></font>
<font></font>
           Operation operation;<font></font>
           Integer prevIndex;<font></font>
           <span class="hljs-comment">//2    </span>
           <span class="hljs-keyword">if</span> (peer.getNextIndex() &lt;= operationsLog.getLastIndex()) {<font></font>
               operation = operationsLog.get(peer.getNextIndex());<font></font>
               prevIndex = peer.getNextIndex() - <span class="hljs-number">1</span>;<font></font>
           } <span class="hljs-keyword">else</span> 
           <span class="hljs-comment">//3  </span><font></font>
           {<font></font>
               operation = <span class="hljs-keyword">null</span>;<font></font>
               prevIndex = operationsLog.getLastIndex();<font></font>
           }<font></font>
<font></font>
<font></font>
           RequestAppendDTO requestAppendDTO = <span class="hljs-keyword">new</span> RequestAppendDTO(<font></font>
                   context.getCurrentTerm(), <span class="hljs-comment">//   </span>
                   context.getId(), <span class="hljs-comment">//  </span>
                   prevIndex,<span class="hljs-comment">//      </span>
                   operationsLog.getTerm(prevIndex),<span class="hljs-comment">//  </span><font></font>
                   context.getCommitIndex(),<font></font>
                               <span class="hljs-comment">//      </span>
                   Operation <span class="hljs-comment">//</span><font></font>
           );<font></font>
<font></font>
...<font></font>
<span class="hljs-comment">/*   http     */</span>
}</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metadata pengikut</font></font></li>
<li>   ,   .             (      ),          ,      ,  ,   .    ,       ,    ,   ,     </li>
<li>   ,    ,       ;        ,     ,       ,  </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, pertimbangkan metode </font></font><code>appendRequest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kelas </font></font><code>ReplicationServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang bertanggung jawab untuk mengirim permintaan append dan memproses hasilnya ke semua pengikut.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/replication/ReplicationServiceImpl.java#L109</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">appendRequest</span><span class="hljs-params">()</span> </span>{<font></font>
       List&lt;Integer&gt; peersIds = context.getPeers().stream().map(Peer::getId).collect(Collectors.toList());<font></font>
<font></font>
       <span class="hljs-comment">//1 </span>
       <span class="hljs-keyword">while</span> (peersIds.size() &gt; <span class="hljs-number">0</span>) {
           <span class="hljs-comment">//2 </span><font></font>
           List&lt;AnswerAppendDTO&gt; answers = sendAppendToAllPeers(peersIds);<font></font>
           peersIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
           <span class="hljs-keyword">for</span> (AnswerAppendDTO answer : answers) {
               <span class="hljs-comment">//3</span>
               <span class="hljs-keyword">if</span> (answer.getStatusCode().equals(OK)) {
                   <span class="hljs-comment">//4</span>
                   <span class="hljs-keyword">if</span> (answer.getTerm() &gt; context.getCurrentTerm()) {<font></font>
                        context.setTermGreaterThenCurrent(answer.getTerm());<font></font>
                       <span class="hljs-keyword">return</span>;<font></font>
                   }<font></font>
                   Peer peer = context.getPeer(answer.getId());<font></font>
                   <span class="hljs-comment">//5     </span>
                   <span class="hljs-keyword">if</span> (answer.getSuccess()) {                      <font></font>
                       peer.setNextIndex(answer.getMatchIndex() + <span class="hljs-number">1</span>);<font></font>
                       peer.setMatchIndex(answer.getMatchIndex());<font></font>
                       <span class="hljs-keyword">if</span> (peer.getNextIndex() &lt;= operationsLog.getLastIndex())<font></font>
                           peersIds.add(answer.getId());<font></font>
                   <span class="hljs-comment">//6      </span>
                   } <span class="hljs-keyword">else</span> {<font></font>
                       peer.decNextIndex();<font></font>
                       peersIds.add(answer.getId());<font></font>
                   }<font></font>
               }<font></font>
           }<font></font>
           <span class="hljs-comment">//7</span><font></font>
           tryToCommit();<font></font>
       }<font></font>
}<font></font>
</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengulangi permintaan sampai kami menerima tanggapan dari semua pengikut bahwa replikasi berhasil. </font><font style="vertical-align: inherit;">Karena satu operasi dikirim per permintaan, mungkin diperlukan beberapa iterasi untuk menyinkronkan log pengikut</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kirim permintaan ke semua pengikut dan dapatkan daftar dengan jawaban </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menganggap jawaban hanya dari pengikut yang tersedia</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika ternyata putaran salah satu pengikut lebih dari putaran pemimpin, kami menghentikan semuanya dan berubah menjadi pengikut </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika pengikut menjawab bahwa semuanya berjalan dengan baik, kami memperbarui metadata pengikut: kami menyimpan indeks terakhir dari log pengikut dan indeks dari operasi berikutnya yang diharapkan oleh pengikut. </font></font></li>
<li>  ,    ,  ,           ,           .  ,                  ,      .     ,         .    ,          .</li>
<li>        ,      .     . </li>
</ol><br>
<h3>     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang mari kita lihat </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bagaimana sebenarnya pengikut memproses permintaan tambahan dari pemimpin. </font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Metode </font></font><code>append</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kelas</font></font><code>ReplicationServiceImpl</code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> AnswerAppendDTO <span class="hljs-title">append</span><span class="hljs-params">(RequestAppendDTO dto)</span> </span>{<font></font>
     <font></font>
       <span class="hljs-comment">//1     </span>
       <span class="hljs-keyword">if</span> (dto.getTerm() &lt; context.getCurrentTerm()) {
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(),context.getCurrentTerm(),<span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<font></font>
       } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dto.getTerm() &gt; context.getCurrentTerm()) {
           <span class="hljs-comment">//2 </span><font></font>
           context.setCurrentTerm(dto.getTerm());<font></font>
           context.setVotedFor(<span class="hljs-keyword">null</span>);<font></font>
       }<font></font>
       <span class="hljs-comment">//3  </span>
       applicationEventPublisher.publishEvent(<span class="hljs-keyword">new</span> ResetElectionTimerEvent(<span class="hljs-keyword">this</span>));<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (!context.getState().equals(FOLLOWER)) {<font></font>
           context.setState(FOLLOWER);<font></font>
       }<font></font>
        <font></font>
       <span class="hljs-comment">//4  </span>
       <span class="hljs-keyword">if</span> ((dto.getPrevLogIndex() &gt; operationsLog.getLastIndex()) ||                                                                                        !dto.getPrevLogTerm().equals(operationsLog.getTerm(dto.getPrevLogIndex()))) {
                      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<font></font>
       }<font></font>
<font></font>
<font></font>
       Operation newOperation = dto.getOperation();<font></font>
       <span class="hljs-keyword">if</span> (newOperation != <span class="hljs-keyword">null</span>) {
           <span class="hljs-keyword">int</span> newOperationIndex = dto.getPrevLogIndex() + <span class="hljs-number">1</span>;<font></font>
           <font></font>
         <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {
               <span class="hljs-comment">//5</span>
               <span class="hljs-keyword">if</span> ((newOperationIndex &lt;= operationsLog.getLastIndex()) &amp;&amp;<font></font>
                      (!newOperation.getTerm().equals(operationsLog.getTerm(newOperationIndex)))){<font></font>
                   operationsLog.removeAllFromIndex(newOperationIndex);<font></font>
               }<font></font>
               <span class="hljs-comment">//6</span>
               <span class="hljs-keyword">if</span> (newOperationIndex &lt;= operationsLog.getLastIndex())<font></font>
               {<font></font>
                 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">true</span>,      operationsLog.getLastIndex());<font></font>
               }<font></font>
               <span class="hljs-comment">//7</span><font></font>
               operationsLog.append(newOperation);<font></font>
           }<font></font>
        }<font></font>
        <span class="hljs-comment">//8 </span>
        <span class="hljs-keyword">if</span> (dto.getLeaderCommit() &gt; context.getCommitIndex()) {<font></font>
           context.setCommitIndex(Math.min(dto.getLeaderCommit(), operationsLog.getLastIndex()));<font></font>
       }<font></font>
<font></font>
                 <font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">true</span>, operationsLog.getLastIndex());<font></font>
   }</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika ronde pemimpin kurang dari ronde pengikut, maka kami mengirim ronde pemimpin kami dan tanda bahwa permintaannya telah ditolak. </font><font style="vertical-align: inherit;">Begitu pemimpin menerima satu ronde yang lebih besar daripada tanggapannya, dia akan berubah menjadi pengikut</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika ronde pemimpin lebih dari ronde pengikut, atur ronde ini ke pengikut.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Karena permintaan diterima dari pemimpin, terlepas dari apakah ada data di sana atau tidak, kami menyetel ulang penghitung waktu suara dan, jika kami bukan pengikut, kami menjadi pengikutnya. </font></font></li>
<li>   ,   ,            ,  ,   ,    ,   .        ,    ,      </li>
<li>              ,   .            .   ,     , - ,   ,      ,      ,      .             ,    .</li>
<li>  ,   .  ,    </li>
<li>  ,     </li>
<li>        ,   ,       ,    . </li>
</ol><br>
<h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetap hanya untuk mengetahui bagaimana pemimpin menerapkan operasi dari log ke database. Dalam proses pengiriman operasi kepada pengikut dan pemrosesan tanggapan dari mereka, pemimpin memperbarui metadata dari node. Segera setelah jumlah node yang indeks operasi terakhir dalam log lebih besar dari indeks operasi terakhir yang diterapkan ke database oleh pemimpin menjadi sama dengan kuorum, kita dapat menyatakan bahwa sebagian besar node menerima operasi dan kita dapat menerapkannya pada database pemimpin. Dengan kata lain, jika seorang pemimpin mengirim operasi ke pengikut dan sebagian besar dari mereka memasukkannya ke dalam log-nya dan menjawab pemimpin itu, maka kita dapat menerapkan operasi ini ke basis data pemimpin dan meningkatkan indeks operasi terakhir yang diterapkan. Indeks ini dengan permintaan append-heartbeat berikutnya akan terbang ke pengikut dan itu akan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menerapkan operasi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan indeks yang sama dari log-nya ke database-nya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita menganalisis metode </font></font><code>tryToCommit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kelas</font></font><code>ReplicationServiceImpl</code><br>
<br>
<pre><code class="java hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tryToCommit</span><span class="hljs-params">()</span> </span>{
       <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
           <span class="hljs-comment">//1</span>
           <span class="hljs-keyword">int</span> N = context.getCommitIndex() + <span class="hljs-number">1</span>;
           <span class="hljs-comment">//2</span><font></font>
           Supplier&lt;Long&gt; count = () -&gt;<font></font>
               context.getPeers().stream().map(Peer::getMatchIndex).<font></font>
                       filter(matchIndex -&gt; matchIndex &gt;= N).count() + <span class="hljs-number">1</span>;<font></font>
<font></font>
           <span class="hljs-comment">//3 </span>
           <span class="hljs-keyword">if</span> (operationsLog.getLastIndex() &gt;= N &amp;&amp;<font></font>
                   operationsLog.getTerm(N).equals(context.getCurrentTerm())&amp;&amp;<font></font>
                      count.get()&gt;=context.getQuorum()<font></font>
           )<font></font>
           {<font></font>
               context.setCommitIndex(N);<font></font>
           } <span class="hljs-keyword">else</span>
               <span class="hljs-keyword">return</span>;<font></font>
       }<font></font>
   }</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mendapatkan indeks operasi berikut yang diterapkan ke database</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menghitung berapa banyak pengikut yang memiliki operasi dengan indeks sedemikian dalam log mereka, dan jangan lupa untuk menambahkan seorang pemimpin </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika jumlah pengikut seperti itu adalah kuorum dan operasi dengan indeks seperti itu ada di log pemimpin, dan putaran operasi ini setara dengan yang sekarang, maka pemimpin menerapkan operasi ke database dan meningkatkan indeks operasi yang terakhir diterapkan. </font><font style="vertical-align: inherit;">Operasi dari babak sebelumnya tidak dapat diterapkan, karena pemimpin lain bertanggung jawab atas mereka dan konflik dapat muncul. </font><font style="vertical-align: inherit;">Setiap pemimpin hanya menerapkan operasi putarannya saat ini.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap algoritma terdistribusi, yang mewakili keluarga RAFT, adalah solusi terintegrasi yang kuat yang menjamin pencapaian hasil, tunduk pada semua aturan yang dijelaskan dalam spesifikasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada banyak algoritma terdistribusi dan mereka berbeda. Ada ZAB, yang diterapkan di Zookeeper dan digunakan, misalnya, untuk menyinkronkan data di Kafka. Ada algoritma dengan persyaratan yang kurang ketat untuk konsistensi, misalnya, massa implementasi protokol Gossip yang digunakan dalam sistem AP. Ada algoritma yang mengikuti prinsip-prinsip RAFT, dan pada saat yang sama menggunakan protokol gosip untuk bertukar log seperti MOKKA, yang juga menggunakan enkripsi.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya percaya bahwa mencoba mencari tahu salah satu dari algoritma ini sangat berguna untuk setiap pengembang, dan seperti yang saya sebutkan di atas, solusi dapat menarik baik secara komprehensif maupun di bagian yang terpisah. </font><font style="vertical-align: inherit;">Dan jelas, Anda pasti perlu melihat ke arah ini kepada mereka yang kegiatannya terkait dengan pengembangan sistem terdistribusi dan mengenai masalah sinkronisasi data, bahkan jika mereka menggunakan solusi industri standar.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referensi</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositori</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spesifikasi</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deskripsi Singkat</font></font></a></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami berharap materi ini bermanfaat bagi Anda. </font><font style="vertical-align: inherit;">Dan jika Anda ingin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengikuti kursus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Anda bisa melakukannya sekarang.</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id495342/index.html">Penyelesaian kartu bank dalam perdagangan - membuat dataset terbuka dan infografis di Google Data Studio</a></li>
<li><a href="../id495344/index.html">Menyatukannya: bagaimana Lamoda membuat layanan Go-nya konsisten</a></li>
<li><a href="../id495346/index.html">Dari kesalahan hingga peringatan dengan tindakan</a></li>
<li><a href="../id495350/index.html">Server web rumah, atau penyedia hosting Anda sendiri</a></li>
<li><a href="../id495354/index.html">Bagaimana cara melepaskan produk secara terus menerus dalam 20 bahasa dan tidak mati?</a></li>
<li><a href="../id495360/index.html">Cara kami mengotomatiskan produk porting dari C # ke C ++</a></li>
<li><a href="../id495362/index.html">Mengasingkan diri dan memprogram: bagaimana tidak menjadi gila di rumah dan menghabiskan waktu dengan bermanfaat</a></li>
<li><a href="../id495364/index.html">Panduan Gaya API, atau jangan buat pengguna berpikir</a></li>
<li><a href="../id495366/index.html">16 jenis programmer, atau Pengembang bukan robot yang sama</a></li>
<li><a href="../id495368/index.html">Kami mendaftar sendiri untuk self-walking self-dog dalam kondisi isolasi diri</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>