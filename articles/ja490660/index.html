<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦎 🧘🏼 🤚🏽 CityMobileの成長をどのように確保したか 🙌🏼 🧙🏻 💯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私の名前はイワンです。私はシティモービルのサーバー開発の責任者です。今日は、まさにこのサーバー開発とは何か、どのような問題が発生したのか、どのように開発する予定なのかについてお話します。
 
 成長の始まり
 CityMobileが13年という長い間存在していたことを知っている人はほとんどいません。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CityMobileの成長をどのように確保したか</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/citymobil/blog/490660/"><img src="https://habrastorage.org/webt/zp/vs/q8/zpvsq8dn-snye4kfqv2ktymbip8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の名前はイワンです。私はシティモービルのサーバー開発の責任者です。</font><font style="vertical-align: inherit;">今日は、まさにこのサーバー開発とは何か、どのような問題が発生したのか、どのように開発する予定なのかについてお話します。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成長の始まり</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CityMobileが13年という長い間存在していたことを知っている人はほとんどいません。かつてはモスクワでのみ働いていた小さな会社でした。開発者はほとんどいませんでしたが、システムがどのように機能するかをよく知っていました。タクシー市場はちょうどその時発展し始めていました、荷はペニーでした。フォールトトレランスとスケーリングを提供するタスクすらありませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2018年、Mail.Ru GroupはCityMobileに投資し、急速に成長し始めました。プラットフォームを書き直す時間もなければ、少なくとも重要なリファクタリングもありませんでした。主な競合他社に追いつき、すぐに人を雇うためには、その機能を開発する必要がありました。私が入社したとき、バックエンドに関与していた開発者はわずか20人で、ほとんど全員が試用中でした。したがって、私たちは「ぶらさがりの果物」を選ぶことにしました。大きな結果をもたらす簡単な変更を加えることです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当時、PHPにモノリスとGoに3つのサービスがあり、モノリスがアクセスしていたMySQLに1つのマスターベースがありました（サービスはRedisとEasticSearchのリポジトリとして使用されていました）。そして、徐々に、負荷の増加に伴い、重いシステム要求がベースを遅くし始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで何ができるでしょうか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、私たちは明白な一歩を踏み出しました：奴隷を生産に入れます。しかし、多くの重い要求が彼に来るならば、彼はそれに耐えますか？また、分析レポートのリクエストが多すぎると、奴隷が遅れ始めることも明らかでした。スレーブの強力なバックログは、CityMobile全体のパフォーマンスに悪影響を与える可能性があります。その結果、アナリストのためにもう1つのスレーブを配置しました。そのラグは、製品の問題につながることはありません。しかし、これでも十分ではないように見えました。 ClickhouseでMySQLのテーブルレプリケーターを作成しました。そして今日、分析はOLAP向けに設計されたスタックを使用して、それ自体で機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この形式では、システムはしばらくの間機能し、その後ハードウェアでより要求の厳しい機能が現れ始めました。</font><font style="vertical-align: inherit;">毎週、ますます多くのリクエストがありました。新しいレコードなしで1週間も経過していませんでした。</font><font style="vertical-align: inherit;">さらに、システムの下に時限爆弾を配置しました。</font><font style="vertical-align: inherit;">以前は、MySQLマスターベースの障害点が1つしかありませんでしたが、スレーブが追加されたため、マスターとスレーブの2つの点がありました。</font><font style="vertical-align: inherit;">これらのマシンのいずれかに障害が発生すると、システムに完全な障害が発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを防ぐために、ローカルプロキシを使用してヘルスチェックスレーブを実行するようになりました。</font><font style="vertical-align: inherit;">これにより、コードを変更せずに多くのスレーブを使用できました。</font><font style="vertical-align: inherit;">各スレーブのステータスとその一般的なメトリックの定期的な自動チェックを導入しました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スレーブラグ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポートの可用性。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロック数など</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定のしきい値を超えると、システムは負荷からスレーブを削除します。</font><font style="vertical-align: inherit;">ただし、同時に引き出すことができるのは半分のスレーブだけなので、残りのスレーブの負荷が増加するため、スレーブは自分でダウンタイムを調整できません。</font><font style="vertical-align: inherit;">プロキシとして、HAProxyを使用し、すぐにバックログにProxySQLに切り替える計画を含めました。</font><font style="vertical-align: inherit;">選択は多少奇妙でしたが、私たちの管理者はすでにHAProxyでの作業に優れた経験があり、問題は深刻で、早期の解決策が必要でした。</font><font style="vertical-align: inherit;">したがって、スレーブ用のフェイルセーフシステムを作成しました。</font><font style="vertical-align: inherit;">彼女のシンプルさのために、彼女は決して私たちを失望させませんでした。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらなる成長</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスが発展するにつれて、システムに別のボトルネックが見つかりました。外部の状況の変化（たとえば、降雨が広い地域で始まった）により、タクシーの注文数は急速に増加しました。そのような状況では、ドライバーは十分に迅速に反応する時間がなく、車が不足していました。注文が配信されている間、MySQLスレーブにループで負荷がかかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは成功した解決策を見つけました-Tarantool。そのためにシステムを書き換えるのは困難だったので、別の方法で問題を解決しました：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">mysql-tarantool-replication</font></a><font style="vertical-align: inherit;">ツールを使用する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQLからTarantoolにいくつかのテーブルの複製を作成しました。車が不足している間に生じたすべての読書要求は、タランツールで放送を開始し、それ以来、雷雨やハリケーンの心配はなくなりました！さらに、障害点の問題をさらに簡単に解決しました。HAProxyを介してヘルスチェックにアクセスするいくつかのレプリカをすぐにインストールしました。 Tarantoolの各インスタンスは、個別のレプリケーターによって複製されます。楽しいボーナスとして、このコードセクションでスレーブの遅延の問題も解決しました。MySQLからTarantoolへのレプリケーションは、MySQLからMySQLへのレプリケーションよりもはるかに速く機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、私たちのマスターベースは依然として障害点であり、レコーディングオペレーションに対応できませんでした。私たちはこの方法でこの問題を解決し始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、その時点で、私たちはすでに積極的に新しいサービス（たとえば、私の同僚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が書いた</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">詐欺対策）の作成を始めていました</font><font style="vertical-align: inherit;">。さらに、サービスにはストレージのスケーラビリティがすぐに必要でした。 Redisの場合はRedis-clusterのみ、Tarantool-Vshardの使用を開始しました。 MySQLを使用する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、新しいロジックに</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Vitess</font></a><font style="vertical-align: inherit;">を使用し始めました</font><font style="vertical-align: inherit;">。このようなデータベースはすぐにシャーディング可能であるため、レコーディングに問題はほとんどなく、突然発生した場合はサーバーを追加することで簡単に解決できます。現在、重要ではないサービスにのみVitessを使用し、落とし穴を調査していますが、将来的にはすべてのMySQLデータベースに適用される予定です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第2に、既存のロジックにVitessを実装するのは困難で長いため、普遍的ではありませんが、よりシンプルな方法で行きました。マスターベースをさまざまなサーバーにテーブルごとに配布し始めました。幸運なことに、レコードの主な負荷は、主な機能にとって重要ではないテーブルによって作成されていることがわかりました。そして、そのようなテーブルを作成するときに、ビジネス障害の追加ポイントを作成しません。私たちにとっての主な敵は、JOINを使用するコード内のテーブルの強いつながりです（JOINとそれぞれ50〜60個のテーブルがありました）。容赦なく切りました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、高負荷システムを設計するための2つの非常に重要なパターンを思い出してください。</font></font><br>
<br>
<ul>
<li>Graceful degradation.   ,       -   . ,   ,      ,       ,     ..    ,             .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Circuit breaker</a>.    ,    . ,    ,    ,        .    ?      (        - graceful degradation).  ,   FPM-  ,     .  -  ( )     ,       .           ,      - ,       ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、少なくともスケーリングを開始しましたが、まだ失敗する点がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、準同期レプリケーションを使用することを決定しました（それを正常に実装しました）。その特徴は何ですか？通常の非同期レプリケーション中にデータセンターのクリーナーがサーバーにバケツの水を注ぐ場合、最後のトランザクションはスレーブにレプリケーションする時間がなく、失われます。そして、この場合、スレーブの1つが新しいマスターになった後、深刻な問題が発生しないことを確認する必要があります。その結果、トランザクションをまったく失わないことを決定し、そのために準同期レプリケーションを使用しました。これでスレーブは遅れることができますが、マスターデータベースサーバーが破壊された場合でも、すべてのトランザクションに関する情報は少なくとも1つのスレーブに保存されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは成功への第一歩でした。</font><font style="vertical-align: inherit;">2番目のステップは、オーケストレーターユーティリティを使用することでした。</font><font style="vertical-align: inherit;">また、システム内のすべてのMySQLを常に監視しています。</font><font style="vertical-align: inherit;">マスターベースに障害が発生した場合、自動化によってマスターが最新のスレーブになり（半同期レプリケーションを考慮して、すべてのトランザクションが含まれるようになります）、書き込み負荷全体がマスターに切り替えられます。</font><font style="vertical-align: inherit;">これで、掃除婦とバケツの物語を追体験することができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は何ですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CityMobileに来たとき、3つのサービスとモノリスがありました。</font><font style="vertical-align: inherit;">今日では20以上ありますが、私たちの成長を阻んでいる主なことは、単一のマスターベースがまだあるということです。</font><font style="vertical-align: inherit;">私たちはこれを英雄的に戦い、それを別々の拠点に分割します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのようにさらに発展させますか？</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイクロサービスのセットを展開します。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、今日私たちが直面している多くの問題を解決します。たとえば、チームにはシステム全体のデバイスを知っている1人の人がいなくなりました。また、急速な成長により、常に最新のドキュメントを入手できるとは限らず、ドキュメントを維持することは非常に困難であるため、初心者が事情を掘り下げることは困難です。また、システムが多数のサービスで構成される場合、それらのそれぞれのドキュメントを書くことは、比類のないほど簡単になります。また、1回限りの調査のコード量が大幅に削減されます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゴーゴー。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私はこの言語が大好きですが、作業コードをある言語から別の言語に書き直すことは実際的ではないといつも信じていました。しかし、最近の経験では、標準で最も人気のあるライブラリであっても、PHPライブラリは最高品質ではないことが示されています。つまり、多くのライブラリにパッチを適用します。 SREチームがRabbitMQと対話するための標準ライブラリにパッチを適用したとしましょう。タイムアウトなどの基本的な機能が機能しないことがわかりました。そして、SREチームが深いほど、そしてこれらの問題を理解しているほど、PHPのタイムアウトについて考える人がほとんどいないこと、ライブラリのテストを気にする人がほとんどないこと、ロックについて考える人が少ないことがわかります。これがなぜ私たちにとって問題になっているのですか？ Goソリューションは保守がはるかに簡単だからです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Goの他に印象に残っていることは何ですか？奇妙なことに、それを書くのはとても簡単です。さらに、Goを使用すると、さまざまなプラットフォームソリューションを簡単に作成できます。この言語には、非常に強力な標準ツールのセットがあります。なんらかの理由でバックエンドが突然スローダウンし始めた場合は、特定のURLにアクセスすると、すべての統計情報（メモリ割り当ての図）が表示され、プロセスがアイドル状態になっている場所がわかります。また、PHPではパフォーマンスの問題を特定するのがさらに難しくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、Goには非常に優れたリンター（最も一般的なエラーを自動的に検出するプログラム）があります。それらのほとんどは「囲碁の50シェード」の記事で説明されており、リンターはそれらを完全に検出します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベースのシャーディングを続けます。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのサービスでVitessに切り替えます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPモノリスのredis-clusterへの変換。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのサービスでは、redis-clusterが優れていることが証明されました。</font><font style="vertical-align: inherit;">残念ながら、PHPでの実装はより困難です。</font><font style="vertical-align: inherit;">monolithは、redis-clusterでサポートされていないコマンドを使用します（これは良いことです。このようなコマンドは、利点よりも多くの問題を引き起こします）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQの問題を調査します。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RabbitMQは最も信頼性の高いソフトウェアではないと考えられています。</font><font style="vertical-align: inherit;">この問題を調査し、問題を見つけて解決します。</font><font style="vertical-align: inherit;">おそらく、カフカまたはタランツールに切り替えることを検討します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja490648/index.html">Kubernetesでのカタコンテナーの使用</a></li>
<li><a href="../ja490650/index.html">初心者ITスペシャリストによる履歴書をコンパイルする際の主な間違い</a></li>
<li><a href="../ja490652/index.html">ロジスティクス。前書き ほぼ複雑</a></li>
<li><a href="../ja490654/index.html">MQシリーズガスセンサーに点を打つ-データシートとチューニングに関する深い理解</a></li>
<li><a href="../ja490656/index.html">Camunda外部タスク-復元力のあるスケーラブルなアーキテクチャでアプリケーションを構築するための強力なツール</a></li>
<li><a href="../ja490664/index.html">PHP：array_key_existsは、in_arrayより500倍高速に検索します</a></li>
<li><a href="../ja490668/index.html">製品からプロジェクトへ、またはその逆への変換の歴史（モスクワ地域の善の例を使用）</a></li>
<li><a href="../ja490670/index.html">車にコードからテストを書く方法</a></li>
<li><a href="../ja490674/index.html">Habr Wickley＃41 /より多くの自動運転車、教授。Fortran、Yandex zashkvar、ロボットの痛み、競合他社のサイトをブロックする方法</a></li>
<li><a href="../ja490676/index.html">ユニットテスト、科学、数学</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>