<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå≤ üìΩÔ∏è üåí Writing a game engine in your first year: easy! (Almost) ü§• üòâ üë®üèª‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Gleb Maryin, I'm in my first year of undergraduate "Applied Mathematics and Computer Science" at the St. Petersburg HSE. In the seco...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Writing a game engine in your first year: easy! (Almost)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/hsespb/blog/504776/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello! </font><font style="vertical-align: inherit;">My name is Gleb Maryin, I'm in my first year of undergraduate "Applied Mathematics and Computer Science" at the St. Petersburg HSE. </font><font style="vertical-align: inherit;">In the second semester, all freshmen in our program make team projects in C ++. </font><font style="vertical-align: inherit;">My teammates and I decided to write a game engine.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read what we get under the cat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10e/b22/0c4/10eb220c409aac5feac61a2164b42886.gif"></div><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are three of us in the team: me, Alexei Luchinin and Ilya Onofriychuk. </font><font style="vertical-align: inherit;">None of us are experts in game development, much less in creating game engines. </font><font style="vertical-align: inherit;">This is the first big project for us: before it, we did only homework and laboratory work, so it is unlikely that professionals in the field of computer graphics will find new information for themselves here. </font><font style="vertical-align: inherit;">We will be glad if our ideas help those who also want to create their own engine. </font><font style="vertical-align: inherit;">But this topic is complex and multifaceted, and the article in no way claims to be complete specialized literature. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everyone else who is interested in learning about our implementation - enjoy reading!</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphic arts</font></font></h1><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First window, mouse and keyboard</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To create windows, handle mouse and keyboard input, we chose the SDL2 library. </font><font style="vertical-align: inherit;">It was a random choice, but so far we have not regretted it.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was important at the very first stage to write a convenient wrapper over the library so that you could create a window with a couple of lines, do manipulations with it like moving the cursor and entering full-screen mode and handle events: keystrokes, cursor movements. </font><font style="vertical-align: inherit;">The task was not difficult: we quickly made a program that can close and open a window, and when you click on RMB, display ‚ÄúHello, World!‚Äù.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the main game cycle appeared:</font></font><br>
<br>
<pre><code class="cpp hljs">Event ev;
<span class="hljs-keyword">bool</span> running = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">while</span> (running):<font></font>
	ev = pullEvent();<font></font>
	<span class="hljs-keyword">for</span> handler in handlers[ev.type]:<font></font>
		handler.handleEvent(ev);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each event handlers attached - </font></font><code>handlers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eg </font></font><code>handlers[QUIT] = {QuitHandler()}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Their task is to handle the corresponding event. </font></font><code>QuitHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the example, it will expose </font></font><code>running = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, thereby stopping the game.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello world</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For drawing in the engine we use </font></font><code>OpenGL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The first </font></font><code>Hello World</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one, as I think, in many projects, was a white square on a black background:&nbsp;</font></font><br>
<br>
<pre><code class="cpp hljs">glBegin(GL_QUADS);<font></font>
glVertex2f(<span class="hljs-number">-1.0f</span>, <span class="hljs-number">1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">1.0f</span>, <span class="hljs-number">1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">1.0f</span>, <span class="hljs-number">-1.0f</span>);<font></font>
glVertex2f(<span class="hljs-number">-1.0f</span>, <span class="hljs-number">-1.0f</span>);<font></font>
glEnd();</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/612/ed8/fbe/612ed8fbe433abd35b12b59e72aac0c7.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we learned how to draw a two-dimensional polygon and carried out the figures in a separate class </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which can rotate with </font></font><code>glRotate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, move with </font></font><code>glTranslate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and stretch with </font></font><code>glScale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We set the color in four channels using </font></font><code>glColor4f(r, g, b, a)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this functionality, you can already make a beautiful fountain of squares. </font><font style="vertical-align: inherit;">Create a class </font></font><code>ParticleSystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that has an array of objects. </font><font style="vertical-align: inherit;">Each iteration of the main loop, the particle system updates the old squares and collects some new ones that it starts in a random direction:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10e/b22/0c4/10eb220c409aac5feac61a2164b42886.gif"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Camera</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step was to write a camera that could move and look in different directions. </font><font style="vertical-align: inherit;">To understand how to solve this problem, we needed knowledge from linear algebra. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If this is not very interesting for you, you can skip the section, see the gif, and read on</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We want to draw a vertex in the coordinates of the screen, knowing its coordinates relative to the center of the object to which it belongs.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, we need to find its coordinates relative to the center of the world in which the object is located.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then, knowing the coordinates and location of the camera, find the position of the vertex in the base of the camera.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then project the vertex onto the plane of the screen.&nbsp;</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, there are three stages. </font><font style="vertical-align: inherit;">Multiplication by three matrices corresponds to them. </font><font style="vertical-align: inherit;">We called these matrices </font></font><code>Model</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>View</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>Projection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start by obtaining the coordinates of the object in the basis of the world. </font><font style="vertical-align: inherit;">Three transformations can be done with an object: scale, rotate, and move. </font><font style="vertical-align: inherit;">All these operations are specified by multiplying the original vector (coordinates in the basis of the object) by the corresponding matrices. </font><font style="vertical-align: inherit;">Then the matrix </font></font><code>Model</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will look like this:&nbsp;</font></font><br>
<br>
<pre><code class="cpp hljs">Model = Translate * Scale * Rotate. 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, knowing the position of the camera, we want to determine the coordinates in its basis: multiply the previously obtained coordinates by the matrix </font></font><code>View</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In C ++, this is conveniently calculated using the function:</font></font><br>
<br>
<pre><code class="cpp hljs">
glm::mat4 View = glm::lookAt(cameraPosition, objectPosition, up);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Literally: look at </font></font><code>objectPosition</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from a position </font></font><code>cameraPosition</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the upward direction is ‚Äúup‚Äù. Why is this direction necessary? Imagine taking a picture of a kettle. You point the camera at him and place the kettle in the frame. At this point, you can say exactly where the frame is at the top (most likely where the kettle has a lid). The program cannot figure out for us how to arrange the frame, and that is why the ‚Äúup‚Äù vector must be specified. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We got the coordinates in the basis of the camera, it remains to project the obtained coordinates on the plane of the camera. The matrix is ‚Äã‚Äãengaged in this </font></font><code>Projection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which creates the effect of reducing the object when it is removed from us.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get the coordinates of the vertex on the screen, you need to multiply the vector by the matrix at least five times. </font><font style="vertical-align: inherit;">All matrices have a size of 4 by 4, so you have to do quite a few multiplication operations. </font><font style="vertical-align: inherit;">We do not want to load processor cores with a lot of simple tasks. </font><font style="vertical-align: inherit;">For this, a video card that has the necessary resources is better. </font><font style="vertical-align: inherit;">So, you need to write a shader: a small instruction for a video card. </font><font style="vertical-align: inherit;">OpenGL has a special GLSL shader language, similar to C, that will help us do this. </font><font style="vertical-align: inherit;">Let's not go into the details of writing a shader, it‚Äôs better to finally look at what happened:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c0/9f3/3cd/6c09f33cd1fb76ea4446b1c4a79f056a.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explanation: There are ten squares that are a short distance behind each other. </font><font style="vertical-align: inherit;">On the right side of them is a player who rotates and moves the camera.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Physics</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is a game without physics? To handle the physical interaction, we decided to use the Box2d library and created a class </font></font><code>WorldObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that inherited from </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Unfortunately, Box2d did not work out of the box, so the brave Ilya wrote a wrapper for b2Body and all the physical connections that are in this library.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1fa/68a/807/1fa68a80750c650cb3d3f947a6f58d54.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Until that moment, we thought to make the graphics in the engine absolutely two-dimensional, and for lighting, if we decide to add it, use the raycasting technique. </font><font style="vertical-align: inherit;">But we had on hand a wonderful camera that can display objects in all three dimensions. </font><font style="vertical-align: inherit;">Therefore, we added thickness to all two-dimensional objects - why not? </font><font style="vertical-align: inherit;">In addition, in the future, this will allow you to make quite beautiful lighting that will leave shadows from thick objects. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lighting appeared in between cases. </font><font style="vertical-align: inherit;">To create it, it was necessary to write the appropriate instructions for drawing each pixel - a fragment shader.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/460/faf/f88/460faff88bbc07d7b466c0c9d7a12f4b.gif"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Textures</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To download the images, we used the DevIL library. </font><font style="vertical-align: inherit;">Each </font></font><code>GraphicalObject2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">became fit one instance of the class </font></font><code>GraphicalPolygon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the front part of the object - and </font></font><code>GraphicalEdge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- side part. </font><font style="vertical-align: inherit;">On each you can stretch your texture. </font><font style="vertical-align: inherit;">First result:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8db/847/a6f/8db847a6fddf768afc0cd175a7368b98.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything that‚Äôs required from the graphics is ready: drawing, one light source and texture. </font><font style="vertical-align: inherit;">Graphics - that's it for now.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">State machine, setting the behavior of objects</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Every object, whatever it may be ‚Äî a state in the state machine, graphic or physical ‚Äî must be ‚Äúticking‚Äù, that is, each iteration of the game loop is updated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objects that can update are inherited from the Behavior class we created. It has functions </font></font><code>onStart, onActive, onStop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that allow you to override the behavior of the heir at startup, during life and at the end of its activity. Now we need to create a supreme object </font></font><code>Activity</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that calls these functions from all objects. The loop function that does this is as follows:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>:
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title">onAwake</span><span class="hljs-params">()</span></span>;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;awake = <span class="hljs-literal">true</span>;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span> (awake):<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onStart();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;running = <span class="hljs-literal">true</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span> (running):<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onActive();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onStop();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;onDestroy();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For now </font></font><code>running == true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, someone can call a function </font></font><code>pause()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that does </font></font><code>running = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If someone calls </font></font><code>kill()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then </font></font><code>awake</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and </font></font><code>running</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">turn to </font></font><code>false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and activity to a complete stop. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we want to pause a group of objects, for example, a system of particles and particles inside it. In the current state, you need to manually call </font></font><code>onPause</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for each object, which is not very convenient. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> everyone </font></font><code>Behavior</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will have an array </font></font><code>subBehaviors</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that he will update, that is:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onStart</span><span class="hljs-params">()</span>:
	<span class="hljs-title">onStart</span><span class="hljs-params">()</span> 		<span class="hljs-comment">//     </span>
	<span class="hljs-keyword">for</span> sb in subBehaviors:
		sb.<span class="hljs-title">onStart</span><span class="hljs-params">()</span>	<span class="hljs-comment">//       Behavior</span>
<span class="hljs-keyword">void</span> <span class="hljs-title">onActive</span><span class="hljs-params">()</span>:
	<span class="hljs-title">onActive</span><span class="hljs-params">()</span>
	<span class="hljs-keyword">for</span> sb in subBehaviors:
		sb.<span class="hljs-title">onActive</span><span class="hljs-params">()</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so on, for each function. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But not every behavior can be set in this way. For example, if an enemy is walking on the platform, the enemy, then he most likely has different states: he is standing </font></font><code>idle_stay</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, he is walking on the platform without noticing us </font></font><code>idle_walk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and at any moment he can notice us and go into attack state </font></font><code>attack</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. I also want to conveniently set the conditions for the transition between states, for example:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">isTransitionActivated</span><span class="hljs-params">()</span>: 		<span class="hljs-comment">//  idle_walk-&gt;attack</span>
	<span class="hljs-keyword">return</span> <span class="hljs-title">canSee</span><span class="hljs-params">(enemy)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The desired pattern is a state machine. </font><font style="vertical-align: inherit;">We also made her the heir </font></font><code>Behavior</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, since on each tick it is necessary to check whether the time has come to switch the state. </font><font style="vertical-align: inherit;">This is useful not only for objects in the game. </font><font style="vertical-align: inherit;">For example, </font></font><code>Level</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this is a state </font></font><code>Level Switcher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and transitions inside the controller machine are conditions for switching levels in the game. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The state has three stages: it has begun, it is ticking, it has stopped. </font><font style="vertical-align: inherit;">You can add some actions to each stage, for example, attach a texture to an object, apply an impulse to it, set the speed, and so on.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conservation</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creating a level in the editor, I want to be able to save it, and the game itself should be able to load the level from the saved data. Therefore, all objects that need to be saved are inherited from the class </font></font><code>NamedStoredObject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It stores a string with the name, class name and has a function </font></font><code>dump()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that dumps data about an object into a string.&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make a save, it remains to simply override </font></font><code>dump()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for each object. Loading is a constructor from a string containing all the information about the object. Download is complete when such a constructor is made for each object.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, the game and the editor are almost the same class, only in the game the level is loaded in read mode, and in the editor in record mode. The engine uses the rapidjson library to write and read objects from json.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GUI</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At some point, the question arose before us: let the graphics, the state machine, and all the rest be written. </font><font style="vertical-align: inherit;">How can a user write a game using this?&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the original version, he would have to inherit from </font></font><code>Game2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and override </font></font><code>onActive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and create objects in the fields of the class. </font><font style="vertical-align: inherit;">But during the creation, he cannot see what he is creating, and he would also need to compile his program and link to our library. </font><font style="vertical-align: inherit;">Horror! </font><font style="vertical-align: inherit;">There would be pluses - one could ask such complex behaviors that one could have imagined: for example, move the block of land as much as the player‚Äôs lives, and do so provided that Uranus is in the constellation Taurus and the euro does not exceed 40 rubles. </font><font style="vertical-align: inherit;">However, we still decided to make a graphical interface.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the graphical interface, the number of actions that can be performed with an object will be limited: flip through the animation slide, apply force, set a certain speed, and so on. The same situation with transitions in the state machine. In large engines, the problem of a limited number of actions is solved by linking the current program with another - for example, Unity and Godot use binding with C #. Already from this script you can do anything: and see in which constellation Uranus, and what is the current euro exchange rate. We do not have such functionality at the moment, but our plans include connecting the engine with Python 3.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To implement the graphical interface, we decided to use Dear ImGui, because it is very small (compared to the well-known Qt) and writing on it is very simple. </font><font style="vertical-align: inherit;">ImGui - the paradigm of creating a graphical interface. </font><font style="vertical-align: inherit;">In it, every iteration of the main loop, all widgets and windows are redrawn only if necessary. </font><font style="vertical-align: inherit;">On the one hand, this reduces the amount of memory consumed, but on the other hand, it most likely takes longer than one execution of the complex function of creating and saving the necessary information for subsequent drawing. </font><font style="vertical-align: inherit;">It remains only to implement the interfaces for creating and editing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what the graphical interface looks like at the time of the article‚Äôs release:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09a/e87/f8e/09ae87f8eea964d382f07b411991d6d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Level editor</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93b/b2e/1bd/93bb2e1bd41ab656341a78fd3dd04102.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">State Machine Editor</font></font></i><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have created only the basis on which you can hang something more interesting. In other words, there is room for growth: you can implement shadow rendering, the ability to create more than one light source, you can connect the engine with the Python 3 interpreter to write scripts for the game. I would like to refine the interface: make it more beautiful, add more different objects, support for hot keys ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is still a lot of work, but we are happy with what we have at the moment.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
During the creation of the project, we got a lot of diverse experience: working with graphics, creating graphical interfaces, working with json files, wrappers of numerous C libraries. And also the experience of writing the first big project in a team. We hope that we were able to tell about it as interesting as it was interesting to deal with it :)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Link to the gihab project: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Glebanister/ample</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504766/index.html">How we visited the metallurgical plant in Asha</a></li>
<li><a href="../en504768/index.html">Analyst internship in Yandex: analysis of test tasks</a></li>
<li><a href="../en504770/index.html">Linux Gaming Distributions</a></li>
<li><a href="../en504772/index.html">Digital events in Moscow from June 1 to 7</a></li>
<li><a href="../en504774/index.html">Survey of IT executives about changing needs for IT services</a></li>
<li><a href="../en504780/index.html">NSA, Ghidra and Unicorns</a></li>
<li><a href="../en504784/index.html">Sectigo's AddTrust root certificate expired on May 30, 2020, which caused problems in OpenSSL 1.0.x and GnuTLS clients</a></li>
<li><a href="../en504786/index.html">Everything you need to know about caching</a></li>
<li><a href="../en504790/index.html">A selection of articles on machine learning: cases, guides and studies for May 2020</a></li>
<li><a href="../en504792/index.html">Duty boarding house. How NSPK saved its duty room from a coronavirus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>