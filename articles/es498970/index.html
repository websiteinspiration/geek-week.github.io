<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ë üí∂ üëµüèæ Kubernetes ConfigMaps: matices para saber ü§∂ üçõ üë©üèΩ‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota : este no es un art√≠culo de gu√≠a completo, sino m√°s bien un recordatorio / sugerencia para aquellos que ya usan ConfigMap en Kubernetes o simplem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes ConfigMaps: matices para saber</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498970/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : este no es un art√≠culo de gu√≠a completo, sino m√°s bien un recordatorio / sugerencia para aquellos que ya usan ConfigMap en Kubernetes o simplemente est√°n preparando su aplicaci√≥n para trabajar en √©l.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_h/ly/ln/_hlylnaruzb2_b5zhbjpinrdphy.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecedentes: de rsync a ... Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que paso antes En la era de la "administraci√≥n cl√°sica", en la versi√≥n m√°s simple, el archivo de configuraci√≥n se colocaba justo al lado de las aplicaciones (o en el repositorio, si lo desea). Es simple: hacemos entrega elemental (CD) para nuestro c√≥digo junto con la configuraci√≥n. Incluso una implementaci√≥n rsync condicional se puede llamar los rudimentos de un CD.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando la infraestructura creci√≥, se requirieron diferentes configuraciones para diferentes entornos (desarrollo / etapa / producci√≥n). La aplicaci√≥n fue entrenada para comprender qu√© configuraci√≥n usar, pas√°ndolas como argumentos para iniciar o variables de entorno establecidas en el entorno. A√∫n m√°s CD es complicado con la llegada de tan √∫til Chef / Puppet / Ansible. Los roles aparecen en los servidores y los entornos dejan de describirse en diferentes lugares: llegamos a IaC (Infraestructura como c√≥digo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© sigui√≥? Si fue posible ver las ventajas cr√≠ticas de Kubernetes por s√≠ mismo e incluso aceptar la necesidad de modificar las aplicaciones para que funcionen en este entorno, hubo una migraci√≥n. En el camino, esperaba muchos matices y diferencias en la construcci√≥n de la arquitectura, pero cuando me las arregl√© para hacer frente a la parte principal, obtuve la tan esperada aplicaci√≥n ejecut√°ndose en K8.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez aqu√≠, a√∫n podemos usar las configuraciones preparadas en el repositorio al lado de la aplicaci√≥n o pasar ENV al contenedor. </font><font style="vertical-align: inherit;">Sin embargo, adem√°s de estos m√©todos, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tambi√©n est√°n disponibles </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esta primitiva K8s le permite usar plantillas Go en configuraciones, es decir </font><font style="vertical-align: inherit;">render√≠celos como p√°ginas HTML y vuelva a cargar la aplicaci√≥n cuando cambie la configuraci√≥n sin reiniciar. </font><font style="vertical-align: inherit;">Con ConfigMaps, ya no es necesario mantener m√°s de 3 configuraciones para diferentes entornos y realizar un seguimiento de la relevancia de cada una. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se puede encontrar una introducci√≥n general a ConfigMaps, por ejemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Y en este art√≠culo me centrar√© en algunas caracter√≠sticas de trabajar con ellos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps simples</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo se ve√≠an las configuraciones en Kubernetes? </font><font style="vertical-align: inherit;">¬øQu√© obtuvieron de las plantillas go? </font><font style="vertical-align: inherit;">Por ejemplo, aqu√≠ hay un ConfigMap ordinario para una aplicaci√≥n implementada desde un gr√°fico Helm:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: app<font></font>
data:<font></font>
  config.json: |<font></font>
    {<font></font>
      "welcome": {{ pluck .Values.global.env .Values.welcome | quote }},<font></font>
      "name": {{ pluck .Values.global.env .Values.name | quote }}<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ los valores sustituidos en </font></font><code>.Values.welcome</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>.Values.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√°n tomados del archivo </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">¬øPor qu√© exactamente de </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">¬øC√≥mo funciona el motor de plantillas Go? </font><font style="vertical-align: inherit;">Ya hemos hablado sobre estos detalles con m√°s detalle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La llamada </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ayuda a seleccionar la l√≠nea necesaria del mapa:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cat .helm/values.yaml <font></font>
welcome:<font></font>
  production: "Hello"<font></font>
  test: "Hey"<font></font>
name:<font></font>
  production: "Bob"<font></font>
  test: "Mike"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, puede tomar tanto l√≠neas espec√≠ficas como fragmentos enteros de la configuraci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, ConfigMap podr√≠a ser as√≠:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {{ pluck .Values.global.env .Values.data | first | toJson | indent 4 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... y en </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- los siguientes contenidos:</font></font><br>
<br>
<pre><code class="plaintext hljs">data:<font></font>
  production:<font></font>
    welcome: "Hello"<font></font>
    name: "Bob"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El involucrado aqu√≠ </font></font><code>global.env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es el nombre del medio ambiente. </font><font style="vertical-align: inherit;">Sustituyendo este valor durante la implementaci√≥n, puede representar ConfigMaps con contenido diferente. </font></font><code>first</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necesitado aqu√≠ porque </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve una lista, cuyo primer elemento contiene el valor deseado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando hay muchas configuraciones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ConfigMap puede contener varios archivos de configuraci√≥n:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {<font></font>
      <span class="hljs-attr">"welcome"</span>: {{ pluck .Values.global.env .Values.welcome | first | quote }},
      <span class="hljs-string">"name"</span>: {{ pluck .Values.global.env .Values.name | first | quote }}<font></font>
    }<font></font>
  database.yml: |<font></font>
    host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><font></font>
    db: app<font></font>
    user: app<font></font>
    password: app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluso puede montar cada configuraci√≥n por separado:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/config.json<font></font>
          subPath: config.json<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/database.yml<font></font>
          subPath: database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... o recoge todas las configuraciones a la vez con el directorio:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si cambia la descripci√≥n del recurso de implementaci√≥n durante la implementaci√≥n, Kubernetes crear√° un nuevo ReplicaSet, disminuyendo el antiguo a 0 y aumentando el nuevo al n√∫mero especificado de r√©plicas. </font><font style="vertical-align: inherit;">(Esto es cierto para la estrategia de implementaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>RollingUpdate</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tales acciones conducir√°n a la recreaci√≥n del pod con una nueva descripci√≥n. </font><font style="vertical-align: inherit;">Por ejemplo: hab√≠a una imagen </font></font><code>image:my-registry.example.com:v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pero se convirti√≥ en - </font></font><code>image:my-registry.example.com:v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Y no importa en absoluto lo que cambiamos exactamente en la descripci√≥n de nuestra implementaci√≥n: lo principal es que esto hizo que se recreara el replicaSet (y, como resultado, el pod). </font><font style="vertical-align: inherit;">En este caso, la nueva versi√≥n del archivo de configuraci√≥n en la nueva versi√≥n de la aplicaci√≥n se monta autom√°ticamente y no habr√° ning√∫n problema.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Respuesta de cambio de ConfigMap</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En caso de cambios en ConfigMap pueden seguir cuatro escenarios de eventos. </font><font style="vertical-align: inherit;">Considerarlos:</font></font><br>
<br>
<ol>
<li> <b></b>:  ConfigMap,    subPath.<br>
<b></b>:       .</li>
<li> <b></b>:  ConfigMap,          pod.<br>
<b></b>:  pod     .</li>
<li> <b></b>:  ConfigMap    Deployment     -.<br>
<b></b>:   ,      ConfigMap‚Äô,   Deployment,   pod  ,   ‚Äî        .</li>
<li> <b></b>:  ConfigMap,   .<br>
<b></b>:    pod‚Äô   / pod‚Äô.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analizaremos con m√°s detalle.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escenario 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬ø </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corregimos ConfigMap? </font><font style="vertical-align: inherit;">La aplicaci√≥n no se reiniciar√°. </font><font style="vertical-align: inherit;">En el caso de montaje por, </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no habr√° cambios hasta que el pod se reinicie manualmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo es simple: Kubernetes monta nuestro ConfigMap en un pod de una versi√≥n espec√≠fica del recurso. </font><font style="vertical-align: inherit;">Como est√° montado con </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ya no se proporciona "influencia" adicional en la configuraci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escenario 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øNo puede actualizar el archivo sin volver a crear el pod? </font><font style="vertical-align: inherit;">De acuerdo, tenemos 6 r√©plicas en Implementaci√≥n, por lo que podemos turnarnos manualmente para hacer todo </font></font><code>delete pod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Luego, al crear nuevos pods, "recoger√°n" la nueva versi√≥n de ConfigMap.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escenario 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øCansado de realizar tales operaciones manualmente? </font><font style="vertical-align: inherit;">En los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consejos y trucos de Helm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se describe una soluci√≥n a este problema </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Deployment<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      annotations:<font></font>
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}<font></font>
[...]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, el </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash de la configuraci√≥n de anotaci√≥n representada simplemente se escribe </font><font style="vertical-align: inherit;">en la plantilla pod ( </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las anotaciones son campos de valores clave arbitrarios en los que puede almacenar sus valores. </font><font style="vertical-align: inherit;">Si los registra en la plantilla del </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pod futuro, estos campos caer√°n en el ReplicaSet y el pod en s√≠. </font><font style="vertical-align: inherit;">Kubernetes notar√° que la plantilla del pod ha cambiado (ya que la configuraci√≥n de sha256 ha cambiado) y comenzar√° </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, en el que nada cambia excepto esta anotaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, guardamos la misma versi√≥n de la aplicaci√≥n y la descripci√≥n del Despliegue y esencialmente desencadenamos la recreaci√≥n del pod por la m√°quina, de forma similar a c√≥mo lo har√≠amos manualmente </font></font><code>kubectl delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pero ya "correctamente": autom√°ticamente y con </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escenario 4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQuiz√°s la aplicaci√≥n ya sabe c√≥mo monitorear los cambios en la configuraci√≥n y recargar autom√°ticamente? </font><font style="vertical-align: inherit;">Aqu√≠ radica una caracter√≠stica importante de ConfigMaps ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Kubernetes, si la configuraci√≥n est√° montada </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, no se actualizar√° hasta que se reinicie el pod </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ver los primeros tres escenarios discutidos anteriormente)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pero si monta ConfigMap como un directorio, sin </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dentro del contenedor habr√° un directorio con una configuraci√≥n actualizada sin reiniciar el pod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay otras caracter√≠sticas que son √∫tiles para recordar:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tal archivo de configuraci√≥n actualizado dentro del contenedor se actualiza con cierto retraso. </font><font style="vertical-align: inherit;">Esto se debe al hecho de que el archivo no est√° montado exactamente, sino el objeto Kubernetes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El archivo dentro es un enlace simb√≥lico. </font><font style="vertical-align: inherit;">Ejemplo con </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-6b4cb86569-22vqv -- ls -lha /app/configfiles <font></font>
total 20K    <font></font>
drwxr-xr-x    1 root     root        4.0K Mar  3 19:34 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
-rw-r--r--    1 root     root          42 Mar  3 19:34 config.json<font></font>
-rw-r--r--    1 root     root          47 Mar  3 19:34 database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øY qu√© pasar√° sin </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuando </font><font style="vertical-align: inherit;">est√© </font><font style="vertical-align: inherit;">montado por el directorio?</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:40 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:40 ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:40 ..data -&gt; ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actualice la configuraci√≥n (mediante implementaci√≥n o </font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), espere 2 minutos (tiempo de almacenamiento en cach√© del servidor) y listo:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha --color /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:44 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:44 ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:44 ..data -&gt; ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta la marca de tiempo modificada en el directorio creado por Kubernetes.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seguimiento de cambios</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y, por √∫ltimo, un ejemplo simple de c√≥mo puede monitorear los cambios en la configuraci√≥n.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilizaremos dicha aplicaci√≥n Go</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span><font></font>
<font></font>
	<span class="hljs-string">"github.com/fsnotify/fsnotify"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// Config fo our application</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
	Welcome <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"welcome"`</span>
	Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> (<font></font>
	globalConfig *Config<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// LoadConfig - load our config!</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Config, error)</span></span> {<font></font>
	configFile, err := os.Open(path)<font></font>
<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to read configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	config := <span class="hljs-built_in">new</span>(Config)<font></font>
<font></font>
	decoder := json.NewDecoder(configFile)<font></font>
	err = decoder.Decode(&amp;config)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to parse configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">return</span> config, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ConfigWatcher - watches config.json for changes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigWatcher</span><span class="hljs-params">()</span></span> {<font></font>
	watcher, err := fsnotify.NewWatcher()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	<span class="hljs-keyword">defer</span> watcher.Close()<font></font>
<font></font>
	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> {
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> event, ok := &lt;-watcher.Events:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"event:"</span>, event)
				<span class="hljs-keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write {<font></font>
					log.Println(<span class="hljs-string">"modified file:"</span>, event.Name)<font></font>
				}<font></font>
				globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)<font></font>
				log.Println(<span class="hljs-string">"config:"</span>, globalConfig)
			<span class="hljs-keyword">case</span> err, ok := &lt;-watcher.Errors:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"error:"</span>, err)<font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
<font></font>
	err = watcher.Add(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	&lt;-done<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	log.Println(<span class="hljs-string">"Start"</span>)<font></font>
	globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">go</span> ConfigWatcher()
	<span class="hljs-keyword">for</span> {<font></font>
		log.Println(<span class="hljs-string">"config:"</span>, globalConfig)<font></font>
		time.Sleep(<span class="hljs-number">30</span> * time.Second)<font></font>
	}<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... agreg√°ndolo con tal configuraci√≥n:</font></font><br>
<br>
<pre><code class="json hljs">$ cat configfiles/config.json <font></font>
{<font></font>
  <span class="hljs-attr">"welcome"</span>: <span class="hljs-string">"Hello"</span>,
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Alice"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si se ejecuta, el registro ser√°:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:18:22 config: &amp;{Hello Alice}<font></font>
2020/03/03 22:18:52 config: &amp;{Hello Alice}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora instalaremos esta aplicaci√≥n en Kubernetes, despu√©s de haber montado la configuraci√≥n de ConfigMap en el pod en lugar del archivo de la imagen. </font><font style="vertical-align: inherit;">Se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> preparado un </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">ejemplo de un gr√°fico Helm</font></a><font style="vertical-align: inherit;"> en GitHub </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">helm install -n habr-configmap --namespace habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Alice'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y cambie solo ConfigMap:</font></font><br>
<br>
<pre><code class="bash hljs">-  production: <span class="hljs-string">"Alice"</span>
+  production: <span class="hljs-string">"Bob"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actualice el gr√°fico Helm en el cl√∫ster, por ejemplo, as√≠:</font></font><br>
<br>
<pre><code class="bash hljs">helm upgrade habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Bob'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øLo que suceder√°?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las aplicaciones v1 y v2 no se reinician porque </font><font style="vertical-align: inherit;">Para ellos, no se ha producido ning√∫n cambio en la implementaci√≥n, todav√≠a dan la bienvenida a Alice.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La aplicaci√≥n v3 se reinici√≥, volvi√≥ a leer la configuraci√≥n y salud√≥ a Bob.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La aplicaci√≥n v4 no se reinici√≥. </font><font style="vertical-align: inherit;">Como ConfigMap se monta como un directorio, se notaron cambios en la configuraci√≥n y la configuraci√≥n cambi√≥ sobre la marcha, sin reiniciar el pod. </font><font style="vertical-align: inherit;">S√≠, la aplicaci√≥n not√≥ cambios en nuestro ejemplo simple: vea el mensaje de evento de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fsnotify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:19:15 event: "configfiles/config.json": CHMOD<font></font>
2020/03/03 22:19:15 config: &amp;{Hello Bob}<font></font>
2020/03/03 22:19:22 config: &amp;{Hello Bob}</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede ver c√≥mo una situaci√≥n similar, el seguimiento de los cambios de ConfigMap, se est√° resolviendo en un proyecto m√°s adulto (y simplemente "real"), </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Importante! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n es √∫til recordar que todo lo anterior en el art√≠culo tambi√©n es cierto para Secret'ov en Kubernetes ( </font></font><code>kind: Secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">): no es por nada que son tan similares a ConfigMap ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Prima! </font><font style="vertical-align: inherit;">Soluciones de terceros</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si est√° interesado en el tema del seguimiento de cambios en las configuraciones, ya hay utilidades listas para esto:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jimmidyson / configmap-reload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : env√≠a una solicitud HTTP si el archivo ha cambiado. </font><font style="vertical-align: inherit;">El desarrollador tambi√©n planea ense√±arle a SIGHUP a enviar, pero la falta de compromisos a partir de octubre de 2019 deja estos planes en cuesti√≥n;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stakater / Reloader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : supervisa ConfigMap / Secrets y realiza una actualizaci√≥n continua (como lo llama su autor) en los recursos asociados con ellos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ser√° conveniente lanzar dichas aplicaciones con un contenedor de sidecar a las aplicaciones existentes. </font><font style="vertical-align: inherit;">Sin embargo, si conoce las caracter√≠sticas de Kubernetes / ConfigMap y las configuraciones para editar no "en vivo" (a trav√©s de </font></font><code>edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), sino solo como parte de la implementaci√≥n ... entonces las capacidades de tales utilidades pueden parecer superfluas, es decir </font><font style="vertical-align: inherit;">Duplicar funciones b√°sicas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con el advenimiento de ConfigMap en Kubernetes, las configuraciones pasaron a la siguiente ronda de desarrollo: el uso de un motor de plantillas les proporcion√≥ una flexibilidad comparable a la representaci√≥n de p√°ginas HTML. </font><font style="vertical-align: inherit;">Afortunadamente, tales complicaciones no </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reemplazaron</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> las soluciones existentes, sino que se convirtieron en su </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complemento</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por lo tanto, para los administradores (o m√°s bien, incluso los desarrolladores) que consideran redundantes las nuevas funciones, todav√≠a hay disponibles archivos antiguos buenos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para aquellos que ya usan ConfigMap'ami o simplemente los miran, el art√≠culo ofrece una breve descripci√≥n de su esencia y matices de uso. </font><font style="vertical-align: inherit;">Si tiene sus propios consejos y trucos sobre el tema, estar√© encantado de verlos en los comentarios.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PD</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lea tambi√©n en nuestro blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivos locales al portar una aplicaci√≥n a Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">   Kubernetes  Helm:    </a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SSL-  Let's Encrypt  cert-manager  Kubernetes</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498944/index.html">Telegram. Perro, o c√≥mo no hacer espejos</a></li>
<li><a href="../es498948/index.html">Hora de los dragones. Autoaislamiento con rompecabezas</a></li>
<li><a href="../es498952/index.html">Invitamos a DINS JS EVENING: estamos hablando de programaci√≥n orientada a aspectos y el marco de composici√≥n de Vuejs 3 API</a></li>
<li><a href="../es498958/index.html">El error no es UIAlertController</a></li>
<li><a href="../es498962/index.html">Acerca de la multitarea: ventanas bajo control</a></li>
<li><a href="../es498974/index.html">Coronavirus: una ilusi√≥n peligrosa de inseguridad</a></li>
<li><a href="../es498976/index.html">Presentaci√≥n de .NET 5.0 Preview 3</a></li>
<li><a href="../es498978/index.html">Uso de Graylog y NLog para recopilar registros de aplicaciones de C #. Experiencia personal</a></li>
<li><a href="../es498982/index.html">Disquetes para Dreamcast</a></li>
<li><a href="../es498984/index.html">Stealth School: 5 tipos de gadgets en juegos de sigilo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>