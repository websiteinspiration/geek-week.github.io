<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>↪️ 👬 ⚕️ Comment désactiver l'avertissement sur les dangers d'une longue écoute audio (Android) 👵🏽 👰🏾 🧘🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probablement, beaucoup de ceux qui écoutent de la musique (et pas seulement) à partir d'un appareil Android ont rencontré cet avertissement:
 
 
 Dans...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment désactiver l'avertissement sur les dangers d'une longue écoute audio (Android)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506870/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablement, beaucoup de ceux qui écoutent de la musique (et pas seulement) à partir d'un appareil Android ont rencontré cet avertissement:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_i/gk/oa/_igkoaiik88g5pr8eooiezni-i8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous verrons pourquoi et quand cet avertissement se produit et comment nous assurer qu'il ne se produit plus.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'apparaît que lorsque vous écoutez du son via un appareil externe (casque / haut-parleurs). Pour ceux qui ne l'ont pas rencontré, une petite explication: imaginez que vous écoutez de la musique avec des écouteurs, assez fort. Soudain, le son devient plus silencieux. Vous essayez d'augmenter le volume à l'aide des boutons du boîtier, mais cela ne fonctionne pas. Sortant l'appareil de votre poche et le déverrouillant, vous verrez un tel avertissement. Ce n'est qu'après accord avec lui qu'il sera possible d'augmenter le volume.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oui, l'avertissement est raisonnable, mais il apparaît à un moment imprévisible, parfois le plus inapproprié: lorsque vous êtes dans les transports en commun / en voiture / en hiver dans la rue / lorsque vous avez les mains sales, etc. </font><font style="vertical-align: inherit;">Il n'est pas pratique de retirer l'appareil, de déverrouiller, d'accepter l'avertissement, de remettre l'appareil dans ces cas. </font><font style="vertical-align: inherit;">Et si les haut-parleurs sont connectés, et non les écouteurs, le message n'est pas tout à fait approprié.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi cela survient</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet avertissement n'est pas une initiative des auteurs de la plateforme. </font><font style="vertical-align: inherit;">Le fait est qu'il existe une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">norme OMS-ETU pour une</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> «écoute sûre» (écoute sûre). </font><font style="vertical-align: inherit;">En Europe et dans certains autres pays, sa mise en œuvre est obligatoire. </font><font style="vertical-align: inherit;">La norme décrit la durée pendant laquelle vous pouvez écouter de l'audio en fonction du volume avec un risque minimal de perte auditive. </font><font style="vertical-align: inherit;">Par exemple, pour un adulte, la «dose» sonore hebdomadaire sûre est de 1,6 Pa </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> h, ce qui équivaut à 20 heures d'écoute à un volume de 83 dB.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lf/lm/xx/lflmxxcutic2hsnxzyh2i_mepyg.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la mise en oeuvre</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon le mcc (code de pays mobile), le mode d'écoute sécurisé peut être activé ou désactivé. Ceci est déterminé par la valeur de la ressource </font></font><code>R.bool.config_safe_media_volume_enabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le mode est activé, le système calcule le temps d'écoute à un volume dangereux (supérieur à 85 dB) et stocke périodiquement la valeur dans une variable </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Lorsque la valeur atteint 20 heures, un avertissement s'affiche. Après avoir accepté l'avertissement, la valeur est réinitialisée et le comptage recommence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une telle implémentation est assez simple et ne tient pas compte, par exemple, de la durée pendant laquelle l'utilisateur a écouté ces 20 heures: peut-être en quelques jours, ou peut-être écouté pendant 6-7 minutes pendant six mois (selon la norme, ce n'est pas une menace pour l'audition ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La logique d'écoute sécurisée est concentrée dans la classe de classe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AudioService.java</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous pouvez y voir les champs correspondants:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// mMusicActiveMs is the cumulative time of music activity since safe volume was disabled.</span>
<span class="hljs-comment">// When this time reaches UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX, the safe media volume is re-enabled</span>
<span class="hljs-comment">// automatically. mMusicActiveMs is rounded to a multiple of MUSIC_ACTIVE_POLL_PERIOD_MS.</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mMusicActiveMs;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX = (<span class="hljs-number">20</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 20 hours</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MUSIC_ACTIVE_POLL_PERIOD_MS = <span class="hljs-number">60000</span>;  <span class="hljs-comment">// 1 minute polling interval</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le champ </font></font><code>mMusicActiveMs </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contient le nombre de millisecondes écoutées par l'utilisateur à un volume non sécurisé depuis la dernière confirmation du dialogue. </font><font style="vertical-align: inherit;">La valeur initiale est chargée à partir de la variable </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dans la même variable, une nouvelle valeur mMusicActiveMs est écrite toutes les minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a aussi un champ </font></font><code>mSafeMediaVolumeState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il contient l'état actuel du système d'écoute sécurisé:</font></font><br>
<br>
<ul>
<li><code>DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: éteint</font></font></li>
<li><code>ACTIVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: activé et la limite d'écoute a été atteinte, ce qui signifie que vous ne pouvez pas autoriser l'utilisateur à augmenter le volume tant qu'il n'est pas d'accord avec l'avertissement</font></font></li>
<li><code>INACTIVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: activé, la limite n'est pas encore atteinte</font></font></li>
</ul><br>
<pre><code class="java hljs">
<span class="hljs-comment">// mSafeMediaVolumeState indicates whether the media volume is limited over headphones.</span>
<span class="hljs-comment">// It is SAFE_MEDIA_VOLUME_NOT_CONFIGURED at boot time until a network service is connected</span>
<span class="hljs-comment">// or the configure time is elapsed. It is then set to SAFE_MEDIA_VOLUME_ACTIVE or</span>
<span class="hljs-comment">// SAFE_MEDIA_VOLUME_DISABLED according to country option. If not SAFE_MEDIA_VOLUME_DISABLED, it</span>
<span class="hljs-comment">// can be set to SAFE_MEDIA_VOLUME_INACTIVE by calling AudioService.disableSafeMediaVolume()</span>
<span class="hljs-comment">// (when user opts out).</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_NOT_CONFIGURED = <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_DISABLED = <span class="hljs-number">1</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_INACTIVE = <span class="hljs-number">2</span>;  <span class="hljs-comment">// confirmed</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SAFE_MEDIA_VOLUME_ACTIVE = <span class="hljs-number">3</span>;  <span class="hljs-comment">// unconfirmed</span>
<span class="hljs-keyword">private</span> Integer mSafeMediaVolumeState;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode pour vérifier le dépassement de la limite ressemble à ceci:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCheckMusicActive</span><span class="hljs-params">(String caller)</span> </span>{
   <span class="hljs-keyword">synchronized</span> (mSafeMediaVolumeState) {
       <span class="hljs-keyword">if</span> (mSafeMediaVolumeState == SAFE_MEDIA_VOLUME_INACTIVE) {
           <span class="hljs-keyword">int</span> device = getDeviceForStream(AudioSystem.STREAM_MUSIC);<font></font>
<font></font>
           <span class="hljs-keyword">if</span> ((device &amp; mSafeMediaVolumeDevices) != <span class="hljs-number">0</span>) {<font></font>
               sendMsg(mAudioHandler,<font></font>
                   MSG_CHECK_MUSIC_ACTIVE,<font></font>
                   SENDMSG_REPLACE,<font></font>
                   <span class="hljs-number">0</span>,
                   <span class="hljs-number">0</span>,<font></font>
                   caller,<font></font>
                   MUSIC_ACTIVE_POLL_PERIOD_MS);<font></font>
               <span class="hljs-keyword">int</span> index = mStreamStates[AudioSystem.STREAM_MUSIC].getIndex(device);
               <span class="hljs-keyword">if</span> (AudioSystem.isStreamActive(AudioSystem.STREAM_MUSIC, <span class="hljs-number">0</span>) &amp;&amp;<font></font>
                   (index &gt; safeMediaVolumeIndex(device))) {<font></font>
                   <span class="hljs-comment">// Approximate cumulative active music time</span><font></font>
                   mMusicActiveMs += MUSIC_ACTIVE_POLL_PERIOD_MS;<font></font>
                   <span class="hljs-keyword">if</span> (mMusicActiveMs &gt; UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX) {<font></font>
                       setSafeMediaVolumeEnabled(<span class="hljs-keyword">true</span>, caller);<font></font>
                       mMusicActiveMs = <span class="hljs-number">0</span>;<font></font>
                   }<font></font>
                   saveMusicActiveMs();<font></font>
               }<font></font>
           }<font></font>
       }<font></font>
   }<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment désactiver un avertissement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour désactiver l'écoute en toute sécurité, vous devez vous assurer que la variable se voit </font></font><code>mSafeMediaVolumeState</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attribuer une valeur pendant la phase de configuration </font></font><code>DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons où la valeur est initialement définie:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onConfigureSafeVolume</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> force, String caller)</span> </span>{<font></font>
   ...<font></font>
   <span class="hljs-keyword">boolean</span> safeMediaVolumeEnabled =<font></font>
           SystemProperties.getBoolean(<span class="hljs-string">"audio.safemedia.force"</span>, <span class="hljs-keyword">false</span>)<font></font>
                   || mContext.getResources().getBoolean(<font></font>
                 com.android.internal.R.bool.config_safe_media_volume_enabled);<font></font>
<font></font>
   <span class="hljs-keyword">boolean</span> safeMediaVolumeBypass =<font></font>
           SystemProperties.getBoolean(<span class="hljs-string">"audio.safemedia.bypass"</span>, <span class="hljs-keyword">false</span>);<font></font>
<font></font>
   <span class="hljs-keyword">int</span> persistedState;
   <span class="hljs-keyword">if</span> (safeMediaVolumeEnabled &amp;&amp; !safeMediaVolumeBypass) {<font></font>
       persistedState = SAFE_MEDIA_VOLUME_ACTIVE;<font></font>
       <span class="hljs-comment">/*  ,  mSafeMediaVolumeState   ACTIVE,  INACTIVE */</span><font></font>
...<font></font>
   } <span class="hljs-keyword">else</span> {<font></font>
       persistedState = SAFE_MEDIA_VOLUME_DISABLED;<font></font>
       mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED;<font></font>
   }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voyons qu'en plus de la valeur de la ressource </font></font><code>R.bool.config_safe_media_volume_enabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, il existe deux propriétés qui activent / désactivent le système d'écoute sécurisé: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.force</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.bypass</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour désactiver l'avertissement, vous devez définir la valeur de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">audio.safemedia.bypass = true</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier system / build.properties</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais cela nécessite des droits root. </font><font style="vertical-align: inherit;">Si ce n'est pas le cas, vous devez comprendre davantage et chercher une autre façon.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment désactiver l'avertissement sans root</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce qui se passe lorsque vous fermez la boîte de dialogue d'avertissement en cliquant sur OK et essayez de reproduire ceci:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onClick</span><span class="hljs-params">(DialogInterface dialog, <span class="hljs-keyword">int</span> which)</span> </span>{<font></font>
        mAudioManager.disableSafeMediaVolume();<font></font>
    } </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode d' </font></font><code>disableSafeMediaVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instance </font><font style="vertical-align: inherit;">est appelée </font></font><code>AudioManager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">/**
* Only useful for volume controllers.
* <span class="hljs-doctag">@hide</span>
*/</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">disableSafeMediaVolume</span><span class="hljs-params">()</span> </span>{ … }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est marqué d'une annotation </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cela signifie que la méthode ne sera pas incluse dans l'API publique malgré le modificateur public. </font><font style="vertical-align: inherit;">Avant Android 9, cela pouvait facilement être contourné en utilisant la réflexion. </font><font style="vertical-align: inherit;">Maintenant, cependant, une telle méthode peut toujours être appelée, mais à l'aide d'une astuce appelée </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">double réflexion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> audioManager = getSystemService(Context.AUDIO_SERVICE) <span class="hljs-keyword">as</span> AudioManager
<span class="hljs-keyword">val</span> getDeclaredMethod = Class::<span class="hljs-keyword">class</span>.java.getDeclaredMethod(<span class="hljs-string">"getDeclaredMethod"</span>, String::<span class="hljs-keyword">class</span>.java, arrayOf&lt;Class&lt;*&gt;&gt;()::<span class="hljs-keyword">class</span>.java)
<span class="hljs-keyword">val</span> disableSafeMediaVolumeMethod = getDeclaredMethod.invoke(AudioManager::<span class="hljs-keyword">class</span>.java, <span class="hljs-string">"disableSafeMediaVolume"</span>, arrayOf&lt;Class&lt;*&gt;&gt;()) <span class="hljs-keyword">as</span> Method<font></font>
disableSafeMediaVolumeMethod.invoke(audioManager)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'appel se termine par une exception. </font></font><br>
<code>java.lang.SecurityException: Only SystemUI can disable the safe media volume: Neither user 10307 nor current process has android.permission.STATUS_BAR_SERVICE.</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'autorisation STATUS_BAR_SERVICE a protectionLevel = "signature | privileged", cela ne fonctionnera pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, essayez ceci. </font><font style="vertical-align: inherit;">Nous surveillerons la variable </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans laquelle la valeur actuelle est stockée périodiquement </font></font><code>mMusicActiveMs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Lorsque la valeur commence à approcher 20 heures, nous la réinitialiserons. </font><font style="vertical-align: inherit;">Ensuite, vous devrez faire en sorte qu'AudioService lise la nouvelle valeur dans les paramètres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pouvez </font><font style="vertical-align: inherit;">lire la valeur </font><font style="vertical-align: inherit;">comme ceci:</font></font><br>
<br>
<pre><code class="kotlin hljs"><span class="hljs-keyword">val</span> unsafeMs = Settings.Secure.getInt(contentResolver, <span class="hljs-string">"unsafe_volume_music_active_ms"</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Même chose avec adb:</font></font><br>
<br>
<pre><code class="bash hljs"> adb shell settings get secure unsafe_volume_music_active_ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et pour écrire la valeur, l'application aura besoin d'une autorisation </font></font><code>android.permission.WRITE_SECURE_SETTINGS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a protectionLevel = "signature | privileged | </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">développement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", ce qui signifie qu'il peut être renvoyé à l'application en utilisant adb:</font></font><br>
<br>
<pre><code class="bash hljs">adb shell pm grant com.example.app android.permission.WRITE_SECURE_SETTINGS</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La valeur elle-même peut être écrite comme ceci:</font></font><br>
<br>
<pre><code class="kotlin hljs">Settings.Secure.putInt(contentResolver, <span class="hljs-string">"unsafe_volume_music_active_ms"</span>
, <span class="hljs-number">1</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez faire de même avec adb:</font></font><br>
<br>
<pre><code class="bash hljs">adb shell settings put secure unsafe_volume_music_active_ms 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est préférable de réinitialiser à 1, comme cela se fait dans AudioManager, mais pas à 0. Puisque 0 correspond à l'état ACTIVE. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous avez maintenant besoin d'AudioService pour lire la nouvelle valeur et mettre à jour la valeur de la variable locale </font></font><code>mMusicActiveMs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe une méthode appropriée dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AudioManager.java</font></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">/**
*  <span class="hljs-doctag">@hide</span>
*  Reload audio settings. This method is called by Settings backup
*  agent when audio settings are restored and causes the AudioService
*  to read and apply restored settings.
*/</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reloadAudioSettings</span><span class="hljs-params">()</span> </span>{<font></font>
   …<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il lance un appel de méthode </font></font><code>readAudioSettings </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans </font></font><code>AudioService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lequel le chargement à </font></font><code>mMusicActiveMs </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partir des paramètres </font><font style="vertical-align: inherit;">a lieu </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readAudioSettings</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> userSwitch)</span> </span>{<font></font>
...<font></font>
<span class="hljs-keyword">synchronized</span> (mSafeMediaVolumeStateLock) {<font></font>
        mMusicActiveMs = MathUtils.constrain(Settings.Secure.getIntForUser(mContentResolver,<font></font>
                Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS, <span class="hljs-number">0</span>, UserHandle.USER_CURRENT),
                <span class="hljs-number">0</span>, UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAX);
        <span class="hljs-keyword">if</span> (mSafeMediaVolumeState == SAFE_MEDIA_VOLUME_ACTIVE) {<font></font>
            enforceSafeMediaVolume(TAG);<font></font>
        }<font></font>
<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode est marquée d'annotations </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. L'appeler avec une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">double réflexion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lève une exception: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
java.lang.SecurityException: refus d'autorisation: le paramètre get / set pour l'utilisateur demande à s'exécuter en tant qu'utilisateur -2 mais appelle depuis l'utilisateur 0; cela nécessite android.permission.INTERACT_ACROSS_USERS_FULL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oui, l'annotation </font></font><code>@hide</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici n'est pas non plus un accident. Bien sûr, nous ne pouvons pas obtenir cette autorisation. Il a protectionLevel = "signature | installer". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste un moyen de faire lire à AudioService la nouvelle valeur - en la redémarrant. Vous ne pouvez pas simplement redémarrer le service système. Vous devez soit redémarrer l'appareil, soit basculer vers un autre utilisateur, puis revenir en arrière. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est maintenant temps de tester la théorie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installer</font></font><code>unsafe_volume_music_active_ms = 71 990 000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (10 secondes restantes, pendant lesquelles vous pouvez écouter de la musique à fort volume)</font></font><br>
<br>
<pre><code class="bash hljs">adb shell settings put secure unsafe_volume_music_active_ms 71990000</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous redémarrons l'appareil (vous pouvez à la place passer à un autre utilisateur, puis revenir):</font></font><br>
<br>
<pre><code class="bash hljs">adb reboot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous connectons le casque, allumons la musique plus fort. </font><font style="vertical-align: inherit;">Un dialogue apparaît dans la minute. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous répétons les mêmes actions, mais affectons unsafe_volume_music_active_ms = 1. Allumez la musique, attendez une minute. </font><font style="vertical-align: inherit;">La boîte de dialogue n'apparaît pas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour désactiver l'avertissement, vous pouvez procéder comme suit: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous avez des droits root</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Définissez la valeur de audio.safemedia.bypass = true dans le système de fichiers / build.properties </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sans droits root</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Vous devez surveiller la valeur </font></font><b><code>Settings.Secure.UNSAFE_VOLUME_MUSIC_ACTIVE_MS</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et l'empêcher de dépasser </font><font style="vertical-align: inherit;">72 000 000 </font><font style="vertical-align: inherit;">(20 heures ) </font><font style="vertical-align: inherit;">Après avoir réinitialisé la valeur, vous devez redémarrer l'appareil (ou basculer vers un autre utilisateur, puis revenir en arrière). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai écrit le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code d'une application simple</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui fait ce travail et me rappelle la nécessité de redémarrer l'appareil / de me connecter.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise à jour</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fabricants d'appareils peuvent apporter des modifications au code de la plate-forme et, à en juger par les commentaires, certains d'entre eux atténuent le comportement par défaut. </font><font style="vertical-align: inherit;">Par exemple, un avertissement peut apparaître une fois et ne se produire plus jusqu'au prochain redémarrage.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr506852/index.html">Comment Signal crypto messenger résiste avec succès à l'écoute électronique par les autorités américaines</a></li>
<li><a href="../fr506860/index.html">23 juin - NX Analyst Meetup # 3. Nous discuterons des entretiens avec les clients et travaillerons avec des clients complexes.</a></li>
<li><a href="../fr506864/index.html">Sortie prochaine de Linux 5.8: des millions de lignes de nouveau code et 14 000 modifications</a></li>
<li><a href="../fr506866/index.html">Base d'assurance unique - Système de collaboration avec les compagnies d'assurance</a></li>
<li><a href="../fr506868/index.html">Sam Altman: générer des idées</a></li>
<li><a href="../fr506872/index.html">Livre Spring Boot 2: Meilleures pratiques pour les professionnels</a></li>
<li><a href="../fr506874/index.html">De la vie d'un programmeur: les gens d'affaires</a></li>
<li><a href="../fr506880/index.html">Joel Spolsky: comment l'ère Stack Overflow a commencé</a></li>
<li><a href="../fr506886/index.html">Life hack for bits</a></li>
<li><a href="../fr506888/index.html">Tri de la triche pour la science des données</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>