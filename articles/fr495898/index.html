<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöï üôÅ üêç Un guide pratique pour g√©rer les fuites de m√©moire dans Node.js üò± ‚òùüèº üíáüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les fuites de m√©moire sont similaires aux entit√©s parasites sur une application. Ils p√©n√®trent tranquillement dans le syst√®me, au d√©but sans causer de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Un guide pratique pour g√©rer les fuites de m√©moire dans Node.js</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/495898/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les fuites de m√©moire sont similaires aux entit√©s parasites sur une application. </font><font style="vertical-align: inherit;">Ils p√©n√®trent tranquillement dans le syst√®me, au d√©but sans causer de mal. </font><font style="vertical-align: inherit;">Mais si la fuite s'av√®re suffisamment forte, elle peut entra√Æner la catastrophe de l'application. </font><font style="vertical-align: inherit;">Par exemple - pour le ralentir fortement ou simplement pour le ¬´tuer¬ª. </font><font style="vertical-align: inherit;">
L'auteur de l'article, dont nous publions la traduction aujourd'hui, sugg√®re de parler des fuites de m√©moire en JavaScript. </font><font style="vertical-align: inherit;">En particulier, nous parlerons de la gestion de la m√©moire en JavaScript, comment identifier les fuites de m√©moire dans les applications r√©elles et comment traiter les fuites de m√©moire.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/ut/sj/t-/utsjt-d80r9mqkvrexbbkws-eae.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'une fuite de m√©moire?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fuite de m√©moire est, au sens large, un morceau de m√©moire allou√© √† une application dont cette application n'a plus besoin, mais qui ne peut pas √™tre renvoy√©e au syst√®me d'exploitation pour une utilisation future. </font><font style="vertical-align: inherit;">En d'autres termes, il s'agit d'un bloc de m√©moire qui est captur√© par l'application sans l'intention d'utiliser cette m√©moire √† l'avenir.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion de la m√©moire</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La gestion de la m√©moire est un m√©canisme d'allocation de m√©moire syst√®me √† une application qui en a besoin et un m√©canisme de renvoi de m√©moire inutile au syst√®me d'exploitation. </font><font style="vertical-align: inherit;">Il existe de nombreuses approches de la gestion de la m√©moire. </font><font style="vertical-align: inherit;">L'approche utilis√©e d√©pend du langage de programmation utilis√©. </font><font style="vertical-align: inherit;">Voici un aper√ßu de plusieurs approches courantes de la gestion de la m√©moire:</font></font><br>
<br>
<ul>
<li>  .           .         .       ,    .        C  C++.   ,   ,   <code>malloc</code>  <code>free</code>,      .</li>
<li>   . ,      ,   ,       .   ,  ,    ,        . ,     ,  ,      ,   .         .  ‚Äî JavaScript, ,   JVM (Java, Scala, Kotlin), Golang, Python, Ruby  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application du concept de propri√©t√© de la m√©moire. </font><font style="vertical-align: inherit;">Avec cette approche, chaque variable doit avoir son propre propri√©taire. </font><font style="vertical-align: inherit;">D√®s que le propri√©taire est hors de port√©e, la valeur de la variable est d√©truite, lib√©rant de la m√©moire. </font><font style="vertical-align: inherit;">Cette id√©e est utilis√©e dans Rust.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe d'autres approches de la gestion de la m√©moire utilis√©es dans diff√©rents langages de programmation. </font><font style="vertical-align: inherit;">Par exemple, C ++ 11 utilise l'idiome </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAII</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tandis que Swift utilise le m√©canisme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais en parler d√©passe le cadre de cet article. </font><font style="vertical-align: inherit;">Afin de comparer les m√©thodes de gestion de la m√©moire ci-dessus, pour comprendre leurs avantages et leurs inconv√©nients, nous avons besoin d'un article s√©par√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JavaScript, un langage sans lequel les programmeurs Web ne peuvent pas imaginer leur travail, utilise l'id√©e de garbage collection. </font><font style="vertical-align: inherit;">Par cons√©quent, nous parlerons davantage du fonctionnement de ce m√©canisme.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collecte de d√©chets JavaScript</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme d√©j√† mentionn√©, JavaScript est un langage qui utilise le concept de garbage collection. </font><font style="vertical-align: inherit;">Pendant le fonctionnement des programmes JS, un m√©canisme appel√© garbage collector est p√©riodiquement lanc√©. </font><font style="vertical-align: inherit;">Il d√©couvre quelles parties de la m√©moire allou√©e sont accessibles √† partir du code d'application. </font><font style="vertical-align: inherit;">Autrement dit, quelles variables sont r√©f√©renc√©es. </font><font style="vertical-align: inherit;">Si le garbage collector d√©couvre qu'un morceau de m√©moire n'est plus accessible √† partir du code d'application, il lib√®re cette m√©moire. </font><font style="vertical-align: inherit;">L'approche ci-dessus peut √™tre mise en ≈ìuvre en utilisant deux algorithmes principaux. </font><font style="vertical-align: inherit;">Le premier est ce que l'on appelle l'algorithme Mark and Sweep. </font><font style="vertical-align: inherit;">Il est utilis√© en JavaScript. </font><font style="vertical-align: inherit;">Le deuxi√®me est le comptage des r√©f√©rences. </font><font style="vertical-align: inherit;">Il est utilis√© en Python et PHP.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3ee/8ac/c60/3ee8acc608afe85e6a4c6f202cb1e8fe.gif"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phases Mark (marquage) et Sweep (nettoyage) de l'</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
algorithme</font><i><font color="#999999"><font style="vertical-align: inherit;"> Mark and Sweep</font></font></i><font style="vertical-align: inherit;"> Lors de la mise en ≈ìuvre de l'algorithme de marquage, une liste de n≈ìuds racine repr√©sent√©e par des variables d'environnement globales (c'est un objet dans le navigateur</font></font><code>window</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) est d'abord cr√©√©e, puis l'arborescence r√©sultante est analys√©e des n≈ìuds racine aux feuilles marqu√©s de tous rencontr√© sur le chemin des objets. </font><font style="vertical-align: inherit;">La m√©moire du tas occup√©e par des objets sans √©tiquette est lib√©r√©e.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuites de m√©moire dans les applications Node.js</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä ce jour, nous avons analys√© suffisamment de concepts th√©oriques li√©s aux fuites de m√©moire et √† la collecte des ordures. </font><font style="vertical-align: inherit;">Donc, nous sommes pr√™ts √† voir √† quoi tout cela ressemble dans les applications r√©elles. </font><font style="vertical-align: inherit;">Dans cette section, nous allons √©crire un serveur Node.js qui a une fuite de m√©moire. </font><font style="vertical-align: inherit;">Nous essaierons d'identifier cette fuite √† l'aide de divers outils, puis nous l'√©liminerons.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Familiarit√© avec un code pr√©sentant une fuite de m√©moire</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä des fins de d√©monstration, j'ai √©crit un serveur Express qui a une route de fuite de m√©moire. </font><font style="vertical-align: inherit;">Nous allons d√©boguer ce serveur.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
<font></font>
app.listen(port, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Example app listening on port <span class="hljs-subst">${port}</span>!`</span>));
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe un tableau </font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui sort du domaine d'application du code de traitement des demandes d'API. </font><font style="vertical-align: inherit;">Par cons√©quent, chaque fois que le code correspondant est ex√©cut√©, de nouveaux √©l√©ments sont simplement ajout√©s au tableau. </font><font style="vertical-align: inherit;">Le tableau n'est jamais effac√©. </font><font style="vertical-align: inherit;">√âtant donn√© que le lien vers ce tableau ne dispara√Æt pas apr√®s avoir quitt√© le gestionnaire de demandes, le garbage collector ne lib√®re jamais la m√©moire qu'il utilise.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçAppeler une fuite de m√©moire</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous arrivons ici au plus int√©ressant. De nombreux articles ont √©t√© √©crits sur la fa√ßon </font></font><code>node --inspect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de d√©boguer les fuites de m√©moire du serveur, apr√®s avoir rempli le serveur de requ√™tes en utilisant quelque chose comme l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artillerie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mais cette approche pr√©sente un inconv√©nient important. Imaginez que vous ayez un serveur API qui a des milliers de points de terminaison. Chacun d'eux prend beaucoup de param√®tres, dont le code sp√©cifique sera appel√© d√©pend des caract√©ristiques de celui-ci. Par cons√©quent, dans des conditions r√©elles, si le d√©veloppeur ne sait pas o√π se trouve la fuite de m√©moire, il devra acc√©der √† chaque API plusieurs fois en utilisant toutes les combinaisons possibles de param√®tres pour remplir la m√©moire. Pour moi, ce n'est pas facile. Cependant, la solution √† ce probl√®me est facilit√©e en utilisant quelque chose comme</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">goreplay</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - un syst√®me qui vous permet d'enregistrer et de "jouer" du trafic r√©el. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de faire face √† notre probl√®me, nous allons faire le d√©bogage en production. </font><font style="vertical-align: inherit;">Autrement dit, nous autoriserons notre serveur √† d√©border de m√©moire pendant son utilisation r√©elle (car il re√ßoit une vari√©t√© de demandes d'API). </font><font style="vertical-align: inherit;">Et apr√®s avoir constat√© une augmentation suspecte de la quantit√© de m√©moire qui lui est allou√©e, nous proc√©derons au d√©bogage.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç Vidage de tas</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de comprendre ce qu'est un vidage de tas, nous devons d'abord d√©couvrir la signification du concept de tas. Si vous d√©crivez ce concept aussi simplement que possible, il s'av√®re que le tas est l'endroit o√π tout ce que la m√©moire est allou√©e tombe. Tout cela est sur le tas jusqu'√† ce que le ramasse-miettes en retire tout ce qui est jug√© inutile. Un vidage de segment de m√©moire est un instantan√© de l'√©tat actuel du segment de m√©moire. Le vidage contient toutes les variables internes et variables d√©clar√©es par le programmeur. Il repr√©sente toute la m√©moire allou√©e sur le tas au moment de la r√©ception du vidage.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, si nous pouvions d'une mani√®re ou d'une autre comparer le vidage de tas du serveur qui venait de commencer avec le vidage du tas de serveur, qui fonctionnait depuis longtemps et d√©bordait de m√©moire, nous pourrions identifier les objets suspects dont l'application n'a pas besoin, mais qui ne sont pas supprim√©s par le garbage collector. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de poursuivre la conversation, parlons de la fa√ßon de cr√©er des vidages de tas. </font><font style="vertical-align: inherit;">Pour r√©soudre ce probl√®me, nous utiliserons le paquetage npm </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heapdump</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui vous permet d'obtenir par programme un vidage du tas du serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez le package:</font></font><br>
<br>
<pre><code class="bash hljs">npm i heapdump
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons apporter quelques modifications au code du serveur qui nous permettront d'utiliser ce package:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> heapdump = <span class="hljs-built_in">require</span>(<span class="hljs-string">"heapdump"</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;<font></font>
<font></font>
<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
<font></font>
app.get(<span class="hljs-string">'/heapdump'</span>, (req, res) =&gt; {<font></font>
&nbsp;&nbsp;heapdump.writeSnapshot(<span class="hljs-string">`heapDump-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>.heapsnapshot`</span>, (err, filename) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Heap dump of a bloated server written to"</span>, filename);<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">msg</span>: <span class="hljs-string">"successfully took a heap dump"</span>})<font></font>
&nbsp;&nbsp;});<font></font>
});<font></font>
<font></font>
app.listen(port, () =&gt; {<font></font>
&nbsp;&nbsp;heapdump.writeSnapshot(<span class="hljs-string">`heapDumpAtServerStart.heapsnapshot`</span>, (err, filename) =&gt; {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Heap dump of a fresh server written to"</span>, filename);<font></font>
&nbsp;&nbsp;});<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous avons utilis√© ce package pour vider un serveur fra√Æchement lanc√©. </font><font style="vertical-align: inherit;">Nous avons √©galement cr√©√© une API </font></font><code>/heapdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con√ßue pour cr√©er un tas lors de l'acc√®s. </font><font style="vertical-align: inherit;">Nous allons nous tourner vers cette API au moment o√π nous nous rendons compte que le serveur a commenc√© √† consommer trop de m√©moire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si votre serveur s'ex√©cute dans un cluster Kubernetes, vous ne pourrez pas, sans effort suppl√©mentaire, vous tourner vers ce m√™me pod dont le serveur s'ex√©cute et qui consomme trop de m√©moire. </font><font style="vertical-align: inherit;">Pour ce faire, vous pouvez utiliser la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redirection de port</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">De plus, comme vous n'aurez pas acc√®s au syst√®me de fichiers dont vous avez besoin pour t√©l√©charger des fichiers de vidage, il serait pr√©f√©rable de t√©l√©charger ces fichiers vers un stockage cloud externe (comme S3).</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç D√©tection de fuite de m√©moire</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, le serveur est d√©ploy√©. Il travaille depuis plusieurs jours. Il re√ßoit beaucoup de requ√™tes (dans notre cas, uniquement des requ√™tes du m√™me type) et nous avons fait attention √† l'augmentation de la quantit√© de m√©moire consomm√©e par le serveur. Une fuite de m√©moire peut √™tre d√©tect√©e √† l'aide d'outils de surveillance comme </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Express Status Monitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clinic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Apr√®s cela, nous appelons l'API pour vider le tas. Ce vidage contiendra tous les objets que le garbage collector n'a pas pu supprimer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemble la requ√™te pour cr√©er un vidage:</font></font><br>
<br>
<pre><code class="bash hljs">curl --location --request GET <span class="hljs-string">'http://localhost:3000/heapdump'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'un vidage de tas est cr√©√©, le garbage collector est oblig√© de s'ex√©cuter. Par cons√©quent, nous n'avons pas √† nous soucier des objets qui pourraient √™tre supprim√©s par le garbage collector √† l'avenir, mais qui sont toujours sur le tas. C'est-√†-dire sur les objets lorsque vous travaillez avec lesquels des fuites de m√©moire ne se produisent pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que nous avons les deux vidages √† notre disposition (un vidage d'un serveur fra√Æchement lanc√© et un vidage d'un serveur qui fonctionne depuis un certain temps), nous pouvons commencer √† les comparer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'obtention d'un vidage de la m√©moire est une op√©ration de blocage qui n√©cessite beaucoup de m√©moire. Par cons√©quent, il doit √™tre effectu√© avec prudence. Vous pouvez en savoir plus sur les probl√®mes possibles rencontr√©s lors de cette op√©ration </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lancez Chrome et appuyez sur la touche.</font></font><code>F12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cela conduira √† la d√©couverte d'outils de d√©veloppement. </font><font style="vertical-align: inherit;">Ici, vous devez acc√©der √† l'onglet </font></font><code>Memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et charger les deux instantan√©s de m√©moire.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5c1/252/992/5c125299224be08bb5bb73f74842f0b8.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le t√©l√©chargement m√©moire amoncel√©s sur l'onglet M√©moire des outils de d√©veloppement Chrome</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Apr√®s avoir t√©l√©charg√©</font><font style="vertical-align: inherit;">deux instantan√©s, vous devez changer</font></font><code>perspective</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour</font></font><code>Comparison</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et cliquez sur l'instantan√© de la m√©moire du serveur qui</font><font style="vertical-align: inherit;">travaill√© pendant</font><font style="vertical-align: inherit;">certain temps.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a99/7c7/224/a997c7224ac3d053651be9e848380e75.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commencer √† comparer des instantan√©s</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ici, nous pouvons analyser la colonne</font></font><code>Constructor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et rechercher des objets que le garbage collector ne peut pas supprimer. </font><font style="vertical-align: inherit;">La plupart de ces objets seront repr√©sent√©s par des liens internes que les n≈ìuds utilisent. </font><font style="vertical-align: inherit;">Ici, il est utile d'utiliser une astuce, qui consiste √† trier la liste par champ</font></font><code>Alloc. Size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Cela trouvera rapidement les objets qui utilisent le plus de m√©moire. </font><font style="vertical-align: inherit;">Si vous d√©veloppez le bloc</font></font><code>(array)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis -</font></font><code>(object elements)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, vous pouvez voir un tableau</font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contenant un grand nombre d'objets qui ne peuvent pas √™tre supprim√©s √† l'aide du garbage collector.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e85/02c/0a2/e8502c0a2dcd1cf635f229eaef8d9e90.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyse d'une baie suspecte</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Cette technique nous permettra d'acc√©der √† la baie</font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et de comprendre que c'est l'op√©ration incorrecte avec elle qui provoque une fuite de m√©moire.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LeakFix m√©moire fuite</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que nous savons que le ¬´coupable¬ª est un tableau </font></font><code>leaks</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, nous pouvons analyser le code et d√©couvrir que le probl√®me est que le tableau est d√©clar√© en dehors du gestionnaire de requ√™tes. </font><font style="vertical-align: inherit;">En cons√©quence, il s'av√®re que le lien vers celui-ci n'est jamais supprim√©. </font><font style="vertical-align: inherit;">Pour r√©soudre ce probl√®me est assez simple - il suffit de transf√©rer la d√©claration du tableau au gestionnaire:</font></font><br>
<br>
<pre><code class="javascript hljs">app.get(<span class="hljs-string">'/bloatMyServer'</span>, (req, res) =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> redundantObj = {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">memory</span>: <span class="hljs-string">"leaked"</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">joke</span>: <span class="hljs-string">"meta"</span><font></font>
&nbsp;&nbsp;};<font></font>
<font></font>
&nbsp;&nbsp;<span class="hljs-keyword">const</span> leaks = [];<font></font>
<font></font>
&nbsp;&nbsp;[...Array(<span class="hljs-number">10000</span>)].map(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> leaks.push(redundantObj));<font></font>
<font></font>
&nbsp;&nbsp;res.status(<span class="hljs-number">200</span>).send({<span class="hljs-attr">size</span>: leaks.length})<font></font>
});<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de v√©rifier l'efficacit√© des mesures prises, il suffit de r√©p√©ter les √©tapes ci-dessus et de comparer √† nouveau les images de tas.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les fuites de m√©moire se produisent dans diff√©rentes langues. </font><font style="vertical-align: inherit;">En particulier, dans - ceux qui utilisent des m√©canismes de collecte des ordures. </font><font style="vertical-align: inherit;">Par exemple, en JavaScript. </font><font style="vertical-align: inherit;">Il n'est g√©n√©ralement pas difficile de r√©parer une fuite - les vraies difficult√©s ne surviennent que lorsque vous la recherchez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, vous vous √™tes familiaris√© avec les bases de la gestion de la m√©moire et la fa√ßon dont la gestion de la m√©moire est organis√©e dans diff√©rentes langues. </font><font style="vertical-align: inherit;">Ici, nous avons reproduit un sc√©nario r√©el de fuite de m√©moire et d√©crit une m√©thode de d√©pannage. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chers lecteurs! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avez-vous rencontr√© des fuites de m√©moire dans vos projets Web?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495888/index.html">PyCon Russie a ouvert CFP pour les futurs conf√©renciers. Formulaires de participation et sujets attendus</a></li>
<li><a href="../fr495890/index.html">Configuration d'un ensemble Nginx / LetsEncrypt dans Docker Swarm</a></li>
<li><a href="../fr495892/index.html">Savez-vous vraiment ce que sont les tableaux?</a></li>
<li><a href="../fr495894/index.html">Javascript Performance Measurement</a></li>
<li><a href="../fr495896/index.html">Package Use-sound: Effets sonores dans les applications React</a></li>
<li><a href="../fr495902/index.html">CAPTCHA: tuer la conversion</a></li>
<li><a href="../fr495904/index.html">Peut-on pr√©voir une √©pid√©mie?</a></li>
<li><a href="../fr495908/index.html">Le chemin de la r√©compense</a></li>
<li><a href="../fr495910/index.html">Installation de ROS dans une image IMG √† carte unique Ubuntu</a></li>
<li><a href="../fr495912/index.html">Autocollants de relecture intelligente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>