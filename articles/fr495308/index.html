<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏠 🤳🏽 😜 Rake sur le chemin de la survie 🙏 🐂 🎅🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'augmentation de l'activité d'échange de données entre microservices est souvent un problème dans l'architecture des solutions informatiques modernes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Rake sur le chemin de la survie</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495308/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'augmentation de l'activité d'échange de données entre microservices est souvent un problème dans l'architecture des solutions informatiques modernes. </font><font style="vertical-align: inherit;">Pressez le maximum et survivez à tout prix - un défi sérieux pour tout développement. </font><font style="vertical-align: inherit;">Par conséquent, la recherche de solutions optimales est un processus continu. </font><font style="vertical-align: inherit;">L'article décrit brièvement les problèmes pouvant survenir lors de l'utilisation de requêtes http très chargées et les moyens de les contourner.</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cette histoire commence par une erreur. D'une manière ou d'une autre, nous avons effectué des tests de charge, dont l'élément principal était l'exécution d'un grand nombre de courtes requêtes http. Un client écrit sous </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netcore 2.2</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , à partir d'un moment donné, lève une </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Net.Sockets.SocketException: adresse déjà utilisée</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il est rapidement devenu évident que les ports n'avaient pas eu le temps de libérer du client, et à un moment donné, le système a refusé d'en ouvrir un nouveau. Maintenant, si nous passons au code, le problème résidait dans l'utilisation de l'ancienne approche avec la classe </font><font style="vertical-align: inherit;">et la construction </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HttpWebRequest</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> request = WebRequest.CreateHttp(uri);
<span class="hljs-keyword">using</span>(<span class="hljs-keyword">var</span> resp = request.GetResponse()){ … }</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il semblerait que nous libérons la ressource, et le port devrait être libéré en temps opportun. </font><font style="vertical-align: inherit;">Cependant, </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">netstat a</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> signalé une augmentation rapide du nombre de ports dans l'état TIME_WAIT. </font><font style="vertical-align: inherit;">Cet état signifie attendre la fermeture de la connexion (et éventuellement recevoir des données perdues). </font><font style="vertical-align: inherit;">Par conséquent, le port peut y rester pendant 1 à 2 minutes. </font><font style="vertical-align: inherit;">Ce problème est traité en détail dans de nombreux articles ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problèmes avec la file d'attente TIME_WAIT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Historique de TIME_WAIT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Néanmoins, cela signifie que </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dotnet essaie</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> «honnêtement» de fermer la connexion, et cela se produit déjà par la faute des paramètres de temporisation dans le système.</font></font></p><br>
<h3 id="pochemu-tak-proishodit-i-kak-s-etim-borotsya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi cela se produit-il et comment y faire face</font></font></h3><br>
<p>    <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">keep-alive</a></em>.     .      ,     .  <em>msdn</em>,  <em>KeepAlive</em>  <em>HttpWebRequest</em>    <em>true</em>.      <em>HttpWebRequest</em> «» ,    ,      .   , <em>HttpWebRequest</em>        «Connection: keep-alive»,       <em>HTTP/1.1</em>. ,   ,    KeepAlive.   HttpWebRequest.KeepAlive = false,      «Connection: close».  ,        .      nginx   . </p><br>
<p>  :</p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">var</span> request = WebRequest.CreateHttp(uri);<font></font>
  request.KeepAlive = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> resp = <span class="hljs-keyword">await</span> request.GetResponseAsync();
  <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> sr = <span class="hljs-keyword">new</span> StreamReader(resp.GetResponseStream()))<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> content = sr.ReadToEnd();<font></font>
  }<font></font>
}</code></pre><br>
<p>      ,    ( 1000   )        .       CLOSE_WAIT, LAST_ACK.  -   ,       .     ,    «»   .</p><br>
<h3 id="zakryvat-nelzya-pereispolzovat"> , </h3><br>
<p>,    ,   .      <em>keep-alive</em>    <em>HttpClient</em>.            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://docs.microsoft.com/ru-ru/dotnet/api/system.net.http." rel="nofollow"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.</p><br>
<p>    ,  ,   ?   keep-alive        nginx:</p><br>
<ul>
<li>keepalive_timeout –   (  15)</li>
<li>keepalive_requests –       (  100)</li>
</ul><br>
<p>    <em>netstat</em>  <em>wireshark</em>,            .   <em>keepalive_requests</em>    (&gt; 1000)  ,     .</p><br>
<h3 id="vyvod"></h3><br>
<p>  <strong> </strong> http    ,     .       .         ,       ,     <em>keep-alive</em>.  <em>keep-alive</em>          ,            .</p><br>
<p>     :</p><br>
<ul>
<li>RunHttpClient –   HttpClient  "Connection: keep-alive" </li>
<li>RunHttpClientClosed –   HttpClient  "Connection: closed"</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunWebRequestClosed - utilise la classe HttpWebRequest en mode "Connexion: fermée"</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur nginx est configuré avec les paramètres suivants: </font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keepalive_timeout 60s;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keepalive_requests 100000;</font></font></li>
</ul><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Méthode</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les pubs</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signifier</font></font></th>
</tr>
</thead>
<tbody>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Runhttpclient</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">963,3 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunWebRequestClosed</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 857,4 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunHttpClientClosed</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 612,4 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Runhttpclient</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 573,9 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunWebRequestClosed</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">37 947,4 ms</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RunHttpClientClosed</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 112,9 ms</font></font></td>
</tr>
</tbody>
</table></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495294/index.html">Macros pour un pythoniste. Rapport Yandex</a></li>
<li><a href="../fr495296/index.html">Médecine légale, injection SQL et chat endurci: analyse de la tâche n ° 3 de l'étape en ligne NeoQUEST-2020</a></li>
<li><a href="../fr495298/index.html">Évaluer les options de Monte Carlo Clojure</a></li>
<li><a href="../fr495302/index.html">Comment augmenter les ventes 2,5 fois en 4 mois dans une boutique en ligne - un cas pour la promotion SEO</a></li>
<li><a href="../fr495304/index.html">Rajeunissement des cellules humaines grâce à leur reprogrammation</a></li>
<li><a href="../fr495310/index.html">Visite virtuelle: biométrie et multiformat</a></li>
<li><a href="../fr495312/index.html">Sécurité du périmètre - l'avenir est maintenant</a></li>
<li><a href="../fr495314/index.html">Comment filtrer la désinformation si elle provient de sources officielles?</a></li>
<li><a href="../fr495330/index.html">Une popularité méritée en chiffres</a></li>
<li><a href="../fr495332/index.html">Quatuor 9: Allegro | Manuscrit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>