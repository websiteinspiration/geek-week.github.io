<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ» ğŸ˜» ğŸ‘ Nginxã§ç›´æ¥ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° ğŸ™‡ğŸ» ğŸ§œğŸ¾ ğŸ™ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nginxã¯å„ªã‚ŒãŸWebã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚ã•ã¾ã–ã¾ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨â€‹â€‹ã™ã‚‹ã“ã¨ã«æ…£ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€Nginxæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ç°¡å˜ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã€ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã€ã‚·ãƒ³ãƒ—ãƒ«ãªAPIã‚’è¨˜è¿°ã—ã€æ§‹æˆã‹ã‚‰ç›´æ¥å‹•çš„ãƒšãƒ¼ã‚¸ã‚’æä¾›ã™ã‚‹ã“...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nginxã§ç›´æ¥ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/504308/"><img src="https://habrastorage.org/webt/3d/1p/2x/3d1p2x0yrvkljpmvhyvrgjzlsre.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nginxã¯å„ªã‚ŒãŸWebã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚ã•ã¾ã–ã¾ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨â€‹â€‹ã™ã‚‹ã“ã¨ã«æ…£ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€Nginxæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ç°¡å˜ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã€ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚Šã€ã‚·ãƒ³ãƒ—ãƒ«ãªAPIã‚’è¨˜è¿°ã—ã€æ§‹æˆã‹ã‚‰ç›´æ¥å‹•çš„ãƒšãƒ¼ã‚¸ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®è¨˜äº‹ã§ã¯ã€nginxæ§‹æˆã§ç°¡å˜ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è¨˜è¿°ã™ã‚‹ä¾‹ã‚’åˆ†æã—ã¾ã™ã€‚</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦‹ãŸç›®ã¯ãƒ¯ã‚¤ãƒ«ãƒ‰ã§ã™ãŒä¾¿åˆ©ãªæ§‹æˆã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã‚ˆã†ã«è¦‹ãˆã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã‚³ãƒ¼ãƒ‰ã¯éåŒæœŸã§å®Ÿè¡Œã•ã‚Œã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãªã—ã§ãƒ¡ã‚¤ãƒ³ã®Nginxã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«å¹²æ¸‰ã—ã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„ã™ã¹ã¦ã®åŸºæœ¬æ©Ÿèƒ½ã¨ã®äº’æ›æ€§ãŒã‚ã‚Šã€é‡è¦ãªã®ã¯è¿…é€Ÿã«æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã§ã™ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lua + Nginxã®ä¸»ãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ã™ã€‚</font><font style="vertical-align: inherit;">Luaã«ãƒã‚¤ãƒ†ã‚£ãƒ–ã§ã‚ã‚Šã€Nginxã‹ã‚‰çµ±åˆã•ã‚ŒãŸã€å¤šãã®æ—¢è£½ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">Nginxã®é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã‚’ç¶­æŒã—ãªãŒã‚‰ã€éå¸¸ã«é©åˆ‡ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å–ã‚Šä»˜ã‘</font></font></h2><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ«ã‚¢</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç´”ç²‹ãªLuaã®ã‚µãƒãƒ¼ãƒˆã¯nginx-extrasãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§æä¾›ã•ã‚Œã¾ã™</font></font><br>
<pre><code class="bash hljs">apt-get install nginx<font></font>
apt-get install nginx-extras</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ss </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒŠã‚¤ã‚¹ãƒ‡ãƒ¼</font></font></a> <br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openrestest</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã®å ´åˆã€Nginxè‡ªä½“ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚OpenRestyã¯ãã‚Œã‚’ã‚¢ã‚»ãƒ³ãƒ–ãƒªã«å«ã‚ã¾ã™ã€‚</font><font style="vertical-align: inherit;">NginxãŒã™ã§ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å‰ã«åˆ‡æ–­ã—ã¦åœæ­¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</font></font><br>
<pre><code class="bash hljs">sudo systemctl <span class="hljs-built_in">disable</span> nginx<font></font>
sudo systemctl stop nginx</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã®å¾Œ</font></font><br>
<pre><code class="bash hljs">sudo apt-get -y install --no-install-recommends wget gnupg ca-certificates<font></font>
wget -O - https://openresty.org/package/pubkey.gpg | sudo apt-key add -<font></font>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"deb http://openresty.org/package/ubuntu <span class="hljs-subst">$(lsb_release -sc)</span> main"</span> \<font></font>
    | sudo tee /etc/apt/sources.list.d/openresty.list<font></font>
sudo apt-get update<font></font>
sudo apt-get -y install openresty</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€å¾Œã«ã€OpenRestyã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="bash hljs">sudo /usr/<span class="hljs-built_in">local</span>/openresty/bin/openresty</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å‡ºåŠ›ã¯ãªãã€ã‚µãƒ¼ãƒãƒ¼ã¯å˜ã«èµ·å‹•ã—ã¦ä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/41/au/x1/41aux1dma6mbdyuzlwx85rgwt7q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœæ­¢ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">sudo /usr/<span class="hljs-built_in">local</span>/openresty/bin/openresty -s quit</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¾ãšã€ã‚µã‚¤ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨æ§‹æˆã‚’ä½œæˆã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /usr/<span class="hljs-built_in">local</span>/openresty/nginx/sites<font></font>
sudo nano /usr/<span class="hljs-built_in">local</span>/openresty/nginx/sites/default.conf</code></pre><br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server;<font></font>
<font></font>
    <span class="hljs-attribute">root</span> /usr/local/openresty/nginx/html/default;<font></font>
<font></font>
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
<font></font>
    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;<font></font>
<font></font>
        <span class="hljs-attribute">content_by_lua_file</span> /usr/local/openresty/nginx/html/default/index.lua;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è¨­å®šã§ç›´æ¥å®Ÿè¡Œã§ãã¾ã™ãŒã€å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ãã«æ¥ç¶šã™ã‚‹æ–¹ãŒä¾¿åˆ©ã§ã™</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /usr/<span class="hljs-built_in">local</span>/openresty/nginx/html/default/index.lua</code></pre><br>
<pre><code class="lua hljs"><span class="hljs-keyword">local</span> name = ngx.var.arg_name <span class="hljs-keyword">or</span> <span class="hljs-string">"Anonymous"</span>
ngx.say(<span class="hljs-string">"Hello, "</span>, name, <span class="hljs-string">"!"</span>)</code></pre><br>
<pre><code class="bash hljs">sudo mkdir /usr/<span class="hljs-built_in">local</span>/openresty/nginx/html/default<font></font>
sudo mv /usr/<span class="hljs-built_in">local</span>/openresty/nginx/html/index.html /usr/<span class="hljs-built_in">local</span>/openresty/nginx/html/default</code></pre><br>
<img src="https://habrastorage.org/webt/ta/sa/b5/tasab5st0iygmkleek2z8morluo.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¾‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹ã¯ã€ã•ã¾ã–ã¾ãªã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ã‚ˆã‚Šå®Ÿç”¨çš„ãªä¾‹ã§ã™ã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ruhighload.com</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTMLå‡ºåŠ›</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {
  <span class="hljs-attribute">location</span> /hello {
    <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/html'</span>;<font></font>
<font></font>
    <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'
        ngx.say("Hello &lt;b&gt;world&lt;/b&gt;!")
    '</span>;<font></font>
  }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¤‡æ•°ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {
  <span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;
    <span class="hljs-attribute">content_by_lua_file</span> /var/www/lua/index.lua;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-attribute">location</span> /admin {
    <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;
    <span class="hljs-attribute">content_by_lua_file</span> /var/www/lua/admin.lua;<font></font>
  }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">http</span> {
    <span class="hljs-comment">#   </span>
    <span class="hljs-attribute">lua_shared_dict</span> stats <span class="hljs-number">1m</span>;<font></font>
<font></font>
    <span class="hljs-section">server</span> {
        <span class="hljs-attribute">location</span> / {
            <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'
		#   hits  1   
                ngx.shared.stats:incr("hits", 1)
		
		#   
                ngx.say(ngx.shared.stats:get("hits"))
            '</span>;<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redisã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">apt-get install lua-nginx-redis</code></pre><br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
        <span class="hljs-attribute">location</span> / {
            <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'
		local redis = require "nginx.redis"
		local red = redis:new()
		local ok, err = red:connect("127.0.0.1", 6379)
		ok, err = red:incr("test")
		local res, err = red:get("test")
		ngx.say("hits: ", res)
            '</span>;<font></font>
        }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openresty.org</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URIã«åŸºã¥ã„ã¦MySQLã‚¯ã‚¨ãƒªã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹ã¨</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ã€OpenRestyãƒ¦ãƒ¼ã‚¶ãƒ¼èª¿æŸ»</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ã‚³ãƒ¼ãƒ‰ã®</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webã‚¢ãƒ—ãƒªã¨</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openresty.orgã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã«</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">åŸºã¥ã„ã¦å‹•çš„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ãŒç™ºç”Ÿã—ã¾ã™</font></a><font style="vertical-align: inherit;"> -ç‰¹å®šã®Webãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼å°‚ç”¨ã®Webã‚µã‚¤ãƒˆã¯ãã‚Œã‚’ä½¿ç”¨ã—ã€openresty.orgã‚‚ä¾‹å¤–ã§ã¯ã‚ã‚Šã¾ã›ã‚“</font></font><br>
<br>
<h4><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/post/270463</font></font></a></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ã‚¨ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¤œç´¢</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-comment">-- search.lua</span>
<span class="hljs-keyword">local</span> <span class="hljs-built_in">string</span> = ngx.var.arg_string  <span class="hljs-comment">--    GET </span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">string</span> == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span>
    ngx.exec(<span class="hljs-string">"/"</span>) <span class="hljs-comment">--   ,   </span>
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-built_in">path</span> = <span class="hljs-string">"/?string="</span> .. <span class="hljs-built_in">string</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> redis = <span class="hljs-built_in">require</span> <span class="hljs-string">"resty.redis"</span> <span class="hljs-comment">--      redis</span>
<span class="hljs-keyword">local</span> red = redis:new()<font></font>
<font></font>
red:set_timeout(<span class="hljs-number">1000</span>) <span class="hljs-comment">-- 1 sec</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> ok, err = red:connect(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6379</span>)
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span>
    ngx.exec(<span class="hljs-built_in">path</span>) <span class="hljs-comment">--     redis,   </span>
<span class="hljs-keyword">end</span><font></font>
<font></font>
res, err = red:get(<span class="hljs-string">"search:"</span> .. <span class="hljs-built_in">string</span>); <span class="hljs-comment">--    redis</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> res == ngx.null <span class="hljs-keyword">then</span>
    ngx.exec(<span class="hljs-built_in">path</span>) <span class="hljs-comment">--   ,   </span>
<span class="hljs-keyword">else</span>
    ngx.header.content_type = <span class="hljs-string">'application/json'</span>
    ngx.say(res) <span class="hljs-comment">--   ,   </span>
<span class="hljs-keyword">end</span></code></pre><br>
<pre><code class="nginx hljs"><span class="hljs-comment"># nginx.conf</span>
<span class="hljs-attribute">location</span> /search-by-string {
   <span class="hljs-attribute">content_by_lua_file</span> lua/search.lua;<font></font>
}</code></pre><br>
</div>
                    </div><br>
<h4><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/post/326486</font></font></a></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼</font></font></b>
                        <div class="spoiler_text"><blockquote>  http {}  lua.<br>
<br>
  :<br>
<br>
<pre><code class="lua hljs">#     *.lua     <font></font>
lua_package_path <span class="hljs-string">"/usr/local/lib/lua/?.lua;;"</span>;<font></font>
init_by_lua_block {<font></font>
    <span class="hljs-comment">--   </span>
    <span class="hljs-comment">--  ,    </span>
    <span class="hljs-built_in">require</span> <span class="hljs-string">"resty.core"</span>
    <span class="hljs-built_in">collectgarbage</span>(<span class="hljs-string">"collect"</span>)  <span class="hljs-comment">-- just to collect any garbage</span>
}</code></pre><br>
  *_lua_block   lua-     .<br>
<br>
 ,      .<br>
<br>
  :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> test.domain.local;<font></font>
<font></font>
  <span class="hljs-attribute">location</span> / {
    <span class="hljs-comment">#   cookie "upid"    â€”    </span>
    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$cookie_upid</span> = <span class="hljs-string">""</span>) {
            <span class="hljs-comment">#    nginx-,     ID </span>
            <span class="hljs-attribute">set</span> <span class="hljs-variable">$upstream_id</span> <span class="hljs-string">''</span>;
            <span class="hljs-section">rewrite_by_lua_block</span> {<font></font>
                --          nginx-<font></font>
                math.randomseed(ngx.time())<font></font>
                --    ,     ( )<font></font>
                math.random(100)<font></font>
                <span class="hljs-attribute">local</span> num = math.random(<span class="hljs-number">100</span>)<font></font>
                --  ,       <span class="hljs-number">20</span>% / <span class="hljs-number">80</span>%<font></font>
                if num &gt; <span class="hljs-number">20</span> then<font></font>
                    ngx.var.upstream_id = <span class="hljs-number">1</span><font></font>
                    ngx.ctx.upid = ngx.var.upstream_id<font></font>
                else<font></font>
                    ngx.var.upstream_id = <span class="hljs-number">2</span><font></font>
                    ngx.ctx.upid = ngx.var.upstream_id<font></font>
                end<font></font>
                -- ID    nginx- <span class="hljs-string">"upstream_id"</span>   <span class="hljs-string">"upid"</span>  ngx.ctx  lua,          <font></font>
            }<font></font>
    <span class="hljs-comment">#    "upid"    ID</span>
    <span class="hljs-comment">#     ,         (  ),   </span>
    add_header Set-Cookie <span class="hljs-string">"upid=<span class="hljs-variable">$upstream_id</span>; Domain=<span class="hljs-variable">$host</span>; Path=/"</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">#       ,   ID  ngx.ctx.upid  </span>
    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$cookie_upid</span> != <span class="hljs-string">""</span>) {
        <span class="hljs-section">rewrite_by_lua_block</span> {<font></font>
            ngx.ctx.<span class="hljs-attribute">upid</span> = ngx.var.cookie_upid<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">#      upstream-</span><font></font>
    proxy_pass http://ab_test;<font></font>
  }<font></font>
}</code></pre><br>
 upstream,   lua    nginx.<br>
<br>
  :<br>
<br>
<pre><code class="lua hljs">upstream ab_test {<font></font>
  # ,  nginx  .    <font></font>
  server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8001</span>;<font></font>
<font></font>
    balancer_by_lua_block {<font></font>
        <span class="hljs-keyword">local</span> balancer = <span class="hljs-built_in">require</span> <span class="hljs-string">"ngx.balancer"</span><font></font>
<font></font>
        <span class="hljs-comment">--   </span>
        <span class="hljs-comment">-- port  ,     ID </span>
        <span class="hljs-keyword">local</span> host = <span class="hljs-string">"127.0.0.1"</span>
        <span class="hljs-keyword">local</span> port = <span class="hljs-number">8000</span> + ngx.ctx.upid<font></font>
<font></font>
        <span class="hljs-comment">--   upstream    </span>
        <span class="hljs-keyword">local</span> ok, err = balancer.set_current_peer(host, port)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span>
                ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">"failed to set the current peer: "</span>, err)
                <span class="hljs-keyword">return</span> ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">end</span>
        <span class="hljs-comment">--    ,  ,   ,     </span><font></font>
    }<font></font>
}</code></pre><br>
    ,      .<br>
<br>
  :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
  <span class="hljs-attribute">listen</span>        <span class="hljs-number">127.0.0.1:8001</span>;
  <span class="hljs-attribute">server_name</span>   test.domain.local;<font></font>
<font></font>
  <span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span>                /var/www/html;
    <span class="hljs-attribute">index</span>               index.html;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {
  <span class="hljs-attribute">listen</span>        <span class="hljs-number">127.0.0.1:8002</span>;
  <span class="hljs-attribute">server_name</span>   test.domain.local;<font></font>
<font></font>
  <span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span>                /var/www/html;
    <span class="hljs-attribute">index</span>               index2.html;<font></font>
  }<font></font>
}</code></pre><br>
  nginx-a       :<br>
<br>
<pre><code class="bash hljs">use of lua-resty-core with LuaJIT 2.0 is not recommended; use LuaJIT 2.1+ instead <span class="hljs-keyword">while</span> connecting to upstream</code></pre></blockquote></div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2Gisï¼ˆ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒã‚¹ãƒˆ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰</font></font></h4><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®éƒ¨åˆ†ã¯ã€åŒåƒšã®AotDã«ã‚ˆã£ã¦ç™ºæ˜ã•ã‚Œã€ä½œæˆã•ã‚Œã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">å†™çœŸã®ãƒªãƒã‚¸ãƒˆãƒªãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚µã‚¤ã‚ºå¤‰æ›´ãªã©ã®ã„ãã¤ã‹ã®æ“ä½œã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚</font><font style="vertical-align: inherit;">å†™çœŸã¯cephã«ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã¯Amazon S3ã®ã‚¢ãƒŠãƒ­ã‚°ã§ã™ã€‚</font><font style="vertical-align: inherit;">ImageMagickã¯ç”»åƒå‡¦ç†ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒªã‚µã‚¤ã‚¶ã«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Šã€å‡¦ç†ã•ã‚ŒãŸç”»åƒãŒãã“ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è§£æã—ã€ç”»åƒã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…è¦ã¨ã™ã‚‹è§£åƒåº¦ã‚’æ±ºå®šã—ã¦cephã«é€ä¿¡ã—ã€å‡¦ç†ã—ã¦ãã®å ´ã§è¡¨ç¤ºã—ã¾ã™ã€‚</font></font></blockquote> <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serve_image.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">require</span> <span class="hljs-string">"config"</span>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">return_not_found</span><span class="hljs-params">(msg)</span></span>
    ngx.<span class="hljs-built_in">status</span> = ngx.HTTP_NOT_FOUND
    <span class="hljs-keyword">if</span> msg <span class="hljs-keyword">then</span>
        ngx.header[<span class="hljs-string">"X-Message"</span>] = msg
    <span class="hljs-keyword">end</span>
    ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> name, size, ext = ngx.var.name, ngx.var.size, ngx.var.ext
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> size <span class="hljs-keyword">or</span> size == <span class="hljs-string">''</span> <span class="hljs-keyword">then</span><font></font>
    return_not_found()<font></font>
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_scales[size] <span class="hljs-keyword">then</span>
    return_not_found(<span class="hljs-string">'Unexpected image scale'</span>)
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> cache_dir =  static_storage_path .. <span class="hljs-string">'/'</span> .. ngx.var.first .. <span class="hljs-string">'/'</span> .. ngx.var.second .. <span class="hljs-string">'/'</span>
<span class="hljs-keyword">local</span> original_fname = cache_dir .. name .. ext
<span class="hljs-keyword">local</span> dest_fname = cache_dir .. name .. size .. ext<font></font>
<font></font>
<span class="hljs-comment">-- make sure the file exists</span>
<span class="hljs-keyword">local</span> file = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">open</span>(original_fname)
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file <span class="hljs-keyword">then</span>
    <span class="hljs-comment">-- download file contents from ceph</span><font></font>
    ngx.req.read_body()<font></font>
    <span class="hljs-keyword">local</span> data = ngx.location.capture(<span class="hljs-string">"/ceph_loader"</span>, {vars = { name = name .. ext }})
    <span class="hljs-keyword">if</span> data.<span class="hljs-built_in">status</span> == ngx.HTTP_OK <span class="hljs-keyword">and</span> data.body:<span class="hljs-built_in">len</span>()&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">os</span>.<span class="hljs-built_in">execute</span>( <span class="hljs-string">"mkdir -p "</span> .. cache_dir )
        <span class="hljs-keyword">local</span> original = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">open</span>(original_fname, <span class="hljs-string">"w"</span>)<font></font>
        original:<span class="hljs-built_in">write</span>(data.body)<font></font>
        original:<span class="hljs-built_in">close</span>()
    <span class="hljs-keyword">else</span>
        return_not_found(<span class="hljs-string">'Original returned '</span> .. data.<span class="hljs-built_in">status</span>)
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span><font></font>
                                                                                                                                                                                                                                 <font></font>
<span class="hljs-keyword">local</span> magick = <span class="hljs-built_in">require</span>(<span class="hljs-string">"imagick"</span>)                                                                                                                                                                                                 <font></font>
magick.thumb(original_fname, image_scales[size], dest_fname)                                                                                                                                                                     <font></font>
ngx.exec(<span class="hljs-string">"@after_resize"</span>)</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
imagic.luaãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¥ç¶šã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">LuaJITã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginx_partial_resizer.conf.template</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-comment"># Old images</span>
<span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(small|small_wide|medium|big|mobile|scaled|original|iphone_(preview|retina_preview|big|retina_big|small|retina_small))_</span> {
    <span class="hljs-attribute">rewrite</span> /([^/]+)$ /__CEPH_BUCKET__/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;
    <span class="hljs-attribute">proxy_pass</span> __UPSTREAM__;<font></font>
}<font></font>
<span class="hljs-comment"># Try get image from ceph, then from local cache, then from scaled by lua original</span>
<span class="hljs-comment"># If image test.png is original, when user wants test_30x30.png:</span>
<span class="hljs-comment"># 1) Try get it from ceph, if not exists</span>
<span class="hljs-comment"># 2) Try get it from /cache/t/es/test_30x30.ong, if not exists</span>
<span class="hljs-comment"># 3) Resize original test.png and put it in /cache/t/es/test_30x30.ong</span>
<span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(?&lt;name&gt;(?&lt;first&gt;.)(?&lt;second&gt;..)[^_]+)((?&lt;size&gt;_[^.]+)|)(?&lt;ext&gt;\.[a-zA-Z]*)$</span> {
    <span class="hljs-attribute">proxy_intercept_errors</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">rewrite</span> /([^/]+)$ /__CEPH_BUCKET__/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;
    <span class="hljs-attribute">proxy_pass</span> __UPSTREAM__;
    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> <span class="hljs-number">403</span> = <span class="hljs-variable">@local</span>;<font></font>
}<font></font>
<span class="hljs-comment"># Helper failover location for upper command cause you can't write</span>
<span class="hljs-comment"># try_files __UPSTREAM__ /cache/$uri @resizer =404;</span>
<span class="hljs-attribute">location</span> <span class="hljs-variable">@local</span> {
    <span class="hljs-attribute">try_files</span> /cache/<span class="hljs-variable">$first</span>/<span class="hljs-variable">$second</span>/<span class="hljs-variable">$name</span><span class="hljs-variable">$size</span><span class="hljs-variable">$ext</span> <span class="hljs-variable">@resize</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># If scaled file not found in local cache resize it with lua magic!</span>
<span class="hljs-attribute">location</span> <span class="hljs-variable">@resize</span> {
<span class="hljs-comment">#    lua_code_cache off;</span>
    <span class="hljs-attribute">content_by_lua_file</span> <span class="hljs-string">"__APP_DIR__/lua/serve_image.lua"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># serve scaled file, invoked in @resizer serve_image.lua</span>
<span class="hljs-attribute">location</span> <span class="hljs-variable">@after_resize</span> {
    <span class="hljs-attribute">try_files</span> /cache/<span class="hljs-variable">$first</span>/<span class="hljs-variable">$second</span>/<span class="hljs-variable">$name</span><span class="hljs-variable">$size</span><span class="hljs-variable">$ext</span> =<span class="hljs-number">404</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># used in @resizer serve_image.lua to download original image</span>
<span class="hljs-comment"># $name contains original image file name</span>
<span class="hljs-attribute">location</span> =/ceph_loader {<font></font>
    internal;<font></font>
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^(.+)$</span> /__CEPH_BUCKET__/<span class="hljs-variable">$name</span> <span class="hljs-literal">break</span>;
    <span class="hljs-attribute">proxy_set_header</span> Cache-Control <span class="hljs-literal">no</span>-cache;
    <span class="hljs-attribute">proxy_set_header</span> If-Modified-Since <span class="hljs-string">""</span>;
    <span class="hljs-attribute">proxy_set_header</span> If-None-Match <span class="hljs-string">""</span>;
    <span class="hljs-attribute">proxy_pass</span> __UPSTREAM__;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> =/favicon.ico {
    <span class="hljs-attribute">return</span> <span class="hljs-number">404</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> =/robots.txt {}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã€‚</font><font style="vertical-align: inherit;">ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œè¨¼ã€é¡§å®¢ã®è­˜åˆ¥ã€RPSåˆ¶å¾¡ã€ãŠã‚ˆã³ä¸è¦ãªäººã®ãŸã‚ã®éšœå£ã€‚</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">firewall.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">module</span>(..., <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>);
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ban</span><span class="hljs-params">(type, element)</span></span>
    CStorage.banPermanent:set(<span class="hljs-built_in">type</span> .. <span class="hljs-string">'__'</span> .. element, <span class="hljs-number">1</span>);<font></font>
    ngx.location.capture(<span class="hljs-string">'/postgres_ban'</span>, { [<span class="hljs-string">'vars'</span>] = { [<span class="hljs-string">'type'</span>] = <span class="hljs-built_in">type</span>, [<span class="hljs-string">'value'</span>] = element} });
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkBanned</span><span class="hljs-params">(apiKey)</span></span>
    <span class="hljs-comment">-- init search criteria</span>
    <span class="hljs-keyword">local</span> searchCriteria = {};<font></font>
    searchCriteria[<span class="hljs-string">'key'</span>] = apiKey;
    <span class="hljs-keyword">if</span> ngx.var.remote_addr <span class="hljs-keyword">then</span>
        searchCriteria[<span class="hljs-string">'ip'</span>] = ngx.var.remote_addr;
    <span class="hljs-keyword">end</span>;
    <span class="hljs-comment">-- search in ban lists</span>
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">type</span>, item <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(searchCriteria) <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">local</span> storageKey = <span class="hljs-built_in">type</span> .. <span class="hljs-string">'__'</span> .. item;
        <span class="hljs-keyword">if</span> CStorage.banPermanent:get(storageKey) <span class="hljs-keyword">then</span>
            ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
        <span class="hljs-keyword">elseif</span> CStorage.banTmp:get(storageKey) <span class="hljs-keyword">then</span>
            <span class="hljs-comment">-- calculate rps and check is our client still bad boy 8-)</span>
            <span class="hljs-keyword">local</span> rps = CStorage.RPS:incr(storageKey, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(rps) <span class="hljs-keyword">then</span>
                CStorage.RPS:set(storageKey, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<font></font>
                rps=<span class="hljs-number">1</span>;
            <span class="hljs-keyword">end</span>;
            <span class="hljs-keyword">if</span> rps <span class="hljs-keyword">then</span>
                <span class="hljs-keyword">if</span> rps &gt; <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_permanent_ban'</span>] <span class="hljs-keyword">then</span><font></font>
                    CStorage.RPS:delete(storageKey);<font></font>
                    ban(<span class="hljs-built_in">type</span>, item);<font></font>
                    ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
                <span class="hljs-keyword">elseif</span> <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_tmp_ban'</span>] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> rps == <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_tmp_ban'</span>] <span class="hljs-keyword">then</span>
                    <span class="hljs-keyword">local</span> attemptsCount = CStorage.banTmp:incr(storageKey, <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">if</span> attemptsCount &gt; <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'tmp_ban'</span>][<span class="hljs-string">'max_attempt_to_exceed_rps'</span>] <span class="hljs-keyword">then</span>
                        <span class="hljs-comment">-- permanent ban</span><font></font>
                        CStorage.banTmp:delete(storageKey);<font></font>
                        ban(<span class="hljs-built_in">type</span>, item);
                    <span class="hljs-keyword">end</span>;
                <span class="hljs-keyword">end</span>;
            <span class="hljs-keyword">end</span>;<font></font>
            ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkTemporaryBlocked</span><span class="hljs-params">(apiKey)</span></span>
    <span class="hljs-keyword">local</span> blockedData = CStorage.tmpBlockedDemoKeys:get(apiKey);
    <span class="hljs-keyword">if</span> blockedData <span class="hljs-keyword">then</span>
        <span class="hljs-comment">--storage.tmpBlockedDemoKeys:incr(apiKey, 1); -- think about it.</span>
        <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'tmpDemoBlocked'</span>);
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkRPS</span><span class="hljs-params">(apiKey)</span></span>
    <span class="hljs-keyword">local</span> rps = <span class="hljs-literal">nil</span>;
    <span class="hljs-comment">-- check rps for IP and ban it if it's needed</span>
    <span class="hljs-keyword">if</span> ngx.var.remote_addr <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> ip = <span class="hljs-string">'ip__'</span> .. <span class="hljs-built_in">tostring</span>(ngx.var.remote_addr);<font></font>
        rps = CStorage.RPS:incr(ip, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(rps) <span class="hljs-keyword">then</span>
            CStorage.RPS:set(ip, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<font></font>
            rps = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">if</span> rps &gt; <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_permanent_ban'</span>] <span class="hljs-keyword">then</span>
            ban(<span class="hljs-string">'ip'</span>, <span class="hljs-built_in">tostring</span>(ngx.var.remote_addr));<font></font>
            ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
        <span class="hljs-keyword">elseif</span> <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_tmp_ban'</span>] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> rps &gt; <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_tmp_ban'</span>] <span class="hljs-keyword">then</span>
            CStorage.banTmp:set(ip, <span class="hljs-number">1</span>, <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'tmp_ban'</span>][<span class="hljs-string">'time'</span>]);<font></font>
            ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-keyword">local</span> apiKey_key_storage = <span class="hljs-string">'key_'</span> .. apiKey[<span class="hljs-string">'key'</span>];
    <span class="hljs-comment">-- check rps for key</span>
    rps = CStorage.RPS:incr(apiKey_key_storage, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(rps) <span class="hljs-keyword">then</span>
        CStorage.RPS:set(apiKey_key_storage, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<font></font>
        rps = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'max_rps'</span>] <span class="hljs-keyword">and</span> rps &gt; <span class="hljs-built_in">tonumber</span>(apiKey[<span class="hljs-string">'max_rps'</span>]) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'mode'</span>] == <span class="hljs-string">'demo'</span> <span class="hljs-keyword">then</span>
            CApiKey.blockTemporary(apiKey[<span class="hljs-string">'key'</span>]);
            <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'tmpDemoBlocked'</span>);
        <span class="hljs-keyword">else</span>
            CApiKey.block(apiKey[<span class="hljs-string">'key'</span>]);
            <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'blocked'</span>);
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-comment">-- similar check requests per period (RPP) for key</span>
    <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'max_request_count_per_period'</span>] <span class="hljs-keyword">and</span> apiKey[<span class="hljs-string">'period_length'</span>] <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> rpp = CStorage.RPP:incr(apiKey_key_storage, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(rpp) <span class="hljs-keyword">then</span>
            CStorage.RPP:set(apiKey_key_storage, <span class="hljs-number">1</span>, <span class="hljs-built_in">tonumber</span>(apiKey[<span class="hljs-string">'period_length'</span>]));<font></font>
            rpp = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">end</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> rpp &gt; <span class="hljs-built_in">tonumber</span>(apiKey[<span class="hljs-string">'max_request_count_per_period'</span>]) <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'mode'</span>] == <span class="hljs-string">'demo'</span> <span class="hljs-keyword">then</span>
                CApiKey.blockTemporary(apiKey[<span class="hljs-string">'key'</span>]);
                <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'tmpDemoBlocked'</span>);
            <span class="hljs-keyword">else</span>
                CApiKey.block(apiKey[<span class="hljs-string">'key'</span>]);
                <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'blocked'</span>);
            <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">local</span> apiKey = ngx.ctx.REQUEST[<span class="hljs-string">'key'</span>];
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(apiKey) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'unauthorized'</span>);
    <span class="hljs-keyword">end</span>;<font></font>
    apiKey = <span class="hljs-built_in">tostring</span>(apiKey)
    <span class="hljs-comment">-- check permanent and temporary banned</span><font></font>
    checkBanned(apiKey);<font></font>
    <span class="hljs-comment">-- check api key</span><font></font>
    apiKey = CApiKey.getData(apiKey);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(apiKey) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'forbidden'</span>);
    <span class="hljs-keyword">end</span>;<font></font>
    apiKey = JSON:decode(apiKey);<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(apiKey[<span class="hljs-string">'is_active'</span>]) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'blocked'</span>);
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    apiKey[<span class="hljs-string">'key'</span>] = <span class="hljs-built_in">tostring</span>(apiKey[<span class="hljs-string">'key'</span>]);
    <span class="hljs-comment">-- check is key in tmp blocked list</span>
    <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'mode'</span>] == <span class="hljs-string">'demo'</span> <span class="hljs-keyword">then</span>
        checkTemporaryBlocked(apiKey[<span class="hljs-string">'key'</span>]);
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-comment">-- check requests count per second and per period</span><font></font>
    checkRPS(apiKey);<font></font>
    <span class="hljs-comment">-- set apiKey's json to global parameter; in index.lua we send it through nginx to php application</span>
    ngx.ctx.GLOBAL[<span class="hljs-string">'api_key'</span>] = JSON:encode(apiKey);
<span class="hljs-keyword">end</span>;</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validator.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">module</span>(..., <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>);<font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkApiVersion</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">local</span> apiVersion = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (ngx.ctx.REQUEST[<span class="hljs-string">'version'</span>]) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> nginx_request = <span class="hljs-built_in">tostring</span>(ngx.var.uri);
        <span class="hljs-keyword">local</span> version = nginx_request:<span class="hljs-built_in">sub</span>(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>);
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">tonumber</span>(version:<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)) <span class="hljs-keyword">and</span> <span class="hljs-built_in">tonumber</span>(version:<span class="hljs-built_in">sub</span>(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)) <span class="hljs-keyword">then</span><font></font>
            apiVersion = version;<font></font>
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'versionIsRequired'</span>);
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">else</span>
        apiVersion = ngx.ctx.REQUEST[<span class="hljs-string">'version'</span>];
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-keyword">local</span> isSupported = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> i, version <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'supported_api_version'</span>]) <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> apiVersion == version <span class="hljs-keyword">then</span>
            isSupported = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (isSupported) <span class="hljs-keyword">then</span>
        CApiException.throw(<span class="hljs-string">'unsupportedVersion'</span>);
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    ngx.ctx.GLOBAL[<span class="hljs-string">'api_version'</span>] = apiVersion;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkKey</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (ngx.ctx.REQUEST[<span class="hljs-string">'key'</span>]) <span class="hljs-keyword">then</span>
        CApiException.throw(<span class="hljs-string">'unauthorized'</span>);
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span><font></font>
    checkApiVersion();<font></font>
    checkKey();<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apikey.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">module</span> ( ..., <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span> )<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(ngx.ctx.GLOBAL[<span class="hljs-string">'CApiKey'</span>]) <span class="hljs-keyword">then</span>
        ngx.ctx.GLOBAL[<span class="hljs-string">'CApiKey'</span>] = {};
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">flush</span><span class="hljs-params">()</span></span><font></font>
    CStorage.apiKey:flush_all();<font></font>
    CStorage.apiKey:flush_expired();<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">local</span> dbError = <span class="hljs-literal">nil</span>;
    <span class="hljs-keyword">local</span> dbData = ngx.location.capture(<span class="hljs-string">'/postgres_get_keys'</span>);<font></font>
    dbData = dbData.body;<font></font>
    dbData, dbError = rdsParser.parse(dbData);<font></font>
    <span class="hljs-keyword">if</span> dbData ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> rows = dbData.resultset
        <span class="hljs-keyword">if</span> rows <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">for</span> i, row <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(rows) <span class="hljs-keyword">do</span>
                <span class="hljs-keyword">local</span> cacheKeyData = {};
                <span class="hljs-keyword">for</span> col, val <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(row) <span class="hljs-keyword">do</span>
                    <span class="hljs-keyword">if</span> val ~= rdsParser.null <span class="hljs-keyword">then</span><font></font>
                        cacheKeyData[col] = val;<font></font>
                    <span class="hljs-keyword">else</span>
                        cacheKeyData[col] = <span class="hljs-literal">nil</span>;
                    <span class="hljs-keyword">end</span>
                <span class="hljs-keyword">end</span>
                CStorage.apiKey:set(<span class="hljs-built_in">tostring</span>(cacheKeyData[<span class="hljs-string">'key'</span>]),JSON:encode(cacheKeyData));
            <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkNotEmpty</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(ngx.ctx.GLOBAL[<span class="hljs-string">'CApiKey'</span>][<span class="hljs-string">'loaded'</span>]) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> cnt = CHelper.tablelength(CStorage.apiKey:get_keys(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">if</span> cnt == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">end</span>;<font></font>
        ngx.ctx.GLOBAL[<span class="hljs-string">'CApiKey'</span>][<span class="hljs-string">'loaded'</span>] = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getData</span><span class="hljs-params">(key)</span></span><font></font>
    checkNotEmpty();<font></font>
    <span class="hljs-keyword">return</span> CStorage.apiKey:get(key);
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStatus</span><span class="hljs-params">(key)</span></span><font></font>
        key = getData(key);<font></font>
        <span class="hljs-keyword">local</span> result = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> key ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><font></font>
            key = JSON:decode(key);<font></font>
            <span class="hljs-keyword">if</span> key[<span class="hljs-string">'is_active'</span>] ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">and</span>  key[<span class="hljs-string">'is_active'</span>] == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span>
                result = <span class="hljs-string">'allowed'</span>;
            <span class="hljs-keyword">else</span>
                result = <span class="hljs-string">'blocked'</span>;
            <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">else</span>
            result = <span class="hljs-string">'forbidden'</span>;
        <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">return</span> result;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">blockTemporary</span><span class="hljs-params">(apiKey)</span></span>
    apiKey = <span class="hljs-built_in">tostring</span>(apiKey);
    <span class="hljs-keyword">local</span> isset = getData(apiKey);
    <span class="hljs-keyword">if</span> isset <span class="hljs-keyword">then</span>
        CStorage.tmpBlockedDemoKeys:set(apiKey, <span class="hljs-number">1</span>, <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'time_demo_apikey_block_tmp'</span>]);
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">block</span><span class="hljs-params">(apiKey)</span></span>
    apiKey = <span class="hljs-built_in">tostring</span>(apiKey);
    <span class="hljs-keyword">local</span> keyData = getData(apiKey);
    <span class="hljs-keyword">if</span> keyData <span class="hljs-keyword">then</span>
        ngx.location.capture(<span class="hljs-string">'/redis_get'</span>, { [<span class="hljs-string">'vars'</span>] = { [<span class="hljs-string">'key'</span>] = apiKey } });<font></font>
        keyData[<span class="hljs-string">'is_active'</span>] = <span class="hljs-literal">false</span>;<font></font>
        CStorage.apiKey:set(apiKey,JSON:encode(cacheKeyData));<font></font>
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">storages.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">module</span> ( ..., <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span> )<font></font>
<font></font>
apiKey = ngx.shared.apiKey;<font></font>
RPS = ngx.shared.RPS;<font></font>
RPP = ngx.shared.RPP;<font></font>
banPermanent = ngx.shared.banPermanent;<font></font>
banTmp = ngx.shared.banTmp;<font></font>
tmpBlockedDemoKeys = ngx.shared.tmpBlockedDemoKeys;</code></pre><br>
</div>
                    </div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒœãƒ¼ãƒŠã‚¹ï¼</font><font style="vertical-align: inherit;">Luaã‚’ã¾ã£ãŸãä½¿ç”¨ã—ãªã„ä¾‹ã€‚</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ§‹æˆã®ã¿ã€ãƒãƒ¼ãƒ‰ã‚³ã‚¢ã®ã¿</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒªã‚¿ãƒ¼ãƒ³ã§ãƒšãƒ¼ã‚¸ã‚’è¿”ã™</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {<font></font>
    ...<font></font>
    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">default_type</span> text/plain;
        <span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">"Your IP: <span class="hljs-variable">$remote_addr</span>\n"</span>;<font></font>
    }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¼·åˆ¶no-www</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> example.org;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> www.example.org;
    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> <span class="hljs-variable">$scheme</span>://example.org<span class="hljs-variable">$request_uri</span>;<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¼·åˆ¶https</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://<span class="hljs-variable">$host</span><span class="hljs-variable">$request_uri</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<font></font>
<font></font>
    <span class="hljs-comment"># let the browsers know that we only accept HTTPS</span>
    <span class="hljs-attribute">add_header</span> Strict-Transport-Security max-age=<span class="hljs-number">2592000</span>;<font></font>
<font></font>
    ...<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URIã®ç‰¹å®šã®ãƒ‘ã‚¹ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-attribute">location</span> /old-site {
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/old-site/(.*)</span> http://example.org/new-site/<span class="hljs-variable">$1</span> <span class="hljs-literal">permanent</span>;<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-attribute">open_file_cache</span> max=<span class="hljs-number">1000</span> inactive=<span class="hljs-number">20s</span>;
<span class="hljs-attribute">open_file_cache_valid</span> <span class="hljs-number">30s</span>;
<span class="hljs-attribute">open_file_cache_min_uses</span> <span class="hljs-number">2</span>;
<span class="hljs-attribute">open_file_cache_errors</span> <span class="hljs-literal">on</span>;</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§ã‚­ãƒ¼ãƒ—ã‚¢ãƒ©ã‚¤ãƒ–</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-attribute">upstream</span> backend {
    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8080</span>;
    <span class="hljs-attribute">keepalive</span> <span class="hljs-number">32</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {<font></font>
    ...<font></font>
    <span class="hljs-attribute">location</span> /api/ {
        <span class="hljs-attribute">proxy_pass</span> http://backend;
        <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;
        <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">""</span>;<font></font>
    }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ€å¾Œã«ã€Luaã®æœ‰ç„¡ã«ã‹ã‹ã‚ã‚‰ãšã€ã•ã¾ã–ã¾ãªç¨‹åº¦ã®è¤‡é›‘ã•ã®æ§‹æˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å¤§è¦æ¨¡ãªãƒªã‚¹ãƒˆ</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çµè«–</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nginxã®Luaå…¨èˆ¬ã€ç‰¹ã«OpenRestyã¯ã€phpã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«é«˜é€Ÿã§è»½é‡ã§ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚‰ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†é€Ÿåº¦ã¨å¾®èª¿æ•´æ©Ÿèƒ½ã‚’ç¶­æŒã—ãªãŒã‚‰ã€Nginxã®åŸºæœ¬æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ã€æŸ”è»Ÿæ€§ã‚’é«˜ã‚ã¾ã™ã€‚</font><font style="vertical-align: inherit;">OpenRestyã¯ã€è£½å“ã«è†¨å¤§ãªæ•°ã®ä¼æ¥­ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€è±Šå¯Œãªã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨å¼·åŠ›ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚µãƒãƒ¼ãƒˆã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">Luaã‚’è©¦ã™ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã»ã¨ã‚“ã©ç„¡åˆ¶é™ã§ã‚ã‚‹ãŸã‚ã€ã»ã¨ã‚“ã©ã®äºˆæœŸã—ãªã„å ´æ‰€ã§å½¹ç«‹ã¡ã¾ã™ã€‚</font><font style="vertical-align: inherit;">Lua-in-Nginxã‚’ã¾ã è©¦ã—ã¦ã„ãªã„å ´åˆã¯ã€ã“ã®ãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦ã•ã‚‰ã«å­¦ç¿’ã™ã‚‹æ™‚é–“ã§ã™ã€‚</font></font><br>
<br>
<hr><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åºƒå‘Šã¨ã—ã¦</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚µã‚¤ãƒˆã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™ã‹ï¼Ÿ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½“ç¤¾</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ã€æ¯æ—¥ã¾ãŸã¯1å›é™ã‚Šã®æ”¯æ‰•ã„ã§ä¿¡é ¼æ€§ã®é«˜ã„ã‚µãƒ¼ãƒãƒ¼ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚å„ã‚µãƒ¼ãƒãƒ¼ã¯500ãƒ¡ã‚¬ãƒ“ãƒƒãƒˆã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãƒãƒ£ãƒãƒ«ã«æ¥ç¶šã•ã‚Œã¦ãŠã‚Šã€DDoSæ”»æ’ƒã‹ã‚‰è§£æ”¾ã•ã‚Œã¦ã„ã¾ã™ã€‚</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja504290/index.html">é–‹ç™ºè€…å‘ã‘ã®CIã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ã®è² è·ãƒ†ã‚¹ãƒˆ</a></li>
<li><a href="../ja504296/index.html">Pythonã§ã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ–ãƒ©ãƒ³ãƒã®ç”Ÿæˆ</a></li>
<li><a href="../ja504300/index.html">IBM iï¼ˆåˆ¥åAS / 400ï¼‰ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºã«ã¤ã„ã¦</a></li>
<li><a href="../ja504304/index.html">Samurai Pathï¼šã‚µãƒ¼ãƒ–ãƒ¬ãƒƒãƒˆã‹ã‚‰ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¸</a></li>
<li><a href="../ja504306/index.html">Elbrusã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸Aerodisk Vostokç”¨ã«ãƒ­ã‚·ã‚¢ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¯ã©ã®ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã‹</a></li>
<li><a href="../ja504310/index.html">ãƒ‡ãƒ¼ã‚¿ã®äºŒåˆ†æ³•ï¼šãƒ‡ãƒ¼ã‚¿ã¨ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é–¢ä¿‚ã‚’å†è€ƒã™ã‚‹</a></li>
<li><a href="../ja504312/index.html">ãƒ­ã‚·ã‚¢ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨GPLã®çµ±ä¸€ç™»éŒ²ã€‚ç§ã®5ã‚»ãƒ³ãƒˆ</a></li>
<li><a href="../ja504314/index.html">HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä»‹ã—ãŸDockerã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãªã—ã®Docker PullãŠã‚ˆã³Docker Pushã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…</a></li>
<li><a href="../ja504318/index.html">åˆå¿ƒè€…å‘ã‘ã«ç„¡æ–™ã®åå¾©é–‹ç™ºãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã‚’å®Ÿæ–½ã—ã¾ã™</a></li>
<li><a href="../ja504320/index.html">Linuxç”¨PVS-Studio Cï¼ƒã‚’ä½¿ç”¨ã—ãŸå˜ä¸€è¡Œã‚³ãƒ¼ãƒ‰ã¾ãŸã¯Nethermindæ¤œè¨¼</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>