<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🤝‍👨🏻 😻 👞 Nginxで直接プログラミング 🙇🏻 🧜🏾 🙍🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nginxは優れたWebサーバーです。さまざまなプログラミング言語のバックエンドと組み合わせて使用​​することに慣れています。しかし、Nginx構成ファイル内で簡単なプログラムを作成できることがわかりました。これを使用して、バランスを取り、シンプルなAPIを記述し、構成から直接動的ページを提供するこ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nginxで直接プログラミング</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/504308/"><img src="https://habrastorage.org/webt/3d/1p/2x/3d1p2x0yrvkljpmvhyvrgjzlsre.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nginxは優れたWebサーバーです。さまざまなプログラミング言語のバックエンドと組み合わせて使用​​することに慣れています。しかし、Nginx構成ファイル内で簡単なプログラムを作成できることがわかりました。これを使用して、バランスを取り、シンプルなAPIを記述し、構成から直接動的ページを提供することもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、nginx構成で簡単なプログラムを記述する例を分析します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
見た目はワイルドですが便利な構成でコードを書くように見えます。</font><font style="vertical-align: inherit;">コードは非同期で実行され、コールバックなしでメインのNginxイベントループに干渉しません。</font><font style="vertical-align: inherit;">他のモジュールやすべての基本機能との互換性があり、重要なのは迅速に機能することです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lua + Nginxの主なソリューションは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">Luaにネイティブであり、Nginxから統合された、多くの既製のモジュールがあります。</font><font style="vertical-align: inherit;">Nginxの高いパフォーマンスとスループットを維持しながら、非常に適切にスケーリングします。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取り付け</font></font></h2><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルア</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
純粋なLuaのサポートはnginx-extrasパッケージで提供されます</font></font><br>
<pre><code class="bash hljs">apt-get install nginx<font></font>
apt-get install nginx-extras</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ss </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ナイスデー</font></font></a> <br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openrestest</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、Nginx自体をインストールする必要はありません。OpenRestyはそれをアセンブリに含めます。</font><font style="vertical-align: inherit;">Nginxがすでにインストールされている場合は、インストールする前に切断して停止する必要があります</font></font><br>
<pre><code class="bash hljs">sudo systemctl <span class="hljs-built_in">disable</span> nginx<font></font>
sudo systemctl stop nginx</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後</font></font><br>
<pre><code class="bash hljs">sudo apt-get -y install --no-install-recommends wget gnupg ca-certificates<font></font>
wget -O - https://openresty.org/package/pubkey.gpg | sudo apt-key add -<font></font>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"deb http://openresty.org/package/ubuntu <span class="hljs-subst">$(lsb_release -sc)</span> main"</span> \<font></font>
    | sudo tee /etc/apt/sources.list.d/openresty.list<font></font>
sudo apt-get update<font></font>
sudo apt-get -y install openresty</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、OpenRestyを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo /usr/<span class="hljs-built_in">local</span>/openresty/bin/openresty</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力はなく、サーバーは単に起動して使用可能になります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/41/au/x1/41aux1dma6mbdyuzlwx85rgwt7q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
停止：</font></font><br>
<br>
<pre><code class="bash hljs">sudo /usr/<span class="hljs-built_in">local</span>/openresty/bin/openresty -s quit</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは世界</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、サイトのディレクトリと構成を作成します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /usr/<span class="hljs-built_in">local</span>/openresty/nginx/sites<font></font>
sudo nano /usr/<span class="hljs-built_in">local</span>/openresty/nginx/sites/default.conf</code></pre><br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;
    <span class="hljs-attribute">listen</span> [::]:<span class="hljs-number">80</span> default_server;<font></font>
<font></font>
    <span class="hljs-attribute">root</span> /usr/local/openresty/nginx/html/default;<font></font>
<font></font>
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
<font></font>
    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;<font></font>
<font></font>
        <span class="hljs-attribute">content_by_lua_file</span> /usr/local/openresty/nginx/html/default/index.lua;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトは設定で直接実行できますが、外部ファイルをすぐに接続する方が便利です</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /usr/<span class="hljs-built_in">local</span>/openresty/nginx/html/default/index.lua</code></pre><br>
<pre><code class="lua hljs"><span class="hljs-keyword">local</span> name = ngx.var.arg_name <span class="hljs-keyword">or</span> <span class="hljs-string">"Anonymous"</span>
ngx.say(<span class="hljs-string">"Hello, "</span>, name, <span class="hljs-string">"!"</span>)</code></pre><br>
<pre><code class="bash hljs">sudo mkdir /usr/<span class="hljs-built_in">local</span>/openresty/nginx/html/default<font></font>
sudo mv /usr/<span class="hljs-built_in">local</span>/openresty/nginx/html/index.html /usr/<span class="hljs-built_in">local</span>/openresty/nginx/html/default</code></pre><br>
<img src="https://habrastorage.org/webt/ta/sa/b5/tasab5st0iygmkleek2z8morluo.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、さまざまなソースからのより実用的な例です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ruhighload.com</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTML出力</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {
  <span class="hljs-attribute">location</span> /hello {
    <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/html'</span>;<font></font>
<font></font>
    <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'
        ngx.say("Hello &lt;b&gt;world&lt;/b&gt;!")
    '</span>;<font></font>
  }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のハンドラー</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {
  <span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;
    <span class="hljs-attribute">content_by_lua_file</span> /var/www/lua/index.lua;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-attribute">location</span> /admin {
    <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;
    <span class="hljs-attribute">content_by_lua_file</span> /var/www/lua/admin.lua;<font></font>
  }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバル変数</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">http</span> {
    <span class="hljs-comment">#   </span>
    <span class="hljs-attribute">lua_shared_dict</span> stats <span class="hljs-number">1m</span>;<font></font>
<font></font>
    <span class="hljs-section">server</span> {
        <span class="hljs-attribute">location</span> / {
            <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'
		#   hits  1   
                ngx.shared.stats:incr("hits", 1)
		
		#   
                ngx.say(ngx.shared.stats:get("hits"))
            '</span>;<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redisのリクエスト数をカウントするスクリプト</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">apt-get install lua-nginx-redis</code></pre><br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
        <span class="hljs-attribute">location</span> / {
            <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'
		local redis = require "nginx.redis"
		local red = redis:new()
		local ok, err = red:connect("127.0.0.1", 6379)
		ok, err = red:incr("test")
		local res, err = red:get("test")
		ngx.say("hits: ", res)
            '</span>;<font></font>
        }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openresty.org</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URIに基づいてMySQLクエリをルーティングすると</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">、OpenRestyユーザー調査</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">コードの</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redis </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webアプリと</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openresty.orgサイトのデータに</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">基づいて動的リクエストルーティング</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が発生します</font></a><font style="vertical-align: inherit;"> -特定のWebテクノロジー専用のWebサイトはそれを使用し、openresty.orgも例外ではありません</font></font><br>
<br>
<h4><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/post/270463</font></font></a></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリキャッシュ検索</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-comment">-- search.lua</span>
<span class="hljs-keyword">local</span> <span class="hljs-built_in">string</span> = ngx.var.arg_string  <span class="hljs-comment">--    GET </span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">string</span> == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span>
    ngx.exec(<span class="hljs-string">"/"</span>) <span class="hljs-comment">--   ,   </span>
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-built_in">path</span> = <span class="hljs-string">"/?string="</span> .. <span class="hljs-built_in">string</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> redis = <span class="hljs-built_in">require</span> <span class="hljs-string">"resty.redis"</span> <span class="hljs-comment">--      redis</span>
<span class="hljs-keyword">local</span> red = redis:new()<font></font>
<font></font>
red:set_timeout(<span class="hljs-number">1000</span>) <span class="hljs-comment">-- 1 sec</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> ok, err = red:connect(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6379</span>)
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span>
    ngx.exec(<span class="hljs-built_in">path</span>) <span class="hljs-comment">--     redis,   </span>
<span class="hljs-keyword">end</span><font></font>
<font></font>
res, err = red:get(<span class="hljs-string">"search:"</span> .. <span class="hljs-built_in">string</span>); <span class="hljs-comment">--    redis</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> res == ngx.null <span class="hljs-keyword">then</span>
    ngx.exec(<span class="hljs-built_in">path</span>) <span class="hljs-comment">--   ,   </span>
<span class="hljs-keyword">else</span>
    ngx.header.content_type = <span class="hljs-string">'application/json'</span>
    ngx.say(res) <span class="hljs-comment">--   ,   </span>
<span class="hljs-keyword">end</span></code></pre><br>
<pre><code class="nginx hljs"><span class="hljs-comment"># nginx.conf</span>
<span class="hljs-attribute">location</span> /search-by-string {
   <span class="hljs-attribute">content_by_lua_file</span> lua/search.lua;<font></font>
}</code></pre><br>
</div>
                    </div><br>
<h4><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/post/326486</font></font></a></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロードバランサー</font></font></b>
                        <div class="spoiler_text"><blockquote>  http {}  lua.<br>
<br>
  :<br>
<br>
<pre><code class="lua hljs">#     *.lua     <font></font>
lua_package_path <span class="hljs-string">"/usr/local/lib/lua/?.lua;;"</span>;<font></font>
init_by_lua_block {<font></font>
    <span class="hljs-comment">--   </span>
    <span class="hljs-comment">--  ,    </span>
    <span class="hljs-built_in">require</span> <span class="hljs-string">"resty.core"</span>
    <span class="hljs-built_in">collectgarbage</span>(<span class="hljs-string">"collect"</span>)  <span class="hljs-comment">-- just to collect any garbage</span>
}</code></pre><br>
  *_lua_block   lua-     .<br>
<br>
 ,      .<br>
<br>
  :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> test.domain.local;<font></font>
<font></font>
  <span class="hljs-attribute">location</span> / {
    <span class="hljs-comment">#   cookie "upid"    —    </span>
    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$cookie_upid</span> = <span class="hljs-string">""</span>) {
            <span class="hljs-comment">#    nginx-,     ID </span>
            <span class="hljs-attribute">set</span> <span class="hljs-variable">$upstream_id</span> <span class="hljs-string">''</span>;
            <span class="hljs-section">rewrite_by_lua_block</span> {<font></font>
                --          nginx-<font></font>
                math.randomseed(ngx.time())<font></font>
                --    ,     ( )<font></font>
                math.random(100)<font></font>
                <span class="hljs-attribute">local</span> num = math.random(<span class="hljs-number">100</span>)<font></font>
                --  ,       <span class="hljs-number">20</span>% / <span class="hljs-number">80</span>%<font></font>
                if num &gt; <span class="hljs-number">20</span> then<font></font>
                    ngx.var.upstream_id = <span class="hljs-number">1</span><font></font>
                    ngx.ctx.upid = ngx.var.upstream_id<font></font>
                else<font></font>
                    ngx.var.upstream_id = <span class="hljs-number">2</span><font></font>
                    ngx.ctx.upid = ngx.var.upstream_id<font></font>
                end<font></font>
                -- ID    nginx- <span class="hljs-string">"upstream_id"</span>   <span class="hljs-string">"upid"</span>  ngx.ctx  lua,          <font></font>
            }<font></font>
    <span class="hljs-comment">#    "upid"    ID</span>
    <span class="hljs-comment">#     ,         (  ),   </span>
    add_header Set-Cookie <span class="hljs-string">"upid=<span class="hljs-variable">$upstream_id</span>; Domain=<span class="hljs-variable">$host</span>; Path=/"</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">#       ,   ID  ngx.ctx.upid  </span>
    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$cookie_upid</span> != <span class="hljs-string">""</span>) {
        <span class="hljs-section">rewrite_by_lua_block</span> {<font></font>
            ngx.ctx.<span class="hljs-attribute">upid</span> = ngx.var.cookie_upid<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">#      upstream-</span><font></font>
    proxy_pass http://ab_test;<font></font>
  }<font></font>
}</code></pre><br>
 upstream,   lua    nginx.<br>
<br>
  :<br>
<br>
<pre><code class="lua hljs">upstream ab_test {<font></font>
  # ,  nginx  .    <font></font>
  server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8001</span>;<font></font>
<font></font>
    balancer_by_lua_block {<font></font>
        <span class="hljs-keyword">local</span> balancer = <span class="hljs-built_in">require</span> <span class="hljs-string">"ngx.balancer"</span><font></font>
<font></font>
        <span class="hljs-comment">--   </span>
        <span class="hljs-comment">-- port  ,     ID </span>
        <span class="hljs-keyword">local</span> host = <span class="hljs-string">"127.0.0.1"</span>
        <span class="hljs-keyword">local</span> port = <span class="hljs-number">8000</span> + ngx.ctx.upid<font></font>
<font></font>
        <span class="hljs-comment">--   upstream    </span>
        <span class="hljs-keyword">local</span> ok, err = balancer.set_current_peer(host, port)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span>
                ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">"failed to set the current peer: "</span>, err)
                <span class="hljs-keyword">return</span> ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">end</span>
        <span class="hljs-comment">--    ,  ,   ,     </span><font></font>
    }<font></font>
}</code></pre><br>
    ,      .<br>
<br>
  :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
  <span class="hljs-attribute">listen</span>        <span class="hljs-number">127.0.0.1:8001</span>;
  <span class="hljs-attribute">server_name</span>   test.domain.local;<font></font>
<font></font>
  <span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span>                /var/www/html;
    <span class="hljs-attribute">index</span>               index.html;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {
  <span class="hljs-attribute">listen</span>        <span class="hljs-number">127.0.0.1:8002</span>;
  <span class="hljs-attribute">server_name</span>   test.domain.local;<font></font>
<font></font>
  <span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span>                /var/www/html;
    <span class="hljs-attribute">index</span>               index2.html;<font></font>
  }<font></font>
}</code></pre><br>
  nginx-a       :<br>
<br>
<pre><code class="bash hljs">use of lua-resty-core with LuaJIT 2.0 is not recommended; use LuaJIT 2.1+ instead <span class="hljs-keyword">while</span> connecting to upstream</code></pre></blockquote></div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2Gis（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポスト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></h4><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この部分は、同僚のAotDによって発明され、作成されました。</font><font style="vertical-align: inherit;">写真のリポジトリがあります。</font><font style="vertical-align: inherit;">これらはユーザーに表示する必要があり、サイズ変更などのいくつかの操作を同時に実行することが望ましいです。</font><font style="vertical-align: inherit;">写真はcephに保存します。これはAmazon S3のアナログです。</font><font style="vertical-align: inherit;">ImageMagickは画像処理に使用されます。</font><font style="vertical-align: inherit;">リサイザにはキャッシュディレクトリがあり、処理された画像がそこに追加されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーのリクエストを解析し、画像とユーザーが必要とする解像度を決定してcephに送信し、処理してその場で表示します。</font></font></blockquote> <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serve_image.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">require</span> <span class="hljs-string">"config"</span>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">return_not_found</span><span class="hljs-params">(msg)</span></span>
    ngx.<span class="hljs-built_in">status</span> = ngx.HTTP_NOT_FOUND
    <span class="hljs-keyword">if</span> msg <span class="hljs-keyword">then</span>
        ngx.header[<span class="hljs-string">"X-Message"</span>] = msg
    <span class="hljs-keyword">end</span>
    ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> name, size, ext = ngx.var.name, ngx.var.size, ngx.var.ext
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> size <span class="hljs-keyword">or</span> size == <span class="hljs-string">''</span> <span class="hljs-keyword">then</span><font></font>
    return_not_found()<font></font>
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_scales[size] <span class="hljs-keyword">then</span>
    return_not_found(<span class="hljs-string">'Unexpected image scale'</span>)
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-keyword">local</span> cache_dir =  static_storage_path .. <span class="hljs-string">'/'</span> .. ngx.var.first .. <span class="hljs-string">'/'</span> .. ngx.var.second .. <span class="hljs-string">'/'</span>
<span class="hljs-keyword">local</span> original_fname = cache_dir .. name .. ext
<span class="hljs-keyword">local</span> dest_fname = cache_dir .. name .. size .. ext<font></font>
<font></font>
<span class="hljs-comment">-- make sure the file exists</span>
<span class="hljs-keyword">local</span> file = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">open</span>(original_fname)
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file <span class="hljs-keyword">then</span>
    <span class="hljs-comment">-- download file contents from ceph</span><font></font>
    ngx.req.read_body()<font></font>
    <span class="hljs-keyword">local</span> data = ngx.location.capture(<span class="hljs-string">"/ceph_loader"</span>, {vars = { name = name .. ext }})
    <span class="hljs-keyword">if</span> data.<span class="hljs-built_in">status</span> == ngx.HTTP_OK <span class="hljs-keyword">and</span> data.body:<span class="hljs-built_in">len</span>()&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">os</span>.<span class="hljs-built_in">execute</span>( <span class="hljs-string">"mkdir -p "</span> .. cache_dir )
        <span class="hljs-keyword">local</span> original = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">open</span>(original_fname, <span class="hljs-string">"w"</span>)<font></font>
        original:<span class="hljs-built_in">write</span>(data.body)<font></font>
        original:<span class="hljs-built_in">close</span>()
    <span class="hljs-keyword">else</span>
        return_not_found(<span class="hljs-string">'Original returned '</span> .. data.<span class="hljs-built_in">status</span>)
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span><font></font>
                                                                                                                                                                                                                                 <font></font>
<span class="hljs-keyword">local</span> magick = <span class="hljs-built_in">require</span>(<span class="hljs-string">"imagick"</span>)                                                                                                                                                                                                 <font></font>
magick.thumb(original_fname, image_scales[size], dest_fname)                                                                                                                                                                     <font></font>
ngx.exec(<span class="hljs-string">"@after_resize"</span>)</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
imagic.luaバインディングを接続します。</font><font style="vertical-align: inherit;">LuaJITにアクセスできる必要があります。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginx_partial_resizer.conf.template</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-comment"># Old images</span>
<span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(small|small_wide|medium|big|mobile|scaled|original|iphone_(preview|retina_preview|big|retina_big|small|retina_small))_</span> {
    <span class="hljs-attribute">rewrite</span> /([^/]+)$ /__CEPH_BUCKET__/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;
    <span class="hljs-attribute">proxy_pass</span> __UPSTREAM__;<font></font>
}<font></font>
<span class="hljs-comment"># Try get image from ceph, then from local cache, then from scaled by lua original</span>
<span class="hljs-comment"># If image test.png is original, when user wants test_30x30.png:</span>
<span class="hljs-comment"># 1) Try get it from ceph, if not exists</span>
<span class="hljs-comment"># 2) Try get it from /cache/t/es/test_30x30.ong, if not exists</span>
<span class="hljs-comment"># 3) Resize original test.png and put it in /cache/t/es/test_30x30.ong</span>
<span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/(?&lt;name&gt;(?&lt;first&gt;.)(?&lt;second&gt;..)[^_]+)((?&lt;size&gt;_[^.]+)|)(?&lt;ext&gt;\.[a-zA-Z]*)$</span> {
    <span class="hljs-attribute">proxy_intercept_errors</span> <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">rewrite</span> /([^/]+)$ /__CEPH_BUCKET__/<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;
    <span class="hljs-attribute">proxy_pass</span> __UPSTREAM__;
    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> <span class="hljs-number">403</span> = <span class="hljs-variable">@local</span>;<font></font>
}<font></font>
<span class="hljs-comment"># Helper failover location for upper command cause you can't write</span>
<span class="hljs-comment"># try_files __UPSTREAM__ /cache/$uri @resizer =404;</span>
<span class="hljs-attribute">location</span> <span class="hljs-variable">@local</span> {
    <span class="hljs-attribute">try_files</span> /cache/<span class="hljs-variable">$first</span>/<span class="hljs-variable">$second</span>/<span class="hljs-variable">$name</span><span class="hljs-variable">$size</span><span class="hljs-variable">$ext</span> <span class="hljs-variable">@resize</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># If scaled file not found in local cache resize it with lua magic!</span>
<span class="hljs-attribute">location</span> <span class="hljs-variable">@resize</span> {
<span class="hljs-comment">#    lua_code_cache off;</span>
    <span class="hljs-attribute">content_by_lua_file</span> <span class="hljs-string">"__APP_DIR__/lua/serve_image.lua"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># serve scaled file, invoked in @resizer serve_image.lua</span>
<span class="hljs-attribute">location</span> <span class="hljs-variable">@after_resize</span> {
    <span class="hljs-attribute">try_files</span> /cache/<span class="hljs-variable">$first</span>/<span class="hljs-variable">$second</span>/<span class="hljs-variable">$name</span><span class="hljs-variable">$size</span><span class="hljs-variable">$ext</span> =<span class="hljs-number">404</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"># used in @resizer serve_image.lua to download original image</span>
<span class="hljs-comment"># $name contains original image file name</span>
<span class="hljs-attribute">location</span> =/ceph_loader {<font></font>
    internal;<font></font>
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^(.+)$</span> /__CEPH_BUCKET__/<span class="hljs-variable">$name</span> <span class="hljs-literal">break</span>;
    <span class="hljs-attribute">proxy_set_header</span> Cache-Control <span class="hljs-literal">no</span>-cache;
    <span class="hljs-attribute">proxy_set_header</span> If-Modified-Since <span class="hljs-string">""</span>;
    <span class="hljs-attribute">proxy_set_header</span> If-None-Match <span class="hljs-string">""</span>;
    <span class="hljs-attribute">proxy_pass</span> __UPSTREAM__;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> =/favicon.ico {
    <span class="hljs-attribute">return</span> <span class="hljs-number">404</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> =/robots.txt {}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
APIのファイアウォール。</font><font style="vertical-align: inherit;">リクエストの検証、顧客の識別、RPS制御、および不要な人のための障壁。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">firewall.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">module</span>(..., <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>);
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ban</span><span class="hljs-params">(type, element)</span></span>
    CStorage.banPermanent:set(<span class="hljs-built_in">type</span> .. <span class="hljs-string">'__'</span> .. element, <span class="hljs-number">1</span>);<font></font>
    ngx.location.capture(<span class="hljs-string">'/postgres_ban'</span>, { [<span class="hljs-string">'vars'</span>] = { [<span class="hljs-string">'type'</span>] = <span class="hljs-built_in">type</span>, [<span class="hljs-string">'value'</span>] = element} });
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkBanned</span><span class="hljs-params">(apiKey)</span></span>
    <span class="hljs-comment">-- init search criteria</span>
    <span class="hljs-keyword">local</span> searchCriteria = {};<font></font>
    searchCriteria[<span class="hljs-string">'key'</span>] = apiKey;
    <span class="hljs-keyword">if</span> ngx.var.remote_addr <span class="hljs-keyword">then</span>
        searchCriteria[<span class="hljs-string">'ip'</span>] = ngx.var.remote_addr;
    <span class="hljs-keyword">end</span>;
    <span class="hljs-comment">-- search in ban lists</span>
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">type</span>, item <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(searchCriteria) <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">local</span> storageKey = <span class="hljs-built_in">type</span> .. <span class="hljs-string">'__'</span> .. item;
        <span class="hljs-keyword">if</span> CStorage.banPermanent:get(storageKey) <span class="hljs-keyword">then</span>
            ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
        <span class="hljs-keyword">elseif</span> CStorage.banTmp:get(storageKey) <span class="hljs-keyword">then</span>
            <span class="hljs-comment">-- calculate rps and check is our client still bad boy 8-)</span>
            <span class="hljs-keyword">local</span> rps = CStorage.RPS:incr(storageKey, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(rps) <span class="hljs-keyword">then</span>
                CStorage.RPS:set(storageKey, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<font></font>
                rps=<span class="hljs-number">1</span>;
            <span class="hljs-keyword">end</span>;
            <span class="hljs-keyword">if</span> rps <span class="hljs-keyword">then</span>
                <span class="hljs-keyword">if</span> rps &gt; <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_permanent_ban'</span>] <span class="hljs-keyword">then</span><font></font>
                    CStorage.RPS:delete(storageKey);<font></font>
                    ban(<span class="hljs-built_in">type</span>, item);<font></font>
                    ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
                <span class="hljs-keyword">elseif</span> <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_tmp_ban'</span>] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> rps == <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_tmp_ban'</span>] <span class="hljs-keyword">then</span>
                    <span class="hljs-keyword">local</span> attemptsCount = CStorage.banTmp:incr(storageKey, <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">if</span> attemptsCount &gt; <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'tmp_ban'</span>][<span class="hljs-string">'max_attempt_to_exceed_rps'</span>] <span class="hljs-keyword">then</span>
                        <span class="hljs-comment">-- permanent ban</span><font></font>
                        CStorage.banTmp:delete(storageKey);<font></font>
                        ban(<span class="hljs-built_in">type</span>, item);
                    <span class="hljs-keyword">end</span>;
                <span class="hljs-keyword">end</span>;
            <span class="hljs-keyword">end</span>;<font></font>
            ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkTemporaryBlocked</span><span class="hljs-params">(apiKey)</span></span>
    <span class="hljs-keyword">local</span> blockedData = CStorage.tmpBlockedDemoKeys:get(apiKey);
    <span class="hljs-keyword">if</span> blockedData <span class="hljs-keyword">then</span>
        <span class="hljs-comment">--storage.tmpBlockedDemoKeys:incr(apiKey, 1); -- think about it.</span>
        <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'tmpDemoBlocked'</span>);
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkRPS</span><span class="hljs-params">(apiKey)</span></span>
    <span class="hljs-keyword">local</span> rps = <span class="hljs-literal">nil</span>;
    <span class="hljs-comment">-- check rps for IP and ban it if it's needed</span>
    <span class="hljs-keyword">if</span> ngx.var.remote_addr <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> ip = <span class="hljs-string">'ip__'</span> .. <span class="hljs-built_in">tostring</span>(ngx.var.remote_addr);<font></font>
        rps = CStorage.RPS:incr(ip, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(rps) <span class="hljs-keyword">then</span>
            CStorage.RPS:set(ip, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<font></font>
            rps = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">if</span> rps &gt; <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_permanent_ban'</span>] <span class="hljs-keyword">then</span>
            ban(<span class="hljs-string">'ip'</span>, <span class="hljs-built_in">tostring</span>(ngx.var.remote_addr));<font></font>
            ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
        <span class="hljs-keyword">elseif</span> <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_tmp_ban'</span>] &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> rps &gt; <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'rps_for_ip_to_tmp_ban'</span>] <span class="hljs-keyword">then</span>
            CStorage.banTmp:set(ip, <span class="hljs-number">1</span>, <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'tmp_ban'</span>][<span class="hljs-string">'time'</span>]);<font></font>
            ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">444</span>);
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-keyword">local</span> apiKey_key_storage = <span class="hljs-string">'key_'</span> .. apiKey[<span class="hljs-string">'key'</span>];
    <span class="hljs-comment">-- check rps for key</span>
    rps = CStorage.RPS:incr(apiKey_key_storage, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(rps) <span class="hljs-keyword">then</span>
        CStorage.RPS:set(apiKey_key_storage, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<font></font>
        rps = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'max_rps'</span>] <span class="hljs-keyword">and</span> rps &gt; <span class="hljs-built_in">tonumber</span>(apiKey[<span class="hljs-string">'max_rps'</span>]) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'mode'</span>] == <span class="hljs-string">'demo'</span> <span class="hljs-keyword">then</span>
            CApiKey.blockTemporary(apiKey[<span class="hljs-string">'key'</span>]);
            <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'tmpDemoBlocked'</span>);
        <span class="hljs-keyword">else</span>
            CApiKey.block(apiKey[<span class="hljs-string">'key'</span>]);
            <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'blocked'</span>);
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-comment">-- similar check requests per period (RPP) for key</span>
    <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'max_request_count_per_period'</span>] <span class="hljs-keyword">and</span> apiKey[<span class="hljs-string">'period_length'</span>] <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> rpp = CStorage.RPP:incr(apiKey_key_storage, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(rpp) <span class="hljs-keyword">then</span>
            CStorage.RPP:set(apiKey_key_storage, <span class="hljs-number">1</span>, <span class="hljs-built_in">tonumber</span>(apiKey[<span class="hljs-string">'period_length'</span>]));<font></font>
            rpp = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">end</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> rpp &gt; <span class="hljs-built_in">tonumber</span>(apiKey[<span class="hljs-string">'max_request_count_per_period'</span>]) <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'mode'</span>] == <span class="hljs-string">'demo'</span> <span class="hljs-keyword">then</span>
                CApiKey.blockTemporary(apiKey[<span class="hljs-string">'key'</span>]);
                <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'tmpDemoBlocked'</span>);
            <span class="hljs-keyword">else</span>
                CApiKey.block(apiKey[<span class="hljs-string">'key'</span>]);
                <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'blocked'</span>);
            <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">local</span> apiKey = ngx.ctx.REQUEST[<span class="hljs-string">'key'</span>];
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(apiKey) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'unauthorized'</span>);
    <span class="hljs-keyword">end</span>;<font></font>
    apiKey = <span class="hljs-built_in">tostring</span>(apiKey)
    <span class="hljs-comment">-- check permanent and temporary banned</span><font></font>
    checkBanned(apiKey);<font></font>
    <span class="hljs-comment">-- check api key</span><font></font>
    apiKey = CApiKey.getData(apiKey);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(apiKey) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'forbidden'</span>);
    <span class="hljs-keyword">end</span>;<font></font>
    apiKey = JSON:decode(apiKey);<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(apiKey[<span class="hljs-string">'is_active'</span>]) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'blocked'</span>);
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    apiKey[<span class="hljs-string">'key'</span>] = <span class="hljs-built_in">tostring</span>(apiKey[<span class="hljs-string">'key'</span>]);
    <span class="hljs-comment">-- check is key in tmp blocked list</span>
    <span class="hljs-keyword">if</span> apiKey[<span class="hljs-string">'mode'</span>] == <span class="hljs-string">'demo'</span> <span class="hljs-keyword">then</span>
        checkTemporaryBlocked(apiKey[<span class="hljs-string">'key'</span>]);
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-comment">-- check requests count per second and per period</span><font></font>
    checkRPS(apiKey);<font></font>
    <span class="hljs-comment">-- set apiKey's json to global parameter; in index.lua we send it through nginx to php application</span>
    ngx.ctx.GLOBAL[<span class="hljs-string">'api_key'</span>] = JSON:encode(apiKey);
<span class="hljs-keyword">end</span>;</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validator.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">module</span>(..., <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span>);<font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkApiVersion</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">local</span> apiVersion = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (ngx.ctx.REQUEST[<span class="hljs-string">'version'</span>]) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> nginx_request = <span class="hljs-built_in">tostring</span>(ngx.var.uri);
        <span class="hljs-keyword">local</span> version = nginx_request:<span class="hljs-built_in">sub</span>(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>);
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">tonumber</span>(version:<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)) <span class="hljs-keyword">and</span> <span class="hljs-built_in">tonumber</span>(version:<span class="hljs-built_in">sub</span>(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>)) <span class="hljs-keyword">then</span><font></font>
            apiVersion = version;<font></font>
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> CApiException.throw(<span class="hljs-string">'versionIsRequired'</span>);
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">else</span>
        apiVersion = ngx.ctx.REQUEST[<span class="hljs-string">'version'</span>];
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-keyword">local</span> isSupported = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> i, version <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'supported_api_version'</span>]) <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> apiVersion == version <span class="hljs-keyword">then</span>
            isSupported = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (isSupported) <span class="hljs-keyword">then</span>
        CApiException.throw(<span class="hljs-string">'unsupportedVersion'</span>);
    <span class="hljs-keyword">end</span>;<font></font>
<font></font>
    ngx.ctx.GLOBAL[<span class="hljs-string">'api_version'</span>] = apiVersion;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkKey</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (ngx.ctx.REQUEST[<span class="hljs-string">'key'</span>]) <span class="hljs-keyword">then</span>
        CApiException.throw(<span class="hljs-string">'unauthorized'</span>);
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span><font></font>
    checkApiVersion();<font></font>
    checkKey();<font></font>
<span class="hljs-keyword">end</span>;</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apikey.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">module</span> ( ..., <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span> )<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(ngx.ctx.GLOBAL[<span class="hljs-string">'CApiKey'</span>]) <span class="hljs-keyword">then</span>
        ngx.ctx.GLOBAL[<span class="hljs-string">'CApiKey'</span>] = {};
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">flush</span><span class="hljs-params">()</span></span><font></font>
    CStorage.apiKey:flush_all();<font></font>
    CStorage.apiKey:flush_expired();<font></font>
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">local</span> dbError = <span class="hljs-literal">nil</span>;
    <span class="hljs-keyword">local</span> dbData = ngx.location.capture(<span class="hljs-string">'/postgres_get_keys'</span>);<font></font>
    dbData = dbData.body;<font></font>
    dbData, dbError = rdsParser.parse(dbData);<font></font>
    <span class="hljs-keyword">if</span> dbData ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> rows = dbData.resultset
        <span class="hljs-keyword">if</span> rows <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">for</span> i, row <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(rows) <span class="hljs-keyword">do</span>
                <span class="hljs-keyword">local</span> cacheKeyData = {};
                <span class="hljs-keyword">for</span> col, val <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(row) <span class="hljs-keyword">do</span>
                    <span class="hljs-keyword">if</span> val ~= rdsParser.null <span class="hljs-keyword">then</span><font></font>
                        cacheKeyData[col] = val;<font></font>
                    <span class="hljs-keyword">else</span>
                        cacheKeyData[col] = <span class="hljs-literal">nil</span>;
                    <span class="hljs-keyword">end</span>
                <span class="hljs-keyword">end</span>
                CStorage.apiKey:set(<span class="hljs-built_in">tostring</span>(cacheKeyData[<span class="hljs-string">'key'</span>]),JSON:encode(cacheKeyData));
            <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">end</span>;
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkNotEmpty</span><span class="hljs-params">()</span></span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span>(ngx.ctx.GLOBAL[<span class="hljs-string">'CApiKey'</span>][<span class="hljs-string">'loaded'</span>]) <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">local</span> cnt = CHelper.tablelength(CStorage.apiKey:get_keys(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">if</span> cnt == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">end</span>;<font></font>
        ngx.ctx.GLOBAL[<span class="hljs-string">'CApiKey'</span>][<span class="hljs-string">'loaded'</span>] = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getData</span><span class="hljs-params">(key)</span></span><font></font>
    checkNotEmpty();<font></font>
    <span class="hljs-keyword">return</span> CStorage.apiKey:get(key);
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStatus</span><span class="hljs-params">(key)</span></span><font></font>
        key = getData(key);<font></font>
        <span class="hljs-keyword">local</span> result = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> key ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><font></font>
            key = JSON:decode(key);<font></font>
            <span class="hljs-keyword">if</span> key[<span class="hljs-string">'is_active'</span>] ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">and</span>  key[<span class="hljs-string">'is_active'</span>] == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span>
                result = <span class="hljs-string">'allowed'</span>;
            <span class="hljs-keyword">else</span>
                result = <span class="hljs-string">'blocked'</span>;
            <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">else</span>
            result = <span class="hljs-string">'forbidden'</span>;
        <span class="hljs-keyword">end</span>;
        <span class="hljs-keyword">return</span> result;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">blockTemporary</span><span class="hljs-params">(apiKey)</span></span>
    apiKey = <span class="hljs-built_in">tostring</span>(apiKey);
    <span class="hljs-keyword">local</span> isset = getData(apiKey);
    <span class="hljs-keyword">if</span> isset <span class="hljs-keyword">then</span>
        CStorage.tmpBlockedDemoKeys:set(apiKey, <span class="hljs-number">1</span>, <span class="hljs-built_in">config</span>.app_params[<span class="hljs-string">'ban_params'</span>][<span class="hljs-string">'time_demo_apikey_block_tmp'</span>]);
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">block</span><span class="hljs-params">(apiKey)</span></span>
    apiKey = <span class="hljs-built_in">tostring</span>(apiKey);
    <span class="hljs-keyword">local</span> keyData = getData(apiKey);
    <span class="hljs-keyword">if</span> keyData <span class="hljs-keyword">then</span>
        ngx.location.capture(<span class="hljs-string">'/redis_get'</span>, { [<span class="hljs-string">'vars'</span>] = { [<span class="hljs-string">'key'</span>] = apiKey } });<font></font>
        keyData[<span class="hljs-string">'is_active'</span>] = <span class="hljs-literal">false</span>;<font></font>
        CStorage.apiKey:set(apiKey,JSON:encode(cacheKeyData));<font></font>
    <span class="hljs-keyword">end</span>;
<span class="hljs-keyword">end</span>;</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">storages.lua</font></font></b>
                        <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-built_in">module</span> ( ..., <span class="hljs-built_in">package</span>.<span class="hljs-built_in">seeall</span> )<font></font>
<font></font>
apiKey = ngx.shared.apiKey;<font></font>
RPS = ngx.shared.RPS;<font></font>
RPP = ngx.shared.RPP;<font></font>
banPermanent = ngx.shared.banPermanent;<font></font>
banTmp = ngx.shared.banTmp;<font></font>
tmpBlockedDemoKeys = ngx.shared.tmpBlockedDemoKeys;</code></pre><br>
</div>
                    </div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボーナス！</font><font style="vertical-align: inherit;">Luaをまったく使用しない例。</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成のみ、ハードコアのみ</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リターンでページを返す</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {<font></font>
    ...<font></font>
    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">default_type</span> text/plain;
        <span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">"Your IP: <span class="hljs-variable">$remote_addr</span>\n"</span>;<font></font>
    }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">強制no-www</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> example.org;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> www.example.org;
    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> <span class="hljs-variable">$scheme</span>://example.org<span class="hljs-variable">$request_uri</span>;<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">強制https</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> https://<span class="hljs-variable">$host</span><span class="hljs-variable">$request_uri</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<font></font>
<font></font>
    <span class="hljs-comment"># let the browsers know that we only accept HTTPS</span>
    <span class="hljs-attribute">add_header</span> Strict-Transport-Security max-age=<span class="hljs-number">2592000</span>;<font></font>
<font></font>
    ...<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URIの特定のパスにリダイレクトする</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-attribute">location</span> /old-site {
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/old-site/(.*)</span> http://example.org/new-site/<span class="hljs-variable">$1</span> <span class="hljs-literal">permanent</span>;<font></font>
}</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルキャッシュ</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-attribute">open_file_cache</span> max=<span class="hljs-number">1000</span> inactive=<span class="hljs-number">20s</span>;
<span class="hljs-attribute">open_file_cache_valid</span> <span class="hljs-number">30s</span>;
<span class="hljs-attribute">open_file_cache_min_uses</span> <span class="hljs-number">2</span>;
<span class="hljs-attribute">open_file_cache_errors</span> <span class="hljs-literal">on</span>;</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップストリームでキープアライブ</font></font></b>
                        <div class="spoiler_text"><pre><code class="nginx hljs"><span class="hljs-attribute">upstream</span> backend {
    <span class="hljs-attribute">server</span> <span class="hljs-number">127.0.0.1:8080</span>;
    <span class="hljs-attribute">keepalive</span> <span class="hljs-number">32</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-section">server</span> {<font></font>
    ...<font></font>
    <span class="hljs-attribute">location</span> /api/ {
        <span class="hljs-attribute">proxy_pass</span> http://backend;
        <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;
        <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">""</span>;<font></font>
    }<font></font>
}</code></pre><br>
</div>
                    </div><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後に、Luaの有無にかかわらず、さまざまな程度の複雑さの構成テンプレートの大規模なリスト</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NginxのLua全般、特にOpenRestyは、phpよりもはるかに高速で軽量です。</font><font style="vertical-align: inherit;">これらは、リクエストの処理速度と微調整機能を維持しながら、Nginxの基本機能を拡張し、柔軟性を高めます。</font><font style="vertical-align: inherit;">OpenRestyは、製品に膨大な数の企業を使用しており、豊富なエコシステムと強力なコミュニティサポートを提供しています。</font><font style="vertical-align: inherit;">Luaを試すためのフィールドはほとんど無制限であるため、ほとんどの予期しない場所で役立ちます。</font><font style="vertical-align: inherit;">Lua-in-Nginxをまだ試していない場合は、このトピックについてさらに学習する時間です。</font></font><br>
<br>
<hr><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">広告として</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サイトをホストするサーバーが必要ですか？</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当社</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、毎日または1回限りの支払いで信頼性の高いサーバーを提供しています。各サーバーは500メガビットのインターネットチャネルに接続されており、DDoS攻撃から解放されています。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja504290/index.html">開発者向けのCIサービスとしての負荷テスト</a></li>
<li><a href="../ja504296/index.html">Pythonでのランダムブランチの生成</a></li>
<li><a href="../ja504300/index.html">IBM i（別名AS / 400）のインタラクティブアプリケーションの開発について</a></li>
<li><a href="../ja504304/index.html">Samurai Path：サーブレットからリアクティブプログラミングへ</a></li>
<li><a href="../ja504306/index.html">ElbrusのストレージAerodisk Vostok用にロシアのハードウェアはどのように作られていますか</a></li>
<li><a href="../ja504310/index.html">データの二分法：データとサービスとの関係を再考する</a></li>
<li><a href="../ja504312/index.html">ロシアのプログラムとGPLの統一登録。私の5セント</a></li>
<li><a href="../ja504314/index.html">HTTPリクエストを介したDockerクライアントなしのDocker PullおよびDocker Pushコマンドの実装</a></li>
<li><a href="../ja504318/index.html">初心者向けに無料の反復開発ワークショップを実施します</a></li>
<li><a href="../ja504320/index.html">Linux用PVS-Studio C＃を使用した単一行コードまたはNethermind検証</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>