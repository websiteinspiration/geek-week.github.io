<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛶 ♉️ 🎛️ Lerne Englisch mit dem Telegramm-Bot 🎂 🧑🏿‍🤝‍🧑🏻 👨🏻‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nein, dies ist nicht einer von Hunderten Artikeln darüber, wie Sie Ihren ersten Hello World-Bot in Python schreiben. Hier finden Sie keine detailliert...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Lerne Englisch mit dem Telegramm-Bot</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488130/"><p><img src="https://habrastorage.org/webt/dt/zb/ck/dtzbcketnxqm5xtpa3vdbo5eul8.png" alt="Bild"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nein, dies ist nicht einer von Hunderten Artikeln darüber, wie Sie Ihren ersten Hello World-Bot in Python schreiben. </font><font style="vertical-align: inherit;">Hier finden Sie keine detaillierten Anweisungen zum Abrufen eines API-Tokens in BotFather oder zum Starten eines Bots in der Cloud. </font><font style="vertical-align: inherit;">Im Gegenzug werde ich Ihnen zeigen, wie Sie die volle Leistung von Python maximal entfalten können, um den ästhetischsten und schönsten Code zu erzielen. </font><font style="vertical-align: inherit;">Wir spielen ein Lied über die Anziehungskraft komplexer Strukturen - wir tanzen und tanzen. </font><font style="vertical-align: inherit;">Unter der Schnittasynchronität gibt es ein eigenes Speichersystem, eine Reihe nützlicher Dekorateure und viel schönen Code.</font></font></p><a name="habracut"></a><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haftungsausschluss:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Personen mit Gehirn-OOP und Anhänger der „richtigen“ Muster können diesen Artikel ignorieren.</font></font></p><br>
<h1 id="ideya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idee</font></font></h1><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um zu verstehen, wie es ist, in der modernen Gesellschaft kein Englisch zu sprechen, stellen Sie sich vor, Sie sind ein Adliger des 18. Jahrhunderts, der kein Französisch kann. </font><font style="vertical-align: inherit;">Auch wenn Sie sich in der Geschichte nicht sehr gut auskennen, können Sie sich vorstellen, wie schwer es wäre, unter solchen Umständen zu leben. </font><font style="vertical-align: inherit;">In der modernen Welt ist Englisch zu einer Notwendigkeit geworden, nicht zu einem Privileg, insbesondere wenn Sie in der IT-Branche tätig sind.</font></font></p><br>
<p>     :   ,   ,  ,        .         , , ,     ,     —  .</p><br>
<p>    ,     :</p><br>
<ul>
<li>     </li>
<li>  youtube-/,        </li>
<li>    </li>
<li> :         </li>
<li>  </li>
</ul><br>
<p>    ,        .   ,  ,         Telegram-.</p><br>
<blockquote>    ,       —        .  ,        .  ,    ,   .<br>
<br>
<em>«      ,     »</em></blockquote><br>
<h1 id="bazovaya-struktura"> </h1><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">python-telegram-bot</a> (ptb).      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">loguru</a>,      .   ,  ptb      ( logging)      . ,              ,     :</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> loguru <span class="hljs-keyword">import</span> logger
<span class="hljs-keyword">import</span> sys<font></font>
<font></font>
<span class="hljs-comment">#   :     </span><font></font>
config = {<font></font>
    <span class="hljs-string">'handlers'</span>: [<font></font>
        {<span class="hljs-string">'sink'</span>: sys.stdout, <span class="hljs-string">'level'</span>: <span class="hljs-string">'INFO'</span>},<font></font>
        {<span class="hljs-string">'sink'</span>: <span class="hljs-string">'logs.log'</span>, <span class="hljs-string">'serialize'</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">'level'</span>: <span class="hljs-string">'DEBUG'</span>},<font></font>
    ],<font></font>
}<font></font>
<font></font>
logger.configure(**config)<font></font>
<font></font>
<span class="hljs-comment"># ...</span><font></font>
<font></font>
updater = Updater(<span class="hljs-string">'YOUR_TOKEN'</span>)<font></font>
dp = updater.dispatcher<font></font>
<font></font>
<span class="hljs-comment">#    .   </span><font></font>
updater.logger = logger<font></font>
dp.logger = logger</code></pre><br>
<p> ,          -,    —  .        .         —  ,       .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> annotations <span class="hljs-comment">#       </span>
<span class="hljs-keyword">from</span> loguru <span class="hljs-keyword">import</span> logger<font></font>
<font></font>
<span class="hljs-keyword">import</span> inspect
<span class="hljs-keyword">import</span> functools
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">file_is_empty</span>(<span class="hljs-params">path: str</span>) -&gt; bool:</span>
    <span class="hljs-keyword">return</span> os.stat(path).st_size == <span class="hljs-number">0</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_file</span>(<span class="hljs-params">path: str</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
    <span class="hljs-keyword">with</span> open(path, <span class="hljs-string">'w'</span>): <span class="hljs-keyword">pass</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cache_decorator</span>(<span class="hljs-params">method</span>):</span>
<span class="hljs-meta">    @functools.wraps(method)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        res = method(self, *args, **kwargs)<font></font>
        Cache.link.recess(self, {<span class="hljs-string">'method_name'</span>: method.__name__}) <span class="hljs-comment"># (1)</span>
        <span class="hljs-comment">#       </span>
        <span class="hljs-comment">#  ; opt   </span>
        logger.opt(lazy=<span class="hljs-literal">True</span>).debug(<span class="hljs-string">f'Decorator for <span class="hljs-subst">{method.__name__}</span> was end'</span>)
        <span class="hljs-keyword">return</span> res
    <span class="hljs-keyword">return</span> wrapper<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span>:</span>
    <span class="hljs-string">"""
    + cache_size  - ,       
    + cache_files -  ,        
    """</span><font></font>
<font></font>
    link = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, cache_size=<span class="hljs-number">10</span></span>):</span>
        <span class="hljs-comment">#    .      </span><font></font>
        self._classes = []<font></font>
        <span class="hljs-comment"># ,  </span><font></font>
        self._cache_files = []<font></font>
        <span class="hljs-comment"># (1):  ,        </span>
        <span class="hljs-comment">#  ,         , </span>
        <span class="hljs-comment">#      .   ,    </span>
        <span class="hljs-comment">#     </span><font></font>
        self.__class__.link = self<font></font>
<font></font>
        self._counter = <span class="hljs-number">0</span><font></font>
        self.CACHE_SIZE = cache_size<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">self, cls: class, file: str</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""
            

        + cls  -  
        + file - ,    
        """</span><font></font>
<font></font>
        self._cache_files.append(file)<font></font>
        self._classes.append(cls)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> file_is_empty(file): <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><font></font>
<font></font>
        logger.opt(lazy=<span class="hljs-literal">True</span>).debug(<span class="hljs-string">f'For <span class="hljs-subst">{cls.__class__.__name__}</span> file <span class="hljs-subst">{file}</span> is not empty'</span>)<font></font>
<font></font>
        <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> self.load(file):<font></font>
            cls.save_non_caching(data)<font></font>
<font></font>
        clear_file(file)<font></font>
        self._counter = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recess</span>(<span class="hljs-params">self, cls: class, data: dict</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""
         ,     
        """</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> self._counter + <span class="hljs-number">1</span> &gt;= self.CACHE_SIZE:<font></font>
            self.save_all()<font></font>
        <span class="hljs-keyword">else</span>: <font></font>
            self._counter += <span class="hljs-number">1</span><font></font>
            filename = self._cache_files[self._classes.index(cls)]<font></font>
            self.save(data, filename=filename)<font></font>
<font></font>
    <span class="hljs-comment"># ...</span>
    <span class="hljs-comment">#    save_all, save, load </span>
    <span class="hljs-comment"># ... </span></code></pre><br>
<p>     ,    ,     :</p><br>
<pre><code class="python hljs"><span class="hljs-meta">@cache_decorator</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_smth_important</span>(<span class="hljs-params">*args, **kwargs</span>) -&gt; Any:</span>
    <span class="hljs-comment"># ...</span>
    <span class="hljs-comment">#  -    ...</span>
    <span class="hljs-comment"># ...</span></code></pre><br>
<p>,      ,   :     .     — EnglishBot,      : ptb,   ,  ,      - .    Telegram-  ,          . ,  ,        ,          .   /    ,       :</p><br>
<pre><code class="python hljs"><span class="hljs-comment">#   </span>
<span class="hljs-keyword">from</span> modules <span class="hljs-keyword">import</span> EnglishBot
<span class="hljs-comment">#  ,   Telegram-</span>
<span class="hljs-keyword">from</span> modules.module <span class="hljs-keyword">import</span> start
<span class="hljs-comment"># ...</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment">#  </span><font></font>
    tbot = EnglishBot(<font></font>
        <span class="hljs-comment"># ...</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-comment">#    </span>
    tbot.add_command_handler(start, <span class="hljs-string">'start'</span>)
    <span class="hljs-comment"># ...</span></code></pre><br>
<p>        ,   .</p><br>
<h1 id="vse-iz-nichego">  </h1><br>
<p> ptb     — update  context,       .  context    chat_data,         .           <code>context.chat_data['data']</code>.   -   ,  <code>context.data</code>. ,   .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> telegram.ext <span class="hljs-keyword">import</span> CommandHandler<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">a</span>(<span class="hljs-params">self, key: str</span>):</span>
    <span class="hljs-comment">#        </span>
    <span class="hljs-comment">#  ,      chat_data</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> object.__getattribute__(self, key)
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> self.chat_data[key]<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">b</span>(<span class="hljs-params">self, key: str, data=None, replace=True</span>):</span>
    <span class="hljs-comment">#  :  replace=False   ,    </span>
    <span class="hljs-comment">#  ,    ,     None</span>
    <span class="hljs-keyword">if</span> replace <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> self.chat_data.get(key, <span class="hljs-literal">None</span>):<font></font>
        self.chat_data[key] = data<font></font>
<font></font>
<span class="hljs-comment">#  context,      context.data</span><font></font>
CallbackContext.__getattribute__ = a<font></font>
<span class="hljs-comment">#       </span>
CallbackContext.set = b</code></pre><br>
<p>   .   ,            context.</p><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bind_context</span>(<span class="hljs-params">func</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">update, context</span>):</span>
        context._bot.bind_user_data(update, context) <span class="hljs-comment"># (2)</span>
        <span class="hljs-keyword">return</span> func(update, context)
    <span class="hljs-keyword">return</span> wrapper<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnglishBot</span>:</span>
    <span class="hljs-comment"># ...</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bind_user_data</span>(<span class="hljs-params">self, update, context</span>) -&gt; dict:</span>
        context.set(<span class="hljs-string">'t_id'</span>, update.message.chat_id, replace=<span class="hljs-literal">False</span>)<font></font>
        context.set(<span class="hljs-string">'t_ln'</span>, update.message.from_user.language_code, replace=<span class="hljs-literal">False</span>)
        <span class="hljs-comment"># ...</span>
        <span class="hljs-comment">#    ,        context</span>
        <span class="hljs-comment">#  -   </span>
        <span class="hljs-comment"># ...</span></code></pre><br>
<p>         context:</p><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnglishBot</span>:</span>
    <span class="hljs-comment"># ...</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        <span class="hljs-comment"># ...</span>
        <span class="hljs-comment"># (2):         context._bot</span>
        CallbackContext._bot = self</code></pre><br>
<p>             .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> EnglishBot <span class="hljs-keyword">import</span> bind_context<font></font>
<font></font>
<span class="hljs-meta">@bind_context</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">update, context</span>):</span>
    <span class="hljs-comment">#         </span>
    <span class="hljs-comment">#          </span>
    <span class="hljs-comment">#       </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> context._bot.user_exist(context.t_id):
        <span class="hljs-comment">#   -  </span>
        context.set(<span class="hljs-string">'push_notification'</span>, <span class="hljs-literal">True</span>)
        <span class="hljs-comment">#      </span><font></font>
        context._bot.new_user(context.t_id, context.t_ln)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> update.message.reply_text(<span class="hljs-string">' '</span>)    
    <span class="hljs-comment"># ...</span></code></pre><br>
<h1 id="dekoratory--nashe-vse"> —  </h1><br>
<p>   ,       ,      .           .</p><br>
<pre><code class="python hljs">
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnglishBot</span>:</span>
    <span class="hljs-comment"># ...</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_command_handler</span>(<span class="hljs-params">self, func: function, name=None</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">"""
        ,    
        """</span><font></font>
<font></font>
        name = name <span class="hljs-keyword">or</span> func.__name__<font></font>
        self.dp.add_handler(CommandHandler(name, func))<font></font>
<font></font>
<span class="hljs-comment"># ...</span><font></font>
<font></font>
<span class="hljs-comment">#   :</span>
tbot.add_command_handler(start) <span class="hljs-comment">#  tbot.add_command_handler(start, 'start')</span></code></pre><br>
<p>  ,    .     bind_context,       wrapper.   .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> functools<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">bind_context</span>(<span class="hljs-params">func</span>):</span>
    <span class="hljs-comment"># functools.wraps  stdlib     Python 3.4</span>
<span class="hljs-meta">    @functools.wraps(func)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">update, context</span>):</span><font></font>
        context._bot.bind_user_data(update, context)<font></font>
        <span class="hljs-keyword">return</span> func(update, context)
    <span class="hljs-keyword">return</span> wrapper</code></pre><br>
<p>     ,         .       .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> functools<font></font>
<font></font>
END = <span class="hljs-number">-1</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">zero_exiter</span>(<span class="hljs-params">func</span>):</span>
<span class="hljs-meta">    @functools.wraps(func)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">update, context</span>):</span>
        <span class="hljs-keyword">if</span> update.to_dict()[<span class="hljs-string">'message'</span>].get(<span class="hljs-string">'text'</span>, <span class="hljs-literal">None</span>) == <span class="hljs-string">'0'</span>:<font></font>
            update.message.reply_text(<span class="hljs-string">' - '</span>)            
            <span class="hljs-keyword">return</span> END <font></font>
<font></font>
        <span class="hljs-keyword">return</span> func(update, context)    
    <span class="hljs-keyword">return</span> wrapper<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">skip_edited</span>(<span class="hljs-params">func</span>):</span>
<span class="hljs-meta">    @functools.wraps(func)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrapper</span>(<span class="hljs-params">update, context</span>):</span>
        <span class="hljs-comment">#     ,   None, </span>
        <span class="hljs-comment">#   conversation_handler,     </span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> update.to_dict().get(<span class="hljs-string">'edited_message'</span>, <span class="hljs-literal">None</span>):
            <span class="hljs-keyword">return</span> func(update, context)
    <span class="hljs-keyword">return</span> wrapper</code></pre><br>
<p>        — <code>@run_async</code>,    .    .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> telegram.ext.dispatcher <span class="hljs-keyword">import</span> run_async
<span class="hljs-keyword">from</span> EnglishBot <span class="hljs-keyword">import</span> skip_edited<font></font>
<font></font>
<span class="hljs-meta">@run_async</span>
<span class="hljs-meta">@skip_edited</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">heavy_function</span>(<span class="hljs-params">update, context</span>):</span>
    <span class="hljs-comment"># ...</span>
    <span class="hljs-comment">#   ,    </span>
    <span class="hljs-comment">#     </span>
    <span class="hljs-comment"># ...</span></code></pre><br>
<p><em>,   —  ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.</em></p><br>
<p>  ,     . <code>@logger.catch</code>,     , ,        logger.</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> loguru <span class="hljs-keyword">import</span> logger<font></font>
<font></font>
<span class="hljs-meta">@logger.catch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">heavy_function2</span>(<span class="hljs-params">update, context</span>):</span>
    <span class="hljs-comment"># ...</span>
    <span class="hljs-comment">#     ,     </span>
    <span class="hljs-comment"># ...</span></code></pre><br>
<h1 id="admin-panel"> </h1><br>
<p>      /      .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> EnglishBot <span class="hljs-keyword">import</span> bind_context
<span class="hljs-keyword">from</span> Cache <span class="hljs-keyword">import</span> file_is_empty
<span class="hljs-keyword">from</span> telegram <span class="hljs-keyword">import</span> ReplyKeyboardMarkup
<span class="hljs-keyword">from</span> loguru <span class="hljs-keyword">import</span> logger<font></font>
<font></font>
LOG_FILE = <span class="hljs-string">'logs.log'</span>
SENDING, MAIN, END = range(<span class="hljs-number">1</span>, <span class="hljs-number">-2</span>, <span class="hljs-number">-1</span>)<font></font>
<font></font>
buttons = ReplyKeyboardMarkup(<font></font>
    [(<span class="hljs-string">' '</span>, <span class="hljs-string">'logs'</span>), (<span class="hljs-string">' '</span>, <span class="hljs-string">'clear'</span>)],<font></font>
    [(<span class="hljs-string">' '</span>, <span class="hljs-string">'send'</span>)],
    <span class="hljs-comment"># [...],</span><font></font>
)<font></font>
<font></font>
<span class="hljs-meta">@bind_context</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">admin_panel</span>(<span class="hljs-params">update, context</span>):</span>
    <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> context._bot.acess_check(context.t_id):
        <span class="hljs-comment">#      ,     </span>
        <span class="hljs-keyword">return</span> update.message.reply_text(<span class="hljs-string">f'  <span class="hljs-subst">{update.message.text}</span>'</span>)<font></font>
<font></font>
    update.message.reply_text(<span class="hljs-string">' :'</span>, reply_markup=buttons)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> MAIN<font></font>
<font></font>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Logs methods</span>
<span class="hljs-comment">#</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_logs</span>(<span class="hljs-params">update, context</span>):</span>
    <span class="hljs-keyword">if</span> file_is_empty(LOG_FILE):<font></font>
        update.callback_query.reply_text(<span class="hljs-string">' '</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment">#   </span>
        context.bot.send_chat_action(chat_id=context.t_id, action=<span class="hljs-string">'upload_document'</span>)<font></font>
        context.bot.sendDocument(chat_id=context.t_id, document=open(LOG_FILE, <span class="hljs-string">'rb'</span>), name=LOG_FILE, timeout=<span class="hljs-number">1000</span>)<font></font>
<font></font>
    <span class="hljs-comment">#     ,      </span>
    update.callback_query.answer(text=<span class="hljs-string">''</span>)
    <span class="hljs-comment">#  ,  .    , None    </span>
    <span class="hljs-comment">#      </span>
    <span class="hljs-keyword">return</span> MAIN<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">logs_clear</span>(<span class="hljs-params">update, context</span>):</span>
    <span class="hljs-keyword">with</span> open(LOG_FILE, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> file:<font></font>
        update.callback_query.reply_text(<span class="hljs-string">''</span>)<font></font>
        update.callback_query.answer(text=<span class="hljs-string">''</span>)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> MAIN<font></font>
<font></font>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Send methods</span>
<span class="hljs-comment">#</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">take_message</span>(<span class="hljs-params">update, context</span>):</span>
    update.callback_query.reply_text(<span class="hljs-string">' '</span>)<font></font>
    update.callback_query.answer(text=<span class="hljs-string">''</span>)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> SENDING<font></font>
<font></font>
<span class="hljs-meta">@zero_exiter</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_all</span>(<span class="hljs-params">update, context</span>):</span>
    count = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-comment">#     </span>
    <span class="hljs-keyword">for</span> id <span class="hljs-keyword">in</span> list(context._bot.get_user_ids()):
        <span class="hljs-comment">#   ,  -     </span>
        <span class="hljs-comment">#         </span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment">#     </span>
            <span class="hljs-keyword">if</span> id == context.t_id: <span class="hljs-keyword">continue</span>
            <span class="hljs-comment">#   Markdown,    </span>
            context.bot.send_message(context.t_id, text=update.message.text_markdown, parse_mode=<span class="hljs-string">'Markdown'</span>)<font></font>
            count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">pass</span><font></font>
<font></font>
    update.callback_query.reply_text(<span class="hljs-string">f' <span class="hljs-subst">{count}</span> '</span>)<font></font>
    update.callback_query.answer(text=<span class="hljs-string">''</span>)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> MAIN<font></font>
<font></font>
<span class="hljs-comment"># ...</span><font></font>
<font></font>
<span class="hljs-comment">#   :</span><font></font>
tbot.add_conversation_handler(<font></font>
    entry_points = [(<span class="hljs-string">'admin'</span>, admin)],
    <span class="hljs-comment">#   send_alk    ,     /</span>
    states = [[(logs, <span class="hljs-string">'^logs$'</span>), (logs_clear, <span class="hljs-string">'^clear$'</span>), (send, <span class="hljs-string">'^send$'</span>)], [(send_alk, <span class="hljs-string">'@^((?!.*((^\/)+)).*)(.+)$'</span>)]]<font></font>
)</code></pre><br>
<p> add_conversation_handler     :</p><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnglishBot</span>:</span>    
    <span class="hljs-comment"># ...</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_conversation_handler</span>(<span class="hljs-params">self, entry_points: list, states: list, fallbacks: list</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        fallbacks = [CommandHandler(name, func) <span class="hljs-keyword">for</span> name, func <span class="hljs-keyword">in</span> fallbacks]<font></font>
        entry_points = [CommandHandler(name, func) <span class="hljs-keyword">for</span> name, func <span class="hljs-keyword">in</span> entry_points]<font></font>
        r_states = {}<font></font>
<font></font>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(states)):<font></font>
            r_states[i] = []<font></font>
<font></font>
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">for</span> func, pattern <span class="hljs-keyword">in</span> states[i]:
                    <span class="hljs-comment">#      @,     </span>
                    <span class="hljs-comment">#  -    </span>
                    <span class="hljs-keyword">if</span> pattern[<span class="hljs-number">0</span>] == <span class="hljs-string">'@'</span>:<font></font>
                        r_states[i].append(MessageHandler(Filters.regex(pattern[<span class="hljs-number">1</span>:]), func))
                    <span class="hljs-keyword">else</span>:<font></font>
                        r_states[i].append(CallbackQueryHandler(func, pattern=pattern))<font></font>
<font></font>
        conv_handler = ConversationHandler(entry_points=entry_points, states=r_states, fallbacks=fallbacks)<font></font>
        dp.add_handler(conv_handler)</code></pre><br>
<h1 id="osnovnoy-funkcional"> </h1><br>
<p>         .</p><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> EnglishBot <span class="hljs-keyword">import</span> bind_context, skip_edited, zero_exiter
<span class="hljs-keyword">from</span> youtube_transcript_api <span class="hljs-keyword">import</span> YouTubeTranscriptApi
<span class="hljs-keyword">from</span> telegram.ext.dispatcher <span class="hljs-keyword">import</span> run_async<font></font>
<font></font>
START_OVER, ADDING, END = range(<span class="hljs-number">1</span>, <span class="hljs-number">-2</span>, <span class="hljs-number">-1</span>)<font></font>
<font></font>
re_youtube = re.compile(<span class="hljs-string">'^(http(s)?:\/\/)?((w){3}.)?youtu(be|.be)?(\.com)?\/.+'</span>)<font></font>
re_text = re.compile(<span class="hljs-string">'^[a-z]{3,20}$'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_youtube_link</span>(<span class="hljs-params">link: str</span>) -&gt; bool:</span>
    <span class="hljs-keyword">if</span> re_youtube.match(link) <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_text</span>(<span class="hljs-params">text: str</span>) -&gt; str:</span>
    bad_symbols = <span class="hljs-string">'!@#%$^&amp;*()_+1234567890-=/|\\?&gt;&lt;.,":;`~[]{}'</span><font></font>
<font></font>
    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> bad_symbols:<font></font>
        text = text.replace(s, <span class="hljs-string">''</span>)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> text.strip().lower()<font></font>
<font></font>
<span class="hljs-meta">@skip_edited</span>
<span class="hljs-meta">@bind_context</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_words</span>(<span class="hljs-params">update, context</span>):</span>
    update.message.reply_text(<span class="hljs-string">' :'</span>)    
    <span class="hljs-keyword">return</span> ADDING<font></font>
<font></font>
<span class="hljs-meta">@run_async</span>
<span class="hljs-meta">@skip_edited</span>
<span class="hljs-meta">@zero_exiter</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_text</span>(<span class="hljs-params">update, context</span>):</span>
    <span class="hljs-comment">#   - ,    ,   </span>
    message = update.message.reply_text(<span class="hljs-string">'...'</span>)<font></font>
<font></font>
    <span class="hljs-keyword">if</span> is_youtube_link(update.message.text):
        <span class="hljs-comment">#        ,    </span>
        <span class="hljs-keyword">try</span>:<font></font>
            transcript_list = YouTubeTranscriptApi.list_transcripts(get_video_id(update.message.text))<font></font>
            t = transcript_list.find_transcript([<span class="hljs-string">'en'</span>])<font></font>
            _text = clear_text(<span class="hljs-string">'. '</span>.join([i[<span class="hljs-string">'text'</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> t.fetch()])).split()
        <span class="hljs-keyword">except</span>:<font></font>
            message.edit_text(<span class="hljs-string">' .   : '</span>)
            <span class="hljs-keyword">return</span> ADDING
    <span class="hljs-keyword">else</span>:<font></font>
        _text = clear_text(update.message.text).split()<font></font>
<font></font>
    <span class="hljs-comment">#        </span><font></font>
    _words = context._bot.get_dict_words(context.t_id)<font></font>
    <span class="hljs-comment"># ,   </span><font></font>
    good_words = []<font></font>
    <span class="hljs-comment">#  </span><font></font>
    bad_words = []<font></font>
<font></font>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> set(_text):
        <span class="hljs-comment">#     </span><font></font>
        z = re_text.match(word)<font></font>
        <span class="hljs-keyword">if</span> z:
            <span class="hljs-comment">#          </span>
            <span class="hljs-keyword">if</span> z.group() <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> _words:<font></font>
                good_words.append(word)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            bad_words.append(word)<font></font>
<font></font>
    <span class="hljs-comment">#     -    </span>
    <span class="hljs-comment">#      </span>
    <span class="hljs-comment"># ...</span><font></font>
<font></font>
<span class="hljs-comment"># ...</span><font></font>
<font></font>
<span class="hljs-comment">#   :</span><font></font>
    tbot.add_conversation_handler(<font></font>
        entry_points = [(<span class="hljs-string">'add_words'</span>, add_words)],<font></font>
        states = [<font></font>
            [(parse_text, <span class="hljs-string">'@^((?!.*((^\/)+)).*)(.+)$'</span>)],
            <span class="hljs-comment"># ...</span>
        ])</code></pre><br>
<h1 id="upakovyvaem-bota"> </h1><br>
<p>     ,         .</p><br>
<pre><code class="python hljs"><span class="hljs-comment">#   :</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> argparse<font></font>
<font></font>
parser = argparse.ArgumentParser()<font></font>
parser.add_argument(<span class="hljs-string">'-l'</span>, <span class="hljs-string">'--level'</span>, default=<span class="hljs-string">'INFO'</span>, <font></font>
                    choices=[<span class="hljs-string">'TRACE'</span>, <span class="hljs-string">'DEBUG'</span>, <span class="hljs-string">'INFO'</span>, <span class="hljs-string">'SUCCESS'</span>, <span class="hljs-string">'WARNING'</span>, <span class="hljs-string">'ERROR'</span>, <span class="hljs-string">'CRITICAL'</span>],<font></font>
                    help=<span class="hljs-string">'     '</span>)<font></font>
parser.add_argument(<span class="hljs-string">'-p'</span>, <span class="hljs-string">'--proxy'</span>, help=<span class="hljs-string">'    '</span>)<font></font>
args = parser.parse_args()<font></font>
<font></font>
config = {<font></font>
    <span class="hljs-string">'handlers'</span>: [<font></font>
        {<span class="hljs-string">'sink'</span>: sys.stdout, <span class="hljs-string">'level'</span>: args.level},
        <span class="hljs-comment">#   .       DEBUG  </span>
        {<span class="hljs-string">'sink'</span>: <span class="hljs-string">'logs.log'</span>, <span class="hljs-string">'serialize'</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">'level'</span>: <span class="hljs-string">'DEBUG'</span>},<font></font>
    ],<font></font>
}<font></font>
<font></font>
logger.configure(**config)<font></font>
<font></font>
<span class="hljs-keyword">if</span> args.proxy:<font></font>
    t_proxy = {<span class="hljs-string">'proxy_url'</span>: args.proxy, <span class="hljs-string">'read_timeout'</span>: <span class="hljs-number">1000</span>, <span class="hljs-string">'connect_timeout'</span>: <span class="hljs-number">1000</span>}
    <span class="hljs-comment"># ...</span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-comment"># ...</span>
<span class="hljs-keyword">else</span>:<font></font>
    t_proxy = <span class="hljs-literal">None</span></code></pre><br>
<p>Python 3.5+  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>      .    ,          VPS.     .     ,      : <code>pip freeze &gt; requirements.txt</code>.       ,     .    <code>pip freeze</code>      ,        ,      .   —   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">pipreqs</a>.</p><br>
<p>,      ,       <code>.pyz</code> .      <code>py -m zipapp "__" -m "__:_" -o bot.pyz</code>,    bot.pyz    . ,    __init__.py     - ,      .</p><br>
<pre><code class="python hljs"><span class="hljs-comment">#  __init__.py </span>
<span class="hljs-comment"># py -m zipapp "__" -m "__init__.py:main" -o bot.pyz</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment"># ...</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre><br>
<p>    <code>zip bot.zip requirements.txt bot.pyz</code>      VPS.</p><br>
<h1 id="itogi"></h1><br>
<p>  Python     ,  ,      .          .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>   ).</p><cut></cut></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de488116/index.html">Fünf wichtige Lektionen zur Spielbalance</a></li>
<li><a href="../de488118/index.html">Haxe Winter Statusbericht</a></li>
<li><a href="../de488120/index.html">Warum lohnt es sich, ein 64-Bit-Betriebssystem auf dem Raspberry Pi4 zu installieren?</a></li>
<li><a href="../de488122/index.html">$ 1,5 Kompaktbrenner aus Aerogel, Aluminium und Papierhandtüchern</a></li>
<li><a href="../de488128/index.html">Vorzugspakete: Was wird zu den Gehältern von IT-Spezialisten in Armenien hinzugefügt?</a></li>
<li><a href="../de488134/index.html">CI auf Github für Android an einem Tag erhöhen</a></li>
<li><a href="../de488136/index.html">Wie hat der Atlas-Roboter gelernt, akrobatische Stunts zu machen, die für einen normalen Menschen unerträglich sind?</a></li>
<li><a href="../de488138/index.html">Kleine Kapazitätsmessungen (analoger kapazitiver Sensor)</a></li>
<li><a href="../de488140/index.html">Wie man das Leben mit Hilfe des Pareto-Gesetzes vereinfacht</a></li>
<li><a href="../de488142/index.html">Nachdenklich Avalonia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>