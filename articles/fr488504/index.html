<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äç‚öñÔ∏è üëçüèª üôá Nous connectons un calendrier de production dans Zabbix üíÜüèª ü•ö üïµüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme nous le savons tous, le processus de travail d'une entreprise, conform√©ment aux jours f√©ri√©s officiels nationaux et internationaux, n√©cessite so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nous connectons un calendrier de production dans Zabbix</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488504/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme nous le savons tous, le processus de travail d'une entreprise, conform√©ment aux jours f√©ri√©s officiels nationaux et internationaux, n√©cessite souvent une modification du processus de production en termes de d√©calage ou de remplacement des jours ouvrables et non ouvrables. De nombreuses organisations ont des calendriers de production internes, sur le calendrier desquels fonctionnent les processus technologiques et commerciaux. Les syst√®mes de surveillance qui fonctionnent de mani√®re autonome, sont souvent configur√©s pour surveiller les processus commerciaux dans le cours normal des affaires et ont un calendrier fixe fixe pour surveiller les flux d'informations et les donn√©es accompagnant les processus commerciaux. Au moment de modifier l'horaire de travail quotidien, les administrateurs n√©cessitent des actions manuelles pour modifier la logique de surveillance.Comment amener Zabbix √† utiliser un calendrier de production? Examinons quelques options plus en d√©tail.</font></font></p><a name="habracut"></a><br>
<h3 id="vvedenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous ceux qui ont travaill√© avec Zabbix savent que la logique de surveillance de certains services est form√©e √† l'aide de mod√®les qui se connectent √† des serveurs avec des services contr√¥l√©s. </font><font style="vertical-align: inherit;">Changer la logique du travail ou le calendrier de v√©rification des services est une t√¢che assez longue, qui d√©pend du nombre d'√©l√©ments contr√¥l√©s. </font><font style="vertical-align: inherit;">La modification de l'horaire de travail, lorsqu'au lieu du jour ouvrable, un jour f√©ri√© est d√©clar√©, afin d'√©viter le d√©clenchement erron√© de d√©clencheurs d'√©v√©nements, oblige les administrateurs √† envoyer le circuit de surveillance en mode de maintenance "Maintenance". </font><font style="vertical-align: inherit;">Dans le cas d'une journ√©e de travail le week-end, vous devez inclure de nombreux services de surveillance pour contr√¥ler le travail des processus m√©tier.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La recommandation officielle pour une planification flexible des d√©clencheurs de surveillance de Zabbix est de remplacer les param√®tres des cycles de scan par des macros globales </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://habr.com/en/company/zabbix/blog/344492/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais cette solution ne permet pas d'automatiser le </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
processus d'activation / d√©sactivation de la v√©rification des services sur un calendrier sous une forme explicite.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le serveur Zabbix est un syst√®me autonome qui fonctionne clairement dans le cadre de sa logique interne. </font><font style="vertical-align: inherit;">Par cons√©quent, les influences externes sur le syst√®me ne sont pas recommand√©es.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essayons d'impl√©menter la logique du calendrier de production sur la base des m√©canismes internes de Zabbix.</font></font></p><br>
<p><em> ,             .     ,    .</em><br>
    github.com,    .</p><br>
<h3 id="ogranicheniya"></h3><br>
<p>   Zabbix    :</p><br>
<ul>
<li>   Zabbix            </li>
<li>         Zabbix </li>
<li>()        </li>
<li>    </li>
</ul><br>
<h3 id="svyaznost-s-sistemoy-zabbix-servera">   Zabbix </h3><br>
<p>  Zabbix    : </p><br>
<ul>
<li>    ,      </li>
<li>       ""</li>
</ul><br>
<h3 id="usloviya-raboty-sistemy">  </h3><br>
<ul>
<li>     ,            /   </li>
<li>            </li>
<li>            ,    </li>
<li>      HTTP/HTTPS</li>
</ul><br>
<h3 id="znacheniya-po-umolchaniyu">  </h3><br>
<p>   :</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://somehost.somedomain/date/</a><br>
 :<br>
</li>
<li>Content-Type: "application/json"</li>
<li> : {"date": "20200202"}<br>
</li>
</ul><br>
<h3 id="usloviya-razvyortyvaniya"> </h3><br>
<ul>
<li>      </li>
<li>      Zabbix-agent.   Zabbix-agent    </li>
<li>      ,   ,     </li>
</ul><br>
<h3 id="metod-1"> ‚Ññ1</h3><br>
<p>           .<br>
      {$DATEURL}    .     "HTTP agent"   "holiday.date.by.http".</p><br>
<p>              (     1).    1.   .</p><br>
<p><img src="https://habrastorage.org/webt/jy/uq/0l/jyuq0l3l892opr9jselcjiptbqm.png"></p><br>
<p>        .<br>
  "Preprocessing"        "$.date".</p><br>
<p><img src="https://habrastorage.org/webt/h-/11/-a/h-11-awzmg8jyd3tpaxbbfotsqa.png"></p><br>
<p>      ,    "holiday.date.by.http"        .</p><br>
<p>        "Calculated"   "today.is.a.holiday" </p><br>
<p><img src="https://habrastorage.org/webt/u9/si/8y/u9si8y77dxbze_pgobaa-soyd4e.png"></p><br>
<p>    :<br>
last(holiday.date.by.http)=date(system.localtime)<br>
  "Numeric(Unsigned)"</p><br>
<p>   ,              0  1.</p><br>
<p><strong>   ,    0  1       .    ,   ""  ,          .        .</strong></p><br>
<p>,         :</p><br>
<ul>
<li>" "</li>
<li>" "  </li>
</ul><br>
<h3 id="tihiy-rezhim">" "</h3><br>
<p> " "             .             .</p><br>
<p>         :</p><br>
<pre><code class="plaintext hljs">{Zabbix server:system.users.num.last()}&gt;1</code></pre><br>
<p>   </p><br>
<pre><code class="plaintext hljs">{Zabbix server:system.users.num.last()}&gt;1 and {Zabbix server:today.is.a.holiday.last()}=0</code></pre><br>
<p>       .<br>
              .</p><br>
<h3 id="proaktivnyy-rezhim-s-opovescheniem">" "  </h3><br>
<p>         "/".</p><br>
<p>       "today.is.a.holiday"          .</p><br>
<p><img src="https://habrastorage.org/webt/ie/z8/4a/iez84a2boqqao9suirse0dgv4rs.png"></p><br>
<p>         .</p><br>
<p><img src="https://habrastorage.org/webt/dh/pw/cb/dhpwcbvknos_ehlbqfkj2izlbba.jpeg"></p><br>
<p>          .</p><br>
<p>          .         "{Zabbix server:system.users.num.last()}&gt;1",        1.</p><br>
<p>     "{Zabbix server:proc.num.last()}&gt;20"</p><br>
<p>            ""</p><br>
<p><img src="https://habrastorage.org/webt/1w/zi/ef/1wziefcapb0doatvsvafj-aitjw.jpeg"></p><br>
<p>           </p><br>
<p><img src="https://habrastorage.org/webt/vt/eb/am/vtebamf2nmeiuq5xjmcjoxxkh8s.jpeg"></p><br>
<p>       (, TG, SMS).</p><br>
<p>             .       .      .</p><br>
<h3 id="metod-2"> ‚Ññ2</h3><br>
<p>    ,  Zabbix          .           ,      .          .<br>
   ?</p><br>
<h4 id="variant-1"> 1</h4><br>
<p>        -  ,                .</p><br>
<h4 id="variant-2"> 2</h4><br>
<p>         ,         .</p><br>
<p>  ,    .<br>
       ,     .      {$HOLIDAY_DATE}.  ,        ,       Zabbix-agent,      {$CURRENT_DATE}   .</p><br>
<p>      InfluxDB.       ,         1  5 .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   InfluxDB</a></p><br>
<p>      ,            .  fuzzytime          .         .</p><br>
<p>         </p><br>
<pre><code class="xml hljs">                <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Today is a holiday<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>CALCULATED<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>influxdb.holiday<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">history</span>&gt;</span>1h<span class="hljs-tag">&lt;/<span class="hljs-name">history</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">trends</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">trends</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">params</span>&gt;</span>date(system.localtime)={$HOLIDAY_DATE}<span class="hljs-tag">&lt;/<span class="hljs-name">params</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">applications</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">application</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>InfluxDB DataCheck<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">applications</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">triggers</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">trigger</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">expression</span>&gt;</span>{last()}<span class="hljs-tag">&lt;/<span class="hljs-name">expression</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>InfluxDB Holiday Activated<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">opdata</span>&gt;</span>If Fired - all dependent triggers are disabled<span class="hljs-tag">&lt;/<span class="hljs-name">opdata</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">priority</span>&gt;</span>INFO<span class="hljs-tag">&lt;/<span class="hljs-name">priority</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">trigger</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">triggers</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span></code></pre><br>
<p>           .<br>
      ,      .</p><br>
<pre><code class="xml hljs">     <span class="hljs-tag">&lt;<span class="hljs-name">params</span>&gt;</span>{$CURRENT_DATE}={$HOLIDAY_DATE}<span class="hljs-tag">&lt;/<span class="hljs-name">params</span>&gt;</span></code></pre><br>
<p>         ,        .</p><br>
<p>""  , "       ,   Zabbix       ?"</p><br>
<p>  ,     ,      . Zabbix  JSON RPC,       ,     .         Zabbix ,       ,    .     ,            Zabbix ,    .</p><br>
<p>   </p><br>
<p><img src="https://habrastorage.org/webt/ak/cy/sh/akcyshemlekp1-0a0lq9somgutu.jpeg"></p><br>
<p>  Preprocessing .</p><br>
<p><img src="https://habrastorage.org/webt/xp/ec/dj/xpecdje882mioyb-s7nbz9cvqos.jpeg"></p><br>
<div class="spoiler"><b class="spoiler_title">Preprocessing Script</b><div class="spoiler_text"><pre><code class="plaintext hljs">//Zabbix.Log(2, 'Date Update request value='+value);<font></font>
var authtoken = '';<font></font>
var globalmacroid = -1;<font></font>
<font></font>
var req = new CurlHttpRequest();<font></font>
req.AddHeader('Content-Type: application/json');<font></font>
resp = req.Post("{$DATEURL}", '{}');<font></font>
var holidaydate = JSON.parse(resp).date;<font></font>
<font></font>
Zabbix.Log(2, 'Found new holiday date='+holidaydate);<font></font>
<font></font>
resp = req.Post("{$JSONRPC}", '{"jsonrpc": "2.0","method": "user.login","params": {"user": "Calendar","password": "SomePassword"},"id": 1}');<font></font>
<font></font>
//   <font></font>
<font></font>
if (req.Status() == 200) {<font></font>
    jv = JSON.parse(resp);<font></font>
    if (jv.result)<font></font>
       authtoken= jv.result;<font></font>
    else<font></font>
       return 0;<font></font>
}<font></font>
else<font></font>
    return 0;<font></font>
<font></font>
//    <font></font>
<font></font>
var reqmacros = <font></font>
{<font></font>
    "jsonrpc": "2.0",<font></font>
    "method": "usermacro.get",<font></font>
    "params": {<font></font>
        "output": "extend",<font></font>
        "globalmacro": true<font></font>
    },<font></font>
    "auth": authtoken,<font></font>
    "id": 1<font></font>
}<font></font>
<font></font>
resp = req.Post("{$JSONRPC}", JSON.stringify(reqmacros));<font></font>
if (req.Status() == 200) {<font></font>
    var jv = JSON.parse(resp);<font></font>
    for(item in jv.result) {<font></font>
        if (jv.result[item].macro == '{\$HOLIDAY_DATE}')<font></font>
            {<font></font>
                globalmacroid = jv.result[item].globalmacroid<font></font>
                Zabbix.Log(2, 'Old Date value: '+jv.result[item].value)<font></font>
            }<font></font>
        }<font></font>
    if (globalmacroid == -1)<font></font>
        return 0;<font></font>
}<font></font>
else<font></font>
{<font></font>
    return 0;<font></font>
}<font></font>
<font></font>
//      <font></font>
<font></font>
var changemacros = <font></font>
{   "jsonrpc": "2.0",<font></font>
    "method": "usermacro.updateglobal",<font></font>
    "params": {<font></font>
        "globalmacroid": globalmacroid,<font></font>
        "value": holidaydate<font></font>
    },<font></font>
    "auth": authtoken,<font></font>
    "id": 1<font></font>
}<font></font>
<font></font>
resp = req.Post("{$JSONRPC}", JSON.stringify(changemacros));<font></font>
<font></font>
if (req.Status() == 200) {<font></font>
   jv = JSON.parse(resp);<font></font>
   if (jv.result.globalmacroids.indexOf(globalmacroid) != -1)<font></font>
        return 1<font></font>
}<font></font>
return 0;</code></pre></div></div><br>
<p>           "{$HOLIDAY_DATE}"    "{$CURRENT_DATE}".       ,              .       ‚Äî   .           .</p><br>
<p>  ,      ,      / ,      -,   /         .</p><br>
<p><strong>P.S.:      ,       WEB ,      "HTTP agent"        .</strong><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   github.com</a></p><br>
<p>UPD:       .</p><br>
<p>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>     " ".    4.X  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">      </a>.                 ,   .</p><br>
<p>¬© Aborche 2020<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7c5/e49/ede/7c5e49ede95e47e91424dbb9bafbb7bb.jpg" alt="Aborche"></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488482/index.html">Combien co√ªte Appium pour le peuple</a></li>
<li><a href="../fr488484/index.html">Lancement SQL - √âv√©nement Microsoft SQL Server 2019</a></li>
<li><a href="../fr488488/index.html">Pour OpenBSD. Un peu de plaisir</a></li>
<li><a href="../fr488490/index.html">Likbez sur les respirateurs. Le respirateur aide-t-il √† l'infection par le virus? Aper√ßu de 11 respirateurs</a></li>
<li><a href="../fr488498/index.html">Laboratoires de l'Universit√© ITMO: √©clairage LED, opto√©lectronique micro-ondes et t√©l√©communications optiques</a></li>
<li><a href="../fr488514/index.html">D√©bogueur √† distance Android - D√©bogage √† distance des applications Android</a></li>
<li><a href="../fr488516/index.html">Guide complet des balises iframe</a></li>
<li><a href="../fr488518/index.html">Examen comparatif des livres √©lectroniques ONYX BOOX Livingstone et Amazon Kindle Paperwhite (2018)</a></li>
<li><a href="../fr488520/index.html">Bloopers et gribouillis. 2</a></li>
<li><a href="../fr488522/index.html">JOOQ et son terrier de lapin. Comment survivre sans hibernation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>