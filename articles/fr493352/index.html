<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚣 🔙 👩🏼‍💻 Diffusez vos vidéos sur YouTube 24h / 24 😊 🤲🏼 👩🏻‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Récemment, comme passe-temps, je filme des vidéos d'un psychologue familier sur vidéo. Je monte et publie les images sur mon site Web. Il y a un mois,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Diffusez vos vidéos sur YouTube 24h / 24</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493352/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Récemment, comme passe-temps, je filme des vidéos d'un psychologue familier sur vidéo. Je monte et publie les images sur mon site Web. Il y a un mois, j'ai eu l'idée d'organiser une diffusion 24 heures sur 24 de ces conférences sur YouTube 24/7. Une sorte de «canal» thématique dédié à la croissance personnelle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment faire une diffusion normale, je sais. Mais comment en faire une diffusion de fichiers vidéo? Elle marchait 24h / 24 et 7j / 7, était flexible, aussi autonome que possible et ne dépendait pas en même temps de mon ordinateur personnel. C'était ce que je devais découvrir. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/vn/5u/tivn5utlpr-vmldtf9dh5hh7fku.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a fallu plusieurs jours pour trouver une solution. J'ai étudié de nombreux forums et divers manuels sans lesquels ma diffusion n'aurait tout simplement pas abouti. Et maintenant, quand la farce est un succès, je ressens le besoin de partager ma décision. Cet article est donc apparu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En bref, la solution finale était la suivante: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS + ffmeg + script bash</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sous la coupe, je décris les étapes franchies et parle des «pièges» découverts lors de la diffusion.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Étape 1 - d'où ira la diffusion?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au tout début, il fallait déterminer où se déroulera la diffusion, où se trouvera sa source. La toute première chose qui m'est venue à l'esprit est venue </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d'un ordinateur personnel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Collectez des vidéos dans une liste de lecture et lisez-les dans n'importe quel lecteur vidéo. Capturez ensuite l'image à l'écran et diffusez-la sur YouTube. Mais j'ai presque immédiatement rejeté cette option. pour le mettre en œuvre, vous devez garder votre ordinateur personnel allumé en permanence, et c'est le bruit des refroidisseurs même la nuit et la consommation d'énergie accrue (+ 100-150 kWh chaque mois). Et il s'avère que vous ne pourrez pas utiliser votre ordinateur personnel pendant la durée de la diffusion. tout mouvement de la souris sera visible dans la diffusion. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis j'ai commencé à regarder vers les </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">services cloud</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Je cherchais un service prêt à l'emploi où vous pourriez télécharger vos vidéos ou, par exemple, insérer des liens vers des vidéos de YouTube et tout serait regroupé en une seule diffusion non-stop. Mais je n'ai rien trouvé de convenable. Peut-être que je regardais mal. La seule chose qui convient à la fonctionnalité est restream.io, un service qui permet de diffuser simultanément sur plusieurs plates-formes. Ils semblent pouvoir télécharger leurs vidéos. Mais ce service a été créé à des fins complètement différentes et ils s'attendent à ce que la diffusion ne dure que quelques heures. Je pense que si, grâce à ce service, il aurait été possible d'organiser une diffusion 24 heures sur 24, cela aurait atteint des dizaines, voire des centaines de dollars par mois. Mais je voulais quand même organiser la diffusion gratuitement ou avec un investissement financier minimal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est devenu clair que vous devez diffuser</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un appareil séparé</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou même un ordinateur séparé. Penser à quelque chose comme le Raspberri Pi. Et quoi? Il n'a pas de glacière. J'ai enregistré la vidéo sur une clé USB, collé un câble Ethernet et laissé reposer quelque part dans un endroit isolé, elle diffuse. Option. Mais je n'avais ni la planche elle-même ni l'expérience avec elle, j'ai donc également refusé cette option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fin de compte, je suis tombé sur une discussion où ils ont discuté de la création de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">votre propre serveur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">émissions. Ce n'était pas exactement ce que je cherchais, mais j'ai saisi l'idée principale - vous pouvez utiliser le serveur! Dans cette discussion, ils ont suggéré d'utiliser un tas de VPS + nginx + OBS. Il est devenu clair que ce groupe pouvait me convenir. La seule chose qui m'a dérouté, c'est que je n'ai jamais administré le serveur et il m'a semblé que mon serveur dédié était confus et cher. J'ai décidé de savoir combien cela coûterait de louer un serveur dans la configuration minimale et j'ai été agréablement surpris.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mu/v8/ms/muv8msmvpgnhzj9z04nuhv_y0-s.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les prix sont en roubles biélorusses et ce ne sont que des miettes. Pour comprendre, 8 roubles biélorusses se situent autour de 3,5 dollars ou 240 roubles russes. Pendant un mois avec un ordinateur à part entière allumé 24h / 24 et 7j / 7 et disposant d'un accès Internet rapide. Pour une raison quelconque, cette découverte a été très joyeuse pour moi, et pendant plusieurs jours j'ai marché terriblement heureux comme un enfant qui a découvert des fusées spatiales :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au fait, j'ai profité de l'offre du tout premier site que Google m'a proposé sur demande «Location de VPS». Il y a peut-être encore plus de solutions budgétaires, mais ce prix me convenait et je n'ai pas cherché plus loin.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la création d'un serveur, vous pouvez sélectionner le système d'exploitation sous lequel il fonctionnera. </font><font style="vertical-align: inherit;">Sur l'un des systèmes répertoriés, vous pouvez organiser la diffusion et faire un choix en fonction de vos préférences et de vos capacités financières (ils demandent des frais supplémentaires pour un serveur avec Windows). </font><font style="vertical-align: inherit;">J'ai choisi CentOS. </font><font style="vertical-align: inherit;">Tout simplement parce que j'avais une petite expérience avec elle.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cv/0a/wh/cv0awhhxim1w2fgglkrlupl5hgc.jpeg" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Étape 2 - Configuration du serveur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première chose dont vous avez besoin après avoir créé le serveur est de vous y connecter via SSH. </font><font style="vertical-align: inherit;">Au début, j'ai utilisé PuTTy, mais j'ai ensuite commencé à utiliser l'application Secure Shell, qui fonctionne sur Google Chrome. </font><font style="vertical-align: inherit;">Cela s'est donc avéré plus pratique pour moi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, j'ai changé le nom d'hôte, mis en place la synchronisation de l'heure sur le serveur, mis à jour le système, joué avec iptables ... et fait un tas de choses, mais pas parce que c'était nécessaire. </font><font style="vertical-align: inherit;">C'était juste intéressant pour moi de configurer le serveur et cela a fonctionné pour moi. </font><font style="vertical-align: inherit;">J'adore quand ça s'avère :) </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais ces étapes qui doivent être faites:</font></font></b><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connectez le référentiel EPEL.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Relevez le serveur FTP (j'ai choisi vsftp).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installez ffmpeg.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne donnerai pas de détails sur l'équipe, cette instruction est plutôt conceptuelle afin de véhiculer un plan d'action général. Si vous rencontrez des difficultés avec l'une des étapes, elles sont rapidement résolues par une requête dans un moteur de recherche comme «CentOS connect EPEL» ou «Installation du serveur FTP CentOS». Et aux premiers liens, vous pouvez trouver des instructions détaillées étape par étape. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, comme je l'ai écrit plus tôt, j'avais besoin d'un tas de VPS + nginx + OBS. VPS - prêt. Mais ici, sur les points restants, des questions ont commencé à se poser. OBS est un programme de diffusion, Open Broadcaster Software. Et cela ne fonctionne qu'avec des threads, c'est-à-dire par exemple, il prend une image d'une webcam et la diffuse. Ou l'enregistrement d'écran. Ou une diffusion déjà en cours redirige vers un autre site. Et je n'ai pas de flux, je n'ai qu'un ensemble de fichiers vidéo dont j'ai besoin pour faire un flux.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a commencé à creuser dans cette direction et est tombé sur ffmpeg. </font><font style="vertical-align: inherit;">FFmpeg est un ensemble de bibliothèques open source gratuites qui vous permettent d'enregistrer, de convertir et de transférer des enregistrements audio et vidéo numériques dans différents formats. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et j'ai été très surpris de voir ce que ffmpeg peut faire. </font><font style="vertical-align: inherit;">Si vous le souhaitez, il extraira le son de la vidéo. </font><font style="vertical-align: inherit;">Si vous le souhaitez, il découpera un fragment de la vidéo sans transcodage. </font><font style="vertical-align: inherit;">Si vous le souhaitez, il sera converti d'un format à un autre. </font><font style="vertical-align: inherit;">Et bien plus encore. </font><font style="vertical-align: inherit;">Jusqu'à ce que vous puissiez lui spécifier un fichier, il le convertira en flux et le transférera lui-même sur YouTube. </font><font style="vertical-align: inherit;">Tout, la chaîne est assemblée. </font><font style="vertical-align: inherit;">Il ne reste plus qu'à affiner les nuances.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Étape 3 - Configuration de la diffusion</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous créons une diffusion sur YouTube. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">À ce stade, nous n'avons besoin que d'un lien et d'une clé de traduction. </font><font style="vertical-align: inherit;">Dans la capture d'écran ci-dessous, ils sont surlignés en rouge. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gr/a3/oo/gra3oogooafzdfjzhlqdqjjxr8o.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">téléchargez les fichiers vidéo sur le serveur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que nous prévoyons de diffuser. </font><font style="vertical-align: inherit;">En fait, FTP n'est nécessaire que pour cette étape. </font><font style="vertical-align: inherit;">Si vous avez un autre moyen pratique de télécharger des fichiers sur le serveur, le serveur FTP peut être ignoré. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous diffusons sur YouTube. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour démarrer la diffusion, vous devez exécuter ffmpeg avec plusieurs attributs. </font><font style="vertical-align: inherit;">Voici la commande la plus courte que j'ai reçue:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -re -i lecture1.mp4 -f flv rtmp://a.rtmp.youtube.com/live2/%_%</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Décryptage des attributs</font></font></b><div class="spoiler_text"><code>-re</code> – ,      .<br>
<br>
<code>-i</code> – ,    . ,       ,    -.       ,  <code>/usr/media/lecture1.mp4</code>.<br>
<br>
<code>-f</code> –    .    ,  ffmpeg « »     mp4  flv.<br>
<br>
    ,     YouTube     .. ,     ,   ,       .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous avez tout fait correctement, après avoir exécuté cette commande, YouTube verra le flux transmis. </font><font style="vertical-align: inherit;">Pour démarrer la diffusion, il vous suffit de cliquer sur le bouton "Démarrer la diffusion" dans YouTube même.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Étape 4 - Ajoutez de l'autonomie</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes nos félicitations! Vous savez maintenant comment démarrer la diffusion à partir d'un fichier vidéo. Mais cela ne suffit pas pour une diffusion 24 heures sur 24. Il est important qu'après la fin de la lecture de la première vidéo, la suivante démarre immédiatement et lorsque toutes les vidéos sont affichées, la lecture recommence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suis venu avec l'option suivante: créer un fichier .sh dans lequel j'ai enregistré une commande pour chaque fichier vidéo et à la fin indiqué une commande pour redémarrer le même script. Il s'est avéré une sorte de récursivité:</font></font><br>
<br>
<pre><code class="bash hljs"> 1... (   lecture1.mp4)<font></font>
 2... (   lecture2.mp4)<font></font>
 3... (   lecture3.mp4)<font></font>
bash start.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et oui, ça a marché. Moi, satisfait de moi, j'ai commencé une émission test et je me suis endormi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une mauvaise surprise m'attendait le matin. Il s'est avéré que l'émission n'a duré que quelques minutes et s'est terminée presque immédiatement lorsque j'ai éteint mon ordinateur. L'enquête a montré que les commandes ainsi lancées sont exécutées alors que l'utilisateur est autorisé sur le serveur. Dès que je me suis déconnecté, l'exécution des commandes que j'ai lancées a été interrompue. Pour éviter que cela ne se produise, il suffit d' </font></font><code>bash</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajouter l'équipe </font><font style="vertical-align: inherit;">avant l' </font><font style="vertical-align: inherit;">équipe </font></font><code>nohup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cela permettra au processus en cours de s'exécuter indépendamment de votre présence. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La version minimale finale du script ressemble à ceci:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -re -i lecture1.mp4 -f flv rtmp://a.rtmp.youtube.com/live2/%_%<font></font>
ffmpeg -re -i lecture2.mp4 -f flv rtmp://a.rtmp.youtube.com/live2/%_%<font></font>
ffmpeg -re -i lecture3.mp4 -f flv rtmp://a.rtmp.youtube.com/live2/%_%<font></font>
nohup bash start.sh $</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Où start.sh est le fichier dans lequel ce script est écrit. </font><font style="vertical-align: inherit;">Et ce fichier doit être situé dans le même répertoire que les fichiers vidéo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ajout d'un signe dollar à la fin vous permet de démarrer le processus en arrière-plan afin de pouvoir continuer à utiliser la console sans interrompre la diffusion. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Des bonus, les brioches suivantes se sont révélées:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez basculer manuellement la lecture des fichiers. </font><font style="vertical-align: inherit;">Pour ce faire, vous devez "tuer" le processus ffmpeg en cours d'exécution. </font><font style="vertical-align: inherit;">Après cela, la lecture du fichier suivant de la liste démarre automatiquement.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De nouvelles vidéos peuvent être ajoutées à la diffusion sans arrêter la diffusion. </font><font style="vertical-align: inherit;">Téléchargez simplement la vidéo sur le serveur, ajoutez la commande pour exécuter ce fichier dans le script, enregistrez-la. </font><font style="vertical-align: inherit;">Et c'est tout. </font><font style="vertical-align: inherit;">Lors de la prochaine lecture, le nouveau fichier sera déjà diffusé avec les anciens fichiers.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Étape 5 - Configurer ffmpeg</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur ce point, en principe, on pourrait s'arrêter. Mais je voulais rendre l'émission un peu plus conviviale pour le public. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons qu'une personne se rende à l'émission, commence à la regarder, qu'elle l'aime et veuille regarder cette conférence depuis le début, et que l'émission n'inclut pas le rembobinage. Pour visualiser une conférence depuis le début, une personne devra se rendre sur mon site Web et obtenir un enregistrement de la conférence d'intérêt. Et comment comprendre quelle conférence l'intéresse? Le site compte 16 conférences et chaque semaine il n'y en a plus. Je pense que même moi, qui ai tourné et édité toutes ces conférences, ne pourra pas déterminer de quelle conférence il s'agit à partir d'un fragment aléatoire. Par conséquent, il est nécessaire que chaque conférence soit désignée d'une manière ou d'une autre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'option d'ajouter des sous-titres aux fichiers vidéo source dans le programme de montage ne me convenait pas. </font><font style="vertical-align: inherit;">Il fallait s'assurer que les fichiers originaux étaient utilisés. </font><font style="vertical-align: inherit;">Pour soutenir la diffusion exigée de moi le moins de mouvements corporels possible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'est avéré que ffmpeg peut également m'aider. </font><font style="vertical-align: inherit;">Il a un attribut spécial </font></font><code>-vf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui vous permet de mettre du texte au-dessus de la vidéo. </font><font style="vertical-align: inherit;">Pour ajouter du texte à la vidéo, vous devez ajouter le fragment suivant à la commande:</font></font><br>
<br>
<pre><code class="bash hljs">-vf drawtext=<span class="hljs-string">"fontfile=OpenSans.ttf:text=' 13\:  .   ?':fontsize=26:fontcolor=white:borderw=1:bordercolor=black:x=40:y=670"</span></code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Décodage des paramètres</font></font></b><div class="spoiler_text"><code>fontfile=</code> –    .       .          .        .<br>
<br>
<code>text=</code> – ,  ,     .<br>
<br>
<code>fontsize=</code> –    .<br>
<br>
<code>fontcolor=</code> –  .<br>
<br>
<code>borderw=</code> –       (         1 ).<br>
<br>
<code>bordercolor=</code> –  .<br>
<br>
<code>x=</code>  <code>y=</code> –  .  <code>0;0</code>     .      ,           1280720 .<br>
</div></div><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela ressemble à ceci:</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/jf/1n/sh/jf1nshia1hbk30-pjd5y6mztga0.jpeg" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Étape 6 - déterminer la qualité de diffusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout, l'émission est prête. FFmpeg diffuse, joue des fichiers, ma présence n'est pas nécessaire pour la diffusion. Même chaque conférence est signée. Regardez comme ça. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais une autre nuance est apparue - j'ai choisi la configuration minimale du serveur et cela n'a pas entraîné la diffusion. Configuration du serveur: 1 cœur (comme 2,2 GHz), 1 gigaoctet de RAM, 25 Go SSD. Il y avait suffisamment de RAM, mais le processeur est presque complètement entré dans le chargement à 100% (et parfois même à 102-103% :) Cela a conduit au gel de la diffusion une fois toutes les quelques secondes. Laid.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez simplement prendre une configuration plus coûteuse avec deux cœurs, l'avantage est qu'avec les technologies cloud, la configuration du serveur est modifiée en appuyant sur quelques boutons. </font><font style="vertical-align: inherit;">Mais je voulais m'adapter à la puissance de la configuration minimale. </font><font style="vertical-align: inherit;">J'ai commencé à étudier la documentation de ffmpeg et oui, il y a aussi des paramètres qui vous permettent d'ajuster la charge sur le système.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une qualité d'image élevée peut être obtenue de deux manières: soit une charge de processeur élevée, soit un trafic sortant important. </font><font style="vertical-align: inherit;">Il s'avère que plus le processeur peut supporter la charge, moins le canal aura besoin de bande passante. </font><font style="vertical-align: inherit;">Ou vous ne pouvez pas charger lourdement le processeur, mais vous aurez alors besoin d'un canal large avec une grande marge de trafic. </font><font style="vertical-align: inherit;">S'il y a des restrictions à la fois sur le processeur et sur la taille du canal / trafic sortant, alors vous devrez réduire la qualité de l'image pour que la diffusion se passe sans problème.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon serveur dispose d'un canal 10 Mbps. Cette largeur est droite avec une marge. Mais il y a une limite de trafic - 1 To par mois. Par conséquent, afin de respecter les restrictions de trafic, mon flux sortant ne doit pas dépasser ~ 300 Ko par seconde, c'est-à-dire le débit binaire du flux sortant ne doit pas dépasser 2,5 Mbps. Au fait, YouTube recommande simplement de diffuser avec un tel débit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ffmpeg utilise différentes approches pour réguler la charge sur le système. Bien écrit à ce sujet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . J'ai fini par utiliser deux attributs: </font></font><code>-crf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>-preset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facteur de taux constant (CRF)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- il s'agit d'un coefficient grâce auquel vous pouvez ajuster la qualité de l'image. </font><font style="vertical-align: inherit;">Le CRF peut varier de 0 à 51, où 0 est la qualité du fichier source, 51 est la pire qualité possible. </font><font style="vertical-align: inherit;">Il est recommandé d'utiliser des valeurs de 17 à 28, la valeur par défaut est de 23. Avec un ratio de 17, la vidéo sera visuellement identique à l'original, mais techniquement ce ne sera pas le cas. </font><font style="vertical-align: inherit;">La documentation indique également que la taille de la vidéo finale, en fonction du CRF spécifié, change de façon exponentielle, c'est-à-dire </font><font style="vertical-align: inherit;">l'augmentation du coefficient de 6 points doublera le débit binaire de la vidéo sortante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous utilisez CRF, vous pouvez choisir le "poids" de l'image sortante, puis en utilisant des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">préréglages (-preset),</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vous pouvez déterminer combien le processeur sera chargé. </font><font style="vertical-align: inherit;">Les paramètres de cet attribut sont les suivants:</font></font><br>
<br>
<ul>
<li><code>ultrafast</code></li>
<li><code>superfast</code></li>
<li><code>veryfast</code></li>
<li><code>faster</code></li>
<li><code>fast</code></li>
<li><code>medium</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - valeur par défaut</font></font></li>
<li><code>slow</code></li>
<li><code>slower</code></li>
<li><code>veryslow</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus le paramètre est "rapide", plus la charge du processeur est élevée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai d'abord pris le préréglage, qui était fondamentalement «difficile» pour mon processeur, puis j'ai réglé plus finement la charge à l'aide de CRF. </font><font style="vertical-align: inherit;">Dans mon cas, le préréglage est apparu </font></font><code>fast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et pour crf, j'ai opté pour une valeur de 24.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout. </font><font style="vertical-align: inherit;">La commande finale pour démarrer la diffusion m'a donné ceci:</font></font><br>
<br>
<pre><code class="bash hljs">ffmpeg -re -i lecture1.mp4 -vf drawtext=<span class="hljs-string">"fontfile=OpenSans.ttf:text=' 1\:   ':fontsize=26:fontcolor=white:borderw=1:bordercolor=black:x=40:y=670"</span> -c:v libx264 -preset fast -crf 24 -g 3 -f flv rtmp://a.rtmp.youtube.com/live2/%_%</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, il n'y a que deux moments non décrits: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) </font></font><code>-c:v libx264</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- une indication d'un codec spécifique pour travailler avec le fichier source. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) </font></font><code>-g 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- une indication explicite du nombre d'images clés. Dans ce cas, il est indiqué que chaque troisième trame doit être clé. La valeur standard est de 5 ou 8, mais YouTube jure, demande au moins 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelle qualité de la diffusion s'est révélée </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La charge du serveur était la suivante:</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/b5/3s/za/b53szauaywx3bdwoic-yebil1es.jpeg" alt="image"><br>
<br>
<img src="https://habrastorage.org/webt/cq/jc/t4/cqjct4xhbz3zabriimgydbxvjaq.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sur la base des données de surveillance, il est clair que la charge du processeur varie de 70% à 95% et la diffusion n'a jamais atteint 100% en une semaine. Donc, avec ces paramètres, le processeur suffit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors du chargement d'un disque, je peux dire qu'il n'est presque pas chargé et qu'un disque dur ordinaire devrait suffire pour la diffusion. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la quantité de trafic sortant me dérange. Il s'avère que mon flux sortant varie de 450 à 650 Ko par seconde. Pendant un mois, ce sera environ 1,8 téraoctets. Vous devrez peut-être acheter du trafic ou toujours passer à une configuration double cœur car Je ne voudrais pas réduire la qualité de l'image. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*** </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, je dirai que la configuration d'une telle diffusion à partir de zéro prend environ 1 à 2 heures. De plus, la plupart du temps, il faudra télécharger la vidéo sur le serveur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tant qu'outil de marketing, le lancement d'une telle émission n'a pas porté ses fruits. Peut-être que si vous finissez les vues de sorte que les algorithmes de YouTube captent cette diffusion et la montrent activement dans les recommandations, alors quelque chose fonctionnera. Dans mon cas, pendant 16 jours de diffusion continue, il a été regardé 58 fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ça va. Diffusez harmonieusement sur la page principale de mon site. Cela s'est avéré une sorte d'opportunité pour se faire rapidement une idée du conférencier et des conférences elles-mêmes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et un instant. Il est important que la diffusion ne viole pas le droit d'auteur de quiconque, sinon elle sera bloquée. Je suis calme pour ma diffusion. J'ai spécialement sélectionné des insertions musicales à usage gratuit, et l'auteur du contenu est assis sur un ordinateur voisin et n'est pas du tout contre moi d'utiliser son contenu :)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si vous avez une radio qui joue en arrière-plan quelque part en arrière-plan, ou si vous avez utilisé votre morceau préféré pendant le montage, ou si vous avez pris une vidéo d'un clip, d'une série ou d'un film de musique populaire, votre diffusion est menacée. </font><font style="vertical-align: inherit;">Il est également important que la diffusion porte au moins une charge sémantique minimale, sinon elle peut être bloquée en tant que spam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
*** </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout pour moi. </font><font style="vertical-align: inherit;">J'espère que ce manuel servira bien quelqu'un. </font><font style="vertical-align: inherit;">Eh bien, si vous avez quelque chose à ajouter - écrivez, je me ferai un plaisir de lire les ajouts et les clarifications à l'article.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr493336/index.html">Comment l'informatique a traduit l'apprentissage en ligne</a></li>
<li><a href="../fr493340/index.html">Rendre les fonctions SIL portables entre les versions dans Jira</a></li>
<li><a href="../fr493342/index.html">Comment NSPK a préparé l'infrastructure pour la transition vers Udalenka</a></li>
<li><a href="../fr493346/index.html">Nous avons réussi à transférer des bureaux à udalenka, et vous?</a></li>
<li><a href="../fr493348/index.html">Rendre "udalenka" génial à nouveau: comment transférer toute l'entreprise au travail à distance en 4 étapes</a></li>
<li><a href="../fr493356/index.html">Video @Databases Meetup: sécurité du SGBD, Tarantool dans l'IoT, Greenplum pour l'analyse de Big Data</a></li>
<li><a href="../fr493360/index.html">Deux doigts d'Algol</a></li>
<li><a href="../fr493362/index.html">Support technique "sur les valises". Comment nous travaillons à distance sans nerfs inutiles et obtenons à distance les services dont nous avons besoin</a></li>
<li><a href="../fr493366/index.html">Qu'est-ce que Windows PowerShell et que mange-t-il? Partie 3: passer des paramètres aux scripts et aux fonctions, créer des applets de commande</a></li>
<li><a href="../fr493374/index.html">Coronavirus - conseils pratiques et un peu de théorie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>