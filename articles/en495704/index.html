<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüé® üå™Ô∏è üë®üèø‚Äçüî¨ Monitoring network equipment over SNMPv3 in Zabbix üôÖüèº ‚ôæ üíù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses the features of monitoring network equipment using the SNMPv3 protocol. We will talk about SNMPv3, I will share my experience i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Monitoring network equipment over SNMPv3 in Zabbix</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/zabbix/blog/495704/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article discusses the features of monitoring network equipment using the SNMPv3 protocol. </font><font style="vertical-align: inherit;">We will talk about SNMPv3, I will share my experience in creating full-fledged templates in Zabbix, and show what you can achieve when organizing distributed alerts on a large network. </font><font style="vertical-align: inherit;">SNMP is the main protocol for monitoring network equipment, and Zabbix is ‚Äã‚Äãexcellent for monitoring a large number of objects and summarizing significant volumes of incoming metrics.</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A few words about SNMPv3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the appointment of SNMPv3, and the features of its use. </font><font style="vertical-align: inherit;">SNMP tasks are monitoring network devices, and elementary management, by sending simple commands to them (for example, turning network interfaces on and off, or rebooting the device). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main difference between the SNMPv3 protocol and its previous versions is the classic security features [1-3], namely:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Authentication, which determines that the request is received from a trusted source;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encryption, to prevent disclosure of transmitted data when intercepted by third parties;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrity, that is, a guarantee that the packet was not tampered with during transmission.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNMPv3 implies the use of a security model in which an authentication strategy is set for a given user and the group to which he belongs (in previous versions of SNMP, in the request from the server to the monitoring object, only ‚Äúcommunity‚Äù was compared, a text string with a ‚Äúpassword‚Äù transmitted in clear form (plain text)). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNMPv3 introduces the concept of security levels - acceptable security levels that determine the configuration of equipment and the behavior of the SNMP agent of the monitoring object. The combination of the security model and the security level determines which security mechanism is used when processing the SNMP packet [4]. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The table describes combinations of models and SNMPv3 security levels (I decided to leave the first three columns as in the original):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qu/5x/ac/qu5xacorpr-q2zreebuvsul87vw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accordingly, we will use SNMPv3 in authentication mode using encryption.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure SNMPv3 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitoring network equipment involves the same configuration of the SNMPv3 protocol both on the monitoring server and on the monitored object. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start by configuring a Cisco network device, its minimum required configuration is as follows (for configuration we use CLI, I simplified names and passwords to avoid confusion):</font></font><br>
<br>
<pre><code class="plaintext hljs">snmp-server group snmpv3group v3 priv read snmpv3name <font></font>
snmp-server user snmpv3user snmpv3group v3 auth md5 md5v3v3v3 priv des des56v3v3v3<font></font>
snmp-server view snmpv3name iso included</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first line of snmp-server group - defines the group of SNMPv3 users (snmpv3group), read mode (read), and the right of access of the snmpv3group group to view certain branches of the monitoring object‚Äôs MIB tree (snmpv3name in the configuration below determines which branches of the MIB tree the group snmpv3group will be able to access).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second line is snmp-server user - defines the user snmpv3user, his membership in the snmpv3group group, as well as the use of authentication md5 (the password for md5 is md5v3v3v3) and encryption des (the password for des is des56v3v3v3). Of course, instead of des it is better to use aes, here I give it just as an example. Also, when defining a user, you can add an access list (ACL) that regulates the IP addresses of monitoring servers that have the right to monitor this device - this is also best practice, but I will not complicate our example.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The third line of snmp-server view defines the code name that sets the branches of the snmpv3name MIB tree so that the snmpv3group user group can request them. </font><font style="vertical-align: inherit;">ISO, instead of strictly defining a single branch, allows the snmpv3group user group to access all objects of the monitoring object‚Äôs MIB tree. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A similar configuration of Huawei equipment (also in the CLI) is as follows:</font></font><br>
<br>
<pre><code class="plaintext hljs">snmp-agent mib-view included snmpv3name iso<font></font>
snmp-agent group v3 snmpv3group privacy read-view snmpv3name<font></font>
snmp-agent usm-user v3 snmpv3user group snmpv3group<font></font>
snmp-agent usm-user v3 snmpv3user authentication-mode md5 <font></font>
            md5v3v3v3<font></font>
snmp-agent usm-user v3 snmpv3user privacy-mode des56<font></font>
            des56v3v3v3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After setting up network devices, you need to check access from the monitoring server via SNMPv3 protocol, I will use snmpwalk:</font></font><br>
<br>
<pre><code class="plaintext hljs">snmpwalk -v 3 -u snmpv3user -l authPriv -A md5v3v3v3 -a md5 -x des -X des56v3v3v3 10.10.10.252</code></pre><br>
<img src="https://habrastorage.org/webt/dj/zh/jt/djzhjtntle82d3erggwh-beglsq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A more visual tool for requesting specific OID objects using MIB files is snmpget: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iz/6n/2v/iz6n2vstdjeaxgsw2fhjqlcra3u.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's move on to setting up a typical data element for SNMPv3, as part of the Zabbix template. For simplicity and independence from the MIB, I use digital OIDs: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/aw/ig/-h/awig-hyentp_3pgvn3urihj7fye.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I use custom macros in key fields, because they will be the same for all data elements in the template. You can set them as part of the template if all network devices on your network have the same SNMPv3 parameters, or within the host if the SNMPv3 parameters for different monitoring objects are different: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/f7/ci/bp/f7cibpnkgslkyj7kq8spsekdi2k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Please note that the monitoring system only has a username and passwords for authentication and encryption . The user group and the area of ‚Äã‚ÄãMIB objects to which access is allowed is set on the monitoring object.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's move on to filling out the template.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbix survey template</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A simple rule when creating any survey templates is to make them as detailed as possible: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/fh/nc/am/fhncamsfgnhkd-h4dy8px17isq4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I pay great attention to inventory so that it is more convenient to work with a large network. </font><font style="vertical-align: inherit;">About this a little later, but for now - triggers:</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/g1/4g/mt/g14gmt7flcx9jhv8q8vgjnee4qe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For ease of visualization of triggers, their names contain system macros {HOST.CONN}, so that not only device names, but also IP addresses are displayed on the dashboard in the alert section, although this is more a matter of convenience than necessary. To determine the unavailability of the device, in addition to the usual echo request, I use the SNMP host unavailability check when the object is accessible via ICMP but does not respond to SNMP requests - this situation is possible, for example, when duplicating IP addresses on different devices, due to incorrectly configured firewalls, or incorrect SNMP settings on monitoring objects. If you use host access control only via ICMP, at the time of investigating incidents on the network, monitoring data may not appear, so their receipt must be controlled.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's move on to discovering network interfaces - for network equipment, this is the most important monitoring function. </font><font style="vertical-align: inherit;">Since there can be hundreds of interfaces on a network device, it is necessary to filter out unnecessary ones so as not to clutter up the visualization and clutter up the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I use the standard detection function for SNMP, with a large number of detectable parameters, for more flexible filtering:</font></font><br>
<br>
<pre><code class="plaintext hljs">discovery[{#IFDESCR},1.3.6.1.2.1.2.2.1.2,{#IFALIAS},1.3.6.1.2.1.31.1.1.1.18,{#IFADMINSTATUS},1.3.6.1.2.1.2.2.1.7]</code></pre><br>
<img src="https://habrastorage.org/webt/1m/vp/fu/1mvpfu0kalas5i-w-9uyb5-pk3s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this detection, you can filter network interfaces by their types, user descriptions ‚Äúdescription‚Äù, and administrative statuses of ports. </font><font style="vertical-align: inherit;">Filters and regular expressions for filtering in my case look as follows: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c1/z_/ym/c1z_ymi8yjcpt-cncmzdfdmynlq.png"><br>
 <br>
<img src="https://habrastorage.org/webt/et/wv/aj/etwvajeuy5h9jwx7bdwyocmhn1c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Upon detection, the following interfaces will be excluded:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manually disabled (adminstatus &lt;&gt; 1), thanks to IFADMINSTATUS;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not having a text description, thanks to IFALIAS;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">having * in the text description, thanks to IFALIAS;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">being official or technical thanks to IFDESCR (in my case, in regular expressions IFALIAS and IFDESCR are checked by one alias regular expression).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The SNMPv3 data collection template is almost ready. </font><font style="vertical-align: inherit;">We will not dwell on prototypes of data elements for network interfaces, we will move on to the results.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitoring results</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To begin with - an inventory of a small network: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bm/s0/h1/bms0h1txizz1lm_p9bdw3iwyvaa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you prepare templates for each series of network devices - you can achieve a convenient layout for analyzing the summary data on the current software, serial numbers, and notification of the arrival of a cleaning woman in the server (due to the small Uptime). </font><font style="vertical-align: inherit;">An excerpt from my list of templates is below: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/i8/ok/ju/i8okju-_mwfomxxj1quhf1eaifk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now - the main dashboard, with triggers distributed by severity level:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rs/cr/-t/rscr-tzx6tnsbpjqqnxwyfhu-qg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to an integrated approach to the templates for each model of devices in the network, it is possible to achieve the fact that within the framework of one monitoring system a tool will be organized for predicting malfunctions and accidents (if there are appropriate sensors and metrics). </font><font style="vertical-align: inherit;">Zabbix is ‚Äã‚Äãwell suited for monitoring network, server, service infrastructures, and the task of servicing network equipment clearly demonstrates its capabilities.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">List of sources used:</font></font></b><div class="spoiler_text">1. Hucaby D. CCNP Routing and Switching SWITCH 300-115 Official Cert Guide. Cisco Press, 2014. pp. 325-329.<br>
2. RFC 3410. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">tools.ietf.org/html/rfc3410</a><br>
3. RFC 3415. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">tools.ietf.org/html/rfc3415</a><br>
4. SNMP Configuration Guide, Cisco IOS XE Release 3SE. Chapter: SNMP Version 3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">www.cisco.com/c/en/us/td/docs/ios-xml/ios/snmp/configuration/xe-3se/3850/snmp-xe-3se-3850-book/nm-snmp-snmpv3.html</a><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495694/index.html">Mobile application reference service</a></li>
<li><a href="../en495696/index.html">How Prince of Persia Creator Overcomes Apple II's Memory Limits</a></li>
<li><a href="../en495698/index.html">Client-server architecture in pictures</a></li>
<li><a href="../en495700/index.html">Doom Boy ESP32</a></li>
<li><a href="../en495702/index.html">We study the Mediastreamer2 VoIP engine. Part 1</a></li>
<li><a href="../en495706/index.html">News from the world of OpenStreetMap No. 505 (03.17.2020-23.03.2020)</a></li>
<li><a href="../en495708/index.html">Openconnect emergency VPN server with two-factor authorization on Centos 8</a></li>
<li><a href="../en495712/index.html">We set development goals (in a bloody enterprise and not only)</a></li>
<li><a href="../en495716/index.html">Myths about learning foreign languages</a></li>
<li><a href="../en495718/index.html">Master JetBrains & ITMO: we continue to study intensively and announce an open day</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>