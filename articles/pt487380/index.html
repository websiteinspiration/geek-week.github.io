<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëê ü§æüèº üöª Otimiza√ß√£o massiva de consultas no PostgreSQL. Kirill Borovikov (tensor) üëåüèø üïú üôãüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O relat√≥rio apresenta algumas abordagens que permitem monitorar o desempenho das consultas SQL quando existem milh√µes por dia e centenas de servidores...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Otimiza√ß√£o massiva de consultas no PostgreSQL. Kirill Borovikov (tensor)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/487380/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O relat√≥rio apresenta algumas abordagens que permitem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monitorar o desempenho das consultas SQL quando existem milh√µes por dia</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e centenas de servidores PostgreSQL controlados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quais solu√ß√µes t√©cnicas nos permitem processar com efici√™ncia esse volume de informa√ß√µes e como facilita a vida de um desenvolvedor comum.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/5XKbFb-l5Do" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quem est√° interessado em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analisar problemas espec√≠ficos e v√°rias t√©cnicas para otimizar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consultas SQL e resolver problemas t√≠picos de DBA no PostgreSQL </font><font style="vertical-align: inherit;">? Voc√™ </font><font style="vertical-align: inherit;">tamb√©m pode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ler uma s√©rie de artigos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre este t√≥pico.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/rj/lq/ao/rjlqaolzkdl1dwerrz6q1f41exs.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Meu nome √© Kirill Borovikov, represento a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">empresa "Tensor"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Especificamente, sou especialista em trabalhar com bancos de dados em nossa empresa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje vou lhe dizer como estamos envolvidos na otimiza√ß√£o de consultas, quando voc√™ n√£o precisa "captar" o desempenho de uma √∫nica solicita√ß√£o, mas sim resolver o problema em massa. Quando existem milh√µes de solicita√ß√µes, e voc√™ precisa encontrar algumas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abordagens para resolver</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> esse grande problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o ‚Äútensor‚Äù para nossos milh√µes de clientes √© o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VLSI - nosso aplicativo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : uma rede social corporativa, solu√ß√µes de comunica√ß√£o por v√≠deo, para gerenciamento interno e externo de documentos, sistemas de contabilidade para contabilidade e armazenamento ... Ou seja, uma ‚Äúmega combina√ß√£o‚Äù para gerenciamento de neg√≥cios integrado, que s√£o mais de 100 projetos internos diferentes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantir que todos funcionem e se desenvolvam normalmente, temos 10 centros de desenvolvimento em todo o pa√≠s, eles t√™m mais de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000 desenvolvedores</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabalhamos com o PostgreSQL desde 2008 e acumulamos uma grande quantidade do que processamos - dados de clientes, estat√≠sticos, anal√≠ticos, dados de sistemas externos de informa√ß√£o - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais de 400 TB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Somente "em produ√ß√£o" existem cerca de 250 servidores e, no total, os servidores de banco de dados que monitoramos s√£o cerca de 1000. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dx/sb/ej/dxsbejtgor4d4qc7u1cpkmxptx8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL √© uma linguagem declarativa. Voc√™ descreve n√£o "como" algo deve funcionar, mas "o que" voc√™ deseja receber. O DBMS sabe como criar o JOIN - como conectar seus tablets, quais condi√ß√µes impor, o que ser√° indexado, o que n√£o ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguns DBMSs aceitam dicas: "N√£o, conecte esses dois tablets em tal e qual fila", mas o PostgreSQL n√£o. Esta √© a posi√ß√£o consciente dos principais desenvolvedores: "Melhor terminarmos o otimizador de consultas do que permitir que os desenvolvedores usem algum tipo de dica". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, apesar do PostgreSQL n√£o permitir que "fora" se controle, ele perfeitamente permite que voc√™ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">veja o que acontece "dentro"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> quando voc√™ executa sua consulta e onde ela apresenta problemas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k_/wc/q0/k_wcq0dayliwb4tturtbl3dmyre.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, com quais problemas cl√°ssicos o desenvolvedor [chega ao DBA] normalmente? "Aqui n√≥s cumprimos a solicita√ß√£o, e </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tudo √© lento</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tudo trava, algo acontece ... Algum tipo de problema!" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os motivos s√£o quase sempre os mesmos:</font></font><br>
<br>
<ul>
<li><b>  </b><br>
: ¬´   SQL  10   JOIN...¬ª ‚Äî  ,       ¬´¬ª,     .    ,       (10    FROM)   - . [<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>]</li>
<li><b> </b><br>
     PostgreSQL,     ¬´¬ª  ,   ‚Äî     ¬´¬ª  .       10 ,   10 ,  PostgreSQL      ,      . [<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>]</li>
<li><b>¬´¬ª  </b><br>
          ,     , ,   .  ‚Ä¶ -   ,       .</li>
<li><b></b><br>
 ,         (INSERT, UPDATE, DELETE) ‚Äî    .</li>
</ul><br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... E para todo o resto, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precisamos de um plano</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! Precisamos ver o que est√° acontecendo dentro do servidor. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c8/ni/rt/c8nirti-tkun1t6z4sxgpnwfwbw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O plano de execu√ß√£o de consultas para o PostgreSQL √© uma √°rvore do algoritmo de execu√ß√£o de consultas em uma representa√ß√£o textual. √â o algoritmo que, como resultado da an√°lise do planejador, foi reconhecido como o mais eficaz. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada n√≥ da √°rvore √© uma opera√ß√£o: extra√ß√£o de dados de uma tabela ou √≠ndice, constru√ß√£o de um bitmap, uni√£o de duas tabelas, uni√£o, interse√ß√£o ou elimina√ß√£o de amostras. O cumprimento da solicita√ß√£o √© uma passagem pelos n√≥s desta √°rvore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para obter um plano de consulta, a maneira mais f√°cil √© executar a instru√ß√£o </font></font><code>EXPLAIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Para obter todos os atributos reais, ou seja, execute uma consulta baseada em - </font></font><code>EXPLAIN (ANALYZE, BUFFERS) SELECT ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ponto negativo: quando voc√™ o executa, acontece "aqui e agora", portanto √© adequado apenas para depura√ß√£o local. Se voc√™ pegar um servidor com muita carga, que est√° sob um forte fluxo de altera√ß√µes de dados, e voc√™ v√™: ‚ÄúSim! Aqui, somos mais lentos com o </font><font style="vertical-align: inherit;">pedido de </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xia</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . " Meia hora, uma hora atr√°s - enquanto voc√™ estava executando e recebendo essa solicita√ß√£o dos logs, transportando-a novamente para o servidor, todos os dados e estat√≠sticas foram alterados. Voc√™ o executa para depurar - e corre rapidamente! E voc√™ n√£o pode entender o porqu√™, porque </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foi</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lento. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/-t/fu/y9-tfu3qhvhayjt86xoy02qy4ju.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender o que era exatamente no momento em que a solicita√ß√£o √© executada no servidor, as pessoas inteligentes escreveram o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√≥dulo auto_explain</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Est√° presente em quase todas as distribui√ß√µes mais comuns do PostgreSQL, e voc√™ pode simplesmente ativ√°-lo no arquivo de configura√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se ele entender que uma solicita√ß√£o est√° sendo executada por mais tempo do que a borda que voc√™ lhe disse, ele tira um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instant√¢neo do plano dessa solicita√ß√£o e os grava juntos em um log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qh/cs/c1/qhcsc15sgsaruhdj6ghcjggfz7c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo parece estar bem agora, vamos ao log e vemos l√° ... [passo de texto]. Mas n√£o podemos dizer nada sobre ele, exceto pelo fato de esse ser um excelente plano, porque foram necess√°rios 11ms para ser conclu√≠do. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo parece estar bem - mas nada est√° claro sobre o que realmente aconteceu. Al√©m do tempo total, n√£o vemos muito. Porque olhar para um texto simples como esse "latuha" √© geralmente amado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas mesmo que seja amado, embora desconfort√°vel, mas h√° mais problemas importantes:</font></font><br>
<br>
<ul>
<li>   <b>    </b>  .     ,       Index Scan    ‚Äî ,     -  .    ,    ¬´¬ª   , CTE ‚Äî     ¬´ ¬ª.</li>
<li> : ,    , ‚Äî  <b>   </b>.      , ,    ,  ,      loops ‚Äî   .         .    ,  ,        ,      ‚Äî - ¬´ ¬ª.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nessas circunst√¢ncias, entenda "Quem √© o elo mais fraco?" </font><font style="vertical-align: inherit;">quase irrealista. </font><font style="vertical-align: inherit;">Portanto, at√© os pr√≥prios desenvolvedores no "manual" escrevem que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Entender o plano √© uma arte que precisa ser aprendida, experimentada ..."</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas temos 1000 desenvolvedores e cada um deles n√£o passar√° essa experi√™ncia √† cabe√ßa. </font><font style="vertical-align: inherit;">Eu, voc√™, ele - eles sabem, e algu√©m ali - n√£o est√° mais l√°. </font><font style="vertical-align: inherit;">Talvez ele aprenda, ou talvez n√£o, mas ele precisa trabalhar agora - e onde ele conseguiria essa experi√™ncia.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planejar visualiza√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, percebemos que, para lidar com esses problemas, precisamos de uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boa visualiza√ß√£o do plano</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[artigo]</font></font></a><br>
<br>
<img src="https://habrastorage.org/webt/ev/nz/3g/evnz3gitzrva603ckfpd42ilzas.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Fomos os primeiros a ‚Äúdar uma volta no mercado‚Äù - vamos procurar na Internet o que existe em geral. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por√©m, descobriu-se que solu√ß√µes relativamente "vivas" que s√£o mais ou menos desenvolvidas, existem muito poucas - literalmente, uma coisa: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">explica.depesz.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de Hubert Lubaczewski. </font><font style="vertical-align: inherit;">Na entrada do campo "feed", uma representa√ß√£o textual do plano mostra uma placa com os dados analisados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempo de trabalho do n√≥ adequado</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempo total em toda a sub√°rvore</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o n√∫mero de registros recuperados e que era estatisticamente esperado</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o pr√≥prio corpo do n√≥</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este servi√ßo tamb√©m tem a capacidade de compartilhar o arquivo de links. Voc√™ jogou seu plano l√° e disse: "Ei, Vasya, aqui est√° um link para voc√™, algo est√° errado a√≠". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/td/ik/odtdikeo22jwnlaxmizq2jodns0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas existem alguns problemas menores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em primeiro lugar, uma enorme quantidade de copiar e colar. Voc√™ pega um peda√ßo do log, coloca-o l√° e de novo e de novo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em segundo lugar, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o h√° an√°lise da quantidade de dados lidos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - os pr√≥prios buffers que s√£o exibidos </font></font><code>EXPLAIN (ANALYZE, BUFFERS)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aqui n√£o vemos. Ele simplesmente n√£o sabe como desmontar, entender e trabalhar com eles. Quando voc√™ l√™ muitos dados e entende que pode "decompor" incorretamente em um disco e armazenar em cache na mem√≥ria, essas informa√ß√µes s√£o muito importantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O terceiro ponto negativo √© o desenvolvimento muito fraco deste projeto. Os commits s√£o muito pequenos, √© bom a cada seis meses e o c√≥digo em Perl.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d9/zu/o6/d9zuo6g5etaeqqdpfsozjtzv09c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas isso √© tudo "letra", algu√©m poderia de alguma forma viver com ela, mas h√° uma coisa que nos afastou desse servi√ßo. Estes s√£o erros de an√°lise Common Table Expression (CTE) e v√°rios n√≥s din√¢micos como InitPlan / SubPlan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ acredita nessa imagem, temos o tempo total de execu√ß√£o de cada n√≥ individual maior que o tempo total de execu√ß√£o de toda a solicita√ß√£o. √â simples - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o tempo de gera√ß√£o deste CTE n√£o foi subtra√≠do do n√≥ CTE Scan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Portanto, n√£o sabemos mais a resposta correta, quanto a pr√≥pria digitaliza√ß√£o CTE levou. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uj/gt/8a/ujgt8auhv331ek_visf6ew7jslq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o percebemos que era hora de escrever a nossa - viva! Cada desenvolvedor diz: "Agora vamos escrever nossos pr√≥prios, ser√° apenas super!"</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eles usaram uma pilha t√≠pica de servi√ßos da Web: o n√∫cleo do Node.js + Express, puxaram o Bootstrap e para belos diagramas - D3.js. </font><font style="vertical-align: inherit;">E nossas expectativas foram justificadas - recebemos o primeiro prot√≥tipo em duas semanas:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analisador de plano pr√≥prio</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ou seja, agora geralmente podemos analisar qualquer plano daqueles gerados pelo PostgreSQL.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an√°lise correta de n√≥s din√¢micos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - CTE Scan, InitPlan, SubPlan</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an√°lise da distribui√ß√£o de buffers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - onde s√£o lidas p√°ginas de dados da mem√≥ria, onde do cache local, onde do disco</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">visibilidade recebida</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Para que n√£o esteja "no registro" que est√° "cavando", mas que voc√™ veja o "link mais fraco" imediatamente na imagem.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/ou/gb/jf/ougbjf30wnktdmvhpqtjj6feqto.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos algo parecido com isto - imediatamente com destaque de sintaxe. Mas geralmente nossos desenvolvedores n√£o est√£o mais trabalhando com uma apresenta√ß√£o completa do plano, mas com uma apresenta√ß√£o mais curta. Afinal, j√° analisamos todos os d√≠gitos e os jogamos para a esquerda e para a direita e deixamos apenas a primeira linha no meio, que tipo de n√≥ √©: gera√ß√£o CTE Scan, CTE ou Seq Scan por algum tipo de etiqueta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa vis√£o abreviada √© o que chamamos de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modelo de plano</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zg/do/j_/zgdoj_caxmbjnyiq_gkiy0cfniw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que mais seria conveniente? Seria conveniente ver qual a propor√ß√£o de qual n√≥ do tempo total √© alocado para n√≥s - e apenas "travar" o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gr√°fico de pizza</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao lado </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apontamos para o n√≥ e vemos - conosco, verifica-se que o Seq Scan levou menos de um quarto do tempo todo e os restantes 3/4 fizeram o CTE Scan. Horror! Esta √© uma pequena observa√ß√£o sobre a "taxa de inc√™ndio" do CTE Scan, se voc√™ os usar ativamente em suas consultas. Eles n√£o s√£o muito r√°pidos - eles perdem mesmo para a varredura de tabela usual. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[artigo] </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[artigo]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mas, geralmente, esses diagramas s√£o mais interessantes, mais complicados quando apontamos imediatamente para um segmento e vemos, por exemplo, que mais da metade do tempo todo, algumas Seq Scan ‚Äúcomiam‚Äù. Al√©m disso, havia algum tipo de filtro dentro, v√°rios registros foram lan√ßados nele ... Voc√™ pode enviar essa foto diretamente para o desenvolvedor e dizer: ‚ÄúVasya, tudo est√° ruim com voc√™ aqui! Entenda, olhe - algo est√° errado! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ul/4i/2q/ul4i2q_4iasvokxfdcwp7jd9tj0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naturalmente, houve um "ancinho".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira coisa em que "pisaram" √© o problema do arredondamento. O tempo do n√≥ de cada indiv√≠duo no plano √© indicado com uma precis√£o de 1 Œºs. E quando o n√∫mero de ciclos de n√≥s excede, por exemplo, 1000 - ap√≥s a execu√ß√£o, o PostgreSQL o dividiu "at√©", ent√£o, no c√°lculo reverso, obtemos o tempo total "em algum lugar entre 0,95 ms e 1,05 ms". Quando a conta √© gasta em microssegundos - nada ainda, mas j√° h√° [mili] segundos - √© necess√°rio levar essas informa√ß√µes em considera√ß√£o ao "desatar" recursos nos n√≥s do plano "quem consumiu quem consumiu quem". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fp/ds/f9/fpdsf9qkt6t_0q810uqhmrivc-k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo ponto, mais complexo, √© a distribui√ß√£o de recursos (esses mesmos buffers) entre n√≥s din√¢micos. Isso nos custou as primeiras 2 semanas no prot√≥tipo mais o plus da semana 4.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conseguir esse problema √© bastante simples - criamos um CTE e supostamente estamos lendo algo nele. De fato, o PostgreSQL √© inteligente e n√£o l√™ nada aqui. Ent√£o pegamos o primeiro registro dele, e os primeiros cem do mesmo CTE. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s5/fv/rg/s5fvrgut9bky4uqjgmawpm97ks4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s olhamos para o plano e entendemos - estranho, temos 3 buffers (p√°ginas de dados) "consumidos" no Seq Scan, outro 1 no CTE Scan e mais 2 no segundo CTE Scan. Ou seja, se tudo √© simplesmente resumido, obtemos 6, mas da placa lemos apenas 3! O CTE Scan n√£o l√™ nada de qualquer lugar, mas trabalha diretamente com a mem√≥ria do processo. Ou seja, h√° claramente algo errado aqui! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, verifica-se que aqui todas as 3 p√°ginas de dados solicitadas √† Seq Scan, primeiro 1 solicitou a 1¬™ CTE Scan e, em seguida, a 2¬™, e elas leram outras 2. Ou seja, 3 p√°ginas foram lidas no total dados, n√£o 6.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3q/5q/nh/3q5qnhygdtg3fh1os2fa-1kixhg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E essa imagem nos levou a entender que a implementa√ß√£o do plano n√£o √© mais uma √°rvore, mas apenas algum tipo de gr√°fico ac√≠clico. </font><font style="vertical-align: inherit;">E n√≥s temos um gr√°fico como este para entendermos "de onde ele veio". </font><font style="vertical-align: inherit;">Ou seja, aqui criamos um CTE a partir de pg_class e o solicitamos duas vezes, e quase o tempo todo nos levou ao ramo quando solicitamos pela segunda vez. </font><font style="vertical-align: inherit;">√â claro que ler o 101¬∫ registro √© muito mais caro do que apenas o 1¬∫ do tablet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yg/kx/3o/ygkx3o3reytihnn6mkhyys3j7l8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s expiramos por um tempo. </font><font style="vertical-align: inherit;">Eles disseram: ‚ÄúAgora, Neo, voc√™ sabe kung fu! </font><font style="vertical-align: inherit;">Agora nossa experi√™ncia est√° na sua tela. </font><font style="vertical-align: inherit;">Agora voc√™ pode us√°-lo. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[artigo]</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consolida√ß√£o de log</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nossos 1000 desenvolvedores deram um suspiro de al√≠vio. Mas entendemos que s√≥ temos centenas de servidores de "batalha" e toda essa "copiar e colar" pelos desenvolvedores n√£o √© de todo conveniente. Percebemos que precis√°vamos colet√°-lo n√≥s mesmos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jl/1t/od/jl1todhk17wci0h_ekudinbrruw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, existe um m√≥dulo regular que pode coletar estat√≠sticas; no entanto, ele tamb√©m precisa ser ativado na configura√ß√£o - este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© o m√≥dulo pg_stat_statements</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mas ele n√£o nos convinha. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em primeiro lugar, ele atribui </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QueryId diferente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √†s mesmas consultas em diferentes esquemas no mesmo banco de dados </font><font style="vertical-align: inherit;">. Ou seja, se voc√™ fizer primeiro </font></font><code>SET search_path = '01'; SELECT * FROM user LIMIT 1;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e depois </font></font><code>SET search_path = '02';</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a mesma solicita√ß√£o, as estat√≠sticas deste m√≥dulo ter√£o entradas diferentes e n√£o poderei coletar estat√≠sticas gerais precisamente no contexto desse perfil de solicita√ß√£o, sem levar em considera√ß√£o os esquemas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo ponto que nos impediu de us√°-lo √© a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falta de planos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ou seja, n√£o h√° plano, apenas a solicita√ß√£o em si. Vemos o que estava desacelerando, mas n√£o entendemos o porqu√™. E aqui voltamos ao problema de um conjunto de dados que muda rapidamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o √∫ltimo ponto √© a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falta de "fatos"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ou seja, √© imposs√≠vel resolver uma inst√¢ncia espec√≠fica de execu√ß√£o de consulta - ela n√£o existe, existem apenas estat√≠sticas agregadas. Embora seja poss√≠vel trabalhar com isso, √© simplesmente muito dif√≠cil. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7x/sr/ij/7xsrijw56i20-dz5oiw0hurx9aq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por isso, decidimos combater o ‚Äúcopiar e colar‚Äù e come√ßamos a escrever um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">colecionador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O coletor √© conectado via SSH, "puxa" uma conex√£o segura para o servidor com o banco de dados usando o certificado e </font></font><code>tail -F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"se apega" ao arquivo de log. Ent√£o nesta sess√£o</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtemos um "espelho" completo de todo o arquivo de log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que o servidor gera. A carga no pr√≥prio servidor √© m√≠nima, porque n√£o analisamos nada l√°, simplesmente espelhamos o tr√°fego. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como j√° come√ßamos a escrever a interface no Node.js, continuamos a escrever o coletor. E essa tecnologia valeu a pena, porque √© muito conveniente usar JavaScript para trabalhar com dados de texto mal formatados, que √© o log. E a pr√≥pria infraestrutura do Node.js. como plataforma de back-end permite que voc√™ trabalhe f√°cil e convenientemente com conex√µes de rede e, de fato, com algum tipo de fluxo de dados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dessa forma, "puxamos" duas conex√µes: a primeira √© "ouvir" o pr√≥prio log e lev√°-lo para n√≥s mesmos, e a segunda √© perguntar periodicamente ao banco de dados. "Mas no log chegou que a placa com oid 123 estava bloqueada", mas n√£o diz nada ao desenvolvedor, e seria bom perguntar ao banco de dados "afinal, o que √© OID = 123?" Por isso, solicitamos periodicamente √† base algo que ainda n√£o sabemos em casa. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/vi/ft/gtviftgv1xepi43a7dayhn5-kxy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Voc√™ simplesmente n√£o levou em considera√ß√£o, existe uma esp√©cie de abelha parecida com um elefante!" Come√ßamos a desenvolver esse sistema quando quer√≠amos monitorar 10 servidores. O mais cr√≠tico em nosso entendimento, sobre o qual houve alguns problemas dif√≠ceis de lidar. Por√©m, durante o primeiro trimestre, conseguimos cem para monitorar - porque o sistema "entrou", todo mundo queria, todo mundo estava confort√°vel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo isso deve ser adicionado, o fluxo de dados √© grande, ativo. Na verdade, monitoramos com o que somos capazes de lidar - depois usamos. Tamb√©m usamos o PostgreSQL como um data warehouse. Mas nada √© mais r√°pido para "derramar" dados nele do que </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ainda n√£o h√° </font><font style="vertical-align: inherit;">operador </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas apenas "derramar" os dados n√£o √© realmente a nossa tecnologia. Como se voc√™ tiver cerca de 50 mil solicita√ß√µes por segundo em uma centena de servidores, isso gerar√° 100-150 GB de logs por dia para voc√™. Portanto, tivemos que "serrar" cuidadosamente a base. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, fizemos o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">particionamento todos os dias</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque, em geral, ningu√©m est√° interessado na correla√ß√£o entre os dias. Qual √© a diferen√ßa que voc√™ teve ontem, se hoje √† noite voc√™ lan√ßou uma nova vers√£o do aplicativo - e j√° algumas novas estat√≠sticas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em segundo lugar, aprendemos (fomos for√ßados) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a escrever muito, muito rapidamente usando</font></font><code>COPY</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ou seja, n√£o apenas </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">porque √© mais r√°pido que </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas ainda mais r√°pido. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rm/ik/nj/rmiknjdu2ydi-yrbk7v369qe8eu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O terceiro ponto - tive </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que abandonar os gatilhos, respectivamente, e da Foreign Keys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ou seja, n√£o temos integridade absolutamente referencial. Porque se voc√™ possui uma tabela na qual existe um par de FK e diz na estrutura do banco de dados que ‚Äúaqui est√° uma entrada de log refere-se a FK, por exemplo, um grupo de registros‚Äù, quando voc√™ a insere, o PostgreSQL n√£o tem nada a fazer, exceto como tomar e executar honestamente </font></font><code>SELECT 1 FROM master_fk1_table WHERE ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com o identificador que voc√™ est√° tentando inserir - apenas para verificar se essa entrada existe, se voc√™ n√£o est√° "interrompendo" essa chave estrangeira com sua inser√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez de um registro na tabela de destino e seus √≠ndices, obtemos mais uma leitura de todas as tabelas √†s quais ele se refere. E n√£o precisamos disso: nossa tarefa √© escrever o m√°ximo poss√≠vel e o mais r√°pido poss√≠vel, com o m√≠nimo de carga. Ent√£o FK - baixo! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥ximo ponto √© agrega√ß√£o e hash. Inicialmente, eles foram implementados em nosso banco de dados - afinal, √© conveniente, imediatamente, quando uma grava√ß√£o chegar, fazer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"mais um"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em algum tipo de placa </font><b><font style="vertical-align: inherit;">diretamente no gatilho</font></b><font style="vertical-align: inherit;"> . √â bom, conveniente, mas a mesma coisa √© ruim - insira um registro, mas voc√™ √© obrigado a ler e escrever outra coisa de outra tabela. Al√©m disso, n√£o apenas isso, leia e escreva - e tamb√©m fa√ßa isso sempre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora imagine que voc√™ tem uma placa na qual simplesmente conta o n√∫mero de solicita√ß√µes que passaram em um host espec√≠fico:</font></font><code>+1, +1, +1, ..., +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. E voc√™, em princ√≠pio, n√£o precisa disso - tudo isso pode ser </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resumido na mem√≥ria do coletor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e enviado ao banco de dados de cada vez </font></font><code>+10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sim, sua integridade l√≥gica pode "desmoronar" no caso de alguns problemas, mas esse √© um caso quase irreal - porque voc√™ tem um servidor normal, ele possui uma bateria no controlador, um log de transa√ß√µes, um log no sistema de arquivos ... Em geral, n√£o Vale a pena. N√£o vale a pena a perda de produtividade que voc√™ obt√©m devido ao trabalho de gatilhos / FK, os custos incorridos ao mesmo tempo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A mesma coisa com hash. Uma certa solicita√ß√£o voa para voc√™, voc√™ calcula um determinado identificador do banco de dados, escreve no banco de dados e depois diz a todos. Tudo est√° bem, at√© que, no momento da grava√ß√£o, uma segunda pessoa chega at√© voc√™ que deseja grav√°-la - e voc√™ tem uma trava, e isso j√° √© ruim. Portanto, se voc√™ pode remover a gera√ß√£o de alguns IDs no cliente (em rela√ß√£o ao banco de dados), √© melhor fazer isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âramos apenas ideais para usar o MD5 a partir do texto - uma solicita√ß√£o, plano, modelo, ... Calculamos no lado do coletor e ‚Äúdespejamos‚Äù o ID j√° preparado no banco de dados. O comprimento do MD5 e o particionamento di√°rio nos permitem n√£o se preocupar com poss√≠veis colis√µes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/yz/uz/3cyzuzpcxxmshllydd9cjcclc9i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, para gravar tudo isso rapidamente, precis√°vamos modificar o pr√≥prio procedimento de grava√ß√£o.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ costuma escrever dados? Temos algum tipo de conjunto de dados, decompomos-o em v√°rias tabelas e depois COPY - primeiro na primeira, depois na segunda, na terceira ... √â inconveniente, porque meio que escrevemos um fluxo de dados em tr√™s etapas seq√ºencialmente. Desagrad√°vel. √â poss√≠vel fazer mais r√°pido? Pode! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, basta decompor esses fluxos em paralelo. Acontece que temos erros, solicita√ß√µes, modelos, bloqueios, voando em fluxos separados ... - e escrevemos tudo em paralelo. Para fazer isso, basta </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manter o canal COPY permanentemente aberto em cada tabela de destino individual</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/v_/0z/vvv_0zw3lqqoqoznvaaqpvm19wq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, o coletor </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sempre tem um fluxo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em que posso escrever os dados necess√°rios. Mas para que o banco de dados veja esses dados e algu√©m n√£o fique travado nos bloqueios, aguardando a grava√ß√£o desses dados, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COPY deve ser interrompido em uma determinada frequ√™ncia</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para n√≥s, um per√≠odo da ordem de 100ms acabou sendo o mais eficaz - feche e abra-o imediatamente novamente na mesma mesa. E se n√£o temos um fluxo em alguns picos, fazemos o pool para um determinado limite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, descobrimos que, para esse perfil de carga, qualquer agrega√ß√£o quando os registros s√£o coletados em pacotes √© ruim. O mal cl√°ssico est√° </font></font><code>INSERT ... VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al√©m de 1000 registros. Porque neste momento voc√™ tem um pico de grava√ß√£o na m√≠dia, e todos os outros que est√£o tentando gravar algo no disco aguardam.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para se livrar de tais anomalias, simplesmente n√£o agregue nada, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o fa√ßa buffer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">E se ocorrer buffer no disco (felizmente, a API Stream no Node.js permite que voc√™ descubra) - adie essa conex√£o. </font><font style="vertical-align: inherit;">√â quando o evento chega at√© voc√™, que √© gratuito novamente - escreva para ele a partir da fila acumulada. </font><font style="vertical-align: inherit;">Enquanto isso, est√° ocupado - pegue o pr√≥ximo de gra√ßa da piscina e escreva para ele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de implementar essa abordagem para a grava√ß√£o de dados, t√≠nhamos aproximadamente opera√ß√µes de grava√ß√£o em 4K e, dessa forma, reduzimos a carga em 4 vezes. </font><font style="vertical-align: inherit;">Agora eles cresceram mais 6 vezes devido a novas bases observ√°veis ‚Äã‚Äã- at√© 100 MB / s. </font><font style="vertical-align: inherit;">E agora armazenamos logs nos √∫ltimos 3 meses no valor de 10 a 15 TB, esperando que em apenas tr√™s meses qualquer desenvolvedor possa resolver qualquer problema.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entendemos os problemas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas apenas a coleta de todos esses dados √© bom, √∫til, apropriado, mas n√£o suficiente - √© preciso entend√™-los. </font><font style="vertical-align: inherit;">Porque s√£o milh√µes de planos diferentes por dia. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j6/kw/jg/j6kwjgsvci1xw-p_vgxpnq6ynag.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas milh√µes s√£o incontrol√°veis, voc√™ deve primeiro fazer "menos". </font><font style="vertical-align: inherit;">E, antes de tudo, √© necess√°rio decidir como voc√™ organizar√° esse "menor". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Identificamos para n√≥s tr√™s pontos-chave:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enviou essa solicita√ß√£o, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ou seja, de qual aplicativo ele "voou": interface da web, back-end, sistema de pagamento ou algo mais.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onde</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> isso aconteceu </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em qual servidor espec√≠fico. </font><font style="vertical-align: inherit;">Como se voc√™ tiver v√°rios servidores em um aplicativo e, de repente, um "embotado" (porque o "disco apodreceu", "a mem√≥ria vazou", outros problemas), ser√° necess√°rio abordar especificamente o servidor.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problema se manifestou de uma maneira ou de outra</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender ‚Äúquem‚Äù nos enviou a solicita√ß√£o, usamos uma ferramenta regular - definindo uma vari√°vel de sess√£o: </font></font><code>SET application_name = '{bl-host}:{bl-method}';</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- envie o nome do host da l√≥gica de neg√≥cios a partir da qual a solicita√ß√£o √© feita e o nome do m√©todo ou aplicativo que a iniciou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de passarmos o "propriet√°rio" da solicita√ß√£o, ela deve ser exibida no log - para isso, configuramos a vari√°vel </font></font><code>log_line_prefix = ' %m [%p:%v] [%d] %r %a'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Qualquer pessoa interessada pode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ver no manual o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que isso tudo significa. </font><font style="vertical-align: inherit;">Acontece que vemos no log:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tempo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identificadores de processo e transa√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nome base</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP da pessoa que enviou esta solicita√ß√£o</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e nome do m√©todo</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/9d/ms/_c/9dms_cgsmfbpgjiyndalqfyadf8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o percebemos que n√£o √© muito interessante observar a correla√ß√£o de uma solicita√ß√£o entre servidores diferentes. Isso acontece com pouca frequ√™ncia quando voc√™ tem um aplicativo que craps igualmente aqui e ali. Mas, mesmo que seja o mesmo, observe qualquer um desses servidores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a se√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúum servidor - um dia‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acabou sendo suficiente para qualquer an√°lise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira se√ß√£o anal√≠tica √© o pr√≥prio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"modelo"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - uma forma abreviada de apresenta√ß√£o do plano, livre de todos os indicadores num√©ricos. A segunda se√ß√£o √© o aplicativo ou m√©todo, e a terceira √© o n√≥ espec√≠fico do plano que nos causou problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando passamos de inst√¢ncias espec√≠ficas para modelos, recebemos imediatamente duas vantagens:</font></font><br>
<br>
<ul>
<li><b>     </b><br>
         ,    .</li>
<li><b></b><br>
 ,  ¬´¬ª   - ,       .     ,     -  , ,   ,    ‚Äî   ,  ,     ‚Äî     , ,      .    ,  ,  .</li>
</ul><br>
<br>
<img src="https://habrastorage.org/webt/_1/gb/is/_1gbissbzxhnibnhpb5kb5ebuuu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O restante dos m√©todos se baseia nos indicadores que extra√≠mos do plano: quantas vezes esse padr√£o ocorreu, o tempo total e m√©dio, quantos dados foram lidos no disco e quanto da mem√≥ria ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™, por exemplo, acessa a p√°gina de an√°lise por host, consulte - algo demais no disco para ler o come√ßo. O disco no servidor n√£o lida - e quem l√™ a partir dele? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E voc√™ pode classificar por qualquer coluna e decidir com o que ir√° lidar agora - com a carga no processador ou no disco ou com o n√∫mero total de solicita√ß√µes ... Classificadas, com apar√™ncia de "superior", reparadas - lan√ßaram uma nova vers√£o do aplicativo. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[v√≠deo aula]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
E imediatamente voc√™ pode ver diferentes aplicativos que v√™m com o mesmo modelo de uma solicita√ß√£o como</font></font><code>SELECT * FROM users WHERE login = 'Vasya'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Front-end, back-end, processamento ... E voc√™ se pergunta por que o usu√°rio deve ler o processamento se n√£o interagir com ele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O caminho oposto √© ver imediatamente a partir do aplicativo o que est√° fazendo. Por exemplo, um frontend √© isso, isso, isso e isso uma vez por hora (apenas a linha do tempo ajuda). E imediatamente surge a pergunta - parece que n√£o √© da conta do front-end fazer algo uma vez por hora ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z7/z-/4n/z7z-4nvcqjd8xktjpl1ilja63eo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de algum tempo, percebemos que n√£o t√≠nhamos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estat√≠sticas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agregadas </font><b><font style="vertical-align: inherit;">em termos de n√≥s do plano</font></b><font style="vertical-align: inherit;"> . Isolamos dos planos apenas os n√≥s que fazem algo com os dados das pr√≥prias tabelas (os l√™ / escreve por √≠ndice ou n√£o). De fato, em rela√ß√£o √† figura anterior, apenas um aspecto √© adicionado - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quantos registros esse n√≥ trouxe para n√≥s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e quantos foram descartados (linhas removidas pelo filtro).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ n√£o tem um √≠ndice adequado na placa, faz um pedido, ele passa al√©m do √≠ndice, cai na Seq Scan ... voc√™ filtrou todos os registros, exceto um. E por que voc√™ precisa de 100 milh√µes de registros filtrados por dia, √© melhor rolar o √≠ndice? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tk/bw/j9/tkbwj9b2v1gmeifbmblipiya86q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de examinar todos os planos por n√≥s, percebemos que existem algumas estruturas t√≠picas nos planos que provavelmente parecer√£o suspeitas. E seria bom dizer ao desenvolvedor: ‚ÄúAmigo, aqui voc√™ primeiro l√™ por √≠ndice, depois classifica e depois corta‚Äù - como regra, h√° um registro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo mundo que escreveu consultas com esse padr√£o provavelmente se deparou com: "D√™-me a √∫ltima ordem para Vasya, a data dele". E se voc√™ n√£o tiver um √≠ndice por data ou o √≠ndice usado n√£o tiver uma data, siga exatamente esse "rake" e prossiga. .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas sabemos que esse √© um "rake" - ent√£o por que n√£o dizer imediatamente ao desenvolvedor o que ele deve fazer? </font><font style="vertical-align: inherit;">Assim, abrindo o plano agora, nosso desenvolvedor imediatamente v√™ uma bela imagem com avisos, onde √© imediatamente informado: "Voc√™ tem problemas aqui e aqui, mas eles s√£o resolvidos dessa maneira". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, a quantidade de experi√™ncia necess√°ria para resolver problemas no in√≠cio e agora caiu significativamente. </font><font style="vertical-align: inherit;">Aqui n√≥s temos essa ferramenta.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/1g/g6/si1gg6ffbtpgsb3q2ew_cgudqa4.jpeg"></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt487380/">https://habr.com/ru/post/pt487380/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt487370/index.html">An√°lise do mercado imobili√°rio com base em dados de msgr.ru</a></li>
<li><a href="../pt487372/index.html">Certificado IBM Data Science Professional certificado</a></li>
<li><a href="../pt487374/index.html">Paul Graham: Problemas na moda</a></li>
<li><a href="../pt487376/index.html">10 recursos angulares √∫teis que voc√™ perdeu</a></li>
<li><a href="../pt487378/index.html">Melhores servidores para pequenas empresas em 2020</a></li>
<li><a href="../pt487384/index.html">Profiss√£o: desenvolvedor front-end</a></li>
<li><a href="../pt487386/index.html">Lista de verifica√ß√£o de adapta√ß√£o como uma ferramenta de entrada suave</a></li>
<li><a href="../pt487388/index.html">Desenvolvimento natural: como passar do e-learning para a gest√£o do conhecimento</a></li>
<li><a href="../pt487390/index.html">Componentes da Web sem Shadow DOM</a></li>
<li><a href="../pt487392/index.html">O que a Magnet deseja saber sobre seus clientes?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>