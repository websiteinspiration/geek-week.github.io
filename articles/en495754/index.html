<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♠️ 👤 🙃 Sim-sim open or reverse engineering smart intercom 🧓🏾 🧔🏽 👩🏼‍🤝‍👩🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading the post KrupnikasThere was an idea to deal with mitmproxy and see how the backend of daily used mobile applications is arranged. The ch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sim-sim open or reverse engineering smart intercom</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495754/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After reading the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">post</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Krupnikas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There was an idea to deal with mitmproxy and see how the backend of daily used mobile applications is arranged. </font><font style="vertical-align: inherit;">The choice fell on the intercom application. </font><font style="vertical-align: inherit;">After authorization, it allows you to open doors and answer video calls. </font><font style="vertical-align: inherit;">What came of this and what holes I managed to find I will tell under the cut.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cd/rc/hu/cdrchuiued3otgzhrka3gqtgdqa.jpeg"></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proxy settings</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To analyze traffic, an approach called a man in the middle is often used. It consists in the fact that when connected to a local network, traffic from the analyzed device first goes to the computer on which it is decrypted and analyzed, and then it is encrypted back and sent to the server. To decrypt traffic, the most popular is the mitmproxy program. Installing mitmproxy was not a big deal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To view traffic from a mobile device, you need to connect to your home wifi from your phone and computer. </font><font style="vertical-align: inherit;">Install mitmproxy on the computer and run. </font><font style="vertical-align: inherit;">On the phone in the wifi settings, set the local address and computer port as a proxy server. </font><font style="vertical-align: inherit;">Next, go to mitm.it from the phone and install a certificate that allows you to decrypt https requests. </font><font style="vertical-align: inherit;">After these steps, requests from the browser became visible. </font><font style="vertical-align: inherit;">Hooray! </font><font style="vertical-align: inherit;">However, the next step was disappointment:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ot/7e/jsot7e1q5qkrqftcgvxvwy2h1mq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">google</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> search led to an open issue on the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">github</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It turned out that, starting with API Level 24, applications no longer trust user certificates. </font><font style="vertical-align: inherit;">Fortunately, you can get around this by unzipping apk and adding the following config to AndroidManifest.xml:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">network-security-config</span>&gt;</span>  
     <span class="hljs-tag">&lt;<span class="hljs-name">debug-overrides</span>&gt;</span>  
          <span class="hljs-tag">&lt;<span class="hljs-name">trust-anchors</span>&gt;</span>  
               <span class="hljs-comment">&lt;!-- Trust preinstalled CAs --&gt;</span>  
               <span class="hljs-tag">&lt;<span class="hljs-name">certificates</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"system"</span> /&gt;</span>  
               <span class="hljs-comment">&lt;!-- Additionally trust user added CAs --&gt;</span>  
               <span class="hljs-tag">&lt;<span class="hljs-name">certificates</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"user"</span> /&gt;</span>  
          <span class="hljs-tag">&lt;/<span class="hljs-name">trust-anchors</span>&gt;</span>  
     <span class="hljs-tag">&lt;/<span class="hljs-name">debug-overrides</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">network-security-config</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, there is a ready-made </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the github </font><font style="vertical-align: inherit;">that does this automatically. </font><font style="vertical-align: inherit;">So, download apk, patch script, set the adb install command and voila everything works.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traffic analysis</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that requests are made to addresses of the form:</font></font><br>
<br>
<pre><code class="bash hljs">https://{intercom-company-url}/api/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two parameters are passed in the header: </font></font><br>
<pre><code class="python hljs"><span class="hljs-string">'api-version'</span>: <span class="hljs-string">'2'</span>,
<span class="hljs-string">'authorization'</span>:&nbsp; <span class="hljs-string">'Bearer&nbsp;your.jwt.token’
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first parameter is the api version, and the second is the authorization token. </font><font style="vertical-align: inherit;">For authorization, a json web token is used, which consists of three parts: the header, payload and signature. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decode it with the command:</font></font><br>
<br>
<pre><code class="bash hljs">pyjwt decode --no-verify your.jwt.token
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
see that payload contains account_id and exp. </font><font style="vertical-align: inherit;">The exp field corresponds to the time the token was created, which allows you to generate tokens for different devices from one account. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most interesting for us are requests for a list of available intercoms and opening doors. </font><font style="vertical-align: inherit;">When sending a request (I used python and the requests library) to</font></font><br>
<br>
<pre><code class="bash hljs">https://{intercom-company-url}/api/customers/properties/{account_id}/intercoms 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get json containing a list of doorphones with fields:</font></font><br>
<br>
<pre><code class="json hljs">[<font></font>
    {<font></font>
        'id': ID,<font></font>
        'mode': MODE, <font></font>
        'sip_account': {'ex_user': USER_ID, 'proxy': PROXY,  'password': PSWD}, <font></font>
        'video': [{'quality': 'low', 'source': 'rtsp:<span class="hljs-comment">//LINK }]</span><font></font>
    }<font></font>
]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In json id - doorphone identifier, mode - which door can be opened (possible values ​​are one_door, left_door, right_door), sip account and a link to the video broadcast. Wow! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using the session initiation protocol (sip), video calls are made through the intercom. In the sip_account field we received id'shniki and passwords for intercoms to which our account has access. Calling them all the same does not work, since they are on the internal network. But the video field is interesting. It contains an external link to broadcast video from the camera. It is enough to open vlc, copy the link and you can look around the clock on the doorphone camera. It’s not good to scatter such links! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we will figure out how to open the door. When you click on the door open button, the application sends a get request:</font></font><br>
<br>
<pre><code class="bash hljs">https://{intercom-company-url}/api/customers/intercoms/{intercom_id}/unlock?door=left_door&amp;id={intercom_id}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out that the presence or absence of the id parameter does not affect anything, but door allows in the case of a doorphone with two doors to open not only your own, but also the next door of your choice. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sim-sim open!</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having figured out the api, I decided to do something useful. </font><font style="vertical-align: inherit;">The result is an Android application that recognizes voice commands, and when it recognizes predefined commands like “sim-sim open,” it sends a request to open the corresponding door.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A smart intercom is good, but a safe and smart intercom is even better.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495732/index.html"># 03 - And a whole byte is not enough ... | 2B or not 2B</a></li>
<li><a href="../en495740/index.html">As we for a week without money, connections and software launched a food delivery service and almost did not screw up</a></li>
<li><a href="../en495746/index.html">We form View in SwiftUI, proceeding from conditions</a></li>
<li><a href="../en495748/index.html">New Punto Switcher for linux: xswitcher</a></li>
<li><a href="../en495752/index.html">When will the pandemic decline? Evaluating in Python with Pandas</a></li>
<li><a href="../en495756/index.html">Key principles for using ECS ​​in game development</a></li>
<li><a href="../en495758/index.html">Fires and Strategy</a></li>
<li><a href="../en495760/index.html">Brighter than the Stars: HGST rebranding and replenishment of the Ultrastar line</a></li>
<li><a href="../en495762/index.html">Prosto: remove boilerplate when working with RecyclerView</a></li>
<li><a href="../en495764/index.html">CSI Linux: linux distribution for cyber investigations and OSINT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>