<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🤝‍👨🏿 🎯 🎨 Y nuevamente sobre incrustado: buscando errores en el proyecto Embox 👩‍🎓 👩🏾‍🔧 👩🏾‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Embox es un sistema operativo multiplataforma y multitarea en tiempo real para sistemas integrados. Está diseñado para funcionar en recursos informáti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Y nuevamente sobre incrustado: buscando errores en el proyecto Embox</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/499986/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/20f/e3c/e6220fe3c8d556e40580a1cf49eab7cb.png" alt="Figura 2"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embox es un sistema operativo multiplataforma y multitarea en tiempo real para sistemas integrados. Está diseñado para funcionar en recursos informáticos bajos y le permite ejecutar aplicaciones basadas en Linux en microcontroladores sin usar Linux. Por supuesto, como cualquier otra aplicación, los errores de Embox tampoco están exentos. Este artículo está dedicado al análisis de errores encontrados en el código del proyecto Embox.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace unos meses, ya escribí </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un artículo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre la verificación de FreeRTOS, otro sistema operativo para sistemas integrados. </font><font style="vertical-align: inherit;">Entonces no encontré errores, pero los encontré en bibliotecas agregadas por los chicos de Amazon al desarrollar su propia versión de FreeRTOS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El artículo que ves ahora frente a ti, en cierto sentido, continúa con el tema del anterior. </font><font style="vertical-align: inherit;">A menudo recibimos solicitudes para verificar FreeRTOS, y lo hicimos. </font><font style="vertical-align: inherit;">Esta vez, no hubo solicitudes para verificar un proyecto específico, pero comencé a recibir cartas y comentarios de desarrolladores integrados a quienes les gustó y quieren más. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, el nuevo número de PVS-Studio para la revista Embedded ha madurado y yace ante ti. </font><font style="vertical-align: inherit;">¡Disfruto ver!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Análisis</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El análisis se llevó a cabo utilizando PVS-Studio, un analizador de código estático para C, C ++, C # y Java. Antes del análisis, el proyecto debe ensamblarse, por lo que nos aseguraremos de que el código del proyecto funcione y también le daremos al analizador la oportunidad de recopilar la información de ensamblaje que puede ser útil para una mejor verificación del código. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las instrucciones en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repositorio oficial de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Embox ofrecen la capacidad de construir bajo diferentes sistemas (Arch Linux, macOS, Debian) y usar Docker. Decidí agregar algo de variedad a mi vida y construir y analizar desde Debian, que instalé recientemente en mi máquina virtual.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La asamblea fue sin problemas. </font><font style="vertical-align: inherit;">Ahora era necesario realizar un análisis. </font><font style="vertical-align: inherit;">Debian es uno de los sistemas basados ​​en Linux PVS-Studio compatibles. </font><font style="vertical-align: inherit;">Una forma conveniente de verificar proyectos desde Linux es compilar el seguimiento. </font><font style="vertical-align: inherit;">Este es un modo especial en el que el analizador recopila toda la información necesaria sobre el ensamblaje para que luego pueda comenzar el análisis con un solo clic. </font><font style="vertical-align: inherit;">Todo lo que necesitaba hacer era: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Descargar e instalar PVS-Studio; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Inicie el seguimiento del ensamblaje yendo a la carpeta con Embox y escribiendo en el terminal</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -- make</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Después de esperar a que se complete el ensamblaje, ejecute el comando:</font></font><br>
<br>
<pre><code class="cpp hljs">pvs-studio-analyzer analyze -o /path/to/output.<span class="hljs-built_in">log</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4) Convierta el informe sin formato a cualquier formato conveniente para usted. </font><font style="vertical-align: inherit;">El analizador viene con una utilidad especial PlogConverter, con la que puede hacer esto. </font><font style="vertical-align: inherit;">Por ejemplo, el comando para convertir el informe en una lista de tareas (para ver, por ejemplo, en QtCreator) se verá así:</font></font><br>
<br>
<pre><code class="cpp hljs">plog-converter -t tasklist -o /path/to/output.tasks /path/to/project</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Todas! </font><font style="vertical-align: inherit;">No me llevó más de 15 minutos completar estos puntos. </font><font style="vertical-align: inherit;">El informe está listo, ahora puede ver los errores. </font><font style="vertical-align: inherit;">Bueno, empecemos :)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ciclo extraño</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uno de los errores encontrados por el analizador fue el extraño ciclo while:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span> ) {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">goto</span> out_cmd;<font></font>
    }<font></font>
<font></font>
    dp.skip --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.skip != <span class="hljs-number">0</span>);       <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">do</span> {<font></font>
    n_read = read(ifd, tbuf, dp.bs);<font></font>
    <span class="hljs-keyword">if</span> (n_read &lt; <span class="hljs-number">0</span>) {<font></font>
      err = -errno;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (n_read == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    ....<font></font>
<font></font>
    dp.count --;<font></font>
  } <span class="hljs-keyword">while</span> (dp.count != <span class="hljs-number">0</span>);<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencia de </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">PVS-Studio: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">V715</font></a><font style="vertical-align: inherit;"> El operador 'while' tiene el cuerpo vacío. </font><font style="vertical-align: inherit;">Patrón sospechoso detectado: 'while (expr) {...} while (dp.skip! = 0);'. </font><font style="vertical-align: inherit;">dd.c 225 hm </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
. </font><font style="vertical-align: inherit;">Realmente extraño bucle. </font><font style="vertical-align: inherit;">La expresión </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while (dp.skip! = 0)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se escribe dos veces, una justo encima del bucle y la segunda justo debajo. </font><font style="vertical-align: inherit;">De hecho, ahora estos son dos ciclos diferentes: uno contiene expresiones entre llaves y el segundo está vacío. </font><font style="vertical-align: inherit;">En este caso, el segundo ciclo nunca se ejecutará. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuación se muestra un bucle do ... while con una condición similar, lo que me lleva a pensar: el bucle extraño fue originalmente como do ... while, pero algo salió mal. </font><font style="vertical-align: inherit;">Creo que este código con una alta probabilidad contiene un error lógico.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pérdidas de memoria</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sí, no sin ellos.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">krename</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *oldpath, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *newpath)</span> </span>{<font></font>
  <font></font>
  <span class="hljs-keyword">char</span> *newpatharg, *oldpatharg;<font></font>
<font></font>
  ....<font></font>
<font></font>
  oldpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(oldpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));<font></font>
  newpatharg =<font></font>
    <span class="hljs-built_in">calloc</span>(<span class="hljs-built_in">strlen</span>(newpath) + diritemlen + <span class="hljs-number">2</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>));
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == oldpatharg || <span class="hljs-literal">NULL</span> == newpatharg) {<font></font>
    SET_ERRNO(ENOMEM);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencias de PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V773</a> The function was exited without releasing the 'newpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V773</a> The function was exited without releasing the 'oldpatharg' pointer. A memory leak is possible. kfsop.c 611</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La función crea las variables locales </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oldpatharg</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dentro de sí misma </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A estos punteros se les asignan las direcciones de las nuevas ubicaciones de memoria asignadas internamente mediante </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si se produce un problema al asignar memoria, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devuelve un puntero nulo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué sucede si solo se asigna un bloque de memoria? </font><font style="vertical-align: inherit;">La función se bloqueará sin liberar ninguna memoria. </font><font style="vertical-align: inherit;">El sitio que se asignó permanecerá en la memoria sin ninguna oportunidad de acceder nuevamente y liberarlo para su uso posterior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otro ejemplo de pérdida de memoria es un poco más brillante:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">block_dev_test</span><span class="hljs-params">(....)</span> </span>{
  <span class="hljs-keyword">int8_t</span> *read_buf, *write_buf;<font></font>
  <font></font>
  ....<font></font>
<font></font>
  read_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
  write_buf = <span class="hljs-built_in">malloc</span>(blk_sz * m_blocks);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (read_buf == <span class="hljs-literal">NULL</span> || write_buf == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failed to allocate memory for buffer!\n"</span>);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (read_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(read_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (write_buf != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-built_in">free</span>(write_buf);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> -ENOMEM;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (s_block &gt;= blocks) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Starting block should be less than number of blocks\n"</span>);
    <span class="hljs-keyword">return</span> -EINVAL;            <span class="hljs-comment">// &lt;=</span><font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencias de PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V773</a> The function was exited without releasing the 'read_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V773</a> The function was exited without releasing the 'write_buf' pointer. A memory leak is possible. block_dev_test.c 195</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí, el programador ya ha mostrado precisión y procesó correctamente el caso en el que fue posible asignar solo una pieza de memoria. </font><font style="vertical-align: inherit;">Procesado correctamente ... y literalmente en la siguiente expresión cometió otro error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias a una verificación escrita correctamente, podemos estar seguros de que en el momento en que se ejecuta la expresión, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve -EINVAL; </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definitivamente tendremos memoria asignada tanto para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write_buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por lo tanto, con tal retorno de la función, tendremos dos fugas a la vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creo que tener una pérdida de memoria en un dispositivo integrado puede ser más doloroso que en una PC clásica. </font><font style="vertical-align: inherit;">En condiciones en que los recursos son muy limitados, debe controlarlos con especial cuidado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Punteros mal manejados</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente código de error es conciso y lo suficientemente simple:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">scsi_write</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">char</span> *buffer,
                      <span class="hljs-keyword">size_t</span> count, <span class="hljs-keyword">blkno_t</span> blkno)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_dev</span> *<span class="hljs-title">sdev</span>;</span>
  <span class="hljs-keyword">int</span> blksize;<font></font>
<font></font>
  ....<font></font>
<font></font>
  sdev = bdev-&gt;privdata;<font></font>
  blksize = sdev-&gt;blk_size; <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!sdev) {              <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">return</span> -ENODEV;<font></font>
  }<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencia de PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El puntero 'sdev' se utilizó antes de verificarlo con nullptr. Líneas de verificación: 116, 118. scsi_disk.c 116 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El puntero </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev se</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> desreferencia justo antes de que se verifique NULL. Es lógico suponer que si alguien escribió dicho cheque, entonces este puntero puede ser nulo. En este caso, tenemos la posible desreferenciación del puntero nulo en la cadena </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El error es que la verificación no se encuentra donde se necesita. Debería haber venido después de la línea " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sdev = bdev-&gt; privdata;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", pero antes de la línea " </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blksize = sdev-&gt; blk_size;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ". Entonces se podría evitar la posible apelación a la dirección cero.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio encontró dos errores más en el siguiente código:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xdrrec_create</span><span class="hljs-params">(....)</span>
</span>{
  <span class="hljs-keyword">char</span> *buff;<font></font>
<font></font>
  ....<font></font>
<font></font>
  buff = (<span class="hljs-keyword">char</span> *)<span class="hljs-built_in">malloc</span>(sendsz + recvsz);<font></font>
  assert(buff != <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
  ....<font></font>
<font></font>
  xs-&gt;extra.rec.in_base = xs-&gt;extra.rec.in_curr = buff;<font></font>
  xs-&gt;extra.rec.in_boundry <font></font>
    = xs-&gt;extra.rec.in_base + recvsz;                    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
  xs-&gt;extra.rec.out_base<font></font>
    = xs-&gt;extra.rec.out_hdr = buff + recvsz;             <span class="hljs-comment">// &lt;= </span><font></font>
  xs-&gt;extra.rec.out_curr <font></font>
    = xs-&gt;extra.rec.out_hdr + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">union</span> xdrrec_hdr);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencias de PVS-Studio:</font></font></b> <br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">puntero</font></a><font style="vertical-align: inherit;"> 'xs-&gt; extra.rec.in_base' en la expresión 'xs-&gt; extra.rec.in_base + recvsz' podría ser nullptr. </font><font style="vertical-align: inherit;">En tal caso, el valor resultante no tendrá sentido y no debe usarse. </font><font style="vertical-align: inherit;">Líneas de verificación: 56, 48. xdr_rec.c 56</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V769</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El puntero 'buff' en la expresión 'buff + recvsz' podría ser nullptr. </font><font style="vertical-align: inherit;">En tal caso, el valor resultante no tendrá sentido y no debe usarse. </font><font style="vertical-align: inherit;">Líneas de verificación: 61, 48. xdr_rec.c 61</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El puntero buf se inicializa con </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y luego su valor se usa para inicializar otros punteros. La función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede devolver un puntero nulo, y esto siempre debe verificarse. Parecería que aquí es una </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aserción</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comprobar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y todo debería funcionar bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Pero no! El hecho es que las </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aserciones</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se utilizan para la depuración, y al compilar el proyecto en la configuración de lanzamiento, esta </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aserción</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se eliminará. Resulta que cuando se trabaja en Debug, el programa funcionará correctamente, y al compilar en Release, el puntero nulo "va" más allá. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nulo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en operaciones aritméticas es incorrecto, porque el resultado de tal operación no tendrá ningún sentido, y dicho resultado no puede usarse. </font><font style="vertical-align: inherit;">De esto nos advierte el analizador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algunos podrían argumentar que no verificar el puntero después de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">malloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realloc</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calloc no</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tiene miedo. </font><font style="vertical-align: inherit;">Como, en el primer acceso por un puntero nulo, se producirá una señal / excepción y no habrá nada malo. </font><font style="vertical-align: inherit;">En la práctica, todo es mucho más complicado, y si la falta de verificación no le parece peligrosa, le sugiero que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lea</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el artículo " </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">¿Por qué es importante verificar qué regresó la función malloc?</font></a><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manejo incorrecto de matrices</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente error es muy similar al ejemplo anterior:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">fat_read_filename</span><span class="hljs-params">(struct fat_file_info *fi,
                      <span class="hljs-keyword">void</span> *p_scratch,
                      <span class="hljs-keyword">char</span> *name)</span> </span>{
  <span class="hljs-keyword">int</span> offt = <span class="hljs-number">1</span>;<font></font>
<font></font>
  ....<font></font>
<font></font>
  offt = <span class="hljs-built_in">strlen</span>(name);
  <span class="hljs-keyword">while</span> (name[offt - <span class="hljs-number">1</span>] == <span class="hljs-string">' '</span> &amp;&amp; offt &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// &lt;=</span>
    name[--offt] = <span class="hljs-string">'\0'</span>;<font></font>
  }<font></font>
  log_debug(<span class="hljs-string">"name(%s)"</span>, name);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> DFS_OK;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencia de PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V781</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El valor del índice 'offt' se verifica después de su uso. </font><font style="vertical-align: inherit;">Quizás haya un error en la lógica del programa. </font><font style="vertical-align: inherit;">fat_common.c 1813 La </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offt se</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa primero dentro de la operación de indexación, y solo entonces se verifica que su valor sea mayor que cero. </font><font style="vertical-align: inherit;">Pero, ¿qué sucede si el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> resulta ser una cadena vacía? </font><font style="vertical-align: inherit;">La función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devolverá </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , luego un golpe fuerte en la pierna. </font><font style="vertical-align: inherit;">El programa accederá a un índice negativo, lo que conducirá a un comportamiento indefinido. </font><font style="vertical-align: inherit;">Cualquier cosa puede suceder, incluido un bloqueo del programa. </font><font style="vertical-align: inherit;">¡Lío!</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a8d/fde/b0d/a8dfdeb0d70054257d1d08162bbd39aa.png" alt="Foto 1"></div> <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Condiciones sospechosas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Y dónde sin ellos? </font><font style="vertical-align: inherit;">Encontramos tales errores literalmente en cada proyecto que verificamos.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">index_descriptor_cloexec_set</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">int</span> cloexec)</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">idesc_table</span> *<span class="hljs-title">it</span>;</span><font></font>
<font></font>
  it = task_resource_idesc_table(task_self());<font></font>
  assert(it);<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (cloexec | FD_CLOEXEC) {<font></font>
    idesc_cloexec_set(it-&gt;idesc_table[fd]);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    idesc_cloexec_clear(it-&gt;idesc_table[fd]);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencia de PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V617</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Considere inspeccionar la condición. El argumento '0x0010' de '|' La operación bit a bit contiene un valor distinto de cero. index_descriptor.c 55 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para comprender en qué consiste el error, observe la definición de la constante </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FD_CLOEXEC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FD_CLOEXEC 0x0010</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resulta que en la expresión </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (cloexec | FD_CLOEXEC) a la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> derecha del bit a bit "o" siempre hay una constante distinta de cero. </font><font style="vertical-align: inherit;">El resultado de dicha operación siempre será un número distinto de cero. </font><font style="vertical-align: inherit;">Por lo tanto, esta expresión siempre será equivalente a la expresión </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (verdadero)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y siempre procesaremos solo la rama entonces de la expresión if. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sospecho que esta constante de macro se usa para preconfigurar el sistema operativo Embox, pero aun así esta condición siempre verdadera parece extraña. </font><font style="vertical-align: inherit;">Quizás quisieron usar el operador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&amp;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aquí </font><font style="vertical-align: inherit;">, pero cometieron un error tipográfico.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">División entera</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente error está relacionado con una característica del lenguaje C:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SBSIZE    1024</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2fs_format</span><span class="hljs-params">(struct block_dev *bdev, <span class="hljs-keyword">void</span> *priv)</span> </span>{
  <span class="hljs-keyword">size_t</span> dev_bsize;
  <span class="hljs-keyword">float</span> dev_factor;<font></font>
<font></font>
  ....<font></font>
<font></font>
  dev_size = block_dev_size(bdev);<font></font>
  dev_bsize = block_dev_block_size(bdev);<font></font>
  dev_factor = SBSIZE / dev_bsize;            <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ext2_dflt_sb(&amp;sb, dev_size, dev_factor);<font></font>
  ext2_dflt_gd(&amp;sb, &amp;gd);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencia de </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">PVS-Studio: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">V636</font></a><font style="vertical-align: inherit;"> La expresión '1024 / dev_bsize' se convirtió implícitamente de tipo 'int' a tipo 'flotante'. Considere utilizar un molde de tipo explícito para evitar la pérdida de una parte fraccional. Un ejemplo: doble A = (doble) (X) / Y;. ext2.c 777 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta característica es la siguiente: si dividimos dos valores enteros, entonces el resultado de la división será entero. Por lo tanto, la división ocurrirá sin un resto, o, en otras palabras, la parte fraccionaria se descartará del resultado de la división. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A veces los programadores lo olvidan y se cometen errores como este. SBSIZE constante y variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tienen un tipo entero (int y size_t respectivamente). Por lo tanto, el resultado de la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expresión SBSIZE / dev_bsize</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">también será de tipo entero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero espera un momento. </font><font style="vertical-align: inherit;">La variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es de tipo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">float</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Obviamente, el programador esperaba obtener un resultado de división fraccional. </font><font style="vertical-align: inherit;">Esto puede verificarse aún más si presta atención al uso posterior de esta variable. </font><font style="vertical-align: inherit;">Por ejemplo, la función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_dflt_sb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , donde </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dev_factor se</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pasa como el tercer parámetro, tiene la siguiente firma:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ext2_dflt_sb</span><span class="hljs-params">(struct ext2sb *sb, <span class="hljs-keyword">size_t</span> dev_size, <span class="hljs-keyword">float</span> dev_factor)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De manera similar, en otros lugares donde se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usa la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><i><font style="vertical-align: inherit;">dev_factor</font></i><font style="vertical-align: inherit;"> : todo indica que se espera un número de coma flotante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para corregir este error, es suficiente convertir uno de los operandos de división a un tipo real. </font><font style="vertical-align: inherit;">Por ejemplo:</font></font><br>
<br>
<pre><code class="cpp hljs">dev_factor = <span class="hljs-keyword">float</span>(SBSIZE) / dev_bsize;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces el resultado de la división será un número fraccionario.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entrada no verificada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente error está asociado con el uso de datos no verificados recibidos desde fuera del programa.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
  <span class="hljs-keyword">int</span> ret;
  <span class="hljs-keyword">char</span> text[SMTP_TEXT_LEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == fgets(&amp;text[<span class="hljs-number">0</span>], <span class="hljs-keyword">sizeof</span> text - <span class="hljs-number">2</span>, <span class="hljs-comment">/* for \r\n */</span>
      <span class="hljs-built_in">stdin</span>)) { ret = -EIO; <span class="hljs-keyword">goto</span> error; }<font></font>
    text[<span class="hljs-built_in">strlen</span>(&amp;text[<span class="hljs-number">0</span>]) - <span class="hljs-number">1</span>] = <span class="hljs-string">'\0'</span>; <span class="hljs-comment">/* remove \n */</span>    <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencia de PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Los</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> datos contaminados no </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">verificados</font></a><font style="vertical-align: inherit;"> se usan en el índice: 'strlen (&amp; text [0])'. </font><font style="vertical-align: inherit;">sendmail.c 102 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, considere lo que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve la</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> función </font><i><font style="vertical-align: inherit;">fgets</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En caso de lectura exitosa de una línea, la función devuelve un puntero a esta línea. </font><font style="vertical-align: inherit;">Si la lectura encuentra un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">final de archivo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes de que se lea al menos un elemento, o si se produce un error de entrada, la función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devuelve </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces la expresión es </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL == fgets (....)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comprueba si la entrada recibida es correcta. Pero hay una advertencia. Si transfiere un terminal nulo como el primer carácter que se leerá (esto se puede hacer, por ejemplo, presionando Ctrl + 2 en el modo Legacy de la línea de comando de Windows), la función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fgets lo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> considera sin devolver </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En este caso, la línea en la que se realiza la grabación tendrá solo un elemento: ' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">\ 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué pasará después? La expresión </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strlen (&amp; text [0])</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devolverá </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Como resultado, recibimos una llamada de índice negativa:</font></font><br>
<br>
<pre><code class="cpp hljs">text[ <span class="hljs-number">0</span> - <span class="hljs-number">1</span> ] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, podemos "anular" el programa simplemente pasando el carácter de terminación de línea a la entrada. </font><font style="vertical-align: inherit;">Esto es incómodo y podría usarse potencialmente para atacar sistemas que usan Embox. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mi colega, que estaba desarrollando esta regla de diagnóstico, incluso tomó nota con un ejemplo de tal ataque al proyecto NcFTP:</font></font><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8DBQjvPQ7tk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recomiendo ver si aún no crees en esa oportunidad :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, el analizador encontró dos lugares más con el mismo error:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Los datos contaminados no verificados se usan en el índice: 'strlen (&amp; from [0])'. </font><font style="vertical-align: inherit;">sendmail.c 55</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1010 Los datos contaminados no verificados se usan en el índice: 'strlen (&amp; to [0])'. </font><font style="vertical-align: inherit;">sendmail.c 65</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Misra</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA es un conjunto de pautas y pautas para escribir código C y C ++ seguro para sistemas integrados altamente responsables. </font><font style="vertical-align: inherit;">En cierto sentido, este es un manual de capacitación, que le permitirá deshacerse no solo de los llamados "olores de código", sino que también protegerá su programa de vulnerabilidades. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MISRA se utiliza donde las vidas humanas dependen de la calidad de su sistema integrado: en las industrias médica, automotriz, aeronáutica y militar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio tiene </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un extenso conjunto de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reglas </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">de</font></a><font style="vertical-align: inherit;"> diagnóstico que le permiten verificar que su código cumpla con los estándares MISRA C y MISRA C ++. </font><font style="vertical-align: inherit;">De manera predeterminada, el modo con estos diagnósticos está desactivado, pero como estamos buscando errores en el proyecto para sistemas integrados, simplemente no podría prescindir de MISRA.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es lo que pude encontrar:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* find and read symlink file */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ext2_read_symlink</span><span class="hljs-params">(struct nas *nas,
                             <span class="hljs-keyword">uint32_t</span> parent_inumber,
                             <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **cp)</span> </span>{
  <span class="hljs-keyword">char</span> namebuf[MAXPATHLEN + <span class="hljs-number">1</span>];<font></font>
<font></font>
  ....<font></font>
<font></font>
  *cp = namebuf;              <span class="hljs-comment">// &lt;=</span>
  <span class="hljs-keyword">if</span> (*namebuf != <span class="hljs-string">'/'</span>) {<font></font>
    inumber = parent_inumber;<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    inumber = (<span class="hljs-keyword">uint32_t</span>) EXT2_ROOTINO;<font></font>
  }<font></font>
  rc = ext2_read_inode(nas, inumber);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
} </code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Advertencia de PVS-Studio: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] La dirección de la matriz local 'namebuf' no debe almacenarse fuera del alcance de esta matriz. ext2.c 298 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El analizador detectó una asignación sospechosa que podría conducir a un comportamiento indefinido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo más de cerca al código. Aquí, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una matriz creada en el ámbito local de la función, y el puntero </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se </font><font style="vertical-align: inherit;">pasa a la función por puntero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Según la sintaxis de C, el nombre de la matriz es un puntero al primer elemento en el área de memoria en la que se almacena la matriz. Resulta que la expresión </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* cp = namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asignará la dirección de la matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a la variable señalada por </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Como </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cp se</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pasa a la función por puntero, un cambio en el valor al que apunta se reflejará en el lugar donde se llamó a la función. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resulta que después de que la función </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ext2_read_symlink</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> complete su trabajo, su tercer parámetro indicará el área que la matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> una vez ocupó </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo hay un "pero": dado que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">namebuf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una matriz reservada en la pila, se eliminará cuando salga la función. Por lo tanto, un puntero que existe fuera de la función apuntará a la memoria liberada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué habrá en esa dirección? </font><font style="vertical-align: inherit;">Es imposible de predecir. </font><font style="vertical-align: inherit;">Es posible que durante algún tiempo el contenido de la matriz continúe en la memoria, o es posible que el programa borre inmediatamente esta área con algo más. </font><font style="vertical-align: inherit;">En general, acceder a dicha dirección devolverá un valor indefinido, y el uso de dicho valor es un error grave. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El analizador también encontró otro error con la misma advertencia:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V2548</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [MISRA C 18.6] La dirección de la variable local 'dst_haddr' no debe almacenarse fuera del alcance de esta variable. </font><font style="vertical-align: inherit;">net_tx.c 82</font></font></li>
</ul><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ba/353/6e6/2ba3536e675a564e65b802a3e596fa36.png" alt="Figura 6"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusión</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me gustó trabajar con el proyecto Embox. A pesar de que no escribí todos los errores encontrados en el artículo, el número total de advertencias fue relativamente pequeño y, en general, el código del proyecto fue escrito con alta calidad. Por lo tanto, expreso mi gratitud a los desarrolladores, así como a aquellos que contribuyeron al proyecto en nombre de la comunidad. ¡Eres genial! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aprovecho esta oportunidad para transmitir saludos a los desarrolladores de Tula. Creo que en San Petersburgo no hace mucho frío en este momento :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí es donde termina mi artículo. Espero que hayas disfrutado leyéndolo y que hayas encontrado algo nuevo para ti. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si está interesado en PVS-Studio y desea verificar de forma independiente algún proyecto usándolo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descárguelo y pruébelo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esto no tomará más de 15 minutos.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea compartir este artículo con una audiencia de habla inglesa, utilice el enlace a la traducción: George Gribkov. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acerca de incrustado nuevamente: búsqueda de errores en el proyecto Embox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es499970/index.html">Estudiamos el motor VoIP Mediastreamer2. Parte 12</a></li>
<li><a href="../es499972/index.html">Resumen de eventos en línea de mayo</a></li>
<li><a href="../es499974/index.html">Juegos 3D en Javascript de Instagram, o ruta de vuelo de salchichas</a></li>
<li><a href="../es499978/index.html">Traducción del libro de Andrew Un, Pasión por el aprendizaje automático, capítulos 36 y 37</a></li>
<li><a href="../es499982/index.html">Plan de prueba para principiantes: de "Ingrese a TI" a "¡Soy ingeniero!"</a></li>
<li><a href="../es499988/index.html">Azúcar y COVID-19</a></li>
<li><a href="../es499990/index.html">Geocodificación ¿Cómo vincular 250 mil direcciones a coordenadas en 10 minutos?</a></li>
<li><a href="../es499992/index.html">Diseñar tecnologías para la implementación de sistemas de facturación para clientes corporativos (parte 2)</a></li>
<li><a href="../es499994/index.html">Cuando terminará el coronavirus</a></li>
<li><a href="../es500000/index.html">Al día de la radio. Comunicación: los nervios de la guerra</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>