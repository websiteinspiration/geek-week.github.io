<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§´ üßöüèº üëçüèº STM32 Teil 2: Initialisierung üé© üòî üöß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das Programmieren zerlegt etwas Gro√ües und Unm√∂gliches in etwas Kleines und sehr Reales.
 
 Hallo allerseits, zun√§chst m√∂chte ich den Moderatoren daf√º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Teil 2: Initialisierung</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491300/"><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Das Programmieren zerlegt etwas Gro√ües und Unm√∂gliches in etwas Kleines und sehr Reales.</font></font></blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hallo allerseits, zun√§chst m√∂chte ich den Moderatoren daf√ºr danken, dass sie meinen ersten (ekelhaften) Beitrag verpasst haben, und Mama Hallo sagen! Au√üerdem m√∂chte ich mich bei allen Lesern und Menschen bedanken, die auf meine Fehler hingewiesen und geholfen haben, sie zu beheben. Ich mache sofort einen Vorbehalt, dass ich auf Russisch nicht ab der 6. Klasse geschrieben habe, im Allgemeinen nicht b√∂se sein. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32 Teil 1: Die Grundlagen</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Also </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">fangen</font></a><font style="vertical-align: inherit;"> wir an. In einem fr√ºheren Artikel habe ich schnell die ersten Punkte durchgearbeitet. Dies war unsere Startup.c-Datei, die f√ºr 2 Vektoren (Stack, Reset_Handler) und ein wenig √ºber das Linker-Skript verantwortlich war. Heute werden wir unseren Initialisierungscode erg√§nzen, den Linker f√ºr Ersatzteile zerlegen und herausfinden, wie alles funktioniert.</font></font><br>
<a name="habracut"></a><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn dieser Code niemandem klar ist, k√∂nnen Sie ihn </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lesen </font><font style="vertical-align: inherit;">(der Artikel ist kein Brunnen, aber versucht zu erkl√§ren). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns nun herausfinden, was hier fehlt und wie Sie es hinzuf√ºgen k√∂nnen. Offensichtlich haben Mikrometer andere Vektoren. Beispielsweise ist der Hard_Fault-Vektor ein Vektor, der bei nicht ordnungsgem√§√üen Aktionen mit Œº aufgerufen wird. Wenn er beispielsweise versucht, eine Anweisung auszuf√ºhren, die der Prozessor nicht versteht, springt er zur Adresse des Hard_Fault-Vektors. Es gibt viele solcher Vektoren und es ist keine Tatsache, dass wir in unserem Programm alles verwenden werden. Interruptvektoren befinden sich ebenfalls in derselben Tabelle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(F√ºr diejenigen, die noch nicht wissen, was ein Vektor ist, ist dies ein Zeiger auf eine Adresse, auch bekannt als "Zeiger"). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir erg√§nzen unseren Code und dann werde ich erkl√§ren, was ich getan habe.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Default_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">NMI_Handler</span><span class="hljs-params">()</span>   __<span class="hljs-title">attribute__</span><span class="hljs-params">((weak, alias(<span class="hljs-string">"Default_Handler"</span>)))</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HardFault_Handler</span><span class="hljs-params">()</span>   __<span class="hljs-title">attribute__</span><span class="hljs-params">((weak, alias(<span class="hljs-string">"Default_Handler"</span>)))</span></span>;
<span class="hljs-comment">//     </span><font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
    &amp;NMI_Handler,<font></font>
    &amp;HardFault_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Default_Handler(){
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier habe ich eine neue Funktion Default_Handler () hinzugef√ºgt; das wird absolut alle Interrupts behandeln. Aber auch mit der Hilfe habe </font></font><code>__attribute__((weak, alias("Default_Handler")));</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ich festgestellt, dass wenn eine Funktion mit demselben Namen deklariert wird, sie der Handler dieses Interrupts ist. Mit anderen Worten, im Moment ist es nur ein Spitzname f√ºr Default_Handler. So k√∂nnen wir alle Vektoren in der Liste aus Ihrem Referenzhandbuch hinzuf√ºgen. Dies geschieht so, dass, wenn Sie pl√∂tzlich beschlossen haben, einen Interrupt zu verwenden, aber vergessen haben, einen Funktionshandler zu erstellen, der √ºbliche Default_Handler aufgerufen wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich denke an dieser Stelle k√∂nnen Sie mit Vektoren die Initialisierung von Sektoren und den Linker beenden. Lassen Sie uns zun√§chst unsere Datei startup.c erneut aktualisieren, indem Sie die Initialisierung der Daten- und BSS-Sektoren zum Reset_Handler-Body sowie zu mehreren externen Variablen hinzuf√ºgen.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_sidata, *_sdata, *_edata, *_sbss, *_ebss;<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
<font></font>
<font></font>
	<span class="hljs-keyword">void</span> **pSource, **pDest;
	<span class="hljs-keyword">for</span> (pSource = &amp;_sidata, pDest = &amp;_sdata; pDest != &amp;_edata; pSource++, pDest++)<font></font>
		*pDest = *pSource;<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (pDest = &amp;_sbss; pDest != &amp;_ebss; pDest++)<font></font>
		*pDest = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also neue Variablen, und wieder wurden sie in unserem Linker-Skript deklariert. </font><font style="vertical-align: inherit;">Rufen Sie das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vorherige Skript auf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Und vergleichen Sie es auch mit einem neuen.</font></font><br>
<br>
<pre><code class="markdown hljs">MEMORY{
<span class="hljs-code">	ROM(rx) : ORIGIN = 0x08000000, LENGTH = 1M
	SRAM (rwx):     ORIGIN = 0x20010000, LENGTH = 240K
}
</span>
<span class="hljs-emphasis">_estack = LENGTH(SRAM) + ORIGIN(SRAM);

SECTIONS{
	.isr_</span>vector : {
<span class="hljs-code">	KEEP(*(.isr_vector))
	} &gt;ROM
	
	.text : {
        . = ALIGN(4);
        *(.text)
    } &gt;ROM
	
	_sidata = LOADADDR(.data);
        .data : {
		. = ALIGN(4);
		_sdata = .;
		*(.data)
		. = ALIGN(4);
		_edata = .;
	} &gt;SRAM AT&gt;ROM
	
	.bss : {
		. = ALIGN(4);
		_sbss = .;
		*(.bss)
		. = ALIGN(4);
		_ebss = .;
	} &gt;SRAM
}</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurden zwei neue Abschnitte hinzugef√ºgt, n√§mlich .data und .bss. </font><font style="vertical-align: inherit;">Warum brauchen wir sie? </font><font style="vertical-align: inherit;">Nun, .data hinterl√§sst globale Variablen und statische Daten gehen an bss. </font><font style="vertical-align: inherit;">Diese beiden Abschnitte befinden sich im RAM, und wenn mit dem bss-Abschnitt alles einfach ist (dies sind nur Nullen), gibt es einige Schwierigkeiten mit dem Datenabschnitt. </font><font style="vertical-align: inherit;">Erstens sind Daten bereits initialisierte Daten, die zur Kompilierungszeit bekannt sind. </font><font style="vertical-align: inherit;">Somit liegt der Datenabschnitt zun√§chst irgendwo im Flash-Speicher. </font><font style="vertical-align: inherit;">Zweitens m√ºssen wir dem Linker irgendwie mitteilen, dass sich das Skript im Flash-Speicher befindet, aber es wird w√§hrend der Programmausf√ºhrung in den RAM √ºbertragen. </font><font style="vertical-align: inherit;">Schauen wir uns einen Teil des Skripts an, in dem wir den Datenabschnitt beschreiben.</font></font><br>
<br>
<pre><code class="markdown hljs">
<span class="hljs-code">        _sidata = LOADADDR(.data);
        .data : {
		. = ALIGN(4);
		_sdata = .;
		*(.data)
		. = ALIGN(4);
		_edata = .;
	} &gt;SRAM AT&gt;ROM</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es beginnt mit der Erkl√§rung von _sidata und der momentanen Zuordnung einer Bedeutung, die uns nicht klar ist. Als n√§chstes beginnt eine Beschreibung des Abschnitts selbst. Ich rate Ihnen , </font><font style="vertical-align: inherit;">√ºber die ALIGN - </font><font style="vertical-align: inherit;">Funktion lesen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber auf den Punkt gebracht, weisen wir unseren Punkt (aktuelle Adresse) ein Wert, der </font><font style="vertical-align: inherit;">leichter von unserem Prozessor akzeptiert wird , </font><font style="vertical-align: inherit;">wenn es versucht , </font><font style="vertical-align: inherit;">Daten oder Anweisungen von dort zu laden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ebenfalls enthalten sind _sdata, _edata und das Ende des Abschnitts. Aber am Ende des Abschnitts gibt es genau das, was wir brauchen.</font></font><code>SRAM AT&gt;ROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Diese Zeile teilt unserem Linker mit, dass sich der Abschnitt im SRAM befindet, dieser Abschnitt jedoch in den ROM- oder Flash-Speicher geladen ist. Nun zur√ºck zu unserer _sidata-Variablen und der LOADADDR-Funktion. Diese Funktion gibt uns einen Wert zur√ºck, der der Adresse des Ladeabschnitts entspricht. Das hei√üt, wir haben angegeben, dass der Abschnitt in den Flash-Speicher geladen wurde, aber wir verwenden ihn im RAM. Um diesen Abschnitt zu √ºbertragen, m√ºssen wir seine Adresse im Flash-Speicher kennen, was die LOADADDR-Funktion zur√ºckgibt. W√§hrenddessen geben die Variablen _sdata und _edata die Position des Abschnitts im RAM an, wodurch wir die M√∂glichkeit haben, den Datenabschnitt in den richtigen Speicher zu laden. Ich m√∂chte Sie daran erinnern, dass dies der Initialisierungscode ist, den wir oben erg√§nzt haben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum brauchen wir diesen Linker und solche Schwierigkeiten bei der Verteilung von Abschnitten unserer Anwendung? Der Datenabschnitt ist nur ein kleines Beispiel daf√ºr, warum wir Abschnitte im Speicher platzieren und verschieben m√ºssen. Unten ist ein Beispiel f√ºr den Textabschnitt, den ich verwende.</font></font><br>
<br>
<pre><code class="markdown hljs">.text (ORIGIN(ROM<span class="hljs-emphasis">_ITCM) + SIZEOF(.isr_</span>vector)): {
<span class="hljs-code">        . = ALIGN(4);
        *(.text)
    } AT&gt;ROM_AXIM</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Wesentliche an diesem Block ist, dass ich den Textabschnitt auch in den Flash-Speicher lade, aber einen anderen Bus verwende, um auf Anweisungen und einen ART-Beschleuniger zuzugreifen (√§hnlich einem normalen Cache). </font><font style="vertical-align: inherit;">Und damit alles funktioniert, habe ich die Ladeadresse und die Adresse w√§hrend der Codeausf√ºhrung angegeben, aber es w√ºrde nicht funktionieren, wenn ich nicht angeben w√ºrde, dass der Abschnitt versetzt werden soll. </font><font style="vertical-align: inherit;">Es gibt noch viele solche Erfindungen, ich werde sie nicht alle zeigen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser Phase werden Abschnitte bei Bedarf geladen und initialisiert. </font><font style="vertical-align: inherit;">Wir haben eine Arbeitsbasis f√ºr das weitere Schreiben von Code. </font><font style="vertical-align: inherit;">Im n√§chsten Artikel werden wir unseren ersten Treiber schreiben und eine LED blinken lassen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank f√ºr Ihre Aufmerksamkeit und Ihren Erfolg bei Ihren Bem√ºhungen.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de491286/index.html">IPv6-Netzwerke nur in der US-Regierung</a></li>
<li><a href="../de491288/index.html">Polygraphisten werden eins nach dem anderen verr√ºckt</a></li>
<li><a href="../de491294/index.html">Verteilte Transaktionen f√ºr heterogene Datenbanken in MS .NET</a></li>
<li><a href="../de491296/index.html">Dagaz: Eine Persistenzgeschichte</a></li>
<li><a href="../de491298/index.html">So finden Sie Malware (nein) mit WinDbg</a></li>
<li><a href="../de491302/index.html">OVPN-Client auf Grandstream-Telefonen</a></li>
<li><a href="../de491304/index.html">Helsinki: eine Stadt des Gl√ºcks und des Komforts</a></li>
<li><a href="../de491308/index.html">ClickHouse - visuell schnelle und intuitive Datenanalyse in Tabix. Igor Strykhar</a></li>
<li><a href="../de491310/index.html">So knacken Sie ein Passwortarchiv selbst</a></li>
<li><a href="../de491336/index.html">Spiele wie ein Spieledesigner</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>