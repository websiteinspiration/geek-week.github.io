<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤪 👦🏽 🤷🏻 Wir überwachen die PostgreSQL-Datenbank - wer ist schuld und was zu tun ist 👩🏽‍🎤 👸🏾 😜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich habe bereits darüber gesprochen, wie wir PostgreSQL-Probleme mithilfe der Massenprotokollüberwachung auf Hunderten von Servern gleichzeitig „abfan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wir überwachen die PostgreSQL-Datenbank - wer ist schuld und was zu tun ist</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/502478/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe bereits darüber gesprochen, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wie wir PostgreSQL-Probleme</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mithilfe der Massenprotokollüberwachung auf Hunderten von Servern gleichzeitig </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">„abfangen“</font></a><font style="vertical-align: inherit;"> . Neben den Protokollen bietet uns dieses DBMS auch </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viele Tools zur Analyse seines Status</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - es ist eine Sünde, sie nicht zu verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie sie nur von der Konsole aus betrachten, können Sie sehr schnell und ohne Nutzen herumlaufen, da die uns zur Verfügung stehende Datenmenge alle angemessenen Grenzen überschreitet.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s1/za/d-/s1zad-d3claa2klkewtgrj8zdaa.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit die Situation kontrollierbar bleibt, haben wir </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für Zabbix ein Add-On entwickelt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das Metriken </font><font style="vertical-align: inherit;">bereitstellt </font><font style="vertical-align: inherit;">, Bildschirme erstellt und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einheitliche Überwachungsregeln</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für alle Server und Datenbanken auf diesen erstellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dem heutigen Artikel geht es darum, welche Schlussfolgerungen durch dynamische Beobachtung der verschiedenen Metriken der PostgreSQL-Serverbasen gezogen werden können und wo das Problem möglicherweise verborgen ist.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbindungsstatus</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das allererste, womit alle Demontagen zum Thema „Was ist mit der Datenbank passiert / es war schlecht“ beginnen, ist die Überwachung des Zusammenfassungsstatus von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_activity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/az/zv/9k/azzv9kl_xmnaxjdfgsgjkmikr48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der linken Grafik sehen wir alle Verbindungen, die auf etwas warten, auf der rechten Seite - die etwas sind tun. </font><font style="vertical-align: inherit;">Abhängig von der PG-Version wird der Verbindungsstatus durch </font></font><code>pg_stat_activity.state/wait_event</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und / oder den Text der Anforderung selbst bestimmt. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worauf zu achten ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wenig</font></font><code>idle</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Irgendwann sind in Ihrer Anwendung möglicherweise nicht genügend Verbindungen zur Datenbank geöffnet. Wenn Sie versuchen, eine andere zu öffnen, warten Sie darauf, dass der Prozess initialisiert wird, um eine neue Verbindung herzustellen.</font></font></li>
<li> <b> <code>idle</code></b>      «»    ,         <code>max_connections</code>.</li>
<li><b> <code>idle in transaction</code></b> —  ,    -  pgbouncer.            .<br>
<br>
        ,  <b>   </b>  ,     <code>idle_in_transaction_session_timeout</code>.</li>
<li><b> <code>wait</code></b> —   - «»  .       —     .<br>
<br>
     ,  <b>  «» </b>  <code>pg_terminate_backend(pid)</code>.</li>
<li><b> <code>active</code></b> ( max-) ,        «».     -     (, « »)      ,   ,    …<br>
<br>
   —       ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">«» </a>.</li>
<li><b><code>maintenance</code></b> —    ,     - :<br>
<br>
<pre><code class="plaintext hljs">query ~* E'^(\\s*(--[^\\n]*\\n|/\\*.*\\*/|\\n))*(autovacuum|VACUUM|ANALYZE|REINDEX|CLUSTER|CREATE|ALTER|TRUNCATE|DROP)'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In den meisten Fällen wird gleichzeitig die Anzahl der automatischen Vakuum- / Autoanalysen ausgeführt, deren Schaden nur darin besteht, Serverressourcen für "fremde" Fälle zu verwenden. </font><font style="vertical-align: inherit;">Wenn dies für Sie kritisch ist - drehen </font></font><code>autovacuum_max_workers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>autovacuum_naptime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aber </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vollständig ausschalten - sollten Sie dies nicht tun</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn jedoch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gleichzeitig zu wachsen beginnt </font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und</font></font><code>maintenance</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es eine Chance ist, zu sehen, ob sich jemand entschlossen hat, den DBA- oder Entwicklercode einzuführen, um beispielsweise die Hälfte der Wahrscheinlichkeit funktionsfähiger Anwendungen zu blockieren.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da es für uns wichtig ist, nicht nur viele Metriken zu entfernen, sondern dies auch so effizient wie möglich zu tun, versuchen wir, einige davon im Rahmen einer Anfrage synchron aufzunehmen:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbindungs- und Sperrstatus</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> event_types(wait_event_type) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'lwlock'</span>)<font></font>
  , (<span class="hljs-string">'lock'</span>)<font></font>
  , (<span class="hljs-string">'bufferpin'</span>)<font></font>
  , (<span class="hljs-string">'client'</span>)<font></font>
  , (<span class="hljs-string">'extension'</span>)<font></font>
  , (<span class="hljs-string">'ipc'</span>)<font></font>
  , (<span class="hljs-string">'timeout'</span>)<font></font>
  , (<span class="hljs-string">'io'</span>)<font></font>
)<font></font>
, <span class="hljs-keyword">events</span>(wait_event) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'walwritelock'</span>)<font></font>
  , (<span class="hljs-string">'wal_insert'</span>)<font></font>
  , (<span class="hljs-string">'buffer_content'</span>)<font></font>
  , (<span class="hljs-string">'buffer_io'</span>)<font></font>
  , (<span class="hljs-string">'lock_manager'</span>)<font></font>
  , (<span class="hljs-string">'relation'</span>)<font></font>
  , (<span class="hljs-string">'extend'</span>)<font></font>
  , (<span class="hljs-string">'page'</span>)<font></font>
  , (<span class="hljs-string">'tuple'</span>)<font></font>
  , (<span class="hljs-string">'transactionid'</span>)<font></font>
  , (<span class="hljs-string">'virtualxid'</span>)<font></font>
  , (<span class="hljs-string">'speculative token'</span>)<font></font>
  , (<span class="hljs-string">'object'</span>)<font></font>
  , (<span class="hljs-string">'userlock'</span>)<font></font>
  , (<span class="hljs-string">'advisory'</span>)<font></font>
  , (<span class="hljs-string">'clientread'</span>)<font></font>
  , (<span class="hljs-string">'datafileextend'</span>)<font></font>
  , (<span class="hljs-string">'datafileread'</span>)<font></font>
  , (<span class="hljs-string">'datafilewrite'</span>)<font></font>
  , (<span class="hljs-string">'slruread'</span>)<font></font>
  , (<span class="hljs-string">'slruwrite'</span>)<font></font>
)<font></font>
, states(state) <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'running'</span>)<font></font>
  , (<span class="hljs-string">'maintenance'</span>)<font></font>
  , (<span class="hljs-string">'waiting'</span>)<font></font>
  , (<span class="hljs-string">'transaction'</span>)<font></font>
  , (<span class="hljs-string">'idle'</span>)<font></font>
)<font></font>
, stats <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">SELECT</span><font></font>
    pid<font></font>
  , datname<font></font>
  , state<font></font>
  , <span class="hljs-keyword">lower</span>(wait_event_type) wait_event_type<font></font>
  , <span class="hljs-keyword">lower</span>(wait_event) wait_event<font></font>
  , <span class="hljs-keyword">query</span>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_stat_activity<font></font>
  <span class="hljs-keyword">WHERE</span><font></font>
    pid &lt;&gt; pg_backend_pid()<font></font>
)<font></font>
, dbs <span class="hljs-keyword">AS</span>(
  <span class="hljs-keyword">SELECT</span><font></font>
    datname<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_database db<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> db.datistemplate<font></font>
)<font></font>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(s.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , states.state<font></font>
  , <span class="hljs-literal">true</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span><font></font>
    states<font></font>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , <span class="hljs-keyword">CASE</span>
          <span class="hljs-keyword">WHEN</span> <span class="hljs-keyword">query</span> ~* E<span class="hljs-string">'^(\\s*(--[^\\n]*\\n|/\\*.*\\*/|\\n))*(autovacuum|VACUUM|ANALYZE|REINDEX|CLUSTER|CREATE|ALTER|TRUNCATE|DROP)'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'maintenance'</span>
          <span class="hljs-keyword">WHEN</span> wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
            wait_event &lt;&gt; <span class="hljs-string">'clientread'</span> <span class="hljs-keyword">AND</span>
            state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'waiting'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'active'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'running'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'idle'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'idle'</span>
          <span class="hljs-keyword">WHEN</span> state <span class="hljs-keyword">IN</span> (<span class="hljs-string">'idle in transaction'</span>, <span class="hljs-string">'idle in transaction (aborted)'</span>) <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'transaction'</span>
          <span class="hljs-keyword">WHEN</span> state = <span class="hljs-string">'fastpath function call'</span> <span class="hljs-keyword">THEN</span>
            <span class="hljs-string">'fastpath'</span>
          <span class="hljs-keyword">ELSE</span>
            <span class="hljs-string">'disabled'</span>
        <span class="hljs-keyword">END</span> state<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) s<font></font>
<span class="hljs-keyword">UNION</span>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(t.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , event_types.wait_event_type<font></font>
  , <span class="hljs-literal">false</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span><font></font>
    event_types<font></font>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , wait_event_type<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">WHERE</span>
        wait_event_type <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) t<font></font>
<span class="hljs-keyword">UNION</span>
  <span class="hljs-keyword">SELECT</span>
    date_part(<span class="hljs-string">'epoch'</span>, <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
  , <span class="hljs-keyword">coalesce</span>(e.qty, <span class="hljs-number">0</span>) val<font></font>
  , dbs.datname dbname<font></font>
  , events.wait_event<font></font>
  , <span class="hljs-literal">false</span> total
  <span class="hljs-keyword">FROM</span><font></font>
    dbs<font></font>
  <span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span>
    <span class="hljs-keyword">events</span>
  <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
    (<font></font>
      <span class="hljs-keyword">SELECT</span><font></font>
        datname<font></font>
      , wait_event<font></font>
      , <span class="hljs-keyword">count</span>(*) qty
      <span class="hljs-keyword">FROM</span><font></font>
        stats<font></font>
      <span class="hljs-keyword">WHERE</span>
        wait_event <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">2</span><font></font>
    ) e;<font></font>
</code></pre></div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schlösser</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir im vorherigen Absatz auf die Überwachung von Sperren eingegangen sind, ist es erwähnenswert, dass PostgreSQL sie gerne links und rechts anwendet: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nz/jl/vd/nzjlvdmvxaaqxdotpshnyuhydlo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Von diesen interessieren uns zwei Arten am meisten:</font></font><br>
<br>
<ul>
<li><b><code>Exclusive</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - tritt normalerweise auf, wenn ein bestimmter Datensatz gesperrt wird.</font></font></li>
<li><b><code>AccessExclusive</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - bei Wartungsarbeiten am Tisch.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie jedoch nicht, dass die Gesamtzahl </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Schlösser nicht aus Gummi besteht</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sowohl empfohlene als auch reguläre Sperren werden im gemeinsam genutzten Speicherbereich gespeichert, dessen Größe durch die Konfigurationsparameter </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und bestimmt wird </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es ist wichtig, dass dieser Speicher ausreichend ist, da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Server sonst </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keine</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sperre </font><font style="vertical-align: inherit;">ausstellen </font><u><font style="vertical-align: inherit;">kann</font></u></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Daher ist die Anzahl der empfohlenen Sperren, die ein Server ausgeben kann, je nach Serverkonfiguration normalerweise auf Zehntausende oder Hunderttausende begrenzt.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In der Regel tritt diese Situation auf, wenn Ihre Anwendung „fließt“ und Ressourcen nicht freigegeben werden: Verbindungen zur Datenbank, Transaktionskontexte oder </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beratungssperren</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Achten Sie daher auf die Gesamtdynamik.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transaktionen pro Sekunde (TPS)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Informationen zu Änderungen im Kontext der aktuellen Datenbank </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abzurufen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , können Sie die Systemansicht </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">pg_stat_database verwenden</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wenn sich jedoch viele Datenbanken auf dem Server befinden, ist es praktisch, dies sofort für alle zu tun und eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verbindung zu herzustellen</font></font><code>postgres</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TPS &amp; Tupel</font></font></b>
                        <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">extract</span>(epoch <span class="hljs-keyword">from</span> <span class="hljs-keyword">now</span>())::<span class="hljs-built_in">integer</span> ts<font></font>
, datname dbname<font></font>
, pg_stat_get_db_tuples_returned(<span class="hljs-keyword">oid</span>) tup_returned<font></font>
, pg_stat_get_db_tuples_fetched(<span class="hljs-keyword">oid</span>) tup_fetched<font></font>
, pg_stat_get_db_tuples_inserted(<span class="hljs-keyword">oid</span>) tup_inserted<font></font>
, pg_stat_get_db_tuples_updated(<span class="hljs-keyword">oid</span>) tup_updated<font></font>
, pg_stat_get_db_tuples_deleted(<span class="hljs-keyword">oid</span>) tup_deleted<font></font>
, pg_stat_get_db_xact_commit(<span class="hljs-keyword">oid</span>) xact_commit<font></font>
, pg_stat_get_db_xact_rollback(<span class="hljs-keyword">oid</span>) xact_rollback
<span class="hljs-keyword">FROM</span><font></font>
  pg_database<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">NOT</span> datistemplate;
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich möchte separat hervorheben - vernachlässigen Sie nicht die Ausgabe von </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maximalwerten von</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Metriken! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ls/yn/yt/lsynyt4rkawj8hvp2pcrnvjiozk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser Grafik sehen wir deutlich die Situation eines plötzlichen Spitzenanstiegs der Anzahl der durchgeführten ( </font></font><b><code>commit</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Transaktionen. </font><font style="vertical-align: inherit;">Dies ist kein Einzelgespräch, das der Auslastung des Servers entspricht, und Transaktionen können unterschiedlich komplex sein. Ein vierfaches Wachstum zeigt jedoch deutlich, dass der Server </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">über eine bestimmte Leistungsreserve verfügen sollte, um einen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solchen Spitzenwert problemlos zu überstehen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun, das Rollback ( </font></font><b><code>rollback</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) der Transaktion ist eine Gelegenheit, um zu überprüfen, ob Ihre Anwendung bewusst ausgeführt </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird oder ob der Server dies aufgrund eines Fehlers automatisch tut.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzahl der Operationen an Datensätzen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Achten Sie zunächst auf die Datensätze, die wir von Indizes / Tabellen abziehen:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/av/sw/dmavswryoevflquj7krtbykqgtw.png"><br>
<br>
<ul>
<li><b><code>tuples.returned</code></b> —   ,   «»   .</li>
<li><b><code>tuples.fetched</code></b> —   ,     « »   <code>Rows Removed by Filter</code>,   «»   .</li>
<li><b><code>tuples.ratio</code></b> — ,    ,  <b>   1</b>,   —  .   ,  ,       ,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie einen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scharfen Peak beobachten</font></font><code>tuples.ratio</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , können Sie sicher sein, dass eine ineffiziente Anfrage aus der im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beschriebenen Kategorie </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">zu Rezepten für deren Behandlung</font></a><font style="vertical-align: inherit;"> im Protokoll auf Sie zukommt </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Allerdings, auch wenn im </font></font><code>ratio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idealfall gleich 1, aber der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peak fiel</font></font><code>returned/fetched</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - auch nicht gut erwarten. Normalerweise kann dies bedeuten, dass der Plan irgendwelche Probleme enthält, wie zum Beispiel:</font></font><br>
<br>
<pre><code class="plaintext hljs">Hash Join<font></font>
  - Hash<font></font>
    - Seq Scan on BIG_TABLE<font></font>
  - Index Scan ...</code></pre><br>
<pre><code class="plaintext hljs">Merge Join<font></font>
  - Index Scan on BIG_INDEX<font></font>
  - Index Scan ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da wir zu überprüfen begonnen haben, was dort gelesen wird, wollen wir sehen, wie es passiert. </font><font style="vertical-align: inherit;">Das heißt, wie viele Datensätze wir von Indizes lesen und wie viel als Ergebnis </font></font><b><code>Seq Scan</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7y/3o/xq/7y3oxqadodpa_zgrhyv0nfxzzua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist klar, dass hier ein ungeplanter Anstieg der Indikatoren Verdacht erregen sollte. </font><font style="vertical-align: inherit;">Wenn Sie beispielsweise aus irgendeinem Grund jede Nacht eine ganze Platte mit 10 Millionen Datensätzen lesen müssen, ist das Auftreten eines solchen Peaks während des Tages ein Grund für die Demontage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sowie alle massenanomalen Einfügungen / Aktualisierungen / Löschungen:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/85/pn/dl/85pndlf5hstls4os3jwmtsuserc.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datencache verwenden</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um zu verstehen, wie das Massen-Korrekturlesen von Datensätzen die Lebensdauer des Servers wirklich verschlechtert, schauen wir uns die Arbeit des Servers mit Datenseiten und das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verhältnis an</font></font><code>block.read/hit</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In einer idealen Welt sollte der Server </font></font><code>shared read</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">absolut nichts </font><font style="vertical-align: inherit;">von der Festplatte ( </font><font style="vertical-align: inherit;">auf dem Plan-Knoten) </font><font style="vertical-align: inherit;">„lesen“ </font><font style="vertical-align: inherit;">, alles sollte sich bereits im Speicher befinden ( </font></font><code>shared hit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), da der </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zugriff auf die Festplatte immer langsam ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Wirklichkeit ist dies nicht ganz richtig und der Grund für eine gründliche Analyse der Anfragen um die Spitzenzeit:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/ue/xl/btuexl-qt3d384qarrm0n6chlr0.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Längste Anfrage / Transaktion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für MVCC sind lang laufende Abfragen und Transaktionen in ausgelasteten Systemen eine Leistungskatastrophe. </font><font style="vertical-align: inherit;">Details und Bilder dazu finden Sie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - wie können Sie unter solchen Bedingungen noch überleben? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a0/jl/ls/a0jllsvlvmsny6hhyq_mjnhnmli.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solche Bösewichte zu fangen hilft uns </font></font><code>pg_stat_activity.query_start/xact_start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie unsere Erfahrung zeigt, reicht eine visuelle Darstellung dieser Metriken bereits aus, um grob darzustellen, wo weiter "gegraben" werden muss:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suchen Sie in der Anwendung nach Ressourcenlecks</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehlgeschlagene Anforderungen optimieren</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setzen Sie produktivere Hardware</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... oder stellen Sie sicher, dass die Last rechtzeitig richtig verteilt ist</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de502460/index.html">Was erwartet Sie in der Startup-Arena der Ukraine im Jahr 2020?</a></li>
<li><a href="../de502462/index.html">Digitale Veranstaltungen in Moskau vom 18. bis 24. Mai</a></li>
<li><a href="../de502464/index.html">Digitale Veranstaltungen in St. Petersburg vom 18. bis 24. Mai</a></li>
<li><a href="../de502466/index.html">Neues RIT ++ unter den neuen Bedingungen</a></li>
<li><a href="../de502472/index.html">Prometheus-Überwachung von Microservice-Anwendungen. Vitaly Levchenko</a></li>
<li><a href="../de502480/index.html">Was ist DHCP-Snooping und wie funktioniert es?</a></li>
<li><a href="../de502486/index.html">Das Buch "Rennen mit der Epidemie. Antibiotika gegen Superbugs "</a></li>
<li><a href="../de502490/index.html">Blinkende restriktive Überzeugungen. Für was und was gibt es</a></li>
<li><a href="../de502492/index.html">Innovationen in Zextras Suite und Zimbra OSE</a></li>
<li><a href="../de502494/index.html">7 Fehler eines Black Friday und wie Magento Cloud funktioniert - Video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>