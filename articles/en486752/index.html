<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö© üå≠ üïé Unique WSGI web server using ESP8266. Part 1 üëÜüèª üê´ ‚ò¶Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone! 
 
 This article is the first part of my tutorial on developing a rather unusual WSGI server. In this article I will explain the theor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unique WSGI web server using ESP8266. Part 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486752/"><img src="https://habrastorage.org/webt/2g/wi/wb/2gwiwbq1_ed0lwgklvoy8kqsayi.png" align="left"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello everyone! </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article is the first part of my tutorial on developing a rather unusual WSGI server. </font><font style="vertical-align: inherit;">In this article I will explain the theoretical part of my idea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main audience is novice developers who are familiar with Python but want to know the zen of the http protocol. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ready? </font><font style="vertical-align: inherit;">Let's go under the cat.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intro </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, this article is a textual accompaniment to my video (I'm trying to maintain a video blog). If interested, a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video on Youtube</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Have you ever had the idea to write a program that no one else wrote? Something to the point of madness unique, absolutely (or close to absolute) useless, but interesting? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No? Well, thank God, normal people read me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And I conceived a unique and very interesting project, the implementation of which will allow me and the reader to understand in practice how http and the web server actually work. This project will plunge the reader into the world of madness http specifications, the paradox of regular expressions and driver imperfections :-). What will allow you to know all the pain of low-level development and enjoy simple dumb user requirements</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 By the way, maybe you will be surprised, but the idea of ‚Äã‚Äãthis project was not born out of nowhere. </font><font style="vertical-align: inherit;">The fact is that I have a Raspberry PI Zero without Wi-Fi and NodeMCU with wi-fi. </font><font style="vertical-align: inherit;">So I thought - is it possible to write a web server on Django and host on a Raspberry PI while connecting to the network via Wi-Fi. </font><font style="vertical-align: inherit;">A normal person would have thought of either buying a raspberry with Wi-Fi or connecting a Wi-Fi adapter to a raspberry. </font><font style="vertical-align: inherit;">I came up with the idea of ‚Äã‚Äãconnecting the ESP8266 to the raspberry, but since the ESP8266 cannot work as a network adapter, the idea came to me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fuh, I hope I justified. </font><font style="vertical-align: inherit;">Now to the point</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theory</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 A web server is a rather complicated thing that works at a low level with sockets, parses raw http requests, parsing headers, manages connections, balances the load, etc. And it‚Äôs better to keep this complex module separate because the web application is already operating with higher-level concepts of models, controllers and views. Both components are necessary and important for the work of the web, but the areas of knowledge necessary for their development do not overlap much, so it is better for them to know as little as possible about each other. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you know, there are many compatible with written in Python web server applications (Gunicorn, Bojern, CherryPy, but not many of them). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As well as there are many web frameworks that can work with any of these web servers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How does this happen? It's simple - we need a standard and this standard is called WSGI. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/8ba/d1c/7a9/8bad1c7a923c50240e6ebb6fbce51465.png" alt="image"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 1 WSGI</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
WSGI is part of the PEP specification and allows you to use various frameworks and web applications with almost no concern for their compatibility. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the following illustration perfectly demonstrates my idea of ‚Äã‚Äãa Python web server </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a34/c40/ccd/a34c40ccd0f6ed6e94d812addf8a0fcd.png" alt="image"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The reader could notice ESP8266 in the picture - no, I won‚Äôt place the web server on this device, since it would be too commonplace compared to my idea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ESP8266 is flashed with factory AT firmware, and accepts only AT commands. But most importantly, with the help of AT commands, he can raise sosket north, which will receive http requests from the client (receive via WiFi) and broadcast them via the serial port</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the serial port, ESP transmits 2 important parameters - the socket ID, indicating that we will return a response to the client. ESP8266, by the way, supports a maximum of 4 simultaneous socket connections. And of course, the http request </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our python 3 web server parses http by folding the headers into a special environment object and raises the application object by passing it the start_response method with which our application will return the response and the environment dictionary which contains all the necessary headers and the body of the http request (necessary methods and the required environment dictionary keys are a key part of the WSGI specification)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the framework processes the request and forms the response, it pulls the start_response method, in this method we get the parameters needed to form the http response, build the raw html string, and transfer the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
whole thing to the client </font><font style="vertical-align: inherit;">via the serial port in ESP8266. </font><font style="vertical-align: inherit;">ESP8266, in turn </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
, I found the correct way to flash ESP8266 AT with factory firmware in an excellent article, the link to which you will find under number 2 in the ‚ÄúUseful URLs‚Äù section. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For AT commands, communication with ESP8266 is as follows (I use ESPloter shell for communication) </font><font style="vertical-align: inherit;">I assume that the ESP8266 has WiFi. </font><font style="vertical-align: inherit;">If Wi-Fi is not raised - it is also easy to do through ESPloter</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command AT + CIPMUX = 1 - opens multiple connection</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command AT + CIPSERVER = 1.80 (port 80, which we open)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After entering these commands, we raised the TCP server to ESP8266 and can receive requests from the client. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also return the response to the client with 2 commands </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - AT + CIPSEND command = socket number, number of bytes </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After this command is completed, the terminal will wait for a message of the specified number of bytes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we enter enough characters, the transmission session will end and we will need to enter a new command </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AT + CIPCLOSE = number socket. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, the browser ends the session and displays the transmitted text. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all for today. </font><font style="vertical-align: inherit;">I hope in the next week I will add and lay out the practical part. </font><font style="vertical-align: inherit;">I have a number of problems, mainly with the operation of the terminal and http parsing, but they seem to be solvable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank! </font><font style="vertical-align: inherit;">Till.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Useful URLs</font></font></h3> <br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article of </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Let`s Build A Web Server</font></a><font style="vertical-align: inherit;"> helped me a lot in this project.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The article </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Restoring AT Firmware on the ESP8266</font></a><font style="vertical-align: inherit;"> helped me </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flash ESP8266</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not underestimate the power of official documentation. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examples of AT commands</font></font></a></li>
</ol></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486740/index.html">Writing an API in Rust using procedural macros</a></li>
<li><a href="../en486742/index.html">Interview with Anatoly Wasserman about the Future</a></li>
<li><a href="../en486744/index.html">A smart domestic-made posture corrector went on sale. We looked at the new product - IBACK</a></li>
<li><a href="../en486746/index.html">Write, do not cut. What I began to miss in Habr's publications</a></li>
<li><a href="../en486750/index.html">The series "For All Mankind": from an alternative story to trash</a></li>
<li><a href="../en486754/index.html">JIRA: rules for the timely preparation of delicious software. TLDR 2: requirements management</a></li>
<li><a href="../en486756/index.html">Python for the tester: how small c pandas scripts help test large datasets</a></li>
<li><a href="../en486760/index.html">Security Week 06: advertising trackers in mobile applications</a></li>
<li><a href="../en486762/index.html">Bedside hosting: the creepy practice of home hosting</a></li>
<li><a href="../en486764/index.html">Do-it-yourself Schema.org: customizing micro-layout without a programmer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>