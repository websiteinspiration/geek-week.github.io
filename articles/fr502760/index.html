<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëµüèæ üé± üë©üèº‚Äçüé§ Qu'est-ce que MagicString et ces lignes sont-elles si magiques? ü•Ç ‚õ©Ô∏è üôä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MagicString est une biblioth√®que peu connue. Malgr√© cela, il r√©sout l'un des probl√®mes les plus urgents - changer le code source en utilisant sa struc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Qu'est-ce que MagicString et ces lignes sont-elles si magiques?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502760/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MagicString est une biblioth√®que peu connue. </font><font style="vertical-align: inherit;">Malgr√© cela, il r√©sout l'un des probl√®mes les plus urgents - changer le code source en utilisant sa structure (AST - arbre de syntaxe abstraite). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous apprendrons ce qu'est MagicString et si ces lignes sont vraiment ¬´magiques¬ª. </font><font style="vertical-align: inherit;">Cela nous aidera √† comprendre le prochain article dans lequel j'expliquerai comment nous avons r√©ussi √† traduire la documentation Angular si rapidement, et comment cela aidera √† la cr√©ation d'un traducteur universel pour Markdown et les fichiers de tout autre format.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/te/vs/2s/tevs2snderlng8i4ucqdjp6q2t8.jpeg"><br>
<br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a 2 semaines, j'ai publi√© la documentation en langue russe d'Angular ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">angular24.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Pendant ce temps, 35 probl√®mes ont √©t√© ajout√©s avec des corrections dans le texte et 2 pull request. Je doutais sinc√®rement que le syst√®me dans lequel vous s√©lectionnez le texte, offrez une traduction et √©mettez automatiquement sur GitHub fonctionnera. Mais le crowdsourcing fonctionne! :) Vous pouvez en savoir plus √† ce sujet dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cet article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s la sortie, l'une des questions les plus pos√©es √©tait: ¬´Pourquoi?¬ª. La question est absolument correcte, mais pour y r√©pondre, vous devez d'abord comprendre ce qu'est MagicString, comment il fonctionne et comment il est utile. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous ayons un code source simple:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulons remplacer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La solution la plus simple consiste √† remplacer const par var par le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String.prototype.replace</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> habituel </font><font style="vertical-align: inherit;">. Et pour cette t√¢che, c'est probablement la solution la plus correcte. Mais que faire si nous devons remplacer const par var uniquement dans la port√©e globale? Mais ne les remplacez pas √† l'int√©rieur des fonctions? Vous pouvez, bien s√ªr, proposer une r√©gularit√© plus complexe ou √©crire du code d√©licat, mais il existe un moyen plus √©volutif et flexible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons utiliser les analyseurs pour obtenir AST - Abstract Syntax Tree. Si vous √™tes int√©ress√© par ce qu'est l'AST, rendez-vous sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">astexplorer.net</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il s'agit essentiellement d'un arbre qui affiche avec pr√©cision la structure de votre code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, chacun des n≈ìuds de cette AST a un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©but</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et des </font><font style="vertical-align: inherit;">index de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indiquant les positions de ces √©l√©ments dans le code source. Connaissant ces coordonn√©es et ayant √† port√©e de main la structure du document, nous pouvons effectuer des remplacements et permutations complexes en pr√©servant la structure du document. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/ox/o-/sroxo-of0k9wyxj-e8zdd-3rebe.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, le remplacement se fait √† l'aide de la conception de mod√®le de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">visiteur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de plusieurs </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assistants</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui s'enveloppent g√©n√©ralement dans une seule biblioth√®que, qui peut √™tre appel√©e ¬´API de transformateur¬ª. Chaque analyseur poss√®de sa propre "API de transformateur". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces biblioth√®ques sont tr√®s faciles √† utiliser, mais elles ont plusieurs probl√®mes. L'un d'eux est la performance.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âtant donn√© que chaque (enfin, presque chaque) n≈ìud de l'arbre AST contient des coordonn√©es, lors du changement d'un n≈ìud, nous devons souvent mettre √† jour les coordonn√©es du reste de l'arbre. Ici, vous pouvez affirmer que vous pouvez le faire avec un peu de sang - ne mettez pas √† jour les coordonn√©es partout, mais restituez simplement l'AST au texte en fonction de la structure. Mais il y a 1 probl√®me: vous perdrez imm√©diatement la mise en forme du texte d'origine, ce qui contredit notre t√¢che - remplacer const par var dans la ligne existante. En fait, nous obtenons une nouvelle ligne avec un nouveau formatage. Et si ce n'est pas un probl√®me pour une petite ligne, imaginez un fichier de 1000 lignes dans lequel la mise en forme a compl√®tement chang√© suite au remplacement de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cela ne semble pas tr√®s bon.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9c/f4/0c/9cf40cjrgwepibssksrrwry2dw8.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici la magie de MagicString. J'ai d'abord appris leur existence gr√¢ce au projet Rich Harris, appel√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Butternut</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le noyer cendr√© est un minifieur JavaScript. Butternutt aurait √©t√© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plus rapide qu'UglifyJS </font><font style="vertical-align: inherit;">et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10-15 fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plus rapide que Babili </font><font style="vertical-align: inherit;">. Je vais continuer et dire que le projet √©tait recouvert d'un bassin en cuivre il y a au moins 3 ans. Mais m√™me alors, j'ai √©t√© intrigu√© par le secret de sa performance. C'√©tait un MagicString. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetons un coup d'≈ìil √† l'utilisation de MagicString:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> MagicString = <span class="hljs-built_in">require</span>( <span class="hljs-string">'magic-string'</span> );
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> MagicString( <span class="hljs-string">'const a = 1; const b = 2;'</span> );<font></font>
<font></font>
s.overwrite( <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'var'</span> );<font></font>
s.toString(); <span class="hljs-comment">// 'var a = 1; const b = 2;'</span><font></font>
<font></font>
<span class="hljs-comment">//  </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'algorithme de MagicString est tr√®s simple: nous enveloppons la cha√Æne d'origine dans un objet dans lequel nous n'appliquons pas directement les modifications √† la cha√Æne, mais ajoutons les coordonn√©es et ce qui doit √™tre fait dans un tableau pour l'avenir. </font><font style="vertical-align: inherit;">Et seulement lorsque quelqu'un veut obtenir la ligne r√©sultante, nous commen√ßons 1 √† 1 pour effectuer les op√©rations accumul√©es. </font><font style="vertical-align: inherit;">Par exemple:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons remplac√© const par var, commen√ßant √† l'index 0 et se terminant √† l'index 5</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous savons que tous les remplacements ult√©rieurs doivent avoir un index inf√©rieur √† 2 (var inf√©rieur √† const de 2 caract√®res, une ligne plus courte)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous mettons √† jour les coordonn√©es de toutes les op√©rations</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous appliquons l'op√©ration suivante, etc.</font></font></li>
</ol><br>
<br>
<img src="https://habrastorage.org/webt/fy/us/kz/fyuskzc54fgvtkxeuwbldzpp2xq.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout semble assez simple. Mais pourquoi MagicString est-il plus rapide? La r√©ponse est assez simple: le nombre d'op√©rations que nous effectuons sur notre arbre est bien inf√©rieur au nombre de n≈ìuds AST. Sans parler de la quantit√© de m√©moire n√©cessaire pour l'AST et du fait que la travers√©e d'arbre (se d√©pla√ßant √† travers un arbre) n'est pas une op√©ration gratuite, mais O (n + m)</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b8/5b/jw/b85bjw9enaiibwd0vo3mbmbk198.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et si je suis pr√™t √† attendre une demi-heure suppl√©mentaire? Et voici le deuxi√®me plus de MagicString. Chaque analyseur invente sa propre API pour la transformation. Et c'est toujours tr√®s bien, s'il existe une telle API (tous les analyseurs ne la fournissent pas), tr√®s souvent nous nous retrouvons sans la possibilit√© de remplacer normalement le texte source en utilisant AST. Mais MagicString est une API universelle unique pour changer la cha√Æne source. Peu importe quel analyseur ou combinaison d'analyseurs vous avez utilis√©. Avec MagicString, vous pouvez aussi bien travailler avec n'importe quel AST. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/63/7v/jf/637vjfnual-mzplhm5ligr1u3bs.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re que MagicString vous int√©resse. Dans le prochain article, je parlerai du double MagicString et comment faire un traducteur universel de documents Markdown. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abonnez-vous √† ma cha√Æne Telegram </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@obenjiro_notes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et Twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obenjiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afin de ne pas manquer les articles suivants sur le sujet et bien d'autres choses int√©ressantes.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502740/index.html">Comment d√©sinfecter les avions √† l'√®re de Covid-19?</a></li>
<li><a href="../fr502742/index.html">Nous vous invitons √† DINS DevOps EVENING (en ligne): l'√©volution de Prometheus et Zabbix et le traitement des logs Nginx dans ClickHouse</a></li>
<li><a href="../fr502744/index.html">10 grands r√©f√©rentiels de d√©veloppeurs Github (partie 2)</a></li>
<li><a href="../fr502746/index.html">Productivit√© et motivation √† distance: les entreprises informatiques russes partagent 2 mois d'exp√©rience isol√©ment</a></li>
<li><a href="../fr502752/index.html">3 pi√®ges dans lesquels tombent les Data Scientists d√©butants</a></li>
<li><a href="../fr502762/index.html">Diff√©rentes fa√ßons de transmettre des donn√©es aux composants angulaires</a></li>
<li><a href="../fr502768/index.html">Le titre de cet article a √©t√© invent√© par un ordinateur.</a></li>
<li><a href="../fr502770/index.html">Nous d√©voilons ProLock: analyse des actions des nouveaux op√©rateurs de ransomware utilisant la matrice MITRE ATT & CK</a></li>
<li><a href="../fr502772/index.html">Comment cr√©er un serveur PostgreSQL sur Google Cloud Platform SQL</a></li>
<li><a href="../fr502782/index.html">Joel Spolsky: niveau d'abstraction pour les d√©veloppeurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>