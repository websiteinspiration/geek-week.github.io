<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👵🏾 🎱 👩🏼‍🎤 Qu'est-ce que MagicString et ces lignes sont-elles si magiques? 🥂 ⛩️ 🙊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MagicString est une bibliothèque peu connue. Malgré cela, il résout l'un des problèmes les plus urgents - changer le code source en utilisant sa struc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Qu'est-ce que MagicString et ces lignes sont-elles si magiques?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502760/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MagicString est une bibliothèque peu connue. </font><font style="vertical-align: inherit;">Malgré cela, il résout l'un des problèmes les plus urgents - changer le code source en utilisant sa structure (AST - arbre de syntaxe abstraite). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, nous apprendrons ce qu'est MagicString et si ces lignes sont vraiment «magiques». </font><font style="vertical-align: inherit;">Cela nous aidera à comprendre le prochain article dans lequel j'expliquerai comment nous avons réussi à traduire la documentation Angular si rapidement, et comment cela aidera à la création d'un traducteur universel pour Markdown et les fichiers de tout autre format.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/te/vs/2s/tevs2snderlng8i4ucqdjp6q2t8.jpeg"><br>
<br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a 2 semaines, j'ai publié la documentation en langue russe d'Angular ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">angular24.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Pendant ce temps, 35 problèmes ont été ajoutés avec des corrections dans le texte et 2 pull request. Je doutais sincèrement que le système dans lequel vous sélectionnez le texte, offrez une traduction et émettez automatiquement sur GitHub fonctionnera. Mais le crowdsourcing fonctionne! :) Vous pouvez en savoir plus à ce sujet dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cet article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après la sortie, l'une des questions les plus posées était: «Pourquoi?». La question est absolument correcte, mais pour y répondre, vous devez d'abord comprendre ce qu'est MagicString, comment il fonctionne et comment il est utile. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous ayons un code source simple:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulons remplacer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La solution la plus simple consiste à remplacer const par var par le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">String.prototype.replace</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> habituel </font><font style="vertical-align: inherit;">. Et pour cette tâche, c'est probablement la solution la plus correcte. Mais que faire si nous devons remplacer const par var uniquement dans la portée globale? Mais ne les remplacez pas à l'intérieur des fonctions? Vous pouvez, bien sûr, proposer une régularité plus complexe ou écrire du code délicat, mais il existe un moyen plus évolutif et flexible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons utiliser les analyseurs pour obtenir AST - Abstract Syntax Tree. Si vous êtes intéressé par ce qu'est l'AST, rendez-vous sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">astexplorer.net</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il s'agit essentiellement d'un arbre qui affiche avec précision la structure de votre code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, chacun des nœuds de cette AST a un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">début</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et des </font><font style="vertical-align: inherit;">index de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indiquant les positions de ces éléments dans le code source. Connaissant ces coordonnées et ayant à portée de main la structure du document, nous pouvons effectuer des remplacements et permutations complexes en préservant la structure du document. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/ox/o-/sroxo-of0k9wyxj-e8zdd-3rebe.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, le remplacement se fait à l'aide de la conception de modèle de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">visiteur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et de plusieurs </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assistants</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui s'enveloppent généralement dans une seule bibliothèque, qui peut être appelée «API de transformateur». Chaque analyseur possède sa propre "API de transformateur". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces bibliothèques sont très faciles à utiliser, mais elles ont plusieurs problèmes. L'un d'eux est la performance.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que chaque (enfin, presque chaque) nœud de l'arbre AST contient des coordonnées, lors du changement d'un nœud, nous devons souvent mettre à jour les coordonnées du reste de l'arbre. Ici, vous pouvez affirmer que vous pouvez le faire avec un peu de sang - ne mettez pas à jour les coordonnées partout, mais restituez simplement l'AST au texte en fonction de la structure. Mais il y a 1 problème: vous perdrez immédiatement la mise en forme du texte d'origine, ce qui contredit notre tâche - remplacer const par var dans la ligne existante. En fait, nous obtenons une nouvelle ligne avec un nouveau formatage. Et si ce n'est pas un problème pour une petite ligne, imaginez un fichier de 1000 lignes dans lequel la mise en forme a complètement changé suite au remplacement de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">var</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Cela ne semble pas très bon.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9c/f4/0c/9cf40cjrgwepibssksrrwry2dw8.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voici la magie de MagicString. J'ai d'abord appris leur existence grâce au projet Rich Harris, appelé </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Butternut</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le noyer cendré est un minifieur JavaScript. Butternutt aurait été </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plus rapide qu'UglifyJS </font><font style="vertical-align: inherit;">et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10-15 fois</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> plus rapide que Babili </font><font style="vertical-align: inherit;">. Je vais continuer et dire que le projet était recouvert d'un bassin en cuivre il y a au moins 3 ans. Mais même alors, j'ai été intrigué par le secret de sa performance. C'était un MagicString. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetons un coup d'œil à l'utilisation de MagicString:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> MagicString = <span class="hljs-built_in">require</span>( <span class="hljs-string">'magic-string'</span> );
<span class="hljs-keyword">var</span> s = <span class="hljs-keyword">new</span> MagicString( <span class="hljs-string">'const a = 1; const b = 2;'</span> );<font></font>
<font></font>
s.overwrite( <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'var'</span> );<font></font>
s.toString(); <span class="hljs-comment">// 'var a = 1; const b = 2;'</span><font></font>
<font></font>
<span class="hljs-comment">//  </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'algorithme de MagicString est très simple: nous enveloppons la chaîne d'origine dans un objet dans lequel nous n'appliquons pas directement les modifications à la chaîne, mais ajoutons les coordonnées et ce qui doit être fait dans un tableau pour l'avenir. </font><font style="vertical-align: inherit;">Et seulement lorsque quelqu'un veut obtenir la ligne résultante, nous commençons 1 à 1 pour effectuer les opérations accumulées. </font><font style="vertical-align: inherit;">Par exemple:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons remplacé const par var, commençant à l'index 0 et se terminant à l'index 5</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous savons que tous les remplacements ultérieurs doivent avoir un index inférieur à 2 (var inférieur à const de 2 caractères, une ligne plus courte)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous mettons à jour les coordonnées de toutes les opérations</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous appliquons l'opération suivante, etc.</font></font></li>
</ol><br>
<br>
<img src="https://habrastorage.org/webt/fy/us/kz/fyuskzc54fgvtkxeuwbldzpp2xq.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout semble assez simple. Mais pourquoi MagicString est-il plus rapide? La réponse est assez simple: le nombre d'opérations que nous effectuons sur notre arbre est bien inférieur au nombre de nœuds AST. Sans parler de la quantité de mémoire nécessaire pour l'AST et du fait que la traversée d'arbre (se déplaçant à travers un arbre) n'est pas une opération gratuite, mais O (n + m)</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b8/5b/jw/b85bjw9enaiibwd0vo3mbmbk198.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et si je suis prêt à attendre une demi-heure supplémentaire? Et voici le deuxième plus de MagicString. Chaque analyseur invente sa propre API pour la transformation. Et c'est toujours très bien, s'il existe une telle API (tous les analyseurs ne la fournissent pas), très souvent nous nous retrouvons sans la possibilité de remplacer normalement le texte source en utilisant AST. Mais MagicString est une API universelle unique pour changer la chaîne source. Peu importe quel analyseur ou combinaison d'analyseurs vous avez utilisé. Avec MagicString, vous pouvez aussi bien travailler avec n'importe quel AST. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/63/7v/jf/637vjfnual-mzplhm5ligr1u3bs.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'espère que MagicString vous intéresse. Dans le prochain article, je parlerai du double MagicString et comment faire un traducteur universel de documents Markdown. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abonnez-vous à ma chaîne Telegram </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@obenjiro_notes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et Twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obenjiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afin de ne pas manquer les articles suivants sur le sujet et bien d'autres choses intéressantes.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502740/index.html">Comment désinfecter les avions à l'ère de Covid-19?</a></li>
<li><a href="../fr502742/index.html">Nous vous invitons à DINS DevOps EVENING (en ligne): l'évolution de Prometheus et Zabbix et le traitement des logs Nginx dans ClickHouse</a></li>
<li><a href="../fr502744/index.html">10 grands référentiels de développeurs Github (partie 2)</a></li>
<li><a href="../fr502746/index.html">Productivité et motivation à distance: les entreprises informatiques russes partagent 2 mois d'expérience isolément</a></li>
<li><a href="../fr502752/index.html">3 pièges dans lesquels tombent les Data Scientists débutants</a></li>
<li><a href="../fr502762/index.html">Différentes façons de transmettre des données aux composants angulaires</a></li>
<li><a href="../fr502768/index.html">Le titre de cet article a été inventé par un ordinateur.</a></li>
<li><a href="../fr502770/index.html">Nous dévoilons ProLock: analyse des actions des nouveaux opérateurs de ransomware utilisant la matrice MITRE ATT & CK</a></li>
<li><a href="../fr502772/index.html">Comment créer un serveur PostgreSQL sur Google Cloud Platform SQL</a></li>
<li><a href="../fr502782/index.html">Joel Spolsky: niveau d'abstraction pour les développeurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>