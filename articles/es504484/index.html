<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèø üëç üí™üèΩ IPSec Todopoderoso ü§∑üèæ üà≤ ü§∞üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Buenas tardes amigos. No es ning√∫n secreto que muchos de nosotros tenemos al menos una vez, pero hemos tenido que lidiar con la necesidad de configura...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>IPSec Todopoderoso</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504484/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buenas tardes amigos. </font><font style="vertical-align: inherit;">No es ning√∫n secreto que muchos de nosotros tenemos al menos una vez, pero hemos tenido que lidiar con la necesidad de configurar una VPN. </font><font style="vertical-align: inherit;">Siendo un lector activo de Habr, not√© que a pesar de la abundancia de art√≠culos sobre IPSec, para muchos todav√≠a parece ser algo complicado y sobrecargado. </font><font style="vertical-align: inherit;">En este art√≠culo intentar√© disipar estos mitos usando mi propia configuraci√≥n completamente funcional como ejemplo. </font><font style="vertical-align: inherit;">En cuatro ejemplos, revisaremos completamente la configuraci√≥n de la soluci√≥n Linux (Strongswan) m√°s popular, comenzando desde un t√∫nel simple con autenticaci√≥n de clave PSK de las partes hasta una conexi√≥n de host a host con autenticaci√≥n de ambos lados basada en certificados de Let's Encrypt. </font><font style="vertical-align: inherit;">¬øInteresante? </font><font style="vertical-align: inherit;">¬°Bienvenido a cat!</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecedentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, la VPN se planific√≥ solo para la organizaci√≥n del canal entre el mini-enrutador de los padres y el servidor dom√©stico "cabecera", que al mismo tiempo act√∫a como un enrutador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de un corto per√≠odo de tiempo, Keenetic fue agregado a esta compa√±√≠a desde dos dispositivos. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero una vez que comenz√≥, result√≥ ser dif√≠cil de detener, y pronto aparecieron tel√©fonos y una computadora port√°til en el diagrama, que quer√≠an esconderse del ojo publicitario que todo lo ve de MT_Free y otras redes WiFi no encriptadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, el amado ILV finalmente se fortaleci√≥, el Banhammer, de quien se enamor√≥ incre√≠blemente de hacer pivotar p√∫blicamente en todas las direcciones, y para neutralizar su preocupaci√≥n por los simples mortales, tuvo que </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apoyar al sector de TI extranjero</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para adquirir VPS en el extranjero.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, un cierto ciudadano que se parece a Shapoklyak, correteando por todas partes con su </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ret√≠cula junto al</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Paquete, y probablemente cree que "Qui√©n ayuda a las personas, est√° perdiendo el tiempo". </font><font style="vertical-align: inherit;">No puedes volverte famoso por las buenas acciones ‚Äù. Quer√≠a mirar en secreto el tr√°fico de otra persona y tomarlo con l√°piz. </font><font style="vertical-align: inherit;">Tambi√©n tendremos que defendernos de tal amor no solicitado y VPN en este caso exactamente lo que recet√≥ el m√©dico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resumir un breve resumen. </font><font style="vertical-align: inherit;">Era necesario encontrar una soluci√≥n que idealmente pudiera cerrar varias tareas a la vez:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interconexi√≥n entre enrutadores Linux</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Construye un t√∫nel entre Linux y Keenetic Household</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dar acceso a los recursos dom√©sticos e Internet a dispositivos port√°tiles (tel√©fonos, computadoras port√°tiles) desde redes no confiables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cree un t√∫nel cifrado de forma segura para el VPS remoto</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No te olvides del maravilloso principio KISS: Keep It Simple, Stupid. </font><font style="vertical-align: inherit;">Cuantos menos componentes se involucren y m√°s f√°cil sea configurar cada uno de ellos, m√°s confiable ser√°.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen de soluciones existentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Repase brevemente lo que es ahora: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPTP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Abuelo Lenin de todos los protocolos. </font><font style="vertical-align: inherit;">Muri√≥: "Deca√≠do en el moho y la miel de tilo". </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L2TP</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
¬øAlguien m√°s que un proveedor usa esto? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
proyecto </font><b><font style="vertical-align: inherit;">Wireguard se</font></b><font style="vertical-align: inherit;"> est√° desarrollando. </font><font style="vertical-align: inherit;">Aserrado activamente. </font><font style="vertical-align: inherit;">Es f√°cil crear un t√∫nel entre dos pares que tienen una IP est√°tica. </font><font style="vertical-align: inherit;">En otros casos, las muletas, las bicicletas con ruedas cuadradas y una cinta aislante azul siempre est√°n listas para ayudar, pero este no es nuestro camino. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenVPN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Soporte para m√∫ltiples plataformas: Windows, Linux, OpenWRT y sus derivados, Android</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fuerte encriptaci√≥n y soporte de certificados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Flexibilidad de personalizaci√≥n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Y contras:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Trabajar completamente en espacio de usuario.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Soporte limitado de enrutadores dom√©sticos: krenenko-kosenko en Mikrotik (sin restar valor a las otras ventajas de las gl√°ndulas) y normal en OpenWRT.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dificultades con la configuraci√≥n de clientes m√≥viles: necesita descargar o crear su propio instalador, copiar configuraciones en alg√∫n lugar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si hay varios t√∫neles, los bailes esperan con la edici√≥n de las unidades systemd en el servidor.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenConnect (implementaci√≥n de c√≥digo abierto del protocolo Cisco Anyconnect)</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Una soluci√≥n muy interesante sobre la cual, desafortunadamente, hay bastante informaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El soporte relativamente amplio para varias plataformas (Windows, Android, Mac basado en la aplicaci√≥n nativa Cisco Anyconnect de la tienda) es una opci√≥n ideal para proporcionar acceso a la red interna de dispositivos port√°tiles.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cifrado fuerte, soporte de certificado, conectividad 2FA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El protocolo en s√≠ est√° completamente basado en TLS (a diferencia de OpenVPN, que se detecta f√°cilmente en el puerto 443). </font><font style="vertical-align: inherit;">Adem√°s de TLS, DTLS tambi√©n es compatible: durante la sesi√≥n establecida, el cliente puede cambiar a la transmisi√≥n de datos a trav√©s de UDP y viceversa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Excelente coexistencia en un puerto de una VPN y un servidor web completo con sniproxy.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> F√°cil configuraci√≥n tanto del servidor como de los clientes.</font></font></li>
</ul> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠, tambi√©n, no estaban exentos de contras:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Trabajar completamente en espacio de usuario.</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP sobre TCP es una mala idea.</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No hay soporte de equipos de grado del cliente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La complejidad de instalar t√∫neles entre dos Linux: te√≥ricamente posible, pr√°cticamente, es mejor pasar tiempo en algo m√°s √∫til.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si hay varios t√∫neles, los bailes con varias configuraciones y unidades de sistema de edici√≥n est√°n esperando.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parecer√≠a un callej√≥n sin salida, pero despu√©s de mirar m√°s de cerca y pasar un poco de tiempo estudiando, me di cuenta de que IPSec basado en IKEv2 puede reemplazar todo lo dem√°s. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IKEv2 IPSEC</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Con la llegada de IKEv2, el protocolo en s√≠ se ha vuelto m√°s f√°cil de configurar, en comparaci√≥n con la versi√≥n anterior, pero a costa de perder la compatibilidad con versiones anteriores.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gracias a la estandarizaci√≥n, el trabajo se proporciona en cualquier lugar y en cualquier cosa: la lista se puede mantener indefinidamente. </font><font style="vertical-align: inherit;">Linux, Mikrotik (en las √∫ltimas versiones de RouterOS), OpenWRT, Android, iPhone. </font><font style="vertical-align: inherit;">Windows tambi√©n tiene soporte nativo que comienza con Windows 7.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alta velocidad: procesamiento de tr√°fico completamente en kernel-space. </font><font style="vertical-align: inherit;">La parte del espacio de usuario solo se necesita para establecer par√°metros de conexi√≥n y monitorear el estado del canal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La capacidad de usar varios m√©todos de autenticaci√≥n: usando tanto PSK como certificados, y en cualquier combinaci√≥n.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Varios modos de funcionamiento: t√∫nel y transporte. </font><font style="vertical-align: inherit;">En qu√© se diferencian se puede leer incluso en Habr√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraciones poco exigentes para nodos intermedios: si en la primera versi√≥n de IKE hubo problemas causados ‚Äã‚Äãpor NAT, IKEv2 tiene mecanismos incorporados para superar NAT y la fragmentaci√≥n nativa de los mensajes IKE, lo que le permite establecer una conexi√≥n en canales con una curva MTU. </font><font style="vertical-align: inherit;">Mirando hacia el futuro, dir√© que en la pr√°ctica nunca he encontrado una red WiFi, donde un cliente pueda establecer una conexi√≥n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contras, sin embargo, tambi√©n tienen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Necesita pasar un tiempo estudiando y entendiendo c√≥mo funciona.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una caracter√≠stica que puede confundir a un novato: IPSec, a diferencia de las soluciones VPN convencionales, no crea interfaces de red. </font><font style="vertical-align: inherit;">Solo se establecen pol√≠ticas de procesamiento de tr√°fico, todo lo dem√°s se resuelve mediante firewall.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de continuar con la configuraci√≥n, suponemos que el lector ya est√° un poco familiarizado con los conceptos y t√©rminos b√°sicos. </font><font style="vertical-align: inherit;">Para ayudar a un principiante, puede recomendar un art√≠culo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y el propio Habr, en el que ya hay art√≠culos bastante interesantes y √∫tiles sobre este tema.</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comenzar a configurar</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habiendo decidido la decisi√≥n, procedemos a la configuraci√≥n. </font><font style="vertical-align: inherit;">El diagrama de red en mi caso tiene la siguiente forma (eliminada bajo el spoiler)</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagrama de Red</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/g4/vc/ka/g4vckajqxwwmj1i0dalms3lipfm.png"></div>
                    </div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsecgw.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el servidor dom√©stico que es el centro de la red. IP externa 1.1.1.1. Una red interna 10.0.0.0/23 y otra direcci√≥n 10.255.255.1/30 para configurar una sesi√≥n privada de BGP con VPS; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mam√°</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es un enrutador Linux basado en una peque√±a red silenciosa instalada por los padres. El ISP emite una direcci√≥n IP din√°mica. Red interna 10.0.3.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keenetic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : enrutador </font><b><font style="vertical-align: inherit;">Keenetic</font></b><font style="vertical-align: inherit;"> con IPSec instalado. El ISP emite una direcci√≥n IP din√°mica. Red interna 10.0.4.0/24; </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">road-warriors</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : dispositivos port√°tiles que se conectan desde redes no confiables. Las direcciones se emiten a los clientes din√°micamente cuando se conectan desde el grupo interno (10.1.1.0/24); </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkn.example.com</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- VPS fuera de la jurisdicci√≥n de un ILV respetado. </font><font style="vertical-align: inherit;">IP externa: 5.5.5.5, direcci√≥n interna 10.255.255.2/30 para configurar una sesi√≥n privada de BGP.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primer paso. </font><font style="vertical-align: inherit;">De simple a complejo: t√∫neles con claves precompartidas (PSK)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ambas cajas de Linux instalamos los paquetes necesarios:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install strongswan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ambos hosts, abra los puertos 500 / udp, 4500 / udp y permita el paso del protocolo ESP. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite el archivo /etc/strongswan/ipsec.secrects (en el lado del host ipsecgw.example.com) y agregue la siguiente l√≠nea:</font></font><br>
<br>
<pre><code class="plaintext hljs">mama@router.home.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el segundo lado, de manera similar:</font></font><br>
<br>
<pre><code class="plaintext hljs">root@root.mama.local: PSK "Very strong PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, la identificaci√≥n es una direcci√≥n de correo electr√≥nico ficticia. </font><font style="vertical-align: inherit;">Se puede encontrar m√°s informaci√≥n en la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficial </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secretos guardados, avanzando. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el host ipsecgw.example.com, edite el archivo /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup <span class="hljs-comment">//   charon</span>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span> <span class="hljs-comment">//  </span>
conn %<span class="hljs-keyword">default</span> <span class="hljs-comment">//    </span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2 <span class="hljs-comment">//      - IKEv2</span><font></font>
    dpdaction = hold<font></font>
    dpddelay = <span class="hljs-number">5</span>s <span class="hljs-comment">// 5   DPD (Dead Peer Detection)   </span>
    mobike = yes <span class="hljs-comment">// Mobile IKE -     IP    </span>
conn mama <span class="hljs-comment">//  </span>
    left = %defaultroute <span class="hljs-comment">//Left -  .  %defaultroute       IKE- ,    default route</span>
    right = %any <span class="hljs-comment">//     IP-</span>
    authby = psk <span class="hljs-comment">//   -   </span>
    leftid = mama@router.home.local <span class="hljs-comment">// ID,   ipsec.secrets</span>
    rightid = root@router.mama.local <span class="hljs-comment">//ID  </span>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> 
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel <font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519! <font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//  charon        </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Del mismo modo, editamos en el par remoto /etc/strongswan/ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn mama<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = psk<font></font>
    leftid = root@router.mama.local<font></font>
    rightid = mama@router.home.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>,<span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes128gcm16-sha384-x25519!<font></font>
    esp = aes128gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si compara las configuraciones, puede ver que est√°n casi reflejadas, solo las definiciones de pares se intercambian. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La directiva </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auto = route</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hace que charon establezca una trampa para el tr√°fico que cae en las directivas left / rightsubnet (selectores de tr√°fico). </font><font style="vertical-align: inherit;">La coordinaci√≥n de los par√°metros del t√∫nel y el intercambio de claves comenzar√°n inmediatamente despu√©s de la aparici√≥n del tr√°fico que cae bajo las condiciones dadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el servidor ipsecgw.example.com en la configuraci√≥n del firewall, prohibimos enmascarar una red 10.0.3.0/24. </font><font style="vertical-align: inherit;">Permitir el reenv√≠o de paquetes entre 10.0.0.0/23 y 10.0.3.0/24 y viceversa. </font><font style="vertical-align: inherit;">En el host remoto, realizamos configuraciones similares deshabilitando el enmascaramiento para la red 10.0.0.0/23 y configurando el reenv√≠o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reiniciamos strongswan en ambos servidores e intentamos hacer ping al nodo central:</font></font><br>
<br>
<pre><code class="cpp hljs">sudo systemctl restart strongswan<font></font>
ping <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
</code></pre><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aseg√∫rate de que todo funcione:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">1</span> up, <span class="hljs-number">0</span> connecting)</span>:
        mama[53]: ESTABLISHED 84 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]
        mama</span>{<span class="hljs-number">141</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c4eb45fe_i ca5ec6ca_o<font></font>
        mama{<span class="hljs-number">141</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n ser√° √∫til asegurarse de que el par√°metro make_before_break est√© establecido en yes en el archivo /etc/strongswan/strongswan.d/charon.conf en todos los pares. </font><font style="vertical-align: inherit;">En este caso, el demonio charon que sirve el protocolo IKEv2 no eliminar√° la asociaci√≥n de seguridad actual durante el procedimiento de cambio de clave, pero crear√° una nueva primero.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segundo paso </font><font style="vertical-align: inherit;">La aparici√≥n de Keenetic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una agradable sorpresa fue la VPN IPSec incorporada en el firmware oficial de Keenetic. </font><font style="vertical-align: inherit;">Para activarlo, solo vaya a la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de componentes KeeneticOS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y agregue el paquete </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPSec VPN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Preparamos la configuraci√≥n en el nodo central, para esto: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite /etc/strongswan/ipsec.secrects y agregue el PSK para el nuevo par:</font></font><br>
<br>
<pre><code class="plaintext hljs">keenetic@router.home.local: PSK "Keenetic+PSK"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite /etc/strongswan/ipsec.conf y agregue otra conexi√≥n al final:</font></font><br>
<br>
<pre><code class="cpp hljs">conn keenetic<font></font>
    left = %defaultroute<font></font>
    right = %any<font></font>
    authby = psk<font></font>
    leftid = keenetic@router.home.local<font></font>
    rightid = root@router.keenetic.local<font></font>
    leftsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span>
    rightsubnet = <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el lado de Keenetic, la configuraci√≥n se realiza en la WebUI a lo largo de la ruta: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Internet -&gt; Conexiones -&gt; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otras conexiones</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es bastante simple</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(3 fotos)</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/0y/im/lp/0yimlpwidapstotzn9jqrs6f4za.png"><br>
<br>
<img src="https://habrastorage.org/webt/yi/xm/wv/yixmwvbj_fvsde_suu4_6wzooni.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/x-/6q/fux-6qh4mpc6nkz8ieu2egqpc54.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si planea conducir grandes vol√∫menes de tr√°fico a trav√©s del t√∫nel, puede intentar habilitar la aceleraci√≥n de hardware, que es compatible con muchos modelos. </font><font style="vertical-align: inherit;">Habilitado por el comando de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hardware del motor de cifrado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la CLI. </font><font style="vertical-align: inherit;">Para deshabilitar y procesar los procesos de cifrado y hash utilizando instrucciones generales de la CPU: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">software de motor de cifrado</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Despu√©s de guardar la configuraci√≥n, restauramos strongswan y dejamos que Keenetic piense durante medio minuto. </font><font style="vertical-align: inherit;">Luego en la terminal vemos una conexi√≥n exitosa:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo esta funcionando:</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function">sudo strongswan status
Security <span class="hljs-title">Associations</span> <span class="hljs-params">(<span class="hljs-number">2</span> up, <span class="hljs-number">0</span> connecting)</span>:
    keenetic[57]: ESTABLISHED 39 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]
    keenetic</span>{<span class="hljs-number">146</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">29</span>, ESP SPIs: ca8f556e_i ca11848a_o<font></font>
    keenetic{<span class="hljs-number">146</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.4</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
        mama[<span class="hljs-number">53</span>]: ESTABLISHED <span class="hljs-number">2</span> hours ago, <span class="hljs-number">1.1</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>[mama@router.home.local]..<span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span>[root@router.mama.local]<font></font>
        mama{<span class="hljs-number">145</span>}:  INSTALLED, TUNNEL, reqid <span class="hljs-number">27</span>, ESP in UDP SPIs: c5dc78db_i c7baafd2_o<font></font>
        mama{<span class="hljs-number">145</span>}:   <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">23</span> <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> === <span class="hljs-number">10.0</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span>
</code></pre><br>
</div>
                    </div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paso tres </font><font style="vertical-align: inherit;">Proteger dispositivos m√≥viles</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de leer un mont√≥n de manuales y un mont√≥n de art√≠culos, se decidi√≥ detenerse en un mont√≥n de un certificado gratuito de Let's Encrypt para autenticar el servidor y la autorizaci√≥n cl√°sica mediante inicio de sesi√≥n y contrase√±a para los clientes. </font><font style="vertical-align: inherit;">Por lo tanto, nos deshacemos de la necesidad de mantener nuestra propia infraestructura PKI, monitorear la caducidad de las claves y realizar gestos innecesarios con dispositivos m√≥viles mediante la instalaci√≥n de certificados autofirmados en la lista de confianza. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instale los paquetes faltantes:</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo yum install epel-release<font></font>
sudo yum install certbot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obtenemos el certificado independiente (no olvide abrir primero 80 / tcp en la configuraci√≥n de iptables):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo certbot certonly --standalone -d ipsecgw.example.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que certbot haya completado su trabajo, debemos ense√±ar a Strongswan a ver nuestro certificado:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el directorio /etc/strongswan/ipsec.d/cacerts cree 2 enlaces simb√≥licos: uno para el almac√©n ra√≠z de certificados de confianza en / etc / pki / tls / certs; </font><font style="vertical-align: inherit;">y un segundo con el nombre ca.pem apuntando a /etc/letsencrypt/live/ipsecgw.example.com/chain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n se crean dos enlaces simb√≥licos en el directorio /etc/strongswan/ipsec.d/certs: el primero, con el nombre certificate.pem, se refiere al archivo /etc/letsencrypt/live/ipsecgw.example.com/cert.pem. </font><font style="vertical-align: inherit;">Y el segundo, llamado fullchain.pem, que enlaza con /etc/letsencrypt/live/ipsecgw.example.com/fullchain.pem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el directorio /etc/strongswan/ipsec.d/private, coloque el enlace simb√≥lico key.pem apuntando a la clave privada generada por certbot y situada en la ruta /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agregue autenticaci√≥n a trav√©s de RSA a ipsec.secrets y un mont√≥n de inicios de sesi√≥n / contrase√±as para nuevos usuarios:</font></font><br>
<br>
<pre><code class="plaintext hljs">ipsecgw.example.com     : RSA key.pem<font></font>
username phone          : EAP "Q1rkz*qt"<font></font>
username notebook       : EAP "Zr!s1LBz"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reiniciamos Strongswan y al llamar a sudo strongswan listcerts deber√≠amos ver la informaci√≥n del certificado:</font></font><br>
<br>
<pre><code class="plaintext hljs">List of X.509 End Entity Certificates<font></font>
<font></font>
  subject:  "CN=ipsecgw.example.com"<font></font>
  issuer:   "C=US, O=Let's Encrypt, CN=Let's Encrypt Authority X3"<font></font>
  validity:  not before May 23 19:36:52 2020, ok<font></font>
             not after  Aug 21 19:36:52 2020, ok (expires in 87 days)<font></font>
  serial:    04:c7:70:9c:a8:ce:57:cc:bf:6f:cb:fb:d3:a9:cf:06:b0:a8<font></font>
  altNames:  ipsecgw.example.com<font></font>
  flags:     serverAuth clientAuth<font></font>
  OCSP URIs: http://ocsp.int-x3.letsencrypt.org<font></font>
  certificatePolicies:<font></font>
             2.23.140.1.2.1<font></font>
             1.3.6.1.4.1.44947.1.1.1<font></font>
             CPS: http://cps.letsencrypt.org<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego describimos la nueva conexi√≥n en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs">conn remote-access<font></font>
    dpddelay = <span class="hljs-number">30</span>s <span class="hljs-comment">//   DPD ,     </span><font></font>
    left = %defaultroute<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    leftcert = fullchain.pem <span class="hljs-comment">//         </span><font></font>
    leftsendcert = always<font></font>
    leftsubnet = <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span> <span class="hljs-comment">//      </span><font></font>
    right = %any<font></font>
    rightid = %any<font></font>
    rightauth = eap-mschapv2 <span class="hljs-comment">// ,  EAP-MSCHAP2</span><font></font>
    rightsendcert = never<font></font>
    eap_identity = %identity <font></font>
    rightsourceip = <span class="hljs-number">10.1</span><span class="hljs-number">.1</span><span class="hljs-number">.0</span>/<span class="hljs-number">24</span> <span class="hljs-comment">//Strongswan       </span>
    rightdns = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span> <span class="hljs-comment">//   DNS</span><font></font>
    type = tunnel<font></font>
    ike = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha384-x25519!<font></font>
    esp = aes256-aes192-aes128-sha256-sha384-modp2048-modp3072-modp4096-modp8192,aes128gcm16-sha256-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = add <span class="hljs-comment">//      </span>
    dpdaction = restart <span class="hljs-comment">// ,      DPD</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No olvide editar el archivo / etc / sysconfig / certbot que indica que tambi√©n actualizaremos el certificado como independiente, agregando CERTBOT_ARGS = "- independiente". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, no olvide activar el temporizador certbot-renew.timer y configurar el enlace para reiniciar Strongswan en caso de emitir un nuevo certificado. </font><font style="vertical-align: inherit;">Para hacer esto, coloque un script bash simple en / etc / letsencrypt / renewal-hooks / deploy /, o edite el archivo / etc / sysconfig / certbot nuevamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reiniciamos Strongswan, activamos el enmascaramiento para la red 10.1.1.0/24 en iptables y configuramos dispositivos m√≥viles.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Androide</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instala la aplicaci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strongswan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> desde Google Play </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lanzamos y creamos un nuevo</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perfil</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/qg/il/ly/qgilly6_cm-2-7jdlo8gtrkyqum.png"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Guardamos el perfil, nos conectamos y, despu√©s de un segundo, no tenemos que preocuparnos de que alguien pueda espiarnos.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verificamos:</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">sudo strongswan statusall<font></font>
Security Associations (3 up, 0 connecting):<font></font>
remote-access[109]: ESTABLISHED 2 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{269}:  INSTALLED, TUNNEL, reqid 55, ESP in UDP SPIs: c706edd1_i e5c12f1d_o<font></font>
remote-access{269}:   0.0.0.0/0 ::/0 === 10.1.1.1/32<font></font>
        mama[101]: ESTABLISHED 34 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{265}:  INSTALLED, TUNNEL, reqid 53, ESP in UDP SPIs: c8c83342_i c51309db_o<font></font>
        mama{265}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
    keenetic[99]: ESTABLISHED 36 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{263}:  INSTALLED, TUNNEL, reqid 52, ESP SPIs: c3308f33_i c929d6f1_o<font></font>
    keenetic{263}:   10.0.0.0/23 === 10.0.4.0/24</code></pre><br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ventanas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows de las versiones actuales se sorprendi√≥ gratamente. </font><font style="vertical-align: inherit;">Toda la configuraci√≥n de la nueva VPN se realiza llamando a dos cmdlets de PowerShell:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnection</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-ServerAddress</span> ipsecgw.example.com <span class="hljs-literal">-TunnelType</span> <span class="hljs-string">"IKEv2"</span>
<span class="hljs-built_in">Set-VpnConnectionIPsecConfiguration</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-AuthenticationTransformConstants</span> SHA256128 <span class="hljs-literal">-CipherTransformConstants</span> AES128 <span class="hljs-literal">-EncryptionMethod</span> AES128 <span class="hljs-literal">-IntegrityCheckMethod</span> SHA256 <span class="hljs-literal">-PfsGroup</span> PFS2048 <span class="hljs-literal">-DHGroup</span> Group14 <span class="hljs-literal">-PassThru</span> <span class="hljs-literal">-Force</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y una cosa m√°s, si Strongswan est√° configurado para emitir direcciones IPv6 a los clientes (s√≠, √©l tambi√©n puede hacerlo):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-built_in">Add-VpnConnectionRoute</span> <span class="hljs-literal">-ConnectionName</span> <span class="hljs-string">"IKEv2"</span> <span class="hljs-literal">-DestinationPrefix</span> <span class="hljs-string">"2000::/3"</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuarta parte, final. </font><font style="vertical-align: inherit;">Cortamos una ventana a Europa</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habiendo visto los talones del proveedor "El sitio fue bloqueado por la decisi√≥n del tal√≥n izquierdo del quinto fiscal adjunto de la aldea Trudovye Mozoli del condado de Bogozabyt", apareci√≥ un VPS peque√±o y discreto (con el nombre de dominio que suena bien rkn.example.com) a miles de kil√≥metros de monos a los que les gusta agitar con un martillo y bloquear redes de tama√±o / 16 a la vez. Y girar sobre este peque√±o VPS fue una creaci√≥n maravillosa de colegas de NIC.CZ llamada BIRD. El p√°jaro de la primera versi√≥n muri√≥ constantemente en p√°nico por la actividad de los monos con bastones, que prohibieron casi el 4% de Internet en el pico de su actividad laboral, dejando una profunda reflexi√≥n durante la reconfiguraci√≥n, por lo tanto, se actualiz√≥ a la versi√≥n 2.0.7. Si los lectores est√°n interesados, publicar√© un art√≠culo sobre la transici√≥n de BIRD a BIRD2, en el que el formato de configuraci√≥n ha cambiado dr√°sticamente,pero la nueva versi√≥n se ha vuelto mucho m√°s r√°pida y no hay problemas con la reconfiguraci√≥n con una gran cantidad de rutas. Y dado que usamos el protocolo de enrutamiento din√°mico, debe haber una interfaz de red a trav√©s de la cual usted necesita enrutar el tr√°fico. Por defecto, IPSec no crea interfaces, pero debido a su flexibilidad, podemos usar los t√∫neles GRE cl√°sicos, que protegeremos en el futuro. Como beneficio adicional, los hosts ipsecgw.example.com y rkn.example.com se autenticar√°n entre s√≠ utilizando Lets Encrypt certificados de renovaci√≥n autom√°tica. Sin PSK, solo certificados, solo hardcore, no hay mucha seguridad.Por defecto, IPSec no crea interfaces, pero debido a su flexibilidad, podemos usar los t√∫neles GRE cl√°sicos, que protegeremos en el futuro. Como beneficio adicional, los hosts ipsecgw.example.com y rkn.example.com se autenticar√°n entre s√≠ utilizando Lets Encrypt certificados de renovaci√≥n autom√°tica. Sin PSK, solo certificados, solo hardcore, no hay mucha seguridad.Por defecto, IPSec no crea interfaces, pero debido a su flexibilidad, podemos usar los t√∫neles GRE cl√°sicos, que protegeremos en el futuro. Como beneficio adicional, los hosts ipsecgw.example.com y rkn.example.com se autenticar√°n entre s√≠ utilizando Lets Encrypt certificados de renovaci√≥n autom√°tica. Sin PSK, solo certificados, solo hardcore, no hay mucha seguridad.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creemos que el VPS est√° preparado, Strongswan y Certbot ya est√°n instalados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el host ipsecgw.example.com (su IP es 1.1.1.1), describimos la nueva interfaz gif0:</font></font><br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="1.1.1.1"<font></font>
PEER_OUTER_IPADDR="5.5.5.5"<font></font>
MY_INNER_IPADDR="10.255.255.1/30"<font></font>
PEER_INNER_IPADDR="10.255.255.2/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reflejado en el host vps.example.com (su IP es 5.5.5.5):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo vi /etc/sysconfig/network-scripts/ifcfg-gif0<font></font>
DEVICE="gif0"<font></font>
MY_OUTER_IPADDR="5.5.5.5"<font></font>
PEER_OUTER_IPADDR="1.1.1.1"<font></font>
MY_INNER_IPADDR="10.255.255.2/30"<font></font>
PEER_INNER_IPADDR="10.255.255.1/30"<font></font>
TYPE="GRE"<font></font>
TTL="64"<font></font>
MTU="1442"<font></font>
ONBOOT="yes"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elevamos las interfaces, pero dado que iptables no tiene una regla que permita el protocolo GRE, el tr√°fico no ir√° (que es lo que necesitamos, ya que no hay protecci√≥n dentro de GRE contra los fan√°ticos de ning√∫n tipo de "paquetes" legislativos).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cooking VPS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, obtenemos otro certificado para el nombre de dominio rkn.example.com. </font><font style="vertical-align: inherit;">Cree enlaces simb√≥licos en /etc/strongswan/ipsec.d como se describe en la secci√≥n anterior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite ipsec.secrets agreg√°ndole una sola l√≠nea:</font></font><br>
<br>
<pre><code class="plaintext hljs">rkn.example.com     : RSA key.pem</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edite ipsec.conf:</font></font><br>
<br>
<pre><code class="cpp hljs">config setup<font></font>
    charondebug = <span class="hljs-string">"dmn 0, mgr 0, ike 0, chd 0, job 0, cfg 0, knl 0, net 0, asn 0, enc 0, lib 0, esp 0, tls 0, tnc 0, imc 0, imv 0, pts 0"</span><font></font>
    strictcrlpolicy = yes<font></font>
conn %<span class="hljs-keyword">default</span><font></font>
    reauth = yes<font></font>
    rekey = yes<font></font>
    keyingtries = %forever<font></font>
    keyexchange = ikev2<font></font>
    dpdaction = restart<font></font>
    dpddelay = <span class="hljs-number">5</span>s<font></font>
    mobike = yes<font></font>
conn rkn<font></font>
    left = %defaultroute<font></font>
    right = ipsecgw.example.com<font></font>
    authby = pubkey<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    leftid = <span class="hljs-string">"CN=rkn.example.com"</span>
    rightid = <span class="hljs-string">"CN=ipsecgw.example.com"</span><font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el lado del host, ipsecgw.example.com tambi√©n se agrega a ipsec.conf en la secci√≥n de configuraci√≥n el par√°metro strictlycrlpolicy = yes, que incluye una estricta comprobaci√≥n de CRL. </font><font style="vertical-align: inherit;">Y describa otra conexi√≥n:</font></font><br>
<br>
<pre><code class="cpp hljs">conn rkn<font></font>
    left = %defaultroute<font></font>
    right = rkn.example.com<font></font>
    leftcert = fullchain.pem<font></font>
    leftsendcert = always<font></font>
    leftauth = pubkey<font></font>
    rightauth = pubkey<font></font>
    rightrsasigkey = /etc/strongswan/ipsec.d/certs/rkn.exapmle.com.pem<font></font>
    leftid = <span class="hljs-string">"CN=ipsecgw.example.com"</span>
    rightid = <span class="hljs-string">"CN=rkn.example.com"</span><font></font>
    leftsubnet = %dynamic<font></font>
    rightsubnet = %dynamic<font></font>
    type = transport<font></font>
    ike = aes256gcm16-sha384-x25519!<font></font>
    esp = aes256gcm16-sha384-x25519!<font></font>
    <span class="hljs-keyword">auto</span> = route<font></font>
    dpdaction = restart<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las configuraciones casi se reflejan. </font><font style="vertical-align: inherit;">El lector atento ya podr√≠a prestar atenci√≥n a un par de puntos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">left / rightsubnet =% dynamic: indica a Strongswan que aplique pol√≠ticas a todos los tipos de tr√°fico entre pares</font></font></li>
<li>      rightrsasigkey.     IKE SA     IKE AUTH ERROR  ,  Strongswan         RSA-  .        openssl.     (ipsecgw  RKN)  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; ~/ipsecgw.example.com.pem  sudo /usr/bin/openssl rsa -in /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; ~/rkn.example.com.pem,     scp       ,   </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No olvide configurar el firewall y los certificados de renovaci√≥n autom√°tica. </font><font style="vertical-align: inherit;">Despu√©s de reiniciar Strongswan en ambos servidores, comience a hacer ping en el extremo m√°s alejado del t√∫nel GRE y vea una conexi√≥n exitosa. </font><font style="vertical-align: inherit;">En VPS (rkn):</font></font><br>
<br>
<pre><code class="plaintext hljs">sudo strongswan status<font></font>
Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   5.5.5.5/32 === 1.1.1.1/32<font></font>
Security Associations (1 up, 0 connecting):<font></font>
         rkn[33]: ESTABLISHED 79 minutes ago, 5.5.5.5[CN=rkn.example.com]...1.1.1.1[CN=ipsecgw.example.com]<font></font>
         rkn{83}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: cb4bc3bb_i c4c35a5a_o<font></font>
         rkn{83}:   5.5.5.5/32 === 1.1.1.1/32</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y en el lado del host ipsecgw </font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debajo del spoiler</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">Routed Connections:<font></font>
         rkn{1}:  ROUTED, TRANSPORT, reqid 1<font></font>
         rkn{1}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
Security Associations (4 up, 0 connecting):<font></font>
remote-access[10]: ESTABLISHED 5 seconds ago, 1.1.1.1[CN=ipsecgw.example.com]...4.4.4.4[phone]<font></font>
remote-access{12}:  INSTALLED, TUNNEL, reqid 7, ESP in UDP SPIs: c7a31be1_i a231904e_o<font></font>
remote-access{12}:   0.0.0.0/0 === 10.1.1.1/32<font></font>
    keenetic[8]: ESTABLISHED 22 minutes ago, 1.1.1.1[keenetic@router.home.local]...3.3.3.3[root@router.keenetic.local]<font></font>
    keenetic{11}:  INSTALLED, TUNNEL, reqid 6, ESP SPIs: cfc1b329_i c01e1b6e_o<font></font>
    keenetic{11}:   10.0.0.0/23 === 10.0.4.0/24<font></font>
        mama[4]: ESTABLISHED 83 minutes ago, 1.1.1.1[mama@router.home.local]...2.2.2.2[root@router.mama.local]<font></font>
        mama{8}:  INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c4a5451a_i ca67c223_o<font></font>
        mama{8}:   10.0.0.0/23 10.1.1.0/24 === 10.0.3.0/24<font></font>
         rkn[3]: ESTABLISHED 83 minutes ago, 1.1.1.1[CN=ipsecgw.example.com]...5.5.5.5[CN=rkn.example.com]<font></font>
         rkn{7}:  INSTALLED, TRANSPORT, reqid 1, ESP SPIs: c4c35a5a_i cb4bc3bb_o<font></font>
         rkn{7}:   1.1.1.1/32 === 5.5.5.5/32<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El t√∫nel est√° instalado, los pings van, en tcpdump es visible que solo ESP pasa entre los hosts. </font><font style="vertical-align: inherit;">Parece posible alegrarse. </font><font style="vertical-align: inherit;">Pero no puedes relajarte sin revisar todo hasta el final. </font><font style="vertical-align: inherit;">Estamos intentando volver a emitir el certificado para VPS y ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chef, todo est√° roto</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzamos a comprender y tropezar con una caracter√≠stica desagradable de Let's Encrypt, que es hermosa en todo lo dem√°s: con cualquier reemisi√≥n del certificado, la clave privada asociada con √©l tambi√©n cambia. La clave privada ha cambiado, y la p√∫blica ha cambiado. A primera vista, la situaci√≥n es desesperada para nosotros: incluso si podemos extraer f√°cilmente la clave p√∫blica durante la nueva emisi√≥n del certificado utilizando el gancho en certbot y pasarlo al lado remoto a trav√©s de SSH, no est√° claro c√≥mo hacer que el remoto Strongswan lo vuelva a leer. Pero la ayuda vino de donde no esperaban: systemd puede monitorear los cambios en el sistema de archivos y ejecutar los servicios asociados con el evento. Esto es lo que usaremos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Crearemos un usuario del servicio keywatcher en cada uno de los hosts con los derechos m√°s restringidos, generaremos claves SSH para cada uno de ellos y los intercambiaremos entre los hosts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el host ipsecgw.example.com, cree el directorio / opt / ipsec-pubkey en el que colocamos 2 scripts.</font></font><br>
<br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/ipsecgw.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/ipsecgw.example.com/privkey.pem -pubout &gt; /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/ipsecgw.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/ipsecgw.example.com.pem rkn.example.com:/home/keywatcher/ipsecgw.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/ipsecgw.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem has not been uploaded to remote host due to error"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key ipsecgw.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span><font></font>
/usr/bin/cp /home/keywatcher/rkn.example.com.pem /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/rkn.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server rkn.example.com has been updated, restarting strongswan daemon to re-read it"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En VPS (el host rkn.example.com), creamos de manera similar un directorio con el mismo nombre, en el que tambi√©n creamos scripts similares, cambiando solo el nombre de la clave. </font><font style="vertical-align: inherit;">C√≥digo, para no abarrotar el art√≠culo, bajo</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">revelaci√≥n</font></font></b>
                        <div class="spoiler_text">sudo vi /opt/ipsec-pubkey/pubkey-copy.sh<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">if</span> [ ! -f /home/keywatcher/rkn.example.com.pem ]; <span class="hljs-keyword">then</span>
  /usr/bin/openssl rsa -<span class="hljs-keyword">in</span> /etc/letsencrypt/live/rkn.example.com/privkey.pem -pubout &gt; /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chown keywatcher:keywatcher /home/keywatcher/rkn.example.com.pem;<font></font>
  /usr/bin/chmod 0600 /home/keywatcher/rkn.example.com.pem;<font></font>
  sudo -u keywatcher /usr/bin/scp /home/keywatcher/rkn.example.com.pem ipsecgw.example.com:/home/keywatcher/rkn.example.com.pem;<font></font>
  status=$?;<font></font>
  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$status</span> -eq 0 ]; <span class="hljs-keyword">then</span><font></font>
    rm -f /home/keywatcher/rkn.example.com.pem;<font></font>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has been successfully uploaded to remote host"</span>;
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem has not been uploaded to remote host"</span>;
  <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    logger <span class="hljs-string">"Public key rkn.example.com.pem already exist on /home/keywatcher directory, something went wrong"</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
<pre><code class="bash hljs">sudo vi /opt/ipsec-pubkey/key-updater.sh</code></pre><br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/bash</span><font></font>
/usr/bin/cp /home/keywatcher/ipsecgw.example.com.pem /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem;<font></font>
/usr/bin/chown root:root /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
/usr/bin/chmod 0600 /etc/strongswan/ipsec.d/certs/ipsecgw.example.com.pem<font></font>
logger <span class="hljs-string">"Public key of server ipsecgw.example.com has been updated, restarting connection"</span><font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El script pubkey-copy.sh es necesario para extraer la parte p√∫blica de la clave y copiarla al host remoto al emitir un nuevo certificado. </font><font style="vertical-align: inherit;">Para hacer esto, en el directorio / etc / letsencrypt / renewal-hooks / deploy en ambos servidores, cree otro microscript:</font></font><br>
<br>
<pre><code class="bash hljs">
<span class="hljs-meta">#!/bin/sh</span><font></font>
/opt/ipsec-pubkey/pubkey-copy.sh &gt; /dev/null 2&gt;&amp;1<font></font>
/usr/bin/systemctl restart strongswan<font></font>
<span class="hljs-built_in">exit</span> 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mitad del problema se resuelve, los certificados se vuelven a emitir, las claves p√∫blicas se extraen y copian entre los servidores, y ha llegado el momento de systemd con sus unidades de ruta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el servidor ipsecgw.example.com en el directorio / etc / systemd / system, cree el archivo keyupdater.path</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/rkn.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Del mismo modo en el host VPS:</font></font><br>
<br>
<pre><code class="bash hljs">[Unit]<font></font>
Wants=strongswan.service<font></font>
[Path]<font></font>
PathChanged=/home/keywatcher/ipsecgw.example.com.pem<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y finalmente, en cada servidor creamos un servicio asociado con esta unidad, que se lanzar√° cuando se cumpla la condici√≥n (PathChanged): cambiar el archivo y cerrarlo despu√©s de la grabaci√≥n. </font><font style="vertical-align: inherit;">Creamos los archivos /etc/systemd/system/keyupdater.service y escribimos:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description= Starts the IPSec key updating script<font></font>
Documentation= man:systemd.service<font></font>
[Service]<font></font>
Type=oneshot<font></font>
ExecStart=/opt/ipsec-pubkey/key-updater.sh<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No olvide volver a leer las configuraciones de systemd con sudo systemctl daemon-reload y asignar el inicio autom√°tico a las unidades de ruta a trav√©s de sudo systemctl enable keyupdater.path &amp;&amp; sudo systemctl start keyupdater. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tan pronto como el host remoto escriba el archivo que contiene la clave p√∫blica en el directorio de inicio del usuario de keywatcher y el descriptor de archivo se cierre, systemd iniciar√° autom√°ticamente el servicio correspondiente, que copiar√° la clave en la ubicaci√≥n deseada y reiniciar√° Strongswan. </font><font style="vertical-align: inherit;">El t√∫nel se instalar√° utilizando la clave p√∫blica correcta del segundo lado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puedes exhalar y disfrutar el resultado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En lugar de una conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como acabamos de ver el </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">infierno,</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> IPSec no da tanto miedo como est√° pintado. </font><font style="vertical-align: inherit;">Todo lo que se ha descrito es una configuraci√≥n totalmente operativa que est√° actualmente en uso. </font><font style="vertical-align: inherit;">Incluso sin mucho conocimiento, puede configurar una VPN y proteger sus datos de manera confiable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, los momentos de configuraci√≥n de iptables quedaron fuera del alcance del art√≠culo, pero el art√≠culo en s√≠ result√≥ ser voluminoso y se ha escrito mucho sobre iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay puntos en el art√≠culo que pueden mejorarse, ya sea la negativa a reiniciar el demonio Strongswan, releyendo sus configuraciones y certificados, pero no pude lograrlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, los reinicios del demonio no dieron miedo: se pierden uno o dos pings entre pares, los clientes m√≥viles restauran la conexi√≥n ellos mismos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Espero que los colegas en los comentarios indiquen la soluci√≥n correcta.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es504464/index.html">C√≥mo se nos ocurri√≥ el TableAdapter y simplificamos el trabajo con UITableView</a></li>
<li><a href="../es504468/index.html">Rendimiento de Raspberry Pi: agregue ZRAM y cambie los par√°metros del kernel</a></li>
<li><a href="../es504472/index.html">Mis mejores herramientas gratuitas para desarrolladores</a></li>
<li><a href="../es504480/index.html">¬øC√≥mo encontrar un vendedor con el que sea rentable trabajar?</a></li>
<li><a href="../es504482/index.html">Preg√∫ntenos: DIT responder√° preguntas</a></li>
<li><a href="../es504486/index.html">Proceso: Creando Vue 3</a></li>
<li><a href="../es504488/index.html">Qu√© industrias y tecnolog√≠as comenzar√°n a desarrollarse r√°pidamente despu√©s de resolver el problema de COVID-19</a></li>
<li><a href="../es504490/index.html">Resumen de eventos en l√≠nea de junio</a></li>
<li><a href="../es504492/index.html">Presione el bot√≥n: teor√≠a y pr√°ctica de la votaci√≥n electr√≥nica - mesa redonda el 30 de mayo</a></li>
<li><a href="../es504502/index.html">La corta y extra√±a vida del primer robot amigo del mundo.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>