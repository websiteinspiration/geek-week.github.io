<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêï üî∫ üë∞üèº We assemble the simplest ZigBee network, program under Mbed, communicate through MQTT üë®üèæ‚Äçüíª üò± üèä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a great entry-level training workshop on using the XBee module in conjunction with a microcontroller that has Mbed OS on board. ZigBee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We assemble the simplest ZigBee network, program under Mbed, communicate through MQTT</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/samsung/blog/497200/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article is a great entry-level training workshop on using the XBee module in conjunction with a microcontroller that has Mbed OS on board. ZigBee is a long and firmly rooted standard in Smart Home systems (for example, it is used along with Z-Wave in the Samsung SmartThings hub, see our </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), it is characterized by low power consumption, ease of use, and, most interestingly, the ability to create self-configuring mesh networks. You will see from the workshop that this is indeed so - we will look at the structure of such a network through a convenient visualizer utility.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is assumed that you already know what ZigBee is and what it is for. </font><font style="vertical-align: inherit;">Now you want to connect your first XBee-module and solve your problems with it, without going into programming the module itself, but only using it as a communication interface. </font><font style="vertical-align: inherit;">In the end, we will send all the data through a makeshift MQTT gateway anywhere, even to a local server, even to the Internet. </font><font style="vertical-align: inherit;">We decided to show everything on the example of Mbed as the simplest and most accessible for beginners RTOS. </font><font style="vertical-align: inherit;">You will be convinced that everything works ‚Äúout of the box‚Äù, and you can immediately start making your project, even if before that you were dealing only with Arduino.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bp/5i/ot/bp5iota_umzhimxdl5yhgnmflzg.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The manual will consist of the following parts:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connection and configuration of the XBee module</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connect the modules to the network</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We configure the module without removing it from the shield</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data retrieval</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending data</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Making a simple MQTT gateway</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But first, a list of components: what is desirable to have in order to do all of the above.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Required Components</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two Mbed-compatible boards. </font><font style="vertical-align: inherit;">We recommend the STM32 Nucleo training board as relatively inexpensive and popular for educational purposes. </font><font style="vertical-align: inherit;">The programming process there is maximally simplified: collect the program in an online free IDE, download the assembled firmware and ‚Äúdrop‚Äù it onto the board, which will appear in the system as a flash drive. </font><font style="vertical-align: inherit;">What specific model to take is not important, but take not the oldest one, pay attention to the amount of memory. </font><font style="vertical-align: inherit;">For example, F401RE - we give just for definiteness, so that you do not get confused in their diversity and at first incomprehensible alphabetic codes of STM processors.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ec/y3/nx/ecy3nxhuys7vlrzai3mq4yfzhy8.png" width="350"> <img src="https://habrastorage.org/webt/ec/y3/nx/ecy3nxhuys7vlrzai3mq4yfzhy8.png" width="350"><br>
</li>
<li> XBee-.      Digi.  ¬´¬ª ,  ,  , MBee,  ,    ,     ,      . /        :      ,      .   /  Pro:      ,      ,   Pro   .<br>
<img src="https://habrastorage.org/webt/r2/ed/ew/r2edew1y1gkdpcw9soz-vunnu9q.png"><img src="https://habrastorage.org/webt/m6/-n/aq/m6-naqf0x0qqrjpj-soxa6aulj0.png"><img src="https://habrastorage.org/webt/t2/x5/ng/t2x5ng0wfuoehd4oujmvhf1spha.png" width="200"><br>
</li>
<li>  XBee Shield V2 ( SeeedStudio).      -     ,        RX  TX XBee-.<br>
<img src="https://habrastorage.org/webt/jk/sv/75/jksv75ger3mv3zfwzfji4tliub0.png"><img src="https://habrastorage.org/webt/jk/sv/75/jksv75ger3mv3zfwzfji4tliub0.png"><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One USB-UART converter with connector for XBee. </font><font style="vertical-align: inherit;">It is needed for initial configuration. </font><font style="vertical-align: inherit;">XBee modules themselves are not equipped with a USB interface (they have nothing to do with it). </font><font style="vertical-align: inherit;">USB is needed solely and exclusively for communication between the module and the computer, and in the device it can work on a much simpler UART. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The slot pitch of the XBee modules is 2.0 mm - for electronics it is non-standard, in the metric system (we are usually used to seeing step 2.54 according to American standards). </font><font style="vertical-align: inherit;">Therefore, unfortunately, such modules are not inserted into the breadboard and they always need an adapter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any adapter is suitable here, we took this one from Waveshare:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/04/md/y5/04mdy5mhmm6cfwuj-a21a5eqagy.png" width="300"></li>
</ul><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connection and configuration of the XBee module</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The simplest thing you can do with the module is to connect it to the computer directly via USB. </font><font style="vertical-align: inherit;">We will immediately get access to its configuration parameters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install XCTU</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To work with XBee, there is an official XCTU program. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Download</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it and install. </font><font style="vertical-align: inherit;">The documentation says that in Ubuntu you need to add a user to a group </font></font><code>dialout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for working with ports not from a superuser - do this if you have not done it yet:</font></font><br>
<br>
<pre><code class="bash hljs">sudo usermod -a -G dialout &lt;username&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download the zip archive from the link, it will contain a file </font></font><code>.run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It needs to be made executable (via </font></font><code>chmod +x _</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the console or: right mouse button - Properties - Permissions) and run </font></font><code>./40002881_V.run</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important to start the installation not from the root (without </font></font><code>sudo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), otherwise there will be problems later. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The setup looks something like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/44/kg/iz/44kgizj3bjlvchzakcksvrh1i_u.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XCTU program</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After installation, you can start the program by running the file </font></font><code>app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the directory where you installed the program (by default - </font></font><code>~/Digi/XCTU-NG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The appearance will be as follows: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qr/wz/y0/qrwzy0nbyhomwp8g-k26jrluio4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this program, you can add your existing module connected to the USB port via an adapter. Click on the Discover button with a magnifying glass. A window pops up asking you to select a port - as you can see, the program correctly detected the port in the system </font></font><code>/dev/ttyUSB0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, this is our USB-UART adapter.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rs/qr/h1/rsqrh1y2if1z6nr_zl844kdba4o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The window suggests ticking off the search. </font><font style="vertical-align: inherit;">Of course, there is a temptation to check all at once to surely find your module. </font><font style="vertical-align: inherit;">But then the search will go on for a very long time. </font><font style="vertical-align: inherit;">In practice, it makes sense to leave the boxes checked by default, and choose the most common options for the data transfer speed, as in the picture below. </font><font style="vertical-align: inherit;">Usually, new modules default to 9600, and for training purposes this is more than enough, the speed here is not critical to us. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/l2/dj/ve/l2djvekjunxaxpxesaxo786q3le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, if everything is successful, you will be asked to select the module found: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4z/dq/le/4zdqledgifvp92zr4lvm6bat2km.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A small bug was noticed: sometimes the module was not at a non-standard speed, manual reset of the module with the Reset button during the search and resetting its baud rate to standard (9600) helped.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Change module parameters</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further we are engaged in module configuration. A bunch of parameters will drop out, most of which are initially incomprehensible. Fortunately, only a few of them will need to be changed for a quick start. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network ID - PAN ID.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A common network key, it must be the same for all devices so that they are independently connected to the network. Put any number, in our case we did 42. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t7/dg/lk/t7dglkxhvbkban2romlxiu97qpi.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CE - Coordinator Enabled.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If there is 1, then this module acts as a coordinator. If it is 0, then the module acts as a router (Router) - in fact, it simply ensures that packets pass through the network through itself. Most hosts are usually routers. We need one coordinator and two routers in our network, so put one here.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is also the role ‚ÄúEnd device‚Äù - this is a module that does not perform work on the transfer of packets, but only communicates with other routers and performs its useful functionality. Usually, he is just in sleep mode and wakes up at set intervals and finds out if there are any messages. Such a module can be powered by a battery, while the router and coordinator should always be ‚Äúonline‚Äù and as a result, need constant power to maintain the entire network. We will not consider such an example now, since it is more interesting for everyone to assign the role of routers and to observe how the network will automatically change its configuration. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/zp/e3/0mzpe3yptscx6la-wummlbiixks.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AP - API Enable.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mode of operation. XBee modules can operate in two modes: AT or API. AT-mode is easier for beginners, it is a transparent replacement of the serial port and work with the module through AT-commands. However, the API mode is much richer in functionality, it allows you to remotely configure modules, contains the sender address, returns the package delivery status, and much more. In addition, libraries for interacting with XBee assume that the device is used in the API mode. Therefore, immediately replace it with the API mode, this is done by setting the unit in the corresponding field. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/wv/ng/rawvngogy6biagddxsxxx08fhao.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The name of the module is Node Identifier.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A handy option to give your module a human-readable name. Let's give it such a name - Coordinator. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xi/h2/fy/xih2fygnbxffyqcyhuwbvn8zhqc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, you can flash the settings into the module by pressing the button with a pencil:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pi/8g/xm/pi8gxmplnffs0qmxtckhrfmxrqe.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Connect the modules to the network</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we will see what kind of network we get if we configure three modules. </font><font style="vertical-align: inherit;">The XCTU program has a fairly convenient network visualizer, we will clearly see the topology. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will configure all three modules in turn with the following parameters:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PAN ID - total number, for example 42</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AP (API Enable) - set to 1 (work in API mode)</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NI (Node Identifier) ‚Äã‚Äã- give the modules understandable names (Coordinator, Lamp and Switch, if we are doing, for example, a model of the Smart Home system).</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CE (Coordinator Enable) - set one of the modules to 1, it will be the coordinator.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then apply power to all modules. Position them like this: the coordinator will be in the USB-UART converter, and the other two (routers) will be located on the XBee Shield boards on top of Nucleo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you did everything carefully, then the beautiful will happen. The modules will automatically connect to the network. You can communicate with routers remotely through the coordinator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks like this. Click the "Discover radio nodes in the same network" button. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/em/nf/mx/emnfmxivn4xxt3wtx0pe0f54m8q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will see that two modules were automatically detected and added: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j3/ev/gf/j3evgfx0nj0xowanzz3ovdctyks.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And you can change their parameters on the fly!&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What‚Äôs still great: now you can see the network map if you switch to the Network working mode at the top right.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sf/2v/ma/sf2vmarm8agrkfjtepgib28sxuq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having spread the network nodes with the mouse, you will see a triangle. </font><font style="vertical-align: inherit;">Please note that traffic to the rightmost module can go in two ways. </font><font style="vertical-align: inherit;">And if you move the modules in space, you will see that the picture has changed, and now, perhaps, another module will become ‚Äúextreme‚Äù. </font><font style="vertical-align: inherit;">This is the essence of a self-configuring network.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Set up the XBee module without removing it from the shield</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, it will be more interesting to work with the XBee-module not through a computer, but by controlling it using a program on the microcontroller. </font><font style="vertical-align: inherit;">That is, connecting it to the STM32Nucleo board. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's discuss how the XBee module can communicate with the microcontroller. </font><font style="vertical-align: inherit;">And let's start with a small task: how to configure a module without removing it from the expansion shield? </font><font style="vertical-align: inherit;">You must admit that moving the module back and forth is inconvenient, at the same time you want to experiment with the parameters and it‚Äôs strange why you need a separate USB-UART module, because in theory there is one in the STM32Nucleo board. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The solution is simple: we need to turn the Nucleo board into a bridge between the XBee module and the USB converter on the board.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">General description of the idea</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The STM32 microcontroller we use has several UART interfaces on board. Each such interface represents a communication channel. One of them is connected to the USB-UART converter so that we can communicate with the computer via USB in the terminal. Two others are not used yet. We will connect the XBee module to one of them, which also has such a communication channel. You can choose any UART, we have chosen for definiteness UART1.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The pinout can be viewed in MBed in the upper right, by pressing the board selection button, and then on the Pinout tab. </font><font style="vertical-align: inherit;">Out of habit, it can be quite difficult to perceive this colorful picture. </font><font style="vertical-align: inherit;">There are a lot of things here, since the board has many interfaces, and there are two pin numbers: relative to the microcontroller (PA_5, PA_6 - pin numbering), and relative to the board (D13, D12 - inscriptions on the Nucleo board, the same numbers near the terminals). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/97/dp/mq/97dpmqw9dmy9lcqtb1hf6i_gyz0.png"><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that on the microcontroller, the UART1 interface will communicate with the XBee-module, and UART2 - as before, with the computer. </font><font style="vertical-align: inherit;">The internal code will redirect UART1 to UART2 and vice versa. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rp/vk/5w/rpvk5wsdsb8qnz5i_m7dk8q-wwc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By connections, it will look like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tp/g7/cs/tpg7cslaiomjx-ogqje-su3q-7s.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Making a ‚Äúbridge‚Äù from a microcontroller</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, we can jumpers on the shield set the numbers to which we want to connect the ZigBee-module. TX communication module will be connected to pin 2 of the board (PA_9 on the microcontroller), and RX to pin 8 (aka PA_10). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It will look like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oh/ce/3s/ohce3sq3y1_0_jewruer0dmn36a.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we took is called the Serial Bridge. This is the ‚Äúbridge‚Äù between the two communication channels. We load the code into the microcontroller, which forwards everything that comes to the input from the computer via UART2, to UART1, and vice versa. As if we inserted a pipe between two sources of information (Linuxsoids will understand). We connected an XBee module to UART1. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code is very simple, the only thing you need to change in it is the pin numbers to which the device is connected. That is, make them PA_9 and PA_10, as indicated above.</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"mbed.h"</span></span>
<span class="hljs-comment">// Make a serial bridge from a serial I/O device on mbed to the PC</span>
<span class="hljs-function">Serial <span class="hljs-title">pc</span><span class="hljs-params">(USBTX, USBRX)</span></span>; <span class="hljs-comment">// tx, rx</span>
<span class="hljs-function">Serial <span class="hljs-title">device</span><span class="hljs-params">(PA_9, PA_10)</span></span>; <span class="hljs-comment">// tx, rx</span>
<span class="hljs-comment">// Defaults to 9600 baud on each device - use .baud(baudrate) to change</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<font></font>
&nbsp;pc.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello!"</span>);
&nbsp;<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>(pc.readable()) {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;device.putc(pc.getc());<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>(device.readable()) {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pc.putc(device.getc());<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important that if you confuse the order of the conclusions - for example, you make a mistake and write PA_10, PA_9 instead of PA_9, PA_10 - the wrong order, the compiler will not report an error to you, and the program will display an error in the console upon reboot:</font></font><br>
<pre><code class="plaintext hljs">pinmap not found for peripheral</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and will not move on, that is, in principle, nothing will work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After you download this code and correctly set the jumpers on the shield, you can safely connect to the XBee module from the computer, just as you did previously with the USB-UART adapter without removing it from the shield. </font><font style="vertical-align: inherit;">It will be regularly detected by the XCTU program. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even if you do not need this functionality, still check that the program is working, because in the next example we will communicate with the XBee module from the microcontroller, and the connection via UART1 should already be established (that is, jumpers are correctly set and pin numbers are indicated in the program) .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Data acquisition</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at two simple examples: how to receive and send data at the microcontroller level, using the XBee module as an external communication interface. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is an official </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from manufacturers - Digi companies. </font><font style="vertical-align: inherit;">It lies in the Mbed repository, there are useful comments on the use and logic of the code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we will learn how to get data - there is an easier example. </font><font style="vertical-align: inherit;">We will have an XBee module connected to the USB-UART converter, send a greeting to the Nucleo board, and it will print this greeting to the console. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zg/ic/u5/zgicu5mh8dvsy8y8aegzetdoew8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">project</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in this library. </font><font style="vertical-align: inherit;">As always, import it into the online compiler as a program.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fix libraries for S2C modules</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keep in mind that if you have S2C series modules: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hc/vr/kb/hcvrkbswx5s8hspbos6djkmxfko.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
then instead of the standard library you need to use the fix: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XBeeLib_Fixed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Otherwise, these programs will not work. </font><font style="vertical-align: inherit;">It is added to the project simply by removing the XBeeLib library from there, and importing it into the XBeeLibFix project. </font><font style="vertical-align: inherit;">Nothing more needs to be changed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So: import this library into the online compiler: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ko/vq/e9/kovqe9zqdl7553_kivabf8bedv0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
project import window will appear. </font><font style="vertical-align: inherit;">There you need to choose the target - where we import: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bx/pt/vt/bxptvt2ctwcv87vl-b1qi5upi4s.png" width="500"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As the target project, select our example XBeeZB_Receive_Data. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7q/lj/hg/7qljhgp7jx5yt9875cqijnfopcs.png" width="500"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After which the library will be imported into the project, and then with a bold move we delete the wrong version of XBeeLib.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iw/hz/or/iwhzor7bqjopgpigyi4_lfiv43e.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example Compilation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, you imported the example and replaced the library in it if necessary. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Look at the sample code, it is quite simple. </font><font style="vertical-align: inherit;">It defines a callback function that is called when a packet is received. </font><font style="vertical-align: inherit;">This function prints the contents of the received packet to the console. </font><font style="vertical-align: inherit;">So if we send her a greeting, she will print it too. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for the example to compile, you need to write in the example the conclusions that we are responsible for communicating with the XBee-module, because the program does not know which conclusions we connected the hardware to. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we go to the config.h file and the lines in it:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//#define RADIO_TX NC /* <span class="hljs-doctag">TODO:</span> specify your setup's Serial TX pin connected to the XBee module DIN pin */</span>
<span class="hljs-comment">//#define RADIO_RX NC /* <span class="hljs-doctag">TODO:</span> specify your setup's Serial RX pin connected to the XBee module DOUT pin */</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uncomment, and instead of NC we write, in accordance with what conclusions we connected the jumpers:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RADIO_TX PA_9</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RADIO_RX PA_10</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Similarly, we modify the lines:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">//#define DEBUG_TX NC /* <span class="hljs-doctag">TODO:</span> specify your setup's Serial TX for debugging */</span>
<span class="hljs-comment">//#define DEBUG_RX NC /* <span class="hljs-doctag">TODO:</span> specify your setup's Serial RX for debugging (optional) */</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We write:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEBUG_TX USBTX</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DEBUG_RX USBRX</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you encounter an error during compilation that you cannot find </font></font><code>device.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, just update the Mbed library in the project tree (right-click on it -&gt; Update). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, the program will compile successfully, and you can download it to the board.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Running example</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having looked at the console what the Nucleo board writes, you will see the following: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/as/mk/fb/asmkfbne30jznt7bzqvr2vjhl5e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How do we send data? </font><font style="vertical-align: inherit;">The easiest option: through the console in the XCTU program. </font><font style="vertical-align: inherit;">Select in the main menu of the program: Tools - Send packets. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ko/9b/7q/ko9b7qwhvwszyezghvzpbs1py74.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the bottom there is a window with the words Send packets. </font><font style="vertical-align: inherit;">Create a new package by clicking on the ‚Äúplus‚Äù on the right. </font><font style="vertical-align: inherit;">A window for creating a new package will appear. </font><font style="vertical-align: inherit;">Select the HEX tab there. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jc/cf/wz/jccfwz6aesmjic-ncukw8ot1ls8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enter there such a data sending: </font></font><br>
<code>7E 00 19 10 01 00 00 00 00 00 00 FF FF FF FE 00 00 48 65 6C 6C 6F 20 58 42 65 65 21 5A</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(using the "Send selected packet" button to the right of the packet list) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will see the result in the console of the listening module:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/55/tg/mk/55tgmkipu_8dk33yhqdxxqa90du.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Please note that it only printed the last part of the byte set that you sent. </font><font style="vertical-align: inherit;">This is the actual payload of the message. </font><font style="vertical-align: inherit;">Also note that if you send ‚Äújust bytes‚Äù (any random combination of bytes), the receiver will not output them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you put a set of bytes:&nbsp; </font></font><br>
<code>48 65 6C 6C 6F 20 58 42 65 65 21</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in any HEX-ASCIII converter (for example, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), then make sure that it means "Hello XBee!" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A very simple task for independent execution: modify the example code so that it displays the message text in ASCII, not HEX, and you could read this text in the terminal.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Sending data</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By analogy with the previous example, we now consider sending data. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bp/5i/ot/bp5iota_umzhimxdl5yhgnmflzg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is here, as in the previous example. </font><font style="vertical-align: inherit;">Only with the difference that we are now opening the </font><font style="vertical-align: inherit;">XBeeZB_Send_Data </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example Compilation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important that if you have a S2C module (it is clearly written on it), </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hc/vr/kb/hcvrkbswx5s8hspbos6djkmxfko.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
then you will again connect the library with a fix, otherwise nothing will work for you. How to do this is described in the previous example.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, here for successful compilation you need to specify the used controller pins, you can simply copy them from the previous example. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We look at the example code itself. It </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses several methods to send data. Choose the simplest one: send data to the coordinator. We don‚Äôt even need to register the address of the coordinator, because he is already registered on the network. Therefore, without changing the sample, we comment while all the lines at the end:</font></font><br>
<pre><code class="cpp hljs">send_data_to_coordinator(xbee);
<span class="hljs-comment">//send_broadcast_data(xbee);</span>
<span class="hljs-comment">//send_data_to_remote_node(xbee, remoteDevice);</span>
<span class="hljs-comment">//send_explicit_data_to_remote_node(xbee, remoteDevice);</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And when you start, you‚Äôll see this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/su/pp/sj/suppsjbb95cdiavs1svsj1ixctm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(if you don‚Äôt see it, just restart the board) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How can I make sure that the data reaches the coordinator? For example, XCTU has network console mode. Turned on by the button in the upper right. In this mode, you will see all the packets on the network. Of course, at the same time, you should have a serial connection with the coordinator. And don't forget to click the Open button at the top left to make it green. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yz/st/vy/yzstvyfb4ed2rkbgvmgushy1gkg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can see detailed information about each package on the network by selecting it in the list on the left: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fl/2w/_f/fl2w_fotyjqzbmdpt9tp6fvyyba.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Scrolling to the end of the package contents, you will see a line with the text "send_data_to_coordinator":</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vm/da/ha/vmdahazkjgs7ttk_d-hg6osq7oi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can try other methods of sending data, but there (for example, to send to a separate selected node) you need to register the node address. </font><font style="vertical-align: inherit;">You can see the addresses of all modules in the XCTU program. </font><font style="vertical-align: inherit;">How to register specific addresses is exhaustively described in the example.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. We make the MQTT gateway</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is great, but now I would like to somehow work with this data outside the XBee network, for example, on the Internet. </font><font style="vertical-align: inherit;">One way to do this is to put the translator from XBee into the popular MQTT protocol. </font><font style="vertical-align: inherit;">Then, in the usual way, we can subscribe to event notifications and send commands from the user interface, and this program can be located anywhere (if you use an external rather than a local MQTT server), and not just on our computer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below is an instruction. </font><font style="vertical-align: inherit;">In short, the program launched on the computer will exchange data from the network coordinator via a USB connection. </font><font style="vertical-align: inherit;">She will transmit these data to the MQTT protocol.</font></font><br>
<img src="https://habrastorage.org/webt/t0/yo/dx/t0yodx2oqigqjepdzr0w8exjwaq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install and configure XBMQ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The program that we will use as the MQTT gateway is called XBMQ, it is open and free. </font><font style="vertical-align: inherit;">Exists in two versions:</font></font><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NodeJS</font></font></a><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Java version will be considered, although this is not too fundamental: we will not program it anyway, we will only install it and use it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the program to work, you will need the RXTX library, it can be installed simply from the repository:</font></font><br>
<pre><code class="bash hljs">sudo apt-get install librxtx-java</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And of course, you need the JDK (Java Development Kit). </font><font style="vertical-align: inherit;">It exists in two versions - from Oracle and OpenJDK, the second is recommended. </font><font style="vertical-align: inherit;">Most likely, OpenJDK is already installed on your system; if not, reinstall it. </font><font style="vertical-align: inherit;">Java needs a maximum of 8th, since </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">javax.xml.bind is excluded from Java 11</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and you need to choose an alternative with JDK-8 as the default option, or create a configuration for this case. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download the repository of the XBMQ program:</font></font><br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://github.com/angryelectron/xbmq-java</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After downloading the source codes, we will collect the binary file of the program. </font><font style="vertical-align: inherit;">Team</font></font><br>
<pre><code class="bash hljs">ant dist</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
will assemble a project for all major operating systems. </font><font style="vertical-align: inherit;">The final compiled program will be in the folder </font></font><code>dist</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now configure this program. </font><font style="vertical-align: inherit;">Open file</font></font><pre><code class="plaintext hljs">dist/xbmq.properties</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 and see there:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment">#</span>
<span class="hljs-comment"># Xbmq Properties.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#port = /dev/ttyUSB0</span>
<span class="hljs-comment">#baud = 9600</span>
<span class="hljs-comment">#rootTopic = ab123</span>
<span class="hljs-comment">#broker = tcp://test.mosquitto.org:1883</span>
<span class="hljs-comment">#username = user</span>
<span class="hljs-comment">#password = password</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uncomment and change to your parameters. </font><font style="vertical-align: inherit;">The parameters are as follows: ZigBee coordinator connection port, speed, root topic (all data will fall into it), MQTT server address, username and password (if the server requires them). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this example, only the server address has changed - to the local mqtt server (standard mosquitto from Linux). </font><font style="vertical-align: inherit;">Everything else was left by default:</font></font><br>
<pre><code class="bash hljs"><font></font>
port = /dev/ttyUSB0<font></font>
baud = 9600<font></font>
rootTopic = ab123<font></font>
broker = tcp://127.0.0.1:1883<font></font>
username = user<font></font>
password = password<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before the next step, you have to install and run the local mosquitto MQTT server:&nbsp;</font></font><br>
<pre><code class="bash hljs">sudo apt-get install mosquitto</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XBMQ launch</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, the program can be launched. </font><font style="vertical-align: inherit;">Having connected the USB-UART converter with the coordinator module inserted, run the program:</font></font><br>
<pre><code class="bash hljs">./dist/xbmq.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you run the script, we see the line in the console:</font></font><br>
<pre><code class="bash hljs">INFO - Starting XBMQ gateway ab123/0013A2004154EA46</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Last - this is exactly the address of our coordinator. </font><font style="vertical-align: inherit;">If you subscribe to all topics with an external MQTT client, you will immediately see 2 messages:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the topic </font></font><code>ab123/0013A2004154EA46/online</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- will be 1, this is Last Will (a good example of how these "special" parameters are used in real life)</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The topic </font></font><code>ab123/0013A2004154EA46/log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will contain the same debugging phrase ‚ÄúStarting XBMQ gateway ...‚Äù that you already saw in the console</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now try to send a message from some other external XBee module - for example, take an example with sending data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, in the MQTT.fx program, if you subscribe to all topics (#), you will see this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hy/56/5l/hy565luregquqnizlxf7pejdn40.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The MQTT.fx program window.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
That is, by starting the example studied earlier with sending a message to the coordinator, we will see this text (‚Äúsend_data_to_coordinator‚Äù) as a part MQTT package. The common parent topic for us is the one specified in the program configuration ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ab123</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you can change it to your own). Next comes the address of the coordinator, then the address of the module from which the message came. Finally, this topic is called DataOut, because it is outgoing data.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, you will see such a picture in any other MQTT client, whether it be MQTTLens or even just</font></font><code>mosquitto_sub</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the console. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A couple of final comments:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a good way, this program should work in daemon mode. </font><font style="vertical-align: inherit;">There is an xbmqd file for this, and README says how to use it.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keep in mind that since it </font></font><code>xbmq</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">holds the port, we cannot run this program at the same time as XCTU.</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can work with your system using the MQTT protocol and write complex, interesting programs! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g8/kt/h0/g8kth04siprq-9s2uwlli2fp6ae.jpeg" align="left"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tatyana Volkova - The author of the training program on the Internet of Things track ‚ÄúSamsung IT Academy‚Äù, a specialist in corporate social responsibility programs at Samsung Research Center</font></font><br>
</i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497178/index.html">‚Äú1C: ERP‚Äù and ‚Äú1C: CRM‚Äù: functionality and comparative analysis of configurations</a></li>
<li><a href="../en497184/index.html">A look at the promising directions of development of geological, geophysical and field data management systems</a></li>
<li><a href="../en497186/index.html">How is the search for a vaccine for coronavirus</a></li>
<li><a href="../en497192/index.html">How IT works from a distance: tips for managing distributed teams</a></li>
<li><a href="../en497194/index.html">Tinder knows more about your intimate life than your friends</a></li>
<li><a href="../en497204/index.html">Digital 2020: fixing trends</a></li>
<li><a href="../en497206/index.html">About Object Oriented Programming</a></li>
<li><a href="../en497212/index.html">[Instruction] Using Google-disk, Google-Site, Google-Form to create a data bank and feedback systems</a></li>
<li><a href="../en497214/index.html">Data Engineer and Data Scientist: what they can and how much they earn</a></li>
<li><a href="../en497216/index.html">We made a coronavirus epidemic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>