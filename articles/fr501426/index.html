<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧗🏼 🎎 💄 Unison: configuration et automatisation de la synchronisation bidirectionnelle des répertoires sur deux serveurs 👇🏿 🧑🏾‍🤝‍🧑🏻 👩🏽‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Getty Images / iStockphoto Le
 
 problème de la synchronisation des répertoires sur deux serveurs avec la famille Linux de systèmes d'exploitation à b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unison: configuration et automatisation de la synchronisation bidirectionnelle des répertoires sur deux serveurs</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/501426/"><img src="https://habrastorage.org/webt/px/ch/pt/pxchptdqlhxiictuiik4ldo02ka.jpeg"><br>
<sup><font color="9999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getty Images / iStockphoto Le</font></font></font></sup><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
problème de la synchronisation des répertoires sur deux serveurs avec la famille Linux de systèmes d'exploitation à bord peut être résolu plus facilement si vous utilisez des outils spécialisés. Voyons comment cela peut être fait avec</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unison</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous possédez peut-être plusieurs serveurs et vous devez synchroniser certains répertoires sur ces serveurs. Par exemple, vous devez synchroniser le répertoire </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur chacun de ces serveurs afin que certaines applications aient accès aux informations pertinentes. Ou peut-être avez-vous simplement besoin de sauvegarder périodiquement les données d'un serveur à un autre de manière synchronisée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unison est similaire à l'utilitaire de synchronisation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rsync</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais contrairement à lui, il prend en charge la synchronisation bidirectionnelle. Autrement dit, il vous permet de synchroniser deux copies de fichiers, en mettant à jour chaque copie en fonction des modifications apportées.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous utilisez Unison sur des serveurs, il est souhaitable d'avoir installé des packages tels que openssh-server et ssh, car pour des raisons de sécurité, la synchronisation est préférable en utilisant le protocole SSH. </font><font style="vertical-align: inherit;">Cependant, si vous êtes confiant dans la sécurité de votre réseau (par exemple, le serveur peut utiliser l'authentification SSH sans mot de passe), vous ne pouvez pas vous embêter.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quoi d'autre est nécessaire pour utiliser Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais montrer l'ensemble du processus en utilisant deux serveurs Ubuntu comme exemple (les deux 18.04). </font><font style="vertical-align: inherit;">Vous pouvez installer et utiliser Unison avec d'autres distributions, mais vous devrez ensuite modifier la commande d'installation, sinon Unison peut être installé à partir de référentiels standard (bien sûr, votre utilisateur doit disposer des droits sudo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'utiliserai ces serveurs:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serveur1 - 192.168.1.6</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serveur2 - 192.168.1.19</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment installer Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première chose à faire est d'installer Unison. </font><font style="vertical-align: inherit;">Cela devrait être fait sur les deux serveurs. </font><font style="vertical-align: inherit;">Accédez aux deux serveurs et entrez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install unison unison-all -y</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Attendez la fin de l'installation d'Unison et continuez.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment générer et copier une clé SSH</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous générons la clé SSH uniquement pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pour ce faire, utilisez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">ssh-keygen -t rsa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous êtes invité à entrer un mot de passe, appuyez simplement sur la touche ENTRÉE. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois la clé générée, copiez-la sur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à l'aide de la commande:</font></font><br>
<br>
<pre><code class="bash hljs">ssh-copy-id 192.168.1.19</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois la clé copiée, vous pouvez passer directement aux affaires.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment utiliser Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créons un répertoire de test pour chaque serveur à des fins de test. </font><font style="vertical-align: inherit;">Commande pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir -p /data1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir -p /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, sur les deux serveurs, vous devez changer le nom du propriétaire du répertoire créé, sinon Unison ne pourra rien y écrire. </font><font style="vertical-align: inherit;">En tant que propriétaire, spécifiez l'utilisateur qui exécutera la commande Unison:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>.<span class="hljs-variable">$USER</span> /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faites de même pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>.<span class="hljs-variable">$USER</span> /data1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mettez des fichiers de test dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">touch /data1/{test1,test2,test3}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous synchronisons nos répertoires avec la commande suivante (en l'exécutant sur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs">unison /data1 ssh://192.168.1.19//data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque vous essayez de synchroniser ces répertoires racine pour la première fois, vous recevrez un avertissement indiquant que la synchronisation peut prendre un certain temps (mais dans notre cas, cela ne se produira pas, car nous n'avons ajouté que trois fichiers de test du volume minimum au répertoire). </font><font style="vertical-align: inherit;">S'il s'agissait d'une sauvegarde en production, le premier lancement pourrait vraiment prendre un certain temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors buvez du thé la prochaine fois. </font><font style="vertical-align: inherit;">En attendant, appuyez sur Entrée pour démarrer le processus. </font><font style="vertical-align: inherit;">Après cela, il vous sera demandé de confirmer la synchronisation de chaque fichier. </font><font style="vertical-align: inherit;">Une fois terminé, entrez «y» pour continuer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous ne synchronisons que trois fichiers de test, cela se produira très rapidement et vous ramènera au shell bash. </font><font style="vertical-align: inherit;">Pour vous assurer que les fichiers sont synchronisés, accédez à </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et entrez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">ls /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, le système signalera que </font><font style="vertical-align: inherit;">nos fichiers test1, test2 et test3 se trouvent </font><font style="vertical-align: inherit;">dans le répertoire </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pu/xv/bi/puxvbivby-poqpuch07emsz7kui.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons réussi: Unison a synchronisé les deux répertoires.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment démarrer Unison sans avoir besoin d'interaction avec l'utilisateur</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense que vous ne voulez pas confirmer constamment la synchronisation de chaque fichier de répertoire à chaque démarrage de Unison. </font><font style="vertical-align: inherit;">Cela est particulièrement gênant lorsque vous synchronisez des répertoires avec un grand nombre de fichiers. </font><font style="vertical-align: inherit;">Par conséquent, l'automatisation est nécessaire. </font><font style="vertical-align: inherit;">Accédez à </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et entrez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/.unison/default.prf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le fichier de configuration s'ouvre pour modification, ajoutez-y deux lignes:</font></font><br>
<br>
<pre><code class="bash hljs">auto=<span class="hljs-literal">true</span>
batch=<span class="hljs-literal">true</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enregistrez puis fermez le fichier. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, Unison ne vous dérangera pas avec des bagatelles. </font><font style="vertical-align: inherit;">Mais ce n'est pas tout.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment créer une tâche pour Cron Scheduler</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense que vous ne voudriez guère démarrer la synchronisation manuellement, car vous pouvez faire une erreur quelque part ou, par exemple, ne pas prendre en compte le changement dans la structure du répertoire sur les serveurs. </font><font style="vertical-align: inherit;">Pour configurer l'automatisation, vous devez créer un travail cron pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créons un script pour démarrer la synchronisation:</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /usr/<span class="hljs-built_in">local</span>/bin/unisonsync</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les éléments suivants doivent être ajoutés à ce fichier: </font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#!/bin/bash/</span>
unison /data1 ssh://192.168.1.19//data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez donner au script le droit d'exécuter:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod ugo+x /usr/<span class="hljs-built_in">local</span>/bin/unisonsync</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez un travail pour Cron avec la commande:</font></font><br>
<br>
<pre><code class="bash hljs">crontab -e</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après ce type:</font></font><br>
<br>
<pre><code class="bash hljs">*/5 * * * * /usr/<span class="hljs-built_in">local</span>/bin/unisonsync &amp;&gt; /dev/null</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, la synchronisation démarre automatiquement toutes les 5 minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai montré que Unison facilite la synchronisation des répertoires sur deux serveurs Linux. </font><font style="vertical-align: inherit;">Vous pouvez le vérifier vous-même en ajoutant des fichiers aux répertoires de test </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data2 correspondants</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur les deux serveurs. </font><font style="vertical-align: inherit;">Après vous être assuré que la synchronisation fonctionne, vous pouvez l'utiliser en mode combat sur les serveurs de production.</font></font><br>
<br>
<hr><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme une publicité</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VDSina est</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> toujours heureux d'offrir des serveurs fiables pour toutes les tâches. </font><font style="vertical-align: inherit;">Vous avez accès à une vaste sélection de systèmes d'exploitation pour une installation automatique, il est possible d'installer n'importe quel système d'exploitation à partir de votre propre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ainsi que d'utiliser un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réseau local à</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> grande vitesse </font><font style="vertical-align: inherit;">entre les serveurs au même endroit.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr501414/index.html">Configurer Debian, Nginx et Gunicorn pour un projet Django</a></li>
<li><a href="../fr501416/index.html">Un peu sur WebRTC: quoi utiliser et le cas de la pratique</a></li>
<li><a href="../fr501418/index.html">Semaine 4 Marathon: Motivation</a></li>
<li><a href="../fr501420/index.html">Mitapas et émissions en ligne sur YouTube: semaine de diffusion du groupe JUG Ru</a></li>
<li><a href="../fr501424/index.html">De la vie avec Kubernetes: comment nous avons supprimé le SGBD (et pas seulement) des environnements de révision aux statiques</a></li>
<li><a href="../fr501430/index.html">Excellent guide de conception et de planification de contenu de site Web</a></li>
<li><a href="../fr501432/index.html">Deux alternatives à JDBC</a></li>
<li><a href="../fr501434/index.html">Semaine de la sécurité 20: piratage d'un ordinateur via Thunderbolt</a></li>
<li><a href="../fr501436/index.html">Algorithme de reconnaissance des nombres sur l'image avec une faible probabilité du deuxième type d'erreur</a></li>
<li><a href="../fr501438/index.html">Fonctionnement du rendu de jeu 3D: éclairage et ombres</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>