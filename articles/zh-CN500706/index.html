<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☎️ 👩🏽‍🍳 🆒 将MySQL（Percona Server）从5.7升级到8.0 📔 🤴🏼 👩🏽‍🍳</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="进展不会停滞不前，因此升级到最新版本的MySQL的原因变得越来越重要。不久前，在我们的一个项目中，是时候将舒适的Percona Server 5.7群集升级到版本8了。所有这些都发生在Ubuntu Linux 16.04平台上。如何以最少的停机时间执行类似的操作，以及我们在升级过程中遇到了什么问题-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>将MySQL（Percona Server）从5.7升级到8.0</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/500706/"><img src="https://habrastorage.org/webt/gr/ty/r9/grtyr9g5ysbgx9woi8ldfpn91ac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
进展不会停滞不前，因此升级到最新版本的MySQL的原因变得越来越重要。</font><font style="vertical-align: inherit;">不久前，在我们的一个项目中，是时候将舒适的Percona Server 5.7群集升级到版本8了。</font><font style="vertical-align: inherit;">所有这些都发生在Ubuntu Linux 16.04平台上。</font><font style="vertical-align: inherit;">如何以最少的停机时间执行类似的操作，以及我们在升级过程中遇到了什么问题-请阅读本文。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">训练</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数据库服务器的任何更新最有可能与数据库的迁移有关：系统资源限制要求的更改和数据库配置的更正，必须清除过时的指令。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在更新之前，我们一定会转向官方文档：</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL 8发行说明</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">；</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自MySQL的升级指南</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Percona的升级指南</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有关更新副本和向导的MySQL教程</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并制定行动计划：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 通过删除过时的指令来修复配置文件。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 检查与实用程序的兼容性。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过安装软件包来更新从数据库</font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 通过放置相同的软件包来更新向导。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将分析计划中的每个项目，看看会出什么问题。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基于Galera的MySQL群集升级过程具有其自身的精妙之处，本文中未进行介绍。</font><font style="vertical-align: inherit;">在这种情况下，您不应使用此指令。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第1部分：检查配置</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在版本8中，删除了MySQL </font></font><code>query_cache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">实际上，它</font><font style="vertical-align: inherit;">在5.7版中</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">被</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">宣布作废</font></a><font style="vertical-align: inherit;">，但现在已被</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全删除</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，有必要删除相关指令。</font><font style="vertical-align: inherit;">对于缓存查询，您现在可以使用外部工具，例如</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在配置中还发现了过时的pro指令</font></font><code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果在MySQL 5.7中可以选择InnoDB格式，则第8版</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅适用于梭子鱼格式</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的结果是删除了以下指令：</font></font><br>
<br>
<ul>
<li> <code>query_cache_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>query_cache_limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>query_cache_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>innodb_file_format_max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了进行验证，我们将使用Percona Server的Docker映像。</font><font style="vertical-align: inherit;">我们将服务器配置放在目录中</font></font><code>mysql_config_test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后创建用于数据和日志的目录。</font><font style="vertical-align: inherit;">percona-server配置测试示例：</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p {mysql_config_test,mysql_data,mysql_logs}<font></font>
cp -r /etc/mysql/conf.d/* mysql_config_test/<font></font>
docker run  --name some-percona -v $(<span class="hljs-built_in">pwd</span>)/mysql_config_test:/etc/my.cnf.d/  -v $(<span class="hljs-built_in">pwd</span>)/mysql_data/:/var/lib/mysql/ -v $(<span class="hljs-built_in">pwd</span>)/mysql_logs/:/var/<span class="hljs-built_in">log</span>/mysql/ -e MYSQL_ROOT_PASSWORD=<span class="hljs-variable">${MYSQL_PASSWORD}</span> -d percona:8-centos</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果：在Docker日志中，或在包含日志的目录中-根据您的配置-将出现一个文件，其中将描述问题指令。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是我们所拥有的：</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-03T12:44:19.670831Z 0 [Warning] [MY-011068] [Server] The syntax 'expire-logs-days' is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.<font></font>
2020-04-03T12:44:19.671678Z 0 [Warning] [MY-013242] [Server] --character-set-server: 'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.<font></font>
2020-04-03T12:44:19.671682Z 0 [Warning] [MY-013244] [Server] --collation-server: 'utf8_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们仍然需要处理编码并替换过时的指令</font></font><code>expire-logs-days</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第2部分：验证正在运行的安装</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新文档中有2个实用程序，用于检查数据库的兼容性。</font><font style="vertical-align: inherit;">它们的使用有助于管理员验证现有数据结构的兼容性。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们从经典的mysqlcheck实用程序开始。</font><font style="vertical-align: inherit;">只需运行：</font></font><br>
<br>
<pre><code class="bash hljs">mysqlcheck -u root -p --all-databases --check-upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果未检测到问题，则该实用程序将以代码0退出：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/f-/yk/xcf-yknfyh2puesxjqupkstv_qo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql-shell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实用程序在现代版本的MySQL中可用</font><font style="vertical-align: inherit;">（在Percona的情况下，这是一个软件包</font></font><code>percona-mysql-shell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。它是经典mysql客户端的替代，并结合了客户端，SQL编辑器和MySQL管理工具的功能。要在更新之前检查服务器，可以通过它运行以下命令：</font></font><br>
<br>
<pre><code class="bash hljs">mysqlsh -- util check-for-server-upgrade { --user=root --host=1.1.1.1 --port=3306 } --config-path=/etc/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下是我们收到的评论：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o_/nd/r5/o_ndr55tsfxrr0gbbu7zgala-vu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总的来说，没有什么重要的-只是有关编码的警告</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（请参阅下文）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">实施的总体结果：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/uy/xc/afuyxccks5gfu2w2bl1pgruvv-8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们决定更新应该没有问题。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上面警告中的注释表示编码问题。</font><font style="vertical-align: inherit;">事实上，直到最近，MySQL中的UTF-8才</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不是真正的UTF-8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因为它仅存储3个字节而不是4个字节。在MySQL 8中，他们最终</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">决定对其进行修复</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：别名</font></font><code>utf8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将很快导致编码</font></font><code>utf8mb4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而旧的</font><font style="vertical-align: inherit;">将导致编码</font><font style="vertical-align: inherit;">。表中的列将变为</font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">将来，该编码</font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将被删除，但在此版本中不会删除。</font><font style="vertical-align: inherit;">因此，我们决定在更新DBMS后将其编码固定在可以正常工作的DBMS安装上。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第3部分：服务器更新</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果有这样一个别致的计划，可能会出什么问题？..意识到细微差别总是会发生的，我们在MySQL开发集群上进行了第一个实验。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如前所述，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">官方文档</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">强调了使用副本更新MySQL服务器的问题。最重要的是，起初值得更新所有副本（从属），因为MySQL 8可以从5.7版向导进行复制。某些困难在于，</font><font style="vertical-align: inherit;">当远程主机处于</font><b><font style="vertical-align: inherit;">只读</font></b><font style="vertical-align: inherit;">模式时</font><font style="vertical-align: inherit;">，我们使用</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主机&lt;-&gt;主机</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模式</font><font style="vertical-align: inherit;">。也就是说，实际上，战斗流量进入一个数据中心，第二个进入备份中心。</font><font style="vertical-align: inherit;">
拓扑如下：</font><font style="vertical-align: inherit;">
升级应从</font><i><font style="vertical-align: inherit;">mysql副本dc 2</font></i><font style="vertical-align: inherit;">副本开始</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/uw/kx/j0/uwkxj0bwhbtjxd27brnug5iosaq.png"><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql master dc 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>mysql replica dc 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql master dc 1服务器，并最终以mysql master dc 1.服务器结束</font></font><code>STOP SLAVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">更新的其余部分如下所示：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">每个副本重启，增加配置选项3： ，</font></font><code>skip-networking</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">。</font></font><code>skip-slave-start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> </font></font><code>skip-log-bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事实是，更新数据库会生成带有更新系统表的二进制日志。</font><font style="vertical-align: inherit;">这些指令确保数据库中的应用程序数据不会发生任何更改，并且有关更新系统表的信息也不会进入二进制日志中。</font><font style="vertical-align: inherit;">这将避免恢复复制时出现问题。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装软件包</font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">需要注意的是在MySQL 8，你是很重要的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并不</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">需要运行命令</font></font><code>mysqlupgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新服务器后。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 成功启动后，请重新启动服务器-已经没有第一段中添加的参数。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们确保复制成功进行：检查</font></font><code>SHOW SLAVE STATUS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并查看应用程序数据库中带有计数器的表是否已更新。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有这些看起来都很简单：开发人员更新成功。</font><font style="vertical-align: inherit;">好的，您可以安全地计划生产的通宵升级。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有悲伤-我们更新了产品</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，将成功的开发经验移植到生产中并非没有意外。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸运的是，更新过程本身始于副本，因此遇到困难后，我们停止了工作，并从快照中恢复了副本。第二天早上重新安排了问题研究的时间。以下条目出现在日志中：</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-01-14T21:43:21.500563Z 2 [ERROR] [MY-012069] [InnoDB] table: t1 has 19 columns but InnoDB dictionary has 20 columns<font></font>
2020-01-14T21:43:21.500722Z 2 [ERROR] [MY-010767] [Server] Error in fixing SE data for db1.t1<font></font>
2020-01-14T21:43:24.208365Z 0 [ERROR] [MY-010022] [Server] Failed to Populate DD tables.<font></font>
2020-01-14T21:43:24.208658Z 0 [ERROR] [MY-010119] [Server] Aborting</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对Google上各种邮件列表的档案的研究导致人们认识到这样的问题是由于</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL错误</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而引起的</font><font style="vertical-align: inherit;">。尽管它甚至是一个实用程序错误</font></font><code>mysqlcheck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>mysqlsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事实证明，MySQL更改了十进制字段（int，tinyint等）的数据表示方式，因此另一种存储它们的方法是在mysql-server内部使用。如果您的数据库</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是5.5或5.1版本，然后又升级到5.7，则可能需要生成</font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一些表。然后，MySQL将更新数据文件，并将其传输为当前的存储格式。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您也可以使用实用程序进行检查</font></font><code>mysqlfrm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">mysqlfrm --diagnostic -vv /var/lib/mysql/db/table.frm<font></font>
...<font></font>
 <span class="hljs-string">'field_length'</span>: 8,
  <span class="hljs-string">'field_type'</span>: 246, <span class="hljs-comment">#  </span>
  <span class="hljs-string">'field_type_name'</span>: <span class="hljs-string">'decimal'</span>,
  <span class="hljs-string">'flags'</span>: 3,
  <span class="hljs-string">'flags_extra'</span>: 67,
  <span class="hljs-string">'interval_nr'</span>: 0,
 <span class="hljs-string">'name'</span>: <span class="hljs-string">'you_deciaml_column'</span>,<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果</font></font><code>field_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您有0，那么表中将使用旧类型-必须完成</font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。但是，如果值是246，则您已经有一个新类型。有关类型的更多信息，请参见</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此外，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此错误</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">考虑了绕过我们的第二个可能原因- </font></font><code>INNODB_SYS_TABLESPACES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果</font><font style="vertical-align: inherit;">系统表</font><font style="vertical-align: inherit;">是在5.1版中创建的，则</font><font style="vertical-align: inherit;">系统表中缺少InnoDB表</font><font style="vertical-align: inherit;">。为避免升级期间出现问题，您可以使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">随附的SQL脚本</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为什么我们在开发人员上没有这样的问题？从生产中定期复制该库-因此，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新创建</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了这些</font><b><font style="vertical-align: inherit;">表</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不幸的是，在一个真正有效的大型数据库上，仅采用并执行无处不在的数据库是行不通的</font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Percona工具包将在这里提供帮助：pt-online-schema-change实用程序非常适合在线OPTIMIZE操作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新后的计划如下：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 优化所有表。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 执行数据库升级。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要检查它并同时找出更新时间，我们禁用了其中一个副本，并且对于所有表，我们运行以下命令：</font></font><br>
<br>
<pre><code class="bash hljs">pt-online-schema-change --critical-load Threads_running=150 --alter <span class="hljs-string">"ENGINE=InnoDB"</span> --execute --chunk-size 100 --quiet --alter-foreign-keys-method auto h=127.0.0.1,u=root,p=<span class="hljs-variable">${MYSQL_PASSWORD}</span>,D=db1,t=t1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于该实用程序会创建一个新的临时表并将其从主表中复制数据，因此无需长时间锁定即可更新这些表。</font><font style="vertical-align: inherit;">当两个表相同时，原始表将被锁定并被一个新表替换。</font><font style="vertical-align: inherit;">在我们的案例中，测试运行表明更新所有表大约需要一天的时间，但是复制数据会导致磁盘上的负载过多。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了避免这种情况，在生产时，我们在命令中添加了</font></font><code>--sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个值为10 </font><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">参数-该参数控制将数据包传输到新表后的等待时间。</font><font style="vertical-align: inherit;">这样，如果真正运行的应用程序需要响应时间，则可以减少负载。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
执行优化后，更新成功。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...但不完全是！</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新后半小时，客户端提出了一个问题。</font><font style="vertical-align: inherit;">该基地的工作非常奇怪：定期地，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">连接中断</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开始了</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">监视中的样子：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hu/gn/7v/hugn7vq8clkacetlzfb-gli1bcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
锯齿图在屏幕截图中可见，这是由于MySQL服务器的部分线程定期由于错误而掉线的事实。</font><font style="vertical-align: inherit;">应用程序中出现错误：</font></font><br>
<br>
<pre><code class="plaintext hljs">[PDOException] SQLSTATE[HY000] [2002] Connection refused</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对日志的快速检查显示，mysqld守护程序无法从操作系统获取所需的资源。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">处理</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">错误时，我们在系统</font><b><font style="vertical-align: inherit;">“孤立的” apparmor策略文件中找到了</font></b><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># dpkg -S /etc/apparmor.d/cache/usr.sbin.mysqld</span><font></font>
dpkg-query: no path found matching pattern /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/local/usr.sbin.mysqld</span>
dpkg-query: no path found matching pattern /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/usr.sbin.mysqld</span><font></font>
mysql-server-5.7: /etc/apparmor.d/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -l mysql-server-5.7</span>
rc  mysql-server-5.7 5.7.23-0ubuntu0.16.04.1      amd64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些文件是几年前升级到MySQL 5.7时形成的，属于远程软件包。</font><font style="vertical-align: inherit;">删除文件并重新启动apparmor服务可以解决此问题：</font></font><br>
<br>
<pre><code class="bash hljs">systemctl stop apparmor<font></font>
rm /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/usr.sbin.mysqld<font></font>
systemctl start apparmor</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任何操作，即使是最简单的操作，都可能导致意外问题。</font><font style="vertical-align: inherit;">而且，即使有一个经过深思熟虑的计划也不能总是保证预期的结果。</font><font style="vertical-align: inherit;">现在，在任何更新计划中，我们的团队还包括强制清除可能由于最近的操作而出现的多余文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
借助这项非专业的图形作品，我要感谢Percona的出色产品！</font></font><br>
<br>
<img height="75" width="75" src="https://habrastorage.org/webt/b1/af/mg/b1afmgyaozxjh0dqcbr3jrkdlk4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聚苯乙烯</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另请参阅我们的博客：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据库和Kubernetes（审查和视频报告）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes提示和技巧：加快大型数据库的引导速度</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们SRE日常生活中的6个实用故事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">    Redis  K8s  -      </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">  MongoDB  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN500694/index.html">68不请自来的提示</a></li>
<li><a href="../zh-CN500696/index.html">跑步鞋如何适应女性的脚</a></li>
<li><a href="../zh-CN500698/index.html">Evgeny Katyshev：“ OpenStreetMap不适合任何信息”</a></li>
<li><a href="../zh-CN500700/index.html">支持TLS1.3和扩展您的个人帐户：2020年第一季度所做的工作</a></li>
<li><a href="../zh-CN500704/index.html">独角兽（Airbnb，Uber，Lyft，Careem）在冠状病毒大流行期间陷入困境，解雇了数千名员工</a></li>
<li><a href="../zh-CN500708/index.html">安全性和DBMS：选择保护工具时需要记住的内容</a></li>
<li><a href="../zh-CN500712/index.html">数字冠状病毒-勒索软件和Infostealer的组合</a></li>
<li><a href="../zh-CN500718/index.html">远程模式下的EPAM：如何工作</a></li>
<li><a href="../zh-CN500720/index.html">新的信息安全标准：使攻击者的生活更加艰难</a></li>
<li><a href="../zh-CN500722/index.html">“烘烤直到准备就绪”：谁以不寻常的方式保存了稀有的录音带</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>