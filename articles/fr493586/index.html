<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéâ üë©‚Äçüë©‚Äçüë¶ üë©üèº‚Äçü§ù‚Äçüë®üèΩ Optimisations du compilateur JIT pour .NET 5 üö∂üèº üíæ üßë‚Äçü§ù‚Äçüßë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, j'ai commenc√© un voyage incroyable dans le monde du compilateur JIT afin de trouver des endroits o√π vous pouvez mettre la main e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Optimisations du compilateur JIT pour .NET 5</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493586/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il y a quelque temps, j'ai commenc√© un voyage incroyable dans le monde du compilateur JIT afin de trouver des endroits o√π vous pouvez mettre la main et acc√©l√©rer quelque chose, car Au cours du travail principal, une petite quantit√© de connaissances en LLVM et ses optimisations s'est accumul√©e. Dans cet article, je voudrais partager une liste de mes am√©liorations dans JIT (dans .NET, il s'appelle RyuJIT en l'honneur d'un dragon ou d'un anime - je ne l'ai pas compris), dont la plupart ont d√©j√† atteint master et seront disponibles dans .NET (Core) 5 Mes optimisations affectent diff√©rentes phases de JIT, ce qui peut √™tre illustr√© de mani√®re tr√®s sch√©matique comme suit: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/ao/qk/diaoqktgwhzremeu8qd8inutrak.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme le montre le diagramme, JIT est un module distinct li√© √† l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface Jit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©troite </font><font style="vertical-align: inherit;">, par lequel JIT consulte sur certaines choses, par exemple, est- </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il possible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lancer une classe √† l'autre. </font><font style="vertical-align: inherit;">Plus tard le JIT compile la m√©thode dans Tier1, plus le runtime peut fournir d'informations, par exemple, que les </font></font><code>static readonly</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">champs peuvent √™tre remplac√©s par une constante, car </font><font style="vertical-align: inherit;">la classe est d√©j√† initialis√©e statiquement.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons donc par la liste.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1817</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Optimisations de boxing / unboxing dans la correspondance de mod√®les</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> importateur La </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
plupart des nouvelles fonctionnalit√©s C # p√®chent souvent en ins√©rant des opcodes CIL </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">box / unbox</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il s'agit d'une op√©ration tr√®s co√ªteuse, qui consiste essentiellement √† allouer un nouvel objet sur le tas, √† y copier la valeur de la pile, puis √† charger √©galement le GC √† la fin. </font><font style="vertical-align: inherit;">Il existe d√©j√† un certain nombre d'optimisations dans JIT pour ce cas, mais j'ai trouv√© une correspondance de mod√®le manquante en C # 8, par exemple:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> Case1&lt;T&gt;(T o)<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (o <span class="hljs-keyword">is</span> <span class="hljs-keyword">int</span> x)
        <span class="hljs-keyword">return</span> x;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> Case2&lt;T&gt;(T o) =&gt; o <span class="hljs-keyword">is</span> <span class="hljs-keyword">int</span> n ? n : <span class="hljs-number">42</span>;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> Case3&lt;T&gt;(T o)<font></font>
{<font></font>
    <span class="hljs-keyword">return</span> o <span class="hljs-keyword">switch</span><font></font>
    {<font></font>
        <span class="hljs-keyword">int</span> n =&gt; n,
        <span class="hljs-keyword">string</span> str =&gt; str.Length,<font></font>
        _ =&gt; <span class="hljs-number">0</span><font></font>
    };<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voyons l'asm-codegen avant mon optimisation (par exemple, pour la sp√©cialisation int) pour les trois m√©thodes: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/5m/8h/iv5m8hqdrwqazfpztoh_n0o0lho.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant apr√®s mon am√©lioration: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-t/f7/bx/-tf7bxj9jip9xzpa9nr3ccelv9w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait est que l'optimisation a trouv√© des mod√®les de code IL</font></font><br>
<br>
<pre><code class="plaintext hljs">box !!T<font></font>
isinst Type1<font></font>
unbox.any Type2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
lors de l'importation et de la possession d'informations sur les types, j'ai pu simplement ignorer ces opcodes et ne pas ins√©rer boxing-anboxing. </font><font style="vertical-align: inherit;">Soit dit en passant, j'ai √©galement </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impl√©ment√© la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m√™me optimisation </font><font style="vertical-align: inherit;">dans Mono. </font><font style="vertical-align: inherit;">Ci-apr√®s, un lien vers Pull-Request est contenu dans l'en-t√™te de la description d'optimisation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1157</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> typeof (T) .IsValueType ‚á® vrai / faux</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> importateur </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, j'ai form√© JIT √† remplacer imm√©diatement </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type.IsValueType</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par une constante si possible. </font><font style="vertical-align: inherit;">C'est un moins le d√©fi et la capacit√© de couper des conditions enti√®res et des branches √† l'avenir, un exemple:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">void</span> Foo&lt;T&gt;()<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">typeof</span>(T).IsValueType)<font></font>
        Console.WriteLine(<span class="hljs-string">"not a valuetype"</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et voyons le codegen pour la sp√©cialisation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foo &lt;int&gt;</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avant l'am√©lioration: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oa/28/lc/oa28lcmskvzitsjlpqr5dlh8uv4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et apr√®s l'am√©lioration: la </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zw/db/n_/zwdbn_ukemjzxf9qbkato_ptblm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
m√™me chose peut √™tre faite avec d'autres propri√©t√©s Type si n√©cessaire.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1157</font></font></a> <code>typeof(T1).IsAssignableFrom(typeof(T2)) ‚á® true/false</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> importateur </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presque la m√™me chose - vous pouvez maintenant v√©rifier la hi√©rarchie dans les m√©thodes g√©n√©riques sans craindre qu'elle ne soit pas optimis√©e, par exemple:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">void</span> Foo&lt;T1, T2&gt;()<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">typeof</span>(T1).IsAssignableFrom(<span class="hljs-keyword">typeof</span>(T2)))<font></font>
        Console.WriteLine(<span class="hljs-string">"T1 is not assignable from T2"</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la m√™me mani√®re, elle sera remplac√©e par une constante </font></font><code>true/false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et la condition pourra √™tre supprim√©e enti√®rement. </font><font style="vertical-align: inherit;">Dans de telles optimisations, bien s√ªr, ce n'est pas sans cas d'angle que vous devez toujours vous souvenir: System .__ Canon g√©n√©riques partag√©s, tableaux, variabilit√© co (ntr), nullables, objets COM, etc.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1378</font></font></a> <code>"Hello".Length ‚á® 5</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> importateur </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgr√© le fait que l'optimisation soit aussi √©vidente et simple que possible, j'ai d√ª beaucoup transpirer pour l'impl√©menter dans JIT-e. Le fait est que JIT ne connaissait pas le contenu de la cha√Æne, il a vu les litt√©raux de cha√Æne ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GT_CNS_STR</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), mais ne savait rien du contenu sp√©cifique des cha√Ænes. J'ai d√ª l'aider en contactant VM (pour √©tendre l'interface JIT susmentionn√©e), et l'optimisation elle-m√™me est essentiellement </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quelques lignes de code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il y a beaucoup de cas d'utilisateurs, en plus des cas √©vidents, tels que: </font></font><b><code>str.IndexOf("foo") + "foo".Length</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aux cas non √©vidents dans lesquels l'inline est impliqu√© (je vous rappelle: Roslyn ne traite pas de l'inline, donc cette optimisation y serait inefficace, comme tout le reste), un exemple:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Validate</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> str</span>)</span> =&gt; str.Length &gt; <span class="hljs-number">0</span> &amp;&amp; str.Length &lt;= <span class="hljs-number">100</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Test</span>(<span class="hljs-params"></span>)</span> =&gt; Validate(<span class="hljs-string">"Hello"</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regardons le codegen pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Validate est en</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ligne): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sl/kl/dz/slkldz4tb8stxhrq_bhz7cmqkdm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et maintenant le codegen apr√®s avoir ajout√© l'optimisation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4p/ao/f5/4paof5hshv_gsogtwqsocahc6vu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
i.e. </font><font style="vertical-align: inherit;">aligner la m√©thode, remplacer les variables par des litt√©raux de cha√Æne, remplacer .Length des litt√©raux par des longueurs de cha√Æne r√©elles, replier les constantes, supprimer le code mort. </font><font style="vertical-align: inherit;">Soit dit en passant, puisque JIT peut d√©sormais v√©rifier le contenu d'une cha√Æne, des portes se sont ouvertes pour d'autres optimisations li√©es aux litt√©raux de cha√Æne. </font><font style="vertical-align: inherit;">L'optimisation elle-m√™me a √©t√© mentionn√©e dans l'annonce du premier aper√ßu de .NET 5.0: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devblogs.microsoft.com/dotnet/announcing-net-5-0-preview-1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans la section </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Am√©liorations de la qualit√© du code dans RyuJIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1644:</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimisation des v√©rifications li√©es.</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √©limination de la v√©rification des limites </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour beaucoup, ce n'est pas un secret que chaque fois que vous acc√©dez √† un tableau par index, le JIT ins√®re pour vous un contr√¥le que le tableau ne va pas au-del√† et l√®ve une exception si cela se produit - dans le cas d'une logique erron√©e, vous ne pouvez pas pour lire la m√©moire al√©atoire, obtenir de la valeur et continuer.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Foo</span>(<span class="hljs-params"><span class="hljs-keyword">int</span>[] array, <span class="hljs-keyword">int</span> index</span>)</span><font></font>
{<font></font>
    <span class="hljs-comment">// if ((uint) array.Length &lt;= (uint) index)</span>
    <span class="hljs-comment">//     throw new IndexOutOfRangeException();</span>
    <span class="hljs-keyword">return</span> array[index];<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une telle v√©rification est utile, mais elle peut grandement affecter les performances: d'une part, elle ajoute une op√©ration de comparaison et rend votre code non ramifi√©, et d'autre part, elle ajoute un code d'appel d'exception √† votre m√©thode avec toutes les cons√©quences. Cependant, dans de nombreux cas, le JIT peut supprimer ces contr√¥les s'il peut se prouver que l'index ne d√©passera jamais cela, ou qu'il existe d√©j√† un autre contr√¥le et qu'un ajout suppl√©mentaire n'est plus n√©cessaire - √âlimination des contr√¥les de limites (plage). J'ai trouv√© plusieurs cas dans lesquels il ne pouvait pas faire face et les ai corrig√©s (et √† l'avenir, je pr√©vois d'autres am√©liorations de cette phase).</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> item = array[index &amp; mask];</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, dans ce code, je dis √† JIT qui </font></font><code>&amp; mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limite essentiellement l'indice d'en haut √† une valeur </font></font><code>mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, c'est-√†-dire </font><font style="vertical-align: inherit;">si la valeur </font></font><code>mask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et la longueur du tableau sont </font><font style="vertical-align: inherit;">connues de JIT </font><font style="vertical-align: inherit;">, vous ne pouvez pas ins√©rer de contr√¥le li√©. </font><font style="vertical-align: inherit;">Il en va de m√™me pour les op√©rations%, (&amp; x &gt;&gt; y). </font><font style="vertical-align: inherit;">Un exemple d'utilisation de cette optimisation dans </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aspnetcore</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, si nous savons que dans notre tableau, par exemple, il y a 256 √©l√©ments ou plus, alors si notre indexeur inconnu est du type octet, peu importe ses efforts, il ne pourra jamais sortir des limites. </font><font style="vertical-align: inherit;">PR: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/dotnet/coreclr/pull/25912</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 24584:</font></font></a> <code>x / 2 ‚á® x * 0.5</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Morph </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C de ce PR et a commenc√© ma plong√©e incroyable dans le monde des optimisations JIT. </font><font style="vertical-align: inherit;">L'op√©ration "division" est plus lente que l'op√©ration "multiplication" (et si pour les entiers et en g√©n√©ral - un ordre de grandeur). </font><font style="vertical-align: inherit;">Fonctionne pour des constantes uniquement √©gales √† la puissance de deux, par exemple:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">float</span> <span class="hljs-title">DivideBy2</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> x</span>)</span> =&gt; x / <span class="hljs-number">2</span>; <span class="hljs-comment">// = x * 0.5; </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Codegen avant optimisation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/df/vo/mf/dfvomfc6foisqpk9uvq8nfihfzy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et apr√®s: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ij/xk/u5/ijxku5zq0hhxmltazwxgfq1tvss.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
si nous comparons ces deux instructions pour Haswell, alors tout deviendra clair:</font></font><br>
<br>
<pre><code class="plaintext hljs">vdivss (Latency: 10-20,  R.Throughput: 7-14)<font></font>
vmulss (Latency:     5,  R.Throughput:  0.5)<font></font>
</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela sera suivi par des optimisations qui sont encore au stade de la r√©vision du code et non par le fait qu'elles seront accept√©es.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 31978:</font></font></a> <code>Math.Pow(x, 2) ‚á® x * x</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> importateur </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est simple ici: au lieu d'appeler pow (f) pour un cas assez populaire, lorsque le degr√© est constant 2 (enfin, c'est gratuit pour 1, -1, 0), vous pouvez le d√©velopper en un simple x * x. </font><font style="vertical-align: inherit;">Vous pouvez d√©velopper d'autres degr√©s, mais pour cela, vous devez attendre la mise en ≈ìuvre du mode ¬´math√©matique rapide¬ª dans .NET, dans lequel la sp√©cification IEEE-754 peut √™tre n√©glig√©e pour des raisons de performances. </font><font style="vertical-align: inherit;">Exemple:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">float</span> <span class="hljs-title">Pow2</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> x</span>)</span> =&gt; MathF.Pow(x, <span class="hljs-number">2</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Codegen avant optimisation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1o/7m/zw/1o7mzwatkp3kritfyahj_zjhija.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et apr√®s:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/el/9g/19/el9g19y1rul_r4sej7fx7sixiso.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 33024:</font></font></a> <code>x * 2 ‚á® x + x</code></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> abaissement L' </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
optimisation du micro (nano) piphol assez simple vous permet de multiplier par 2 sans charger la constante dans le registre.</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">float</span> <span class="hljs-title">MultiplyBy2</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> x</span>)</span> =&gt; x * <span class="hljs-number">2</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Codegen avant optimisation: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e7/4s/-r/e74s-rigvhc6eh14gl7ygnbeqva.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d5/wg/ru/d5wgrutrxfvbsccck-hhjdvw37w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, l'instruction est la </font></font><code>mul(ss/sd/ps/pd)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√™me en termes de latence et de d√©bit que </font></font><code>add(ss/sd/ps/pd)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais la n√©cessit√© de charger la constante ¬´2¬ª peut l√©g√®rement ralentir le travail. </font><font style="vertical-align: inherit;">Ici, dans l'exemple du codegen ci-dessus, j'ai </font></font><code>vaddss</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout fait dans le cadre d'un registre.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 32368:</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimisation de la baie. Longueur / c (ou% s)</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Morph </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il se trouve que le champ Longueur du tableau est un type sign√©, et la division et le reste par une constante est beaucoup plus efficace √† partir d'un type non sign√© (et pas seulement une puissance de deux), il suffit de comparer ce codegen: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7u/cf/0a/7ucf0a2z26ew1ndszgycipb4dxw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon PR rappelle simplement √† JIT que </font></font><code>Array.Length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bien que significatif, mais en fait, la longueur du tableau NEVER ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sauf si vous √™tes un anarchiste</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) peut √™tre inf√©rieure √† z√©ro, ce qui signifie que vous pouvez le regarder comme un nombre non sign√© et appliquer des optimisations comme pour uint.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 32716:</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimisation de comparaisons simples en code sans branche</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phase:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> analyse de flux </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'une autre classe d'optimisations qui fonctionne avec des blocs de base au lieu d'expressions en un. </font><font style="vertical-align: inherit;">Ici, JIT est un peu conservateur et peut √™tre am√©lior√©, par exemple des insertions cmove lorsque cela est possible. </font><font style="vertical-align: inherit;">J'ai commenc√© avec une optimisation simple pour ce cas:</font></font><br>
<br>
<pre><code class="cs hljs">x = condition ? A : B;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
si A et B sont des constantes et que la diff√©rence entre elles est l'unit√©, par exemple, </font></font><code>condition ? 1 : 2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alors nous, sachant que l'op√©ration de comparaison en elle-m√™me renvoie 0 ou 1, pouvons remplacer jump par add. </font><font style="vertical-align: inherit;">En termes de RyuJIT, cela ressemble √† ceci: je </font></font><br>
<br>
<img src="https://habrastorage.org/webt/am/y8/rv/amy8rv0tjz3vxzelpbz1lhgqr6a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
recommande de voir la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">description du</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PR lui-m√™me, j'esp√®re que tout y est clairement d√©crit.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toutes les optimisations ne sont pas √©galement utiles.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les optimisations n√©cessitent des frais assez √©lev√©s: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Augmentation = complexit√© du code existant pour le support et la lecture </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Bogues potentiels: tester les optimisations du compilateur est incroyablement difficile et facile de manquer quelque chose et d'obtenir une sorte de faute de segment de la part des utilisateurs. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Compilation lente </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
* Augmenter la taille du binaire JIT </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous l'avez d√©j√† compris, toutes les id√©es et tous les prototypes d'optimisations ne sont pas accept√©s et il faut prouver qu'ils ont droit √† la vie. L'une des fa√ßons accept√©es de le prouver dans .NET est d'ex√©cuter l'utilitaire jit-utils, qui compilera AOT un ensemble de biblioth√®ques (toutes BCL et corelib) et comparera le code assembleur pour toutes les m√©thodes avant et apr√®s les optimisations, voici </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment ce rapport</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recherche l'optimisation</font></font><code>"str".Length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En plus du rapport, il existe encore un certain cercle de personnes (telles que les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jkotas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) qui, en un coup d'≈ìil, peuvent √©valuer l'utilit√© et tout pirater du haut de leur exp√©rience et comprendre quels endroits dans .NET peuvent √™tre un goulot d'√©tranglement et lesquels ne le peuvent pas. </font><font style="vertical-align: inherit;">Et encore une chose: ne jugez pas l'optimisation par l'argument ¬´personne n'√©crit¬ª, ¬´il vaudrait mieux afficher juste un avertissement dans Roslyn¬ª - vous ne savez jamais √† quoi ressemblera votre code apr√®s JIT inline tout ce qui est possible et remplit les constantes.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr493574/index.html">Proxy local pour filtrer le trafic du navigateur</a></li>
<li><a href="../fr493578/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 407 (16-22 mars 2020)</a></li>
<li><a href="../fr493580/index.html">Apprendre √† d√©ployer des microservices. Partie 4. Jenkins</a></li>
<li><a href="../fr493582/index.html">√ât√© artificiel: ultraviolet lointain contre coronavirus</a></li>
<li><a href="../fr493584/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 503 (03.03.2020-09.03.2020)</a></li>
<li><a href="../fr493590/index.html">Pourquoi Cisco AnyConnect n'est pas seulement un client VPN</a></li>
<li><a href="../fr493594/index.html">PHP Digest n ¬∞ 176 (11-23 mars 2020)</a></li>
<li><a href="../fr493596/index.html">L'homme qui n'√©tait pas press√©</a></li>
<li><a href="../fr493598/index.html">Masquer une partie du num√©ro de t√©l√©phone</a></li>
<li><a href="../fr493604/index.html">√âv√©nements num√©riques √† Moscou du 23 au 29 mars</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>