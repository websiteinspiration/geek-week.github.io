<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍💼 🔝 🙇🏾 Le début le plus simple de la STM grâce à «un seul endroit» 🧑🏼‍🤝‍🧑🏼 👩🏻‍🍳 🙋🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probablement, le temps des guerres religieuses d'AVR contre la STM est déjà passé, mais non, non, oui, il y a des éclats d'affrontements entre les deu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Le début le plus simple de la STM grâce à «un seul endroit»</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488380/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablement, le temps des guerres religieuses d'AVR contre la STM est déjà passé, mais non, non, oui, il y a des éclats d'affrontements entre les deux camps. Presque toute publication sur l'artisanat AVR aura certainement un commentaire comme «Oui, combien vous pouvez baiser votre grand-mère, il est grand temps de passer à la STM», puis les variations sur le sujet du prix, du nombre de jambes et des minuteries. Si le STMshcher est plus avancé, il y aura certainement une indication qu'il n'y a pas de DMA dans l'AVR et ne le fera pas, donc l'AVR devrait mourir. Pourquoi un simple DMA blink-voltmètre-thermomètre, une montagne de minuteries 16 bits, 100 jambes et un ADC 12 bits, personne ne l'explique généralement. Pourquoi avons-nous besoin d'une telle moissonneuse dans un appareil que Tiny13 peut facilement retirer, qui en même temps n'est pas chargé, même sur un tiers de ses ressources, personne ne comprendra. Il vous suffit de passer à STM32, et c'est tout. Pour ici.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et je dois dire que les gens ont soif de nouveauté. Mais vraiment, je peux essayer? Et si vous l'aimez? Voici juste le manuel de référence de la populaire STM32F103C8T6, sur laquelle est basée la tablette bleue la plus massive de 1126 pages. D'une certaine manière, elle n'a pas vraiment de «démarrage rapide». Même un utilitaire séparé, tellement détesté par les anciens «kalokub», et qui doit être étudié, quoi de neuf. Oui, et après avoir plongé dans Cube, il est peu probable que cela commence dans 5 minutes, la nappe générée par lui n'est pas la lecture la plus accessible pour la nuit, c'est juste pour entrer dans le front, dont tout le monde ne peut pas parler là-bas.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De nombreux articles, similaires à celui-ci, sur le démarrage rapide et facile dans la STM méritent une discussion séparée. Pour tous ces articles, au début, j'étais très confus par une circonstance. Nulle part il n'y a une explication détaillée de ce que nous écrivons ici. Un tas de captures d'écran sur la façon de créer un projet, puis immédiatement un mur de code, faites-le comme ça! Et qu'y a-t-il, pourquoi est-ce, pourquoi est-il ainsi, où trouver tous ces mots apparemment compréhensibles, personne n'y plonge, car les forces se sont épuisées lors de la rédaction d'un manuel sur l'installation de Cale et de Cuba, et sur le lancement du projet. Ce n'est qu'après un certain temps, individuel pour chacun, que la compréhension de ce qui se passe et pourquoi vient. À mon tour, je propose une façon de commencer non pas depuis le début, comme tout le monde, mais depuis la fin. Maintenant, nous allons faire le contraire, ne pas configurer le contrôleur, écrire du code et le débuter, mais procéder immédiatement au débogage,et enregistrer nos actions sous forme de code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous installons donc Keil en tant qu'environnement gratuit (jusqu'à 32 Ko de code). Nous ne décrirons pas cette action, celle-ci est sur Internet, et l'installateur étape par étape doit être maîtrisé par la personne qui se rend à la STM. Nous commençons le projet: Project-New uVision Project, créons un dossier et un fichier de projet. La fenêtre de sélection du contrôleur s'ouvre, entrez 103C8 dans la recherche et acceptez le seul modèle sélectionné. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous arrivons à la fenêtre de sélection de la bibliothèque:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4v/ox/yf/4voxyfdppukch2gamrnsguvzbfk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous mettons trois daws: CMSIS-CORE, Device-Startup et Device-GPIO. Cet ensemble est assez suffisant pour faire rebondir une jambe, allumant la LED. Ensuite, vous devez encore configurer, vous ne pouvez rien obtenir de cela. Alt + F7 lance la fenêtre de paramètres située Project-Options for Target, où dans l'onglet "Output" vous devez cocher la case "Create HEX-File" pour créer un fichier de firmware que nous téléchargerons sur le contrôleur. Ensuite, dans l'onglet «Débogage», nous sélectionnons ST-Link, qui, en fait, chargera le micrologiciel et débutera: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kd/uw/6l/kduw6ltbrav_uadgbbrp93w5oke.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
par le bouton «Réglage» à côté de la fenêtre de sélection du programmeur, nous arrivons à la fenêtre «Configuration du pilote cible Cortex-M», où dans le « Télécharger Flash "mettre un daw" Reset and Run ".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'arborescence du projet, faites un clic droit sur le dossier «Source Group 1», dans l'assistant qui s'ouvre, créez le fichier main.c, dans lequel nous allons bientôt écrire le code. Dans le main.c ouvert, cliquez avec le bouton droit sur la première et la plus importante inclusion: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qc/zp/ju/qczpjupur2s0vqx-reffsuzy5qo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez le code composé de principal et sans fin tout en:</font></font><br>
<br>
<pre><code class="plaintext hljs">#include "stm32f10x.h"                  // Device header<font></font>
int main(){<font></font>
	while(1){<font></font>
	}<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Curieusement, c'est tout pour l'instant, c'est un programme prêt à l'emploi et compréhensible qui se compile et se charge correctement dans le contrôleur. Nous appuyons sur F7 et nous voyons que le firmware a été assemblé avec succès, il n'y a pas d'erreurs ou d'avertissements. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4b/bs/d3/4bbsd3ca51m6nmrx4gon6a_rwyw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À partir de ce moment, le contrôleur nous est entièrement accessible, nous pouvons le saisir sous la ligne de débogage et le tordre dans toutes les directions, et il répondra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les touches Ctrl + F5 nous conduisent au débogage, et le bouton «System Viewer Windows» vous permet de lancer les fenêtres pour contrôler les registres de registres et contrôler les jambes du GPIO. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1e/ri/u1/1eriu1hhnribtydyhsaq-i36lr4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, je vous suggère d'utiliser toujours le Manuel de référence, d'autant plus que vous n'avez même pas besoin de le télécharger, il est disponible en cliquant dans l'onglet «Livres» du menu «Affichage»:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fx/4j/hm/fx4jhmgymzqzczhfcqto1wusr2m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, je propose d'utiliser le raisonnement suivant. Du brochage sur la tablette bleue, on peut voir que la LED se bloque sur la jambe du port 13. De nombreuses ressources Internet et discussions mentionnent toujours qu'avant de faire quelque chose dans STM, vous devez activer quelque chose, sinon, régler l'horloge. Sans plus tarder, nous écrivons dans le champ de recherche du lecteur pdf ce dont nous avons besoin, à savoir, activer le port C: «PORT C CLOCK ENABLE». Nous </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qf/lh/vs/qflhvsoyc3fhyds54-clxwq0eqo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
entrons </font><font style="vertical-align: inherit;">dans l'image suivante: </font><font style="vertical-align: inherit;">De cela, nous pouvons conclure que la synchronisation du port C est activée dans le registre IOPCEN. Avec ces connaissances, nous allons dans l'onglet RCC en mode débogage et saisissons ce nom dans la barre de recherche: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z0/x4/3q/z0x43qbnbga_-q0voxoajotxuqs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cochez la case requise avec une coche, et à partir de ce moment, nous considérons le port C activé.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, en se souvenant de l'AVR qui souffre depuis longtemps, nous allons chercher le réglage de la broche réelle. Pour que cela fonctionne, il est nécessaire d'expliquer ce que nous attendons exactement d'elle. Et nous voulons sauter avec le pied numéro 13 du port C, pour cela, nous devons définir le mode de son fonctionnement. Dans la barre de recherche du manuel de référence, nous conduisons dans «Configuration de bit de port», qui exprime notre désir de lire où les paramètres de jambe sont cachés. La recherche nous amène à un tableau dont il résulte que pour attribuer une jambe comme sortie, il est nécessaire de configurer les registres MODE et CNF: A </font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/c4/ot/odc4oti0osjwy9qvuax79slsqv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
partir du tableau n ° 20 il est clair que pour affecter une jambe comme sortie Push-Pull, il faut réinitialiser les registres CNF0 et CNF1, et l'état de la paire MODE0 et MODE1 sont décrits dans le tableau n ° 21, je choisirai l'option supérieure, jusqu'à 10MHz, MODE0 = 1, MODE1 = 0. C'est ce que je vais faire dans la fenêtre GPIOC pour les registres CNF13 et MODE13</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-n/x5/y3/-nx5y33grvntsdchwf7emhxlgnc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons maintenant configuré l'horloge et le mode de fonctionnement du port. Il est temps de savoir exactement comment sauter une jambe. En anglais, définissez le bit de port est écrit comme "Port bit set", et nous chercherons cette phrase dans le manuel: La </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nw/l8/r2/nwl8r2ne5djl9o3hmpwxg2eigg0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
recherche nous amène à une page avec un tableau, qui montre clairement que le registre BSRR, composé de paires BS et BR, est responsable de la définition de l'état de la jambe de port , Bit set et Bit reset, respectivement. Nous trouvons ces registres dans la fenêtre GPIOC en mode débogage et profitons du contrôle de la jambe numéro 13 directement en poussant des choucas avec la souris dans les cases à cocher correspondantes:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ob/vj/c3/obvjc3gnvzem1sh6tecfly7quyk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une LED sur le panneau de pilules bleu se bloque entre la jambe et le VCC, le contrôlant ainsi de nouveau au nom du registre. Le Bit Set (registre BS13) l'éteint et le Bit Reset (registre BR13) l'allume. Ce sont des registres d'opérations atomiques, ils sont réinitialisés après avoir coché la case. Il est possible de contrôler le pied via le registre ODR (clause 9.2.4 Registre des données de sortie du port (GPIOx_ODR) dans le manuel de référence), il montre clairement à quoi mène l'installation et la réinitialisation du choucas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nv/rd/ou/nvrdouc1ano_fn8gdpdplk2v5rq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une LED verte et verte qui s'éteint indique que tout fonctionne correctement. Il ne reste plus qu'à écrire tout cela sous forme de code dans le main.c. C'est là qu'apparaissent les raisins mêmes qui distinguent cette méthode de compréhension du contrôleur STM par le débogage des autres, dont Internet tout entier est jonché. Je suggère simplement de réécrire ce que nous voyons dans la fenêtre de débogage en code. Exemple:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/f9/ww/kqf9wwqdt2ydqoz9ovv1f9k2xt0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Définissez le mode de fonctionnement du port et activez la synchronisation; </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/a-/fk/iua-fkaw0im1tjbpxqm4kwpruio.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont allumé le pied bâbord, ont attendu, l'ont éteint, etc.:</font></font><br>
<br>
<pre><code class="plaintext hljs">#include "stm32f10x.h"                  // Device header<font></font>
<font></font>
int main(){<font></font>
	RCC-&gt;APB2ENR=0x00000010;			//  <font></font>
	GPIOC-&gt;CRH=0x44144444;			//   Push-Pull  10MHz<font></font>
	int i;								//     / <font></font>
	while(1){<font></font>
		GPIOC-&gt;ODR=0x00002000;		//  LED,      <font></font>
		i=2000000;					//    <font></font>
		while (i) i--;					// <font></font>
		GPIOC-&gt;ODR=0x00000000;		//  LED<font></font>
		i=2000000;					//  <font></font>
		while (i) i--;					<font></font>
	}<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, cette méthode est loin d'être la meilleure et n'est pas correcte, mais à mon avis la plus compréhensible et la plus simple. De plus, il s'initie au travail avec une fiche technique (manuel de référence) et ne lui fait pas peur, comme la lecture de mana et l'écriture de footcloths multi-pages de code pour Blink. Oui, il n'y a pas de couches d'abstractions, beaucoup a été manqué, mais je pense que vous pouvez pardonner cela pour le début élémentaire. Lire le mana et travailler correctement avec les registres est alors, maintenant la LED clignote et nous comprenons essentiellement comment et ce que nous avons fait, et surtout, d'où viennent toutes ces abréviations. Si on m'avait montré cette façon d'étudier la STM auparavant, je n'aurais peut-être pas collecté plus de 9000 programmeurs différents pour AVR dans lesquels il n'y avait pas de débogage, mais j'aurais tout de suite repris le Cortex. En effet, dans AVR il n'y a pas de débogage intelligible et accessible, mais de toute façon, il est trop tôt pour oublier Tiny13. Elle sort ses tâches.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr488368/index.html">Ce que j'ai appris en travaillant sur mon premier projet à grande échelle</a></li>
<li><a href="../fr488370/index.html">TDD pour microcontrôleurs. Partie 2: Comment les espions se débarrassent des dépendances</a></li>
<li><a href="../fr488374/index.html">Télégramme + 1C + Webhooks + Apache + Certificat auto-signé</a></li>
<li><a href="../fr488376/index.html">Quand le principe "au diable tout, prenez-le et faites-le!" ne fonctionne pas: notes du procrastinateur</a></li>
<li><a href="../fr488378/index.html">En bref sur la dénomination dans JS</a></li>
<li><a href="../fr488382/index.html">J'ajoute un délai de 3 à 25 secondes aux sites que je visite</a></li>
<li><a href="../fr488386/index.html">Cas d'application des outils d'analyse d'anomalies de réseau: attaques via des plug-ins de navigateur</a></li>
<li><a href="../fr488388/index.html">Reconnexion et authentification HTTP de base</a></li>
<li><a href="../fr488390/index.html">Comment se faire des amis de Telegram Bot avec OpenId Connect</a></li>
<li><a href="../fr488392/index.html">Images prêtes pour la production pour k8s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>