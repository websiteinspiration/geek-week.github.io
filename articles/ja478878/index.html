<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤶🏾 👨🏻‍✈️ 👩‍❤️‍💋‍👨 StackOverflowの歴史の中で最も人気のあるコードにはバグがあります。  👨🏽‍💼 🕘 👩🏼‍💻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近の調査「GitHubプロジェクトでのStack Overflowコードスニペットの使用と原因の特定」では、ほとんどの場合、オープンソースプロジェクトでの私の回答がほぼ10年前に書かれていることがわかりました。皮肉なことに、バグがあります。
 
 昔…
 2010年に、私は自分のオフィスに座ってナ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>StackOverflowの歴史の中で最も人気のあるコードにはバグがあります。 </h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478878/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最近の調査</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「GitHubプロジェクトでのStack Overflowコードスニペットの使用と原因の特定」では</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ほとんどの場合、オープンソースプロジェクトでの私の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">回答</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がほぼ10年前に書かれて</font><font style="vertical-align: inherit;">いる</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">こと</font></a><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">わかりました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">皮肉なことに、バグがあります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">昔…</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2010年に、私は自分のオフィスに座ってナンセンス</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でした。コードゴルフ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">好きで</font></a><font style="vertical-align: inherit;">、スタックオーバーフローに評価を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">追加しました</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の質問が私の注意を引きました：読み取り可能な形式でバイト数を表示する方法は？</font><font style="vertical-align: inherit;">つまり、123456789バイトなどを「123.5 MB」に変換する方法です。</font><i><font color="gray"><font style="vertical-align: inherit;">2010年の古き良きインターフェース、Wayback Machineに感謝</font></font></i></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><img src="https://habrastorage.org/getpro/habr/post_images/7ca/00b/1f7/7ca00b1f7d4f57f0f8afa4ed9554797a.png"></a><br>
<i><font color="gray"><font style="vertical-align: inherit;"></font></font></i> <br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
暗黙的に、結果は適切な単位で1から999.9の間の数値になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ループに関する答えはすでに1つありました。</font><font style="vertical-align: inherit;">アイデアは単純です。最大単位（EB = 10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">18</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;バイト）から最小単位（B = 1バイト）</font><font style="vertical-align: inherit;">までのすべての度数をチェックし</font><font style="vertical-align: inherit;">、最初のバイト数よりも少ない数を適用します。</font><font style="vertical-align: inherit;">疑似コードでは、次のようになります。</font></font><br>
<br>
<pre><code class="plaintext hljs">suffixes   = [ "EB", "PB", "TB", "GB", "MB", "kB", "B" ]<font></font>
magnitudes = [ 10^18, 10^15, 10^12, 10^9, 10^6, 10^3, 10^0 ]<font></font>
i = 0<font></font>
while (i &lt; magnitudes.length &amp;&amp; magnitudes[i] &gt; byteCount)<font></font>
    i++<font></font>
printf("%.1f %s", byteCount / magnitudes[i], suffixes[i])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、正の評価の正解では、追いつくのは困難です。</font><font style="vertical-align: inherit;">スタックオーバーフローの専門用語では、これは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">西部最速のシューティングゲームの問題</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれてい</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">しかし、ここでは答えにいくつかの欠陥があったので、それを超えたいと思っていました。</font><font style="vertical-align: inherit;">少なくとも、ループのあるコードは大幅に削減できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まあ、これは代数です、すべてが簡単です！</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それからそれは私に夜明けしました。</font><font style="vertical-align: inherit;">プレフィックスはキロ、メガ、ギガ、...-1000度（またはIEC規格では1024）以下であるため、正しいプレフィックスはサイクルではなく対数を使用して決定できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この考えに基づいて、私は以下を公開しました：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">humanReadableByteCount</span><span class="hljs-params">(<span class="hljs-keyword">long</span> bytes, <span class="hljs-keyword">boolean</span> si)</span> </span>{
    <span class="hljs-keyword">int</span> unit = si ? <span class="hljs-number">1000</span> : <span class="hljs-number">1024</span>;
    <span class="hljs-keyword">if</span> (bytes &lt; unit) <span class="hljs-keyword">return</span> bytes + <span class="hljs-string">" B"</span>;
    <span class="hljs-keyword">int</span> exp = (<span class="hljs-keyword">int</span>) (Math.log(bytes) / Math.log(unit));<font></font>
    String pre = (si ? <span class="hljs-string">"kMGTPE"</span> : <span class="hljs-string">"KMGTPE"</span>).charAt(exp-<span class="hljs-number">1</span>) + (si ? <span class="hljs-string">""</span> : <span class="hljs-string">"i"</span>);
    <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1f %sB"</span>, bytes / Math.pow(unit, exp), pre);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、これはあまり読みやすくありません。log/ powは他のオプションよりも効率が劣ります。</font><font style="vertical-align: inherit;">しかし、ループがなく、分岐もほとんどないので、結果はかなり美しいと思います。</font></font><br>
<br>
<blockquote><b>  </b>.     byteCount = 1000<sup>s</sup>,  <i>s</i>   (    1024.)  <i>s</i>  <i>s</i>&nbsp;= log<sub>1000</sub>(byteCount).<br>
<br>
 API    log<sub>1000</sub>,            s&nbsp;= log(byteCount)&nbsp;/ log(1000).   <i>s</i>  int,     , ,    (   ),        .<br>
<br>
,   <i>s</i>&nbsp;= 1,    ,  <i>s</i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;= 2-メガバイトなど。</font><font style="vertical-align: inherit;">byteCountを1000 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">秒で</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">割り</font><font style="vertical-align: inherit;">、対応する文字をプレフィックスに平手打ちします。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残ったのは、コミュニティが答えをどのように認識しているかを確認することだけでした。</font><font style="vertical-align: inherit;">このコードがスタックオーバーフローの履歴で最も複製されるとは思えませんでした。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帰属調査</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2018年に早送りします。</font><font style="vertical-align: inherit;">大学院生のSebastian Baltesが科学ジャーナル</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empirical Software Engineeringに</font></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「GitHubプロジェクトでのStack Overflowコードスニペットの使用と帰属」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">というタイトルの記事</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">を公​​開しています</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">彼の研究のトピックは、Stack Overflow CC BY-SA 3.0ライセンスがどの程度尊重されているか、つまり、著者がStack Overflowリンクをコードのソースとして指し示しているかどうかです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分析のために</font><font style="vertical-align: inherit;">、コードのスニペットが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタックオーバーフローダンプ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から</font><font style="vertical-align: inherit;">抽出され、パブリックGitHubリポジトリのコードにマッピングされました。</font><font style="vertical-align: inherit;">要約からの引用：</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パブリックGitHub（GH）プロジェクトでのSO回答からのJavaコードの重要なフラグメントの使用と属性を分析する大規模な実証的研究の結果を提示します。</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（ネタバレ：いいえ、ほとんどのプログラマーはライセンス要件に準拠していません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事の表は次のとおりです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d_/jb/az/d_jbazgu5cmhwyw__yxdxkzdhwy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この回答が一番上</font><font style="vertical-align: inherit;">にある</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3758880</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、</font><font style="vertical-align: inherit;">8年前に私が発表したまさにその回答であることが</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">わかり</font></a><font style="vertical-align: inherit;">ました</font><font style="vertical-align: inherit;">。現在、彼は10万以上のビューと1000以上のプラスを持っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitHubでのクイック検索では、実際に何千ものコードリポジトリが生成されます</font></font><code>humanReadableByteCount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c4c/3de/bc6/c4c3debc6c290c209b90c2dca5be46ab.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リポジトリでこのフラグメントを検索します。</font></font><br>
<br>
<pre><code class="bash hljs">$ git grep humanReadableByteCount</code></pre><br>
<blockquote><b> </b>,      .<br>
<br>
     OpenJDK  - ,   OpenJDK    CC BY-SA 3.0.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow">  jdk9-dev</a>  :   Stack Overflow   OpenJDK  ?<br>
<br>
  ,       Oracle,   OpenJDK,        :<br>
<br>
<i>,<br>
<br>
          SO (aioobe)?    OpenJDK    Oracle,        OpenJDK.</i> <br>
<br>
Oracle      .  ,      ,       «».<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、状況を明確にするためにセバスチャンから手紙が届いたので、私はそうしました。このコードは</font><font style="vertical-align: inherit;">、Oracleに到着する</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でも追加されて</font><font style="vertical-align: inherit;">おり、コミットする関係があり</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ません</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">オラクルで冗談を言ってはいけない。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チケットが開か</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">た</font></a><font style="vertical-align: inherit;">数日後</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">に、</font></a><font style="vertical-align: inherit;">このコード</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は削除されました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バグ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はあなたがすでにそれについて考えたに違いない。</font><font style="vertical-align: inherit;">コードのどのようなエラーですか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再び：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">humanReadableByteCount</span><span class="hljs-params">(<span class="hljs-keyword">long</span> bytes, <span class="hljs-keyword">boolean</span> si)</span> </span>{
    <span class="hljs-keyword">int</span> unit = si ? <span class="hljs-number">1000</span> : <span class="hljs-number">1024</span>;
    <span class="hljs-keyword">if</span> (bytes &lt; unit) <span class="hljs-keyword">return</span> bytes + <span class="hljs-string">" B"</span>;
    <span class="hljs-keyword">int</span> exp = (<span class="hljs-keyword">int</span>) (Math.log(bytes) / Math.log(unit));<font></font>
    String pre = (si ? <span class="hljs-string">"kMGTPE"</span> : <span class="hljs-string">"KMGTPE"</span>).charAt(exp-<span class="hljs-number">1</span>) + (si ? <span class="hljs-string">""</span> : <span class="hljs-string">"i"</span>);
    <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1f %sB"</span>, bytes / Math.pow(unit, exp), pre);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どんなオプション？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エクサバイト（10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">18</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">後</font><font style="vertical-align: inherit;">はゼタバイト（10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）です。</font><font style="vertical-align: inherit;">多分本当に大きな数はkMGTPEを超えますか？</font><font style="vertical-align: inherit;">番号。</font><font style="vertical-align: inherit;">最大値は2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">63</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1≈9.2×10 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">18</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">であるため、エクサバイトを超える値はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多分SIユニットとバイナリシステムの間の混乱？</font><font style="vertical-align: inherit;">番号。</font><font style="vertical-align: inherit;">回答の最初のバージョンには混乱がありましたが、すぐに修正されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たぶんexpはゼロになってしまい、charAt（exp-1）がクラッシュしますか？</font><font style="vertical-align: inherit;">いいえ。</font><font style="vertical-align: inherit;">最初のifステートメントはこのケースをカバーしています。</font><font style="vertical-align: inherit;">exp値は常に少なくとも1 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
になります。出力に奇妙な丸め誤差があるのではないでしょうか。</font><font style="vertical-align: inherit;">さて、ようやく...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くのナイン</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソリューションは、1 MBに近づくまで機能します。入力として999,999バイトが指定されている場合、結果（SIモードの場合）はになり</font></font><code>"1000,0 kB"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。 999,999は</font><font style="vertical-align: inherit;">999.9×1000 </font><sup><font style="vertical-align: inherit;">1</font></sup><font style="vertical-align: inherit;">よりも</font><font style="vertical-align: inherit;">1000×1000 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1に</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">近いですが、1000 </font><font style="vertical-align: inherit;">という記号は仕様で禁止されています。正しい結果は</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">
私の弁護では、執筆時点では、Apache CommonsやAndroidライブラリを含む22件の公開されたすべての回答にそのようなエラーがあったと言えます。</font><font style="vertical-align: inherit;">
それを修正するには？まず、バイト数が</font><font style="vertical-align: inherit;">999.9×1000 </font><sup><font style="vertical-align: inherit;">1</font></sup><font style="vertical-align: inherit;">ではなく</font><font style="vertical-align: inherit;">1×1,000 </font><sup><font style="vertical-align: inherit;">2</font></sup><font style="vertical-align: inherit;">（1 MB）に</font><font style="vertical-align: inherit;">近づくとすぐに、指数（exp）が「k」から「M」に変わることに注意してください。</font></font><sup><font style="vertical-align: inherit;"></font></sup><font style="vertical-align: inherit;"></font><code>"1.0 MB"</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><sup><font style="vertical-align: inherit;"></font></sup><font style="vertical-align: inherit;"></font><sup><font style="vertical-align: inherit;"></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（999.9 k）。</font><font style="vertical-align: inherit;">これは999,950で発生します。同様に、999,950,000を通過するときに「M」から「G」に切り替える必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このしきい値を計算し</font></font><code>exp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>bytes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに多い</font><font style="vertical-align: inherit;">場合は</font><font style="vertical-align: inherit;">増やし</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">if</span> (bytes &gt;= Math.pow(unit, exp) * (unit - <span class="hljs-number">0.05</span>))<font></font>
    exp++;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この変更により、バイト数が1 EBに近づくまで、コードは適切に機能します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もっとナイン</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
999 949 999 999 999 999 999を計算するとき、コード</font></font><code>1000.0 PB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は正しい結果を</font><font style="vertical-align: inherit;">生成</font><font style="vertical-align: inherit;">します</font></font><code>999.9 PB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">数学的には、コードは正確なので、ここで何が起こりますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今、私たちは限界に直面してい</font></font><code>double</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<blockquote><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">浮動小数点演算の概要</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IEEE 754仕様によれば、ゼロに近い浮動小数点値は非常に密な表現を持ち、大きい値は非常にまばらな表現を持っています。</font><font style="vertical-align: inherit;">実際、すべての値の半分は-1から1の間であり、大きな数になると、サイズの値は</font></font><code>Long.MAX_VALUE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何も意味しません。</font><font style="vertical-align: inherit;">文字通り。</font></font><br>
<br>
<pre><code class="plaintext hljs">double l1 = Double.MAX_VALUE;<font></font>
double l2 = l1 - Long.MAX_VALUE;<font></font>
System.err.println(l1 == l2);  // prints true</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「浮動小数点ビット」を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題は2つの計算で表されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">議論の分裂</font></font><code>String.format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構築のしきい値 </font></font><code>exp</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
に切り替えることができますが</font></font><code>BigDecimal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、退屈です。</font><font style="vertical-align: inherit;">さらに、標準APIにはの対数がないため、ここでも問題が発生します</font></font><code>BigDecimal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中間値を下げる</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の問題を解決するために、</font></font><code>bytes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">精度を向上させる目的の範囲に</font><font style="vertical-align: inherit;">値</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">減らし、</font><font style="vertical-align: inherit;">それに応じて調整でき</font></font><code>exp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">いずれの場合も、最終結果は丸められるため、最下位のカテゴリを除外しても問題ありません。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">if</span> (exp &gt; <span class="hljs-number">4</span>) {<font></font>
    bytes /= unit;<font></font>
    exp--;<font></font>
}</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最下位ビットの設定</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目の問題を解決するには、</font><font style="vertical-align: inherit;">最下位ビット</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が重要</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です（99994999 ... 9と99995000 ... 0は異なる次数でなければなりません）。そのため、別のソリューションを見つける必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、12の異なるしきい値（各モードに6つ）があり、そのうちの1つだけがエラーにつながることに注意してください。</font><font style="vertical-align: inherit;">不正な結果はD00 </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で終わるため、一意に識別できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">直接修正できます。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">long</span> th = (<span class="hljs-keyword">long</span>) (Math.pow(unit, exp) * (unit - <span class="hljs-number">0.05</span>));
<span class="hljs-keyword">if</span> (exp &lt; <span class="hljs-number">6</span> &amp;&amp; bytes &gt;= th - ((th &amp; <span class="hljs-number">0xFFF</span>) == <span class="hljs-number">0xD00</span> ? <span class="hljs-number">52</span> : <span class="hljs-number">0</span>))<font></font>
    exp++;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
浮動小数点結果の特定のビットパターンに依存しているため、strictfp修飾子を使用して、コードがハードウェアとは独立して機能するようにします。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">負の入力値</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どのような状況で負のバイト数が意味をなすかは明確ではありませんが、Javaには署名されていないため</font></font><code>long</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、このオプションを処理することをお勧めします。</font><font style="vertical-align: inherit;">現在、-10,000のような入力はを生成し</font></font><code>-10000 B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
書き込み</font></font><code>absBytes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">long</span> absBytes = bytes == Long.MIN_VALUE ? Long.MAX_VALUE : Math.abs(bytes);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
式はので、とても冗長です</font></font><code>-Long.MIN_VALUE == Long.MIN_VALUE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">今度は</font><font style="vertical-align: inherit;">代わりに</font></font><code>exp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">してすべての計算</font><font style="vertical-align: inherit;">を行い</font></font><code>absBytes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font><code>bytes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終版</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、元のバージョンの精神に基づいて短縮および圧縮されたコードの最終バージョンです。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-comment">// From: https://programming.guide/the-worlds-most-copied-so-snippet.html</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">strictfp</span> String <span class="hljs-title">humanReadableByteCount</span><span class="hljs-params">(<span class="hljs-keyword">long</span> bytes, <span class="hljs-keyword">boolean</span> si)</span> </span>{
    <span class="hljs-keyword">int</span> unit = si ? <span class="hljs-number">1000</span> : <span class="hljs-number">1024</span>;
    <span class="hljs-keyword">long</span> absBytes = bytes == Long.MIN_VALUE ? Long.MAX_VALUE : Math.abs(bytes);
    <span class="hljs-keyword">if</span> (absBytes &lt; unit) <span class="hljs-keyword">return</span> bytes + <span class="hljs-string">" B"</span>;
    <span class="hljs-keyword">int</span> exp = (<span class="hljs-keyword">int</span>) (Math.log(absBytes) / Math.log(unit));
    <span class="hljs-keyword">long</span> th = (<span class="hljs-keyword">long</span>) (Math.pow(unit, exp) * (unit - <span class="hljs-number">0.05</span>));
    <span class="hljs-keyword">if</span> (exp &lt; <span class="hljs-number">6</span> &amp;&amp; absBytes &gt;= th - ((th &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0xd00</span> ? <span class="hljs-number">52</span> : <span class="hljs-number">0</span>)) exp++;<font></font>
    String pre = (si ? <span class="hljs-string">"kMGTPE"</span> : <span class="hljs-string">"KMGTPE"</span>).charAt(exp - <span class="hljs-number">1</span>) + (si ? <span class="hljs-string">""</span> : <span class="hljs-string">"i"</span>);
    <span class="hljs-keyword">if</span> (exp &gt; <span class="hljs-number">4</span>) {<font></font>
        bytes /= unit;<font></font>
        exp -= <span class="hljs-number">1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1f %sB"</span>, bytes / Math.pow(unit, exp), pre);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、ループや過度の分岐を回避するための試みとして始まったことに注意してください。</font><font style="vertical-align: inherit;">しかし、すべての境界線状況を平滑化した後、コードは元のバージョンよりもさらに読みにくくなりました。</font><font style="vertical-align: inherit;">個人的には、このフラグメントを本番環境でコピーすることはしません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロダクション品質の更新バージョンについては、別の記事</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「読み取り可能なフォーマットでのバイトサイズのフォーマット」を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主な調査結果</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何千ものプラスがある場合でも、Stack Overflowへの回答にエラーがある可能性があります。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特に</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタックオーバーフローを使用するコードでは</font><font style="vertical-align: inherit;">、すべての境界ケースを確認してください</font><font style="vertical-align: inherit;">。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">浮動小数点演算は複雑です。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードをコピーするときは、必ず正しい属性を含めてください。</font><font style="vertical-align: inherit;">誰かがあなたをきれいな水に連れて行くかもしれません。</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478858/index.html">XHProf Adminでのプロファイリングセッションの比較</a></li>
<li><a href="../ja478862/index.html">Yandex.Marketでのフロントエンドテストの仕組みと、毎週のリリースを拒否する理由</a></li>
<li><a href="../ja478866/index.html">Meet Space-JetBrainsの新製品</a></li>
<li><a href="../ja478872/index.html">DIY：倉庫監視を自動化する方法</a></li>
<li><a href="../ja478874/index.html">東芝は最大6 TBの容量を持つ2つの新しいHDDラインを発表し、2020年以来企業セグメントに焦点を当てていることを発表しました</a></li>
<li><a href="../ja478880/index.html">2019年後半に雇用主がITスペシャリストに提供した給与</a></li>
<li><a href="../ja478884/index.html">2020年にサイトでRTSPを準備する方法、またはイノシシが逃げる時間がない理由</a></li>
<li><a href="../ja478886/index.html">インラインコンテンツを含む角度コンポーネント</a></li>
<li><a href="../ja478888/index.html">モジュラーCSSとコードサポートの問題に関するいくつかの考え</a></li>
<li><a href="../ja478890/index.html">私の小包はどこにありますか？AIは配信タスクを容易にします</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>