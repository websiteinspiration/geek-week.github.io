<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõéÔ∏è üë©üèΩ‚Äçüîß üèñÔ∏è Custom script when closing the lid of the laptop and locking the screen without sleep ü•© üåé üë©üèæ‚Äçü§ù‚Äçüë®üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. I use Lubuntu 18.04 on my home laptop. One fine day, I decided that I was not happy with the actions that Power Manager offers when cl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Custom script when closing the lid of the laptop and locking the screen without sleep</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491486/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font><font style="vertical-align: inherit;">I use Lubuntu 18.04 on my home laptop. </font><font style="vertical-align: inherit;">One fine day, I decided that I was not happy with the actions that Power Manager offers when closing the lid of a laptop. </font><font style="vertical-align: inherit;">When I closed the lid of the laptop, I wanted to block the screen and after a while send the laptop to hibernation. </font><font style="vertical-align: inherit;">To do this, I wrote a script and I hasten to share it with you.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I ran into two problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first is that hibernation does not work in the loubunt out of the box; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Find the UUID swap, for this you need to do:</font></font><br>
<br>
<pre><code class="bash hljs">grep swap /etc/fstab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my case, the output is as follows:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># swap was on /dev/mmcblk0p2 during installation</span><font></font>
UUID=aebf757e-14c0-410a-b042-3d9a6044a987 none            swap    sw              0       0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then you need to add the UUID to the kernel initialization parameters. </font><font style="vertical-align: inherit;">To do this, add in the file / etc / default / grub to the line "GRUB_CMDLINE_LINUX_DEFAULT" resume = UUID =% your UUID%</font></font><br>
<br>
<pre><code class="bash hljs">...<font></font>
GRUB_CMDLINE_LINUX_DEFAULT=<span class="hljs-string">"quiet splash resume=UUID=aebf757e-14c0-410a-b042-3d9a6044a987"</span>
...</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And execute the command:</font></font><br>
<br>
<pre><code class="bash hljs">sudo update-grub</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now hibernation should work, for verification you can do:</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl hibernate</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second problem was how to lock the user‚Äôs screen from root without sending the laptop to sleep. </font><font style="vertical-align: inherit;">I solved it using dbus-send, the command itself is in the script below. </font><font style="vertical-align: inherit;">If someone knows other options, please write in the comments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's start writing the script. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing we need to do in Power Manager is select Switch off display as the action when closing the lid so that there are no conflicts with our script. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ve/vx/3i/vevx3ieyswyr8g0h80rpz5lxpuy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then create the file / etc / acpi / events / laptop-lid with the following contents:</font></font><br>
<br>
<pre><code class="plaintext hljs">event=button/lid.*<font></font>
action=/etc/acpi/laptop-lid.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and create the script /etc/acpi/laptop-lid.sh with the following contents:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#set variables</span>
<span class="hljs-comment"># BUS   environ   lxsession</span><font></font>
BUS=$(grep -z DBUS_SESSION_BUS_ADDRESS \<font></font>
	/proc/$(pidof -s lxsession)/environ | \<font></font>
	sed <span class="hljs-string">'s/DBUS_SESSION_BUS_ADDRESS=//g'</span>)
<span class="hljs-comment">#     ,    </span>
USER=$(grep -z USER /proc/$(pidof -s lxsession)/environ | sed <span class="hljs-string">'s/USER=//g'</span>)
<span class="hljs-comment">#     </span>
LID=<span class="hljs-string">"/proc/acpi/button/lid/LID0/state"</span><font></font>
<font></font>
<span class="hljs-comment">#Check lid state (return 0 if closed)</span>
<span class="hljs-function"><span class="hljs-title">check_lid</span></span> () {<font></font>
	grep -q closed <span class="hljs-variable">$LID</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">#Lock screen without sleep</span><font></font>
check_lid<font></font>
<span class="hljs-keyword">if</span> [ $? = 0 ]
<span class="hljs-keyword">then</span>
	<span class="hljs-comment">#TODO run command as root</span>
	sudo -u <span class="hljs-variable">$USER</span> -E dbus-send --bus=<span class="hljs-variable">$BUS</span> \<font></font>
				    --<span class="hljs-built_in">type</span>=method_call \<font></font>
				    --dest=<span class="hljs-string">"org.freedesktop.ScreenSaver"</span> \
				    <span class="hljs-string">"/org/freedesktop/ScreenSaver"</span> \<font></font>
				    org.freedesktop.ScreenSaver.Lock<font></font>
<span class="hljs-keyword">fi</span><font></font>
<font></font>
<span class="hljs-comment">#Wait 10 minutes and hibernate if lid is closed</span><font></font>
sleep 600<font></font>
check_lid<font></font>
<span class="hljs-keyword">if</span> [ $? = 0 ]
<span class="hljs-keyword">then</span><font></font>
	systemctl hibernate<font></font>
<span class="hljs-keyword">fi</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We make the script executable:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod a+x /etc/acpi/laptop-lid.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And restart the acpid daemon so that the changes apply:</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl restart acpid.service</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is ready. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For Gnome in the script you need to change:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lxsessin =&gt; gnome-session </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">org.freedesktop.ScreenSaver =&gt; org.gnome.ScreenSaver </font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491476/index.html">MEMS accelerometers, magnetometers and orientation angles</a></li>
<li><a href="../en491478/index.html">A new implant for the blind connects directly to the brain</a></li>
<li><a href="../en491480/index.html">CoVirus MVP project - an online map of coronavirus infection or a ‚Äúred button" in your hand</a></li>
<li><a href="../en491482/index.html">Introducing PowerShell 7.0</a></li>
<li><a href="../en491484/index.html">Stas Afanasyev. Juno. Pipelines based on io.Reader / io.Writer. Part 1</a></li>
<li><a href="../en491488/index.html">What does it mean to be Agile?</a></li>
<li><a href="../en491490/index.html">How does Gitlab-CI inherit environment variables?</a></li>
<li><a href="../en491494/index.html">The grandiose scam of Soviet science: why a reusable orbital ship turned out to be one-time</a></li>
<li><a href="../en491496/index.html">IntelliJ IDEA Tips & Tricks: 1. Comparing Files and Folders</a></li>
<li><a href="../en491498/index.html">How a project manager to choose a job</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>