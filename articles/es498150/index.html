<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèº‚Äçü§ù‚Äçüßëüèº üöµüèª üêù Programadores de fontaneros, o la historia de una fuga y las dificultades de lidiar con ella üêá ü§™ üè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Era martes 25 de febrero. El dif√≠cil lanzamiento de la versi√≥n el s√°bado 22 de febrero ya estaba en el pasado. Parec√≠a que todo lo peor estaba atr√°s, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Programadores de fontaneros, o la historia de una fuga y las dificultades de lidiar con ella</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498150/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Era martes 25 de febrero. El dif√≠cil lanzamiento de la versi√≥n el s√°bado 22 de febrero ya estaba en el pasado. Parec√≠a que todo lo peor estaba atr√°s, y nada presagiaba problemas. Pero todo cambi√≥ a la vez cuando se produjo un error de monitoreo debido a una p√©rdida de memoria en el proceso coordinador del servicio de control de acceso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øDe donde? Los √∫ltimos cambios importantes en la base del c√≥digo del coordinador fueron en la versi√≥n anterior hace m√°s de dos meses, y despu√©s de eso no sucedi√≥ nada notable en la memoria. Pero, desafortunadamente, los horarios de monitoreo fueron inflexibles: la memoria del coordinador obviamente comenz√≥ a gotear en alg√∫n lugar, un gran charco hizo alarde en el piso de servicio, lo que significa que el equipo de plomer√≠a ten√≠a mucho trabajo por hacer.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/sz/a5/nc/sza5ncpnbgd9jxdzckmeu1bztsi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero hacemos una peque√±a digresi√≥n. </font><font style="vertical-align: inherit;">Entre otras cosas, VLSI le permite realizar un seguimiento de las horas de trabajo y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controlar el acceso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por modelo de rostro, huella digital o tarjetas de acceso. </font><font style="vertical-align: inherit;">Al mismo tiempo, VLSI se comunica con los controladores de punto final (cerraduras, torniquetes, terminales de acceso, etc.). </font><font style="vertical-align: inherit;">Un servicio separado se comunica con los dispositivos. </font><font style="vertical-align: inherit;">Es pasivo, interact√∫a con dispositivos de control de acceso basados ‚Äã‚Äãen sus propios protocolos implementados a trav√©s de HTTP (S). </font><font style="vertical-align: inherit;">Est√° escrito sobre la base de la pila est√°ndar de servicios en nuestra empresa: la base de datos PostgreSQL, Python 3 se usa para la l√≥gica de negocios, extendida con m√©todos C / C ++ desde nuestra plataforma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un nodo de servicio web t√≠pico consta de los siguientes procesos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitor es el proceso ra√≠z.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un coordinador es un proceso secundario de un monitor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procesos de trabajo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitor es el primer proceso de servicio web. </font><font style="vertical-align: inherit;">Su tarea es llamar a fork (), iniciar el proceso del coordinador secundario y monitorear su trabajo. </font><font style="vertical-align: inherit;">El coordinador es el proceso principal del servicio web, es √©l quien recibe solicitudes de dispositivos externos, env√≠a respuestas y equilibra la carga. </font><font style="vertical-align: inherit;">El coordinador env√≠a la solicitud a los procesos de trabajo para su ejecuci√≥n, ellos la ejecutan, transfieren la respuesta a la memoria compartida e informan al coordinador que la tarea se ha completado y usted puede recoger el resultado.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQui√©n tiene la culpa y qu√© hacer?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, el coordinador del servicio de control de acceso difiere de los coordinadores de otros servicios en nuestra empresa por la presencia de un servidor web. Los coordinadores de otros servicios trabajaron sin fugas, por lo que el problema tuvo que buscarse en nuestra configuraci√≥n. Peor a√∫n, en los bancos de pruebas, la nueva versi√≥n existi√≥ durante mucho tiempo, y nadie not√≥ problemas de memoria en ellos. Comenzaron a mirar m√°s de cerca y descubrieron que la memoria fluye solo en uno de los soportes, e incluso entonces con un √©xito variable, lo que significa que el problema a√∫n no se reproduce tan f√°cilmente.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c_/lg/_k/c_lg_kswgcknpdyc8k2h7bd22d8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© hacer? ¬øC√≥mo encontrar una raz√≥n? En primer lugar, tomamos un volcado de memoria y lo enviamos a especialistas de la plataforma para su an√°lisis. El resultado: no hay nada en el vertedero: no hay raz√≥n, no hay indicios en qu√© direcci√≥n mirar m√°s all√°. Verificamos los cambios en el c√≥digo del coordinador de la versi√≥n anterior; de repente hicimos algunas ediciones terribles, pero ¬øno entendimos esto de inmediato? Pero no, solo se agregaron algunos comentarios al c√≥digo del coordinador, pero un par de m√©todos se trasladaron a nuevos archivos, en general, nada criminal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzaron a mirar a nuestros colegas, desarrolladores del n√∫cleo de nuestro servicio. Negaron con confianza la posibilidad misma de estar involucrados en nuestra desgracia, pero ofrecieron implantar el monitoreo de tracemalloc en el servicio. Apenas dicho que hecho, en la pr√≥xima revisi√≥n estamos finalizando el servicio, probando r√°pidamente, lanzando a la batalla.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ¬øqu√© vemos? Ahora nuestra memoria fluye no solo r√°pidamente, sino tambi√©n muy r√°pidamente: el crecimiento se ha vuelto exponencial. Atribuimos el primer pico a las fuerzas del mal y los factores que los acompa√±an, pero el segundo pico, varias horas despu√©s del primero, deja en claro que lleva demasiado tiempo esperar a que se libere el pr√≥ximo hotfix con un comportamiento de emergencia del servicio. Por lo tanto, tomamos los resultados de tracemalloc y aplicamos parches al servicio, retrocediendo las ediciones con monitoreo para regresar al menos al crecimiento lineal.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zl/yh/w7/zlyhw7-3oq-9wxxwkvwvsl8gd08.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parec√≠a que ten√≠amos los resultados del trabajo de tracemalloc en la memoria asignada en Python, ahora los analizaremos y encontraremos al culpable de la fuga, pero no estaba all√≠: en los datos recopilados no hay picos de 5.5GB que vimos en los gr√°ficos de monitoreo. La memoria m√°xima utilizada es de solo 250 MB, e incluso traceMalloc consume 130 MB de ellos. Esto es en parte explicable: tracemalloc le permite ver la din√°mica de la memoria en Python, pero no sabe acerca de la asignaci√≥n de memoria en los paquetes C y C ++ que implementa nuestra plataforma. No fue posible encontrar algo interesante en los datos obtenidos, la memoria se asigna en vol√∫menes aceptables a objetos ordinarios como secuencias, cadenas y diccionarios, en general, nada sospechoso. Luego decidimos eliminar todo lo superfluo de los datos, dejando solo el consumo total de memoria y el tiempo, y visualizar.Aunque la visualizaci√≥n no ayud√≥ a responder las preguntas "qu√© est√° sucediendo" y "por qu√©", con su ayuda vimos una correlaci√≥n con los datos del monitoreo, lo que significa que definitivamente tenemos un problema en alg√∫n lugar y tenemos que buscarlo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yr/es/gp/yresgpdyry0i_dr88dbtswqr8k8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ese momento, nuestro equipo de fontaneros se qued√≥ sin ideas sobre d√≥nde buscar una fuga. Afortunadamente, el p√°jaro nos cant√≥ que ocurri√≥ un cambio importante desde la plataforma: la versi√≥n de Python cambi√≥ de 3.4 a 3.7, y este es un gran campo de b√∫squeda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidimos buscar problemas relacionados con p√©rdidas de memoria en Python 3.7 en Internet, porque seguro que alguien ya se encontr√≥ con este comportamiento. A√∫n as√≠, Python 3.7 se public√≥ hace mucho tiempo, cambiamos a √©l solo con la actualizaci√≥n actual. Afortunadamente, la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">respuesta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a nuestra pregunta se encontr√≥ r√°pidamente, y tambi√©n hubo un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">problema</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una solicitud de extracci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para solucionar el problema, y ‚Äã‚Äãella misma estaba en los cambios realizados por los desarrolladores de Python. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQue pas√≥?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir de la versi√≥n 3.7, el comportamiento de la clase ThreadingMixIn ha cambiado, de lo que heredamos de nuestro servidor web para procesar cada solicitud en un hilo separado. En la clase ThreadingMixIn, agregaron la entrada de todos los hilos creados en una matriz. Debido a tales cambios, las instancias de clase que manejan conexiones de dispositivos no se liberan despu√©s de la finalizaci√≥n, y el recolector de basura en Python no puede borrar la memoria de los hilos gastados. Esto es lo que condujo al crecimiento lineal de la memoria asignada en proporci√≥n directa al n√∫mero de solicitudes a nuestro servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√°, el c√≥digo insidioso del m√≥dulo Python con un gran agujero (el c√≥digo en Python 3.5 se muestra a la izquierda antes de los cambios, a la derecha, en 3.7, despu√©s):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/pp/87/0mpp87t9snuuoadbahwaoxw2jj8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al descubrir la raz√≥n, eliminamos f√°cilmente la fuga: en nuestra clase de herederos cambiamos el valor de la bandera que devolvi√≥ el comportamiento anterior, y eso es todo: ¬°una victoria! </font><font style="vertical-align: inherit;">Las secuencias se crean como antes, sin escribir en la variable de clase, pero observamos una imagen agradable en los gr√°ficos de monitoreo: ¬°la fuga se ha solucionado! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1o/ja/ss/1ojassz9esw-378romz5kexysde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es bueno escribir sobre esto despu√©s de una victoria. </font><font style="vertical-align: inherit;">Probablemente no seamos los primeros en encontrar este problema despu√©s de cambiar a Python 3.7, pero lo m√°s probable es que no sea el √∫ltimo. </font><font style="vertical-align: inherit;">Para nosotros, concluimos que necesitamos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adopte un enfoque m√°s serio para evaluar las posibles consecuencias de cambios importantes, especialmente si otras decisiones aplicadas dependen de nosotros.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el caso de cambios globales en la plataforma, como, por ejemplo, cambiar la versi√≥n de Python, verifique su c√≥digo en busca de posibles problemas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda a cualquier cambio sospechoso en los horarios de monitoreo no solo de los servicios de combate, sino tambi√©n de los de prueba. </font><font style="vertical-align: inherit;">A pesar del recolector de basura actual, tambi√©n hay p√©rdidas de memoria en Python.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es necesario tener cuidado con las herramientas de an√°lisis de memoria como tracemalloc, ya que su uso incorrecto puede empeorar las cosas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debe estar preparado para el hecho de que la detecci√≥n de p√©rdidas de memoria requerir√° paciencia, perseverancia y un poco de trabajo de detective.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, me gustar√≠a expresar mi gratitud a todos los que ayudaron a hacer frente al trabajo de plomer√≠a de emergencia y una vez m√°s a volver a su capacidad de trabajo anterior a nuestro servicio.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es498136/index.html">Conversaci√≥n con Polina Gurtova sobre el futuro y el presente de Frontend. Los organizadores de DUMP 2020 hacen algunas preguntas importantes.</a></li>
<li><a href="../es498138/index.html">La vida despu√©s de los estudios universitarios: c√≥mo decid√≠ qu√© hacer a continuaci√≥n cuando la educaci√≥n superior y el trabajo ya existen</a></li>
<li><a href="../es498140/index.html">Replica esto. Seminarios web Apache Ignite y GridGain</a></li>
<li><a href="../es498144/index.html">Su primer BERT: una gu√≠a ilustrada</a></li>
<li><a href="../es498146/index.html">Seis tendencias de seguridad inteligente a tener en cuenta</a></li>
<li><a href="../es498154/index.html">Calendario de eventos inform√°ticos gratuitos en l√≠nea del 20 al 26 de abril</a></li>
<li><a href="../es498158/index.html">Marat√≥n remoto Semana 1: Lugar de trabajo</a></li>
<li><a href="../es498160/index.html">GlusterFS como almacenamiento externo para Kubernetes</a></li>
<li><a href="../es498162/index.html">Te invitamos a una pasant√≠a de TI en Alfa Bank</a></li>
<li><a href="../es498164/index.html">Estrategias de producto para costos de transici√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>