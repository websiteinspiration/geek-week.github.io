<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßîüèº üë©üèº‚Äçüç≥ ü§úüèæ Exibir resultados de pesquisa e problemas de desempenho üêì üèí üíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um dos cen√°rios t√≠picos em todos os aplicativos familiares √© procurar dados de acordo com certos crit√©rios e exibi-los em um formato f√°cil de ler. Tam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Exibir resultados de pesquisa e problemas de desempenho</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/epam_systems/blog/493438/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um dos cen√°rios t√≠picos em todos os aplicativos familiares √© procurar dados de acordo com certos crit√©rios e exibi-los em um formato f√°cil de ler. </font><font style="vertical-align: inherit;">Tamb√©m pode haver oportunidades adicionais para classifica√ß√£o, agrupamento e pagina√ß√£o. </font><font style="vertical-align: inherit;">A tarefa, em teoria, √© trivial, mas ao resolv√™-la, muitos desenvolvedores cometem v√°rios erros, que sofrem com o desempenho. </font><font style="vertical-align: inherit;">Vamos tentar considerar v√°rias solu√ß√µes para esse problema e formular recomenda√ß√µes para escolher a implementa√ß√£o mais eficaz.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ms/kc/-s/mskc-s_1t4wcxa9w7i04zg4cjjq.jpeg" alt="imagem"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o de pagina√ß√£o n¬∫ 1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A op√ß√£o mais simples que vem √† mente √© paginar os resultados da pesquisa em sua forma mais cl√°ssica.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rd/xx/vs/rdxxvst5xhcdfxzvlgrob1csxdk.png" width="498" height="232"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que um aplicativo use um banco de dados relacional. </font><font style="vertical-align: inherit;">Nesse caso, para exibir informa√ß√µes neste formul√°rio, voc√™ precisar√° executar duas consultas SQL:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obter linhas para a p√°gina atual.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calcule o n√∫mero total de linhas que correspondem aos crit√©rios de pesquisa - isso √© necess√°rio para mostrar as p√°ginas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere a primeira consulta usando o </font><font style="vertical-align: inherit;">servidor </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AdventureWorks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para 2016 do </font><font style="vertical-align: inherit;">banco de dados MS SQL de teste como exemplo </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para esse fim, usaremos a tabela Sales.SalesOrderHeader:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> Sales.SalesOrderHeader
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> OrderDate <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">OFFSET</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ROWS</span>
<span class="hljs-keyword">FETCH</span> <span class="hljs-keyword">NEXT</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">ONLY</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A consulta acima exibir√° os primeiros 50 pedidos de uma lista classificada em ordem decrescente por data de adi√ß√£o, ou seja, os √∫ltimos 50 pedidos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele √© executado rapidamente em uma base de teste, mas vamos examinar o plano de execu√ß√£o e as estat√≠sticas de E / S:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rw/e8/u8/rwe8u8un-1t5bm3yttan4qsfqrg.png" width="624" height="144"></div><br>
<pre><code class="plaintext hljs">Table 'SalesOrderHeader'. Scan count 1, logical reads 698, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode obter estat√≠sticas de E / S para cada solicita√ß√£o executando o comando SET STATISTICS IO ON no tempo de execu√ß√£o da consulta. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver no plano de execu√ß√£o, o mais intensivo em recursos √© classificar todas as linhas na tabela de origem pela data em que foram adicionadas. </font><font style="vertical-align: inherit;">E o problema √© que, quanto mais linhas aparecerem na tabela, mais dif√≠cil ser√° a classifica√ß√£o. </font><font style="vertical-align: inherit;">Na pr√°tica, essas situa√ß√µes devem ser evitadas; portanto, adicione o √≠ndice na data da adi√ß√£o e verifique se o consumo de recursos mudou:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/7y/so/g1/7ysog13xd9kalhv9fakieghj4je.png" width="720" height="148"></div><br>
<pre><code class="plaintext hljs">Table 'SalesOrderHeader'. Scan count 1, logical reads 165, physical reads 0, read-ahead reads 5, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, ficou muito melhor. </font><font style="vertical-align: inherit;">Mas todos os problemas foram resolvidos? </font><font style="vertical-align: inherit;">Vamos alterar a solicita√ß√£o de pesquisa de pedidos em que o custo total das mercadorias exceda US $ 100:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> Sales.SalesOrderHeader
<span class="hljs-keyword">WHERE</span> SubTotal &gt; <span class="hljs-number">100</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> OrderDate <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">OFFSET</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ROWS</span>
<span class="hljs-keyword">FETCH</span> <span class="hljs-keyword">NEXT</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">ONLY</span>
</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yn/_c/7s/yn_c7stdebp1utx8_ck4fbrvxjq.png" width="800" height="137"></div><br>
<pre><code class="plaintext hljs">Table 'SalesOrderHeader'. Scan count 1, logical reads 1081, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos uma situa√ß√£o engra√ßada: o plano de consulta √© um pouco pior que o anterior, mas o n√∫mero real de leituras l√≥gicas √© quase o dobro do que com uma varredura de tabela completa. </font><font style="vertical-align: inherit;">Existe uma sa√≠da - se fizermos o pre√ßo composto a partir do √≠ndice existente e adicionarmos o pre√ßo total das mercadorias como o segundo campo, obteremos 165 leituras l√≥gicas:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IX_SalesOrderHeader_OrderDate_SubTotal <span class="hljs-keyword">on</span> Sales.SalesOrderHeader(OrderDate, SubTotal);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa s√©rie de exemplos pode ser continuada por um longo tempo, mas os dois pensamentos principais que quero expressar aqui s√£o:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicionar qualquer novo crit√©rio ou ordem de classifica√ß√£o √† consulta de pesquisa pode afetar significativamente a velocidade de sua execu√ß√£o.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por√©m, se precisarmos subtrair apenas uma parte dos dados, e n√£o todos os resultados que atendem √†s condi√ß√µes de pesquisa, h√° muitas maneiras de otimizar essa consulta.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos para a segunda consulta, mencionada no in√≠cio - para a que conta o n√∫mero de registros que atendem aos crit√©rios de pesquisa. </font><font style="vertical-align: inherit;">Tome o mesmo exemplo - localizando pedidos que custam mais de US $ 100:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">FROM</span> Sales.SalesOrderHeader
<span class="hljs-keyword">WHERE</span> SubTotal &gt; <span class="hljs-number">100</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na presen√ßa do √≠ndice composto indicado acima, obtemos:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nb/tg/yz/nbtgyzsg7her2lswpnfq2jbmotk.png" width="517" height="197"></div><br>
<pre><code class="plaintext hljs">Table 'SalesOrderHeader'. Scan count 1, logical reads 698, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O fato de a consulta passar por todo o √≠ndice n√£o √© surpreendente, j√° que o campo SubTotal n√£o est√° na primeira posi√ß√£o, portanto, a consulta n√£o pode ser usada. O problema √© resolvido adicionando outro √≠ndice ao campo SubTotal e, como resultado, j√° fornece apenas 48 leituras l√≥gicas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode dar mais alguns exemplos de solicita√ß√µes para contar a quantidade, mas a ess√™ncia permanece a mesma: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receber uma parte dos dados e contar a quantidade total s√£o duas solicita√ß√µes fundamentalmente diferentes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e cada uma exige suas pr√≥prias medidas de otimiza√ß√£o. No caso geral, n√£o √© poss√≠vel encontrar uma combina√ß√£o de √≠ndices que funcione igualmente bem para ambas as consultas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consequentemente, um dos requisitos importantes que devem ser esclarecidos ao desenvolver uma solu√ß√£o de pesquisa √© se √© realmente importante para a empresa ver o n√∫mero total de objetos encontrados. </font><font style="vertical-align: inherit;">Muitas vezes acontece que n√£o. </font><font style="vertical-align: inherit;">E a navega√ß√£o para n√∫meros de p√°gina espec√≠ficos, na minha opini√£o, √© uma solu√ß√£o com um escopo muito restrito, pois a maioria dos cen√°rios de pagina√ß√£o se parece com "v√° para a pr√≥xima p√°gina".</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o de pagina√ß√£o n¬∫ 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que os usu√°rios n√£o se importem em saber o n√∫mero total de objetos encontrados. </font><font style="vertical-align: inherit;">Vamos tentar simplificar a p√°gina de pesquisa:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/tc/pr/1t/tcpr1teevrkdz8tcwsbjmx_dl5i.png" width="498" height="230"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, apenas o fato de que n√£o h√° como acessar n√∫meros de p√°gina espec√≠ficos mudou e agora esta tabela n√£o precisa saber quantos deles podem ser exibidos. Mas surge a pergunta - como a tabela sabe se h√° dados para a pr√≥xima p√°gina (para exibir corretamente o link "Avan√ßar")? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A resposta √© muito simples: voc√™ pode subtrair do banco de dados um registro a mais do que precisa exibir, e a presen√ßa desse registro "adicional" mostrar√° se existe a pr√≥xima parte. Portanto, para obter uma p√°gina de dados, voc√™ precisar√° concluir apenas uma consulta, o que melhora significativamente o desempenho e facilita o suporte a essa funcionalidade. Na pr√°tica, tive um caso ao me recusar a contar o n√∫mero total de registros acelerando a sa√≠da dos resultados em 4-5 vezes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para essa abordagem, existem v√°rias op√ß√µes para a interface do usu√°rio: os comandos "voltar" e "encaminhar", como no exemplo acima, o bot√£o "carregar mais", que simplesmente adiciona uma nova parte aos resultados exibidos, "rolagem infinita", que funciona com o princ√≠pio de "carregar mais" ", Mas o sinal para obter a pr√≥xima parte √© o usu√°rio percorrer todos os resultados exibidos at√© o final. </font><font style="vertical-align: inherit;">Qualquer que seja a solu√ß√£o visual, o princ√≠pio da amostragem de dados permanece o mesmo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As nuances da implementa√ß√£o da pagina√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em todos os exemplos das consultas acima, √© usada a abordagem "offset + number", quando a pr√≥pria consulta indica em que ordem as linhas de resultado e quantas linhas devem ser retornadas. </font><font style="vertical-align: inherit;">Primeiro, considere a melhor forma de organizar a transfer√™ncia de par√¢metros nesse caso. </font><font style="vertical-align: inherit;">Na pr√°tica, conheci v√°rias maneiras:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O n√∫mero de s√©rie da p√°gina solicitada (pageIndex), tamanho da p√°gina (tamanho da p√°gina).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O n√∫mero de s√©rie do primeiro registro a ser retornado (startIndex), o n√∫mero m√°ximo de registros como resultado (contagem).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O n√∫mero de s√©rie do primeiro registro a ser retornado (startIndex), o n√∫mero de s√©rie do √∫ltimo registro a ser retornado (endIndex).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä primeira vista, pode parecer que isso seja t√£o elementar que n√£o h√° diferen√ßa. </font><font style="vertical-align: inherit;">Mas n√£o √© assim - a op√ß√£o mais conveniente e universal √© a segunda (startIndex, count). </font><font style="vertical-align: inherit;">H√° v√°rias raz√µes para isso:</font></font><br>
<br>
<ul>
<li>    +1 ,  ,    pageIndex  pageSize  . ,    50   .    ,      ,  .   ¬´+1¬ª    , ,          1  51,   ‚Äî  51  101  ..     51   pageIndex,      52  102  .. ,             ‚Äî     ¬´¬ª ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A terceira op√ß√£o n√£o faz sentido, pois para executar consultas na maioria dos bancos de dados, voc√™ ainda precisar√° transferir a quantidade, n√£o o √≠ndice do √∫ltimo registro. </font><font style="vertical-align: inherit;">Deixe a subtra√ß√£o de startIndex de endIndex e uma opera√ß√£o aritm√©tica elementar, mas √© sup√©rflua aqui.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora devemos descrever as defici√™ncias da implementa√ß√£o da pagina√ß√£o atrav√©s de "deslocamento + quantidade":</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obter cada p√°gina seguinte ser√° mais caro e mais lento que a anterior, porque o banco de dados ainda precisar√° passar por todos os registros "desde o in√≠cio", de acordo com os crit√©rios de pesquisa e classifica√ß√£o, e depois parar no fragmento desejado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nem todos os DBMSs podem suportar essa abordagem.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem alternativas, mas elas tamb√©m s√£o imperfeitas. </font><font style="vertical-align: inherit;">A primeira dessas abordagens √© chamada ‚Äúpagina√ß√£o do conjunto de chaves‚Äù ou ‚Äúm√©todo de busca‚Äù e consiste no seguinte: ap√≥s receber uma parte, voc√™ pode lembrar os valores dos campos no √∫ltimo registro da p√°gina e depois us√°-los para obter a pr√≥xima parte. </font><font style="vertical-align: inherit;">Por exemplo, realizamos a seguinte solicita√ß√£o:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> Sales.SalesOrderHeader
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> OrderDate <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">OFFSET</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ROWS</span>
<span class="hljs-keyword">FETCH</span> <span class="hljs-keyword">NEXT</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">ONLY</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E no √∫ltimo registro, obtivemos o valor da data do pedido '2014-06-29'. </font><font style="vertical-align: inherit;">Em seguida, para obter a pr√≥xima p√°gina, voc√™ pode tentar fazer o seguinte:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> Sales.SalesOrderHeader
<span class="hljs-keyword">WHERE</span> OrderDate &lt; <span class="hljs-string">'2014-06-29'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> OrderDate <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">OFFSET</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ROWS</span>
<span class="hljs-keyword">FETCH</span> <span class="hljs-keyword">NEXT</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">ONLY</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema √© que OrderDate √© um campo n√£o exclusivo e √© prov√°vel que a condi√ß√£o mencionada acima ignore muitas das linhas necess√°rias. </font><font style="vertical-align: inherit;">Para tornar essa solicita√ß√£o inequ√≠voca, voc√™ precisa adicionar um campo exclusivo √† condi√ß√£o (suponha que 75074 seja o √∫ltimo valor da chave prim√°ria da primeira parte):</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> Sales.SalesOrderHeader
<span class="hljs-keyword">WHERE</span> (OrderDate = <span class="hljs-string">'2014-06-29'</span> <span class="hljs-keyword">AND</span> SalesOrderID &lt; <span class="hljs-number">75074</span>)
   <span class="hljs-keyword">OR</span> (OrderDate &lt; <span class="hljs-string">'2014-06-29'</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> OrderDate <span class="hljs-keyword">DESC</span>, SalesOrderID <span class="hljs-keyword">DESC</span>
<span class="hljs-keyword">OFFSET</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ROWS</span>
<span class="hljs-keyword">FETCH</span> <span class="hljs-keyword">NEXT</span> <span class="hljs-number">50</span> <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">ONLY</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa op√ß√£o funcionar√° corretamente, mas, no caso geral, ser√° dif√≠cil otimizar, pois a condi√ß√£o cont√©m o operador OR. Se o valor da chave prim√°ria aumentar com o crescimento de OrderDate, a condi√ß√£o poder√° ser simplificada deixando apenas o filtro por SalesOrderID. Mas se n√£o houver uma correla√ß√£o estrita entre os valores da chave prim√°ria e o campo pelo qual o resultado √© classificado - na maioria dos DBMSs, esse OR n√£o pode ser evitado. A exce√ß√£o conhecida por mim √© o PostgreSQL, onde a compara√ß√£o de tuplas √© totalmente suportada e a condi√ß√£o acima pode ser escrita como ‚ÄúWHERE (OrderDate, SalesOrderID) &lt;('2014-06-29', 75074). Se voc√™ possui uma chave composta com esses dois campos, uma solicita√ß√£o semelhante deve ser bastante f√°cil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda abordagem alternativa pode ser encontrada, por exemplo, na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API de rolagem ElasticSearch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BD do Cosmos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - quando uma consulta, al√©m dos dados, retorna um identificador especial com o qual voc√™ pode obter o pr√≥ximo lote de dados. </font><font style="vertical-align: inherit;">Se esse identificador tiver uma vida √∫til ilimitada (como no Comsos DB), essa √© uma √≥tima maneira de implementar a pagina√ß√£o com transi√ß√£o sequencial entre as p√°ginas (op√ß√£o n¬∫ 2 mencionada acima). </font><font style="vertical-align: inherit;">Suas poss√≠veis desvantagens: nem todos os DBMSs s√£o suportados; </font><font style="vertical-align: inherit;">o pr√≥ximo identificador de lote recebido pode ter uma vida √∫til limitada, o que geralmente n√£o √© adequado para implementar a intera√ß√£o do usu√°rio (como a API de rolagem ElasticSearch).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Filtragem complexa</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√≥s complicamos ainda mais a tarefa. </font><font style="vertical-align: inherit;">Suponha que exista um requisito para implementar a chamada pesquisa facetada, que √© familiar a todos, de lojas online. </font><font style="vertical-align: inherit;">Os exemplos acima, com base na tabela de pedidos, n√£o s√£o muito indicativos nesse caso, portanto, mudaremos para a tabela Produto do banco de dados AdventureWorks:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/di/ws/13/diws13cm-qjxoy3igxslnbvizca.png" width="595" height="234"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qual √© a ideia da pesquisa facetada? </font><font style="vertical-align: inherit;">Nisso, para cada elemento do filtro, o n√∫mero de registros correspondentes a este crit√©rio √© mostrado </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">levando em considera√ß√£o os filtros selecionados em todas as outras categorias</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, se selecionarmos a categoria Bicicletas e a cor Preto neste exemplo, a tabela exibir√° apenas bicicletas pretas, mas ao mesmo tempo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para cada crit√©rio do grupo "Categorias", o n√∫mero de produtos dessa categoria em preto ser√° mostrado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para cada crit√©rio do grupo Cores, o n√∫mero de bicicletas dessa cor ser√° mostrado.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° um exemplo de sa√≠da do resultado para tais condi√ß√µes:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y8/v2/q2/y8v2q2j76mcfnmjmirzu8jrnhyu.png" width="605" height="234"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se al√©m de marcar a categoria ‚ÄúVestu√°rio‚Äù, a tabela tamb√©m mostrar√° as roupas pretas dispon√≠veis. </font><font style="vertical-align: inherit;">O n√∫mero de produtos em preto na se√ß√£o "Cor" tamb√©m ser√° recalculado de acordo com as novas condi√ß√µes, apenas na se√ß√£o "Categorias" nada mudar√° ... Espero que esses exemplos sejam suficientes para entender o algoritmo de pesquisa facetado familiar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora imagine como isso pode ser implementado em uma base relacional. </font><font style="vertical-align: inherit;">Cada grupo de crit√©rios, como Categoria e Cor, exigir√° uma solicita√ß√£o separada:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pc.ProductCategoryID, pc.Name, <span class="hljs-keyword">COUNT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">FROM</span> Production.Product p
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> Production.ProductSubcategory ps <span class="hljs-keyword">ON</span> p.ProductSubcategoryID = ps.ProductSubcategoryID
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> Production.ProductCategory pc <span class="hljs-keyword">ON</span> ps.ProductCategoryID = pc.ProductCategoryID
<span class="hljs-keyword">WHERE</span> p.Color = <span class="hljs-string">'Black'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> pc.ProductCategoryID, pc.Name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span>
</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/mf/79/az/mf79azaflzgu-1gatq4gtbhcdzw.png" width="331" height="90"></div><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> Color, <span class="hljs-keyword">COUNT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">FROM</span> Production.Product p
  <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> Production.ProductSubcategory ps <span class="hljs-keyword">ON</span> p.ProductSubcategoryID = ps.ProductSubcategoryID
<span class="hljs-keyword">WHERE</span> ps.ProductCategoryID = <span class="hljs-number">1</span> <span class="hljs-comment">--Bikes</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> Color
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">COUNT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span>
</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cf/ec/r5/cfecr5njjmi93lsdrei1teygmhi.png" width="190" height="110"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que h√° de errado com essa decis√£o? </font><font style="vertical-align: inherit;">Muito simples - n√£o escala bem. </font><font style="vertical-align: inherit;">Cada se√ß√£o de filtro requer uma consulta separada para contar quantidades, e essas consultas n√£o s√£o as mais f√°ceis. </font><font style="vertical-align: inherit;">Nas lojas online, em algumas se√ß√µes, pode haver v√°rias dezenas de se√ß√µes do filtro, o que pode ser um problema s√©rio de desempenho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geralmente, ap√≥s essas declara√ß√µes, elas me oferecem algumas solu√ß√µes, a saber:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combine todas as contagens de quantidade em uma consulta. </font><font style="vertical-align: inherit;">Tecnicamente, isso √© poss√≠vel usando a palavra-chave UNION, apenas isso n√£o ajudar√° muito no desempenho - de qualquer maneira, o banco de dados ter√° que executar cada um dos fragmentos do zero.</font></font></li>
<li> .      ,    .   ,      . ,   10 ¬´¬ª,     5 .   ¬´¬ª    ,       -.         9- ,  ,        .     50 ,    ,     2<sup>50</sup>.         ,  .     ,            5-10 . ,          ,  -  ,      ,                (     ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Felizmente, essa tarefa h√° muito tempo tem solu√ß√µes suficientemente eficazes que previsivelmente funcionam em grandes quantidades de dados. Para qualquer uma dessas op√ß√µes, faz sentido dividir a recontagem de facetas e colocar a p√°gina de resultados em duas chamadas paralelas ao servidor e organizar a interface do usu√°rio de tal maneira que carregar os dados nas facetas "n√£o interfira" na exibi√ß√£o dos resultados da pesquisa.</font></font><br>
<br>
<ul>
<li>   ¬´¬ª   . ,        ,       ,   ,      ‚Äî ¬´1425  , ?¬ª       ,    ¬´¬ª.                 ¬´¬ª.  ,   ,             .        -. ,       ,        .</li>
<li> search engine      ,   Solr, ElasticSearch, Sphinx  .      ¬´¬ª         .    ,          ,       ‚Äî     .      ,  search engine       ,    :     ,    ,    ;       search engine      .       ‚Äî     .      ¬´ ¬ª.          ¬´¬ª    ,   ,            .      ,   -  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">transactional outbox</a>      .</li>
</ul><br>
<h2></h2><br>
<ol>
<li>     ‚Äî  ,             .   ¬´¬ª  ¬´¬ª ‚Äî    ,      :<br>
<ul>
<li>                   ‚Äî       .</li>
<li>   ,         ,    ,     .  -          ‚Äî    .</li>
</ul></li>
<li>                ,          ‚Äî         #2.</li>
<li>     faceted search,        :<br>
<ul>
<li>        .</li>
<li> search engine   Solr, ElasticSearch, Sphinx  .   ,         ,            . </li>
</ul></li>
<li>   faceted search              .      ,   ,        .</li>
<li>   SQL   ,   ,    ,           (   ¬´¬ª ).           ,   ‚Äî  ¬´¬ª.           ,        .</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt493426/index.html">Organiza√ß√£o do c√≥digo em microsservi√ßos e minha abordagem do uso da arquitetura hexagonal e DDD</a></li>
<li><a href="../pt493428/index.html">"N√£o daremos origem a teorias da conspira√ß√£o". Fale sobre confer√™ncias de ML com pessoas de empresas de ci√™ncia e TI</a></li>
<li><a href="../pt493430/index.html">Arquitetura de rede para aplicativos da Web</a></li>
<li><a href="../pt493432/index.html">Por que n√£o iniciar uma carreira em uma pequena empresa que n√£o √© de TI</a></li>
<li><a href="../pt493436/index.html">Programa para altera√ß√£o de direitos de acesso e registro de nomes de arquivos / diret√≥rios no Bash</a></li>
<li><a href="../pt493440/index.html">Marketing de influenciadores na China: no que se baseia e no que influenciadores podem oferecer no contexto de emerg√™ncias</a></li>
<li><a href="../pt493442/index.html">Lembrete de EPI</a></li>
<li><a href="../pt493444/index.html">O projeto "Glass". Copos descart√°veis ‚Äã‚Äãde ch√° / caf√© de efici√™ncia energ√©tica</a></li>
<li><a href="../pt493446/index.html">Leitura de fim de semana: 10 hist√≥rias sonoras incomuns - de jogos com espi√µes e teorias da conspira√ß√£o a ASMR relaxante</a></li>
<li><a href="../pt493448/index.html">Roteamento eficiente por mola</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>