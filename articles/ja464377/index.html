<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔕 ✋🏿 🧑🏾‍🤝‍🧑🏽 ダーティアセンブラーハッキング6502 😌 ⛔️ 🖐🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、私の小さなCommodore 64プログラミングコンテストの参加者が使用したトリックのいくつかを紹介します。競争のルールは単純でした。2つの線を描画して下の画像を形成するC64実行可能（PRG）ファイルを作成します。ファイルのサイズが小さい方が勝ちます。
 
 
 コンテストエントリは...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ダーティアセンブラーハッキング6502</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464377/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、私の小さな</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commodore 64プログラミングコンテストの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参加者が使用したトリックのいくつかを紹介します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">競争のルールは単純でした。2つの線を描画して下の画像を形成するC64実行可能（PRG）ファイルを作成します。</font><font style="vertical-align: inherit;">ファイルのサイズが小さい方が勝ちます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3f4/5d1/afc/3f45d1afc9817c6530b6b34c44dd0497.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテストエントリは、公開ツイートとPRGファイルのバイトとMD5ハッシュのみを含むプライベートメッセージで公開されました。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースコードへのリンクを含む参加者のリスト：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィリップ・ヘロン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-34バイト、勝者）</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geir Straume</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-34バイト）</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペトリ・ハッキネン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-37バイト）</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matlev Raksenblatts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-38バイト）</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jan Ahrenius</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-48バイト）</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jamie Fuller</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-50バイト）</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デビッドA.ガーシュマン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-53バイト）</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janne Hellsten</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;-56バイト）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（誰かを逃した場合は、お知らせください。リストを更新します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事の残りの部分では、コンペティションで使用されたいくつかのアセンブラートリックについて取り上げます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基礎</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Graphics C64は、デフォルトで40x25文字エンコードモードで動作します。</font><font style="vertical-align: inherit;">RAMのフレームバッファは2つの配列に分かれています。</font></font><br>
<br>
<ul>
<li><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> （画面RAM、40x25バイト）</font></font><br>
</li>
<li><code>$d800</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> （カラーRAM、40x25バイト）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文字を設定するには、バイトをオンスクリーンRAMに保存します</font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（たとえば、</font></font><code>$0400+y*40+x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">カラーRAMはデフォルトでライトブルーで初期化されています（カラー14）：これはラインに使用するカラーです。つまり、カラーRAMはタッチせずに残すことができます。</font><font style="vertical-align: inherit;">（境界線）と</font><font style="vertical-align: inherit;">（背景）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
のメモリI / Oレジスタを使用して、境界線と背景の色を制御します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
固定線の傾きを直接プログラムすれば、2本の線を描くのは非常に簡単です。</font><font style="vertical-align: inherit;">以下は、線を描き、画面の内容を標準出力（</font><font style="vertical-align: inherit;">PCでコードを機能させるために</font><font style="vertical-align: inherit;">使用）</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">フラッシュするCの実装です</font><font style="vertical-align: inherit;">。</font></font><code>$d020</code><font style="vertical-align: inherit;"></font><code>$d021</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>malloc()</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">dump</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span>* screen)</span> </span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint8_t</span>* s = screen;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">25</span>; y++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-number">40</span>; x++, s++) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%c"</span>, *s == <span class="hljs-number">0xa0</span> ? <span class="hljs-string">'#'</span> : <span class="hljs-string">'.'</span>);<font></font>
        }<font></font>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setreg</span><span class="hljs-params">(<span class="hljs-keyword">uintptr_t</span> dst, <span class="hljs-keyword">uint8_t</span> v)</span> </span>{
<span class="hljs-comment">//  *((uint8_t *)dst) = v;</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
<span class="hljs-comment">//  uint8_t* screenRAM = (uint_8*)0x0400;</span>
    <span class="hljs-keyword">uint8_t</span>* screenRAM = (<span class="hljs-keyword">uint8_t</span> *)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">40</span>*<span class="hljs-number">25</span>, <span class="hljs-number">0x20</span>);<font></font>
<font></font>
    setreg(<span class="hljs-number">0xd020</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// Set border color</span>
    setreg(<span class="hljs-number">0xd021</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// Set background color</span><font></font>
<font></font>
    <span class="hljs-keyword">int</span> yslope = (<span class="hljs-number">25</span>&lt;&lt;<span class="hljs-number">8</span>)/<span class="hljs-number">40</span>;
    <span class="hljs-keyword">int</span> yf = yslope/<span class="hljs-number">2</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-number">40</span>; x++) {
        <span class="hljs-keyword">int</span> yi = yf &gt;&gt; <span class="hljs-number">8</span>;
        <span class="hljs-comment">// First line</span>
        screenRAM[x + yi*<span class="hljs-number">40</span>] = <span class="hljs-number">0xa0</span>;
        <span class="hljs-comment">// Second line (X-mirrored)</span>
        screenRAM[(<span class="hljs-number">39</span>-x) + yi*<span class="hljs-number">40</span>] = <span class="hljs-number">0xa0</span>;<font></font>
        yf += yslope;<font></font>
    }<font></font>
<font></font>
    dump(screenRAM);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の画面コードは</font></font><code>$20</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（空白）と</font></font><code>$a0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（8×8ブロックで塗りつぶされています）です。</font><font style="vertical-align: inherit;">実行すると、2行のASCII画像が表示されます。</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">## .................................... ##</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
..＃.................................................＃..</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... ## .............................. ## ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.....＃............................＃.....</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...... ## ........................ ## ......</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
........ ## .................... ## ........</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
..........＃..................＃..........</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
........... ## .............. ## ...........</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.............＃............＃.............</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.............. ## ........ ## ..............</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
................ ## .... ## ................</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
..................＃..＃..................</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
................... ## ...................</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
..................＃..＃..................</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
................ ## .... ## ................</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.............. ## ........ ## ..............</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.............＃............＃.............</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
........... ## .............. ## ...........</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
..........＃..................＃..........</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
........ ## .................... ## ........</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...... ## ........................ ## ......</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
.....＃............................＃.....</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... ## .............................. ## ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
..＃.................................................＃..</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
## .................................... ##</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じことがアセンブラで簡単に実装されています。</font></font><br>
<br>
<pre><code class="plaintext hljs">!include "c64.asm"<font></font>
<font></font>
+c64::basic_start(entry)<font></font>
<font></font>
entry: {<font></font>
    lda #0      ; black color<font></font>
    sta $d020   ; set border to 0<font></font>
    sta $d021   ; set background to 0<font></font>
<font></font>
    ; clear the screen<font></font>
    ldx #0<font></font>
    lda #$20<font></font>
clrscr:<font></font>
!for i in [0, $100, $200, $300] {<font></font>
    sta $0400 + i, x<font></font>
}<font></font>
    inx<font></font>
    bne clrscr<font></font>
<font></font>
    ; line drawing, completely unrolled<font></font>
    ; with assembly pseudos<font></font>
    lda #$a0<font></font>
<font></font>
    !for i in range(40) {<font></font>
        !let y0 = Math.floor(25/40*(i+0.5))<font></font>
        sta $0400 + y0*40 + i<font></font>
        sta $0400 + (24-y0)*40 + i<font></font>
    }<font></font>
inf: jmp inf  ; halt<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PRGは286バイトという非常に大きなサイズであることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最適化に入る前に、いくつかの観察を行います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ROMルーチンを配置したC64で作業します。便利なルーチンがたくさんあります。たとえば、で画面をクリアします</font></font><code>JSR $E544</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第2に、6502などの8ビットプロセッサでのアドレス計算は面倒で、多くのバイトを消費する可能性があります。このプロセッサには乗数もないため、計算に</font></font><code>y*40+i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は通常、論理シフトの束またはバイトも消費するルックアップテーブルが含ま</font><font style="vertical-align: inherit;">れているよう</font><font style="vertical-align: inherit;">です。 40倍にならないようにするには、画面カーソルを少しずつ進めるのが最善です。</font></font><br>
<br>
<pre><code class="plaintext hljs">    int yslope = (25&lt;&lt;8)/40;<font></font>
    int yf = yslope/2;<font></font>
    uint8_t* dst = screenRAM;<font></font>
    for (int x = 0; x &lt; 40; x++) {<font></font>
        dst[x] = 0xa0;<font></font>
        dst[(39-x)] = 0xa0;<font></font>
        yf += yslope;<font></font>
        if (yf &amp; 256) { // Carry set?<font></font>
            dst += 40;<font></font>
            yf &amp;= 255;<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
固定カウンターに線の傾きを追加し続け</font></font><code>yf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、8ビットの加算によりキャリーフラグが設定されると、40を追加</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
します。アセンブラーのインクリメンタルアプローチは次のとおりです。</font></font><br>
<br>
<pre><code class="plaintext hljs">!include "c64.asm"<font></font>
<font></font>
+c64::basic_start(entry)<font></font>
<font></font>
!let screenptr = $20<font></font>
!let x0 = $40<font></font>
!let x1 = $41<font></font>
!let yf = $60<font></font>
<font></font>
entry: {<font></font>
        lda #0<font></font>
        sta x0<font></font>
        sta $d020<font></font>
        sta $d021<font></font>
<font></font>
        ; kernal clear screen<font></font>
        jsr $e544<font></font>
<font></font>
        ; set screenptr = $0400<font></font>
        lda #&lt;$0400<font></font>
        sta screenptr+0<font></font>
        lda #&gt;$0400<font></font>
        sta screenptr+1<font></font>
<font></font>
        lda #80<font></font>
        sta yf<font></font>
<font></font>
        lda #39<font></font>
        sta x1<font></font>
xloop:<font></font>
        lda #$a0<font></font>
        ldy x0<font></font>
        ; screenRAM[x] = 0xA0<font></font>
        sta (screenptr), y<font></font>
        ldy x1<font></font>
        ; screenRAM[39-x] = 0xA0<font></font>
        sta (screenptr), y<font></font>
<font></font>
        clc<font></font>
        lda #160  ; line slope<font></font>
        adc yf<font></font>
        sta yf<font></font>
        bcc no_add<font></font>
<font></font>
        ; advance screen ptr by 40<font></font>
        clc<font></font>
        lda screenptr<font></font>
        adc #40<font></font>
        sta screenptr<font></font>
        lda screenptr+1<font></font>
        adc #0<font></font>
        sta screenptr+1<font></font>
<font></font>
no_add:<font></font>
        inc x0<font></font>
        dec x1<font></font>
        bpl xloop<font></font>
<font></font>
inf:    jmp inf<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
82バイトと、まだかなり重いです。</font><font style="vertical-align: inherit;">1つの明らかな問題は、16ビットのアドレス計算です。</font></font><code>screenptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">間接インデックスアドレス指定の</font><font style="vertical-align: inherit;">値</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">設定します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">        ; set screenptr = $0400<font></font>
        lda #&lt;$0400<font></font>
        sta screenptr+0<font></font>
        lda #&gt;$0400<font></font>
        sta screenptr+1</code></pre><br><font style="vertical-align: inherit;"></font><code>screenptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40を追加して次の行に</font><font style="vertical-align: inherit;">
翻訳</font><font style="vertical-align: inherit;">します。</font></font><br>
<br>
<pre><code class="plaintext hljs">        ; advance screen ptr by 40<font></font>
        clc<font></font>
        lda screenptr<font></font>
        adc #40<font></font>
        sta screenptr<font></font>
        lda screenptr+1<font></font>
        adc #0<font></font>
        sta screenptr+1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、このコードは最適化できますが、16ビットアドレスをまったく削除した場合はどうなりますか？</font><font style="vertical-align: inherit;">それを行う方法を見てみましょう。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トリック1.スクロール！</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画面上のRAMに線を作成する代わりに、最後の画面の行Y = 24にのみ描画し、画面全体を上にスクロールして、</font></font><code>JSR $E8EA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！で</font><font style="vertical-align: inherit;">ROMスクロール関数を呼び出します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
xloopの最適化方法は次のとおりです。</font></font><br>
<br>
<pre><code class="plaintext hljs">        lda #0<font></font>
        sta x0<font></font>
        lda #39<font></font>
        sta x1<font></font>
xloop:<font></font>
        lda #$a0<font></font>
        ldx x0<font></font>
        ; hardcoded absolute address to last screen line<font></font>
        sta $0400 + 24*40, x<font></font>
        ldx x1<font></font>
        sta $0400 + 24*40, x<font></font>
<font></font>
        adc yf<font></font>
        sta yf<font></font>
        bcc no_scroll<font></font>
        ; scroll screen up!<font></font>
        jsr $e8ea<font></font>
no_scroll:<font></font>
        inc x0<font></font>
        dec x1<font></font>
        bpl xloop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはレンダリングがどのように見えるかです：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/63f/081/6a6/63f0816a6728ec839de0197b6e0a3179.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、このプログラムで私のお気に入りのトリックの1つです。</font><font style="vertical-align: inherit;">ほとんどすべての競技者が自分でそれを見つけました。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トリック2.自己変更コード</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ピクセル値を格納するためのコードは次のように終わります：</font></font><br>
<br>
<pre><code class="plaintext hljs">        ldx x1<font></font>
        ; hardcoded absolute address to last screen line<font></font>
        sta $0400 + 24*40, x<font></font>
        ldx x0<font></font>
        sta $0400 + 24*40, x<font></font>
        inc x0<font></font>
        dec x1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、次の14バイトのシーケンスでエンコードされます。</font></font><br>
<br>
<pre><code class="plaintext hljs">0803: A6 22               LDX $22<font></font>
0805: 9D C0 07            STA $07C0,X<font></font>
0808: A6 20               LDX $20<font></font>
080A: 9D C0 07            STA $07C0,X<font></font>
080D: E6 22               INC $22<font></font>
080F: C6 20               DEC $20</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自己変更コード（SMC）を使用すると、これをよりコンパクトに記述できます。</font></font><br>
 <br>
<pre><code class="plaintext hljs">        ldx x1<font></font>
        sta $0400 + 24*40, x<font></font>
addr0:  sta $0400 + 24*40<font></font>
        ; advance the second x-coord with SMC<font></font>
        inc addr0+1<font></font>
        dec x1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... 13バイトでエンコードされています：</font></font><br>
<br>
<pre><code class="plaintext hljs">0803: A6 22               LDX $22<font></font>
0805: 9D C0 07            STA $07C0,X<font></font>
0808: 8D C0 07            STA $07C0<font></font>
080B: EE 09 08            INC $0809<font></font>
080E: C6 22               DEC $22</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トリック3.動作状態「電源オン」</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
競争では、労働環境についてワイルドな仮定をすることは正常であると考えられていました。</font><font style="vertical-align: inherit;">たとえば、線画はC64電源をオンにした後に最初に始まるものであり、BASICコマンドラインにクリーンな出力を返す必要はありません。</font><font style="vertical-align: inherit;">したがって、PRGに入るときに初期環境で見つけたすべてのものは、有利に使用でき、使用する必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レジスタA、X、Yはゼロと見なされます</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのCPUフラグがクリアされました</font></font><br>
</li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゼロページ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツ</font><font style="vertical-align: inherit;">（アドレス</font></font><code>$00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$ff</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、一部のKERNAL ROMプロシージャを呼び出す場合、CPUフラグ、一時的なゼロページ値などの副作用を最大限に活用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の最適化の後、マシンのメモリで興味深いものを探します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0df/43f/93c/0df43f93c58a142911607d3ba5ba44dd.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゼロページには、私たちの目的に役立ついくつかの値が含まれています：</font></font><br>
<br>
<ul>
<li><code>$d5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：39 / $ 27 ==行の長さ-1</font></font><br>
</li>
<li><code>$22</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：64 / $ 40 ==ラインスロープカウンターの初期値</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、初期化中に数バイトが節約されます。</font><font style="vertical-align: inherit;">例えば：</font></font><br>
<br>
<pre><code class="plaintext hljs">!let x0 = $20<font></font>
        lda #39      ; 0801: A9 27    LDA #$27<font></font>
        sta x0       ; 0803: 85 20    STA $20<font></font>
xloop:<font></font>
        dec x0       ; 0805: C6 20    DEC $20<font></font>
        bpl xloop    ; 0807: 10 FC    BPL $0805</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これに</font></font><code>$d5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は39の値が含まれているため</font></font><code>x0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、LDA / STAペアを取り除く</font><font style="vertical-align: inherit;">ことにより、カウンターにそれを示すことができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">!let x0 = $d5<font></font>
        ; nothing here!<font></font>
xloop:<font></font>
        dec x0       ; 0801: C6 D5    DEC $D5<font></font>
        bpl xloop    ; 0803: 10 FC    BPL $0801</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたのコード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
でのフィリップの勝者</font><font style="vertical-align: inherit;">はこれを極端にします。</font><font style="vertical-align: inherit;">文字列の最後の文字のアドレスを思い出してください</font></font><code>$07C0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（== </font></font><code>$0400+24*40</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">この値は、初期化中にゼロページに存在しません。</font><font style="vertical-align: inherit;">ただし、ROMからのスクロールルーチンが一時的なゼロページ値を使用する方法の副作用として</font></font><code>$D1-$D2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、関数の出力の</font><font style="vertical-align: inherit;">アドレス</font><font style="vertical-align: inherit;">には値が含まれます</font></font><code>$07C0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、</font></font><code>STA $07C0,x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1バイトで</font><font style="vertical-align: inherit;">はなくピクセルを格納するために、</font><font style="vertical-align: inherit;">より短い間接インデックスアドレス指定を使用できます</font></font><code>STA ($D1),y</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トリック4.ダウンロードの最適化</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的なC64 PRGバイナリには、次のものが含まれています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の2バイト：ダウンロードアドレス（通常は</font></font><code>$0801</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12バイトのBASICブートシーケンス</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインブートシーケンスは次のようになります（アドレス</font></font><code>$801-$80C</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<pre><code class="plaintext hljs">0801: 0B 08 0A 00 9E 32 30 36 31 00 00 00<font></font>
080D: 8D 20 D0     STA $D020</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BASICトークン化メモリレイアウトの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
詳細については</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">触れ</font></a><font style="vertical-align: inherit;">ませんが、このシーケンスは多かれ少なかれ「10 SYS 2061」に対応しています。</font><font style="vertical-align: inherit;">アドレス</font></font><code>2061</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><code>$080D</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）は、BASICインタープリターがSYSコマンドを実行するときに実際のマシンコードプログラムが実行される場所です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
14バイトが多すぎるようです。</font><font style="vertical-align: inherit;">Philip、Matlev、Geirは、いくつかのトリッキーなトリックを使用して、メインシーケンスを完全に削除しました。</font><font style="vertical-align: inherit;">これ</font><font style="vertical-align: inherit;">は、PRGロードアドレス（最初の2バイト）を無視して常ににロード</font><font style="vertical-align: inherit;">するため、PRGを</font></font><code>LOAD"*",8,1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">ロードする必要があり</font></font><code>LOAD"*",8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font><code>$0801</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/911/d07/fdb/911d07fdb2c0e2e13b07e360bb16d03c.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは2つの方法が使用されました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタックトリック</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本的なベクターウォームリセットトリック</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタックトリック</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トリックは</font></font><code>$01F8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、目的のエントリポイントを示す値で</font><font style="vertical-align: inherit;">プロセッサスタックにポップすることです</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、コードへの16ビットポインターで始まるPRGを作成し、PRGをにロードすることによって行われます</font></font><code>$01F8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">    * = $01F8<font></font>
    !word scroll - 1  ; overwrite stack<font></font>
<font></font>
scroll:	jsr $E8EA</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BASICローダー（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">逆アセンブル後</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">コードを</font></a><font style="vertical-align: inherit;">参照</font><font style="vertical-align: inherit;">）がロードを完了し、helpを使用して呼び出し元のオブジェクトに戻りたいと思うと</font></font><code>RTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すぐに、PRGに直接戻ります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本的なベクターウォームリセットトリック</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、分解後にPRGを確認するだけで簡単に説明できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">02E6: 20 EA E8    JSR $E8EA<font></font>
02E9: A4 D5       LDY $D5<font></font>
02EB: A9 A0       LDA #$A0<font></font>
02ED: 99 20 D0    STA $D020,Y<font></font>
02F0: 91 D1       STA ($D1),Y<font></font>
02F2: 9D B5 07    STA $07B5,X<font></font>
02F5: E6 D6       INC $D6<font></font>
02F7: 65 90       ADC $90<font></font>
02F9: 85 90       STA $90<font></font>
02FB: C6 D5       DEC $D5<font></font>
02FD: 30 FE       BMI $02FD<font></font>
02FF: 90 E7       BCC $02E8<font></font>
0301: 4C E6 02    JMP $02E6</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の行（</font></font><code>JMP $02E6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）に</font><font style="vertical-align: inherit;">注意してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">JMP命令は、の</font></font><code>$0301</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジャンプアドレスで</font><font style="vertical-align: inherit;">始まり</font><font style="vertical-align: inherit;">ます</font></font><code>$0302-$0303</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードがメモリにロードされると、アドレスから開始して</font></font><code>$02E6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、値が</font><font style="vertical-align: inherit;">アドレス</font><font style="vertical-align: inherit;">に</font></font><code>$02E6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">書き込まれます</font></font><code>$0302-$0303</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この場所には特別な意味があります。「基本的な待機サイクル」へのポインタが含まれています（詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C64メモリカード</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を参照してください</font><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">PRGをダウンロードすると、PRGが上書きされる</font></font><code>$02E6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、ウォームリセット後のBASICインタープリターが待機ループに移動しようとすると、このループに入ることはなく、代わりにレンダリングプログラムに入ります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BASICの発売に伴うその他のトリック</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ペトリ</font><font style="vertical-align: inherit;">は、ゼロページで独自の定数を入力できる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のBASIC起動トリック</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">発見</font><font style="vertical-align: inherit;">しました。</font><font style="vertical-align: inherit;">この方法では、独自のトークン化されたBASIC開始シーケンスを手動で作成し、BASICプログラムの行番号に定数をエンコードします。</font><font style="vertical-align: inherit;">入力では、BASIC行番号ahem、つまり定数がアドレスに格納されます</font></font><code>$39-$3A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">とても賢い！</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ギミック5.カスタム制御フロー</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、1行だけを出力して実行を停止する、xループのわずかに簡略化したバージョンです。</font></font><br>
<br>
<pre><code class="plaintext hljs">        lda #39<font></font>
        sta x1<font></font>
xloop:<font></font>
        lda #$a0<font></font>
        ldx x1<font></font>
        sta $0400 + 24*40, x<font></font>
<font></font>
        adc yf<font></font>
        sta yf<font></font>
        bcc no_scroll<font></font>
        ; scroll screen up!<font></font>
        jsr $e8ea<font></font>
no_scroll:<font></font>
        dec x1<font></font>
        bpl xloop<font></font>
<font></font>
        ; intentionally halt at the end<font></font>
inf:    jmp inf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、間違いがあります。</font><font style="vertical-align: inherit;">最後のピクセルを描画すると、画面をスクロールできなくなります。</font><font style="vertical-align: inherit;">したがって、最後のピクセルを書き込んだ後にスクロールを停止するには、追加のブランチが必要です。</font></font><br>
<br>
<pre><code class="plaintext hljs">        lda #39<font></font>
        sta x1<font></font>
xloop:<font></font>
        lda #$a0<font></font>
        ldx x1<font></font>
        sta $0400 + 24*40, x<font></font>
<font></font>
        dec x1<font></font>
        ; skip scrolling if last pixel<font></font>
        bmi done<font></font>
<font></font>
        adc yf<font></font>
        sta yf<font></font>
        bcc no_scroll<font></font>
        ; scroll screen up!<font></font>
        jsr $e8ea<font></font>
no_scroll:<font></font>
        jmp xloop<font></font>
done:<font></font>
<font></font>
        ; intentionally halt at the end<font></font>
inf:    jmp inf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
制御フローは、Cコンパイラが構造化プログラムから生成するものと非常によく似ています。</font><font style="vertical-align: inherit;">最後のスクロールをスキップするコード</font></font><code>JMP abs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、3バイトを使用</font><font style="vertical-align: inherit;">する新しい命令</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">導入し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">条件付きジャンプは、直接アドレッシングで相対8ビットオペランドを使用してジャンプアドレスをエンコードするため、長さは2バイトのみです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JMPが「最後のスクロールをスキップする」のを回避するには、スクロール呼び出しをループの最上部に移動し、制御フロー構造を少し変更します。</font><font style="vertical-align: inherit;">Philipが実装した方法は次のとおりです。</font></font><br>
<br>
<pre><code class="plaintext hljs">        lda #39<font></font>
        sta x1<font></font>
scroll: jsr $e8ea<font></font>
xloop:<font></font>
        lda #$a0<font></font>
        ldx x1<font></font>
        sta $0400 + 24*40, x<font></font>
<font></font>
        adc yf<font></font>
        sta yf<font></font>
        dec x1     ; doesn't set carry!<font></font>
inf:    bmi inf    ; hang here if last pixel!<font></font>
        bcc xloop  ; next pixel if no scroll<font></font>
        bcs scroll ; scroll up and continue</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、1つの3バイトJMPが完全に削除され、他のJMPが2バイトの条件付きブランチに変換され、合計4バイトが節約されます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トリック6.ビット圧縮されたライン</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部の要素は、ラインスロープカウンターを使用せず、ビットを8ビット定数に圧縮します。</font><font style="vertical-align: inherit;">このようなパッケージは、ラインに沿ったピクセルの位置が8ピクセルの繰り返しパターンに対応するという事実に基づいています。</font></font><br>
<br>
<pre><code class="plaintext hljs">int mask = 0xB6; // 10110110<font></font>
uint8_t* dst = screenRAM;<font></font>
for (int x = 0; x &lt; 40; x++) {<font></font>
    dst[x] = 0xA0;<font></font>
    if (mask &amp; (1 &lt;&lt; (x&amp;7))) {<font></font>
        dst += 40; // go down a row<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、かなりコンパクトなアセンブラになります。</font><font style="vertical-align: inherit;">ただし、通常、傾斜カウンターのオプションはさらに小さくなります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">勝者</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィリップ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">の34バイトのコンテスト受賞プログラム</font></a><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">上記のトリックのほとんどは彼のコードでうまく機能します：</font></font><br>
<br>
<pre><code class="plaintext hljs">ov = $22 ; == $40, initial value for the overflow counter<font></font>
ct = $D5 ; == $27 / 39, number of passes. Decrementing, finished at -1<font></font>
lp = $D1 ; == $07C0, pointer to bottom line. Set by the kernal scroller<font></font>
<font></font>
        ; Overwrite the return address of the kernal loader on the stack<font></font>
        ; with a pointer to our own code<font></font>
<font></font>
        * = $01F8<font></font>
        .word scroll - 1<font></font>
<font></font>
scroll: jsr $E8EA    ; Kernal scroll up, also sets lp pointer to $07C0<font></font>
loop:   ldy ct	     ; Load the decrementing counter into Y (39 &gt; -1)<font></font>
        lda #$A0     ; Load the PETSCII block / black col / ov step value<font></font>
        sta $D020, y ; On the last two passes, sets the background black<font></font>
p1:     sta $07C0    ; Draw first block (left &gt; right line)<font></font>
        sta (lp), y  ; Draw second block (right &gt; left line)<font></font>
        inc p1 + 1   ; Increment pointer for the left &gt; right line<font></font>
        adc ov	     ; Add step value $A0 to ov<font></font>
        sta ov<font></font>
        dec ct	     ; Decrement the Y counter<font></font>
        bmi *	     ; If it goes negative, we're finished<font></font>
        bcc loop     ; Repeat. If ov didn't overflow, don't scroll<font></font>
        bcs scroll   ; Repeat. If ov overflowed, scroll</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、なぜ34バイトに留まるのでしょうか。</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンテストが終了するとすぐに、全員がコードとメモを共有し、さらに改善する方法について一連の活発な議論が行われました。</font><font style="vertical-align: inherit;">締め切り後、さらにいくつかのオプションが提示されました：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィリップ-33バイト</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィリップ-32バイト</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ペトリ-31バイト</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィリップ-29バイト</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必ず確認してください-本物の真珠がいくつかあります。</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
読んでくれてありがとう。</font><font style="vertical-align: inherit;">参加してくれたMatlev、Phil、Geir、Petri、Jamie、Ian、Davidに特に感謝します（誰も見逃さなかったことを願っています-Twitterですべての言及を追跡するのは本当に困難でした！）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS Petriは私のコンテストを「年次」と呼んだので、うーんたぶん来年お会いしましょう。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja464367/index.html">そして、もう1つのSteam Windowsクライアントのローカル権限エスカレーション0day</a></li>
<li><a href="../ja464369/index.html">どのブロッカーを使用していますか？結果</a></li>
<li><a href="../ja464371/index.html">アプリケーションのパフォーマンスに悪影響を与える可能性があるため、Kubernetesポッド、ndotsの/etc/resolv.conf：5オプション</a></li>
<li><a href="../ja464373/index.html">Androidのエッジツーエッジ：正しく実行する</a></li>
<li><a href="../ja464375/index.html">検索エンジンの仕組み</a></li>
<li><a href="../ja464381/index.html">目撃者の目を通したアラスカへの旅、またはKDD'19</a></li>
<li><a href="../ja464383/index.html">直接の手の森があるプロジェクトで物事を整理する方法（tslint、prettierなどの設定）</a></li>
<li><a href="../ja464385/index.html">C ++の究極のケースとしてのPython。パート1/2</a></li>
<li><a href="../ja464387/index.html">ビデオゲームのスカンジナビアの物語のロシアの足跡、終了</a></li>
<li><a href="../ja464391/index.html">ハッカー会議からの10の興味深いレポート</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>