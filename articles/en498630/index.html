<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôé ü§∂üèΩ üèì Physical simulation of hundreds of thousands of particles on Unity + DOTS ü§∞üèΩ üë£ ü¶É</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At one point, while wandering around the expanses of the World Wide Web on one of the sites, I discovered an interactive JS element - a picture made u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Physical simulation of hundreds of thousands of particles on Unity + DOTS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498630/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At one point, while wandering around the expanses of the World Wide Web on one of the sites, I discovered an interactive JS element - a picture made up of particles flying apart as the mouse cursor approached. </font><font style="vertical-align: inherit;">There was a desire to program a simulation of such behavior on Unity and check what performance can be squeezed out of the engine. </font><font style="vertical-align: inherit;">I am sharing with you technical solutions and my observations received during the implementation process.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nj/dl/cv/njdlcvymmooeqpufewcyt-mzb9m.png" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result is as follows:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Animation</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/zi/ik/k3/ziikk35cekb2ju-m5korvwfdj-s.gif"><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to achieve it, you need to solve the following problems:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">describe particle physics;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ensure the optimal speed of position calculation on each frame;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">choose a way to quickly draw a large number of particles on the screen.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Physics</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To describe the desired particle behavior, we need to formulate only three principles: the desire to reduce the distance to the starting point, the desire to "fly away" from the mouse cursor and the damping of the movement. </font><font style="vertical-align: inherit;">We do not need exact physical interactions and formulas, we only need general principles, moving in accordance with which the particle will behave in a deliberate manner. </font><font style="vertical-align: inherit;">For simplicity, mass is excluded from all formulas - we agree to consider it to be single.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reducing the distance to the starting position</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for the particle to strive to return to its original position, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hooke's law</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will suit us </font><font style="vertical-align: inherit;">: the force directed towards the initial position will be linearly proportional to the distance to it. </font><font style="vertical-align: inherit;">The particle flew away two times farther from the initial position - two times stronger it ‚Äúpulls‚Äù backward, everything is simple.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The distance from the cursor</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To be interesting, the particles must somehow interact with the cursor, allow themselves to "push" from the starting position. </font><font style="vertical-align: inherit;">I took </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gravity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the opposite sign as the </font><font style="vertical-align: inherit;">basis for this interaction </font><font style="vertical-align: inherit;">: particles will be repelled by a force inversely proportional to the square of the distance between the position of the mouse cursor and the current position of the particle and directed along the vector from the cursor to the particle.</font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>F</mi><mo>=</mo><mo>&amp;#x2212;</mo><mi>C</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><msup><mi>r</mi><mn>2</mn></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.679ex" height="2.884ex" viewBox="0 -916.9 5028.5 1241.8" role="img" focusable="false" style="vertical-align: -0.755ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-46" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-3D" x="1027" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2212" x="2083" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-43" x="2862" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2F" x="3622" y="0"></use><g transform="translate(4123,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-72" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-32" x="638" y="513"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F</font></font></mi><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></mo><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></mo><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mrow class="MJX-TeXAtom-ORD"><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/</font></font></mo></mrow><msup><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></mi><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></mn></msup></math></span></span><script type="math/tex" id="MathJax-Element-1">F = -C/r^2</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.766ex" height="2.134ex" viewBox="0 -809.3 760.5 918.9" role="img" focusable="false" style="vertical-align: -0.255ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-43" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi></math></span></span><script type="math/tex" id="MathJax-Element-2">C</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a certain constant that regulates the interaction.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attenuation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we restrict ourselves to the two previous formulas, the particle after setting the initial amplitude will oscillate forever, because there is nowhere to lose energy in the framework of such a model. </font><font style="vertical-align: inherit;">We will simulate the attenuation as the force of the viscous resistance of the medium, which, according </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the Stokes law</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , is linearly proportional to the particle velocity and directed in the opposite direction to the motion. </font><font style="vertical-align: inherit;">We are satisfied with the restrictions imposed on the applicability of this formula, since in this case we are not interested in the absolute accuracy of the physical interaction, but only on the principle.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Result</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we obtain the formula of the force acting on the particle at an arbitrary moment in time:</font></font><br>
<p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>F</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mi>s</mi></msub><mo>=</mo><msub><mi>C</mi><mi>a</mi></msub><mo>&amp;#x2217;</mo><mo stretchy=&quot;false&quot;>(</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mo>&amp;#x2212;</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mn>0</mn></msub><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2212;</mo><mfrac><msub><mi>C</mi><mi>r</mi></msub><mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mo>&amp;#x2212;</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mi>r</mi></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><msup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mn>2</mn></msup></mrow></mfrac><mo>&amp;#x2217;</mo><mfrac><mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mo>&amp;#x2212;</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mi>r</mi></msub></mrow><mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mo>&amp;#x2212;</mo><msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>x</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mi>r</mi></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo stretchy=&quot;false&quot;>|</mo></mrow></mrow></mfrac><mo>&amp;#x2212;</mo><msub><mi>C</mi><mi>d</mi></msub><mo>&amp;#x2217;</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mover><mi>v</mi><mo stretchy=&quot;false&quot;>&amp;#x2192;</mo></mover></mrow><mo>,</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="54.689ex" height="6.384ex" viewBox="0 -1508.9 23546.5 2748.8" role="img" focusable="false" style="vertical-align: -2.88ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-46" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="761" y="246"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-73" x="1078" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-3D" x="1472" y="0"></use><g transform="translate(2528,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-61" x="1011" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2217" x="3940" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-28" x="4663" y="0"></use><g transform="translate(5052,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="549" y="8"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2212" x="5847" y="0"></use><g transform="translate(6848,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="549" y="8"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-30" x="809" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-29" x="7874" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2212" x="8486" y="0"></use><g transform="translate(9264,0)"><g transform="translate(342,0)"><rect stroke="none" width="4475" height="60" x="0" y="220"></rect><g transform="translate(1670,676)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-72" x="1011" y="-213"></use></g><g transform="translate(60,-925)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-7C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-7C" x="278" y="0"></use><g transform="translate(557,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="549" y="8"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2212" x="1351" y="0"></use><g transform="translate(2352,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="549" y="8"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-72" x="809" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-7C" x="3344" y="0"></use><g transform="translate(3622,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-7C" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-32" x="393" y="675"></use></g></g></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2217" x="14424" y="0"></use><g transform="translate(14925,0)"><g transform="translate(342,0)"><rect stroke="none" width="4021" height="60" x="0" y="220"></rect><g transform="translate(617,676)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="549" y="8"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2212" x="794" y="0"></use><g transform="translate(1795,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="549" y="8"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-72" x="809" y="-213"></use></g></g><g transform="translate(60,-726)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-7C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-7C" x="278" y="0"></use><g transform="translate(557,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="549" y="8"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2212" x="1351" y="0"></use><g transform="translate(2352,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="549" y="8"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-72" x="809" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-7C" x="3344" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-7C" x="3622" y="0"></use></g></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2212" x="19630" y="0"></use><g transform="translate(20631,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-64" x="1011" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2217" x="22039" y="0"></use><g transform="translate(22761,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-76" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-20D7" x="505" y="9"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2C" x="23268" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></mi></msub><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></mo><msub><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></mi></msub><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚àó</font></font></mo><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(</font></font></mo><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></mo><msub><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></mn></msub><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></mo><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></mo><mfrac><msub><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></mi></msub><mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></mo></mrow><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></mo><msub><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></mi></msub><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></mo></mrow><msup><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></mo></mrow><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></mn></msup></mrow></mfrac><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚àó</font></font></mo><mfrac><mrow><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></mo><msub><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></mi></msub></mrow><mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></mo></mrow><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></mo><msub><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></mi></msub><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></mo></mrow><mrow class="MJX-TeXAtom-ORD"><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></mo></mrow></mrow></mfrac><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></mo><msub><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></mi></msub><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚àó</font></font></mo><mrow class="MJX-TeXAtom-ORD"><mover><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v</font></font></mi><mo stretchy="false"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Üí</font></font></mo></mover></mrow><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-3">\vec{F}_s=C_a*(\vec{x}-\vec{x}_0)-\frac{C_r}{||\vec{x}-\vec{x}_r||^2}*\frac{\vec{x}-\vec{x}_r}{||\vec{x}-\vec{x}_r||}-C_d*\vec{v},</script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi><mo>,</mo><mi>v</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.491ex" height="1.884ex" viewBox="0 -540.2 1503.2 811.3" role="img" focusable="false" style="vertical-align: -0.63ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2C" x="572" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-76" x="1017" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></mo><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v</font></font></mi></math></span></span><script type="math/tex" id="MathJax-Element-4">x, v</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - current position and particle velocity, </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>x</mi><mn>0</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.384ex" height="1.884ex" viewBox="0 -540.2 1026.4 811.3" role="img" focusable="false" style="vertical-align: -0.63ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-30" x="809" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mn><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-5">x_0</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - starting position </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>x</mi><mi>r</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.303ex" height="1.759ex" viewBox="0 -540.2 991.8 757.5" role="img" focusable="false" style="vertical-align: -0.505ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-78" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-72" x="809" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-6">x_r</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - cursor position, </font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>C</mi><mi>a</mi></msub><mo>,</mo><msub><mi>C</mi><mi>r</mi></msub><mo>,</mo><msub><mi>C</mi><mi>d</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.221ex" height="2.509ex" viewBox="0 -809.3 4400.7 1080.4" role="img" focusable="false" style="vertical-align: -0.63ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-61" x="1011" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2C" x="1189" y="0"></use><g transform="translate(1635,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-72" x="1011" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMAIN-2C" x="2769" y="0"></use><g transform="translate(3215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/498630/&amp;usg=ALkJrhgVgBH8tWi9MchkIILMPlvnKwybqA#MJMATHI-64" x="1011" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></mi></msub><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></mo><msub><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r</font></font></mi></msub><mo><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font></mo><msub><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></mi><mi><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d</font></font></mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-7">C_a, C_r, C_d</script><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - coefficients of attraction, repulsion and attenuation, respectively.</font></font><a name="Equation"></a><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another animation</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/ae/i5/21/aei521dteubbenx4oiceuk9wnfw.gif"><br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programming behavior</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since in our model the particles are independent of each other, and their behavior is determined solely by their characteristics and common constants, the calculation of the updated state is ideally suited for parallelization. </font><font style="vertical-align: inherit;">Taking into account my long-standing interest in Unity </font></font><abbr title="Data Oriented Technology Stack"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DOTS</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I decided to apply this technology to solve the formulated problem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DOTS is a relatively recent development of the Unity engine, a technology stack focused on writing high-performance multi-threaded code. </font><font style="vertical-align: inherit;">On Habr√© there is a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translation of an</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> introductory article in DOTS. </font><font style="vertical-align: inherit;">Thanks to the use of the </font></font><abbr title="Entity Component System"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ECS</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Jobs System </font><font style="vertical-align: inherit;">architectural pattern </font><font style="vertical-align: inherit;">and the Burst compiler, DOTS makes it possible to write fast multi-threaded code, while reducing the likelihood of a shot in the foot.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The essence of writing a program within the </font></font><abbr title="Entity Component System"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ECS</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is to separate the code into components ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Components</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) that describe the state, systems ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Systems</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) that describe the behavior and interaction of components, and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entities</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - objects that contain a set of components.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Components</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will need the following components:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//    ( )</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> AttractorPosData : IComponentData<font></font>
{<font></font>
   <span class="hljs-keyword">public</span> float2 Value;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> VelocityData : IComponentData<font></font>
{<font></font>
   <span class="hljs-keyword">public</span> float2 Value;<font></font>
} <font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> AccelerationData : IComponentData<font></font>
{<font></font>
   <span class="hljs-keyword">public</span> float2 Value;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> ParticleData : IComponentData <font></font>
{<font></font>
    <span class="hljs-keyword">public</span> Color color;
    <span class="hljs-keyword">public</span> Matrix4x4 matrix;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With components, everything is quite simple, go to the systems:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">//   </span>
[<span class="hljs-meta">UpdateBefore(typeof(MoveSystem))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VelocityUpdateSystem</span> : <span class="hljs-title">SystemBase</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnUpdate</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> time = Time.DeltaTime;<font></font>
        Entities.ForEach((<span class="hljs-keyword">ref</span> VelocityData velocity, 
                <span class="hljs-keyword">in</span> AccelerationData acceleration) =&gt;<font></font>
            {<font></font>
                velocity.Value += time * acceleration.Value;<font></font>
            })<font></font>
            .ScheduleParallel();<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MoveSystem</span> : <span class="hljs-title">SystemBase</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnUpdate</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> time = Time.DeltaTime;<font></font>
        Entities.ForEach((<span class="hljs-keyword">ref</span> Translation t, <span class="hljs-keyword">in</span> VelocityData velocity) =&gt;<font></font>
            {<font></font>
                t.Value.xy += time * velocity.Value;<font></font>
            })<font></font>
            .ScheduleParallel();<font></font>
    }<font></font>
}<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can control the sequence of systems using attributes </font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">UpdateBeforeAttribute</span>]<font></font>
[<span class="hljs-meta">UpdateAfterAttribute</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The largest system that describes the behavior will be the acceleration update system, acting in accordance with the derived </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">formula</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">UpdateBefore(typeof(VelocityUpdateSystem))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AccelerationSystem</span> : <span class="hljs-title">SystemBase</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnUpdate</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        float2 repulsorPos = Globals.Repulsor.Position;<font></font>
<font></font>
        <span class="hljs-comment">//   </span>
        <span class="hljs-keyword">var</span> attractionPower = Globals.SettingsHolder.SettingsModel.Attraction;
        <span class="hljs-comment">//  </span>
        <span class="hljs-keyword">var</span> repulsionPower = Globals.SettingsHolder.SettingsModel.Repulsion;
        <span class="hljs-comment">//  </span>
        <span class="hljs-keyword">var</span> dampingPower = Globals.SettingsHolder.SettingsModel.Damping;<font></font>
        Entities.ForEach((<font></font>
                <span class="hljs-keyword">ref</span> AccelerationData acceleration, 
                <span class="hljs-keyword">in</span> AttractorPosData attractorPos, 
                <span class="hljs-keyword">in</span> Translation t,
                <span class="hljs-keyword">in</span> VelocityData velocity) =&gt;<font></font>
            {<font></font>
                <span class="hljs-comment">//  </span>
                <span class="hljs-keyword">var</span> attraction = (attractorPos.Value - t.Value.xy) * attractionPower;<font></font>
<font></font>
                <span class="hljs-keyword">var</span> distSqr = math.distancesq(repulsorPos, t.Value.xy);
                <span class="hljs-comment">//  </span>
                <span class="hljs-keyword">var</span> repulsion = -math.normalizesafe(repulsorPos - t.Value.xy) <font></font>
                    / distSqr * repulsionPower;<font></font>
<font></font>
                <span class="hljs-comment">//  </span>
                <span class="hljs-keyword">var</span> damping = -velocity.Value * dampingPower;<font></font>
<font></font>
                acceleration.Value = attraction + repulsion + damping;<font></font>
            })<font></font>
            .ScheduleParallel();<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Render</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the potentially huge number of particles that need to be displayed, for all you can use the same square mesh of two polygons, as well as the same material, which would make it possible to render them all in one draw call, if not for one ‚Äú but ‚Äù: all particles, in general, have different colors, otherwise the resulting picture will be very boring. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The standard Unity shader </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúSprites / Default‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPU Instancing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to optimize the rendering of objects with unequal sprites and colors, combining them into one draw call, but in this case, a link to the texture and color for each specific object must be set from a script, to which from ECS we do not have access. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The solution may be the </font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Graphics.DrawMeshInstanced</font></a></i><font style="vertical-align: inherit;"> method</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which allows you to draw one mesh several times in one draw call with different material parameters, using the same GPU Instancing. </font><font style="vertical-align: inherit;">It looks like this:</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">UpdateAfter(typeof(TrsMatrixCalculationSystem))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SpriteSheetRenderer</span> : <span class="hljs-title">SystemBase</span><font></font>
{<font></font>
    <span class="hljs-comment">// DrawMeshInstanced     1023    </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> BatchCount = <span class="hljs-number">1023</span>;
    <span class="hljs-comment">//   </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> List&lt;Matrix4x4&gt; _matrixList = <span class="hljs-keyword">new</span> List&lt;Matrix4x4&gt;(BatchCount);
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> List&lt;Vector4&gt; _colorList = <span class="hljs-keyword">new</span> List&lt;Vector4&gt;(BatchCount);<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnUpdate</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> materialPropertyBlock = <span class="hljs-keyword">new</span> MaterialPropertyBlock();
        <span class="hljs-keyword">var</span> quadMesh = Globals.Quad;
        <span class="hljs-keyword">var</span> material = Globals.ParticleMaterial;<font></font>
<font></font>
        <span class="hljs-comment">//        </span>
        <span class="hljs-comment">//   </span>
        <span class="hljs-keyword">var</span> shaderPropertyId = Shader.PropertyToID(<span class="hljs-string">"_Color"</span>);<font></font>
<font></font>
        <span class="hljs-keyword">var</span> entityQuery = GetEntityQuery(<span class="hljs-keyword">typeof</span>(ParticleData));
        <span class="hljs-comment">//   ,   ParticleData</span>
        <span class="hljs-keyword">var</span> animationData = <font></font>
                   entityQuery.ToComponentDataArray&lt;ParticleData&gt;(Allocator.TempJob);<font></font>
        <span class="hljs-keyword">var</span> layer = LayerMask.NameToLayer(<span class="hljs-string">"Particles"</span>);<font></font>
<font></font>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> meshCount = <span class="hljs-number">0</span>; <font></font>
              meshCount &lt; animationData.Length; <font></font>
              meshCount += BatchCount)<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> batchSize = math.min(BatchCount, animationData.Length - meshCount);<font></font>
            _matrixList.Clear();<font></font>
            _colorList.Clear();<font></font>
<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = meshCount; i &lt; meshCount + batchSize; i++)<font></font>
            {<font></font>
                _matrixList.Add(animationData[i].matrix);<font></font>
                _colorList.Add(animationData[i].color);<font></font>
            }<font></font>
<font></font>
            materialPropertyBlock.SetVectorArray(shaderPropertyId, _colorList);<font></font>
            Graphics.DrawMeshInstanced(<font></font>
                quadMesh,<font></font>
                <span class="hljs-number">0</span>,<font></font>
                material,<font></font>
                _matrixList,<font></font>
                materialPropertyBlock,<font></font>
                ShadowCastingMode.Off, <span class="hljs-literal">false</span>, layer);<font></font>
        }<font></font>
<font></font>
        animationData.Dispose();<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to render a group of objects using this method, you need to collect an array of transition matrices and those material properties that are supposed to be varied. </font><font style="vertical-align: inherit;">The rendering system, as you can see, runs after the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TrsMatrixCalculationSystem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - an auxiliary system that calculates the transition matrix for each of the particles, which looks very simple:</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">UpdateAfter(typeof(MoveSystem))</span>]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TrsMatrixCalculationSystem</span> : <span class="hljs-title">SystemBase</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnUpdate</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        <span class="hljs-comment">//   scale   </span>
        <span class="hljs-keyword">var</span> scale = Globals.SettingsHolder.SettingsModel.ParticlesScale;<font></font>
        Entities.ForEach((<span class="hljs-keyword">ref</span> ParticleData data, <span class="hljs-keyword">in</span> Translation translation) =&gt;<font></font>
            {<font></font>
                data.matrix = Matrix4x4.TRS(translation.Value, Quaternion.identity,<font></font>
                    <span class="hljs-keyword">new</span> Vector3(scale, scale, scale));<font></font>
            })<font></font>
            .ScheduleParallel();<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Animation of 46,000 particles</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/2z/ji/yk/2zjiykutabsgl4pg6qpuphxxsw0.gif"><br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's time to talk about why (besides, of course, aesthetic satisfaction) this was all up to. </font><font style="vertical-align: inherit;">In Unity, at the moment, there is an opportunity to choose from two </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripting Backend</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><abbr title="Common language runtime"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CLR</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementations </font><font style="vertical-align: inherit;">): the good old </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mono</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and a more modern solution from Unity developers - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IL2CPP</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compare the build performance for these two runtime implementations:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The number of particles on the screen</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Average frame rate, Mono</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Average frame rate, IL2CPP</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50,000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">128</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">66</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">130</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">200,000</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">57</font></font></td>
</tr>
</tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PC specifications: </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QHD 2560x1440 </font></font></i><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intel Core i5-9600K </font></font></i><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16GB RAM </font></font></i><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSI GeForce RTX 2080 SUPER VENTUS XS OC 8.0 GB </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/oq/aq/yh/oqaqyh3frvpelp5-wqq4pt2qjl4.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">160,000 particles</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It is noticeable that, in this spherical vacuum experiment, IL2CPP outperforms Mono about twice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the profiler, literally all the time spent on the frame is spent on the rendering system, the calculations of the other systems are practically ‚Äúfree‚Äù: </font></font><br>
<img src="https://habrastorage.org/webt/fe/ap/6y/feap6y37oxytyf3acvhpn_h6_us.png"> <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unity Editor </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/a2/pv/i6/a2pvi6zlukwnxderl4zk6k2fg6u.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It is noticeable that most of the time is spent on the process of converting color from </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Color</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vector4</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and adding to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">list.Add ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We can easily get rid of the first one - we will postpone the transformation at the moment of particle generation, since the color does not change in the process:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-comment">// </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> ParticleData : IComponentData<font></font>
{<font></font>
    <span class="hljs-keyword">public</span> Color color;
    <span class="hljs-keyword">public</span> Matrix4x4 matrix;<font></font>
}<font></font>
<span class="hljs-comment">// </span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> ParticleData : IComponentData<font></font>
{<font></font>
    <span class="hljs-keyword">public</span> Vector4 color;
    <span class="hljs-keyword">public</span> Matrix4x4 matrix;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This change allowed us to completely get rid of the expensive conversion operation: The </font></font><img src="https://habrastorage.org/webt/su/kz/fk/sukzfklw-xmgirni-jbtc0fw5qw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
number of frames per second for 200,000 particles after it increased to 61. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is possible to optimize the filling of lists, for example, to store all arrays of colors, generating them once, but this solution does not seem elegant to me, therefore I will be glad to constructive suggestions in the comments.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ECS in general and Unity DOTS in particular are great tools for specific scenarios and task classes. </font><font style="vertical-align: inherit;">They perform their role in efficiently processing a huge amount of data and allow you to create simulations, which in their absence would have taken much more effort. </font><font style="vertical-align: inherit;">However, do not consider DOTS as a ‚Äúsilver bullet‚Äù and throw stones at developers who adhere to traditional Unity concepts in new projects - DOTS is not for everyone and not for every task.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everyone can get acquainted with the project in my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github repository</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but how to install the build as a desktop wallpaper in </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wallpaper Engine</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498614/index.html">Analysis of a series of promotional videos for the game Spin Voyage</a></li>
<li><a href="../en498618/index.html">Android in an industrial controller</a></li>
<li><a href="../en498620/index.html">Touching the world: human skin receptor biomechanics</a></li>
<li><a href="../en498624/index.html">[Instruction] Creating Google tests (Google forms)</a></li>
<li><a href="../en498628/index.html">How to build a rocket accelerator for PowerCLI scripts¬†</a></li>
<li><a href="../en498632/index.html">Peptide for a beautiful mulatto</a></li>
<li><a href="../en498634/index.html">11 stupid questions to an orthopedist and masseuse about working at a computer and not only</a></li>
<li><a href="../en498636/index.html">Simple shader for point lights in fog</a></li>
<li><a href="../en498638/index.html">3D arcade in the browser: how we made the game on React + Redux</a></li>
<li><a href="../en498642/index.html">Geeek Club: how we raised $ 137,000 on Kickstarter for a DIY PCB designer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>