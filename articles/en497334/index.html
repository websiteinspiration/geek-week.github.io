<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úèÔ∏è üëáüèø üë©üèª‚Äçüåæ The notorious bugs and how to avoid them on the example of ClickHouse üèÇüèª ‚óºÔ∏è üïö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are writing code, get ready for problems. They will definitely be, and they should be expected from all sides: from your code and compiler, fro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The notorious bugs and how to avoid them on the example of ClickHouse</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/497334/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are writing code, get ready for problems. </font><font style="vertical-align: inherit;">They will definitely be, and they should be expected from all sides: from your code and compiler, from the operating system and hardware, and users sometimes throw up ‚Äúsurprises‚Äù. </font><font style="vertical-align: inherit;">If you scaled the cluster to cosmic scales, then expect "space" bugs. </font><font style="vertical-align: inherit;">Especially when it comes to data from Internet traffic.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ooBAQIe0KlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexey Milovidov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o6CuFl2Q</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) will talk about the most ridiculous, discouraging and hopeless problems from his experience in developing and supporting ClickHouse. </font><font style="vertical-align: inherit;">Let's see how they had to be debugged and what measures the developers should take from the very beginning, so that there would be less problems.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notorious bugs</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you wrote some code, get ready for problems right away. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Errors in the code.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> They will be required. But let's say you wrote the perfect code, compiled, but bugs will appear </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the compiler</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the code will not work correctly. We fixed the compiler, everything compiled - run it. But (unexpectedly) everything works incorrectly, because </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there are bugs in the kernel of the OS too</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If there are no bugs in the OS, inevitably, they will be </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in hardware</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Even if you wrote the perfect code that works perfectly on the perfect hardware, you will still encounter problems, for example, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configuration errors</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It would seem that you did everything right, but someone made a mistake in the configuration file, and everything does not work again.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When all the bugs have been fixed, users will finish it, because they constantly use your code ‚Äúincorrectly‚Äù. </font><font style="vertical-align: inherit;">But the problem is definitely not in the users, but in the code: you </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wrote something that is difficult to use</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at these bugs with a few examples.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration bugs</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deletion of data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The first case from practice. Fortunately, not mine and not Yandex, do not worry. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introductory first. The map-reduce architecture of a cluster (such as Hadoop) consists of several data servers (data nodes) that store data, and one or more master servers that know the location of all the data on the servers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data nodes know the address of the master and connect to it. The wizard monitors where and what data should be located, and gives different commands to the data nodes: ‚ÄúDownload the data X, you must have the data Y, and delete the data Z‚Äù. What could go wrong?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When a new configuration file was uploaded to all data nodes, they mistakenly connected to the master from another cluster, and not to their own. </font><font style="vertical-align: inherit;">The master looked at the data about which the data nodes were informed, decided that the data was incorrect and should be deleted. </font><font style="vertical-align: inherit;">The problem was noticed when half of the data was erased.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/ii/6i/s8ii6igrww4j3zdjhrfyyqrl2nk.png" width="350"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most epic bugs are those that lead to inadvertent data deletion.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avoiding this is very simple. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not delete data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For example, put aside in a separate directory or delete with a delay. First, we transfer so that they are not visible to the user, and if he finds that something has disappeared within a few days, we will return it back. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not delete unexpected data if the cause is unknown</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Programmatically limit the start of deletion of unknown data: unexpected, with strange names, or if there are too many of them. The administrator will notice that the server does not start and writes some message, and will understand. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the program performs destructive actions - isolate testing and production at the network level</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(iptables). For example, deleting files or sending e-mail is a destructive action because it will ‚Äúeat up‚Äù someone's attention. Put a threshold on them: a hundred letters can be sent, and for a thousand put a safety checkbox, which is set before something terrible happens. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurations</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The second example is already from my practice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One good company somehow had a strange ClickHouse cluster. The strangeness was that the replicas did not synchronize. When the server was restarted, it did not start and a message appeared that all the data was incorrect: ‚ÄúThere are a lot of unexpected data, I will not start. We must set the flag </font></font><code>force_restore_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and figure it out. ‚Äù</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nobody could figure it out in the company - they just set the flag. At the same time, half of the data disappeared somewhere, resulting in charts with gaps. The developers turned to me, I thought something interesting was happening, and decided to investigate. When morning came a few hours later and the birds started to sing outside the window, I realized that I didn‚Äôt understand anything. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ClickHouse server uses the ZooKeeper service for coordination. ClickHouse stores data, and ZooKeeper determines which servers what data should lie on: stores metadata about what data on which replica should be. ZooKeeper is also a cluster - it replicates according to a very good distributed consensus algorithm, with strict consistency.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a rule, ZooKeeper is 3 machines, sometimes 5. In the ClickHouse configuration all machines are indicated at once, the connection is established with a random machine, interacts with it, and this server replicates all requests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What happened? The company had three ZooKeeper servers. But they did not work as a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cluster of three nodes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but as </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">three independent nodes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äî three clusters from one node. One ClickHouse connects to one server and writes data. The replicas want to download this data, but they are nowhere to be found. When restarting, the server connects to another ZooKeeper: it sees that the data with which it worked before is superfluous, it must be postponed somewhere. He does not delete them, but transfers them to a separate directory - in ClickHouse data is not so easily deleted.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decide to fix the ZooKeeper configuration. </font><font style="vertical-align: inherit;">I rename all the data and make a request for </font></font><code>ATTACH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parts of the data from the directory </font></font><code>detached/unexpeted_*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, all the data was restored, the replicas were synchronized, there were no losses, the graphs were continuous. </font><font style="vertical-align: inherit;">The company is satisfied, thankful, as if they had already forgotten how everything had worked badly before. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These were simple configuration bugs. </font><font style="vertical-align: inherit;">More bugs will be in the code.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bugs in the code</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We write code in C ++. </font><font style="vertical-align: inherit;">This means that we already have problems.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next example is a real bug from production on </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Yandex.Metrica cluster</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2015) - a consequence of the C ++ code. </font><font style="vertical-align: inherit;">The bug was that sometimes the user instead of responding to the request received an error message:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúChecksum doesn't match, corrupted data‚Äù - the check sum does not match, the data is broken - scary!</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LRUCache became inconsistent. </font><font style="vertical-align: inherit;">There must be a bug in it ‚Äù- the cache became inconsistent, most likely a bug in it.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code we wrote informs itself that there is a bug there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
" </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Checksum doesn't match, corrupted data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ." </font><font style="vertical-align: inherit;">Check sums of compressed data blocks are checked before being decompressed. </font><font style="vertical-align: inherit;">Usually this error appears when data is broken on the file system. </font><font style="vertical-align: inherit;">For various reasons, some files turn out to be garbage when the server is restarted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But here is another case: I read the file manually, the check sum matches, there is no error. </font><font style="vertical-align: inherit;">Once appeared, the error is stably reproduced upon repeated request. </font><font style="vertical-align: inherit;">When the server restarts, the error disappears for a while, and then again appears stably. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps the matter is in RAM? </font><font style="vertical-align: inherit;">A typical situation is when bits are beating in it. </font><font style="vertical-align: inherit;">I look in </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dmesg</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(kern.log), but there is no machine check exceptions - they usually write when something is wrong with RAM. If the server had beaten RAM, then not only my program would work incorrectly, but all the others would generate errors randomly. However, there are no other manifestations of the error. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LRUCache became inconsistent. There must be a bug in it. "</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This is a clear mistake in the code, and we are writing in C ++ - perhaps memory access? But tests under AddressSanitizer, ThreadSanitizer, MemorySanitizer, UndefinedBehaviorSanitizer in CI show nothing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps some test cases are not covered? I collect the server with AddressSanitizer, run it on production - it catches nothing. For some time, the error is cleared by resetting some mark cache (sachet cache).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the programming rules says: if it‚Äôs not clear what the bug is, look closely at the code, hoping to find something there. I did so, found a bug, fixed it - it did not help. I look at another place in the code - there is also a bug. Corrected, again did not help. I fixed a few more, the code got better, but the error still didn't disappear! </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cause.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Trying to find a pattern by server, by time, by the nature of the load - nothing helps. Then he realized that the problem manifests itself only on one of the clusters, and never on the others. The error is not reproduced so often, but it always appears on one cluster after a restart, and everything is clean on the other. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out that the reason is that on the ‚Äúproblem‚Äù cluster they used a new feature - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cache dictionaries</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">They use the hand-written memory </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allocator ArenaWithFreeLists</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We not only write in C ++, but also saw some kind of custom allocators - we doom ourselves to problems twice. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ArenaWithFreeLists is a part of memory in which memory is allocated consecutively in sizes divisible by two: 16, 32, 64 bytes. </font><font style="vertical-align: inherit;">If memory is freed, then they form a singly linked list of free FreeLists blocks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at the code.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArenaWithFreeLists</span>
{</span>
    Block * free_lists[<span class="hljs-number">16</span>] {};
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">sizeToPreviousPowerOfTwo</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">return</span> _bit_scan_reverse(size - <span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">char</span> * <span class="hljs-title">alloc</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> size)</span>
    </span>{
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> list_idx = findFreeListIndex(size);<font></font>
        free_lists[list_idx] -&gt;...<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It uses a function </font></font><code>_bit_scan_reverse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with an underscore at the beginning.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is an unwritten rule: ‚ÄúIf a function has one underscore at the beginning, read the documentation on it once, and if two, read it twice.‚Äù</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We listen and read the documentation: ‚Äúint _bit_scan_reverse (int a). Set dst to the index of the highest set bit in 32-bit integer a. If no bits are set in a then dst is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">undefined</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . " We seem to have found a problem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In C ++, this situation is considered impossible for the compiler. The compiler can use undefined behavior, this ‚Äúimpossibility‚Äù, as an assumption for optimizing the code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The compiler does nothing wrong - it honestly generates assembly instructions </font></font><code>bsr %edi, %eax</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. But, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if the operand is zero, the instruction has </font></font></strong><code><strong>bsr</strong></code><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">undefined behavior not at the C ++ level, but at the CPU level.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If the source register is zero, then the destination register does not change: there was some garbage at the input, this garbage will also remain at the output.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result depends on where the compiler puts this instruction. </font><font style="vertical-align: inherit;">Sometimes a function with this instruction is inline, sometimes not. </font><font style="vertical-align: inherit;">In the second case there will be something like this code:</font></font><br>
<br>
<pre><code class="cpp hljs">bsrl %edi, %eax<font></font>
retq</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then I looked at an example of similar code in my binary using </font></font><code>objdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lq/6k/4f/lq6k4fg0lwpm2nhwhxbyauyjt2c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the results, I see that sometimes the source register and destination register are the same. </font><font style="vertical-align: inherit;">If there was zero, then the result will also be zero - everything is fine. </font><font style="vertical-align: inherit;">But sometimes the registers are different, and the result will be garbage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How does this bug manifest itself?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We use garbage as an index in the FreeLists array. </font><font style="vertical-align: inherit;">Instead of an array, we go to some distant address and get memory access.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are lucky, almost all the addresses nearby are filled with data from the cache - we spoil the cache. </font><font style="vertical-align: inherit;">The cache contains file offsets.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We read files at the wrong offset. </font><font style="vertical-align: inherit;">From the wrong offset, we get the check sum. </font><font style="vertical-align: inherit;">But there is not a check-sum, but something else - this check-sum will not coincide with the following data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We get the error ‚ÄúChecksum doesn't match, corrupted data‚Äù.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, not data is corrupted, but only the cache in RAM. </font><font style="vertical-align: inherit;">We were immediately informed about the error, because we check-sum the data. </font><font style="vertical-align: inherit;">The error was </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corrected</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on December 27, 2015 and went to celebrate. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the wrong code can at least be fixed. </font><font style="vertical-align: inherit;">But how to fix bugs in hardware?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bugs in iron</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are not even bugs, but physical laws - inevitable effects. According to physical laws, iron is inevitably buggy. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non-atomic write to RAID</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For example, we created RAID1. It consists of two hard drives. This means that one server is a distributed system: data is written to one hard drive and to another. But what if data is written to one disc and power is lost while recording to the second? Data on a RAID1 array will not be consistent. We will not be able to understand which data is correct, because we will read one byte or the other. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can deal with this by placing the log. For example, in ZFS this problem is solved, but more on that later. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit rot on HDD and SSD</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Bits on hard drives and on SSDs can go bad just like that. Modern SSDs, especially those with multi-level cells, are designed to ensure that cells will constantly deteriorate. Error correction codes help, but sometimes the cells deteriorate so much and so much that even this does not save. Undetected errors are obtained. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit flips in RAM</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (but what about ECC?). In RAM in servers, bits are also corrupted. It also has error correction codes. When errors occur, they are usually visible from the messages in the Linux kernel log in dmesg. When there are many errors, we will see something like: "N million errors with memory have been fixed." But individual bits will not be noticed, and for sure something will be buggy. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bit flips at the CPU and network level</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . There are errors at the CPU level, in CPU caches and, of course, when transmitting data over a network.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How do iron errors usually manifest? The ticket ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A malformed znode prevents ClickHouse from starting</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù </font><font style="vertical-align: inherit;">comes to GitHub </font><font style="vertical-align: inherit;">- the data in the ZooKeeper node is corrupted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In ZooKeeper, we usually write some metadata in plain text. There is something wrong with him - " </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">replica</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " is written very strange. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8_/gk/zk/8_gkzkxlb1dzwhiph0saer-0d50.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It rarely happens that because of a bug in the code, one bit changes. Of course, we can write such a code: we take the Bloom filter, change the bit at certain addresses, calculate the addresses incorrectly, change the wrong bit, it falls on some data. That's it, now in ClickHouse it‚Äôs not ‚Äú </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">replica‚Äù</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but ‚Äú </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repli </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">b</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù and on it all the data is wrong. But usually, a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">change in one bit is a symptom of iron problems</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps you know the example of bitsquatting. </font><font style="vertical-align: inherit;">Artyom Dinaburg </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">made an experiment</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : there are domains on the Internet that have a lot of traffic, although users do not go to these domains on their own. </font><font style="vertical-align: inherit;">For example, such a domain FB-CDN.com is a Facebook CDN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artyom registered a similar domain (and many others), but changed one bit. </font><font style="vertical-align: inherit;">For example, FA-CDN.com instead of FB-CDN.com. </font><font style="vertical-align: inherit;">The domain was not published anywhere, but traffic came to it. </font><font style="vertical-align: inherit;">Sometimes the FB-CDN host was written in the HTTP headers, and the request went to another host due to errors in RAM on users' devices. </font><font style="vertical-align: inherit;">RAM with error correction does not always help. </font><font style="vertical-align: inherit;">Sometimes it even interferes and leads to vulnerabilities (read about Rowhammer, ECCploit, RAMBleed).</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion: always check-sum the data yourself.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When writing to the file system, check-sum without fail. </font><font style="vertical-align: inherit;">When transmitting over the network, also check-summarize - do not expect that there are any check-sums there.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More bugs! ..</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Production Cluster Metrics</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Users in response to a request sometimes get an exception: ‚ÄúChecksum doesn't match: corrupted data‚Äù - the check sum is not correct, the data is corrupted. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/lb/wz/jylbwzqxrbk-g3hgygq4bktgdr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The error message displays detailed data: what check amount was expected, what check amount is actually in this data, the size of the block for which we check the check amount and the exception context. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we received the packet over the network from some server, an exception appeared - it looks familiar. </font><font style="vertical-align: inherit;">Perhaps again passing through memory, race condition, or something else.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This exception appeared in 2015. The bug was fixed, it no longer appeared. In February 2019, he suddenly appeared again. At this time I was at one of the conferences, my colleagues dealt with the problem. The error was reproduced several times a day among 1000 servers with ClickHouse: it is not possible to collect statistics on one server, then on another. At the same time, there were no new releases at this time. It did not work out and solve the problem, but after a few days the error itself disappeared. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They forgot about the error, and on May 15, 2019, it repeated. We continued to deal with her. The first thing I did was look at all the available logs and graphs. He studied them all day, did not understand anything, did not find any patterns. If the problem cannot be reproduced, the only option is to collect all cases, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">look for patterns</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and addictions. </font><font style="vertical-align: inherit;">Perhaps the Linux kernel does not work correctly with the processor, incorrectly saves or loads any registers.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypotheses and patterns</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7 out of 9 servers with E5-2683 v4 failed. But of the error prone, only about half of the E5-2683 v4 is an empty hypothesis. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mistakes are usually not repeated</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In addition to the mtauxyz cluster, where there is indeed Corrupted data (bad data on the disk). This is another case, we reject the hypothesis. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The error does not depend on the Linux kernel</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - checked on different servers, found nothing. Nothing interesting in kern.log, </font></font><code>machine check exception</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no </font><font style="vertical-align: inherit;">messages </font><font style="vertical-align: inherit;">. In network graphics, including retransmitters, CPU, IO, Network, nothing interesting. All network adapters on the servers on which errors occur and do not appear are the same. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are no patterns</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . What to do? Continue to look for patterns. Second attempt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I look at uptime servers:</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uptime is high, servers work stably</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , segfault and something like that is not. I always rejoice when I see that the program crashed with segfault - at least it crashed. Worse, when there is an error, it spoils something, but nobody notices it. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Errors are grouped by day</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and occur within a couple of days. In some 2 days, more appear, in some less, then again more - it is not possible to accurately determine the time of occurrence of errors. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some errors match packages and the check amount that we expected.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Most errors have only two package options. I was lucky because in the error message we added the very value of the check sum, which helped to compile statistics. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No server patterns</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where we read the data from. The size of the compressed block that we check-sum is less than a kilobyte. Looked at the package sizes in HEX. This was not useful to me - the binary representation of packet sizes and check sums is not noticeable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I didn‚Äôt fix the error - I was again looking for patterns. Third attempt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For some reason, the error appears only </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on one of the clusters</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - on the third replicas in the Vladimir DC (we like to call data centers by city names). In February 2019, an error also appeared in Vladimirs DC, but on a different version of ClickHouse. This is another argument against the hypothesis that we wrote the wrong code. We already rewrote it three times from February to May - the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error is probably not in the code</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All errors when reading packets over the network -</font></font><code>while receiving packet from</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The package on which the error occurred depends on the structure of the request. </font><font style="vertical-align: inherit;">For requests that differ in structure, an error on different check sums. </font><font style="vertical-align: inherit;">But in requests where the error is on the same check sum, the constants differ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All requests with an error, except for one, are </font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But for comparison, there is one unusually simple request, and the compressed block size for it is only 75 bytes.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(ReceiveTimestamp) <span class="hljs-keyword">FROM</span> tracking_events_all 
<span class="hljs-keyword">WHERE</span> APIKey = <span class="hljs-number">1111</span> <span class="hljs-keyword">AND</span> (OperatingSystem <span class="hljs-keyword">IN</span> (<span class="hljs-string">'android'</span>, <span class="hljs-string">'ios'</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We reject the hypothesis of influence </font></font><code>GLOBAL JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most interesting is that the affected servers </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are grouped into ranges by their names</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was tired and desperate, began to look for completely delusional patterns. </font><font style="vertical-align: inherit;">It's good that I did not get to debugging the code using numerology. </font><font style="vertical-align: inherit;">But there were still leads.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The groups of problem servers are the same as in February.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem servers are located in certain parts of the data center. </font><font style="vertical-align: inherit;">In DC Vladimir there are so-called lines - its different parts: VLA-02, VLA-03, VLA-04. </font><font style="vertical-align: inherit;">Errors are clearly grouped: in some queues it is good (VLA-02), in other problems (VLA-03, VLA-04).</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typing debugging</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It only remained to debug using the "spear" method. </font><font style="vertical-align: inherit;">This means forming the hypothesis ‚ÄúWhat happens if you try to do so?‚Äù </font><font style="vertical-align: inherit;">and collect data. </font><font style="vertical-align: inherit;">For example, I found a </font></font><code>query_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simple query with an error </font><font style="vertical-align: inherit;">in the table </font><font style="vertical-align: inherit;">for which the packet size is </font></font><code>size of compressed block</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">very small (= 107). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/zz/fd/cszzfdvfkob2rhon1-n_xfnqtn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I took the request, copied it and executed it manually using clickhouse-local.</font></font><br>
<br>
<pre><code class="sql hljs">strace -f -e trace=network -s 1000 -x \<font></font>
clickhouse-local <span class="hljs-comment">--query "</span>
    <span class="hljs-keyword">SELECT</span> uniqIf(DeviceIDHash, SessionType = <span class="hljs-number">0</span>)
    <span class="hljs-keyword">FROM</span> remote(<span class="hljs-string">'127.0.0.{2,3}'</span>, mobile.generic_events)
    <span class="hljs-keyword">WHERE</span> StartDate = <span class="hljs-string">'2019-02-07'</span> <span class="hljs-keyword">AND</span> APIKey <span class="hljs-keyword">IN</span> (<span class="hljs-number">616988</span>,<span class="hljs-number">711663</span>,<span class="hljs-number">507671</span>,<span class="hljs-number">835591</span>,<span class="hljs-number">262098</span>,<span class="hljs-number">159700</span>,<span class="hljs-number">635121</span>,<span class="hljs-number">509222</span>)
        <span class="hljs-keyword">AND</span> EventType = <span class="hljs-number">1</span> <span class="hljs-keyword">WITH</span> TOTALS<span class="hljs-string">" --config config.xml</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the help of strace I received a snapshot (dump) of blocks over the network - the exact same packets that are received when this request is executed, and I can study them. You can use tcpdump for this, but it‚Äôs inconvenient: it‚Äôs hard to isolate a specific request from production traffic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using strace, you can trace the ClickHouse server itself. But this server works in production, if I do this I will get an array of incomprehensible information. Therefore, I launched a separate program that executes exactly one request. Already for this program I run strace and get what was transmitted over the network. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The request is executed without errors - the error is not reproduced</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If reproduced, the problem would be resolved. Therefore, I copied the packets to a text file and manually began to parse the protocol.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f5/0y/-8/f50y-8qvloj4brnns-nvgydpbsa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The check amount was the same as expected. </font><font style="vertical-align: inherit;">This is exactly the package on which sometimes, at another time, in other requests, errors occurred. </font><font style="vertical-align: inherit;">But so far there have been no errors. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wrote a simple program that takes a package and checks the check amount when replacing one bit in each byte. </font><font style="vertical-align: inherit;">The program performed bit flip at every possible position and read the check amount. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3m/fn/wr/3mfnwrp1udvm_ecrw0lnpcyoz0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I started the program and found that if you change the value of one bit, you get exactly that broken check-sum, for which there is a complaint</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hardware problem</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If an error occurs in the software (for example, driving through memory), single bit flip is unlikely. </font><font style="vertical-align: inherit;">Therefore, a new hypothesis appeared - the problem is in the gland. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One could close the lid of the laptop and say: "The problem is not on our side, but in the hardware, we do not do this." </font><font style="vertical-align: inherit;">But no, let's try to understand where the problem is: in the RAM, on the hard drive, in the processor, in the network card or in the network card RAM in the network equipment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to localize a hardware problem?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The problem arose and disappeared on certain dates.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Affected servers are grouped by their names: </font></font><code>mtxxxlog01-{39..44 57..58 64 68..71 73..74 76}-3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The groups of problem servers are the same as February.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem servers are only in certain queues of the data center.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were questions to network engineers - the data is beating on network switches. It turns out that network engineers exchanged switches for others exactly on those dates. After a question, they replaced them with the previous ones and the problem disappeared. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem is resolved, but questions still remain (no longer for engineers). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why doesn't ECC (error correction memory) help on network switches?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Because multiple bit flip can compensate each other - you get an undetected error. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why don't TCP check sums help?</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> They are weak. If only one bit has changed in the data, then TCP check sums will always see the change. If two bits have changed, then the changes may not be detected - they cancel each other out.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only one bit has changed in our package, but the error is not visible. That's because 2 bits changed in the TCP segment: they calculated the check sum from it, it coincided. But in one TCP segment more than one packet of our application is located. And for one of them, we already consider our check-sum. Only one bit has changed in this packet. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why Ethernet check sums do not help - are they stronger than TCP? </font></font></strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ethernet Check Amount</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">check-summarize the data so that they do not break during transmission through one segment (I can be wrong with the terminology, I'm not a network engineer). </font><font style="vertical-align: inherit;">Network equipment forwards these packets and can forward some data during forwarding. </font><font style="vertical-align: inherit;">Therefore, the check amounts are simply recounted. </font><font style="vertical-align: inherit;">We checked - on the wire the packages have not changed. </font><font style="vertical-align: inherit;">But if they beat on the network switch itself, it will recalculate the check amount (it will be different), and forward the packet further.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nothing will save you - check-sum yourself. </font><font style="vertical-align: inherit;">Do not expect someone to do this for you.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For data blocks, a 128-bit check sum is considered (this overkill just in case). </font><font style="vertical-align: inherit;">We correctly inform the user about the error. </font><font style="vertical-align: inherit;">Data is transmitted over the network, it is damaged, but we do not record it anywhere - all our data is in order, you can not worry. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The data that is stored in ClickHouse remains consistent. </font><font style="vertical-align: inherit;">Use check sums in ClickHouse. </font><font style="vertical-align: inherit;">We love check sums so much that we immediately consider three options:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For compressed data blocks when writing to a file, to the network.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The total check is the sum of compressed data for reconciliation verification.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total check is the sum of uncompressed data for reconciliation verification.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are bugs in data compression algorithms, this is a known case. </font><font style="vertical-align: inherit;">Therefore, when the data is replicated, we also consider the total check sum of the compressed data and the total amount of uncompressed data.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not be afraid to count the check amounts, they do not slow down.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, it depends on which ones and how to count. </font><font style="vertical-align: inherit;">There are nuances, but be sure to consider the check amount. </font><font style="vertical-align: inherit;">For example, if you count from the compressed data, then there will be less data, they will not slow down.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Improved error message</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How to explain to the user when he receives such an error message that this is a hardware problem? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t4/f6/rj/t4f6rj1mtuo38kojydfgddfh2nc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the check sum does not match, before sending an exception, I try to change every bit - just in case. If the check sum converges when changing and one bit is changed, then the problem is most likely hardware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we can detect this error, and if it changes when one bit is changed, why not fix it? We can do this, but if we fix errors all the time, the user will not know that the equipment is in a problem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we found out that there were problems in the switches, people from other departments began to report: ‚ÄúAnd we have one bit incorrectly written to Mongo! And something got to us in PostgreSQL! ‚Äù This is good, but it‚Äôs better to report problems earlier.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we released a new diagnostic release, the first user to whom it worked wrote a week later: ‚ÄúHere's the message - what's the problem?‚Äù </font><font style="vertical-align: inherit;">Unfortunately, he did not read it. </font><font style="vertical-align: inherit;">But I read and suggested with a 99% probability that if the error appears on one server, then the problem is with the hardware. </font><font style="vertical-align: inherit;">I leave the remaining percentage in case I wrote the code incorrectly - this happens. </font><font style="vertical-align: inherit;">As a result, the user replaced the SSD, and the problem disappeared.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Delirium" in the data</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This interesting and unexpected problem made me worry. We have Yandex.Metrica data. A simple JSON is written to the database in one of the columns - user parameters from the JavaScript code of the counter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I make some kind of request and the ClickHouse server crashed with segfault. From the stack trace, I realized what the problem was - a fresh commit from our external contributors from another country. The commit fixed, segfault disappeared. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I run the same request: </font></font><code>SELECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in ClickHouse, to get JSON, but again, nonsense, everything works slowly. I get JSON, and it is 10 MB. I display it and look more attentively: </font></font><code>{"jserrs": cannot find property of object undefind...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and then a megabyte of binary code fell out.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nt/ab/1g/ntab1gtbj8eialtctjq4nu-ucdi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were thoughts that this is again a passage from memory or a race condition. </font><font style="vertical-align: inherit;">A lot of such binary data is bad, it can contain anything. </font><font style="vertical-align: inherit;">If so, now I will find passwords and private keys there. </font><font style="vertical-align: inherit;">But I did not find anything, so I immediately rejected the hypothesis. </font><font style="vertical-align: inherit;">Maybe this is a bug in my program on the ClickHouse server? </font><font style="vertical-align: inherit;">Perhaps in a program that writes (it is also written in C ++) - all of a sudden she accidentally puts her dump memory into ClickHouse? </font><font style="vertical-align: inherit;">In this hell, I began to look closely at the letters and realized that it was not so simple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clue path</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same garbage was recorded on two clusters, independently of each other. </font><font style="vertical-align: inherit;">The data is junk, but it's valid UTF-8. </font><font style="vertical-align: inherit;">This UTF-8 has some strange URLs, font names, and a lot of letters "I" in a row. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is special about the little Cyrillic "I"? </font><font style="vertical-align: inherit;">No, this is not Yandex. </font><font style="vertical-align: inherit;">The fact is that in the encoding of Windows 1251 it is the 255th character. </font><font style="vertical-align: inherit;">And on our Linux servers, no one uses Windows 1251 encoding. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that this is a dump of the browser: the JavaScript code of the metric counter collects JavaScript errors. </font><font style="vertical-align: inherit;">As it turned out, the answer is simple - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it all came from the user</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From here, too, conclusions can be drawn.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bugs from all over the Internet</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Metrica collects traffic from 1 billion devices on the Internet: browsers on PCs, cell phones, tablets. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Garbage will come inevitably</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : there are bugs in user devices, everywhere unreliable RAM and terrible hardware that overheats. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The database stores more than 30 trillion lines (page views). If you analyze the data from this table, you can find anything there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, it‚Äôs correct to simply filter this garbage before writing to the database. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No need to write garbage to the database - she doesn't like it.</font></font></b><br>
<br>
<blockquote> HighLoad++   ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> 133 </a>   ),       -  ,   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">++</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">PHP Russia 2020 Online</a>. <br>
<br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Badoo</a>, <b> PHP Russia 2020 Online  </b>. PHP Russia 2020 Online  13 ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.<br>
<br>
          ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>,     . </blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en497324/index.html">"Like the apple of an eye ..." or make a simple security system based on a microcontroller (Canny or Arduino) and Raspberry PI</a></li>
<li><a href="../en497326/index.html">More secure SSH connectivity with DNSSEC</a></li>
<li><a href="../en497328/index.html">Easy way to learn a language (any)</a></li>
<li><a href="../en497330/index.html">Chrome Remote Desktop. Remote support</a></li>
<li><a href="../en497332/index.html">Houston, we have a problem. System Design Failure</a></li>
<li><a href="../en497336/index.html">Computer brands of the 90s, part 3, final</a></li>
<li><a href="../en497338/index.html">What happened to transport last week - the crisis is developing</a></li>
<li><a href="../en497340/index.html">COVID-19: how to stop reading news and start analyzing data</a></li>
<li><a href="../en497342/index.html">Browser on guard of API requests: building secure communication between the front-end and the back-end</a></li>
<li><a href="../en497346/index.html">Speed ‚Äã‚Äãup numpy, scikit and pandas 100 times with Rust and LLVM: interview with developer Weld</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>