<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’„ ğŸ§›ğŸ½ ğŸ‘©ğŸ»â€ğŸŒ¾ ClickHouseã®ã‚¹ãƒãƒ¼ãƒˆæ–‡å­—åˆ—å‡¦ç†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  ğŸ‘¨ğŸ¾â€ğŸŒ¾ ğŸ†‘ ğŸ‘©ğŸ¾â€ğŸš’</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ClickHouseã¯å¸¸ã«æ–‡å­—åˆ—å‡¦ç†ã‚¿ã‚¹ã‚¯ã«é­é‡ã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€å¤§æ–‡å­—ã¨å°æ–‡å­—ã‚’åŒºåˆ¥ã™ã‚‹æ¤œç´¢ã§ã‚ã‚‹ã‹åœ§ç¸®ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ã§ã‚ã‚‹ã‹ã«é–¢ä¿‚ãªãã€æ¤œç´¢ã€UTF-8æ–‡å­—åˆ—ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è¨ˆç®—ã€ã¾ãŸã¯ã‚ˆã‚Šã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ãªä½•ã‹ã€‚
 

ClickHouse Lyosha Milovidovã®é–‹ç™ºè²¬ä»»è€…ãŒ o6CuFl2...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ClickHouseã®ã‚¹ãƒãƒ¼ãƒˆæ–‡å­—åˆ—å‡¦ç†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/466183/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouseã¯å¸¸ã«æ–‡å­—åˆ—å‡¦ç†ã‚¿ã‚¹ã‚¯ã«é­é‡ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€å¤§æ–‡å­—ã¨å°æ–‡å­—ã‚’åŒºåˆ¥ã™ã‚‹æ¤œç´¢ã§ã‚ã‚‹ã‹åœ§ç¸®ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ã§ã‚ã‚‹ã‹ã«é–¢ä¿‚ãªãã€æ¤œç´¢ã€UTF-8æ–‡å­—åˆ—ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è¨ˆç®—ã€ã¾ãŸã¯ã‚ˆã‚Šã‚¨ã‚­ã‚¾ãƒãƒƒã‚¯ãªä½•ã‹ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouse Lyosha Milovidovã®é–‹ç™ºè²¬ä»»è€…ãŒ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o6CuFl2Q</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å½¼ã¯ã€é«˜ç­‰çµŒæ¸ˆå­¦éƒ¨ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚µã‚¤ã‚¨ãƒ³ã‚¹å­¦éƒ¨ã§ç§ãŸã¡ã®ã¨ã“ã‚ã«æ¥ã¦ã€å­¦æœŸæœ«è«–æ–‡ã‚„å’æ¥­è¨¼æ›¸ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’æ•°å¤šãæä¾›ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã€ŒClickHouseã§ã®ã‚¹ãƒãƒ¼ãƒˆæ–‡å­—åˆ—å‡¦ç†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€ï¼ˆç§ã¯å®Ÿé¨“çš„ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å«ã‚€ã•ã¾ã–ã¾ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«èˆˆå‘³ãŒã‚ã‚‹äººï¼‰ã‚’è¦‹ãŸã¨ãã€ã™ãã«ã‚¯ãƒ¼ãƒ«ãªå’æ¥­è¨¼æ›¸ã®ä½œæˆæ–¹æ³•ã®è¨ˆç”»ã‚’ç«‹ã¦ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ç§ã®å–œã³ã¨è¡¨ç¾ã¯æ¬¡ã®ã‚ˆã†ã«èª¬æ˜ã§ãã¾ã™ã€‚</font></font></p><br>
<p><img src="https://habrastorage.org/webt/av/4d/2g/av4d2gj_pplevfljaomiqsnccda.jpeg"></p><br>
<a name="habracut"></a><br>
<h2 id="clickhouse"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¯ãƒªãƒƒã‚¯ãƒã‚¦ã‚¹</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouseã¯ã€ãƒ¡ãƒ¢ãƒªå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æ§‹æˆã‚’æ…é‡ã«æ¤œè¨ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">å„åˆ—ã®çµ‚ã‚ã‚Šã«ã¯ã€16ãƒã‚¤ãƒˆã®ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’å®‰å…¨ã«èª­ã¿å–ã‚‹ãŸã‚ã«15ãƒã‚¤ãƒˆã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãŸã¨ãˆã°ã€ColumnStringã¯nullã§çµ‚äº†ã™ã‚‹æ–‡å­—åˆ—ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’æ ¼ç´ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã®ã‚ˆã†ãªé…åˆ—ã‚’æ‰±ã†ã®ã¯ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚</font></font></p><br>
<p><img src="https://habrastorage.org/webt/w4/go/yp/w4goypgrxiigdp5tpdy3eyao2bu.png"><br>
</p><br>
<p>  ColumnFixedString, ColumnConst  LowCardinality,         .     ,       ,        .</p><br>
<h2 id="poisk-po-podstrokam">  </h2><br>
<p> ,         .    ,    ClickHouse.    :</p><br>
<ol>
<li>haystack â€” ,    ;    <em>n</em>.</li>
<li>needle â€”    ,    ;    <em>m</em>.</li>
</ol><br>
<p>      ,   2 ( 3)    .  â€”        .   â€” ,    .     â€” ,   ,       .     ,     ,  needle, haystack   . </p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.     :</p><br>
<ol>
<li> â€”  â€” ,</li>
<li> â€” ,</li>
<li> â€”  â€” ,</li>
<li> â€” ,</li>
<li> (  glibc   Â«memmemÂ»),</li>
<li>BNDM.</li>
</ol><br>
<p>  .   ClickHouse   ,        .</p><br>
<h4 id="algoritm-volnickogo"> </h4><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>      2010 .  -    â€”  â€” ,   .</p><br>
<p> <em>m &lt; 4</em>,     .    (2   ) needle    -     <em>|Sigma|<sup>2</sup></em>  (   2<sup>16</sup> ),      ,    â€”    .      <em>m â€” 2</em>   haystack.   haystack   <em>m â€” 1</em>,         haystack        -.         . ,  ,    . </p><br>
<p> <em>m â€” 1</em>   ,     needle  haystack,        â€”   ,      haystack.    ,   -       .  ,     ,         (,     ),  â€”   .</p><br>
<p> .   haystack  <code>abacabaac</code>  needle  <code>aaca</code>. -  <code>{aa : 0, ac : 1, ca : 2}</code>.</p><br>
<pre><code class="plaintext hljs">0 1 2 3 4 5 6 7 8 9<font></font>
a b a c a b a a c a<font></font>
    ^ -   </code></pre><br>
<p>  <code>ac</code>.  needle  ,   :</p><br>
<pre><code class="plaintext hljs">0 1 2 3 4 5 6 7 8 9<font></font>
a b a c a b a a c a<font></font>
  a a c a</code></pre><br>
<p> .  <code>ac</code>  -   ,    3:</p><br>
<pre><code class="plaintext hljs">0 1 2 3 4 5 6 7 8 9<font></font>
a b a c a b a a c a<font></font>
          ^ -   </code></pre><br>
<p> <code>ba</code>  - ,  :</p><br>
<pre><code class="plaintext hljs">0 1 2 3 4 5 6 7 8 9<font></font>
a b a c a b a a c a<font></font>
                ^ -   </code></pre><br>
<p> <code>ca</code>  needle ,      :</p><br>
<pre><code class="plaintext hljs">0 1 2 3 4 5 6 7 8 9<font></font>
a b a c a b a a c a<font></font>
            a a c a</code></pre><br>
<p>   . -,      ,  64       - . -, 2<sup>16</sup> â€”        ;    movzwl (   , Â«Â»)  .</p><br>
<p>       .     .,   .    ,  , KMP:   â€”  â€” , BM:  â€” , BMH:  â€”  â€” .</p><br>
<p><img src="https://habrastorage.org/webt/wp/vn/v2/wpvnv2eqrbhhvqvryaqmdjc9igy.png"><br>
</p><br>
<p>   ,     :</p><br>
<p><img src="https://habrastorage.org/webt/oi/3x/dh/oi3xdhxe7awdlsqxxui2lyqvxjc.png"><br>
</p><br>
<p>    <code>position(Column, ConstNeedle)</code>,         .</p><br>
<h2 id="poisk-po-regulyarnym-vyrazheniyam">   </h2><br>
<p>,   ClickHouse     .      ,      haystack.         ,    . </p><br>
<p>   :      ,   â€” ;   ,     (, '.', '*', '?', '\w'  . .).        0.  :<br>
<img src="https://habrastorage.org/webt/2x/uk/uo/2xukuompabpmnrjpk-muwg1yydi.png"><br>
</p><br>
<p>   ,     haystack   ,     ,             RE2.      ,     RE2  736 /, Hyperscan (   )   1,6 /,     1,69 /c       LZ4.  ,            ,       ,    .</p><br>
<p>  LIKE      ,   LIKE        %%%%% ( )  <code>_</code> ( ).</p><br>
<p> ,       ,   <code>yandex|google</code>    ,     haystack.      .</p><br>
<h2 id="poisk-po-mnogim-podstrokam">   </h2><br>
<p>   ,    needle,   ,         haystack.      ,    â€” .         .     .</p><br>
<p><del></del> ClickHouse   ,     -  , ,     .  . </p><br>
<p>        ,       .             -   .         needle  1,    ,        . -   128  (  255   ,     256 needle).   ,      (    ):</p><br>
<p><img src="https://habrastorage.org/webt/ak/no/hq/aknohqtvebtx-c_ijmza8af0emm.png"><br>
</p><br>
<p><img src="https://habrastorage.org/webt/x6/cm/z4/x6cmz4d3i5qy5i3tfj1ngbssewc.png"><br>
</p><br>
<p> ,          (    ).         (     â€”  2,5 /). </p><br>
<p><img src="https://habrastorage.org/webt/nl/t_/pt/nlt_pt077xl7n-cya0qb6eh67re.png"><br>
</p><br>
<p>  . ,         .    â€”       .</p><br>
<p><img src="https://habrastorage.org/webt/n8/wm/uz/n8wmuzm_vcepo4olqcse1e7gwqy.png"><br>
</p><br>
<p>  ,    needle  . ,         haystack,     .</p><br>
<p><img src="https://habrastorage.org/webt/zg/z1/ej/zgz1ejecxev4-j-oz3m6egxydt0.png"><br>
</p><br>
<p>   -  13-15 .  97% ,     ,   15 :</p><br>
<p><img src="https://habrastorage.org/webt/x-/6j/od/x-6jodqalhriam_byxewdzoxzhs.png"><br>
</p><br>
<p>     â€” 41 ,   :</p><br>
<p><img src="https://habrastorage.org/webt/yx/ez/da/yxezdam_2poycdgttd9nnsyjjqy.png"><br>
</p><br>
<p>   ClickHouse (19.5)       :</p><br>
<p>â€” <code>multiSearchAny(h, [n_1, ..., n_k])</code> â€” 1,   -  needle   haystack.<br>
â€” <code>multiSearchFirstPosition(h, [n_1, ..., n_k])</code> â€”      haystack ( )  0,   .<br>
â€” <code>multiSearchFirstIndex(h, [n_1, ..., n_k])</code> â€”    needle,    haystack; 0,   .<br>
â€” <code>multiSearchAllPositions(h, [n_1, ..., n_k])</code> â€”     needle,  array.</p><br>
<p> -UTF8 ( ), -CaseInsensitive ( 4    ), -CaseInsensitiveUTF8 ( ,          ).    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p>   ,   -      ?   ,     .</p><br>
<h2 id="poisk-po-mnogim-regulyarnym-vyrazheniyam">    </h2><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Hyperscan</a> â€”   Intel,       .        ,    ,   SIMD      (, ,  Teddy).</p><br>
<p> ,          .    ,     .</p><br>
<p><img src="https://habrastorage.org/webt/of/xl/dd/ofxlddsnj92zghvsducv9e9jktu.png"><br>
</p><br>
<p> ,      ClickHouse    12-         .</p><br>
<p>   Hyperscan    .   ,           .</p><br>
<p>    .  â€”       ,  haystack    2<sup>32</sup> .  â€”     ,    needle  . .    â€”  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>   .   ClickHouse       Hyperscan:</p><br>
<p>â€” <code>multiMatchAny(h, [n_1, ..., n_k])</code> â€” 1,   -  needle   haystack.<br>
â€” <code>multiMatchAnyIndex(h, [n_1, ..., n_k])</code> â€”    needle,    haystack.</p><br>
<p> ,      ,  ?    .</p><br>
<h2 id="priblizhyonnyy-poisk"> </h2><br>
<p>       â€”   ,   ,   ,    a  m   b  n.  ,        <em>O(mn)</em>;      <em>O(mn/log max(n, m))</em>;    <em>O( (n + m) â‹… alpha)</em>,  <em>alpha</em> â€” ; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>   <em>O( (alpha âˆ’ |n âˆ’ m|)min(m, n, alpha) + m + n)</em> ( ,    ) ,   ,  <em>O(alpha^2 + m + n)</em>.   :        ,  ,  â€”        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<p> : ,            ,  ;     <em>O( (n + m) log (n + m))</em>. </p><br>
<p>     ,    .           .</p><br>
<p><img src="https://habrastorage.org/webt/ok/b8/gg/okb8ggb8vwkzft3ggzdipy29pja.png"><br>
</p><br>
<p>  ,   .      ,   ,    .     ,          ,    .         m &lt; n,       . </p><br>
<p>     ( d  n â€” m + 1 ,  d[i] â€”     i-   )  <em>O(|Sigma| (n + m) log (n + m))</em>?   <em>|Sigma|</em>  , ,     .        Sigma   â€”   .</p><br>
<p> . <code>abba</code>,  <code>ba</code>,  .  2  <code>1001, 01</code>  <code>0110, 10</code>.</p><br>
<pre><code class="plaintext hljs">   a<font></font>
1001<font></font>
01   - 0 <font></font>
 01  - 0 <font></font>
  01 - 1 </code></pre><br>
<pre><code class="plaintext hljs">   b<font></font>
0110<font></font>
10   - 0 <font></font>
 10  - 1 <font></font>
  10 - 1 </code></pre><br>
<p>  [0, 1, 2] â€”    .  ,       â€”      needle    haystack.   ,  ,    !</p><br>
<p> ,   :       <em>m &lt; n</em>   <em>O(n log n)</em>  ,        .      .      ,   â€”      ,               <em>O(n log n)</em> â€”  -!  ,   ,     .</p><br>
<p>   ClickHouse.     |Sigma| = 30  ,   â€”        ,    , Â« Â».</p><br>
<p>      .   ,    n- .      n- haystack  needle,  2  c  n-.             n-.    0  1 â€”    0,    .  ,  <em>n = 4</em>:</p><br>
<pre><code class="plaintext hljs">abcda â†’ {abcd, bcda}; Size = 2<font></font>
bcdab â†’ {bcda, cdab}; Size = 2<font></font>
<font></font>
        .<font></font>
|{abcd, cdab}| / (2 + 2) = 0.5</code></pre><br>
<p>    4-        SSE,        crc32-.</p><br>
<p><img src="https://habrastorage.org/webt/ad/36/uk/ad36ukzmrspftbjxxwbc3djljv4.png"><br>
</p><br>
<p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>. :       .</p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>      ASCII    .</p><br>
<p>â€” <code>ngramDistance(haystack, needle)</code> â€”    0  1;    0,       .<br>
â€” -UTF8, -CaseInsensitive, -CaseInsensitiveUTF8 (     ASCII).</p><br>
<p>Hyperscan      â€”       :       ,    .  <em>distance + 1</em> ,     ,    ,  Â«Â»,             .  ClickHouse      :</p><br>
<p>â€” <code>multiFuzzyMatchAny(haystack, distance, [n_1, ..., n_k])</code> â€”  multiMatchAny,   .<br>
â€” <code>multiFuzzyMatchAnyIndex(haystack, distance, [n_1, ..., n_k])</code> â€”  multiMatchAnyIndex,   .</p><br>
<p>  <em>distance</em>    ,        .</p><br>
<p>       UTF-8 .     .</p><br>
<h2 id="obrabotka-utf-8-strok"> UTF-8 </h2><br>
<p>,       UTF-8    .     SIMD.   ,    .</p><br>
<p>,    UTF-8 :</p><br>
<p><img src="https://habrastorage.org/webt/iu/xn/zu/iuxnzucrcetohvgsxb7ozohxwws.png"><br>
</p><br>
<p>       .    .    :</p><br>
<p>â€”   0xC<em>   0xD</em>  2 <br>
â€” 0xC2 = 11<u>0</u>00010<br>
â€” 0xDF = 11<u>0</u>11111<br>
â€” 0xE0 = 111<u>0</u>0000<br>
â€” 0xF4 = 1111<u>0</u>100,  0xF4  ,     0xF8,    <br>
â€”  7      ,    ASCII </p><br>
<p> :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">size_t</span> <span class="hljs-title">seqLength</span><span class="hljs-params">(<span class="hljs-keyword">const</span> UInt8 first_octet)</span> </span>{
    <span class="hljs-keyword">if</span> (first_octet &lt; <span class="hljs-number">0x80</span>u)
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> first_zero = bitScanReverse(<span class="hljs-keyword">static_cast</span>&lt;UInt8&gt;(~first_octet));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">7</span> - first_zero;<font></font>
}</code></pre><br>
<p>      ,      ,   .</p><br>
<pre><code class="cpp hljs">f = __builtin_clz(val) <span class="hljs-comment">// (bsrl,     ) f(2) = 30, f(8) = 28, f(7) = 29 </span></code></pre><br>
<p> bitScanReverse:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">bitScanReverse</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> x)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">31</span> - __builtin_clz(x);<font></font>
}</code></pre><br>
<p>   UTF-8      SIMD.              : </p><br>
<p>â€” 0xBF = -65<br>
â€” 0x80 = -128<br>
â€” 0xC2 = -62<br>
â€” 0x7F = 127<br>
â€”      [0xC2, 0x7F]<br>
â€”       [0x80, 0xBF]</p><br>
<p>  .     -65 ,   ,   ,  .     SIMD,    load 16   input stream.    ,        0xFF,     â€” 0x00.   <code>pmovmskb</code>,       .     ,     SSE4- <code>popcnt</code>.      :</p><br>
<p><img src="https://habrastorage.org/webt/gn/mh/q5/gnmhq5lwynwpkdmqe2k3xsowxfs.png"><br>
</p><br>
<p>,           1,5 /.</p><br>
<p> :</p><br>
<p>â€” <code>lengthUTF8(string)</code> â€”     UTF-8 ,    - ,   .</p><br>
<p>  ,         UTF-8 . ,        UTF-8 .</p><br>
<p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">https://github.com/cyb70289/utf8/</a>,   ClickHouse (      )   1,22 /     900 /   .     ,     .</p><br>
<p>â€” <code>isValidUTF8(string)</code> â€”  1,    UTF-8 ,  0.<br>
â€” <code>toValidUTF8(string)</code> â€”    UTF-8     (U+FFFD).          . No rocket science.</p><br>
<p> ,  UTF-8  -         -,  . </p><br>
<h2 id="chto-dalshe"> ?</h2><br>
<p>,      .  ,     10/10.       Highload++ Siberia (,  ,     ).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.  ,          .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.    ,      . :)</p><br>
<p>           (   -): </p><br>
<p>â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  concat  2 </a>;<br>
â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  python format  </a>;<br>
â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> LZ4   4%</a>;<br>
â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    SIMD  ARM  PPC64LE</a>;<br>
â€”         ClickHouse.</p><br>
<p>  , ,   , <del>     </del> ClickHouse       ,   , ,  developer-  devops-. ClickHouse , .     JSON?         â€”    ,          . </p><br>
<p>    ClickHouse   , , ,   .       .</p><br>
<p>  4   ,       ,        ,  .        <del> </del>        .   ,     .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link">ivan_puzyrevskiy</a>,  ,  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link">maxim_babenko</a>  ,        .     ,  -  .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja466169/index.html">JetBrainsã®ç¾å½¹å­¦ç”Ÿå‘ã‘ã®ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼</a></li>
<li><a href="../ja466171/index.html">JUG.EKBã«è¡Œã5ã¤ã®ç†ç”±</a></li>
<li><a href="../ja466175/index.html">Cisco Expressway 12.5.5ã€‚VPNã‚’ä½¿ç”¨ã—ãªã„ã‚ªãƒ•ã‚£ã‚¹å¤–ã®ãƒ“ãƒ‡ã‚ªä¼šè­°</a></li>
<li><a href="../ja466179/index.html">fformï¼šReactï¼†JSONSchema-æœ€å¤§ã®æŸ”è»Ÿæ€§</a></li>
<li><a href="../ja466181/index.html">Cã®Pythonï¼ˆC APIï¼‰</a></li>
<li><a href="../ja466187/index.html">Unity3dã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã€‚ãƒ‘ãƒ¼ãƒˆ2</a></li>
<li><a href="../ja466191/index.html">ã‚¢ãƒ¡ãƒªã‚«ã«ãŠã‘ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸­ç«‹æ€§ã®ãŸã‚ã®æˆ¦ã„ã«ã¤ã„ã¦ã®ä¸»ãªã“ã¨ã¯ã€å‡ºæ¥äº‹ã®å¹´è¡¨ã¨ç¾åœ¨ã®çŠ¶æ³ã§ã™</a></li>
<li><a href="../ja466193/index.html">RSSãƒ•ã‚£ãƒ¼ãƒ‰ã‹ã‚‰ã®ã‚«ã‚¹ã‚¿ãƒ MailChimpè‡ªå‹•ãƒ•ã‚£ãƒ¼ãƒ‰</a></li>
<li><a href="../ja466197/index.html">PVS-Studio 7.04</a></li>
<li><a href="../ja466199/index.html">PostgreSQLã®ãƒ­ãƒƒã‚¯ï¼š4.ãƒ¡ãƒ¢ãƒªå†…ã®ãƒ­ãƒƒã‚¯</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>