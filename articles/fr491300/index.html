<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏼‍🤝‍🧑🏼 🐯 💅🏾 STM32 Partie 2: Initialisation ✊🏼 ⚫️ 🤭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La programmation divise quelque chose de grand et d'impossible en quelque chose de petit et de très réel.
 
 Bonjour à tous, pour commencer, je voudra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Partie 2: Initialisation</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491300/"><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La programmation divise quelque chose de grand et d'impossible en quelque chose de petit et de très réel.</font></font></blockquote><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonjour à tous, pour commencer, je voudrais remercier les modérateurs d'avoir manqué mon premier post (dégoûtant), et dire bonjour à maman! Et je voudrais également remercier tous les lecteurs et les personnes qui ont souligné mes erreurs et aidé à les corriger. Je fais immédiatement une réserve qu'en russe je n'ai pas écrit de 6e année, en général, ne soyez pas en colère. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32 Partie 1: Les bases Commençons</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
donc. Dans un article précédent, j'ai rapidement passé en revue les tout premiers points. C'était notre fichier startup.c, qui était responsable de 2 vecteurs (pile, Reset_Handler) et un peu du script de l'éditeur de liens. Aujourd'hui, nous compléterons notre code d'initialisation, analyserons l'éditeur de liens pour les pièces de rechange et découvrirons comment tout fonctionne.</font></font><br>
<a name="habracut"></a><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si ce code n'est clair pour personne, vous pouvez le lire </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (l'article n'est pas une fontaine, mais a essayé de l'expliquer). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant ce qui manque ici et comment l'ajouter. De toute évidence, les microns ont d'autres vecteurs. Par exemple, le vecteur Hard_Fault est un vecteur qui est appelé à des actions incorrectes avec μ, par exemple, s'il essaie d'exécuter une instruction que le processeur ne comprend pas, il sautera à l'adresse du vecteur Hard_Fault. Il y a beaucoup de tels vecteurs et ce n'est pas un fait que dans notre programme, nous utiliserons tout. De plus, les vecteurs d'interruption sont dans la même table. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(Pour ceux qui ne savent toujours pas ce qu'est un vecteur, il s'agit d'un pointeur vers une adresse, alias «pointeur»). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous complétons notre code, puis je vous expliquerai ce que j'ai fait.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Default_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">NMI_Handler</span><span class="hljs-params">()</span>   __<span class="hljs-title">attribute__</span><span class="hljs-params">((weak, alias(<span class="hljs-string">"Default_Handler"</span>)))</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HardFault_Handler</span><span class="hljs-params">()</span>   __<span class="hljs-title">attribute__</span><span class="hljs-params">((weak, alias(<span class="hljs-string">"Default_Handler"</span>)))</span></span>;
<span class="hljs-comment">//     </span><font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
    &amp;NMI_Handler,<font></font>
    &amp;HardFault_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Default_Handler(){
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, j'ai ajouté une nouvelle fonction Default_Handler (); qui gérera toutes les interruptions, absolument. Mais aussi avec l'aide, </font></font><code>__attribute__((weak, alias("Default_Handler")));</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j'ai noté que si une fonction avec le même nom est déclarée, alors ce sera le gestionnaire de cette interruption. En d'autres termes, en ce moment, ce n'est qu'un surnom pour Default_Handler. Nous pouvons donc ajouter tous les vecteurs dans la liste de votre manuel de référence. Ceci est fait de sorte que si vous décidez soudainement d'utiliser une interruption, mais oubliez de créer un gestionnaire de fonctions, alors le Default_Handler habituel est appelé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je pense qu'à ce stade, avec les vecteurs, vous pouvez terminer et passer à l'initialisation des secteurs et à l'éditeur de liens. Pour commencer, mettons à jour notre startup.c en ajoutant l'initialisation des secteurs data et bss au corps Reset_Handler ainsi que plusieurs variables externes.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_sidata, *_sdata, *_edata, *_sbss, *_ebss;<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
<font></font>
<font></font>
	<span class="hljs-keyword">void</span> **pSource, **pDest;
	<span class="hljs-keyword">for</span> (pSource = &amp;_sidata, pDest = &amp;_sdata; pDest != &amp;_edata; pSource++, pDest++)<font></font>
		*pDest = *pSource;<font></font>
<font></font>
	<span class="hljs-keyword">for</span> (pDest = &amp;_sbss; pDest != &amp;_ebss; pDest++)<font></font>
		*pDest = <span class="hljs-number">0</span>;<font></font>
<font></font>
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, de nouvelles variables, et encore une fois, elles ont été déclarées dans notre script de l'éditeur de liens. </font><font style="vertical-align: inherit;">Rappelez le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script précédent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et comparez-le également avec un nouveau.</font></font><br>
<br>
<pre><code class="markdown hljs">MEMORY{
<span class="hljs-code">	ROM(rx) : ORIGIN = 0x08000000, LENGTH = 1M
	SRAM (rwx):     ORIGIN = 0x20010000, LENGTH = 240K
}
</span>
<span class="hljs-emphasis">_estack = LENGTH(SRAM) + ORIGIN(SRAM);

SECTIONS{
	.isr_</span>vector : {
<span class="hljs-code">	KEEP(*(.isr_vector))
	} &gt;ROM
	
	.text : {
        . = ALIGN(4);
        *(.text)
    } &gt;ROM
	
	_sidata = LOADADDR(.data);
        .data : {
		. = ALIGN(4);
		_sdata = .;
		*(.data)
		. = ALIGN(4);
		_edata = .;
	} &gt;SRAM AT&gt;ROM
	
	.bss : {
		. = ALIGN(4);
		_sbss = .;
		*(.bss)
		. = ALIGN(4);
		_ebss = .;
	} &gt;SRAM
}</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux nouvelles sections ont été ajoutées, ce sont .data et .bss. </font><font style="vertical-align: inherit;">Pourquoi avons-nous besoin d'eux? </font><font style="vertical-align: inherit;">bien .data laissera des variables globales et statique ira à bss. </font><font style="vertical-align: inherit;">Ces deux sections sont en RAM, et si tout est simple avec la section bss (ce ne sont que des zéros), alors il y a quelques difficultés avec la section data. </font><font style="vertical-align: inherit;">Premièrement, les données sont déjà des données initialisées qui sont connues au moment de la compilation. </font><font style="vertical-align: inherit;">Ainsi, initialement, la section de données se trouvera quelque part dans la mémoire flash. </font><font style="vertical-align: inherit;">Deuxièmement, nous devons en quelque sorte indiquer à l'éditeur de liens le script qu'il est dans la mémoire flash, mais il sera transféré dans la RAM pendant l'exécution du programme. </font><font style="vertical-align: inherit;">Jetons un coup d'œil à un morceau du script où nous décrivons la section des données.</font></font><br>
<br>
<pre><code class="markdown hljs">
<span class="hljs-code">        _sidata = LOADADDR(.data);
        .data : {
		. = ALIGN(4);
		_sdata = .;
		*(.data)
		. = ALIGN(4);
		_edata = .;
	} &gt;SRAM AT&gt;ROM</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela commence par la déclaration de _sidata et l'attribution, pour le moment, d'un sens qui ne nous est pas clair. Ensuite, une description de la section elle-même commence. Je vous conseille de lire à propos de la fonction ALIGN </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais en résumé, nous attribuons à notre point (adresse actuelle) une valeur qui est plus facilement acceptée par notre processeur lorsqu'il essaie de charger des données ou des instructions à partir de là. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sont également inclus _sdata, _edata et la fin de la section. Mais à la fin de la section, il y a juste ce dont nous avons besoin.</font></font><code>SRAM AT&gt;ROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Cette ligne indique à notre éditeur de liens que la section est en SRAM mais cette section est chargée dans la mémoire ROM ou flash. Revenons maintenant à notre variable _sidata et à la fonction LOADADDR. Cette fonction nous renverra une valeur qui sera égale à l'adresse de la section de chargement. Autrement dit, nous avons indiqué que la section était chargée dans la mémoire flash, mais nous l'utilisons dans la mémoire RAM, et pour transférer cette section, nous devons connaître son adresse dans la mémoire flash, ce que renvoie la fonction LOADADDR. Pendant ce temps, les variables _sdata et _edata indiquent l'emplacement de la section dans la RAM, nous donnant ainsi la possibilité de charger la section de données dans la bonne mémoire. Permettez-moi de vous rappeler que c'est ce que traite le code d'initialisation que nous avons complété ci-dessus.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi avons-nous besoin de cet éditeur de liens et de telles difficultés avec la distribution des sections de notre application? La section Données n'est qu'un petit exemple des raisons pour lesquelles nous devons pouvoir placer et décaler des sections en mémoire. Voici un exemple de la section de texte que j'utilise.</font></font><br>
<br>
<pre><code class="markdown hljs">.text (ORIGIN(ROM<span class="hljs-emphasis">_ITCM) + SIZEOF(.isr_</span>vector)): {
<span class="hljs-code">        . = ALIGN(4);
        *(.text)
    } AT&gt;ROM_AXIM</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'essence de ce bloc est que je charge également la section de texte dans la mémoire flash, mais que j'utilise un bus différent pour accéder aux instructions et un accélérateur ART (un peu comme un cache normal). </font><font style="vertical-align: inherit;">Et pour que tout fonctionne, j'ai indiqué l'adresse de chargement et l'adresse pendant l'exécution du code, mais cela ne fonctionnerait pas si je n'indiquais pas que la section devait être décalée. </font><font style="vertical-align: inherit;">Il existe de nombreuses autres inventions de ce genre, je ne les montrerai pas toutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce stade, les sections sont chargées si nécessaire et initialisées. </font><font style="vertical-align: inherit;">nous avons une base de travail pour l'écriture de code supplémentaire. </font><font style="vertical-align: inherit;">Dans le prochain article, nous allons écrire notre premier pilote et faire clignoter une LED. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci à tous pour votre attention et la réussite de vos efforts.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491286/index.html">Réseaux IPv6 uniquement dans le gouvernement américain</a></li>
<li><a href="../fr491288/index.html">Les polygraphes deviennent fous un par un</a></li>
<li><a href="../fr491294/index.html">Transactions distribuées pour des bases de données hétérogènes dans MS .NET</a></li>
<li><a href="../fr491296/index.html">Dagaz: une histoire de persistance</a></li>
<li><a href="../fr491298/index.html">Comment trouver des logiciels malveillants (non) avec WinDbg</a></li>
<li><a href="../fr491302/index.html">Client OVPN sur les téléphones Grandstream</a></li>
<li><a href="../fr491304/index.html">Helsinki: une ville de bonheur et de confort</a></li>
<li><a href="../fr491308/index.html">ClickHouse - analyse des données visuellement rapide et intuitive dans Tabix. Igor Strykhar</a></li>
<li><a href="../fr491310/index.html">Comment déchiffrer une archive de mots de passe vous-même</a></li>
<li><a href="../fr491336/index.html">Jouez comme un game designer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>