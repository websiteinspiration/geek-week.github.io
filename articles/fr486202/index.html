<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüè´ üç® üìØ Alpine recueille les versions Docker sous Python 50 fois plus lentement et les images 2 fois plus lourdes ü§Ωüèª ‚ù£Ô∏è üòö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alpine Linux est souvent recommand√© comme image de base pour Docker. On vous dit que l'utilisation d'Alpine rendra vos builds plus petits et le proces...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Alpine recueille les versions Docker sous Python 50 fois plus lentement et les images 2 fois plus lourdes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486202/"><img src="https://habrastorage.org/webt/hg/51/dn/hg51dne-v3zvjg--xoybqzk67fa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alpine Linux est souvent recommand√© comme image de base pour Docker. </font><font style="vertical-align: inherit;">On vous dit que l'utilisation d'Alpine rendra vos builds plus petits et le processus de build plus rapide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si vous utilisez Alpine Linux pour les applications Python, alors cela:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rend vos constructions beaucoup plus lentes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rend votre apparence plus grande</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perdre son temps</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et √† la fin, cela peut provoquer des erreurs d'ex√©cution</font></font></li>
</ul><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons pourquoi Alpine le recommande, mais pourquoi vous ne devriez pas l'utiliser dans un endroit avec Python.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi les gens recommandent Alpine?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que nous ayons besoin de gcc dans le cadre de notre image et que nous voulons comparer Alpine Linux vs Ubuntu 18.04 en termes de vitesse de construction et de taille d'image finale. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, t√©l√©chargez deux images et comparez leur taille:</font></font><br>
<br>
<pre><code class="bash hljs">$ docker pull --quiet ubuntu:18.04<font></font>
docker.io/library/ubuntu:18.04<font></font>
$ docker pull --quiet alpine<font></font>
docker.io/library/alpine:latest<font></font>
$ docker image ls ubuntu:18.04<font></font>
REPOSITORY          TAG        IMAGE ID         SIZE<font></font>
ubuntu              18.04      ccc6e87d482b     64.2MB<font></font>
$ docker image ls alpine<font></font>
REPOSITORY          TAG        IMAGE ID         SIZE<font></font>
alpine              latest     e7d92cdc71fe     5.59MB<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, l'image de base d'Alpine est beaucoup plus petite. </font><font style="vertical-align: inherit;">Essayons maintenant d'installer gcc et commen√ßons avec Ubuntu:</font></font><br>
<br>
<pre><code class="bash hljs">FROM ubuntu:18.04<font></font>
RUN apt-get update &amp;&amp; \<font></font>
    apt-get install --no-install-recommends -y gcc &amp;&amp; \<font></font>
    apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*<font></font>
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©criture du Dockerfile parfait d√©passe le cadre de cet article.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesurons la vitesse de construction:</font></font><br>
<br>
<pre><code class="bash hljs">$ time docker build -t ubuntu-gcc -f Dockerfile.ubuntu --quiet .<font></font>
sha256:b6a3ee33acb83148cd273b0098f4c7eed01a82f47eeb8f5bec775c26d4fe4aae<font></font>
<font></font>
real    0m29.251s<font></font>
user    0m0.032s<font></font>
sys     0m0.026s<font></font>
$ docker image ls ubuntu-gcc<font></font>
REPOSITORY   TAG      IMAGE ID      CREATED         SIZE<font></font>
ubuntu-gcc   latest   b6a3ee33acb8  9 seconds ago   150MB<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©p√©tez la m√™me chose pour Alpine (Dockerfile):</font></font><br>
<br>
<pre><code class="bash hljs">FROM alpine<font></font>
RUN apk add --update gcc<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous assemblons, regardons l'heure et la taille de l'assemblage:</font></font><br>
<br>
<pre><code class="bash hljs">$ time docker build -t alpine-gcc -f Dockerfile.alpine --quiet .<font></font>
sha256:efd626923c1478ccde67db28911ef90799710e5b8125cf4ebb2b2ca200ae1ac3<font></font>
<font></font>
real    0m15.461s<font></font>
user    0m0.026s<font></font>
sys     0m0.024s<font></font>
$ docker image ls alpine-gcc<font></font>
REPOSITORY   TAG      IMAGE ID       CREATED         SIZE<font></font>
alpine-gcc   latest   efd626923c14   7 seconds ago   105MB<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme promis, les images alpines s'assemblent plus rapidement et moins par elles-m√™mes: 15 secondes au lieu de 30 et une taille d'image de 105 Mo contre 150 Mo. </font><font style="vertical-align: inherit;">C'est plut√¥t bien! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si nous passons √† la construction d'une application Python, alors tout n'est pas si rose.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Image Python</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les applications Python utilisent souvent des pandas et matplotlib. </font><font style="vertical-align: inherit;">Par cons√©quent, l'une des options est de prendre une image officielle bas√©e sur Debian en utilisant ce Dockerfile:</font></font><br>
<br>
<pre><code class="bash hljs">FROM python:3.8-slim<font></font>
RUN pip install --no-cache-dir matplotlib pandas<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous le collectons:</font></font><br>
<br>
<pre><code class="bash hljs">$ docker build -f Dockerfile.slim -t python-matpan.<font></font>
Sending build context to Docker daemon  3.072kB<font></font>
Step 1/2 : FROM python:3.8-slim<font></font>
 ---&gt; 036ea1506a85<font></font>
Step 2/2 : RUN pip install --no-cache-dir matplotlib pandas<font></font>
 ---&gt; Running <span class="hljs-keyword">in</span> 13739b2a0917<font></font>
Collecting matplotlib<font></font>
  Downloading matplotlib-3.1.2-cp38-cp38-manylinux1_x86_64.whl (13.1 MB)<font></font>
Collecting pandas<font></font>
  Downloading pandas-0.25.3-cp38-cp38-manylinux1_x86_64.whl (10.4 MB)<font></font>
...<font></font>
Successfully built b98b5dc06690<font></font>
Successfully tagged python-matpan:latest<font></font>
<font></font>
real    0m30.297s<font></font>
user    0m0.043s<font></font>
sys     0m0.020s<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons une image de 363 Mo en taille. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Allons-nous nous am√©liorer avec Alpine? </font><font style="vertical-align: inherit;">Essayons:</font></font><br>
<br>
<pre><code class="bash hljs">FROM python:3.8-alpine<font></font>
RUN pip install --no-cache-dir matplotlib pandas<font></font>
</code></pre><br>
<pre><code class="bash hljs">$ docker build -t python-matpan-alpine -f Dockerfile.alpine .                                 <font></font>
Sending build context to Docker daemon  3.072kB                                               <font></font>
Step 1/2 : FROM python:3.8-alpine                                                             <font></font>
 ---&gt; a0ee0c90a0db                                                                            <font></font>
Step 2/2 : RUN pip install --no-cache-dir matplotlib pandas                                                  <font></font>
 ---&gt; Running <span class="hljs-keyword">in</span> 6740adad3729                                                                 <font></font>
Collecting matplotlib                                                                         <font></font>
  Downloading matplotlib-3.1.2.tar.gz (40.9 MB)                                               <font></font>
    ERROR: Command errored out with <span class="hljs-built_in">exit</span> status 1:                                            
     <span class="hljs-built_in">command</span>: /usr/<span class="hljs-built_in">local</span>/bin/python -c <span class="hljs-string">'import sys, setuptools, tokenize; sys.argv[0] = '</span><span class="hljs-string">"'"</span><span class="hljs-string">'/
tmp/pip-install-a3olrixa/matplotlib/setup.py'</span><span class="hljs-string">"'"</span><span class="hljs-string">'; __file__='</span><span class="hljs-string">"'"</span><span class="hljs-string">'/tmp/pip-install-a3olrixa/matplotlib/setup.py'</span><span class="hljs-string">"'"</span><span class="hljs-string">';f=getattr(tokenize, '</span><span class="hljs-string">"'"</span><span class="hljs-string">'open'</span><span class="hljs-string">"'"</span><span class="hljs-string">', open)(__file__);code=f.read().replace('</span><span class="hljs-string">"'"</span><span class="hljs-string">'\r\n'</span><span class="hljs-string">"'"</span><span class="hljs-string">', '</span><span class="hljs-string">"'"</span><span class="hljs-string">'\n'</span><span class="hljs-string">"'"</span><span class="hljs-string">');f.close();exec(compile(code, __file__, '</span><span class="hljs-string">"'"</span><span class="hljs-string">'exec'</span><span class="hljs-string">"'"</span><span class="hljs-string">'))'</span> egg_info --egg-base /tmp/pip-install-a3olrixa/matplotlib/pip-egg-info                              <font></font>
<font></font>
...<font></font>
ERROR: Command errored out with <span class="hljs-built_in">exit</span> status 1: python setup.py egg_info Check the logs <span class="hljs-keyword">for</span> full <span class="hljs-built_in">command</span> output.<font></font>
The <span class="hljs-built_in">command</span> <span class="hljs-string">'/bin/sh -c pip install matplotlib pandas'</span> returned a non-zero code: 1
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que ce passe-t-il?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alpine ne prend pas en charge les roues</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous regardez la construction, qui est bas√©e sur Debian, vous verrez qu'elle t√©l√©charge matplotlib-3.1.2-cp38-cp38-manylinux1_x86_64. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whl</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceci est le binaire pour la roue. Alpine t√©l√©charge les sources de `matplotlib-3.1.2.tar. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gz</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> `, car il ne prend pas en charge les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> standard </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pourquoi? La plupart des distributions Linux utilisent la version GNU (glibc) de la biblioth√®que standard C, qui est en fait requise par tous les programmes C, y compris Python. Mais Alpine utilise `musl`, et puisque ces binaires sont pour` glibc`, ils ne sont tout simplement pas une option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, si vous utilisez Alpine, vous devez compiler tout le code √©crit en C dans chaque package Python.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ah, oui, une liste de toutes ces d√©pendances qui doivent √™tre compil√©es devra √™tre recherch√©e par nous-m√™mes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous obtenons ceci:</font></font><br>
<br>
<pre><code class="bash hljs">FROM python:3.8-alpine<font></font>
RUN apk --update add gcc build-base freetype-dev libpng-dev openblas-dev<font></font>
RUN pip install --no-cache-dir matplotlib pandas<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le temps de construction prend ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... 25 minutes 57 secondes! </font><font style="vertical-align: inherit;">Et la taille de l'image est de 851 Mo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les images alpines prennent beaucoup plus de temps, elles sont elles-m√™mes plus grandes et vous devez toujours rechercher toutes les d√©pendances. </font><font style="vertical-align: inherit;">Vous pouvez bien s√ªr r√©duire la taille de la build en utilisant </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des builds en plusieurs √©tapes,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mais cela signifie que plus de travail doit √™tre fait. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce n'est pas tout!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alpine peut provoquer des bogues d'ex√©cution inattendus</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En th√©orie, musl est compatible avec la glibc, mais dans la pratique, les diff√©rences peuvent causer de nombreux probl√®mes. </font><font style="vertical-align: inherit;">Et s'ils le sont, alors certainement d√©sagr√©ables. </font><font style="vertical-align: inherit;">Voici quelques probl√®mes qui peuvent survenir:</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alpine a une pile de flux plus petite par d√©faut, ce qui peut entra√Æner des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erreurs dans Python</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Certains utilisateurs ont constat√© que les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">applications Python sont plus lentes en</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> raison de la fa√ßon dont musl alloue la m√©moire (diff√©rente de la glibc).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un utilisateur a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rencontr√© une erreur lors du formatage de la date</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certes, ces erreurs ont d√©j√† √©t√© corrig√©es, mais qui sait combien d'autres.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'utilisez pas d'images alpines pour Python</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous ne voulez pas vous soucier des versions longues et volumineuses, des recherches de d√©pendances et des bugs potentiels - n'utilisez pas Alpine Linux comme image de base. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choisir une bonne image de base</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486190/index.html">Notre exp√©rience dans le d√©veloppement d'un pilote CSI dans Kubernetes pour Yandex.Cloud</a></li>
<li><a href="../fr486192/index.html">Les cyber fraudeurs piratent les op√©rateurs mobiles pour acc√©der aux num√©ros de t√©l√©phone des abonn√©s</a></li>
<li><a href="../fr486194/index.html">√Ä propos des sauvegardes dans Proxmox VE</a></li>
<li><a href="../fr486198/index.html">Parler est difficile. Essais sur la communication avec les non-programmeurs</a></li>
<li><a href="../fr486200/index.html">Conseils Docker: nettoyez votre machine des d√©chets ind√©sirables</a></li>
<li><a href="../fr486204/index.html">Profession: Administrateur syst√®me</a></li>
<li><a href="../fr486206/index.html">Quels types de fraude ai-je rencontr√©s en freelance et en sous-traitance</a></li>
<li><a href="../fr486210/index.html">2020: tendances et pr√©visions</a></li>
<li><a href="../fr486212/index.html">D√©l√©gation du droit de signer des documents √† un robot</a></li>
<li><a href="../fr486216/index.html">Pourquoi Internet quantique se construit-il dans l'espace et qui met d√©j√† en ≈ìuvre de tels projets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>