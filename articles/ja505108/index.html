<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙏🏾 🏹 🐶 PostgreSQLのパフォーマンスを改善するためのLinuxのチューニング。イリヤ・コスモデヤンスキー 💮 🅿️ ☣️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ilya Kosmodemyanskyによる2015年のレポート「PostgreSQLパフォーマンスを改善するためのLinuxチューニング」のデコード
 

もちろん、記事の一部は古くなっていますが、ここではPostgreSQL向けのLinuxの基本的なチューニングについて調べました。
 
 
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLのパフォーマンスを改善するためのLinuxのチューニング。イリヤ・コスモデヤンスキー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/505108/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ilya Kosmodemyanskyによる2015年のレポート「PostgreSQLパフォーマンスを改善するためのLinuxチューニング」のデコード</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もちろん、記事の一部は古くなっていますが、ここではPostgreSQL向けのLinuxの基本的なチューニングについて調べました。</font></font><br>
<img src="https://habrastorage.org/webt/lz/-j/1p/lz-j1pyzefrqt3hcgqtk3t2i0zy.png"></p><a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/V0M6YwWmMYM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<p>   .     PostgreSQL-Consulting.       ,    Linux        PostgreSQL  ,     .</p><br>
<p>   ?     PostgreSQL,   -    UNIX’ .   ?    Oracle  PostgreSQL,   Oracle    80 % DBA      20 %  Linux.</p><br>
<p> PostgreSQL  .  PostgreSQL     ,   Linux.        ,         .    ,    ,    . . </p><br>
<p>    Linux?    ,     Linux ,                    PostgreSQL   –  Linux.   FreeBSD,  ,   -   .      ,      . <strong> PostgreSQL  Windows –     ,   ,   Windows       UNIX,   PostgreSQL     ,    .</strong> </p><br>
<p>   Solaris,  ,     ,  . </p><br>
<p><img src="https://habrastorage.org/webt/ci/ka/tm/cikatmazqvmu6mzffuz0gdz4woe.png"></p><br>
<p>   Linux  1 000  syctl,    ,   .  ,       ,       - .    ,  .  ,  :   BIOS ,     . .</p><br>
<p>   ,      ,      ,       ,    ,            Linux,     .      ,          ,     . . .          . </p><br>
<p><img src="https://habrastorage.org/webt/2m/c-/47/2mc-47jfbageaksps925f7sduri.png"></p><br>
<p>  tuning targets   Linux?  ,         Linux,    targets    . </p><br>
<p> :</p><br>
<ul>
<li>CPU.</li>
<li>Memory.</li>
<li>Storage.</li>
<li>Other.        . , ,  ,              . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ka/sa/wf/kasawfxz_qtm3kxwat4kkssh7ju.png"></p><br>
<p>   PostgreSQL     ?   ,    -    ,      . </p><br>
<p>,   ,    –   .     ,         .       Oracle  ,    ,           –      .    ,     . </p><br>
<p> ,     PostgreSQL    .    ,           , . . -    Linux    . </p><br>
<p>  –   -  target    , , , CPU  -   ,   workload      ,          ,     ,      . </p><br>
<p><img src="https://habrastorage.org/webt/f4/x-/78/f4x-78ymceyvs8_2wjqewjftdya.png"></p><br>
<p>     ,   .    Linux         PostgreSQL. PostgreSQL    Oracle      , . .         ,     kernel buffer      . </p><br>
<p>    .     .       RAID-  . . </p><br>
<p>   -       .</p><br>
<p>PostgreSQL –    .   .   -    .      .     ,    ,      ,         . </p><br>
<p>  - - ,        .      .   ,         . . . ,    ,    WAL.   -        checkpoint.        ,   .   ,    ,          ,        fsync  kernel buffer.</p><br>
<p>   ?     ,     ,    .  ,     ,        –   ,   , ,     ,         20 . , ,     .</p><br>
<p>     –      ,     - .   –     .  PostgreSQL    select - ,      .     . ,    ,    .</p><br>
<p>        ,         .    ,       -   ,       ,       . </p><br>
<p>      .</p><br>
<p><img src="https://habrastorage.org/webt/hl/uo/9s/hluo9sctsghav01gkrlpw7jajzw.png"></p><br>
<p>    - ,   :</p><br>
<ul>
<li>-,     .</li>
<li>-,      ,       .</li>
<li>, -,    . </li>
</ul><br>
<p>   512 GB            SATA     ,          ,     SATA .      .     .</p><br>
<p><img src="https://habrastorage.org/webt/ds/gn/x2/dsgnx2pmwfolcohmvy02m0oc_qg.png"></p><br>
<p>     ,    ,     . </p><br>
<p>   –  NUMA. NUMA –  ,    ,   .    workload    .          ,   ,   page cache  ,   . </p><br>
<p><img src="https://habrastorage.org/webt/uz/4a/6y/uz4a6yxhj9xozqrqhli9hbyi280.png"></p><br>
<p>  .  ,   NUMA -  ?   -  ,  - CPU  .       PostgreSQL  ,      .        CPU.    .       ,   NUMA  PostgreSQL.</p><br>
<p><img src="https://habrastorage.org/webt/bf/y6/6i/bfy66ihjjcwpkqfbwi1ctvxicta.png"></p><br>
<p>    ? NUMA –  Non-Uniform Memory Access.   ?    CPU,       .    interconnects      CPU.</p><br>
<p>   <code>numactl --hardware</code>,      .      distances.   – 10-20, -   .     ,   ,        .  ,  .       .</p><br>
<p> ,     CPU      ,     interconnect     -.    CPU    page cache PostgreSQL – , -  .     ,    CPU       .   ,  ,    interconnects.    .    ,    ,  .      – , .   ,    ,       . </p><br>
<p>      ,    Linux   ,   .       . </p><br>
<p> ?  ,    .      ,      page cache  – ,  . </p><br>
<p>          ,        ,        .           ,           NUMA.</p><br>
<p>      ,     ,          CPU      -  . </p><br>
<p><img src="https://habrastorage.org/webt/mc/v5/qi/mcv5qi5xhaytlex02v4nyexhv8e.png"></p><br>
<p><strong>   –    NUMA</strong>, ,  .        ,     ,  . </p><br>
<p>  .    ,  ,  ,       ,      –   .     .   - NUMA  .       ,  reboot,    ,   .  ,   ,     PostgreSQL NUMA  ,  ,    ,   .    ,    . </p><br>
<p>   Robert Haas.     PostgreSQL.       .        ,        ,   NUMA  . ,  - ,       ,       .       ,       . </p><br>
<p> ,     ,     .        master-slave  .       slave,          ,     slave,    . </p><br>
<p>  ,    ,           ,      ,  .      .</p><br>
<p><img src="https://habrastorage.org/webt/wt/no/ef/wtnoefrdmdnddrhdltz-p8mmeau.png"></p><br>
<p>  –  huge pages. Huge pages   ,      ,   ,    .   . </p><br>
<p>  ?      ,     , ,  30 GB.     huge pages.  ,      overhead   .   overhead    . </p><br>
<p><img src="https://habrastorage.org/webt/p-/us/wl/p-uswljsdjl7ylz6aga6rsv__sc.png"></p><br>
<p> ?   ?      .  ,   .     ,        .      ,        Translation Lookaside Buffer (TLB).</p><br>
<p>  TLB –  ,         . -,             chunks,      .    ,     . Overhead      , . .    -  .  . </p><br>
<p> –       ,    ,     cache misses.          .       .  Linux    .  FreeBSD    .     Linux.  huge pages.</p><br>
<p>   ,  huge pages,  ,    ,    Oracle  IBM, . .       ,   ,      . </p><br>
<p><img src="https://habrastorage.org/webt/s-/ic/an/s-icandlypwr5tici8yd5zsxhfk.png"></p><br>
<p>     PostgreSQL? -,       huge pages.</p><br>
<p>-,        sysctl  –  .    -  .   ,     shared buffers,  huge pages  . </p><br>
<p>        PostgreSQL,     –   25 %      ,  75 %,   ,    75 %     .   .  ,    256 GB  , , , 64 GB     .      –         .</p><br>
<p>  9.2 (  ,   8.2)        PostgreSQL  huge pages.     . -,  ,     huge pages . , -,  ,    ,   .     .  PostgreSQL     system 5,        libhugetlbfs —    .</p><br>
<p> 9.3   PostgreSQL        system 5   .   ,       instances PostgreSQL   ,   ,       .  ,    sysctl.    sysctl,      . .  ,  .    mmap   huge pages.       shared buffers.        9.3,    overhead     .</p><br>
<p>  community        9.4     .   9.4    postgresql.conf,     try, on  off.</p><br>
<p>Try –   .   PostgreSQL,     ,      huge pages  .    ,     .     FreeBSD  Solaris,     try,   . </p><br>
<p> on,     ,      huge pages.   –     .      try,  ,     ,   ,       .       Linux.</p><br>
<p>   ,  ,   . Transparent huge pages –    PostgreSQL  .       .   Transparent huge pages   workload,      ,       .     ,     .       ,    32, 64, 128, 256 GB   ,   huge pages –  Ok,  Transparent  . </p><br>
<p><img src="https://habrastorage.org/webt/ip/b5/eq/ipb5equazb08sb3vxjjcs0xfwcw.png"></p><br>
<p>  ,  ,     ,      .       ,    . </p><br>
<p>       .      ,            Linux.   ,     ,  ,     -   swap’,      OOM-killer.  OOM-killer,       PostgreSQL,  .    , . .   . </p><br>
<p><img src="https://habrastorage.org/webt/xp/el/x5/xpelx5kbqj3rpwslzpwc05dqigc.png"></p><br>
<p> ?       ,   .  -    swap’   - .  ,  ,   . </p><br>
<p><img src="https://habrastorage.org/webt/oy/nz/ja/oynzja7bklp6qwniksqrb2l9nfu.png"></p><br>
<p>   vm.swappiness   , . .  swap.  ,  32 GB       –   .   swap’,   ,   ,   .      .        ?    ,    ,  swap ,    . </p><br>
<p>   , . .      .    swap  , . . ,               OOM-killer,     .     ,    workload       , . .    ,   -  .        ,   postmaster.     ,     . </p><br>
<p>  ,   ,   –  - 6, . .      swap    ,   . <strong>    vm.swappiness = 1,      ,     ,     OOM-killer’     .</strong> </p><br>
<p><img src="https://habrastorage.org/webt/1e/p9/fx/1ep9fxkxbwyekscvjhy8vzosrs0.png"></p><br>
<p> ?         -   ,     .     ,      ,     .   ,         .</p><br>
<p>    PostgreSQL,   checkpoints spikes,   - ,   . , ,  ,        .          . PostgreSQL  ,   ,      .         ,     , . .   ,      . </p><br>
<p><img src="https://habrastorage.org/webt/4b/8j/-r/4b8j-rypvklk6jqw9pqxb3yqzps.png"></p><br>
<p>      ?  ,   PostgreSQL      .  .   , PostgreSQL   checkpoints,         .       ,  checkpoint     ,      fsync.    kernel buffer       fsync.      ,      ,      .</p><br>
<p>     .   ,   .       .   –   .      90 %    .         ,  RAID-   90 %,    .  ,   -   100  - . </p><br>
<p>    ,     .    ,   ,     . . </p><br>
<p>       postgres’ ,  ,   checkpoint.     ,   ,          checkpoint  .   ,    .  ,          -     , . . -,       .    checkpoint     .     , ,  , . .      .      ,    . . .  ,  - -   . </p><br>
<p>  ,    ?     IO   ,   ,   ,     ,  . </p><br>
<p><img src="https://habrastorage.org/webt/eh/me/_4/ehme_4jcjf_bm6stnjoyzqxjmdq.png"></p><br>
<p>     Linux,     hardware,   ,   PostgreSQL,      checkpoints,       ,       Debian.    Linux   : vm.dirty_ratio=20, vm.dirty_background_ratio=10.</p><br>
<p>  ?   2.6   demon flushing’. Pdglush    ,   ,   background’     kernel buffer  ,          ,   backgrouind’   . </p><br>
<p>  background?  10 %    ,    ,     kernel buffer,       background’.   background’?       ,   . , ,  N .   -    .         -  . </p><br>
<p>   .     ,     ,   .   checkpoint          ,    kernel buffer pgflush     . </p><br>
<p>     ,    20 %,           ,    ,      .    , . </p><br>
<p>  ? <strong>   ,        20  10 %    ,    ,          ,    .</strong> </p><br>
<p> ,    128 GB  . 12,8 GB      .         ,        ,    . </p><br>
<p><img src="https://habrastorage.org/webt/ty/mx/nh/tymxnh-2wfmqyltmauo5p82lxtq.png"></p><br>
<p><strong>          RAID-.</strong>        ,   512 MB . </p><br>
<p>   .  vm.dirty_background   .      .  ratio  ,   ,   ,    ,   .    DBA-     ,      ,   ,   .     ,       ,   ,     .    ,      . </p><br>
<p> ,    ?   ,     flushing,       .      –     ,     IO,    , . .   sql-   ,  .  -   –    ,     checkpoint.       .      ,   flushing’,   ,     IO  .     ,    . </p><br>
<p>     ,      .        postgresql.conf, . .  checkpoints.        . <strong>      RAID,      .</strong>   RAID     . <strong>   SSD  RAID’,     ,    .</strong>   -.         ,      PostgreSQL.    - . </p><br>
<p><img src="https://habrastorage.org/webt/lg/oa/ic/lgoaicgiw4vn1zk3vytrvgz46ko.png"></p><br>
<p>      ?   .   .         .        ,     . </p><br>
<p><img src="https://habrastorage.org/webt/d2/xb/9j/d2xb9jhf6w_xfvtht1cowndx8ew.png"></p><br>
<p>    .      .  sched_migration_cost    sched_autogroup_enabled,    . </p><br>
<p>    ?   sched_migration_cost?  Linux scheduler      CPU  .   PostgreSQL,   ,    CPU    .     ,      openoffice  ,  ,  , ,  <strong>   –   .</strong> <strong>   –  migration_cost  -  ,     .</strong> </p><br>
<p>     scheduler?  ,          . . .    -   -  ,  scheduler   .   ,      -,       .     - ,      ,      CPU,   .    . </p><br>
<p>  –  autogroup.      workload,        –       , -   .    - . <strong>  PostgreSQL –     prefork’,     .   lock writer, checkpoint         scheduler,   CPU.     ,   ,        .  ,             .</strong></p><br>
<p><img src="https://habrastorage.org/webt/c9/ia/s1/c9ias1s31xzwdfscvacwoxrwy_0.png"></p><br>
<p>        pgbench’,     migration_cost   autogroup. <strong>       10 %</strong>.    postgres’ ,    ,       <strong>  50 %</strong>.    .</p><br>
<p><img src="https://habrastorage.org/webt/i9/ep/oc/i9epoctypct--1mwk__vgagawem.png"></p><br>
<p>   power saving policy. ,   Linux    .       .   ,       . </p><br>
<p> ,        - ,  «»     ,      .    ,       .             .</p><br>
<p><strong>             ,    –  acpi_cpufreq + permormance.   ondemand’   .</strong> </p><br>
<p>Intel_pstate –    .      ,        .</p><br>
<p>, , governor  performance. Ondemand, powersave    –    . </p><br>
<p>  explain analyze PostgreSQL     ,    powersave,          CPU   .</p><br>
<p>      .   –      .      . </p><br>
<p><img src="https://habrastorage.org/webt/ch/ps/ug/chpsugqp5z-rjqgzc8yp7yyvn48.png"></p><br>
<p>          DBA- PosgreSQL-Consulting,       ,        .         ,      .       .    .        - .       .</p><br>
<p>:</p><br>
<p><em>! , ,            application  ,       ,   PostgreSQL   .   ? Sysctl     .   ,  sysctl - ,       .   cgroup       .      ?    performance,   PostgreSQL       ?</em></p><br>
<p>       .       ,     . .,  ,       .      ,      ,       ,    .</p><br>
<p>  ?   , ,  ,     , ,  ,       latency .      ,      -,       ,     checkpoint      WAL,       .     ,     . </p><br>
<p>    NGINX     ,       .      .    ,   ,   .</p><br>
<p>   ,         . ,  sysctl  dirty_ratio,      –     .         .      .     ,   .       . </p><br>
<p>  NUMA   . VmWare, ,    NUMA    .     –     . </p><br>
<p><em>  ,   Amazon AWS.    image .    Amazon RDS .    -      ?</em></p><br>
<p>  ,    .         ,       .    ,  ,    ,   shaping. . .    ,     .   Amazon RDS   ,    .   ,       .    .        .     .   .</p><br>
<p><em> Transparent huge pages       Huge TLB?</em></p><br>
<p> .     .        .    PostgreSQL?        . Transparent      transparent –   .  ,     ,   .         shared_memory segment,  Transparent huge pages  .  PostgreSQL         ,        . , , ,     curruption shared_memory,     -. PostgreSQL     .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja505090/index.html">「役に立つ」/「使わない」/役に立たないという言葉の翻訳について</a></li>
<li><a href="../ja505092/index.html">マイクロソフトでの就職方法</a></li>
<li><a href="../ja505098/index.html">Snom D717 IP電話レビュー</a></li>
<li><a href="../ja505104/index.html">世界のトップ5の薬局サイトに参入したサービスを開発した方法</a></li>
<li><a href="../ja505106/index.html">乾燥した水と海の膝の深さ</a></li>
<li><a href="../ja505114/index.html">6月3日の輸送：1週間の朗報（そして今、全国をドライブする方法）</a></li>
<li><a href="../ja505116/index.html">3DデンタルスキャナーMedit Identica T300の概要</a></li>
<li><a href="../ja505118/index.html">マス広告管理のためのGoogle広告エディター：カスタマイズと7つの使用例</a></li>
<li><a href="../ja505120/index.html">Hackathon DataMonetize：友達を小売りしてBigDataにする簡単な方法</a></li>
<li><a href="../ja505124/index.html">地球上でフクロウを引くのをやめる</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>