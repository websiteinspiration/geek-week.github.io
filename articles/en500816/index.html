<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💟 👨🏿‍🎓 👨‍👨‍👦‍👦 Mikrosha. Chapter one. SD card controller 🏷️ 🔱 👨🏼‍💻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many people remember this wonderful PC. I got this when I was 11. It took 28 years and now I decided to make expansion devices, which I really lacked ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mikrosha. Chapter one. SD card controller</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500816/"><img src="https://habrastorage.org/getpro/habr/post_images/4e4/843/62d/4e484362df0eacd9d8d9a7444c4a6c64.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many people remember this wonderful PC. </font><font style="vertical-align: inherit;">I got this when I was 11. It took 28 years and now I decided to make expansion devices, which I really lacked then, as a hobby.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idea</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the network, I saw several options for SD downloaders for such PCs, I didn’t like the presence of microcontrollers in them, I wanted to use “vintage, warm DIP” circuitry, which is why I decided to use “KR1533” on the domestic logic. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an add. </font><font style="vertical-align: inherit;">RAM I applied UT62256. </font><font style="vertical-align: inherit;">This is the only imported chip in the project. </font><font style="vertical-align: inherit;">Of course, it was possible to install KP537RU10 or KP537RU25A, but firstly, they would have had to be installed not one but two (I planned 4 KB of additional RAM), and secondly I had UT62256, but I didn’t have KR537, and I didn’t have to order I wanted to. </font><font style="vertical-align: inherit;">Therefore, I allowed myself the freedom to import, and then the idea came up to use all 32kB of additional RAM, with page switching. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bs/hq/ho/bshqhoyuqbckntjlxyd73v88gb8.jpeg"> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the ROM I chose KR573RF5, there were just two clean ones.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flow chart</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After sitting over a cup of tea, I drew such a block diagram. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e40/650/c2d/e40650c2d607251445e4774ab7f524ed.jpg"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the RAM chip, the ROM chip, and the PORT block. The PORT block has a parallel interface having 8 inputs and 8 outputs. When writing to the EFFF address, the written code is set at the outputs, and when reading from the same address, the read value corresponds to the status of the inputs. Three of the outputs and one of the inputs are connected to the SD card through a level converter.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The RAM is represented by the UT62256 chip and has 32kB of memory. Since the range of E000-EFFE addresses is almost 4kB (4095 bytes), we get 8 pages that are selected by the PORT block, bits 1,2 and 3. That is, writing to the EFFF address sets the page in accordance with these three bits. Also reading from this port shows which page is currently selected (in the same bits). Total, we have 32760 bytes of additional RAM (4095x8str). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ROM chip is KR573RF5. It is connected to the address space F000-F7FF, and contains the BSVV code (BIOS), the task of this code is to initialize the SD card, load the OS from it and transfer control to it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accordingly, after turning on the PC, we type in the GF000 System Monitor and press VK.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 In the future, there is an idea to modify the native ROM of the System Monitor to automatically boot the OS from the SD card, and the PC will go to the standard Monitor prompt if the download failed or was interrupted, for example, by pressing some key. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I'll think about it again.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scheme</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
About 2-3 hours at the computer, and I drew the following diagram in EAGLE. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/457/20c/399/45720c3997d2e7861a69285379e0d26f.jpg"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zoom</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
I drew based on the microcircuits that I had. </font><font style="vertical-align: inherit;">It is possible that the number of logic chips can be reduced if other gates are used, but I only had one. </font><font style="vertical-align: inherit;">And in the future, I will most likely optimize the circuit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Low level circuit parsing ...</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... removed under the spoiler, I think few people are interested in this jungle.</font></font></b>
                        <div class="spoiler_text">     V3/1,     A14  A15  ,    N3   ,        .1.   V1/2      G,     IC2.    A  B,    A12  A13 . , ,        A14  A15,        A12  A13.      — 1110, <br>
  A15-1; A14-1; A13-1; A12-0.       N2.    ,        5  11,  - ,         ,            .  1   5,   2   11.   ,   1C ,   2C ,    .1     5,   .0 —  11.<br>
<br>
:       Exxx  =1,   «PORT»,        Exxx  C=0,   «RAM».<br>
<br>
 «C»      ,     (A0-A11).      xFFF,  =1,   =0. :  «PORT»   EFFF,   «RAM»  E000-EFFE.<br>
<br>
 «RAM»    CS  IC3,   ,  ,     E000-EFFE      .     E000-EFFE      .     EFFF      IC4,     .      «PORT»  «WR» c   V1/5, V1/6  V3/4.<br>
<br>
   EFFF       IC5,    <br>
   B0-B7. <br>
<br>
           .     « »   CS3      CS  . </div>
                    </div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Layout assembly</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I have no opportunity to poison the board at home, and I, taking a piece of foil-coated double-sided PCB, sawed out the necessary rectangle from it. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This rectangle was firmly inserted into the PC “internal interface” slot, did not hang out and did not move. Next, I scratched the pads on the back and front. It turned out pretty well. Then the rough arrangement of microcircuits and the reconnaissance of holes. On the front side, I drilled it with a large drill so that the terminals of the microcircuits do not come in contact with the front foil. On the reverse side, I scratched the perimeter of each contact row and divided it into contact pads.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step I put all the microcircuits (and the socket) and disappeared from the back. It took a lot of time the installation, which I conducted with a thin MGTF. He led the wiring on both sides, from the front he soldered directly to the legs of the microcircuits, from the back to the sites. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2a3/6b0/811/2a36b081191f9121d1c009aa800343d7.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the soldering process was over, I decided to pay attention to the signal level converter. The fact is that the SD card works with a voltage of 3.3V, and the chips KR1533AP6 and KR1533IR22 TTL 5v. Therefore, I had to make a small adapter scarf, on which the levels were limited to zener diodes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The signal coming from the SD card to the controller I just pulled to the source 3.3v. 10k resistor. As practice has shown, this signal does not need to be converted. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/1a9/b60/a51/1a9b60a514daff10804816ab02db91f9.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although in the final version I will probably make a inverter based on a comparator.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I used a microSD to SD adapter as a card holder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, there were no special problems in assembling the layout, although I was afraid that some of the microcircuits might be malfunctioning.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Layout Tests</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, I checked the RAM operation, wrote “AA”, “55”, “F0” and “0F” patterns to the E000-EFFE area using the System Monitor directive “F” and checked them using the “D” directive. </font><font style="vertical-align: inherit;">Everything turned out to be normal. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then, with the “M” directive, I began to write different values ​​to the EFFF address, and watch the changes on the legs of the register 153322 with a multimeter, the states corresponded to the recorded codes. </font><font style="vertical-align: inherit;">Also, when reading from this port, the code contained the selected page, in accordance with the plan, and even when the MISO signal was closed to ground in the low bit, it turned out to be 0, and when opened 1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was even somehow suspicious that all the microcircuits were working and the installation was successful no mistakes.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSVV</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Of course, I didn’t have any special tools for writing programs for 58080. </font><font style="vertical-align: inherit;">I had to write a program in a notebook (notepad), then translate it into codes manually. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Created a file in the editor under DOS “HIEW” and began filling it with codes. </font><font style="vertical-align: inherit;">For the basics, I took my project under AVR, in which there was standard initialization of the SD card. </font><font style="vertical-align: inherit;">The project was old, and it did not use any file system, just a logger. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First I wrote a low-level function of the SPI programming interface, and then a high-level SD card initialization routine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out something like this algorithm ...</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... which is put under the spoiler, I think it is already known to everyone.</font></font></b>
                        <div class="spoiler_text">1.    ()  90;<br>
2.  CS  .1   10  FF;<br>
3.  CS  .0;<br>
4.  CMD0;<br>
5.   01,    7;<br>
6.  .  =0,    ,    2;<br>
7.  CMD8;<br>
8.  ACMD41;<br>
9.   00,   11<br>
10.  .  =0,    ,    8;<br>
11.  CMD58.<br>
12.  2       EFFE.<br>
13.  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 The OCR card register was also read in the initialization routine, and the 2nd byte in it was written to the EFFE address. </font><font style="vertical-align: inherit;">This was necessary to determine the type of card. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of SDSC - 80h, and in the case of SDHC - C0h. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 If the initialization did not pass, then the message “SD CARD ERROR” was displayed and then the monitor went out without reset. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I converted this BSVV into WAV and downloaded it to the PC via the tape input, then debugged it, corrected the source code and downloaded it again.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bridges</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now I have additional RAM, 32,760 bytes in size, divided into 8 pages. But how to navigate between pages? How can a program running on the first page invoke a routine located on the fourth? </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve this problem, I have provided software bridges. A bridge is a small area in ROM that mediates control transfer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, executing code must transfer control to page number 3, to address E4B5. Then, the executing code places the lower 12 bits (4B5) in the register pair of the processor HL, and in the upper four bits puts the value 3 - the page number. Now in the register pair HL the value 34B5 is written. And the code jumps (JMP) to the ROM area, which is called the JMP-Bridge, it's just going to a fixed address in the ROM. The code in this area extracts the page number from the high bits of the HL register pair and writes them to the register of the PORT block at the EFFF address. The third page of RAM is now displayed in the E000-EFFE area. The JMP-Bridge program resets the four high bits of the HL register pair and writes “E” there. Now in the HL register pair there is already a physical address E4B5, and here the JMP-Bridge program transfers control to it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This transfers control between pages. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a CALL-Bridge, it is needed to call a subroutine with a return, and differs from JMP-Bridge by saving the current page on the stack, and the reverse procedure for returning. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next two bridges are STA-Bridge and LDA-Bridge. </font><font style="vertical-align: inherit;">As the names suggest, the first one writes the Battery register to a logical address (in HL), and the second one reads data from the logical address into this register. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to these two bridges, a program executing from one page can store data in another.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS loading</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you look at the boot sector of the SD card, you can see that the text “Disk error, press any key to restart” is located at addresses 1AC-1D4. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a56/a5a/a9b/a56a5aa9bd2e2f2a81499a567ad2da25.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes, it’s so strange how it looks in the photo, because the character encoding of Mikroshi does not coincide with ASCII. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided to use this area to place the data there for downloading the PC. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, I put the code 00 in position 1BA, and thereby cut the record. Now, just “Disk error” should be displayed and that’s it. The remaining bytes are mine. The principle is simple, 6 bytes MicrOS signature, and 4 bytes address on the SD card of the beginning of the file with OS. In BSVV, I wrote down, after receiving the boot sector from the SD card, the signature is checked, and if it is, then take the next 4 bytes and use it as the sector address for loading the OS.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If there is no signature, the message “OS DOWNLOAD ERROR” is displayed and the System Monitor goes out without reset.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now, finally, everything works. </font><font style="vertical-align: inherit;">BSVV is written, but I still need to write it to ROM. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/49a/cb4/d36/49acb4d36b5b9709eba320cca18b1b39.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And for this, I need to edit all the addresses of subroutine calls and jumps, since this processor has absolute addressing. </font><font style="vertical-align: inherit;">And I wrote BSVV for the region 6000-67FF to load in RAM. </font><font style="vertical-align: inherit;">But now we need to change all 6xxx to Fxxx. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, I am in the “popanetsky” conditions. </font><font style="vertical-align: inherit;">I have a ROM programmer, but it's an old one, under an LPT port. </font><font style="vertical-align: inherit;">And there is not a single computer with LPT. </font><font style="vertical-align: inherit;">But there is a pair of Atmega32A, in the PDIP40 package and a breadboard. </font><font style="vertical-align: inherit;">You may need to emulate LPT using AVR. </font><font style="vertical-align: inherit;">But maybe it will all work out ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all for now. </font><font style="vertical-align: inherit;">Thank you for the attention! </font><font style="vertical-align: inherit;">To be continued…</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500796/index.html">What to analyze before designing an interface</a></li>
<li><a href="../en500798/index.html">Now I know that my colleague has python, or How our team maintains relations at a distance during the distance</a></li>
<li><a href="../en500800/index.html">Why software is not always a commodity and where does IT profit</a></li>
<li><a href="../en500804/index.html">Debriefing the Audi A8</a></li>
<li><a href="../en500806/index.html">Escort</a></li>
<li><a href="../en500818/index.html">Neurocomputer interfaces for games: what is known today</a></li>
<li><a href="../en500822/index.html">Who will bury the modern web?</a></li>
<li><a href="../en500824/index.html">Do you need voice narration for videos about applications and web services?</a></li>
<li><a href="../en500828/index.html">Single sign-on for SSH do-it-yourself</a></li>
<li><a href="../en500830/index.html">The new service takes pictures of employees every 5 minutes. They hate him for it.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>